{"version":3,"file":"kedcomponents.js","sources":["webpack://[name]/webpack/bootstrap","webpack://[name]/./kedbackend/client.js","webpack://[name]/./kedbackend/clientweb.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/bearer-storage-sessionstorage.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/hash-restorer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/access-control.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/http-error.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/ked-bearer-provider.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/restclient.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/cache-bust.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/apply-mutations-on-deltas.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-cache.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-merge.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-query.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-repo.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-subscription.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-writer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/mutation-queue.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/query-set.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-course.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-task.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate.js","webpack://[name]/./kedbackend/js/dist/js/observable/collection.js","webpack://[name]/./kedbackend/js/dist/js/observable/emitter.js","webpack://[name]/./kedbackend/js/dist/js/observable/fiber-context.js","webpack://[name]/./kedbackend/js/dist/js/observable/index.js","webpack://[name]/./kedbackend/js/dist/js/observable/map.js","webpack://[name]/./kedbackend/js/dist/js/observable/mixin.js","webpack://[name]/./kedbackend/js/dist/js/observable/observable.js","webpack://[name]/./kedbackend/js/dist/js/observable/value.js","webpack://[name]/./kedbackend/observable.js","webpack://[name]/./kedbackend/repo.js","webpack://[name]/./src/access-control/get-user-claims.ts","webpack://[name]/./src/access-control/index.ts","webpack://[name]/./src/apis/edsclient.ts","webpack://[name]/./src/apis/google-calendar.ts","webpack://[name]/./src/apis/google-client.ts","webpack://[name]/./src/apis/ked-learninggoals.ts","webpack://[name]/./src/components/calendar/calendar-self.tsx","webpack://[name]/./src/components/calendar/calendar-tutored.tsx","webpack://[name]/./src/components/calendar/course-name-to-css-class.ts","webpack://[name]/./src/components/calendar/crunch-colliding-events.ts","webpack://[name]/./src/components/calendar/day-view-event.tsx","webpack://[name]/./src/components/calendar/day-view.tsx","webpack://[name]/./src/components/calendar/hour-marker.tsx","webpack://[name]/./src/components/calendar/index.tsx","webpack://[name]/./src/components/calendar/should-include-calendar.ts","webpack://[name]/./src/components/calendar/status-bar.tsx","webpack://[name]/./src/components/calendar/time-lines.tsx","webpack://[name]/./src/components/calendar/week-view.tsx","webpack://[name]/./src/components/charts/charts-utils.ts","webpack://[name]/./src/components/charts/doughnut.tsx","webpack://[name]/./src/components/charts/goal-progress.tsx","webpack://[name]/./src/components/charts/progress.tsx","webpack://[name]/./src/components/course-builder/sub-components/ellipsis-loader.tsx","webpack://[name]/./src/components/course-builder/sub-components/remove-item.tsx","webpack://[name]/./src/components/course-builder/sub-components/spinner.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/confirmation.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/learning-goals-list.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/task-list.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner-self.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner-tutored.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner.tsx","webpack://[name]/./src/components/kg-termplanner/week-note-dialog.tsx","webpack://[name]/./src/components/ks-goals/future-abilities-table.tsx","webpack://[name]/./src/components/ks-goals/future-abilities-viewmodel.ts","webpack://[name]/./src/components/ks-goals/goals-viewmodel.ts","webpack://[name]/./src/components/ks-goals/goals.tsx","webpack://[name]/./src/components/ks-termplanner/ks-termplanner-self.tsx","webpack://[name]/./src/components/ks-termplanner/ks-termplanner-tutored.tsx","webpack://[name]/./src/components/ks-termplanner/termplanner-utils.ts","webpack://[name]/./src/components/ks-termplanner/termplanner.tsx","webpack://[name]/./src/components/ks-termplanner/tutor-dialog.tsx","webpack://[name]/./src/components/ks-termplanner/viewmodel.ts","webpack://[name]/./src/components/latest-assessments/latest-assessments.tsx","webpack://[name]/./src/components/learning-tasks/index.tsx","webpack://[name]/./src/components/list-courses/list-courses.tsx","webpack://[name]/./src/components/my-courses/my-courses.tsx","webpack://[name]/./src/components/my-subjects/my-subjects-inner.tsx","webpack://[name]/./src/components/my-subjects/my-subjects.tsx","webpack://[name]/./src/components/tutors-select/tutors-select.tsx","webpack://[name]/./src/components/utility-components/LanguageContext.tsx","webpack://[name]/./src/components/utility-components/SetupLanguageIntl.tsx","webpack://[name]/./src/components/utility-components/checkbox.tsx","webpack://[name]/./src/components/utility-components/content-editable-field.tsx","webpack://[name]/./src/components/utility-components/dialogs.tsx","webpack://[name]/./src/components/utility-components/form-field-text-input.tsx","webpack://[name]/./src/components/utility-components/form-field-textarea.tsx","webpack://[name]/./src/components/utility-components/form-field.tsx","webpack://[name]/./src/components/utility-components/observe.tsx","webpack://[name]/./src/components/utility-components/open-close-box.tsx","webpack://[name]/./src/components/utility-components/tutorable-component.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/actions-sv.ts","webpack://[name]/./src/components/utility-components/wysiwyg/actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/exec.ts","webpack://[name]/./src/components/utility-components/wysiwyg/html-patch-policy.ts","webpack://[name]/./src/components/utility-components/wysiwyg/image-edit-actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/index.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/wash-html.ts","webpack://[name]/./src/components/week-notebook/index.ts","webpack://[name]/./src/components/week-notebook/root-week-notebook.tsx","webpack://[name]/./src/components/week-notebook/week-notebook.tsx","webpack://[name]/./src/components/weekplanner/add-custom-goal.tsx","webpack://[name]/./src/components/weekplanner/add-custom-task.tsx","webpack://[name]/./src/components/weekplanner/add-or-edit-sub-task.tsx","webpack://[name]/./src/components/weekplanner/edit-user-task.tsx","webpack://[name]/./src/components/weekplanner/get-task-type.ts","webpack://[name]/./src/components/weekplanner/refiner.ts","webpack://[name]/./src/components/weekplanner/user-tasks-box.tsx","webpack://[name]/./src/components/weekplanner/weekplanner-persisted-state.ts","webpack://[name]/./src/components/weekplanner/weekplanner-self.tsx","webpack://[name]/./src/components/weekplanner/weekplanner-tutored.tsx","webpack://[name]/./src/components/weekplanner/weekplanner.tsx","webpack://[name]/./src/elements/KEDComponents/kedcomponents.client.ts","webpack://[name]/./src/elements/KEDComponents/kedcomponents.ts","webpack://[name]/./src/elements/KEDComponents/webpack-entry.ts","webpack://[name]/./src/features/features.ts","webpack://[name]/./src/features/index.ts","webpack://[name]/./src/global-setters/configure.ts","webpack://[name]/./src/global-setters/set-all.ts","webpack://[name]/./src/global-setters/set-bearer-providers.ts","webpack://[name]/./src/global-setters/set-eds-client.ts","webpack://[name]/./src/global-setters/set-ked-backend-client.ts","webpack://[name]/./src/globals/KED.cfg.ts","webpack://[name]/./src/globals/KED.env.ts","webpack://[name]/./src/globals/KED.ts","webpack://[name]/./src/globals/KED.tutorEnv.ts","webpack://[name]/./src/globals/db.ts","webpack://[name]/./src/globals/ked.ts","webpack://[name]/./src/globals/moment-sv-locale.ts","webpack://[name]/./src/repos/hidden-courses-repo.ts","webpack://[name]/./src/repos/ked-repo.ts","webpack://[name]/./src/repos/kg-termplanner-repo.ts","webpack://[name]/./src/repos/ks-termplanner-repo-instance.ts","webpack://[name]/./src/repos/ks-termplanner-repo.ts","webpack://[name]/./src/repos/repo.ts","webpack://[name]/./src/repos/user-tasks-repo.ts","webpack://[name]/./src/repos/week-notes-repo.ts","webpack://[name]/./src/utils/constants.js","webpack://[name]/./src/utils/generic-school-term.ts","webpack://[name]/./src/utils/generic-school-utils.ts","webpack://[name]/./src/utils/if-takes-time.ts","webpack://[name]/./src/utils/make-suspense-api.ts","webpack://[name]/./src/utils/pending-job.ts","webpack://[name]/./src/utils/query-string.ts","webpack://[name]/./src/utils/request-tutored-tokens.ts","webpack://[name]/./src/utils/school-moment.ts","webpack://[name]/./src/utils/school-term.ts","webpack://[name]/./src/utils/utils.ts","webpack://[name]/./src/utils/weekutil.ts"],"sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"kedcomponents\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp_name_\"] = window[\"webpackJsonp_name_\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([\"./src/elements/KEDComponents/webpack-entry.ts\",\"vendors\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","export * from './js/dist/js/ked-backend-client';","export * from './js/dist/js/ked-backend-client-web';","var BearerStorageSessionStorage = /** @class */ (function () {\r\n    function BearerStorageSessionStorage() {\r\n    }\r\n    BearerStorageSessionStorage.prototype.save = function (id, tokenInfo) {\r\n        sessionStorage.setItem(\"bearer-\" + id, JSON.stringify(tokenInfo));\r\n    };\r\n    BearerStorageSessionStorage.prototype.load = function (id) {\r\n        try {\r\n            var json = sessionStorage.getItem(\"bearer-\" + id);\r\n            return Promise.resolve(json ? JSON.parse(json) : { token: null, expires: 0 });\r\n        }\r\n        catch (ex) {\r\n            return Promise.resolve({ token: null, expires: 0 });\r\n        }\r\n    };\r\n    return BearerStorageSessionStorage;\r\n}());\r\nexport { BearerStorageSessionStorage };\r\n//# sourceMappingURL=bearer-storage-sessionstorage.js.map","var redirHash = sessionStorage.getItem(\"redir-hash\");\r\nif (redirHash)\r\n    try {\r\n        var _a = JSON.parse(redirHash), time = _a.time, hash = _a.hash;\r\n        if (time && time > Date.now() - 60000) {\r\n            sessionStorage.removeItem(\"redir-hash\");\r\n            location.hash = hash;\r\n        }\r\n    }\r\n    catch (_) { }\r\nexport function rememberHashLocation() {\r\n    sessionStorage.setItem(\"redir-hash\", JSON.stringify({ time: Date.now(), hash: location.hash }));\r\n}\r\n//# sourceMappingURL=hash-restorer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendClient, HttpError } from '../ked-backend-client';\r\nimport { BearerStorageSessionStorage } from \"./bearer-storage-sessionstorage\";\r\nimport { avoidSimultanousCalls } from '../ked-backend-client/utils';\r\nimport { KedModelMigratorMixin } from '../ked-model-migrator';\r\nimport './hash-restorer';\r\nimport { rememberHashLocation } from './hash-restorer';\r\nKedModelMigratorMixin(KedBackendClient.prototype);\r\nexport var storage = new BearerStorageSessionStorage();\r\nvar timeOfPageLoad = Date.now();\r\nvar WebServerBearerProvider = /** @class */ (function () {\r\n    function WebServerBearerProvider(tokenPath, tokenResponseMapper, tokenId) {\r\n        this.tokenPath = tokenPath;\r\n        this.tokenResponseMapper = tokenResponseMapper;\r\n        this.tokenId = tokenId;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    WebServerBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!!this.tokenInfo.token) return [3 /*break*/, 2];\r\n                        if (!this.tokenId) return [3 /*break*/, 2];\r\n                        _a = this;\r\n                        return [4 /*yield*/, storage.load(this.tokenId)];\r\n                    case 1:\r\n                        _a.tokenInfo = _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        if (!(this.tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _b.sent();\r\n                        _b.label = 4;\r\n                    case 4: return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WebServerBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, _c, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0: return [4 /*yield*/, fetch(this.tokenPath, {\r\n                            headers: { Accept: \"text/plain; application/json\" },\r\n                            redirect: 'manual',\r\n                            cache: 'no-cache',\r\n                            credentials: \"same-origin\"\r\n                        })];\r\n                    case 1:\r\n                        res = _e.sent();\r\n                        if (res.status === 302 || (!res.status && res.type === \"opaqueredirect\")) {\r\n                            // User session timed out and server wants to redirect entire page to login page\r\n                            // Time to reload current page to force a redirect of the entire page instead for\r\n                            // just redirecting to /api/token or whatever.\r\n                            if (Date.now() - timeOfPageLoad > 60000) { // prohibit endless loop of reloading self.\r\n                                this.wantsRedirect = true; // So that listeners to onbeforeunload could show alternate message.\r\n                                console.log(\"Redirect wanted. Reload page.\");\r\n                                rememberHashLocation();\r\n                                window.location.reload(true);\r\n                                throw new HttpError(302, \"Redirected\");\r\n                            }\r\n                        }\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = Error.bind;\r\n                        _b = \"HTTP\" + res.status + \" \";\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(Error, [void 0, _b + (_e.sent())]))();\r\n                    case 3:\r\n                        _c = this;\r\n                        _d = this.tokenResponseMapper;\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 4:\r\n                        _c.tokenInfo = _d.apply(this, [_e.sent()]);\r\n                        storage.save(this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WebServerBearerProvider;\r\n}());\r\nexport { WebServerBearerProvider };\r\nexport var isomorphic = { fetch: fetch.bind(self), btoa: btoa.bind(self) };\r\nvar KedBackendClientWeb = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendClientWeb, _super);\r\n    function KedBackendClientWeb(apiBaseUrl, providerOrTokenPath, options) {\r\n        var _this = this;\r\n        var bearerProvider = typeof providerOrTokenPath !== 'string' ?\r\n            providerOrTokenPath :\r\n            new WebServerBearerProvider(providerOrTokenPath, (options && options.tokenResponseMapper) || (function (x) { return ({ token: x, expires: Date.now() + 59 * 60 * 60 }); }), options && options.tokenId);\r\n        _this = _super.call(this, isomorphic, bearerProvider, apiBaseUrl) || this;\r\n        return _this;\r\n    }\r\n    return KedBackendClientWeb;\r\n}(KedBackendClient));\r\nexport { KedBackendClientWeb };\r\n//# sourceMappingURL=index.js.map","var DocumentAccess = /** @class */ (function () {\r\n    function DocumentAccess(accessClaimType, accessClaimValue, right) {\r\n        this.accessClaimType = accessClaimType;\r\n        this.accessClaimValue = accessClaimValue;\r\n        this.right = right;\r\n    }\r\n    DocumentAccess.fromString = function (ac) {\r\n        if (!ac)\r\n            return null;\r\n        var split = ac.split(':');\r\n        if (split.length < 3)\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        var claimType = DocumentAccess.unescape(split[0]);\r\n        var claimValue = DocumentAccess.unescape(split[1]);\r\n        var right = split[2];\r\n        if (right !== 'R' && right !== 'W' && right !== 'S')\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        return new DocumentAccess(claimType, claimValue, right);\r\n    };\r\n    DocumentAccess.escape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%/g, \"%25\").replace(/\\:/g, \"%3A\");\r\n    };\r\n    DocumentAccess.unescape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%3A/g, \":\").replace(/\\%25/g, \"%\");\r\n    };\r\n    DocumentAccess.prototype.toString = function () {\r\n        return DocumentAccess.escape(this.accessClaimType) + \":\" +\r\n            DocumentAccess.escape(this.accessClaimValue) + \":\" +\r\n            this.right;\r\n    };\r\n    DocumentAccess.fromStringArray = function (acl) {\r\n        return acl\r\n            .map(function (ac) { return DocumentAccess.fromString(ac); })\r\n            .filter(function (ac) { return ac; });\r\n    };\r\n    DocumentAccess.toStringArray = function (acl) {\r\n        return acl.map(function (ac) { return ac.toString(); });\r\n    };\r\n    return DocumentAccess;\r\n}());\r\nexport { DocumentAccess };\r\nexport function hasAccess(acl, userClaims, requestedRight) {\r\n    if (userClaims.some(function (claim) { return claim.type === 'role' && claim.value === \"ADMIN\"; }))\r\n        return true;\r\n    return acl.some(function (a) {\r\n        return userClaims.some(function (c) {\r\n            return a.accessClaimType === c.type &&\r\n                a.accessClaimValue === c.value && ((a.right === 'R' && requestedRight === 'R') ||\r\n                (a.right === 'W' && ['R', 'W'].indexOf(requestedRight) >= 0) ||\r\n                (a.right === 'S'));\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=access-control.js.map","import * as tslib_1 from \"tslib\";\r\nvar HttpError = /** @class */ (function (_super) {\r\n    tslib_1.__extends(HttpError, _super);\r\n    function HttpError(code, message) {\r\n        var _this = _super.call(this, \"HTTP\" + code + \" \" + message) || this;\r\n        _this.code = code;\r\n        _this.message = message;\r\n        _this.name = \"http\" + code;\r\n        _this.message = \"HTTP\" + code + \" \" + message;\r\n        return _this;\r\n    }\r\n    return HttpError;\r\n}(Error));\r\nexport { HttpError };\r\n//# sourceMappingURL=http-error.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nexport * from './utils';\r\nexport { KedBearerProvider } from './ked-bearer-provider';\r\nexport * from './access-control';\r\nexport { RestClient };\r\nimport { HttpError } from './http-error';\r\nexport { HttpError };\r\nexport * from './restclient';\r\n;\r\n// | 'otherFlag' | 'thirdFlag';...\r\nvar KedBackendClient = /** @class */ (function () {\r\n    function KedBackendClient(isomorphic, bearerProvider, baseUrl) {\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n    }\r\n    KedBackendClient.prototype.getMyClaims = function (table, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"me/claims/\" + (table || \"\"), null, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.get = function (table, id, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(table + \"/\" + id, options, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.list = function (table, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = tslib_1.__assign({}, options);\r\n                        if (typeof location !== 'undefined' && location.search.includes('useSP')) {\r\n                            if (!options.from &&\r\n                                !options.to &&\r\n                                (!options.include || !options.include.includes(\"acl\")) &&\r\n                                !options.role &&\r\n                                !options.name &&\r\n                                [options.hasEdgesFrom, options.hasEdgesTo, options.ids, options.tags].filter(function (x) { return !!x; }).length === 1) {\r\n                                query.flags = (query.flags || []).concat(['useSP']);\r\n                            }\r\n                        }\r\n                        if (options && options.mutationsOnEmpty)\r\n                            query.mutationsOnEmpty = JSON.stringify(options.mutationsOnEmpty);\r\n                        return [4 /*yield*/, this.http.get(\"\" + table, query, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.batch = function (reqs, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        // Reorder operations so that 'add's come first and 'delete's come last:\r\n                        reqs = reqs.slice().sort(function (req1, req2) {\r\n                            return req1.op === 'add' ? -1 : req2.op === 'add' ? 1 :\r\n                                req1.op === 'delete' ? 1 : req2.op === 'delete' ? -1 : 0;\r\n                        });\r\n                        return [4 /*yield*/, this.http.post(\"batch\", reqs, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.do = function (scopeFn) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var runner;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        runner = new BatchRunner();\r\n                        scopeFn(runner);\r\n                        return [4 /*yield*/, this.batch(runner.mutationRequests)];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.deleteRealm = function (realm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.delete(\"realms/\" + realm)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.add = function (table, doc, branchId) {\r\n        return this.do(function (r) { return r.add(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.put = function (table, doc) {\r\n        return this.do(function (r) { return r.put(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        return this.do(function (r) { return r.update(table, id, deltaDoc, branchId); });\r\n    };\r\n    KedBackendClient.prototype.merge = function (branchId, targetBranchId) {\r\n        return this.do(function (r) { return r.merge(branchId, targetBranchId); });\r\n    };\r\n    KedBackendClient.prototype.clearBranch = function (branchId) {\r\n        return this.do(function (r) { return r.clearBranch(branchId); });\r\n    };\r\n    KedBackendClient.prototype.delete = function (table, id) {\r\n        return this.do(function (r) { return r.delete(table, id); });\r\n    };\r\n    KedBackendClient.prototype.share = function (table, id, acl) {\r\n        return this.do(function (r) { return r.share(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.unshare = function (table, id, acl) {\r\n        return this.do(function (r) { return r.unshare(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.link(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.link2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.link2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.unlink(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.unlink2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.unlink2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.undoLink = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.undoLink(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    return KedBackendClient;\r\n}());\r\nexport { KedBackendClient };\r\nvar BatchRunner = /** @class */ (function () {\r\n    function BatchRunner() {\r\n        this.mutationRequests = [];\r\n    }\r\n    BatchRunner.prototype.add = function (table, doc, branchId) {\r\n        this.mutationRequests.push({ op: 'add', table: table, doc: doc, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.put = function (table, doc) {\r\n        doc = tslib_1.__assign({}, doc);\r\n        delete doc.acl; // Forbidden to send acl with put() calls.\r\n        this.mutationRequests.push({ op: 'put', table: table, doc: doc });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        deltaDoc = tslib_1.__assign({}, deltaDoc);\r\n        this.mutationRequests.push({ op: 'update', table: table, id: id, deltaDoc: deltaDoc, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.merge = function (branchId, targetBranchId) {\r\n        this.mutationRequests.push({ op: 'merge', branchId: branchId, targetBranchId: targetBranchId });\r\n    };\r\n    BatchRunner.prototype.clearBranch = function (branchId) {\r\n        this.mutationRequests.push({ op: 'clear-branch', branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.delete = function (table, id) {\r\n        this.mutationRequests.push({ op: 'delete', table: table, id: id });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.share = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'share', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unshare = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'unshare', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unlink2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.undoLink = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'undo-link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    return BatchRunner;\r\n}());\r\nexport { BatchRunner };\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nimport { avoidSimultanousCalls } from './utils';\r\nvar KedBearerProvider = /** @class */ (function () {\r\n    function KedBearerProvider(isomorphic, storage, tokenId, clientId, clientSecret, tokenUrl, tokenQuery) {\r\n        this.isomorphic = isomorphic;\r\n        this.storage = storage;\r\n        this.tokenId = tokenId;\r\n        this.clientId = clientId;\r\n        this.clientSecret = clientSecret;\r\n        this.tokenUrl = tokenUrl;\r\n        this.tokenQuery = tokenQuery;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.client = new RestClient(isomorphic, \"\", {\r\n            username: this.clientId,\r\n            password: this.clientSecret\r\n        });\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    KedBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, token, expires, _b, e_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.tokenInfo, token = _a.token, expires = _a.expires;\r\n                        if (token && expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        _c.trys.push([1, 4, , 6]);\r\n                        _b = this;\r\n                        return [4 /*yield*/, this.storage.load(this.clientId + \"/\" + this.tokenId)];\r\n                    case 2:\r\n                        _b.tokenInfo = _c.sent();\r\n                        if (this.tokenInfo.token && this.tokenInfo.expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        e_1 = _c.sent();\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, retries, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        retries = 0;\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        if (!(retries < 6)) return [3 /*break*/, 5];\r\n                        console.log(\"Retrieving token for \" + this.tokenId);\r\n                        return [4 /*yield*/, this.client.get(this.tokenUrl, this.tokenQuery, { cache: 'reload' })];\r\n                    case 2:\r\n                        res = _c.sent();\r\n                        if (res.status !== 200) {\r\n                            console.warn(\"Got \" + res.status + \" \" + res.statusText);\r\n                            return [3 /*break*/, 4];\r\n                        }\r\n                        _a = this;\r\n                        _b = {};\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 3:\r\n                        _a.tokenInfo = (_b.token = _c.sent(), _b.expires = Date.now() + 59 * 60 * 1000, _b);\r\n                        console.log(\"Got token for \" + this.tokenId + \": \" + JSON.stringify(this.tokenInfo));\r\n                        this.storage.save(this.clientId + \"/\" + this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        ++retries;\r\n                        return [3 /*break*/, 1];\r\n                    case 5: throw new Error(\"Failed to retrieve token for \" + JSON.stringify(this.tokenId));\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBearerProvider;\r\n}());\r\nexport { KedBearerProvider };\r\n//# sourceMappingURL=ked-bearer-provider.js.map","/*\r\ndeclare var Buffer; // node built-in\r\n\r\n\r\nfunction basicAuthHeader(username, password) {\r\n    return \"Basic \" + new Buffer(username + \":\" + password).toString(\"base64\");\r\n}\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport { createUUID } from \"./utils\";\r\nimport { Emitter } from '../observable/emitter';\r\nvar RestClient = /** @class */ (function () {\r\n    function RestClient(isomorphic, baseUrl, options) {\r\n        this.isomorphic = isomorphic;\r\n        this.baseUrl = baseUrl;\r\n        this.options = options;\r\n        this.numOutstandingOperations = 0;\r\n        this.cache = {}; //, timeout: number}};\r\n        this._status = new Emitter(this);\r\n        this.fetchOptions = { mode: 'cors' };\r\n        this.authHeader = options.bearer ?\r\n            \"Bearer \" + options.bearer :\r\n            options.username ?\r\n                \"Basic \" + isomorphic.btoa(options.username + \":\" + (options.password || \"\")) :\r\n                null;\r\n        this.bearerProvider = options.bearerProvider || null;\r\n    }\r\n    Object.defineProperty(RestClient.prototype, \"status\", {\r\n        get: function () {\r\n            return this._status;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    RestClient.prototype.suspenseFetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        var key = method + \" \" + path + \" \" + JSON.stringify(headers) + \" \" + JSON.stringify(query) + \" \" + JSON.stringify(fetchOptions);\r\n        var entry = this.cache[key];\r\n        if (entry) {\r\n            // Entry found. Is it still being fetched?\r\n            if ('promise' in entry)\r\n                throw entry.promise; // Still being fetched. Multiple parallell fetches should work on same promise!\r\n            // Promise has resolved. Return result.\r\n            return entry.result;\r\n        }\r\n        else {\r\n            // We are the first to do this request. Start doing it:\r\n            var promise = this.fetch(path, method, headers, query, fetchOptions).then(function (res) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var status, text;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            status = res.status;\r\n                            return [4 /*yield*/, res.text()];\r\n                        case 1:\r\n                            text = _a.sent();\r\n                            this.cache[key] = {\r\n                                result: {\r\n                                    status: status,\r\n                                    text: function () { return text; },\r\n                                    json: function () { return JSON.parse(text); }\r\n                                }\r\n                            };\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); });\r\n            // Immediately put the promise in the cache. Multiple parallell fetches should work on the same promise!\r\n            this.cache[key] = { promise: promise };\r\n            // Suspend until promise is resolved. At that time, the cache will contain an answer!\r\n            throw promise;\r\n        }\r\n    };\r\n    RestClient.prototype.fetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        ++this.numOutstandingOperations;\r\n        this._status.dispatch(this);\r\n        return this._fetch(path, method, headers, query, fetchOptions)\r\n            .then(function (res) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return res;\r\n        }).catch(function (err) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return Promise.reject(err);\r\n        });\r\n    };\r\n    RestClient.prototype._fetch = function (path, method, headers, query, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var queryStr, _a, authHeader, tokenInfo, bearerProvider, _b, _c, url, res, wwwauth, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0:\r\n                        if (fetchOptions && fetchOptions.cache === 'no-cache') {\r\n                            // Workaround for back-button not respecting cache control in Chrome/Opera.\r\n                            // Append a query parameter to force a cache entry\r\n                            query = tslib_1.__assign({}, query, { nocache: createUUID() });\r\n                        }\r\n                        queryStr = query && Object.keys(query).filter(function (key) { return query[key] !== undefined; }).map(function (key) {\r\n                            return encodeURIComponent(key) +\r\n                                \"=\" +\r\n                                encodeURIComponent(query[key]);\r\n                        })\r\n                            .join('&');\r\n                        _a = this, authHeader = _a.authHeader, tokenInfo = _a.tokenInfo, bearerProvider = _a.bearerProvider;\r\n                        if (!(!authHeader && !tokenInfo && bearerProvider)) return [3 /*break*/, 2];\r\n                        _b = this;\r\n                        return [4 /*yield*/, bearerProvider.getBearer()];\r\n                    case 1:\r\n                        _b.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 2;\r\n                    case 2:\r\n                        if (!tokenInfo) return [3 /*break*/, 5];\r\n                        if (!(tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        console.log(\"Token expired. Refresh it:\");\r\n                        _c = this;\r\n                        return [4 /*yield*/, bearerProvider.refreshBearer()];\r\n                    case 3:\r\n                        _c.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 4;\r\n                    case 4:\r\n                        authHeader = \"Bearer \" + tokenInfo.token;\r\n                        _e.label = 5;\r\n                    case 5:\r\n                        // In one way or another, we've concluded an Authorization header to use:\r\n                        if (authHeader) {\r\n                            headers.Authorization = authHeader;\r\n                        }\r\n                        url = this.baseUrl + path + (queryStr ? \"?\" + queryStr : \"\");\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 6:\r\n                        res = _e.sent();\r\n                        if (!(res.status == 401 && this.bearerProvider)) return [3 /*break*/, 9];\r\n                        wwwauth = res.headers.get(\"www-authenticate\");\r\n                        console.log(\"Got \" + res.status + \" from \" + (this.baseUrl + path));\r\n                        if (!(wwwauth && /Bearer/i.test(wwwauth))) return [3 /*break*/, 9];\r\n                        _d = this;\r\n                        return [4 /*yield*/, this.bearerProvider.refreshBearer()];\r\n                    case 7:\r\n                        _d.tokenInfo = _e.sent();\r\n                        headers.Authorization = \"Bearer \" + this.tokenInfo.token;\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 8:\r\n                        res = _e.sent();\r\n                        _e.label = 9;\r\n                    case 9: return [2 /*return*/, res];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    RestClient.prototype.get = function (path, query, fetchOptions) {\r\n        return this.fetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.suspenseGet = function (path, query, fetchOptions) {\r\n        return this.suspenseFetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.post = function (path, data, fetchOptions) {\r\n        return this.fetch(path, \"POST\", {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Accept\": \"application/json\"\r\n        }, null, tslib_1.__assign({}, fetchOptions, { body: JSON.stringify(data) }));\r\n    };\r\n    RestClient.prototype.delete = function (path, query, body, fetchOptions) {\r\n        return this.fetch(path, \"DELETE\", { Accept: \"application/json; text/plain\" }, query, tslib_1.__assign({}, fetchOptions, { body: body }));\r\n    };\r\n    return RestClient;\r\n}());\r\nexport { RestClient };\r\n//# sourceMappingURL=restclient.js.map","import * as tslib_1 from \"tslib\";\r\nexport function createUUID() {\r\n    // Decent solution from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript\r\n    var d = Date.now();\r\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n        var r = (d + Math.random() * 16) % 16 | 0;\r\n        d = Math.floor(d / 16);\r\n        return (c === 'x' ? r : (r & 0x7 | 0x8)).toString(16);\r\n    });\r\n    return uuid;\r\n}\r\nexport function avoidSimultanousCalls(method) {\r\n    var ongoingPromise = null;\r\n    return function () {\r\n        if (!ongoingPromise) {\r\n            ongoingPromise = method.apply(this, arguments).then(function (result) {\r\n                ongoingPromise = null;\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromise;\r\n    };\r\n}\r\nexport function getGlobalId(realm) {\r\n    var prefix = 'ec96b3be-45fc-41d3-b69e-';\r\n    var pad = ['50', '08', 'e1', '40', 'e4', 'e7'];\r\n    if (realm.length > 6)\r\n        throw new Error(\"Too long realm\");\r\n    for (var i = 0; i < realm.length; ++i) {\r\n        var hex = realm.charCodeAt(i).toString(16);\r\n        pad[i] = hex.length === 2 ?\r\n            hex :\r\n            '0' + hex;\r\n    }\r\n    return prefix + pad.join('');\r\n}\r\nexport function computePredestinatedId(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, data, digest, _a, i;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    data = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', data)];\r\n                case 1:\r\n                    digest = new (_a.apply(Uint8Array, [void 0, _b.sent()]))();\r\n                    i = 0;\r\n                    return [2 /*return*/, 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n                            var nibble = digest[i++] % 16 | 0;\r\n                            var washedNibble = c === 'x' ?\r\n                                nibble :\r\n                                nibble & 0x7 | 0x8;\r\n                            return washedNibble.toString(16);\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function simpleDigest(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, inputBytes, digestBytes, _a;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    inputBytes = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', inputBytes)];\r\n                case 1:\r\n                    digestBytes = new (_a.apply(Uint8Array, [void 0, _b.sent(), 0, 16]))();\r\n                    return [2 /*return*/, buf2hex(digestBytes)];\r\n            }\r\n        });\r\n    });\r\n}\r\nvar simpleDigestCache = {};\r\nexport function simpleDigestSuspense(inputs) {\r\n    var results = inputs.map(function (input) { return simpleDigestCache[input]; });\r\n    var unresolvedInputs = [];\r\n    results.forEach(function (result, index) {\r\n        if (!result)\r\n            unresolvedInputs.push(inputs[index]);\r\n    });\r\n    if (unresolvedInputs.length === 0)\r\n        return results;\r\n    throw Promise.all(unresolvedInputs.map(function (input) { return simpleDigest(input).then(function (result) { return simpleDigestCache[input] = result; }); }));\r\n}\r\nexport function buf2hex(buffer) {\r\n    return Array.prototype.map.call(buffer, function (x) { return ('00' + x.toString(16)).slice(-2); }).join('');\r\n}\r\nexport function updateArray(a, mapper) {\r\n    var retval = a;\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var t = a[i];\r\n        var mapped = mapper(t);\r\n        if (mapped !== t) {\r\n            if (retval === a)\r\n                retval = a.slice();\r\n            retval[i] = mapped;\r\n        }\r\n    }\r\n    return retval;\r\n}\r\n/*\r\nexport function updateArray<T>(a: T[], mapper: (t: T) => T | false): T[] {\r\n  let retval = a;\r\n  let j = 0;\r\n  for (let i=0,l=a.length; i<l; ++i, ++j) {\r\n    const t = a[i];\r\n    const mapped = mapper(t);\r\n    if (mapped === false) {\r\n      // Mapper wants to delete this doc.\r\n      if (retval === a) retval = a.slice();\r\n      retval.splice(j, 1);\r\n      --j; // compensate for ++j\r\n    } else if (mapped !== t) {\r\n      if (retval === a) retval = a.slice();\r\n      retval[j] = mapped;\r\n    }\r\n  }\r\n  return retval;\r\n}\r\n*/ \r\n//# sourceMappingURL=utils.js.map","import * as JsonSchema from \"kedbackend-schema/schema.json\";\r\nimport { getTableFromLabel } from \"./utils\";\r\nvar CacheBust = /** @class */ (function () {\r\n    function CacheBust() {\r\n    }\r\n    CacheBust.getCacheBust = function (table, query, user, includes) {\r\n        var involvedItems = CacheBust.getInvolvedItems(table, query, includes);\r\n        return involvedItems\r\n            .map(function (item) { return localStorage.getItem(\"cache-bust-\" + user + \"-\" + item); })\r\n            .filter(function (value) { return !!value; })\r\n            .join('/') || 'static';\r\n    };\r\n    CacheBust.invalidateCache = function (reqs, user) {\r\n        for (var _i = 0, _a = CacheBust.getCacheInvalidations(reqs); _i < _a.length; _i++) {\r\n            var item = _a[_i];\r\n            localStorage.setItem(\"cache-bust-\" + user + \"-\" + item, '' + Date.now());\r\n        }\r\n    };\r\n    CacheBust.getInvolvedItems = function (table, query, includes) {\r\n        var hasEdgesFrom = query.hasEdgesFrom;\r\n        var relatedTables = includes\r\n            .map(function (label) { return JsonSchema.tables[table].relationships[label]; })\r\n            .filter(function (table) { return !!table; });\r\n        if (hasEdgesFrom)\r\n            relatedTables.push(\"hef\" + table);\r\n        return [table, 'master', query.branchId].filter(function (x) { return !!x; }).concat(relatedTables).sort();\r\n    };\r\n    CacheBust.getCacheInvalidations = function (reqs) {\r\n        var invalidationSet = {};\r\n        reqs.forEach(function (req) {\r\n            switch (req.op) {\r\n                case 'add':\r\n                case 'put':\r\n                case 'delete':\r\n                case 'update':\r\n                    invalidationSet[req.table] = true;\r\n                    break;\r\n                case 'link':\r\n                case 'unlink':\r\n                case 'undo-link':\r\n                    invalidationSet[req.sourceTable] = true;\r\n                    invalidationSet[\"hef-\" + getTableFromLabel(req.sourceTable, req.label)] = true;\r\n                    break;\r\n                case 'clear-branch':\r\n                    invalidationSet[req.branchId] = true;\r\n                    break;\r\n                case 'merge':\r\n                    invalidationSet[req.branchId] = true;\r\n                    invalidationSet[req.targetBranchId || \"master\"] = true;\r\n                    break;\r\n            }\r\n        });\r\n        return Object.keys(invalidationSet);\r\n    };\r\n    return CacheBust;\r\n}());\r\nexport { CacheBust };\r\n//# sourceMappingURL=cache-bust.js.map","import * as tslib_1 from \"tslib\";\r\nimport { mergeDeltas } from '../delta-merge';\r\nexport function applyMutationsOnDeltas(branchId, deltas, mutations, optimistic, userDisplayName, hasAdditionalFilter) {\r\n    var _loop_1 = function (m) {\r\n        switch (m.op) {\r\n            case 'add-related':\r\n                //\r\n                // AddRelated RepoMutation\r\n                //\r\n                if (!hasAdditionalFilter && m.branchId === branchId) {\r\n                    deltas = [{\r\n                            type: 'add',\r\n                            sourceId: m.id,\r\n                            targetId: m.relatedDoc.id,\r\n                            label: m.graphProp,\r\n                            sourceTable: m.table,\r\n                            $meta: optimistic ? 'adding' : 'persisted',\r\n                            dateTime: Date.now(),\r\n                            targetName: m.relatedDoc.name,\r\n                            contributor: userDisplayName\r\n                        }].concat(deltas);\r\n                }\r\n                break;\r\n            case 'clear-branch':\r\n                //\r\n                // ClearBranch RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                break;\r\n            case 'delete':\r\n                //\r\n                // Delete RepoMutation\r\n                //\r\n                // This type of mutation can not be performed onto branches. There's no branchId property on m.\r\n                break;\r\n            case 'merge':\r\n                //\r\n                // Merge RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                else if (m.targetBranchId === branchId) {\r\n                    // This change will append new deltas to our deltas array but we don't know what would come.\r\n                    // Need to refetch from server.\r\n                    if (!optimistic)\r\n                        return { value: null }; // Caller should check for null and re-fetch data from server.\r\n                }\r\n                break;\r\n            case 'remove-related':\r\n                //\r\n                // Remove-Related RepoMutation\r\n                //\r\n                if (hasAdditionalFilter || m.branchId !== branchId)\r\n                    return \"continue\";\r\n                deltas = [{\r\n                        type: 'remove',\r\n                        sourceId: m.id,\r\n                        targetId: m.relatedDoc.id,\r\n                        targetName: m.relatedDoc.name,\r\n                        label: m.graphProp,\r\n                        sourceTable: m.table,\r\n                        contributor: userDisplayName,\r\n                        dateTime: Date.now(),\r\n                        $meta: optimistic ? 'adding' : 'persisted'\r\n                    }].concat(deltas);\r\n                break;\r\n            case 'undo-link':\r\n                //\r\n                // Undo-Link RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (d) {\r\n                        return (d.type === 'add' || d.type === 'remove' || d.type === 'undo-link') &&\r\n                            d.sourceId === m.id &&\r\n                            d.targetId === m.relatedId;\r\n                    });\r\n                    if (idx < 0)\r\n                        return \"continue\";\r\n                    // Found an \"add\" or \"remove\" delta to change:\r\n                    if (optimistic) {\r\n                        var deltaRelation = deltas[idx];\r\n                        // Mark the existing add/remove delta as currenlty being deleted\r\n                        deltas = deltas.slice(0, idx).concat([\r\n                            tslib_1.__assign({}, deltaRelation, { $meta: optimistic ? 'removing' : 'persisted' })\r\n                        ], deltas.slice(idx + 1));\r\n                    }\r\n                    else {\r\n                        // Persisted. Just remove it:\r\n                        deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                    }\r\n                }\r\n                break;\r\n            case 'update':\r\n                //\r\n                // Update RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (delta) {\r\n                        return delta.type === 'modify' &&\r\n                            delta.targetId === m.id;\r\n                    });\r\n                    if (idx < 0 && !hasAdditionalFilter) {\r\n                        deltas = [{\r\n                                type: 'modify',\r\n                                table: m.table,\r\n                                targetId: m.id,\r\n                                targetName: m.targetName,\r\n                                data: m.deltaDoc,\r\n                                dateTime: Date.now(),\r\n                                contributors: [userDisplayName],\r\n                                $meta: optimistic ? 'adding' : 'persisted',\r\n                            }].concat(deltas);\r\n                    }\r\n                    else {\r\n                        var existingDeltaDoc = deltas[idx];\r\n                        var contributors = existingDeltaDoc.contributors.slice();\r\n                        if (!contributors.includes(userDisplayName)) {\r\n                            contributors.push(userDisplayName);\r\n                        }\r\n                        var newData = mergeDeltas(existingDeltaDoc.data, m.deltaDoc, { removeUnsetProps: true });\r\n                        if (!optimistic && Object.keys(newData).length === 0) {\r\n                            // Committed mutation that resets a deltaDoc. Remove the deltaDoc entirely:\r\n                            deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                        }\r\n                        else {\r\n                            // \r\n                            deltas = [\r\n                                {\r\n                                    type: 'modify',\r\n                                    table: m.table,\r\n                                    targetId: m.id,\r\n                                    targetName: m.targetName,\r\n                                    data: newData,\r\n                                    dateTime: Date.now(),\r\n                                    contributors: contributors,\r\n                                    $meta: optimistic ? 'updating' : 'persisted',\r\n                                }\r\n                            ].concat(deltas.slice(0, idx), deltas.slice(idx + 1));\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n        }\r\n    };\r\n    for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\r\n        var m = mutations_1[_i];\r\n        var state_1 = _loop_1(m);\r\n        if (typeof state_1 === \"object\")\r\n            return state_1.value;\r\n    }\r\n    return deltas;\r\n}\r\n//# sourceMappingURL=apply-mutations-on-deltas.js.map","import * as tslib_1 from \"tslib\";\r\nimport { HttpError } from '../../ked-backend-client';\r\nimport { applyMutationsOnDeltas } from './apply-mutations-on-deltas';\r\nvar DeltaCache = /** @class */ (function () {\r\n    function DeltaCache(getClient, getUser, getUserDisplayName) {\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.lookup = {};\r\n    }\r\n    DeltaCache.prototype.applyMutations = function (mutations, _a) {\r\n        var optimistic = (_a === void 0 ? { optimistic: false } : _a).optimistic;\r\n        // Apply mutations locally onto the DeltaCache and notify their subscribers\r\n        for (var _i = 0, _b = Object.keys(this.lookup); _i < _b.length; _i++) {\r\n            var queryKey = _b[_i];\r\n            var cacheEntry = this.lookup[queryKey];\r\n            if (cacheEntry.value) {\r\n                // Instead here: Store the mutations on cacheEntry. No matter if it yet has value or not.\r\n                // Then apply mutation whenever subscribing! (Better handling of mutations that arrives before fetch() is done)\r\n                // (See how I handle this in query-set.ts)\r\n                var newValue = applyMutationsOnDeltas(cacheEntry.query.branchId, cacheEntry.value, mutations, optimistic, this.getUserDisplayName(), !!cacheEntry.query.tags);\r\n                if (newValue === null) {\r\n                    // The mutation requires cacheEntry to be refetched from server\r\n                    if (!optimistic) {\r\n                        // Caller has successfully performed the mutations and got success back from server.\r\n                        // It's ok to refetch the deltas from server now:\r\n                        cacheEntry.fetch();\r\n                        // After fetch completes, it will notify the subscribers.\r\n                    }\r\n                }\r\n                if (newValue !== cacheEntry.value) {\r\n                    cacheEntry.optimisticValue = newValue;\r\n                    if (!optimistic)\r\n                        cacheEntry.value = newValue;\r\n                    cacheEntry.notify(newValue);\r\n                }\r\n            }\r\n        }\r\n    };\r\n    DeltaCache.prototype.subscribe = function (query, observer) {\r\n        var _this = this;\r\n        var cacheEntry = this.lookup[query.branchId + query.tags];\r\n        if (!cacheEntry) {\r\n            cacheEntry = new DeltaCacheEntry(this.getClient(), query);\r\n            this.lookup[query.branchId + query.tags] = cacheEntry;\r\n        }\r\n        if (cacheEntry.cleanupTimer) {\r\n            clearTimeout(cacheEntry.cleanupTimer);\r\n            cacheEntry.cleanupTimer = null;\r\n        }\r\n        var subscription = {\r\n            unsubscribe: function () {\r\n                cacheEntry.subscribers = cacheEntry.subscribers.filter(function (_a) {\r\n                    var o = _a.observer;\r\n                    return o !== observer;\r\n                });\r\n                if (cacheEntry.subscribers.length === 0) {\r\n                    cacheEntry.cleanupTimer = setTimeout(function () {\r\n                        if (cacheEntry.subscribers.length === 0) {\r\n                            delete _this.lookup[query.branchId + query.tags];\r\n                        }\r\n                    }, 100);\r\n                }\r\n            }\r\n        };\r\n        cacheEntry.subscribers.push({ observer: observer, subscription: subscription });\r\n        if (cacheEntry.value) {\r\n            // Value has been successfully retrieved already. Pick from cache.\r\n            observer(cacheEntry.optimisticValue || cacheEntry.value, null, subscription);\r\n        }\r\n        else if (cacheEntry.isFetching) {\r\n            // A value is on its way. Sit back and relax. All registered\r\n            // observers (including this one) will be notified when data arrives\r\n            // or fails.\r\n        }\r\n        else if (cacheEntry.error) {\r\n            observer(null, cacheEntry.error, subscription);\r\n        }\r\n        else {\r\n            cacheEntry.fetch();\r\n        }\r\n        return subscription;\r\n    };\r\n    return DeltaCache;\r\n}());\r\nexport { DeltaCache };\r\nvar DeltaCacheEntry = /** @class */ (function () {\r\n    function DeltaCacheEntry(client, query) {\r\n        this.fetchOperationId = 0; // Makes sure a re-fetch will discard the result from any ongoing fetch.\r\n        this.client = client;\r\n        this.query = query;\r\n        this.value = null;\r\n        this.error = null;\r\n        this.optimisticValue = null;\r\n        this.subscribers = [];\r\n        this.isFetching = false;\r\n        this.cleanupTimer = null;\r\n    }\r\n    DeltaCacheEntry.prototype.fetch = function () {\r\n        var _this = this;\r\n        var fetchOperationId = ++this.fetchOperationId;\r\n        this.isFetching = true;\r\n        this.fetchFromServer().then(function (value) {\r\n            // Success\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                value.sort(function (a, b) { return b.dateTime - a.dateTime; }); // Latest first\r\n                _this.value = value;\r\n                _this.optimisticValue = value;\r\n                _this.notify(value);\r\n            }\r\n        }).catch(function (error) {\r\n            // Fail\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                _this.error = error;\r\n                _this.fail(error);\r\n            }\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.fetchFromServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!this.query.branchId)\r\n                            throw new Error('Deltas only available on branches');\r\n                        return [4 /*yield*/, this.client.http.get('deltas', this.query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status >= 300 || res.status < 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.notify = function (value) {\r\n        for (var _i = 0, _a = this.subscribers; _i < _a.length; _i++) {\r\n            var _b = _a[_i], observer = _b.observer, subscription = _b.subscription;\r\n            observer(value, null, subscription);\r\n        }\r\n    };\r\n    DeltaCacheEntry.prototype.fail = function (error) {\r\n        var copy = this.subscribers.slice();\r\n        this.subscribers = [];\r\n        for (var _i = 0, copy_1 = copy; _i < copy_1.length; _i++) {\r\n            var _a = copy_1[_i], observer = _a.observer, subscription = _a.subscription;\r\n            observer(null, error, subscription);\r\n        }\r\n    };\r\n    return DeltaCacheEntry;\r\n}());\r\n//# sourceMappingURL=delta-cache.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Collection } from '../../observable';\r\nvar DeltaCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(DeltaCollection, _super);\r\n    function DeltaCollection(deltaCache, query) {\r\n        var _this = _super.call(this, function (observer) { return _this.deltaCache.subscribe(query, observer); }) || this;\r\n        _this.deltaCache = deltaCache;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    DeltaCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return new DeltaCollection(this.deltaCache, tslib_1.__assign({}, this.query, { tags: tags }));\r\n    };\r\n    return DeltaCollection;\r\n}(Collection));\r\nexport { DeltaCollection };\r\n//# sourceMappingURL=delta-collection.js.map","import * as tslib_1 from \"tslib\";\r\nexport function applyDelta(doc, delta) {\r\n    var keys = Object.keys(delta);\r\n    var targetDoc = doc;\r\n    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\r\n        var key = keys_1[_i];\r\n        if (targetDoc === doc)\r\n            targetDoc = tslib_1.__assign({}, doc);\r\n        var val = delta[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_1 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            // Do nothing on target doc!\r\n                            targetDoc.$wasUnset = true; // Just mark it for re-retrieval after successful posting changes.\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd = miValue;\r\n                            if (!Array.isArray(valuesToAdd)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            else {\r\n                                targetArray = targetArray.slice(); // On JS side, we must be immutable\r\n                            }\r\n                            targetDoc[key] = targetArray;\r\n                            for (var _i = 0, valuesToAdd_1 = valuesToAdd; _i < valuesToAdd_1.length; _i++) {\r\n                                var v = valuesToAdd_1[_i];\r\n                                if (!targetArray.includes(v)) { // avoid dups\r\n                                    targetArray.push(v);\r\n                                }\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_1 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_1)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            targetDoc[key] = targetArray.filter(function (t) { return !valuesToRemove_1.includes(t); });\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _a = 0, metaInstructions_1 = metaInstructions; _a < metaInstructions_1.length; _a++) {\r\n                    var mi = metaInstructions_1[_a];\r\n                    _loop_1(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDoc[key] = val;\r\n    }\r\n    return targetDoc;\r\n}\r\n// {name: \"Ulla\"}, {name: {$unset:0}\r\n// {tags: {$add: \"hej\"}}, {tags: {$unset:0}\"}\r\nexport function mergeDeltas(delta1, delta2, _a) {\r\n    var removeUnsetProps = (_a === void 0 ? { removeUnsetProps: false } : _a).removeUnsetProps;\r\n    //return {...delta1, ...delta2};\r\n    var keys = Object.keys(delta2);\r\n    var targetDelta = tslib_1.__assign({}, delta1);\r\n    for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {\r\n        var key = keys_2[_i];\r\n        var val = delta2[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_2 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            if (removeUnsetProps) {\r\n                                delete targetDelta[key];\r\n                            }\r\n                            else {\r\n                                // No matter if targetDelta is empty or has value. Set it to {$unset:0}\r\n                                // to make sure the very end result will have {$unset:0}\r\n                                targetDelta[key] = { $unset: 0 };\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd_2 = miValue;\r\n                            if (!Array.isArray(valuesToAdd_2)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$remove: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$add: [...]} arrays.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetRemoveArray)) {\r\n                                targetMetaProp.$remove =\r\n                                    targetRemoveArray.filter(function (t) { return !valuesToAdd_2.includes(t); });\r\n                                if (targetMetaProp.$remove.length === 0) {\r\n                                    // If $remove array became emtpy. Remove the $remove prop.\r\n                                    delete targetMetaProp.$remove;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $add array.\r\n                            var targetAddArray = targetMetaProp.$add;\r\n                            targetAddArray = targetAddArray ? targetAddArray.concat(valuesToAdd_2) : valuesToAdd_2.slice();\r\n                            targetMetaProp.$add = targetAddArray;\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_2 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_2)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$add: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$remove: [...]} arrays.\r\n                            var targetAddArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetAddArray)) {\r\n                                targetMetaProp.$add =\r\n                                    targetAddArray.filter(function (t) { return !valuesToRemove_2.includes(t); });\r\n                                if (targetMetaProp.$add.length === 0) {\r\n                                    // If $add array became emtpy. Remove the $add prop.\r\n                                    delete targetMetaProp.$add;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $remove array.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            targetRemoveArray = targetRemoveArray ? targetRemoveArray.concat(valuesToRemove_2) : valuesToRemove_2.slice();\r\n                            targetMetaProp.$remove = targetRemoveArray;\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _b = 0, metaInstructions_2 = metaInstructions; _b < metaInstructions_2.length; _b++) {\r\n                    var mi = metaInstructions_2[_b];\r\n                    _loop_2(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDelta[key] = val;\r\n    }\r\n    return targetDelta;\r\n}\r\n//# sourceMappingURL=delta-merge.js.map","export * from './kedbackend-collection';\r\nexport * from './kedbackend-query';\r\nexport * from './kedbackend-repo';\r\nexport * from './kedbackend-subscription';\r\nexport * from './kedbackend-writer';\r\nexport * from './mutation-queue';\r\nexport * from './query-set';\r\nexport * from '../observable/mixin';\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { KedBackendSubscription } from \"./kedbackend-subscription\";\r\nimport { CacheBust } from './cache-bust';\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport { Collection } from '../observable/collection';\r\n/**\r\n * Represents a \"live\" query against a table or filtered table.\r\n */\r\nvar KedBackendCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendCollection, _super);\r\n    function KedBackendCollection(repo, table, query) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = new KedBackendSubscription(observer, _this);\r\n            _this.repo.querySet.subscribe(subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.repo = repo;\r\n        _this.table = table;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    Object.defineProperty(KedBackendCollection.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendCollection.prototype, \"includes\", {\r\n        get: function () {\r\n            return this._includes || (this._includes = [].concat(this.query.include || []));\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendCollection.prototype.applyQuery = function (query) {\r\n        return new KedBackendCollection(this.repo, this.table, tslib_1.__assign({}, this.query, query));\r\n    };\r\n    KedBackendCollection.prototype.addToQueryArrayProp = function (arrayProp, entries) {\r\n        var _a;\r\n        return this.applyQuery((_a = {}, _a[arrayProp] = (this.query[arrayProp] || []).concat(entries), _a));\r\n    };\r\n    KedBackendCollection.prototype.addFlags = function () {\r\n        var flags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            flags[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"flags\", flags);\r\n    };\r\n    KedBackendCollection.prototype.debug = function () {\r\n        return this.applyQuery({ debug: true });\r\n    };\r\n    KedBackendCollection.prototype.idsOnly = function () {\r\n        return this.addFlags(\"idsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.idsAndNamesOnly = function () {\r\n        return this.addFlags(\"idsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsOnly = function () {\r\n        return this.addFlags(\"includeIdsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsAndNamesOnly = function () {\r\n        return this.addFlags(\"includeIdsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.between = function (from, to) {\r\n        return this.applyQuery({ from: from, to: to });\r\n    };\r\n    KedBackendCollection.prototype.role = function (role) {\r\n        return this.applyQuery({ role: role });\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesFrom = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesFrom(\" + JSON.stringify(ids) + \")\");\r\n        var hef = this.addToQueryArrayProp(\"hasEdgesFrom\", ids);\r\n        return hef;\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesTo = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesTo(\" + JSON.stringify(ids) + \")\");\r\n        var het = this.addToQueryArrayProp(\"hasEdgesTo\", ids);\r\n        return het;\r\n    };\r\n    KedBackendCollection.prototype.id = function (id) {\r\n        var _this = this;\r\n        return this.applyQuery({ ids: [id] }).single({\r\n            onZero: function () { throw new Error(\"Could not find entity in \" + _this.table + \" with id \" + id); },\r\n            onMany: function () { throw new Error(\"Multiple entries in \" + _this.table + \" with id \" + id); },\r\n        });\r\n    };\r\n    KedBackendCollection.prototype.ids = function (ids) {\r\n        return this.applyQuery({ ids: ids });\r\n    };\r\n    KedBackendCollection.prototype.name = function (name) {\r\n        return this.applyQuery({ name: name });\r\n    };\r\n    KedBackendCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return this.applyQuery({ tags: tags });\r\n    };\r\n    KedBackendCollection.prototype.branchId = function (branchId) {\r\n        return this.applyQuery({ branchId: branchId });\r\n    };\r\n    KedBackendCollection.prototype.include = function () {\r\n        var graphs = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            graphs[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"include\", graphs);\r\n    };\r\n    KedBackendCollection.prototype.cacheOptimized = function (onOrOff) {\r\n        return onOrOff === undefined || onOrOff === true ?\r\n            this.applyQuery({ cacheBust: CacheBust.getCacheBust(this.table, this.query, this.repo.getUser(), this.includes) }) :\r\n            this.applyQuery({ cacheBust: undefined });\r\n    };\r\n    KedBackendCollection.prototype.mutationsOnEmpty = function (mutationFactory) {\r\n        var tx = new BatchRunner();\r\n        mutationFactory(tx);\r\n        return this.applyQuery({ mutationsOnEmpty: tx.mutationRequests });\r\n    };\r\n    KedBackendCollection.prototype.single = function (throwers) {\r\n        var _this = this;\r\n        var _a = throwers || {}, onZero = _a.onZero, onMany = _a.onMany;\r\n        return this.toValue().map(function (items) {\r\n            if (items.length === 0) {\r\n                if (onZero)\r\n                    onZero();\r\n                else\r\n                    throw new Error(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but none was found.\");\r\n            }\r\n            if (items.length > 1) {\r\n                debugger;\r\n                if (onMany)\r\n                    onMany();\r\n                else\r\n                    console.log(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but \" + items.length + \" was found.\");\r\n            }\r\n            return items[0];\r\n        });\r\n    };\r\n    /*combineLatest<TOther>(other: QueryObservable<TOther>) {\r\n      return this.render(x => x).combineLatest(other);\r\n    }*/\r\n    KedBackendCollection.prototype.update = function (doc, changes, debounce) {\r\n        if (debounce === void 0) { debounce = 1000; }\r\n        this.repo.writer.mutate([{\r\n                op: 'update',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: doc.id,\r\n                deltaDoc: changes,\r\n                targetName: doc.name\r\n            }], debounce);\r\n    };\r\n    KedBackendCollection.prototype.addRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.add = function (doc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add',\r\n                id: doc.id,\r\n                table: this.table,\r\n                doc: doc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.removeRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'remove-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.undoLink = function (id, label, relatedId) {\r\n        if (!this.query.branchId)\r\n            throw new Error(\"undo links can only be performed on branches\");\r\n        this.repo.writer.mutate([{\r\n                op: 'undo-link',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedId: relatedId\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.delete = function () {\r\n        var _this = this;\r\n        var ids = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            ids[_i] = arguments[_i];\r\n        }\r\n        this.repo.writer.mutate(ids.map(function (id) { return ({\r\n            op: 'delete',\r\n            table: _this.table,\r\n            id: id\r\n        }); }), 0);\r\n    };\r\n    KedBackendCollection.prototype.unsubscribe = function (subscription) {\r\n        this.repo.querySet.unsubscribe(subscription);\r\n    };\r\n    return KedBackendCollection;\r\n}(Collection));\r\nexport { KedBackendCollection };\r\n/*mixin(\r\n  KedBackendCollection.prototype,\r\n  MappedCollection.prototype,\r\n  \"map\", \"flat\", \"concat\", \"render\", \"load\");*/\r\n//# sourceMappingURL=kedbackend-collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { updateArray } from '../ked-backend-client/utils';\r\nimport { branchSensitive, getTableFromLabel } from './utils';\r\nimport { applyDelta } from './delta-merge';\r\nvar KedBackendQuery = /** @class */ (function () {\r\n    function KedBackendQuery(table, query, user, repo, mutationQueue) {\r\n        this.table = table;\r\n        this.query = query;\r\n        this.user = user;\r\n        this.repo = repo;\r\n        this.mutationQueue = mutationQueue;\r\n        this.subscriptions = [];\r\n        this.data = [];\r\n        this.gotInitialResponse = false;\r\n        this.invalid = false;\r\n        this.loadedVersion = 0;\r\n        this._loadPromise = null;\r\n        this.includes = query.include ?\r\n            typeof query.include === 'string' ?\r\n                [query.include] :\r\n                query.include :\r\n            [];\r\n    }\r\n    KedBackendQuery.queryKey = function (table, query) {\r\n        var mutationsOnEmpty = query.mutationsOnEmpty, comparableProps = tslib_1.__rest(query, [\"mutationsOnEmpty\"]);\r\n        return table + JSON.stringify(comparableProps);\r\n    };\r\n    Object.defineProperty(KedBackendQuery.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendQuery.prototype.subscribe = function (subscription) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.subscriptions.push(subscription);\r\n                        if (!(this.gotInitialResponse && !this.invalid)) return [3 /*break*/, 1];\r\n                        data = this.getDataWithMutationsApplied(this.mutationQueue.get(), true, this.data);\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 1:\r\n                        data = this.queryLocally();\r\n                        if (!data) return [3 /*break*/, 2];\r\n                        this.data = data;\r\n                        this.error = null;\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.load()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var loadPromise;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.gotInitialResponse) {\r\n                            // mutationsOnEmpty should never be used twice.\r\n                            delete this.query.mutationsOnEmpty;\r\n                        }\r\n                        if (!(!version && this._loadPromise)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this._loadPromise];\r\n                    case 1: \r\n                    // loading is ongoing, and caller does not require a recent refresh.\r\n                    // wait for the ongoing load to complete\r\n                    return [2 /*return*/, _a.sent()];\r\n                    case 2:\r\n                        version = version || this.repo.writer.persistedVersion.value;\r\n                        loadPromise = this._loadPromise = this._load(version).then(function (data) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                _this.data = data;\r\n                                _this.loadedVersion = Math.max(_this.loadedVersion, version);\r\n                            }\r\n                        }).catch(function (error) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. The error is the final result. Set it.\r\n                                _this.error = error;\r\n                            }\r\n                        }).then(function () {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. We're finished. Data or error is already set.\r\n                                // Mark gotInitialResponse to true and notify subscribers.\r\n                                _this._loadPromise = null;\r\n                                _this.gotInitialResponse = true;\r\n                                _this.notifySubscribers(_this.mutationQueue.get());\r\n                            }\r\n                            else {\r\n                                // A more recent call to load() is ongoing, OR was ongoing but responded\r\n                                // before us.\r\n                                // In any case return this._loadPromise. If it's ongoing we'll wait for it\r\n                                // to finish. If it's null, we'll be returning finally here without\r\n                                // any action, because the action was taken by the refresher.\r\n                                return _this._loadPromise; // Wait for the refreshed load to complete\r\n                            }\r\n                        });\r\n                        return [4 /*yield*/, loadPromise];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype._load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.mutationQueue.affectsQuery(this.table, this.query, this.includes)) return [3 /*break*/, 2];\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        return [4 /*yield*/, this.repo.writer.waitForVersionToPersist(version)];\r\n                    case 1:\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [4 /*yield*/, this.queryServer()];\r\n                    case 3: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.unsubscribe = function (subscription) {\r\n        this.subscriptions = this.subscriptions.filter(function (s) { return s !== subscription; });\r\n    };\r\n    KedBackendQuery.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _i, mutations_1, m, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.data) return [3 /*break*/, 9];\r\n                        _i = 0, mutations_1 = mutations;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < mutations_1.length)) return [3 /*break*/, 8];\r\n                        m = mutations_1[_i];\r\n                        if (!(m.op === 'clear-branch' && (m.branchId === this.query.branchId))) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 3:\r\n                        if (!(m.op === 'merge' && (!m.targetBranchId ||\r\n                            m.branchId === this.query.branchId ||\r\n                            m.targetBranchId === this.query.branchId))) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 5:\r\n                        if (!(m.op === 'update' && ((m.deltaDoc.tags && this.query.tags) ||\r\n                            (m.deltaDoc.name && this.query.name)))) return [3 /*break*/, 7];\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 6:\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 7:\r\n                        _i++;\r\n                        return [3 /*break*/, 1];\r\n                    case 8:\r\n                        data = this.getDataWithMutationsApplied(mutations, false, this.data);\r\n                        this.data = data;\r\n                        _a.label = 9;\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.refreshOrInvalidate = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(this.subscriptions.length === 0)) return [3 /*break*/, 1];\r\n                        this.invalid = true;\r\n                        return [3 /*break*/, 3];\r\n                    case 1: return [4 /*yield*/, this.load(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.notifySubscribers = function (optimisticMutations) {\r\n        var _this = this;\r\n        if (this.data && this.gotInitialResponse) {\r\n            var data_1 = this.getDataWithMutationsApplied(optimisticMutations, true, this.data);\r\n            this.subscriptions.forEach(function (s) {\r\n                s.notifySubscriber(data_1, _this.error);\r\n            });\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.queryLocally = function () {\r\n        return this.repo.querySet.queryLocally(this.table, this.query, this.includes);\r\n    };\r\n    KedBackendQuery.prototype.queryServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.repo.getClient().list(this.table, tslib_1.__assign({}, this.query))];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        return [2 /*return*/, data];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.getDataWithMutationsApplied = function (mutations, optimistic, data) {\r\n        var _this = this;\r\n        mutations.forEach(function (mutation) {\r\n            data = _this.applyMutationsOnData(data, mutation, optimistic);\r\n        });\r\n        return data;\r\n    };\r\n    KedBackendQuery.prototype.applyMutationsOnData = function (data, m, optimistic) {\r\n        if (branchSensitive(m) && m.branchId != this.query.branchId)\r\n            return data;\r\n        var _a = this, table = _a.table, includes = _a.includes, listOptions = _a.query;\r\n        var sourceIds = listOptions.hasEdgesFrom ? [].concat(listOptions.hasEdgesFrom || []) : [];\r\n        var requestedTags = listOptions.tags ? [].concat(listOptions.tags || []) : [];\r\n        switch (m.op) {\r\n            case 'update': {\r\n                return updateArray(data, function (doc) {\r\n                    if (doc.id === m.id) {\r\n                        // Apply delta on updated document\r\n                        var updatedDoc = applyDelta(doc, m.deltaDoc);\r\n                        if (optimistic)\r\n                            updatedDoc.$meta = 'updating';\r\n                        return updatedDoc;\r\n                    }\r\n                    // If id does not apply to this doc, search in graphs the id is found\r\n                    // among graph included docs, and if so, update that one:\r\n                    includes.forEach(function (label) {\r\n                        var _a;\r\n                        var includedDocs = doc[label];\r\n                        if (includedDocs) {\r\n                            var updatedArray = updateArray(includedDocs, function (related) {\r\n                                if (related.id !== m.id)\r\n                                    return related;\r\n                                var updatedRelated = applyDelta(related, m.deltaDoc);\r\n                                if (optimistic)\r\n                                    updatedRelated.$meta = 'updating';\r\n                                return updatedRelated;\r\n                            });\r\n                            if (updatedArray !== includedDocs) {\r\n                                doc = tslib_1.__assign({}, doc, (_a = {}, _a[label] = updatedArray, _a));\r\n                            }\r\n                        }\r\n                    });\r\n                    return doc;\r\n                });\r\n            }\r\n            case 'add':\r\n                if (table === m.table) {\r\n                    if (listOptions.tags) {\r\n                        var queriedTags_1 = [].concat(listOptions.tags); // tag can be either string or string[]. Make is string[] always.\r\n                        if (m.doc.tags && m.doc.tags.some(function (tag) { return queriedTags_1.includes(tag); })) {\r\n                            return data.concat([m.doc]); // Make the added doc appear in the result (optimistic mutation)\r\n                        }\r\n                    }\r\n                    // Todo, apply also for other list options, like ids:\r\n                    // The above code for 'add' was only written to cover the use case of teachers-page notifications!\r\n                }\r\n                return data; // fallback case - query was not affected.\r\n            case 'add-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    // If expression is `db.courseBlocks....whatever.. .include(\"abilities\")`, detect: db.courseBlocks.addRelated(blockId, 'abilities', ...)\r\n                    // ...because table = 'courseBlocks' and includes has \"abilities\".\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        var relatedDoc = tslib_1.__assign({}, m.relatedDoc);\r\n                        if (optimistic)\r\n                            relatedDoc.$meta = 'adding';\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = doc[m.graphProp].concat([relatedDoc]), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id)) {\r\n                        // If expression is:\r\n                        //   `db.courseBlocks.hasEdgesFrom([courseId])`  (meaning table='courseBlocks' and sourceIds includes courseId)\r\n                        // , detect: db.courseInstances.addRelated(courseId, 'courseBlocks', ....) // m.graphProp === 'blocks'--> getTableFromLabel --> 'courseBlocks'\r\n                        if (table === getTableFromLabel(m.table, m.graphProp)) {\r\n                            if (!listOptions.tags)\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            if (m.relatedDoc.tags && requestedTags.some(function (tag) { return m.relatedDoc.tags.includes(tag); })) {\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (listOptions.ids && listOptions.ids.some(function (id) { return id === m.relatedDoc.id; })) {\r\n                    // A certain ID is observed. A doc with this id is being added.\r\n                    // Add the doc to the result. Exactly this WILL happen in the following typical scenario:\r\n                    // 1. User adds a related document to a list.\r\n                    // 2. Document remains within the MutationQueue while batch-request is being processed by server.\r\n                    // 3. User clicks the added item to edit or view it (or our component redirects to its editor)\r\n                    // 4. A new query of that particular ID is subscribed to {ids=[theId]}\r\n                    //    KedBackendQuery.subscribe then does this:\r\n                    //      1. Call queryLocally() before querying server\r\n                    //      2. queryLocally() inspects mutations and finds a match, returning an empty list\r\n                    //         (assumes as we are adding it, it can't exist on the server anyway)\r\n                    //      3. KedBackendQUery applies mutations onto the empty list, and ends up here to add\r\n                    //         it optimistically.\r\n                    //      4. When server responds with 200 OK, calls us here again with optimistic=false\r\n                    //         to \"persist\" it in the query's data array.\r\n                    //      4B: If not 200 OK, mutation may be gone and the subscriber will se an error page\r\n                    //         \"Could not find entity with id X.\" along with a red error message on the screen\r\n                    //         about that it failed to save on server.\r\n                    return data.concat(this.setGraphProps(m.relatedDoc));\r\n                }\r\n                return data;\r\n            case 'remove-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        var includedDocs = doc[m.graphProp];\r\n                        if (!includedDocs)\r\n                            return doc;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = optimistic ?\r\n                            // Mark related-doc-to-remove with $meta: 'deleting'\r\n                            includedDocs.map(function (d) { return d.id !== m.relatedDoc.id ?\r\n                                d : tslib_1.__assign({}, d, { $meta: 'deleting' }); }) :\r\n                            // Delete related-doc-to-remove from doc[grapProp]:\r\n                            includedDocs.filter(function (d) { return d.id !== m.relatedDoc.id; }), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id))\r\n                        return optimistic ?\r\n                            data.map(function (d) { return d.id === m.relatedDoc.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                            data.filter(function (d) { return d.id !== m.relatedDoc.id; });\r\n                }\r\n                return data;\r\n            case 'delete':\r\n                if (table === m.table) {\r\n                    return data.filter(function (d) { return d.id !== m.id; });\r\n                }\r\n                else if (listOptions.include) {\r\n                    var includedTables = includes\r\n                        .map(function (label) { return ({ label: label, table: getTableFromLabel(table, label) }); });\r\n                    var labels_1 = includedTables.filter(function (_a) {\r\n                        var table = _a.table;\r\n                        return table === m.table;\r\n                    });\r\n                    if (labels_1.length > 0) {\r\n                        return updateArray(data, function (doc) {\r\n                            labels_1.forEach(function (_a) {\r\n                                var label = _a.label;\r\n                                var _b;\r\n                                var relatedDocs = doc[label];\r\n                                if (relatedDocs) {\r\n                                    doc = tslib_1.__assign({}, doc, (_b = {}, _b[label] = optimistic ?\r\n                                        relatedDocs.map(function (d) { return d.id === m.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                                        relatedDocs.filter(function (_a) {\r\n                                            var id = _a.id;\r\n                                            return id !== m.id;\r\n                                        }), _b));\r\n                                }\r\n                            });\r\n                            return doc;\r\n                        });\r\n                    }\r\n                }\r\n                return data;\r\n            default:\r\n                return data;\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.setGraphProps = function (doc) {\r\n        var copy = tslib_1.__assign({}, doc);\r\n        this.includes.forEach(function (label) { return copy[label] = copy[label] || []; });\r\n        return copy;\r\n    };\r\n    return KedBackendQuery;\r\n}());\r\nexport { KedBackendQuery };\r\n//# sourceMappingURL=kedbackend-query.js.map","import * as tslib_1 from \"tslib\";\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { KedBackendCollection } from './kedbackend-collection';\r\nimport { QuerySet } from './query-set';\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { KedBackendWriter } from './kedbackend-writer';\r\nimport { DeltaCollection } from './delta-collection/delta-collection';\r\nvar KedBackendRepo = /** @class */ (function () {\r\n    function KedBackendRepo(getClient, getUser, getUserDisplayName, defaultQueryOptions, mutationQueue, querySet, writer, cacheOptimized) {\r\n        var _this = this;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.defaultQueryOptions = defaultQueryOptions;\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.writer = writer;\r\n        this.cacheOptimized = cacheOptimized;\r\n        if (!defaultQueryOptions)\r\n            this.defaultQueryOptions = {};\r\n        if (!mutationQueue)\r\n            this.mutationQueue = new MutationQueue();\r\n        if (!querySet)\r\n            this.querySet = new QuerySet(this.mutationQueue);\r\n        if (!writer)\r\n            this.writer = new KedBackendWriter(this.mutationQueue, this.querySet, getClient, getUser, getUserDisplayName);\r\n        Object.keys(tables).forEach(function (table) {\r\n            var collection = new KedBackendCollection(_this, table, defaultQueryOptions || {});\r\n            if (cacheOptimized) {\r\n                collection = collection.cacheOptimized();\r\n            }\r\n            _this[table] = collection;\r\n        });\r\n        this.deltas = new DeltaCollection(this.writer.deltaCache, {\r\n            branchId: this.defaultQueryOptions.branchId // If branchId is undefined. DeltaCollection will respond with Error on subscribe()\r\n        });\r\n    }\r\n    KedBackendRepo.prototype.table = function (tableName) {\r\n        var collection = new KedBackendCollection(this, tableName, this.defaultQueryOptions);\r\n        if (this.cacheOptimized)\r\n            collection = collection.cacheOptimized();\r\n        return collection;\r\n    };\r\n    KedBackendRepo.prototype._clone = function (queryOptions, cacheOptimized) {\r\n        var clone = new KedBackendRepo(this.getClient, this.getUser, this.getUserDisplayName, tslib_1.__assign({}, this.defaultQueryOptions, queryOptions), this.mutationQueue, this.querySet, this.writer, cacheOptimized === undefined ? this.cacheOptimized : cacheOptimized);\r\n        return clone;\r\n    };\r\n    KedBackendRepo.prototype.branch = function (branchId) {\r\n        return this._clone({ branchId: branchId });\r\n    };\r\n    KedBackendRepo.prototype.role = function (role) {\r\n        return this._clone({ role: role });\r\n    };\r\n    KedBackendRepo.prototype.optimizeCache = function () {\r\n        return this._clone({}, true);\r\n    };\r\n    KedBackendRepo.prototype.clearBranch = function () {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot clear master branch\");\r\n        this.writer.mutate([{ op: 'clear-branch', branchId: this.defaultQueryOptions.branchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.merge = function (targetBranchId) {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot merge from master branch\");\r\n        this.writer.mutate([{ op: 'merge', branchId: this.defaultQueryOptions.branchId, targetBranchId: targetBranchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.saveNow = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.writer.waitForVersionToPersist(this.writer.currentVersion)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBackendRepo;\r\n}());\r\nexport { KedBackendRepo };\r\n//# sourceMappingURL=kedbackend-repo.js.map","var KedBackendSubscription = /** @class */ (function () {\r\n    function KedBackendSubscription(subscriber, collection) {\r\n        this.subscriber = subscriber;\r\n        this.collection = collection;\r\n    }\r\n    KedBackendSubscription.prototype.notifySubscriber = function (data, error) {\r\n        try {\r\n            if (error)\r\n                this.subscriber([], error, this);\r\n            else if (data !== this.lastNotifiedData) { // Will in-fact be equal by reference if data is same as last notification (as we use an immutable approach on data)\r\n                this.lastNotifiedData = data;\r\n                this.subscriber(data, error, this);\r\n            }\r\n        }\r\n        catch (ex) {\r\n            try {\r\n                this.subscriber([], ex, this);\r\n            }\r\n            catch (ex2) {\r\n                console.error(\"Error while notifying KedBackendSubscriber:\", ex2, 'originally notified error:', ex);\r\n            }\r\n        }\r\n    };\r\n    KedBackendSubscription.prototype.unsubscribe = function () {\r\n        this.collection.unsubscribe(this);\r\n    };\r\n    return KedBackendSubscription;\r\n}());\r\nexport { KedBackendSubscription };\r\n//# sourceMappingURL=kedbackend-subscription.js.map","import * as tslib_1 from \"tslib\";\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { CacheBust } from './cache-bust';\r\nimport { Emitter } from '../observable';\r\nimport { DeltaCache } from './delta-collection/delta-cache';\r\nvar KedBackendWriter = /** @class */ (function () {\r\n    function KedBackendWriter(mutationQueue, querySet, getClient, getUser, getUserDisplayName) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = null;\r\n        this.currentVersion = 0;\r\n        this.persistedVersion = new Emitter(0);\r\n        this.errorSubscribers = [];\r\n        this.stateSubscribers = [];\r\n        this.deltaCache = new DeltaCache(getClient, getUser, getUserDisplayName);\r\n    }\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isSaving\", {\r\n        get: function () { return !!this._isSavingPromise; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isEdited\", {\r\n        get: function () { return this.mutationQueue.get().length > 0; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendWriter.prototype.onError = function (callback) {\r\n        this.errorSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.onStateChange = function (callback) {\r\n        this.stateSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.off = function (callback) {\r\n        this.errorSubscribers = this.errorSubscribers.filter(function (s) { return s !== callback; });\r\n        this.stateSubscribers = this.stateSubscribers.filter(function (s) { return s !== callback; });\r\n    };\r\n    KedBackendWriter.prototype.dispatchError = function (error, retryable) {\r\n        var _this = this;\r\n        this.errorSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(error, retryable, _this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.dispatchStateChange = function () {\r\n        var _this = this;\r\n        this.stateSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(_this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mutate = function (mutations, debounce) {\r\n        this.mutationQueue.add(mutations);\r\n        ++this.currentVersion;\r\n        this.dispatchStateChange();\r\n        this.querySet.notifySubscribers();\r\n        this.deltaCache.applyMutations(this.mutationQueue.get(), { optimistic: true });\r\n        if (!this._isSavingPromise) {\r\n            if (this._timeoutId)\r\n                clearTimeout(this._timeoutId);\r\n            this._timeoutId = setTimeout(this.save.bind(this), debounce);\r\n        }\r\n        // If isSaving, we don't need to do anything, becase it will re-check if additional\r\n        // mutations have come, when saving is done.\r\n    };\r\n    KedBackendWriter.prototype.retrySave = function () {\r\n        return this.save();\r\n    };\r\n    KedBackendWriter.prototype.waitForVersionToPersist = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedVersion;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.persistedVersion.load()];\r\n                    case 1:\r\n                        persistedVersion = _a.sent();\r\n                        if (!(persistedVersion < version)) return [3 /*break*/, 3];\r\n                        this.save(); // Be more eager to save\r\n                        return [4 /*yield*/, this.persistedVersion.filter(function (persistedVersion) { return persistedVersion >= version; }).load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.save = function () {\r\n        var _this = this;\r\n        if (this._timeoutId)\r\n            clearTimeout(this._timeoutId);\r\n        if (this._isSavingPromise)\r\n            return this._isSavingPromise;\r\n        if (!this.isEdited)\r\n            return Promise.resolve();\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = this._save();\r\n        this._isSavingPromise.catch(function () { }).then(function () { return _this._isSavingPromise = null; });\r\n        return this._isSavingPromise;\r\n    };\r\n    KedBackendWriter.prototype._save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var mutations, version, mutationRequests, res_1, etagMutations, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.dispatchStateChange();\r\n                        mutations = this.mutationQueue.get();\r\n                        version = this.currentVersion;\r\n                        this.mutationQueue.moveToSavingQueue();\r\n                        mutationRequests = this.mapMutations(mutations);\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 6, 11, 12]);\r\n                        return [4 /*yield*/, this.getClient().batch(mutationRequests)];\r\n                    case 2:\r\n                        res_1 = _a.sent();\r\n                        etagMutations = Object.keys(res_1.newEtags).map(function (id) { return ({\r\n                            op: 'update',\r\n                            table: null,\r\n                            id: id,\r\n                            deltaDoc: { $etag: res_1.newEtags[id] },\r\n                            targetName: null // We don't have the target name. But this mutation won't be visible in a DeltaCollection anyway, so it wont be used.\r\n                        }); });\r\n                        // Invalidate cache\r\n                        CacheBust.invalidateCache(mutationRequests, this.getUser());\r\n                        // Commmit mutations along with etagMutations into queries cached data\r\n                        this.persistedVersion.dispatch(version);\r\n                        this.deltaCache.applyMutations(mutations, { optimistic: false });\r\n                        return [4 /*yield*/, this.querySet.commitMutations(MutationQueue.merge(mutations, etagMutations), version)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        // On success, clear saving queue as the mutations will now be committed to all query's data instead.\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        // Finally, notify subscribers so that views get updated with committed results\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 5];\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 4:\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5: return [3 /*break*/, 12];\r\n                    case 6:\r\n                        error_1 = _a.sent();\r\n                        this.persistedVersion.dispatchError(error_1);\r\n                        if (!(error_1 && error_1.name && error_1.name.startsWith(\"http4\"))) return [3 /*break*/, 9];\r\n                        // Access Control denied, bad request or similar. Throw mutations away.\r\n                        this.dispatchError(error_1, false);\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 8];\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 7:\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        _a.sent();\r\n                        _a.label = 8;\r\n                    case 8: return [3 /*break*/, 10];\r\n                    case 9:\r\n                        this.dispatchError(error_1, true);\r\n                        _a.label = 10;\r\n                    case 10: return [3 /*break*/, 12];\r\n                    case 11:\r\n                        this.dispatchStateChange();\r\n                        return [7 /*endfinally*/];\r\n                    case 12: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mapMutations = function (mutations) {\r\n        var br = new BatchRunner();\r\n        mutations.forEach(function (m) {\r\n            switch (m.op) {\r\n                case 'update':\r\n                    br.update(m.table, m.id, m.deltaDoc, m.branchId);\r\n                    break;\r\n                case 'add':\r\n                    br.add(m.table, m.doc);\r\n                    break;\r\n                case 'add-related':\r\n                    if (!m.relatedDoc.$etag) {\r\n                        // No $etag means this is a new document. Add it before linking to it:\r\n                        br.add(tables[m.table].relationships[m.graphProp], m.relatedDoc, m.branchId);\r\n                    }\r\n                    br.link2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'remove-related':\r\n                    br.unlink2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'undo-link':\r\n                    br.undoLink(m.table, m.id, m.graphProp, m.relatedId, m.branchId);\r\n                    break;\r\n                case 'delete':\r\n                    br.delete(m.table, m.id);\r\n                    break;\r\n                case 'clear-branch':\r\n                    br.clearBranch(m.branchId);\r\n                    break;\r\n                case 'merge':\r\n                    br.merge(m.branchId, m.targetBranchId);\r\n                    break;\r\n            }\r\n        });\r\n        return br.mutationRequests;\r\n    };\r\n    return KedBackendWriter;\r\n}());\r\nexport { KedBackendWriter };\r\n//# sourceMappingURL=kedbackend-writer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { getTableFromLabel, branchSensitive, globalOp } from './utils';\r\nimport { mergeDeltas } from './delta-merge';\r\nvar MutationQueue = /** @class */ (function () {\r\n    function MutationQueue() {\r\n        this.queue = [];\r\n        this.savingQueue = [];\r\n    }\r\n    MutationQueue.prototype.add = function (mutations) {\r\n        this.queue = MutationQueue.merge(this.queue, mutations);\r\n    };\r\n    MutationQueue.prototype.moveToSavingQueue = function () {\r\n        this.savingQueue = MutationQueue.merge(this.savingQueue, this.queue);\r\n        this.queue = [];\r\n    };\r\n    MutationQueue.prototype.clearSavingQueue = function () {\r\n        this.savingQueue = [];\r\n    };\r\n    MutationQueue.prototype.get = function () {\r\n        return this.savingQueue.concat(this.queue);\r\n    };\r\n    MutationQueue.prototype.affectsQuery = function (table, query, includes) {\r\n        var mutations = this.get();\r\n        if (mutations.some(function (m) { return m.op === 'merge' || m.op === 'clear-branch'; }))\r\n            return true;\r\n        if (query.ids) {\r\n            // A query with \"ids\" filter will be easy to detect a no-match on:\r\n            return mutations.some(function (m) { return globalOp(m) || (!branchSensitive(m) || m.branchId === query.branchId) &&\r\n                query.ids.includes(m.id); });\r\n        }\r\n        // Otherwise, check if mutations affect same branch and table. Could be done more fine grained,\r\n        // but that would only be a suboptimization.\r\n        return mutations.some(function (m) {\r\n            return m.op === 'add' ?\r\n                m.table === table :\r\n                m.op === 'delete' ?\r\n                    m.table === table || (includes.some(function (label) { return getTableFromLabel(table, label) === m.table; })) :\r\n                    globalOp(m) ? true :\r\n                        m.branchId == query.branchId &&\r\n                            (m.table === table || (m.op !== 'update' && ([table].concat(includes.map(function (label) { return getTableFromLabel(table, label); })).some(function (table) { return getTableFromLabel(m.table, m.graphProp) === table; }))));\r\n        });\r\n    };\r\n    MutationQueue.merge = function (queue1, queue2) {\r\n        var mutableQueue1 = queue1.slice();\r\n        var mutableQueue2 = queue2.slice();\r\n        //if (mutableQueue1.length > 0) debugger;\r\n        var len = queue1.length;\r\n        var _loop_1 = function (i) {\r\n            var m = queue1[i];\r\n            if (m.op === 'update') {\r\n                var overlappingIdOpIdx = mutableQueue2.findIndex(function (newMut) {\r\n                    return newMut.op === 'update' &&\r\n                        newMut.branchId === m.branchId &&\r\n                        newMut.id === m.id;\r\n                });\r\n                if (overlappingIdOpIdx >= 0) {\r\n                    mutableQueue1[i] = tslib_1.__assign({}, m, { deltaDoc: mergeDeltas(m.deltaDoc, mutableQueue2[overlappingIdOpIdx].deltaDoc) });\r\n                    mutableQueue2.splice(overlappingIdOpIdx, 1);\r\n                }\r\n            }\r\n        };\r\n        for (var i = 0; i < len; ++i) {\r\n            _loop_1(i);\r\n        }\r\n        return mutableQueue1.concat(mutableQueue2);\r\n    };\r\n    return MutationQueue;\r\n}());\r\nexport { MutationQueue };\r\n//# sourceMappingURL=mutation-queue.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport * as JsonSchema from 'kedbackend-schema/schema.json';\r\nimport { queryArray } from './utils';\r\nvar QuerySet = /** @class */ (function () {\r\n    function QuerySet(mutationQueue) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.queries = [];\r\n    }\r\n    QuerySet.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, Promise.all(this.queries.map(function (q) { return q.commitMutations(mutations, version); }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.cleanupInvalidQueries();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QuerySet.prototype.cleanupInvalidQueries = function () {\r\n        this.queries = this.queries.filter(function (q) {\r\n            if (q.invalid) {\r\n                if (q.timeoutHandle) {\r\n                    clearTimeout(q.timeoutHandle);\r\n                    q.timeoutHandle = null;\r\n                }\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n    };\r\n    QuerySet.prototype.notifySubscribers = function () {\r\n        var optimisticMutations = this.mutationQueue.get();\r\n        this.queries.forEach(function (q) {\r\n            q.notifySubscribers(optimisticMutations);\r\n        });\r\n    };\r\n    QuerySet.prototype.findQuery = function (table, query) {\r\n        return this.queries.find(function (q) { return q.queryKey === KedBackendQuery.queryKey(table, query); });\r\n    };\r\n    QuerySet.prototype.queryLocally = function (table, query, includes) {\r\n        // For now, only handle this very common and special case (which\r\n        // will save a lot of unnescessary network traffic if I am thinking right...)\r\n        var mutations = this.mutationQueue.get();\r\n        // Check if the query wants to get a single entity by its ID:\r\n        if (query.ids && query.ids.length === 1) {\r\n            // And if so, if we have an outgoing mutation to create that entity:\r\n            if (mutations.some(function (m) { return m.op === 'add-related' && m.relatedDoc.id === query.ids[0]; })) {\r\n                // Then return an EMPTY response, signalling that we can resolve this locally,\r\n                // but let the optistic feature of KedBackendQuery apply the mutation before\r\n                // notifying subscribers (we don't want it to be persistent before the server\r\n                // has accepted the mutation)\r\n                return [];\r\n            }\r\n        }\r\n        // OK, another quite common case is when we ask for a certain ID and that ID replies\r\n        // within another query\r\n        if (query.hasEdgesFrom || query.hasEdgesTo)\r\n            return null; // Not possible to handle\r\n        if (!query.ids)\r\n            return null; // For now, just take hight for this particular and most common case!\r\n        var _loop_1 = function (q) {\r\n            if (!q.gotInitialResponse)\r\n                return \"continue\";\r\n            if (q.query.branchId !== query.branchId)\r\n                return \"continue\";\r\n            if (q.query.flags)\r\n                return \"continue\"; // It would be complex to support various flags. Query's data may include ids only. Can't rely on the query.\r\n            var qIncludes = q.includes;\r\n            if (qIncludes.length > 0 && (!query.include || query.include.length === 0)) {\r\n                // We don't include, but this query does. Check if we can find our result within it.\r\n                var label = qIncludes.find(function (l) { return JsonSchema.tables[q.table][\"relationships\"][l] === table; });\r\n                if (label) {\r\n                    var res_1 = {};\r\n                    for (var _i = 0, _a = q.data; _i < _a.length; _i++) {\r\n                        var entity = _a[_i];\r\n                        var subData = queryArray(query, entity[label]);\r\n                        subData.forEach(function (r) { return res_1[r.id] = r; });\r\n                    }\r\n                    var result_1 = Object.keys(res_1).map(function (id) { return res_1[id]; });\r\n                    // Only return result if we could look up every requested ID:\r\n                    if (!query.ids.every(function (id) { return result_1.some(function (x) { return x.id === id; }); }))\r\n                        return \"continue\";\r\n                    return { value: result_1 };\r\n                }\r\n            }\r\n            if (!includes.every(function (label) { return qIncludes.includes(label); }))\r\n                return \"continue\";\r\n            // Lastly, if the query includes all graphs that we do, pick the subset from that query.\r\n            // Concrete example: We observe a certain Task by ID and want its knowledgeRequirements along with it,\r\n            // and there's another query of all tasks that also includes knowledgeRequirements. Use it. \r\n            if (q.table === table) {\r\n                var result_2 = queryArray(query, q.data);\r\n                // Only return result if we could look up every requested ID:\r\n                if (!query.ids.every(function (id) { return result_2.some(function (x) { return x.id === id; }); }))\r\n                    return \"continue\";\r\n                return { value: result_2 };\r\n            }\r\n        };\r\n        for (var _i = 0, _a = this.queries; _i < _a.length; _i++) {\r\n            var q = _a[_i];\r\n            var state_1 = _loop_1(q);\r\n            if (typeof state_1 === \"object\")\r\n                return state_1.value;\r\n        }\r\n    };\r\n    QuerySet.prototype.subscribe = function (subscription) {\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (!kbQuery) {\r\n            kbQuery = new KedBackendQuery(table, query, repo.getUser(), repo, this.mutationQueue);\r\n            this.queries.push(kbQuery);\r\n        }\r\n        else {\r\n            if (kbQuery.timeoutHandle) {\r\n                clearTimeout(kbQuery.timeoutHandle);\r\n                kbQuery.timeoutHandle = null;\r\n            }\r\n        }\r\n        kbQuery.subscribe(subscription);\r\n    };\r\n    QuerySet.prototype.unsubscribe = function (subscription) {\r\n        var _this = this;\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (kbQuery) {\r\n            // Prohibit further notifications to this subscription:\r\n            kbQuery.unsubscribe(subscription);\r\n            // Release unnescessary memory when there are no more subscriptions of this query, by removing the query itself\r\n            // To that in a delayed manner, so that an unsubscribe() followed by an immediate subscribe() don't have to re-query the server:\r\n            if (kbQuery.subscriptions.length === 0) {\r\n                // Schedule for garbage collection in 5 minutes:\r\n                kbQuery.timeoutHandle = setTimeout(function () {\r\n                    // Check if kbQuery still has no subscriptions (not certain! A new subscriber may have come along...)\r\n                    if (kbQuery.subscriptions.length === 0) {\r\n                        // Still no subscriptions on it, time to release some memory and forget the in-memory cache of the query result\r\n                        _this.queries = _this.queries.filter(function (q) { return q !== kbQuery; });\r\n                    }\r\n                }, this.queries.length > 50 ?\r\n                    500 : // Don't host too many queries. Garbage collect this within 500 ms\r\n                    5 * 60000); // Allow query in memory for another 5 minutes\r\n            }\r\n        }\r\n    };\r\n    return QuerySet;\r\n}());\r\nexport { QuerySet };\r\n//# sourceMappingURL=query-set.js.map","import { tables } from 'kedbackend-schema/schema.json';\r\nexport function getTableFromLabel(table, label) {\r\n    return tables[table].relationships[label];\r\n}\r\nexport function queryArray(query, data) {\r\n    var filter = getFilterFromQuery(query);\r\n    return data.filter(filter);\r\n}\r\nexport function AND(filter1, filter2) {\r\n    return function (x) { return filter1(x) && filter2(x); };\r\n}\r\nexport function getFilterFromQuery(query) {\r\n    var filter = function (x) { return true; };\r\n    if (query.from)\r\n        return AND(filter, function (x) { return x.dateTime >= query.from; });\r\n    if (query.to)\r\n        return AND(filter, function (x) { return x.dateTime < query.to; });\r\n    if (query.ids)\r\n        return AND(filter, function (x) { return query.ids.includes(x.id); });\r\n    if (query.name)\r\n        return AND(filter, function (x) { return x.name === query.name; });\r\n    if (query.tags)\r\n        return AND(filter, function (x) { return x.tags && [].concat(query.tags || []).some(function (tag) { return x.tags.includes(tag); }); });\r\n    // query.hasEdgesFrom and query.hasEdgesTo cannot by filtered here\r\n    return filter;\r\n}\r\nexport function branchSensitive(m) {\r\n    return m.op !== 'delete';\r\n}\r\nexport function globalOp(m) {\r\n    return m.op === 'clear-branch' || m.op === 'merge';\r\n}\r\n//# sourceMappingURL=utils.js.map","import migrate from './migrate';\r\nexport var KedModelMigratorMixin = function (client) {\r\n    if (client.__migrator_mixed_in)\r\n        return;\r\n    client.__migrator_mixed_in = true;\r\n    var get = client.get;\r\n    var list = client.list;\r\n    client.get = function (table, id, options) {\r\n        var include = options && options.include;\r\n        return get.apply(this, arguments).then(function (result) {\r\n            migrate(result, table, include && include.toString().split(','));\r\n            return result;\r\n        });\r\n    };\r\n    client.list = function (table, options) {\r\n        var include = options && options.include;\r\n        return list.apply(this, arguments).then(function (result) {\r\n            result.forEach(function (doc) { return migrate(doc, table, include && include.toString().split(',')); });\r\n            return result;\r\n        });\r\n    };\r\n    return client;\r\n};\r\n//# sourceMappingURL=index.js.map","import migrateTask from './migrate-task';\r\nexport default function migrateCourse(course, graphs) {\r\n    if (!course.modules)\r\n        course.modules = [];\r\n    course.modules.forEach(function (module) {\r\n        if (!module.resources) {\r\n            module.resources = [];\r\n        }\r\n        if (!module.taskIds) {\r\n            module.taskIds = [];\r\n        }\r\n    });\r\n    if (!course.responsibleTeachers) {\r\n        course.responsibleTeachers = [];\r\n    }\r\n    // Earlier wrong spelling of resources\r\n    if ('resourses' in course && !('resources' in course)) {\r\n        course.resources = course.resourses;\r\n        delete course.resourses;\r\n    }\r\n    if (!course.resources) {\r\n        course.resources = [];\r\n    }\r\n    if (graphs) {\r\n        graphs.forEach(function (label) {\r\n            switch (label) {\r\n                case 'tasks':\r\n                    course.tasks.forEach(function (task) { return migrateTask(task); });\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=migrate-course.js.map","export default function migrateTask(task) {\r\n    if (!task.resources)\r\n        task.resources = [];\r\n}\r\n//# sourceMappingURL=migrate-task.js.map","import migrateCourse from './migrate-course';\r\nimport migrateTask from './migrate-task';\r\nexport default function migrate(doc, table, graphs) {\r\n    switch (table) {\r\n        case \"courses\":\r\n            migrateCourse(doc, graphs);\r\n            break;\r\n        case \"tasks\":\r\n            migrateTask(doc);\r\n            break;\r\n    }\r\n}\r\n//# sourceMappingURL=migrate.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Value } from \"./value\";\r\nimport { Emitter } from \"./emitter\";\r\nvar Collection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Collection, _super);\r\n    function Collection(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Collection.prototype._map = function (mapper) {\r\n        throw \"mixedin\";\r\n    };\r\n    Collection.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Collection(function (s) { return x.subscribe(s); });\r\n        if (Array.isArray(x)) {\r\n            var emitter_1 = new Emitter(x);\r\n            return new Collection(function (s) { return emitter_1.subscribe(s); });\r\n        }\r\n        throw new Error(\"ObservableCollection.from() can only take arrays or observables\");\r\n    };\r\n    Collection.prototype.map = function (mapper) {\r\n        return this._map(function (items) { return items.map(function (item) { return mapper(item); }); });\r\n    };\r\n    Collection.prototype.flat = function () {\r\n        return this._map(function (items) { return [].concat.apply([], items); });\r\n    };\r\n    Collection.prototype.filter = function (filter) {\r\n        return this._map(function (items) { return items.filter(filter); });\r\n    };\r\n    Collection.prototype.concat = function (other) {\r\n        return Collection.from(this.toValue().combineLatest(other).map(function (_a) {\r\n            var me = _a[0], other = _a[1];\r\n            return me.concat(other);\r\n        }));\r\n    };\r\n    Collection.prototype.orderBy = function (prop) {\r\n        return this.toValue().map(function (array) { return array.slice().sort(function (a, b) {\r\n            var aProp = a && a[prop];\r\n            var bProp = b && b[prop];\r\n            return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n        }); }).toCollection(function (x) { return x; });\r\n    };\r\n    Collection.prototype.toValue = function () {\r\n        var _this = this;\r\n        return new Value(function (s) { return _this.subscribe(s); });\r\n    };\r\n    Collection.prototype.groupBy = function (prop) {\r\n        return this.toValue().map(function (items) {\r\n            var rv = {};\r\n            items.forEach(function (item) {\r\n                var list = rv[item[prop]] || (rv[item[prop]] = []);\r\n                list.push(item);\r\n            });\r\n            return rv;\r\n        });\r\n    };\r\n    Collection.prototype.first = function () {\r\n        return this.toValue().map(function (arr) { return arr[0]; });\r\n    };\r\n    return Collection;\r\n}(Observable));\r\nexport { Collection };\r\nCollection.prototype._map = initMapMethod(Collection);\r\n//# sourceMappingURL=collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Value } from \"./value\";\r\nvar Emitter = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Emitter, _super);\r\n    function Emitter(initialValue) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = {\r\n                unsubscribe: function () { return _this.subscribers = _this.subscribers.filter(function (_a) {\r\n                    var s = _a[0];\r\n                    return s !== observer;\r\n                }); },\r\n            };\r\n            _this.subscribers.push([observer, subscription]);\r\n            if (_this.error)\r\n                observer(null, _this.error, subscription);\r\n            else\r\n                observer(_this.value, undefined, subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.subscribers = [];\r\n        _this.value = initialValue;\r\n        return _this;\r\n    }\r\n    Emitter.prototype.dispatch = function (value) {\r\n        this.value = value;\r\n        this.error = undefined;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype.dispatchError = function (error) {\r\n        this.error = error;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype._dispatch = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (_a) {\r\n            var observer = _a[0], subscription = _a[1];\r\n            try {\r\n                observer(_this.value, _this.error, subscription);\r\n            }\r\n            catch (err) {\r\n                observer(null, err, subscription);\r\n            }\r\n        });\r\n    };\r\n    return Emitter;\r\n}(Value));\r\nexport { Emitter };\r\n//# sourceMappingURL=emitter.js.map","var stack = [];\r\nvar currentFiber = null;\r\nvar providers = [function () { return currentFiber; }];\r\nfunction pushFiber(fiber) {\r\n    stack.push(currentFiber);\r\n    currentFiber = fiber;\r\n}\r\nfunction popFiber() {\r\n    currentFiber = stack.pop();\r\n}\r\nvar _FiberContext = {\r\n    get current() { return currentFiber; },\r\n    /*run: function rerun<R>(fiber: Fiber, fn: ()=>R): R | Promise<R> {\r\n      pushFiber(fiber);\r\n      try {\r\n        return Promise.resolve(fn());\r\n      } catch (p) {\r\n        if (p && typeof p.then === 'function') {\r\n          return p.then(()=>rerun(fiber, fn));\r\n        } else {\r\n          return Promise.reject(p);\r\n        }\r\n      } finally {\r\n        popFiber();\r\n      }\r\n    },*/\r\n    addProvider: function (getCurrentFiber) {\r\n        providers.push(getCurrentFiber);\r\n        setCurrentGetterFromProviders();\r\n    },\r\n    removeProvider: function (getCurrentFiber) {\r\n        providers = providers.filter(function (p) { return p !== getCurrentFiber; });\r\n        setCurrentGetterFromProviders();\r\n    }\r\n};\r\nfunction setCurrentGetterFromProviders() {\r\n    Object.defineProperty(_FiberContext, \"current\", {\r\n        get: providers.reduce(function (p, c) { return function () { return p() || c(); }; }),\r\n        set: function () { throw new Error(\"Use FiberContext.push() to change current fiber\"); }\r\n    });\r\n}\r\nvar _global = (typeof self === 'undefined' ? global : self);\r\nif (!_global[\"KEDFiberContext\"]) {\r\n    _global[\"KEDFiberContext\"] = _FiberContext;\r\n}\r\nexport var FiberContext = _global[\"KEDFiberContext\"];\r\n//# sourceMappingURL=fiber-context.js.map","export * from './observable';\r\nexport * from './value';\r\nexport * from './collection';\r\nexport * from './emitter';\r\nexport * from './fiber-context';\r\n//# sourceMappingURL=index.js.map","export function initMapMethod(ctor) {\r\n    return function (mapper) {\r\n        var _this = this;\r\n        return new ctor(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else\r\n                try {\r\n                    observer(mapper(value), error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n        }); });\r\n    };\r\n}\r\n//# sourceMappingURL=map.js.map","export function mixin(targetProto, mixinProto) {\r\n    var props = [];\r\n    for (var _i = 2; _i < arguments.length; _i++) {\r\n        props[_i - 2] = arguments[_i];\r\n    }\r\n    props.forEach(function (prop) { return targetProto[prop] = mixinProto[prop]; });\r\n}\r\n//# sourceMappingURL=mixin.js.map","var Observable = /** @class */ (function () {\r\n    //static get [Symbol.species]() { return this; }\r\n    function Observable(_subscribe) {\r\n        this._subscribe = _subscribe;\r\n    }\r\n    Observable.prototype.subscribe = function (observer) {\r\n        try {\r\n            return this._subscribe(function (items, error, subscription) {\r\n                try {\r\n                    observer(items, error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n            });\r\n        }\r\n        catch (error) {\r\n            observer(null, error, { unsubscribe: function () { } });\r\n        }\r\n    };\r\n    return Observable;\r\n}());\r\nexport { Observable };\r\n//# sourceMappingURL=observable.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Collection } from \"./collection\";\r\nimport { FiberContext } from './fiber-context';\r\nvar Value = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Value, _super);\r\n    function Value(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Value.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Value(function (s) { return x.subscribe(s); });\r\n        throw new Error(\"Value.from() can only take observables\");\r\n    };\r\n    Value.prototype.read = function () {\r\n        var resolved = false, result, err, notify;\r\n        var subscription = this.subscribe(function (value, error, subsciption) {\r\n            resolved = true;\r\n            result = value;\r\n            err = error;\r\n            if (error && notify)\r\n                notify(null, error, subsciption);\r\n            else if (notify)\r\n                notify(value, null, subsciption);\r\n        });\r\n        if (resolved) {\r\n            var currentFiber = FiberContext.current;\r\n            if (!currentFiber) {\r\n                subscription.unsubscribe();\r\n                throw new Error(\"Invalid Fiber Context\");\r\n            }\r\n            if (err) {\r\n                subscription.unsubscribe();\r\n                throw err;\r\n            }\r\n            var subscriptions = currentFiber.subscriptions, observer = currentFiber.observer;\r\n            subscriptions.push(subscription);\r\n            notify = observer;\r\n            return result;\r\n        }\r\n        throw new Promise(function (resolve, reject) {\r\n            notify = function (value, error, subscription) {\r\n                subscription.unsubscribe();\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n            };\r\n        });\r\n    };\r\n    Value.prototype.load = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.subscribe(function (value, error, subsciption) {\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n                subsciption.unsubscribe();\r\n            });\r\n        });\r\n    };\r\n    Value.prototype.filter = function (fn) {\r\n        var _this = this;\r\n        return new Value(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else if (fn(value))\r\n                observer(value, error, subscription);\r\n        }); });\r\n    };\r\n    Value.prototype.log = function (prefix) {\r\n        return this.map(function (x) {\r\n            console.log(prefix, x);\r\n            return x;\r\n        });\r\n    };\r\n    Value.prototype.toCollection = function (mapper) {\r\n        var _this = this;\r\n        return new Collection(function (s) { return _this.map(mapper).subscribe(s); });\r\n    };\r\n    Value.prototype.combineLatest = function (other) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var values = [null, null];\r\n            var mySubscription, otherSubscription;\r\n            var subscription = {\r\n                unsubscribe: function () {\r\n                    mySubscription.unsubscribe();\r\n                    otherSubscription.unsubscribe();\r\n                }\r\n            };\r\n            mySubscription = _this.subscribe(function (items, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[0] = items;\r\n                if (values[1] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            otherSubscription = other.subscribe(function (value, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[1] = value;\r\n                if (values[0] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            return subscription;\r\n        });\r\n    };\r\n    Value.prototype.switchMap = function (mapper) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var mappedSubscription = null;\r\n            var subscription = null;\r\n            var returnedSubscription = {\r\n                unsubscribe: function () {\r\n                    subscription.unsubscribe();\r\n                    if (mappedSubscription) {\r\n                        mappedSubscription.unsubscribe();\r\n                        mappedSubscription = null;\r\n                    }\r\n                }\r\n            };\r\n            subscription = _this.subscribe(function (item, error, s) {\r\n                subscription = s;\r\n                if (mappedSubscription) {\r\n                    mappedSubscription.unsubscribe();\r\n                    mappedSubscription = null;\r\n                }\r\n                if (error)\r\n                    observer(null, error, returnedSubscription);\r\n                else {\r\n                    try {\r\n                        var observableOrValue = mapper(item);\r\n                        if (observableOrValue && typeof observableOrValue.subscribe === 'function') {\r\n                            mappedSubscription = observableOrValue.subscribe(function (value, error, s) {\r\n                                mappedSubscription = s;\r\n                                observer(value, error, returnedSubscription);\r\n                            });\r\n                        }\r\n                        else {\r\n                            observer(observableOrValue, null, subscription);\r\n                        }\r\n                    }\r\n                    catch (error) {\r\n                        observer(null, error, subscription);\r\n                    }\r\n                }\r\n            });\r\n            return returnedSubscription;\r\n        });\r\n    };\r\n    return Value;\r\n}(Observable));\r\nexport { Value };\r\nValue.prototype.map = initMapMethod(Value);\r\n//# sourceMappingURL=value.js.map","export * from './js/dist/js/observable';\r\n","export * from './js/dist/js/ked-backend-repo';\r\n","export default function getUserClaims(user) {\r\n    return [{\r\n            type: \"email\",\r\n            value: user.mail\r\n        }, {\r\n            type: \"school\",\r\n            value: user.school\r\n        }].concat(user.roles.map(function (role) { return ({\r\n        type: \"role\",\r\n        value: role\r\n    }); })).concat(user.roles.map(function (role) { return ({\r\n        type: \"schoolRole\",\r\n        value: user.school + \"/\" + role\r\n    }); }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { DocumentAccess, hasAccess as _hasAccess } from 'kedbackend/client';\r\nimport getUserClaims from './get-user-claims';\r\nimport { parseQueryString, generateQueryString } from \"../utils/query-string\";\r\nexport { getUserClaims };\r\nexport var IMPERSONATION_QUERY_PARAMS = [\r\n    \"user\",\r\n    \"role\",\r\n    \"school\",\r\n    \"debug\",\r\n    \"testVersion\",\r\n    \"testversion\",\r\n    \"features\",\r\n    \"schoolGrade\",\r\n    \"schoolgrade\",\r\n    \"schoolType\",\r\n    \"schooltype\"\r\n];\r\nexport function hasAccess(user, doc, requestedRight) {\r\n    var claims = getUserClaims(user);\r\n    if (requestedRight !== 'R' && user.tutorFor) {\r\n        claims = claims.filter(function (claim) { return claim.type !== 'email'; });\r\n    }\r\n    var result = _hasAccess(DocumentAccess.fromStringArray(doc.acl || []), claims, requestedRight);\r\n    //console.log(`Has ${requestedRight} access to ${doc.name}/${doc.id}: ${result}`);\r\n    return result;\r\n}\r\nexport function hasReadAccess(user, doc) {\r\n    return hasAccess(user, doc, 'R');\r\n}\r\nexport function hasWriteAccess(user, doc) {\r\n    return hasAccess(user, doc, 'W');\r\n}\r\nexport function hasShareAccess(user, doc) {\r\n    return hasAccess(user, doc, 'S');\r\n}\r\nexport function isTeacherAtSchool(user, school) {\r\n    var isTeacher = user.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\r\n    var belongsToSchool = (school || \"\").toLowerCase() === user.school.toLowerCase();\r\n    return (isTeacher && belongsToSchool);\r\n}\r\nexport function isAdminOrTeacherAtSchool(user, school) {\r\n    return user.roles.includes(\"ADMIN\") || isTeacherAtSchool(user, school);\r\n}\r\nexport var impersonationEnv = {\r\n    actAs: function (options) {\r\n        var role = options.role, school = options.school, url = options.url;\r\n        var currentQuery = parseQueryString(location.search);\r\n        var newQuery = tslib_1.__assign({}, currentQuery, { role: role, school: school });\r\n        var newQueryString = generateQueryString(newQuery);\r\n        if (url) {\r\n            location.href = \"\" + url + newQueryString;\r\n        }\r\n        else {\r\n            location.hash = \"#\";\r\n            location.search = newQueryString;\r\n        }\r\n    }\r\n};\r\nexport function actAs(options) {\r\n    impersonationEnv.actAs(options);\r\n}\r\nexport function preserveImpersonationQuery(url, query) {\r\n    var e_1, _a;\r\n    var currentQuery = parseQueryString(location.search);\r\n    var preservedQuery = {};\r\n    try {\r\n        for (var IMPERSONATION_QUERY_PARAMS_1 = tslib_1.__values(IMPERSONATION_QUERY_PARAMS), IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next(); !IMPERSONATION_QUERY_PARAMS_1_1.done; IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next()) {\r\n            var param = IMPERSONATION_QUERY_PARAMS_1_1.value;\r\n            if (currentQuery[param])\r\n                preservedQuery[param] = currentQuery[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (IMPERSONATION_QUERY_PARAMS_1_1 && !IMPERSONATION_QUERY_PARAMS_1_1.done && (_a = IMPERSONATION_QUERY_PARAMS_1.return)) _a.call(IMPERSONATION_QUERY_PARAMS_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    var newQueryString = generateQueryString(tslib_1.__assign({}, preservedQuery, query));\r\n    var pHash = url.indexOf('#');\r\n    return pHash >= 0 ?\r\n        \"\" + url.substr(0, pHash) + newQueryString + url.substr(pHash) :\r\n        \"\" + url + newQueryString;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from 'kedbackend/client';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { getTermStarEndDate } from '../utils/school-moment';\r\nimport { SchoolTerm } from '../utils/school-term';\r\nimport { dateTimeReviver, L } from '../utils/utils';\r\nimport mockJsonFile from './mock/mock-eds-data.json';\r\nimport moment from 'moment';\r\nimport { makeSuspenseApi } from '../utils/make-suspense-api';\r\nvar EdsClient = /** @class */ (function () {\r\n    function EdsClient(isomorphic, baseUrl, bearerProvider, userEmailGetter) {\r\n        var _this = this;\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n        this.userEmailGetter = userEmailGetter;\r\n        var isApiMethod = function (m) {\r\n            return typeof _this[m] === 'function' &&\r\n                m !== 'constructor' && // Since makeSuspenseApi() walks prototype chain\r\n                m !== 'privatizingCacheBust' &&\r\n                m !== 'userEmailGetter';\r\n        } // List non-API methods here...\r\n        ;\r\n        Object.keys(EdsClient.prototype).forEach(function (method) {\r\n            if (isApiMethod(method)) {\r\n                _this[method] = avoidSimultanousCalls(_this[method]);\r\n            }\r\n        });\r\n        this.suspense = makeSuspenseApi(this, { isApiMethod: isApiMethod });\r\n    }\r\n    EdsClient.prototype.privatizingCacheBust = function () {\r\n        return { user: this.userEmailGetter() };\r\n    };\r\n    /**\r\n       * Retrieve active courses for current logged in student.\r\n       *\r\n       * @param courseCode Short-name of the course. Optional.\r\n       */\r\n    EdsClient.prototype.getActiveCourses = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json, ex_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _c.trys.push([0, 5, , 6]);\r\n                        query = this.privatizingCacheBust();\r\n                        if (q) {\r\n                            if (q.courseCode)\r\n                                query.CourseCode = q.courseCode;\r\n                            if (q.periodName)\r\n                                query.PeriodName = q.periodName;\r\n                        }\r\n                        return [4 /*yield*/, this.http.get(\"studentactivecourses\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.courses];\r\n                    case 5:\r\n                        ex_1 = _c.sent();\r\n                        console.error(\"Error from EDS: \" + ex_1);\r\n                        throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"], [\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"]))));\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve latest assessments for current logged in user.\r\n     *\r\n     * @param limit Optional limit\r\n     */\r\n    EdsClient.prototype.getLatestAssessments = function (limit) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = this.privatizingCacheBust();\r\n                        if (!isNaN(limit))\r\n                            query.Count = limit;\r\n                        return [4 /*yield*/, this.http.get(\"studentassessments\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.assessments];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve studyplans for current logged-in user\r\n     */\r\n    EdsClient.prototype.getStudentGoals = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentgoals\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentGoals];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getStudentFutureAbilities = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentFutureAbilities\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentFutureAbilities];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getTeacherTutorStudents = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"teachertutorstudents\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.students];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTuitionGroups()\r\n     *\r\n     * Return tuitiongroups for school\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param courseCode - Skolverkets code for course\r\n     */\r\n    EdsClient.prototype.getSchoolTuitionGroups = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTuitionGroups\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTuitionGroups];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getTuitionGroupStudents()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param tuitionGroupName - tuition gruop name in EDS\r\n     */\r\n    EdsClient.prototype.getTuitionGroupStudents = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"TuitionGroupStudents\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.tuitionGroupStudents];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTeachers()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     */\r\n    EdsClient.prototype.getSchoolTeachers = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTeachers\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTeachers];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // we assume that the EDS will return the current academic year dates determined by the current date\r\n    EdsClient.prototype.getAcademicYearTerms = function (schoolLocale, date) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var holidays, firstTermMoment, secondTermMoment, startFirstTermDate, startSecondTermDate, endFirstTermDate, endSecondTermDate, firstTerm, secondTerm;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                // mock data\r\n                switch (schoolLocale) {\r\n                    case 'en_sin':\r\n                        return [2 /*return*/, mockJsonFile.SouthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'en_nin':\r\n                        return [2 /*return*/, mockJsonFile.NorthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'sv':\r\n                        {\r\n                            holidays = [];\r\n                            firstTermMoment = getTermStarEndDate(date, true);\r\n                            secondTermMoment = getTermStarEndDate(date, false);\r\n                            startFirstTermDate = firstTermMoment[0];\r\n                            startSecondTermDate = secondTermMoment[0];\r\n                            endFirstTermDate = firstTermMoment[1];\r\n                            endSecondTermDate = secondTermMoment[1];\r\n                            firstTerm = { startDate: new Date(startFirstTermDate.year(), startFirstTermDate.month(), startFirstTermDate.date()).toDateString(), endDate: new Date(startFirstTermDate.year(), endFirstTermDate.month(), endFirstTermDate.date()).toDateString() };\r\n                            secondTerm = { startDate: new Date(startSecondTermDate.year(), startSecondTermDate.month(), startSecondTermDate.date()).toDateString(), endDate: new Date(startSecondTermDate.year(), endSecondTermDate.month(), endSecondTermDate.date()).toDateString() };\r\n                            return [2 /*return*/, { firstTerm: firstTerm, secondTerm: secondTerm, holidays: holidays }];\r\n                        }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return EdsClient;\r\n}());\r\nexport { EdsClient };\r\nvar EDSPeriod = /** @class */ (function () {\r\n    function EDSPeriod(periodStringOrSchoolTerm) {\r\n        if (typeof periodStringOrSchoolTerm === 'string') {\r\n            this.period = periodStringOrSchoolTerm;\r\n            this.term = this.period.startsWith('HT') ? 'AT' : 'ST';\r\n            this.year = parseInt(this.period.substr(2));\r\n            if (isNaN(this.year))\r\n                throw new Error(\"Invalid period: \" + this.period);\r\n        }\r\n        else {\r\n            var schoolTerm = new SchoolTerm(periodStringOrSchoolTerm);\r\n            this.period = (schoolTerm.term === 'AT' ? \"HT\" : \"VT\") + schoolTerm.year;\r\n            this.term = schoolTerm.term;\r\n            this.year = schoolTerm.year;\r\n        }\r\n    }\r\n    Object.defineProperty(EDSPeriod.prototype, \"schoolTerm\", {\r\n        get: function () {\r\n            return new SchoolTerm({\r\n                academicYear: this.term === 'AT' ?\r\n                    this.year + \"/\" + (this.year + 1) :\r\n                    this.year - 1 + \"/\" + this.year,\r\n                term: this.term\r\n            });\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    EDSPeriod.prototype.toString = function () {\r\n        return this.period;\r\n    };\r\n    EDSPeriod.prototype.valueOf = function () {\r\n        return this.year + \":\" + (this.term === 'ST' ? \"1\" : \"2\");\r\n    };\r\n    return EDSPeriod;\r\n}());\r\nexport { EDSPeriod };\r\nexport function parseJsonDate_old(jsonDateStr) {\r\n    var date = dateTimeReviver(\"\", jsonDateStr);\r\n    if (!(date instanceof Date))\r\n        throw new Error(\"Invalid JSON date string: \" + jsonDateStr);\r\n    return date;\r\n}\r\nfunction avoidSimultanousCalls(method) {\r\n    var ongoingPromises = {};\r\n    return function () {\r\n        var argsJson = JSON.stringify([].slice.call(arguments));\r\n        if (!ongoingPromises[argsJson]) {\r\n            ongoingPromises[argsJson] = method.apply(this, arguments).then(function (result) {\r\n                delete ongoingPromises[argsJson];\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromises[argsJson];\r\n    };\r\n}\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleClient } from './google-client';\r\nvar GoogleCalendar = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoogleCalendar, _super);\r\n    function GoogleCalendar(googleTokenProvider) {\r\n        var _this = _super.call(this, { discoveryDocs: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest' }) || this;\r\n        _this.setBearerProvider(googleTokenProvider);\r\n        return _this;\r\n    }\r\n    GoogleCalendar.prototype.listCalendars = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, err_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        _a.trys.push([2, 4, , 5]);\r\n                        return [4 /*yield*/, gapi.client.calendar.calendarList.list({})];\r\n                    case 3:\r\n                        res = _a.sent();\r\n                        // TODO: What is the normal res.status? 200? Throw if not 200?\r\n                        return [2 /*return*/, res.result.items];\r\n                    case 4:\r\n                        err_1 = _a.sent();\r\n                        // TODO: Parse out error from err (which is an object!)\r\n                        throw err_1.error; // Is this correct? Test!\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleCalendar.prototype.batchEvents = function (_a) {\r\n        var calendarList = _a.calendarList, timeMin = _a.timeMin, timeMax = _a.timeMax;\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var batch_1;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        try {\r\n                            batch_1 = gapi.client.newBatch();\r\n                            calendarList.forEach(function (cal) {\r\n                                batch_1.add(gapi.client.calendar.events.list({\r\n                                    'calendarId': cal.id || 'primary',\r\n                                    'timeMin': timeMin && (new Date(timeMin)).toISOString(),\r\n                                    'timeMax': timeMax && (new Date(timeMax)).toISOString(),\r\n                                    'showDeleted': false,\r\n                                    'singleEvents': true,\r\n                                    'fields': 'items/id,items/start,items/end,items/summary,items/location,items/htmlLink,items/description',\r\n                                    'maxResults': 2500,\r\n                                    'orderBy': 'startTime'\r\n                                }), { 'id': cal.id });\r\n                            });\r\n                            return [2 /*return*/, batch_1.then(function (resp) {\r\n                                    var newCals = {};\r\n                                    for (var i in calendarList) {\r\n                                        var calId = calendarList[i].id;\r\n                                        var events = resp.result[calId].result.items;\r\n                                        newCals[calId] = { calendar: calendarList[i], events: events };\r\n                                    }\r\n                                    return newCals;\r\n                                })];\r\n                        }\r\n                        catch (err) {\r\n                            throw err.error;\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return GoogleCalendar;\r\n}(GoogleClient));\r\nexport { GoogleCalendar };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { env } from '../globals/KED.env';\r\nvar GoogleClient = /** @class */ (function () {\r\n    function GoogleClient(_a) {\r\n        var discoveryDocs = _a.discoveryDocs;\r\n        this.googleTokenProvider = env.googleTokenProvider;\r\n        this.discoveryDocs = [];\r\n        this.discoveryDocs.push(discoveryDocs);\r\n    }\r\n    GoogleClient.prototype.setBearerProvider = function (googleTokenProvider) {\r\n        this.googleTokenProvider = googleTokenProvider;\r\n    };\r\n    GoogleClient.prototype.ensureInited = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var tokenResult;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(typeof gapi === 'undefined')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadGapi()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (!(!this.tokenExpiration || this.tokenExpiration < new Date())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.googleTokenProvider.getBearer()];\r\n                    case 3:\r\n                        tokenResult = _a.sent();\r\n                        this.tokenExpiration = new Date(tokenResult.expires);\r\n                        this.token = tokenResult.token;\r\n                        _a.label = 4;\r\n                    case 4: \r\n                    // Load all discovyerDocs\r\n                    return [4 /*yield*/, gapi.client.init({\r\n                            discoveryDocs: this.discoveryDocs\r\n                        })];\r\n                    case 5:\r\n                        // Load all discovyerDocs\r\n                        _a.sent();\r\n                        return [4 /*yield*/, gapi.client.setToken({\r\n                                access_token: this.token\r\n                            })];\r\n                    case 6:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleClient.prototype.loadGapi = function () {\r\n        return new Promise(function (resolve) {\r\n            if (typeof gapi !== 'undefined')\r\n                return resolve();\r\n            var script = document.createElement('script');\r\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\r\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n            window.gaapi_loaded = resolve;\r\n        });\r\n    };\r\n    return GoogleClient;\r\n}());\r\nexport { GoogleClient };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function getLearningGoalsAndTasks(apiPath, pageId) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var res, data;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, fetch(apiPath + \"?nodeID=\" + pageId, { credentials: \"same-origin\" })];\r\n                case 1:\r\n                    res = _a.sent();\r\n                    return [4 /*yield*/, res.json()];\r\n                case 2:\r\n                    data = _a.sent();\r\n                    return [2 /*return*/, data];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../globals/KED.env';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { Calendar } from './index';\r\nexport function CalendarSelf(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(Calendar, tslib_1.__assign({}, tslib_1.__assign({}, props, { env: env }))));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { Calendar } from './index';\r\nimport { TutorableComponent } from '../utility-components/tutorable-component';\r\nexport function CalendarTutored(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\r\n                return React.createElement(Calendar, tslib_1.__assign({ key: env.currentUser.mail }, props, { env: env }));\r\n            } }));\r\n}\r\n","export function courseNameToCssClass(cssPrefix, courseName) {\r\n    return \"\" + cssPrefix + courseName.substr(0, 3).toLowerCase();\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten, distinct, compareProp } from '../../utils/utils';\r\nexport function crunchCollidingEvents(events, isLastCall) {\r\n    var result = [];\r\n    events.forEach(function (event, eventIndex) {\r\n        var overlaps = result.filter(function (x) { return x.startMoment && x.endMoment &&\r\n            (x.startMoment <= event.startMoment) &&\r\n            (x.endMoment > event.startMoment); });\r\n        var allOverlaps = overlaps.concat(flatten(overlaps.map(function (o) { return o.prevOverlaps; })));\r\n        allOverlaps = distinct(allOverlaps, function (o) { return o.index; });\r\n        allOverlaps.sort(compareProp(\"startMoment\"));\r\n        var width; // = Math.round(100 / Math.max((allOverlaps.length + 1), 1));\r\n        var pos = 0;\r\n        allOverlaps.forEach(function (overlap, i) {\r\n            if (i % 4 === 0) {\r\n                width = Math.max(25, Math.round(100 / Math.max(allOverlaps.length - i + 1, 1)));\r\n                pos = 0;\r\n            }\r\n            overlap.width = width;\r\n            overlap.className = (overlap.className || \"\").split(' ')\r\n                .filter(function (cn) { return cn !== 'splitted'; })\r\n                .concat(\"splitted\")\r\n                .join(' '),\r\n                overlap.pos = pos;\r\n            pos += width;\r\n        });\r\n        result.push(tslib_1.__assign({}, event, { index: eventIndex, pos: pos, width: width, className: width < 100 ?\r\n                (event.className ? event.className + \" splitted\" : \"splitted\") :\r\n                event.className, prevOverlaps: allOverlaps }));\r\n        /*if (isLastCall && moment(event.start).day() === 1) {\r\n          if (/Sve2/.test(event.text)) {\r\n            debugger;\r\n          }\r\n          if (/Franska/.test(event.text)) {\r\n            debugger;\r\n          }\r\n          if (/Tyska/.test(event.text)) {\r\n            debugger;\r\n          }\r\n          if (/spansk/.test(event.text)) debugger;\r\n          if (/Eng6/.test(event.text)) debugger;\r\n        }*/\r\n    });\r\n    return result;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport moment from 'moment';\r\nimport { MINUTE } from '../../utils/constants';\r\nimport { L } from '../../utils/utils';\r\nexport default function DayViewEvent(_a) {\r\n    var id = _a.id, dayStart = _a.dayStart, startMoment = _a.startMoment, endMoment = _a.endMoment, text = _a.text, location = _a.location, description = _a.description, width = _a.width, pos = _a.pos, locale = _a.locale, zoom = _a.zoom, htmlLink = _a.htmlLink, className = _a.className;\r\n    var top = (moment(startMoment).diff(dayStart) / MINUTE) * zoom;\r\n    var height = (moment(endMoment).diff(startMoment) / MINUTE) * zoom;\r\n    var localeTimeOptions = { hour: 'numeric', minute: '2-digit' };\r\n    var localeStartTime = startMoment.toDate().toLocaleTimeString(locale, localeTimeOptions);\r\n    var localeEndTime = endMoment.toDate().toLocaleTimeString(locale, localeTimeOptions);\r\n    return React.createElement(\"div\", { className: \"dayviewevent \" + className, style: {\r\n            position: 'absolute',\r\n            boxSizing: 'border-box',\r\n            top: top,\r\n            left: (pos || 0) + \"%\",\r\n            width: (width || 100) + '%',\r\n            height: height,\r\n            maxHeight: height,\r\n            overflow: 'hidden'\r\n        }, title: localeStartTime + \" - \" + localeEndTime + \" \" + text +\r\n            (location ?\r\n                \"\\n\" + L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Plats: \", \"\"], [\"Plats: \", \"\"])), location) :\r\n                \"\") +\r\n            (description ?\r\n                \"\\n\" + description :\r\n                \"\") },\r\n        React.createElement(\"a\", { className: \"event-title\", href: htmlLink, target: \"calendar-event\" }, text),\r\n        React.createElement(\"p\", { className: \"event-period\" },\r\n            localeStartTime,\r\n            \" - \",\r\n            localeEndTime),\r\n        location &&\r\n            React.createElement(\"p\", { className: \"event-location\" }, location),\r\n        description &&\r\n            React.createElement(\"p\", { className: \"event-description\" }, description));\r\n}\r\nvar templateObject_1;\r\n","import * as React from 'react';\r\nimport moment from 'moment';\r\nimport DayViewEvent from './day-view-event';\r\nimport TimeLines from './time-lines';\r\nimport { MINUTE } from '../../utils/constants';\r\nimport { crunchCollidingEvents } from './crunch-colliding-events';\r\nexport default function DayView(_a) {\r\n    var dayStart = _a.dayStart, // Milliseconds at start of the day (for example 08:00 the day)\r\n    dayEnd = _a.dayEnd, // Milliseconds at end of the day (for example 17:00 the day)\r\n    events = _a.events, // Events to show\r\n    locale = _a.locale, zoom = _a.zoom, isLastCall = _a.isLastCall;\r\n    var height = (moment(dayEnd).diff(dayStart) / MINUTE) * zoom;\r\n    var crunchedEvents = crunchCollidingEvents(events, isLastCall);\r\n    return (React.createElement(\"div\", { className: \"dayview\", style: {\r\n            top: 0,\r\n            height: height,\r\n            maxHeight: height,\r\n            position: 'relative',\r\n            overflow: 'hidden'\r\n        } },\r\n        React.createElement(TimeLines, { dayStart: dayStart, dayEnd: dayEnd, zoom: zoom }),\r\n        crunchedEvents.map(function (ev) { return React.createElement(DayViewEvent, { key: ev.id, id: ev.id, className: ev.className, dayStart: dayStart, startMoment: ev.startMoment, endMoment: ev.endMoment, text: ev.text, location: ev.location, description: ev.description, width: ev.width, pos: ev.pos, locale: locale, zoom: zoom, htmlLink: ev.htmlLink }); })));\r\n}\r\n","import * as React from 'react';\r\nimport moment from 'moment';\r\nexport default function HourMarker(_a) {\r\n    var startHour = _a.startHour, endHour = _a.endHour, locale = _a.locale, zoom = _a.zoom;\r\n    var hourPixels = 60 * zoom;\r\n    var hours = [];\r\n    for (var hour = startHour; hour <= endHour; ++hour) {\r\n        hours.push(hour);\r\n    }\r\n    return React.createElement(\"div\", { className: \"hourmarker\", style: {\r\n            position: 'relative',\r\n            left: 0,\r\n            top: 0,\r\n            overflow: 'visible',\r\n            height: (endHour - startHour) * hourPixels\r\n        } }, hours.map(function (hour, i) {\r\n        var ypos = i * hourPixels;\r\n        return React.createElement(\"span\", { key: hour },\r\n            React.createElement(\"div\", { style: {\r\n                    position: 'absolute',\r\n                    left: 0,\r\n                    top: ypos,\r\n                    marginTop: '-4px',\r\n                    padding: 0\r\n                } }, moment().hour(hour).minute(0).toDate().toLocaleString(locale, { hour: \"2-digit\", minute: \"2-digit\" })));\r\n    }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport WeekView from './week-view';\r\nimport { GoogleCalendar } from '../../apis/google-calendar';\r\nimport moment from 'moment';\r\nimport { flatten } from '../../utils/utils';\r\nimport { courseNameToCssClass } from './course-name-to-css-class';\r\nimport { shouldIncludeCalendar } from './should-include-calendar';\r\nimport env from '../../globals/KED.env';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar Calendar = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Calendar, _super);\r\n    function Calendar(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        // Props\r\n        var firstDay = props.firstDay;\r\n        if (typeof firstDay === 'string' || typeof firstDay === 'number') {\r\n            firstDay = moment().startOf('week').weekday(firstDay);\r\n        }\r\n        var _a = _this.props, initialStartHour = _a.initialStartHour, initialEndHour = _a.initialEndHour, initialZoom = _a.initialZoom;\r\n        // State\r\n        _this.state = {\r\n            firstDay: firstDay,\r\n            startHour: initialStartHour,\r\n            endHour: initialEndHour,\r\n            zoom: initialZoom,\r\n            calendars: {},\r\n            calendarsBeingLoaded: [],\r\n            status: 'Loading calendars... (authenticating...)',\r\n            error: null\r\n        };\r\n        var googleTokenProvider = (props.env || env).googleTokenProvider;\r\n        _this.gcal = new GoogleCalendar(googleTokenProvider);\r\n        // Start calling on Google API right away. Store promise in property.\r\n        _this.gcal.ensureInited().then(function () {\r\n            return _this.loadData(firstDay);\r\n        }).catch(function (error) {\r\n            _this.handleError(error);\r\n        });\r\n        return _this;\r\n    }\r\n    Calendar.prototype.handleError = function (error) {\r\n        if (!error)\r\n            error = \"Unknown error\";\r\n        this.setState({ error: error });\r\n        console.error(error.stack || error); // Keep!\r\n    };\r\n    Calendar.prototype.loadData = function (firstDay) {\r\n        var _this = this;\r\n        // Props\r\n        var numDays = this.props.numDays;\r\n        var intl = this.context.intl;\r\n        this.setState({\r\n            firstDay: firstDay,\r\n            calendars: {},\r\n            calendarsBeingLoaded: [],\r\n            error: null,\r\n            status: intl.formatMessage({ id: \"calendar.loadingCalendar\", defaultMessage: \"Loading calendars... (listing...)\" })\r\n        });\r\n        // Important to return the Promise so that caller will catch any error.\r\n        return this.gcal.listCalendars().then(function (calendars) {\r\n            // Ignore the \"week numbers\" calendar as we already include week numbers in our view\r\n            calendars = calendars.filter(function (cal) { return shouldIncludeCalendar(cal); });\r\n            //!/Week Numbers/ig.test(c.summary)\r\n            //console.log(calendars.map(c => ({bgColor: c.backgroundColor, primary: c.primary, summary: c.summary, x: c})));\r\n            // Calendars Successfully listed.\r\n            _this.setState({\r\n                status: intl.formatMessage({ id: \"calendar.loadCalendarEvents\", defaultMessage: \"Load calendar events...\" })\r\n            });\r\n            _this.gcal.batchEvents({\r\n                calendarList: calendars,\r\n                timeMin: moment(firstDay).startOf('day'),\r\n                timeMax: moment(firstDay).add(numDays, 'days').endOf('day')\r\n            }).then(function (result) {\r\n                _this.setState({ calendars: result, status: '' });\r\n            });\r\n        });\r\n    };\r\n    Calendar.prototype.navigateToPreviousWeek = function () {\r\n        var _this = this;\r\n        this.loadData(moment(this.state.firstDay).add(-1, \"week\")).catch(function (error) {\r\n            _this.handleError(error);\r\n        });\r\n    };\r\n    Calendar.prototype.navigateToNextWeek = function () {\r\n        var _this = this;\r\n        this.loadData(moment(this.state.firstDay).add(1, \"week\")).catch(function (error) {\r\n            _this.handleError(error);\r\n        });\r\n    };\r\n    Calendar.prototype.render = function () {\r\n        var _this = this;\r\n        // Props\r\n        var numDays = this.props.numDays;\r\n        var intl = this.context.intl;\r\n        // State\r\n        var _a = this.state, firstDay = _a.firstDay, startHour = _a.startHour, endHour = _a.endHour, zoom = _a.zoom, calendars = _a.calendars, status = _a.status, error = _a.error;\r\n        var eventSets = Object.keys(calendars)\r\n            .map(function (calendarId) { return calendars[calendarId]; })\r\n            .map(function (_a) {\r\n            var calendar = _a.calendar, events = _a.events;\r\n            var isSchedule = calendar.summary === 'Skolschema' && calendar.description === \"Synchronized\";\r\n            var isHoliday = /holiday/.test(calendar.id);\r\n            var isClassRoom = /classroom/.test(calendar.id);\r\n            var classNames = [];\r\n            if (calendar.colorId)\r\n                classNames.push(\"gcal-palette-\" + calendar.colorId);\r\n            if (isSchedule)\r\n                classNames.push(\"course-event\");\r\n            if (isHoliday)\r\n                classNames.push(\"holiday-event\");\r\n            // Map Google Calendar events to our own format:\r\n            return events.map(function (event) { return ({\r\n                id: event.id,\r\n                start: event.start,\r\n                end: event.end,\r\n                text: event.summary,\r\n                location: event.location,\r\n                description: event.description,\r\n                //bgColor: calendar.backgroundColor,\r\n                //fgColor: calendar.foregroundColor,\r\n                htmlLink: event.htmlLink,\r\n                className: (isSchedule && event.summary ?\r\n                    classNames.concat(courseNameToCssClass('course-event-', event.summary)) :\r\n                    classNames).join(\" \")\r\n            }); });\r\n        });\r\n        var events = flatten(eventSets);\r\n        // Else, render the WeekView now. Any error should be displayed as red status\r\n        return React.createElement(\"div\", { style: { position: 'relative', top: 0, left: 0 } },\r\n            React.createElement(\"div\", { className: \"btn-toolbar week-navigation\" },\r\n                React.createElement(\"div\", { className: \"btn-group\" },\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.navigateToPreviousWeek(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.navigateToNextWeek(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" }))),\r\n                React.createElement(\"div\", { className: \"btn-group\" }, intl.formatMessage({ id: \"calendar.currentDate\", defaultMessage: \"Vecka {week}, {year}\" }, { week: moment(firstDay).week(), year: moment(firstDay).year() }))),\r\n            React.createElement(WeekView, { locale: intl.locale, firstDay: firstDay, startHour: startHour, endHour: endHour, numDays: numDays, zoom: zoom, events: events, status: status, error: error }));\r\n    };\r\n    Calendar.contextType = LanguageContext;\r\n    return Calendar;\r\n}(React.Component));\r\nexport { Calendar };\r\n","/* Calendars to show:\r\n\r\n    summary: \"Matsedel\",\r\n    summary: \"Skolschema\",\r\n    primary: true\r\n    id.includes('classroom')\r\n    id.includes('holiday')\r\n*/\r\nexport function shouldIncludeCalendar(cal) {\r\n    var summary = cal.summary || \"\";\r\n    var isOwner = /owner/ig.test(cal.accessRole);\r\n    var isPrimary = !!cal.primary;\r\n    var isClassroomCalendar = /classroom/ig.test(cal.id);\r\n    var isHolidayCalendar = /holiday/ig.test(cal.id);\r\n    return (isPrimary ||\r\n        isClassroomCalendar ||\r\n        isHolidayCalendar ||\r\n        ///matsedel/ig.test(summary) ||\r\n        (/schema/ig.test(summary) && isOwner));\r\n}\r\n","import * as React from 'react';\r\nexport default function StatusBar(_a) {\r\n    var status = _a.status, error = _a.error;\r\n    if (!status && !error)\r\n        return null;\r\n    return React.createElement(\"div\", { className: \"statusbar\" }, error ?\r\n        React.createElement(\"p\", { className: \"error\" }, '' + error) :\r\n        React.createElement(\"p\", { className: \"status\" }, status));\r\n}\r\n","import * as React from 'react';\r\nimport moment from 'moment';\r\nexport default function TimeLines(_a) {\r\n    var dayStart = _a.dayStart, dayEnd = _a.dayEnd, zoom = _a.zoom;\r\n    var hourPixels = 60 * zoom;\r\n    var startHour = moment(dayStart).hour();\r\n    var endHour = moment(dayEnd).hour();\r\n    var hours = [];\r\n    for (var hour = startHour; hour <= endHour; ++hour) {\r\n        hours.push(hour);\r\n    }\r\n    return React.createElement(\"div\", null, hours.map(function (hour) {\r\n        return React.createElement(\"div\", { key: hour, className: \"timeline\", style: {\r\n                width: '100%',\r\n                boxSizing: 'border-box',\r\n                margin: hourPixels / 2 + \"px 0 0 0\",\r\n                height: hourPixels / 2\r\n            } });\r\n    }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport moment from 'moment';\r\nimport DayView from './day-view';\r\nimport HourMarker from './hour-marker';\r\nimport { capitalizeFirst, clone } from '../../utils/utils';\r\nimport StatusBar from './status-bar';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar WeekView = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekView, _super);\r\n    function WeekView() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    WeekView.prototype.render = function () {\r\n        // Props:\r\n        var _a = this.props, firstDay = _a.firstDay, // {moment} The day to start with (normally a monday)\r\n        startHour = _a.startHour, // {number} The hour to start on\r\n        endHour = _a.endHour, // {number} The hour to end rendering per day\r\n        numDays = _a.numDays, // {number} Number of days, normally 5.\r\n        events = _a.events, // Array of events to display in the week.\r\n        locale = _a.locale, // Locale to use for showing week days and hour marks.\r\n        zoom = _a.zoom, // {number} Zoom where 1 means that 1 minute = 1 pixel.  \r\n        status = _a.status, error = _a.error;\r\n        var intl = this.context.intl;\r\n        // Prepare DayView datas \r\n        var dayDatas = [];\r\n        var day = moment(firstDay);\r\n        var _loop_1 = function (i) {\r\n            var dayStart = moment(day).hour(startHour);\r\n            var dayEnd = moment(day).hour(endHour);\r\n            var dayDate = moment(day).format('yyyy-MM-DD');\r\n            var isToday = moment(dayStart).startOf(\"day\").valueOf() === moment().startOf(\"day\").valueOf();\r\n            dayDatas.push({\r\n                name: capitalizeFirst(dayStart.toDate().toLocaleString(locale, {\r\n                    weekday: 'long',\r\n                    day: 'numeric',\r\n                    month: 'short'\r\n                })),\r\n                dayStart: dayStart,\r\n                dayEnd: dayEnd,\r\n                isToday: isToday,\r\n                events: events.filter(function (event) {\r\n                    return event.start && event.end && event.start.dateTime && event.end.dateTime &&\r\n                        (moment(event.start.dateTime).isBetween(dayStart, dayEnd) ||\r\n                            moment(event.end.dateTime).isBetween(dayStart, dayEnd));\r\n                })\r\n                    // Change start / end to directly point to the dateTime\r\n                    .map(function (event) { return clone(event, { startMoment: moment(event.start.dateTime), endMoment: moment(event.end.dateTime) }); })\r\n                    .sort(function (a, b) { return a.startMoment.valueOf > b.startMoment.valueOf ? 1 : a.startMoment < b.startMoment ? -1 : 0; }),\r\n                fullDayEvents: events.filter(function (event) {\r\n                    // Verify that it is a full-day-event\r\n                    return event.start && event.end && event.start.date && event.end.date &&\r\n                        // Verify it applies to current day\r\n                        (event.start.date <= dayDate && event.end.date > dayDate);\r\n                })\r\n                    // Change start / end to directly point to the date object\r\n                    .map(function (event) { return clone(event, {\r\n                    startDate: event.start.date,\r\n                    endDate: event.end.date\r\n                }); })\r\n            });\r\n            day = moment(day) // clone it\r\n                .add(1, 'days'); // Add another day\r\n        };\r\n        for (var i = 0; i < numDays; ++i) {\r\n            _loop_1(i);\r\n        }\r\n        // Render\r\n        return React.createElement(\"div\", { className: \"vemendo-weekview\" },\r\n            React.createElement(\"table\", null,\r\n                React.createElement(\"tbody\", null,\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"td\", { style: { border: 0 } }),\r\n                        dayDatas.map(function (d) { return React.createElement(\"td\", { key: d.dayStart.toISOString(), className: d.isToday ? \"today\" : null },\r\n                            React.createElement(\"p\", { className: \"dayname\" }, d.name)); })),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"td\", { style: { border: 0 } },\r\n                            React.createElement(\"p\", { className: \"week-number\" }, intl.formatMessage({ id: \"calendar.weekNumber\", defaultMessage: \"V{weekNumber}\" }, { weekNumber: moment(firstDay).week() }))),\r\n                        dayDatas.map(function (day) {\r\n                            return React.createElement(\"td\", { key: day.dayStart.toISOString(), className: day.isToday ? \"today\" : null }, day.fullDayEvents.map(function (_a) {\r\n                                var id = _a.id, text = _a.text, location = _a.location, description = _a.description, htmlLink = _a.htmlLink, className = _a.className;\r\n                                return React.createElement(\"div\", { key: id, className: \"dayviewevent full-day \" + className, title: \"\" + text + (location ?\r\n                                        \"\\n\" + intl.formatMessage({ id: \"calendar.fullDayEventLocation\", defaultMessage: \"Plats: {location}\" }, { location: location }) :\r\n                                        \"\") +\r\n                                        (description ?\r\n                                            \"\\n\" + description :\r\n                                            \"\") },\r\n                                    React.createElement(\"a\", { className: \"event-title\", href: htmlLink, target: \"calendar-event\" }, text),\r\n                                    location &&\r\n                                        React.createElement(\"p\", { className: \"event-location\" }, location),\r\n                                    description &&\r\n                                        React.createElement(\"p\", { className: \"event-description\" }, description));\r\n                            }));\r\n                        })),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"td\", { style: { border: 0 } },\r\n                            React.createElement(HourMarker, { startHour: startHour, endHour: endHour, locale: locale, zoom: zoom })),\r\n                        dayDatas.map(function (day) { return React.createElement(\"td\", { key: day.dayStart.toISOString(), className: day.isToday ? \"today\" : null },\r\n                            React.createElement(DayView, { key: day.dayStart.toISOString(), dayStart: day.dayStart, dayEnd: day.dayEnd, events: day.events, locale: locale, zoom: zoom, isLastCall: status == '' }),\r\n                            \" \"); })),\r\n                    (status || error) && (!error || error.name !== \"UnauthorizedError\") &&\r\n                        //\r\n                        // Show status / error\r\n                        //\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"td\", { style: { border: 0 } }),\r\n                            React.createElement(\"td\", { style: { border: 0 }, colSpan: numDays },\r\n                                React.createElement(StatusBar, { status: status, error: error }))))));\r\n    };\r\n    WeekView.contextType = LanguageContext;\r\n    return WeekView;\r\n}(React.Component));\r\nexport default WeekView;\r\n","export function getWeekplannerProgressData(taskSets) {\r\n    var chartTasks = { completedTasks: 0, totalNumberOfTasks: 0, subjectData: {} };\r\n    taskSets.forEach(function (elem) { return elem.learningGoals.forEach(function (x) {\r\n        var subjectCompletedTasks = x.tasks.filter(function (t) { return t.done; }).length;\r\n        var courseSubjectData = chartTasks.subjectData[elem.courseName];\r\n        if (!courseSubjectData) {\r\n            courseSubjectData = chartTasks.subjectData[elem.courseName] = {\r\n                completedNumberOfTasks: 0,\r\n                numberOfTasks: 0\r\n            };\r\n        }\r\n        courseSubjectData.completedNumberOfTasks += subjectCompletedTasks;\r\n        courseSubjectData.numberOfTasks += x.tasks.length;\r\n        chartTasks.completedTasks += subjectCompletedTasks;\r\n        chartTasks.totalNumberOfTasks += x.tasks.length;\r\n    }); });\r\n    return chartTasks;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar Doughnut = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Doughnut, _super);\r\n    function Doughnut() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    Doughnut.prototype.render = function () {\r\n        var _a = this.props, percentage = _a.percentage, errorMessage = _a.errorMessage, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n        //default values\r\n        var stroke = 2;\r\n        //equals with he circumference/2II\r\n        var radius = 100 / (2 * 3.14);\r\n        //take into account the stroke\r\n        var center = radius + stroke;\r\n        var viewboxW = center * 2;\r\n        var viewvboxH = center * 2;\r\n        var roundedPercentage = Math.round(percentage);\r\n        var startErrorText = 10;\r\n        return (React.createElement(\"svg\", { className: \"doughnut-chart\", viewBox: \"0 0 \" + viewboxW + \" \" + viewvboxH, width: \"100%\", height: \"100%\" },\r\n            React.createElement(\"circle\", { className: \"circle-chart-background\", stroke: backgroundColor, strokeWidth: stroke + 1, fill: \"none\", cx: center, cy: center, r: radius }),\r\n            React.createElement(\"circle\", { className: \"circle-chart-circle\", stroke: progressColor, ref: \"progressCircle\", strokeWidth: stroke, style: { strokeDasharray: roundedPercentage + \", 100\" }, strokeLinecap: \"round\", fill: \"none\", cx: center, cy: center, r: radius }),\r\n            React.createElement(\"g\", { className: \"circle-chart-info\" }, !errorMessage ? React.createElement(\"text\", { className: \"circle-chart-percent\", x: center, y: center, alignmentBaseline: \"central\", textAnchor: \"middle\" }, roundedPercentage + \"%\") :\r\n                React.createElement(\"text\", { className: \"circle-chart-percent-error\", x: center, y: center, alignmentBaseline: \"central\", fontSize: \"5\", textAnchor: \"middle\" }, errorMessage.split(' ').map(function (element) {\r\n                    var tspan = React.createElement(\"tspan\", { key: element, x: center, y: startErrorText }, element);\r\n                    startErrorText += 5;\r\n                    return tspan;\r\n                })))));\r\n    };\r\n    Doughnut.defaultProps = {\r\n        backgroundColor: \"#efefef\",\r\n        progressColor: \"#3dbca2\",\r\n        errorMessage: null\r\n    };\r\n    return Doughnut;\r\n}(React.Component));\r\nexport { Doughnut };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar GoalProgress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoalProgress, _super);\r\n    function GoalProgress() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.createProgress = function () {\r\n            var _a = _this.props, numberOfTasks = _a.numberOfTasks, completedNumberOfTasks = _a.completedNumberOfTasks, maximumTasksDisplayed = _a.maximumTasksDisplayed, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n            var progress = [];\r\n            if (numberOfTasks > maximumTasksDisplayed) {\r\n                return React.createElement(\"div\", { className: \"progress-overview\" },\r\n                    \" \",\r\n                    completedNumberOfTasks,\r\n                    \" / \",\r\n                    numberOfTasks,\r\n                    \" \");\r\n            }\r\n            for (var taskNo = 1; taskNo <= numberOfTasks; taskNo++) {\r\n                progress.push(React.createElement(\"svg\", { key: taskNo },\r\n                    React.createElement(\"circle\", { className: \"circle-chart-background\", fill: taskNo > completedNumberOfTasks ? backgroundColor : progressColor, cx: \"8\", cy: \"8\", r: \"8\" })));\r\n            }\r\n            return progress;\r\n        };\r\n        return _this;\r\n    }\r\n    GoalProgress.prototype.render = function () {\r\n        return React.createElement(\"div\", { className: \"goals-progress\" }, this.createProgress());\r\n    };\r\n    GoalProgress.defaultProps = {\r\n        numberofTasks: 0,\r\n        completedNumberOfTasks: 0,\r\n        maximumTasksDisplayed: 10,\r\n        backgroundColor: \"lightgrey\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return GoalProgress;\r\n}(React.Component));\r\nexport { GoalProgress };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar Progress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Progress, _super);\r\n    function Progress() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    Progress.prototype.render = function () {\r\n        var _a = this.props, percentage = _a.percentage, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n        var roundedPercentage = Math.round(percentage);\r\n        return (React.createElement(\"svg\", { className: \"progress-chart\", width: \"100%\", height: \"25\" },\r\n            React.createElement(\"rect\", { fill: backgroundColor, width: \"100%\", height: \"100%\", rx: \"4\" }),\r\n            React.createElement(\"rect\", { className: \"fill\", fill: progressColor, width: roundedPercentage + \"%\", height: \"100%\", rx: \"4\" }),\r\n            React.createElement(\"text\", { className: \"filled-text\", textAnchor: \"middle\", x: \"50%\", y: \"50%\", dy: \".3em\" }, roundedPercentage + \"%\")));\r\n    };\r\n    Progress.defaultProps = {\r\n        percentage: 0,\r\n        backgroundColor: \"#F1F5F4\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return Progress;\r\n}(React.Component));\r\nexport { Progress };\r\n","import * as React from 'react';\r\nexport var EllipsisLoader = function () {\r\n    return React.createElement(\"img\", { style: { border: 0, margin: 0, padding: 0 }, className: \"ellipsis-loader\" });\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\n;\r\nexport var RemoveItem = function (_a) {\r\n    var onClick = _a.onClick, className = _a.className, style = _a.style, title = _a.title;\r\n    return React.createElement(\"div\", { title: title || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Radera\"], [\"Radera\"]))), className: \"removeItem \" + (className || \"\"), onClick: onClick, style: style });\r\n};\r\nvar templateObject_1;\r\n","import * as React from 'react';\r\nexport var Spinner = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? \"\" : _b;\r\n    return React.createElement(\"span\", null,\r\n        React.createElement(\"i\", { className: \"fa fa-spinner fa-spin\", \"aria-hidden\": \"true\" }),\r\n        \"\\u00A0\",\r\n        label);\r\n};\r\n","import * as React from 'react';\r\nexport function Confirmation(props) {\r\n    return React.createElement(\"div\", { className: \"confirmation-box \" + props.className + (props.visible ? \" visible\" : \"\") },\r\n        React.createElement(\"p\", null, props.text),\r\n        React.createElement(\"button\", { onClick: function () { return props.onConfirm(); } }, \"OK\"),\r\n        React.createElement(\"button\", { onClick: function () { return props.onCancel(); } }, \"Avbryt\"));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { TaskList } from './task-list';\r\nimport { LanguageContext } from '../../utility-components/LanguageContext';\r\nvar LearningGoalsList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LearningGoalsList, _super);\r\n    function LearningGoalsList() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    LearningGoalsList.prototype.render = function () {\r\n        var _a = this.props, commonTasks = _a.commonTasks, learningGoals = _a.learningGoals;\r\n        var intl = this.context.intl;\r\n        return React.createElement(\"div\", null,\r\n            learningGoals.map(function (lg) { return React.createElement(\"div\", { key: lg.name },\r\n                React.createElement(\"h5\", null, lg.name),\r\n                React.createElement(TaskList, { learningTasks: lg.learningTasks })); }),\r\n            commonTasks.length > 0 && React.createElement(\"div\", null,\r\n                learningGoals.length > 0 && React.createElement(\"h5\", null, intl.formatMessage({ id: \"learningGoalsLost.overall\", defaultMessage: \"Övergripande\" })),\r\n                React.createElement(TaskList, { learningTasks: commonTasks })));\r\n    };\r\n    LearningGoalsList.contextType = LanguageContext;\r\n    return LearningGoalsList;\r\n}(React.Component));\r\nexport { LearningGoalsList };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport moment from 'moment';\r\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\r\nimport { userTasksRepo } from '../../../repos/user-tasks-repo';\r\nimport { arrayToMap } from '../../../utils/utils';\r\nimport { Confirmation } from './confirmation';\r\nimport { LanguageContext } from '../../utility-components/LanguageContext';\r\nimport { UIAddbox } from '../../utility-components/checkbox';\r\nvar TaskList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskList, _super);\r\n    function TaskList(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTasks: [],\r\n            weekDate: Date.now(),\r\n            confirmations: []\r\n        };\r\n        _this.onChange = _this.onChange.bind(_this);\r\n        return _this;\r\n    }\r\n    TaskList.prototype.onChange = function (userTasks, persisted) {\r\n        if (persisted.weekDate !== this.state.weekDate) {\r\n            this.setState({\r\n                confirmations: []\r\n            });\r\n        }\r\n        this.setState({\r\n            userTasks: userTasks,\r\n            weekDate: persisted.weekDate\r\n        });\r\n    };\r\n    TaskList.prototype.componentDidMount = function () {\r\n        userTasksRepo.subscribe(this.onChange);\r\n    };\r\n    TaskList.prototype.componentWillUnmount = function () {\r\n        userTasksRepo.unsubscribe(this.onChange);\r\n    };\r\n    TaskList.prototype.toggleTask = function (learningTask) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var userTasks, weekDate, latestTimeStamp, userTask;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        userTasks = this.state.userTasks.filter(function (ut) {\r\n                            return learningTask.task ?\r\n                                ut.task && ut.task.some(function (t) { return t.id === learningTask.id; }) :\r\n                                ut.siteVisionPageId === learningTask.id;\r\n                        });\r\n                        weekDate = this.state.weekDate;\r\n                        if (!(userTasks.length === 0)) return [3 /*break*/, 2];\r\n                        latestTimeStamp = Math.max.apply(Math.max, [weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        userTask = {\r\n                            id: createUUID(),\r\n                            courseName: learningTask.courseName,\r\n                            dateTime: latestTimeStamp + 2000,\r\n                            learningGoal: learningTask.learningGoal,\r\n                            name: learningTask.name,\r\n                            url: learningTask.url,\r\n                            acl: [\r\n                                // Default ACL: Let user self have full control over this item:\r\n                                new DocumentAccess(\"email\", env.currentUser.mail, \"S\"),\r\n                                // Additional ACL: Let employees on same school have read access to it.\r\n                                // This currently only applies to tasks that refer to course tasks (not custom tasks!)\r\n                                new DocumentAccess(\"schoolRole\", env.currentUser.school + \"/EMPLOYEE\", \"R\")\r\n                            ].map(function (ac) { return ac.toString(); })\r\n                        };\r\n                        if (learningTask.task && learningTask.task.deadline) {\r\n                            userTask.deadline = learningTask.task.deadline;\r\n                        }\r\n                        if (learningTask.task) {\r\n                            userTask.task = [learningTask.task];\r\n                            if (learningTask.course) {\r\n                                userTask.course = [learningTask.course];\r\n                            }\r\n                            else if (learningTask.courseInfo) {\r\n                                userTask.courseInfo = learningTask.courseInfo;\r\n                            }\r\n                        }\r\n                        else {\r\n                            userTask.siteVisionPageId = learningTask.id;\r\n                        }\r\n                        if (learningTask.step) {\r\n                            userTask.step = learningTask.step;\r\n                        }\r\n                        return [4 /*yield*/, Promise.all([\r\n                                userTasksRepo.setWeekPlannerBoxOpen(learningTask.courseName, true),\r\n                                userTasksRepo.insert([userTask])\r\n                            ])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: \r\n                    // Already present in weekplanner. It's time to delete those that matched us.\r\n                    return [4 /*yield*/, userTasksRepo.delete(userTasks.map(function (t) { return t.id; }))];\r\n                    case 3:\r\n                        // Already present in weekplanner. It's time to delete those that matched us.\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskList.prototype.render = function () {\r\n        var _this = this;\r\n        var intl = this.context.intl;\r\n        var learningTasks = this.props.learningTasks;\r\n        var userTasks = arrayToMap(this.state.userTasks, function (ut) { return ut.task && ut.task.length > 0 ?\r\n            ut.task.map(function (t) { return t.id; })[0] : // course-builder tasks looked up by id\r\n            ut.siteVisionPageId ? ut.siteVisionPageId : // non-course-builder tasks\r\n                ut.url; });\r\n        var confirmations = this.state.confirmations;\r\n        var weekPlannerWeek = moment(this.state.weekDate).week();\r\n        var currentWeek = moment().week();\r\n        var forWeekString = weekPlannerWeek === currentWeek ? \"\" :\r\n            weekPlannerWeek === currentWeek + 1 ? intl.formatMessage({ id: \"taskList.nextWeekTask\", defaultMessage: \"för nästa vecka (v{week})\" }, { week: weekPlannerWeek }) :\r\n                weekPlannerWeek === currentWeek - 1 ? intl.formatMessage({ id: \"taskList.lastWeekTask\", defaultMessage: \"för förra veckan (v{week})\" }, { week: weekPlannerWeek }) :\r\n                    intl.formatMessage({ id: \"taskList.currentWeekTask\", defaultMessage: \"för vecka {week}\" }, { week: weekPlannerWeek });\r\n        return React.createElement(\"div\", { className: \"taskContainer\" }, learningTasks.map(function (learningTask, idx) {\r\n            var taskLookupId = learningTask.id;\r\n            var userTask = userTasks[taskLookupId] || { $meta: 'deleted' }; // No exist = $meta: 'deleted'\r\n            var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting';\r\n            var selected = userTask.$meta !== 'deleted' && userTask.$meta !== 'deleting';\r\n            var describedAction = selected ?\r\n                intl.formatMessage({ id: \"taskList.removeTaskFromWeeklyPlanning\", defaultMessage: \"Ta bort uppgiften från egen veckoplanering {week}\" }, { week: forWeekString }) :\r\n                intl.formatMessage({ id: \"taskList.addTaskToWeeklyPlanning\", defaultMessage: \"Lägg till uppgiften i egen veckoplanering {week}\" }, { week: forWeekString });\r\n            var confirmationVisible = confirmations.some(function (tid) { return taskLookupId === tid; });\r\n            return React.createElement(\"div\", { key: idx },\r\n                React.createElement(UIAddbox, { state: selected ? 'checked' : '', onChange: function () { return !isWorking && weekPlannerWeek === currentWeek ?\r\n                        _this.toggleTask(learningTask) :\r\n                        confirmationVisible ?\r\n                            _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) }) :\r\n                            _this.setState({ confirmations: tslib_1.__spread(confirmations).concat(taskLookupId) }); }, label: React.createElement(\"a\", { title: describedAction, href: learningTask.url }, learningTask.name) }),\r\n                React.createElement(Confirmation, { visible: confirmationVisible, text: describedAction, onConfirm: function () {\r\n                        _this.toggleTask(learningTask);\r\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\r\n                    }, onCancel: function () {\r\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\r\n                    } }));\r\n        }));\r\n    };\r\n    TaskList.contextType = LanguageContext;\r\n    return TaskList;\r\n}(React.Component));\r\nexport { TaskList };\r\n","import * as React from 'react';\r\nimport { KGTermPlanner } from './kg-termplanner';\r\nimport env from '../../globals/KED.env';\r\nexport function KGTermPlannerSelf() {\r\n    return React.createElement(KGTermPlanner, { env: env, tutored: false });\r\n}\r\n","import * as React from 'react';\r\nimport { KGTermPlanner } from './kg-termplanner';\r\nimport { TutorableComponent } from '../utility-components/tutorable-component';\r\nexport function KGTermPlannerTutored() {\r\n    return React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\r\n            return React.createElement(KGTermPlanner, { key: env.currentUser.mail, env: env, tutored: true });\r\n        } });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EDSPeriod } from '../../apis/edsclient';\r\nimport { getSchoolMoment, getFirstAndLastWeekOfTerm, getTermStarEndDate } from '../../utils/school-moment';\r\nimport moment from 'moment';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { Dialogs } from '../utility-components/dialogs';\r\nimport { WeekNoteDialog } from './week-note-dialog';\r\nimport { distinct } from '../../utils/utils';\r\nimport { KEDWeek } from '../../utils/weekutil';\r\nimport { DocumentAccess, createUUID } from 'kedbackend/client';\r\nimport { TutorDialog } from '../ks-termplanner/tutor-dialog';\r\nimport { features } from '../../features';\r\nvar KGTermPlanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KGTermPlanner, _super);\r\n    function KGTermPlanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        var now = new Date();\r\n        _this.state = {\r\n            now: now,\r\n            courses: [],\r\n            weekPlans: [],\r\n            isLoadingCourses: true,\r\n            isLoadingWeekPlans: true,\r\n            dialogs: []\r\n            //goals: []\r\n        };\r\n        _this.updateWeekPlans = _this.updateWeekPlans.bind(_this);\r\n        return _this;\r\n    }\r\n    KGTermPlanner.prototype.componentDidMount = function () {\r\n        this.loadEDSCourses();\r\n        this.props.env.kgTermPlannerRepo.mem.subscribe(this.updateWeekPlans);\r\n    };\r\n    KGTermPlanner.prototype.componentWillUnmount = function () {\r\n        this.props.env.kgTermPlannerRepo.mem.unsubscribe(this.updateWeekPlans);\r\n    };\r\n    KGTermPlanner.prototype.updateWeekPlans = function (weekPlans) {\r\n        this.setState({ weekPlans: weekPlans, isLoadingWeekPlans: false });\r\n    };\r\n    KGTermPlanner.prototype.loadEDSCourses = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schoolMoment, periodName, courses, _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _b.trys.push([0, , 2, 3]);\r\n                        schoolMoment = getSchoolMoment(moment(this.state.now));\r\n                        periodName = new EDSPeriod(schoolMoment).period;\r\n                        _a = distinct;\r\n                        return [4 /*yield*/, this.props.env.edsClient.getActiveCourses({ periodName: periodName })];\r\n                    case 1:\r\n                        courses = _a.apply(void 0, [_b.sent(), function (course) { return course.name; }]);\r\n                        //console.log(\"courses:\" + JSON.stringify(courses, null, 2));\r\n                        this.setState({ courses: courses });\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        this.setState({ isLoadingCourses: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KGTermPlanner.prototype.onNoteClick = function (weekNumber, weekDate, courseName, weekPlan, note) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(WeekNoteDialog, { weekNumber: weekNumber, weekDate: weekDate, courseName: courseName, weekPlan: weekPlan, note: note, env: this.props.env, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    /**\r\n   *\r\n   * @param weekNumber\r\n   * @param comment\r\n   *\r\n   * Add a comment from tutor\r\n   */\r\n    KGTermPlanner.prototype.onTutorClick = function (tutorNote, weekNumber) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(TutorDialog, { weekNumber: weekNumber, comment: tutorNote.value, updateData: function (newValue) { return _this.updateTutorNoteField(tutorNote, newValue); }, deleteNoteData: function () { return _this.deleteTutorNoteField(tutorNote.id); }, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    KGTermPlanner.prototype.deleteTutorNoteField = function (noteId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var showError_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 2, , 3]);\r\n                        return [4 /*yield*/, this.props.env.kgTermPlannerRepo.delete([noteId])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        showError_1 = _a.sent();\r\n                        return [3 /*break*/, 3];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KGTermPlanner.prototype.updateTutorNoteField = function (tutorNote, newValue) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var oldValue, showError_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        oldValue = (tutorNote && tutorNote.value) || \"\";\r\n                        if (oldValue === newValue)\r\n                            return [2 /*return*/];\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        tutorNote.value = newValue;\r\n                        //set document ACL\r\n                        tutorNote.acl = [\r\n                            new DocumentAccess(\"tutorFor\", this.props.env.currentUser.mail, \"S\").toString(),\r\n                            new DocumentAccess(\"email\", this.props.env.currentUser.mail, \"R\").toString(),\r\n                        ];\r\n                        return [4 /*yield*/, this.props.env.kgTermPlannerRepo.upsert(tutorNote, function (note) { return note.value = newValue; })];\r\n                    case 2: return [2 /*return*/, _a.sent()];\r\n                    case 3:\r\n                        showError_2 = _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KGTermPlanner.prototype.openDialog = function (dialog) {\r\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\r\n    };\r\n    KGTermPlanner.prototype.closeDialog = function () {\r\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\r\n    };\r\n    KGTermPlanner.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, courses = _a.courses, now = _a.now, isLoadingCourses = _a.isLoadingCourses, isLoadingWeekPlans = _a.isLoadingWeekPlans, weekPlans = _a.weekPlans, dialogs = _a.dialogs;\r\n        var isLoading = isLoadingCourses || isLoadingWeekPlans;\r\n        var weeks = [];\r\n        var tutorNotes = [];\r\n        var schoolMoment = getSchoolMoment(moment(now));\r\n        var _b = tslib_1.__read(getTermStarEndDate(now, schoolMoment.term === 'AT'), 2), termStart = _b[0], termEnd = _b[1];\r\n        var _c = tslib_1.__read(getFirstAndLastWeekOfTerm(schoolMoment.term), 2), firstWeek = _c[0], lastWeek = _c[1];\r\n        var showKgTutorCommentField = features.kgTutorComment;\r\n        var currentWeekPlans = weekPlans.filter(function (x) { return !x.type; });\r\n        var currentTutorNotes = weekPlans.filter(function (x) { return x.type === 'tutor-note'; });\r\n        var _loop_1 = function (weekMoment) {\r\n            var weekNumber = weekMoment.week();\r\n            var weekYear = weekMoment.year();\r\n            var kedWeek = KEDWeek(weekYear, weekNumber);\r\n            if (weekNumber >= firstWeek && weekNumber <= lastWeek) {\r\n                var weekPlan = currentWeekPlans.filter(function (wp) {\r\n                    return wp.dateTime >= kedWeek.notBefore &&\r\n                        wp.dateTime <= kedWeek.notAfter;\r\n                })[0];\r\n                var tutorNote = currentTutorNotes.filter(function (wp) {\r\n                    return wp.dateTime >= kedWeek.notBefore &&\r\n                        wp.dateTime <= kedWeek.notAfter;\r\n                })[0];\r\n                var startOfWeek = weekMoment.clone().startOf('week').valueOf();\r\n                weeks.push({\r\n                    weekNumber: weekNumber,\r\n                    weekDate: startOfWeek,\r\n                    weekPlan: weekPlan\r\n                });\r\n                tutorNotes.push({\r\n                    weekNumber: weekNumber,\r\n                    tutorValue: tutorNote || { value: '', dateTime: startOfWeek, id: createUUID(), type: 'tutor-note' }\r\n                });\r\n            }\r\n        };\r\n        for (var weekMoment = termStart.clone(); weekMoment.valueOf() < termEnd.valueOf(); weekMoment = weekMoment.clone().add(1, 'week').startOf('week')) {\r\n            _loop_1(weekMoment);\r\n        }\r\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n            React.createElement(\"h4\", null, \"Terminsplanering\"),\r\n            React.createElement(\"hr\", null),\r\n            isLoading ?\r\n                React.createElement(Spinner, null) : courses.length === 0 ? React.createElement(\"div\", null, \"Terminsplaneraren aktiveras n\\u00E4r du skrivits in p\\u00E5 dina kurser\") :\r\n                React.createElement(\"table\", { className: \"termplanner-table zebra\" },\r\n                    React.createElement(\"thead\", null,\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"th\", null, \"Vecka\"),\r\n                            courses.map(function (c, idx) { return React.createElement(\"th\", { key: idx, className: \"kgCourseHeader\" }, c.name); }),\r\n                            showKgTutorCommentField && React.createElement(\"th\", { className: \"tutorHeader\" }))),\r\n                    React.createElement(\"tbody\", null, weeks.map(function (w, idx) {\r\n                        var isCurrentWeek = w.weekNumber === moment().week();\r\n                        var noteValue = tutorNotes && tutorNotes.find(function (tn) { return tn.weekNumber === w.weekNumber; });\r\n                        return React.createElement(\"tr\", { key: idx, className: isCurrentWeek ? \"currentWeek\" : \"\" },\r\n                            React.createElement(\"td\", null, w.weekNumber),\r\n                            courses.map(function (c, idx) {\r\n                                var note = w.weekPlan && w.weekPlan.plans[c.name];\r\n                                return React.createElement(\"td\", { key: idx, className: note ? \"courseNote note-color-\" + note.color : \"courseNote\", \"data-tooltip\": note && note.description, title: note && note.description, onClick: function () { return _this.onNoteClick(w.weekNumber, w.weekDate, c.name, w.weekPlan, note); } }, note ? React.createElement(\"i\", { className: \"fas fa-align-center\" }) : '');\r\n                            }),\r\n                            showKgTutorCommentField && (_this.props.tutored ?\r\n                                React.createElement(\"td\", { key: idx, onClick: function () { return _this.onTutorClick(noteValue.tutorValue, w.weekNumber); }, className: \"tutorCell\" }, noteValue.tutorValue.value ? React.createElement(\"div\", { key: idx, \"data-tooltip\": noteValue.tutorValue.value },\r\n                                    React.createElement(\"i\", { className: \"fas fa-comment-dots\" })) : React.createElement(\"div\", { key: idx },\r\n                                    React.createElement(\"i\", { className: \"fas fa-comment-medical\" })))\r\n                                :\r\n                                    noteValue.tutorValue.value ? React.createElement(\"td\", { className: \"tutorCell\" },\r\n                                        React.createElement(\"div\", { \"data-tooltip\": noteValue.tutorValue.value },\r\n                                            React.createElement(\"i\", { className: \"far fa-comment-dots\" }))) : React.createElement(\"td\", null)));\r\n                    })),\r\n                    React.createElement(\"tfoot\", null,\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"th\", { key: \"points\" }, \"Po\\u00E4ng\"),\r\n                            courses.map(function (c, idx) { return React.createElement(\"th\", { key: idx, className: \"stepCell\" }, c.credits); })),\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"th\", null, \"Betygsm\\u00E5l\"),\r\n                            courses.map(function (c, idx) {\r\n                                return React.createElement(\"th\", { key: idx, className: \"stepCell\" }, c.periodGoalGrade);\r\n                            })))),\r\n            React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () { return _this.setState({ dialogs: dialogs.slice(0, dialogs.length - 1) }); } }));\r\n    };\r\n    return KGTermPlanner;\r\n}(React.Component));\r\nexport { KGTermPlanner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { createUUID } from 'kedbackend/client';\r\nvar WeekNoteDialog = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekNoteDialog, _super);\r\n    function WeekNoteDialog(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            description: props.note ? props.note.description : '',\r\n            color: props.note ? props.note.color : 'yellow'\r\n        };\r\n        return _this;\r\n    }\r\n    WeekNoteDialog.prototype.delete = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, weekNumber, weekDate, courseName, weekPlan, note, closeDialog, env, _b, description, color;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.props, weekNumber = _a.weekNumber, weekDate = _a.weekDate, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, closeDialog = _a.closeDialog, env = _a.env;\r\n                        _b = this.state, description = _b.description, color = _b.color;\r\n                        closeDialog();\r\n                        if (!(Object.keys(weekPlan.plans).length === 1)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, env.kgTermPlannerRepo.delete([weekPlan.id])];\r\n                    case 1:\r\n                        _c.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, env.kgTermPlannerRepo.update([weekPlan], function (wp) {\r\n                            delete wp.plans[courseName];\r\n                        })];\r\n                    case 3:\r\n                        _c.sent();\r\n                        _c.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekNoteDialog.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, weekNumber, weekDate, courseName, weekPlan, note, closeDialog, env, _b, description, color, plans;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.props, weekNumber = _a.weekNumber, weekDate = _a.weekDate, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, closeDialog = _a.closeDialog, env = _a.env;\r\n                        _b = this.state, description = _b.description, color = _b.color;\r\n                        closeDialog();\r\n                        if (description.length == 0) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (!weekPlan) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, env.kgTermPlannerRepo.update([weekPlan], function (wp) { return wp.plans[courseName] = { description: description, color: color }; })];\r\n                    case 1:\r\n                        _c.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2:\r\n                        plans = {};\r\n                        plans[courseName] = { description: description, color: color };\r\n                        return [4 /*yield*/, env.kgTermPlannerRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    dateTime: weekDate,\r\n                                    plans: plans\r\n                                }])];\r\n                    case 3:\r\n                        _c.sent();\r\n                        _c.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekNoteDialog.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, weekNumber = _a.weekNumber, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, env = _a.env;\r\n        var _b = this.state, description = _b.description, color = _b.color;\r\n        var readOnly = env.tutored;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"h2\", null,\r\n                    \"H\\u00E4ndelse f\\u00F6r vecka \",\r\n                    weekNumber,\r\n                    \" och \",\r\n                    courseName),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-table\" },\r\n                    React.createElement(\"div\", null, \"Beskrivning:\"),\r\n                    React.createElement(\"div\", { className: \"fullWidth\" },\r\n                        React.createElement(\"textarea\", { autoFocus: true, value: description, disabled: readOnly, onChange: function (ev) { return _this.setState({ description: ev.target.value }); } }))),\r\n                React.createElement(\"div\", { className: \"align-table\" },\r\n                    React.createElement(\"div\", null, \"F\\u00E4rg:\"),\r\n                    React.createElement(\"div\", null,\r\n                        React.createElement(\"select\", { value: color, disabled: readOnly, onChange: function (ev) { return _this.setState({ color: ev.target.value }); } },\r\n                            React.createElement(\"option\", { value: \"yellow\" }, \"Gul\"),\r\n                            React.createElement(\"option\", { value: \"yellowLight\" }, \"Ljusgul\"),\r\n                            React.createElement(\"option\", { value: \"cyan\" }, \"Gr\\u00F6n\"),\r\n                            React.createElement(\"option\", { value: \"cyanLight\" }, \"Ljusgr\\u00F6n\"),\r\n                            React.createElement(\"option\", { value: \"purple\" }, \"Lila\"),\r\n                            React.createElement(\"option\", { value: \"purpleLight\" }, \"Ljuslila\"),\r\n                            React.createElement(\"option\", { value: \"red\" }, \"R\\u00F6d\"),\r\n                            React.createElement(\"option\", { value: \"redLight\" }, \"Rosa\"))))),\r\n            React.createElement(\"div\", null, readOnly ?\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.props.closeDialog(); } }, \"Avbryt\") :\r\n                React.createElement(React.Fragment, null,\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } }, \"Spara\"),\r\n                    note && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return _this.delete(); } }, \"Ta bort\"))));\r\n    };\r\n    return WeekNoteDialog;\r\n}(React.Component));\r\nexport { WeekNoteDialog };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../globals/KED.env';\r\nimport { FutureAbilitiesViewModel } from './future-abilities-viewmodel';\r\nvar FutureAbilitiesTable = /** @class */ (function (_super) {\r\n    tslib_1.__extends(FutureAbilitiesTable, _super);\r\n    function FutureAbilitiesTable(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            loading: false,\r\n            data: [],\r\n            error: null\r\n        };\r\n        return _this;\r\n    }\r\n    FutureAbilitiesTable.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    FutureAbilitiesTable.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ loading: true });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        return [4 /*yield*/, env.edsClient.getStudentFutureAbilities()];\r\n                    case 2:\r\n                        data = _a.sent();\r\n                        this.setState({ data: data });\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        error_1 = _a.sent();\r\n                        this.setState({ error: error_1 });\r\n                        return [3 /*break*/, 4];\r\n                    case 4:\r\n                        this.setState({ loading: false });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FutureAbilitiesTable.prototype.render = function () {\r\n        var viewModel = new FutureAbilitiesViewModel(this.state.data);\r\n        var columnHeaders = viewModel.columnHeaders, vtHts = viewModel.vtHts, capabRows = viewModel.capabRows;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"h5\", null, \"Framtidsf\\u00F6rm\\u00E5gor\"),\r\n            React.createElement(\"div\", { className: \"partialEditStudyPlanViewMode\" },\r\n                React.createElement(\"table\", { style: { width: '100%' }, className: \"smallFont\" },\r\n                    React.createElement(\"thead\", null,\r\n                        React.createElement(\"tr\", null, columnHeaders.map(function (_a, i) {\r\n                            var name = _a.name, type = _a.type;\r\n                            return type === 'header' ?\r\n                                React.createElement(\"th\", { key: i, rowSpan: 2 }, name) :\r\n                                React.createElement(\"th\", { key: i, colSpan: 2 }, name);\r\n                        })),\r\n                        React.createElement(\"tr\", { className: \"header\" }, vtHts.map(function (vtHt, i) { return React.createElement(\"th\", { key: i }, vtHt); }))),\r\n                    React.createElement(\"tbody\", null, capabRows.map(function (row, i) { return React.createElement(\"tr\", { key: i, className: (Math.floor(i / 3) % 2) && 'tableOdd' }, row.map(function (col, i) { return col.type === 'ability' ?\r\n                        React.createElement(\"td\", { key: i, rowSpan: 3, className: \"goalsSubject\" }, col.name) :\r\n                        col.type === 'capability' ?\r\n                            React.createElement(\"td\", { key: i, className: \"goalsSubject\" }, col.name) :\r\n                            col.selected ?\r\n                                React.createElement(\"td\", { key: i, className: \"edsSelected\" },\r\n                                    React.createElement(\"div\", { className: \"markedItem\" })) :\r\n                                React.createElement(\"td\", { key: i }); })); })))));\r\n    };\r\n    return FutureAbilitiesTable;\r\n}(React.Component));\r\nexport { FutureAbilitiesTable };\r\n","import { flatten } from '../../utils/utils';\r\nvar FutureAbilitiesViewModel = /** @class */ (function () {\r\n    function FutureAbilitiesViewModel(data) {\r\n        // Will build the total years\r\n        var formNames = {};\r\n        data.forEach(function (a) { return a.capabilities.forEach(function (c) { return formNames[c.formName] = true; }); });\r\n        var years = Object.keys(formNames);\r\n        // columnHeaders\r\n        this.columnHeaders = [{\r\n                name: \"Framtidsförmåga\",\r\n                type: \"header\"\r\n            }, {\r\n                name: \"Område\",\r\n                type: \"header\"\r\n            }].concat(years.map(function (year) { return ({\r\n            name: year,\r\n            type: 'year'\r\n        }); }));\r\n        // vtHts\r\n        this.vtHts = flatten(years.map(function (year) { return [\"HT\", \"VT\"]; }));\r\n        // cababRows\r\n        var rows = [];\r\n        data.forEach(function (a) {\r\n            var row = [{ type: 'ability', name: a.abilityName }];\r\n            var addedCapabs = {};\r\n            a.capabilities.forEach(function (c) {\r\n                var cells = [\r\n                    { type: 'term', selected: c.htHasValue !== false },\r\n                    { type: 'term', selected: c.vtHasValue !== false }\r\n                ];\r\n                //if (c.htHasValue || c.vtHasValue) debugger;\r\n                if (!addedCapabs[c.capabilityName]) {\r\n                    //if (!isFirstCapability) rows.push(row);\r\n                    if (row.length > 1) {\r\n                        rows.push(row);\r\n                        row = [];\r\n                    }\r\n                    addedCapabs[c.capabilityName] = true;\r\n                    row.push({ type: 'capability', name: c.capabilityName });\r\n                    cells.forEach(function (cell) { return row.push(cell); });\r\n                }\r\n                else if (row) {\r\n                    //addedCapabs[c.capabilityName].concat(cells);\r\n                    cells.forEach(function (cell) { return row.push(cell); });\r\n                }\r\n            });\r\n            if (row)\r\n                rows.push(row);\r\n        });\r\n        this.capabRows = rows;\r\n    }\r\n    return FutureAbilitiesViewModel;\r\n}());\r\nexport { FutureAbilitiesViewModel };\r\n","import { EDSPeriod } from '../../apis/edsclient';\r\nvar ViewModel = /** @class */ (function () {\r\n    function ViewModel(studyPlans) {\r\n        this.subjects = studyPlans.map(function (sp) {\r\n            var periodGoals = sp.periodGoals\r\n                .map(function (g) { return ({ period: new EDSPeriod(g.periodName), goal: g.gradeName }); });\r\n            return {\r\n                name: sp.courseUnitName,\r\n                atGoal: periodGoals.filter(function (_a) {\r\n                    var period = _a.period;\r\n                    return period.term === 'AT';\r\n                }).map(function (_a) {\r\n                    var goal = _a.goal;\r\n                    return goal;\r\n                })[0],\r\n                stGoal: periodGoals.filter(function (_a) {\r\n                    var period = _a.period;\r\n                    return period.term === 'ST';\r\n                }).map(function (_a) {\r\n                    var goal = _a.goal;\r\n                    return goal;\r\n                })[0],\r\n                finalGoal: sp.finalGoalGrade,\r\n                strategies: sp.strategyText\r\n            };\r\n        });\r\n    }\r\n    return ViewModel;\r\n}());\r\nexport { ViewModel };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../utils/utils';\r\nimport { ViewModel } from './goals-viewmodel';\r\nimport env from '../../globals/KED.env';\r\nimport { FutureAbilitiesTable } from './future-abilities-table';\r\nvar KSGoals = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KSGoals, _super);\r\n    function KSGoals(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            loadingStudyPlans: false,\r\n            studyPlans: [],\r\n            error: null\r\n        };\r\n        return _this;\r\n    }\r\n    KSGoals.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    KSGoals.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var studyPlans, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ loadingStudyPlans: true });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        return [4 /*yield*/, env.edsClient.getStudentGoals()];\r\n                    case 2:\r\n                        studyPlans = _a.sent();\r\n                        this.setState({ studyPlans: studyPlans });\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        error_1 = _a.sent();\r\n                        this.setState({ error: error_1 });\r\n                        return [3 /*break*/, 4];\r\n                    case 4:\r\n                        this.setState({ loadingStudyPlans: false });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KSGoals.prototype.render = function () {\r\n        var viewModel = new ViewModel(this.state.studyPlans);\r\n        var showTermGoals = ('' + env.currentUser.schoolType).toLowerCase() !== \"gymnasium\";\r\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n            React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"M\\u00E5l\"], [\"M\\u00E5l\"])))),\r\n            React.createElement(\"hr\", null),\r\n            React.createElement(\"table\", { className: \"smallFont\" },\r\n                React.createElement(\"thead\", null,\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"])))),\r\n                        showTermGoals && React.createElement(\"th\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"HT\"], [\"HT\"])))),\r\n                        showTermGoals && React.createElement(\"th\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"VT\"], [\"VT\"])))),\r\n                        React.createElement(\"th\", null, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Slutm\\u00E5l\"], [\"Slutm\\u00E5l\"])))),\r\n                        React.createElement(\"th\", null, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Strategier\"], [\"Strategier\"])))))),\r\n                React.createElement(\"tbody\", null, viewModel.subjects.map(function (s, i) {\r\n                    return React.createElement(\"tr\", { key: s.name, className: i % 2 && \"tableOdd\" },\r\n                        React.createElement(\"td\", { className: \"goalsSubject\" }, s.name),\r\n                        showTermGoals && React.createElement(\"td\", { className: \"goalsTerm\" }, s.atGoal),\r\n                        showTermGoals && React.createElement(\"td\", { className: \"goalsTerm\" }, s.stGoal),\r\n                        React.createElement(\"td\", { className: \"goalsEnd\" }, s.finalGoal),\r\n                        React.createElement(\"td\", null, s.strategies));\r\n                }))),\r\n            React.createElement(\"div\", { className: \"divider\" }),\r\n            React.createElement(FutureAbilitiesTable, null));\r\n    };\r\n    return KSGoals;\r\n}(React.Component));\r\nexport { KSGoals };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as React from 'react';\r\nimport { KSTermPlanner } from './termplanner';\r\nimport env from '../../globals/KED.env';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nexport function KSTermPlannerSelf(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(KSTermPlanner, { env: env, tutored: false, initialDate: new Date() }));\r\n}\r\n","import * as React from 'react';\r\nimport { KSTermPlanner } from './termplanner';\r\nimport { TutorableComponent } from '../utility-components/tutorable-component';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nexport function KSTermPlannerTutored(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\r\n                return React.createElement(KSTermPlanner, { key: env.currentUser.mail, env: env, tutored: true, initialDate: new Date() });\r\n            } }));\r\n}\r\n","export function getFirstAndLastWeek(term) {\r\n    return term === 'AT' ?\r\n        [33, 50] : // This is a guess! Need data! Should be possible to get from skola24?\r\n        [2, 23]; // This is a guess! Need data!\r\n}\r\nexport var LAST_STEP_SPRING = 28; // Week 28 is in summer. Use it as placeholder for \"last step\"\r\nexport var LAST_STEP_AUTUMN = 52; // Week must be valid. Use it as placeholder for \"last step\"\r\n/**\r\n * Note that this function is tightly coupled to the swedish school.\r\n */\r\nexport function findCourseFromColumnHeader(courses, columnHeader) {\r\n    switch (columnHeader) {\r\n        case 'M.spr': return courses\r\n            .filter(function (course) { return course.shortName !== 'MA' && course.shortName.startsWith('M'); })[0] || null;\r\n        case 'Ma': return courses.filter(function (c) { return c.shortName === \"MA\"; })[0] || null;\r\n        case 'Sv/SvA': return courses.filter(function (c) { return c.shortName.startsWith(\"SV\"); })[0] || null;\r\n        case 'Eng': return courses.filter(function (c) { return c.shortName === \"EN\"; })[0] || null;\r\n    }\r\n    return null;\r\n}\r\nexport function getColumnsHeader(locale) {\r\n    switch (locale) {\r\n        case 'sv':\r\n            return ['M.spr', 'Ma', 'Sv/SvA', 'Eng'];\r\n        case 'en_sin':\r\n            return ['MFL', 'Ma', 'Hi', 'Eng', 'Yoga', 'ICT'];\r\n        case 'en_nin':\r\n            return ['MFL', 'Ma', 'Hi', 'Eng', 'Yoga', 'ICT'];\r\n    }\r\n}\r\n/**\r\n * Note that this function is tightly coupled to the swedish school.\r\n */\r\nexport function getColumnHeaderFromCourse(course) {\r\n    var shortName = course.shortName;\r\n    if (shortName === \"MA\")\r\n        return 'Ma';\r\n    if (shortName === \"EN\")\r\n        return 'Eng';\r\n    if (shortName.startsWith(\"SV\"))\r\n        return 'Sv/SvA';\r\n    if (shortName.startsWith(\"M2\"))\r\n        return 'M.spr';\r\n    return null;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { GenericSchoolTerm } from '../../utils/generic-school-term';\r\nimport { ViewModel } from './viewmodel';\r\nimport { ContentEditableField } from '../utility-components/content-editable-field';\r\nimport '../../repos/ks-termplanner-repo-instance';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { Doughnut } from '../charts/doughnut';\r\nimport { getSchoolTranslatedSubjectFullname } from '../../utils/generic-school-utils';\r\nimport { Dialogs } from '../utility-components/dialogs';\r\nimport { TutorDialog } from './tutor-dialog';\r\nimport { DocumentAccess } from 'kedbackend/client';\r\nimport { features } from '../../features';\r\nimport { OpenCloseBox } from '../utility-components/open-close-box';\r\nvar KSTermPlanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KSTermPlanner, _super);\r\n    function KSTermPlanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.unmounted = false;\r\n        _this.state = {\r\n            schoolTerm: new GenericSchoolTerm(props.initialDate),\r\n            activeCourses: [],\r\n            weekPlans: [],\r\n            error: null,\r\n            loadingActiveCourses: false,\r\n            loadingWeekPlans: false,\r\n            initialLoad: true,\r\n            dialogs: []\r\n        };\r\n        _this.flowId = 1;\r\n        _this.updateWeekPlans = _this.updateWeekPlans.bind(_this);\r\n        return _this;\r\n    }\r\n    KSTermPlanner.prototype.componentDidMount = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.load(this.state.schoolTerm)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        if (!this.unmounted)\r\n                            this.props.env.ksTermPlannerRepo.mem.subscribe(this.updateWeekPlans);\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KSTermPlanner.prototype.componentWillUnmount = function () {\r\n        this.unmounted = true;\r\n        this.props.env.ksTermPlannerRepo.mem.unsubscribe(this.updateWeekPlans);\r\n    };\r\n    KSTermPlanner.prototype.updateWeekPlans = function (weekPlansOrTutorComm, error) {\r\n        this.setState({ weekPlans: weekPlansOrTutorComm, loadingWeekPlans: false, error: error || null });\r\n    };\r\n    KSTermPlanner.prototype.load = function (schoolTerm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var flowId, ksTermPlannerRepo, term, currentSchoolTerm, activeCourses, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        flowId = ++this.flowId;\r\n                        this.fields = [];\r\n                        this.setState({\r\n                            //loadingWeekPlans: true,\r\n                            loadingActiveCourses: true\r\n                        });\r\n                        ksTermPlannerRepo = this.props.env.ksTermPlannerRepo;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 4, , 5]);\r\n                        return [4 /*yield*/, this.loadAcademicYearDates(schoolTerm, cfg.KED_SCHOOL_LOCALE)];\r\n                    case 2:\r\n                        term = _a.sent();\r\n                        if (this.flowId !== flowId)\r\n                            return [2 /*return*/];\r\n                        currentSchoolTerm = new GenericSchoolTerm(schoolTerm.selectedDate, this.context.intl.locale, term);\r\n                        //refresh saved data\r\n                        ksTermPlannerRepo.refreshData(currentSchoolTerm.getTermStartAndEnd(true));\r\n                        return [4 /*yield*/, this.loadActiveCourses(currentSchoolTerm)];\r\n                    case 3:\r\n                        activeCourses = _a.sent();\r\n                        if (this.flowId !== flowId)\r\n                            return [2 /*return*/];\r\n                        this.setState({ schoolTerm: currentSchoolTerm, initialLoad: false, activeCourses: activeCourses, loadingActiveCourses: false });\r\n                        return [3 /*break*/, 5];\r\n                    case 4:\r\n                        error_1 = _a.sent();\r\n                        if (this.flowId !== flowId)\r\n                            return [2 /*return*/];\r\n                        this.setState({ schoolTerm: currentSchoolTerm, loadingActiveCourses: false, error: error_1 });\r\n                        return [3 /*break*/, 5];\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KSTermPlanner.prototype.loadAcademicYearDates = function (schoolTerm, schoolLocale) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var termDates;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.props.env.edsClient.getAcademicYearTerms(schoolLocale, schoolTerm.selectedDate)];\r\n                    case 1:\r\n                        termDates = _a.sent();\r\n                        return [2 /*return*/, termDates];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KSTermPlanner.prototype.loadActiveCourses = function (schoolTerm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var periodName, activeCourses;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        periodName = schoolTerm.getEdsPeriodName();\r\n                        return [4 /*yield*/, this.props.env.edsClient.getActiveCourses({ periodName: periodName })];\r\n                    case 1:\r\n                        activeCourses = _a.sent();\r\n                        return [2 /*return*/, activeCourses];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KSTermPlanner.prototype.updateCell = function (weekPlan, columnName, newValue) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var oldValue, error_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        oldValue = (weekPlan && weekPlan.cellValues[columnName]) || \"\";\r\n                        if (oldValue === newValue)\r\n                            return [2 /*return*/];\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        weekPlan.cellValues[columnName] = newValue;\r\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.upsert(weekPlan, function (wp) { return wp.cellValues[columnName] = newValue; })];\r\n                    case 2: return [2 /*return*/, _a.sent()];\r\n                    case 3:\r\n                        error_2 = _a.sent();\r\n                        console.error(error_2.stack || error_2);\r\n                        if (error_2.name === \"http403\") {\r\n                            this.setState({ error: this.context.intl({ id: \"common.changesNotSavedUnauthorized\", defaultMessage: \"Ändringarna sparades inte p.g.a. otillräcklig behörighet.\" }) });\r\n                        }\r\n                        else {\r\n                            this.setState({ error: this.context.intl({ id: \"common.changesNotSavedErrorOccured\", defaultMessage: \"För tillfället problem att spara data. Dina ändringar sparades inte.\" }) });\r\n                        }\r\n                        return [3 /*break*/, 4];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     *\r\n     * @param tutorNote\r\n     * @param newValue\r\n     *\r\n     * Update tutor field value\r\n     */\r\n    KSTermPlanner.prototype.updateTutorNoteField = function (tutorNote, newValue) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var oldValue, showError_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        oldValue = (tutorNote && tutorNote.content) || \"\";\r\n                        if (oldValue === newValue)\r\n                            return [2 /*return*/];\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        tutorNote.content = newValue;\r\n                        //set document ACL\r\n                        tutorNote.acl = [\r\n                            new DocumentAccess(\"tutorFor\", this.props.env.currentUser.mail, \"S\").toString(),\r\n                            new DocumentAccess(\"email\", this.props.env.currentUser.mail, \"R\").toString(),\r\n                        ];\r\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.upsert(tutorNote, function (note) { return note.content = newValue; })];\r\n                    case 2: return [2 /*return*/, _a.sent()];\r\n                    case 3:\r\n                        showError_1 = _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Delete tutor comment by Id\r\n     * @param noteId\r\n     */\r\n    KSTermPlanner.prototype.deleteTutorNoteField = function (noteId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var showError_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 2, , 3]);\r\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.delete([noteId])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        showError_2 = _a.sent();\r\n                        return [3 /*break*/, 3];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Add a comment from tutor\r\n     * @param weekNumber\r\n     * @param comment\r\n     *\r\n     */\r\n    KSTermPlanner.prototype.onTutorClick = function (note) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(TutorDialog, { weekNumber: note.weekNumber, comment: note.content, intl: this.context.intl, updateData: function (val) { return _this.updateTutorNoteField(note, val); }, deleteNoteData: function () { return _this.deleteTutorNoteField(note.id); }, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    KSTermPlanner.prototype.openDialog = function (dialog) {\r\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\r\n    };\r\n    KSTermPlanner.prototype.closeDialog = function () {\r\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\r\n    };\r\n    /**\r\n     * Navigate to adjacent field depending on direction\r\n     * @param pos current position in field-matrix\r\n     * @param direction direction to take\r\n     */\r\n    KSTermPlanner.prototype.navigate = function (pos, direction) {\r\n        var newpos = tslib_1.__assign({}, pos);\r\n        var maxRows = this.fields.length;\r\n        var maxCols = Math.max.apply(Math, tslib_1.__spread(this.fields.map(function (row) { return row.length; })));\r\n        switch (direction) {\r\n            case 'up':\r\n                newpos.row = Math.max(pos.row - 1, 0);\r\n                break;\r\n            case 'down':\r\n                newpos.row = Math.min(pos.row + 1, maxRows);\r\n                break;\r\n            case 'left':\r\n                newpos.col = Math.max(pos.col - 1, 0);\r\n                break;\r\n            case 'right':\r\n                newpos.col = Math.min(pos.col + 1, maxCols);\r\n                break;\r\n        }\r\n        if (this.fields[newpos.row] && this.fields[newpos.row][newpos.col])\r\n            this.fields[newpos.row][newpos.col].myself.current.focus();\r\n    };\r\n    /**\r\n     * Adds field to field-matrix to enable navigation in thee table\r\n     * @param field current field\r\n     * @param pos position of field in field-matrix\r\n     */\r\n    KSTermPlanner.prototype.addField = function (field, pos) {\r\n        if (this.fields[pos.row] === undefined) {\r\n            this.fields[pos.row] = [];\r\n        }\r\n        this.fields[pos.row][pos.col] = field;\r\n    };\r\n    /**\r\n     * Creates the cell in the termplanner table\r\n     * @param rowIndex index of row in table\r\n     * @param colIndex index of column in table\r\n     * @param subjectName name field\r\n     * @param model --unused?\r\n     * @param weekPlan current row from weekPlan\r\n     * @param readOnlyCells if cells are readonly\r\n     */\r\n    KSTermPlanner.prototype.getTableCell = function (rowIndex, colIndex, subjectName, model, weekPlan, readOnlyCells, colType) {\r\n        var _this = this;\r\n        var completedSteps = model.completedSteps;\r\n        var pos = { row: rowIndex, col: colIndex };\r\n        if (colType === 'Tutor') {\r\n            var tutoredWeekPlan = weekPlan;\r\n            var content = tutoredWeekPlan.content;\r\n            if (this.props.tutored) {\r\n                return React.createElement(\"td\", { key: \"tutornote\" + colIndex, onClick: function () { return _this.onTutorClick(tutoredWeekPlan); }, className: \"tutorCell\" }, content ? React.createElement(\"div\", { key: colIndex, \"data-tooltip\": content },\r\n                    React.createElement(\"i\", { key: colIndex, className: \"fas fa-comment-dots\" })) :\r\n                    React.createElement(\"div\", { key: colIndex },\r\n                        React.createElement(\"i\", { key: colIndex, className: \"fas fa-comment-medical\" })));\r\n            }\r\n            return React.createElement(\"td\", { key: \"tutornote\" + colIndex, className: \"tutorCell\" }, content && React.createElement(\"div\", { key: colIndex, \"data-tooltip\": content },\r\n                React.createElement(\"i\", { key: colIndex, className: \"far fa-comment-dots\" })));\r\n        }\r\n        else {\r\n            var currentWeekPlan = weekPlan;\r\n            var cellValues = currentWeekPlan.cellValues;\r\n            // an outer td cell and inner div is used to regulate the height and allow for ellipses on text-overflow\r\n            return React.createElement(\"td\", { className: this.getCellClassName(completedSteps, cellValues, subjectName) },\r\n                React.createElement(ContentEditableField, { key: colIndex, ref: function (field) { return _this.addField(field, pos); }, text: cellValues[subjectName], tag: 'div', validateValue: colType == 'Step' ? /^\\d*$/ : undefined, maxChars: colType == 'Comment' ? 100 : (colType == 'Course' ? 30 : 3), onChange: this.updateCell.bind(this, weekPlan, subjectName), readOnly: readOnlyCells || colType == 'Tutor', allowNavigation: true, onNavigate: this.navigate.bind(this, pos) }));\r\n        }\r\n    };\r\n    /**\r\n     * Get classname for cell\r\n     * @param completedSteps\r\n     * @param cellValues\r\n     * @param subjectName\r\n     */\r\n    KSTermPlanner.prototype.getCellClassName = function (completedSteps, cellValues, subjectName) {\r\n        var colType = this.getColumnType(subjectName);\r\n        if (colType == 'Step' && completedSteps[subjectName + cellValues[subjectName]]) {\r\n            return 'stepCell completedStep';\r\n        }\r\n        return colType.toLowerCase() + 'Cell';\r\n    };\r\n    /**\r\n     * Creates the cell in the termplanner tables footer\r\n     * @param rowIndex index of row in table\r\n     * @param colIndex index of column in table\r\n     * @param subjectName name field\r\n     * @param model\r\n     * @param readOnlyCells if cells are readonly\r\n     */\r\n    KSTermPlanner.prototype.getFooterCell = function (rowIndex, colIndex, subjectName, model, readOnlyCells) {\r\n        var _this = this;\r\n        var pos = { row: rowIndex, col: colIndex };\r\n        var colType = this.getColumnType(subjectName);\r\n        return React.createElement(\"th\", { className: colType + \"Footer\" },\r\n            React.createElement(ContentEditableField, { key: \"stepFooterCell\" + colIndex, ref: function (field) { return _this.addField(field, pos); }, tag: 'div', text: model.lastSteps.cellValues[subjectName], onChange: this.updateCell.bind(this, model.lastSteps, subjectName), readOnly: readOnlyCells, maxChars: 10, allowNavigation: true, onNavigate: this.navigate.bind(this, pos) }));\r\n    };\r\n    KSTermPlanner.prototype.getStepHeaderColumn = function (index, translatedColumnHeader, colType) {\r\n        return React.createElement(\"th\", { key: \"stepHeaderCell_\" + index, className: colType.toLowerCase() + \"Header\" }, colType != 'Tutor' ? translatedColumnHeader : '');\r\n    };\r\n    KSTermPlanner.prototype.getColumnType = function (name) {\r\n        var colTypes = { 'Kommentar': 'Comment', 'Kurs': 'Course', 'TutorComment': 'Tutor' };\r\n        return colTypes.hasOwnProperty(name) ? colTypes[name] : 'Step';\r\n    };\r\n    KSTermPlanner.prototype.openCloseProgressCharts = function (value) {\r\n        localStorage.setItem('TermplannerBoxCharts', value);\r\n    };\r\n    KSTermPlanner.prototype.getStepCharts = function (columns, subjectProgress) {\r\n        var _this = this;\r\n        var chartsBoxState = JSON.parse(localStorage.getItem('TermplannerBoxCharts'));\r\n        return React.createElement(OpenCloseBox, { headerOpen: chartsBoxState, onOpenClose: this.openCloseProgressCharts, title: this.context.intl.formatMessage({ id: \"termplanner.chartsBoxTitle\", defaultMessage: \"Min progression\" }) },\r\n            React.createElement(\"div\", { className: \"charts-container\" }, columns.map(function (element) {\r\n                if (!element.isFixed) {\r\n                    var percentage = subjectProgress[element.name] ? subjectProgress[element.name].value : 0;\r\n                    var errorMessage = subjectProgress[element.name].finalStepCompleted ? null :\r\n                        _this.context.intl.formatMessage({ id: \"termplanner.noFinalStepAvailable\", defaultMessage: \"Inget slutsteg tillgängligt\" });\r\n                    var translatedColumns = getSchoolTranslatedSubjectFullname(_this.context.intl);\r\n                    return React.createElement(\"div\", { key: element.name, className: \"chart-box\" },\r\n                        React.createElement(\"h4\", null, translatedColumns[element.name]),\r\n                        React.createElement(\"div\", { key: element.name, className: \"inner-chart-box\" },\r\n                            React.createElement(Doughnut, { key: element.name, percentage: percentage, errorMessage: errorMessage })));\r\n                }\r\n            })));\r\n    };\r\n    KSTermPlanner.prototype.getWeekTutorNote = function (weekPlansOrTutorNote, weekNumber) {\r\n        return weekPlansOrTutorNote.find(function (x) { return x.type === \"tutor-note\" && x.weekNumber === weekNumber; });\r\n    };\r\n    KSTermPlanner.prototype.render = function () {\r\n        var _this = this;\r\n        var intl = this.context.intl;\r\n        var showTutorCommentField = features.ksTutorComment;\r\n        var showDoughnutCharts = features.termplannerCharts;\r\n        var model = new ViewModel(this.state.weekPlans, this.state.activeCourses, this.state.schoolTerm, cfg.KED_SCHOOL_LOCALE, intl, showTutorCommentField);\r\n        var termGoals = model.termGoals, columns = model.columns;\r\n        var tutored = this.props.tutored;\r\n        var _a = this.state, loadingWeekPlans = _a.loadingWeekPlans, error = _a.error, dbWeekPlans = _a.weekPlans, dialogs = _a.dialogs;\r\n        var failedInitialLoad = dbWeekPlans.length === 0 && !!error;\r\n        var readOnlyCells = failedInitialLoad || tutored || loadingWeekPlans;\r\n        var rowOffset = 0;\r\n        var filteredWeekplans = model.weekPlansOrTutorNote.filter(function (x) { return !x.type; });\r\n        return this.state.initialLoad ? React.createElement(\"p\", null,\r\n            React.createElement(Spinner, null),\r\n            React.createElement(FormattedMessage, { id: \"termplanner.loadingTermplanner\", defaultMessage: \"V.g. v\\u00E4nta medan terminsplaner laddas...\" })) :\r\n            React.createElement(\"div\", { className: \"termplanner\" +\r\n                    (this.state.loadingWeekPlans ? \" loading-weekplans\" : \"\") +\r\n                    (this.state.loadingActiveCourses ? \" loading-courses\" : \"\") },\r\n                showDoughnutCharts && this.state.activeCourses.length > 0 && this.getStepCharts(columns, model.subjectProgress),\r\n                React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                    React.createElement(\"div\", { className: \"weekSelect\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"p\", null, this.state.schoolTerm.toLocaleString(intl, true))),\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"div\", { className: \"btn-group\" },\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () {\r\n                                        var term = _this.state.schoolTerm.prevTerm();\r\n                                        _this.load(term);\r\n                                    } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () {\r\n                                        var term = _this.state.schoolTerm.nextTerm();\r\n                                        _this.load(term);\r\n                                    } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" }))))),\r\n                    React.createElement(FormattedMessage, { id: \"termplanner.termPlanning\", defaultMessage: \"Terminsplanering\", tagName: \"h4\" }),\r\n                    React.createElement(\"hr\", null),\r\n                    React.createElement(\"table\", { className: \"termplanner-table zebra\" },\r\n                        React.createElement(\"thead\", null,\r\n                            React.createElement(\"tr\", null,\r\n                                React.createElement(\"th\", { className: \"weekColumn\" },\r\n                                    React.createElement(FormattedMessage, { id: \"termplanner.weekNumber\", defaultMessage: \"Vecka\" })),\r\n                                columns.map(function (elem, index) {\r\n                                    var colType = _this.getColumnType(elem.name);\r\n                                    return _this.getStepHeaderColumn(index, elem.translatedName, colType);\r\n                                }))),\r\n                        React.createElement(\"tbody\", null, filteredWeekplans.filter(function (wk) { return wk.cellValues; }).map(function (weekPlan, rowIndex) {\r\n                            rowOffset = rowIndex;\r\n                            var weekNumber = weekPlan.weekNumber, academicWeekNumber = weekPlan.academicWeekNumber;\r\n                            var week = weekNumber;\r\n                            var isCurrentWeek = _this.state.schoolTerm.isCurrentWeek(weekPlan.dateTime);\r\n                            return React.createElement(\"tr\", { key: model.year + ':' + week, className: isCurrentWeek ? \"currentWeek\" : \"\" },\r\n                                React.createElement(\"td\", null, intl.locale === \"sv\" ? week : academicWeekNumber),\r\n                                columns.map(function (elem, colIndex) {\r\n                                    var colType = _this.getColumnType(elem.name);\r\n                                    var tutorValue = _this.getWeekTutorNote(model.weekPlansOrTutorNote, weekNumber);\r\n                                    return colType === \"Tutor\" ?\r\n                                        tutorValue && showTutorCommentField && _this.getTableCell(rowIndex, colIndex, elem.name, model, tutorValue, readOnlyCells, colType) :\r\n                                        _this.getTableCell(rowIndex, colIndex, elem.name, model, weekPlan, readOnlyCells, colType);\r\n                                }));\r\n                        })),\r\n                        React.createElement(\"tfoot\", null,\r\n                            React.createElement(\"tr\", null,\r\n                                React.createElement(\"th\", null,\r\n                                    React.createElement(FormattedMessage, { id: \"termplanner.finalStep\", defaultMessage: \"Slutsteg\" })),\r\n                                columns.filter(function (c) { return !c.isFixed; }).map(function (elem, index) {\r\n                                    return _this.getFooterCell(rowOffset + 1, index, elem.name, model, readOnlyCells);\r\n                                }),\r\n                                React.createElement(\"th\", null, \"-\"),\r\n                                React.createElement(\"th\", null),\r\n                                showTutorCommentField && React.createElement(\"th\", null)),\r\n                            React.createElement(\"tr\", null,\r\n                                React.createElement(\"th\", null,\r\n                                    React.createElement(FormattedMessage, { id: \"termplanner.edsGoalGrades\", defaultMessage: \"Terminsm\\u00E5l\" })),\r\n                                columns.filter(function (c) { return !c.isFixed; }).map(function (elem, index) {\r\n                                    var colType = _this.getColumnType(elem.name).toLowerCase();\r\n                                    return React.createElement(\"th\", { key: \"grades_\" + index, className: colType + \"Footer\" }, termGoals[elem.name]);\r\n                                }),\r\n                                React.createElement(\"th\", null, \"-\"),\r\n                                React.createElement(\"th\", null, this.state.error && React.createElement(\"p\", { className: \"error\" }, '' + this.state.error)),\r\n                                showTutorCommentField && React.createElement(\"th\", null))))),\r\n                React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () { return _this.setState({ dialogs: dialogs.slice(0, dialogs.length - 1) }); } }));\r\n    };\r\n    KSTermPlanner.contextType = LanguageContext;\r\n    return KSTermPlanner;\r\n}(React.Component));\r\nexport { KSTermPlanner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar TutorDialog = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TutorDialog, _super);\r\n    function TutorDialog(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            comment: props.comment ? props.comment : ''\r\n        };\r\n        return _this;\r\n    }\r\n    TutorDialog.prototype.delete = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var closeDialog;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                closeDialog = this.props.closeDialog;\r\n                closeDialog();\r\n                this.props.deleteNoteData();\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    TutorDialog.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var closeDialog, comment;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                closeDialog = this.props.closeDialog;\r\n                comment = this.state.comment;\r\n                closeDialog();\r\n                this.props.updateData(comment);\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    TutorDialog.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, weekNumber = _a.weekNumber, intl = _a.intl;\r\n        var comment = this.state.comment;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"h2\", null, intl ? intl.formatMessage({ id: \"tutorNoteDialog.weekComment\", defaultMessage: \"Kommentar för vecka {weekNumber}\" }, { weekNumber: weekNumber }) : \"Kommentar f\\u00F6r vecka \" + weekNumber),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-table\" },\r\n                    React.createElement(\"div\", { className: \"fullWidth\" },\r\n                        React.createElement(\"textarea\", { autoFocus: true, value: comment, onChange: function (ev) { return _this.setState({ comment: ev.target.value }); } })))),\r\n            React.createElement(\"div\", null, React.createElement(React.Fragment, null,\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } },\r\n                    intl ? intl.formatMessage({ id: \"common.save\", defaultMessage: \"Spara\" }) : 'Spara',\r\n                    \" \"),\r\n                comment && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return _this.delete(); } }, intl ? intl.formatMessage({ id: \"common.remove\", defaultMessage: \"Ta bort\" }) : \"Ta bort\"))));\r\n    };\r\n    return TutorDialog;\r\n}(React.Component));\r\nexport { TutorDialog };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { getColumnsHeader, getColumnHeaderFromCourse, } from './termplanner-utils';\r\nimport moment from 'moment';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { KEDWeek } from '../../utils/weekutil';\r\nimport { getSchoolTranslatedSubjects } from '../../utils/generic-school-utils';\r\nvar ViewModel = /** @class */ (function () {\r\n    function ViewModel(dbWeekPlans, \r\n    //dbTutorNotes: TermPlannerTutorNote[],\r\n    courses, currentSchoolTerm, currentSchoolLocale, intl, showTutorCommentField) {\r\n        var _a, e_1, _b, e_2, _c;\r\n        var _this = this;\r\n        this.subjectProgress = {};\r\n        this.columns = [];\r\n        this.weekPlansOrTutorNote = [];\r\n        if (currentSchoolTerm.schoolMoment) {\r\n            var _d = tslib_1.__read(currentSchoolTerm.getTermStartAndEnd(), 2), termStart = _d[0], termEnd = _d[1];\r\n            this.year = termStart.year();\r\n            //init columns\r\n            var columnHeaders = getColumnsHeader(currentSchoolLocale);\r\n            columnHeaders.forEach(function (c) { return _this.columns.push({ name: c }); });\r\n            //define fixed columns - we keep these separated, in case that the other columns will be dynamically retrieved\r\n            var fixedColumns_1 = [{ name: \"Kurs\", isFixed: true }, { name: \"Kommentar\", isFixed: true }];\r\n            if (showTutorCommentField) {\r\n                fixedColumns_1.push({ name: \"TutorComment\", isFixed: true });\r\n            }\r\n            //Add fixed columns names\r\n            (_a = this.columns).push.apply(_a, tslib_1.__spread(fixedColumns_1));\r\n            //populate translations\r\n            var translatedColumns = getSchoolTranslatedSubjects(currentSchoolLocale, intl);\r\n            this.columns.forEach(function (element) {\r\n                element.translatedName = translatedColumns[element.name];\r\n            });\r\n            var currentTermHolidays = currentSchoolTerm.schoolMoment.academicYearStructure.holidays;\r\n            var currentTerm_1 = currentSchoolTerm.schoolMoment.term;\r\n            //\r\n            // weekPlans\r\n            //\r\n            var weekplanValues = dbWeekPlans.filter(function (x) { return !x.type; });\r\n            var tutorValues = dbWeekPlans.filter(function (w) { return w.type === 'tutor-note'; });\r\n            var startAcademicYearNumber = currentSchoolTerm.schoolMoment.academicYearStructure.academicStartWeek;\r\n            var _loop_1 = function (weekMoment) {\r\n                holidayPeriod = currentTermHolidays.filter(function (h) { return weekMoment.week() >= moment(h.startDate).startOf(\"week\").week() &&\r\n                    weekMoment.week() <= moment(h.endDate).endOf('week').week(); });\r\n                //if the current week is a holiday week, skip it\r\n                if (holidayPeriod.length > 0) {\r\n                    return \"continue\";\r\n                }\r\n                var weekNumber = weekMoment.week();\r\n                var kedWeek = KEDWeek(weekMoment.year(), weekNumber);\r\n                //A term can end and start on the same week for India\r\n                //in this case we should filter them by the term\r\n                //This is not the case for sv locale and we want to skip this check \r\n                //because data is already saved in the database\r\n                var weekPlan = weekplanValues.filter(function (wp) {\r\n                    return wp.dateTime >= kedWeek.notBefore &&\r\n                        wp.dateTime <= kedWeek.notAfter &&\r\n                        (!wp.isFinalStep &&\r\n                            wp.term === currentTerm_1 || intl.locale === \"sv\");\r\n                })[0];\r\n                var tutorNote = tutorValues.filter(function (wp) {\r\n                    return wp.dateTime >= kedWeek.notBefore &&\r\n                        wp.dateTime <= kedWeek.notAfter &&\r\n                        (wp.term === currentTerm_1 || intl.locale === \"sv\");\r\n                })[0];\r\n                this_1.weekPlansOrTutorNote.push(tslib_1.__assign({}, weekPlan || {}, { id: weekPlan ? weekPlan.id : createUUID(), dateTime: weekPlan ? weekPlan.dateTime : weekMoment.valueOf(), cellValues: weekPlan ? weekPlan.cellValues : {}, weekNumber: weekNumber, academicWeekNumber: startAcademicYearNumber++, term: currentTerm_1 }));\r\n                this_1.weekPlansOrTutorNote.push(tslib_1.__assign({}, tutorNote || {}, { id: tutorNote ? tutorNote.id : createUUID(), type: 'tutor-note', dateTime: tutorNote ? tutorNote.dateTime : weekMoment.valueOf(), content: tutorNote ? tutorNote.content : '', weekNumber: weekNumber, term: currentTerm_1 }));\r\n            };\r\n            var this_1 = this, holidayPeriod;\r\n            for (var weekMoment = termStart.clone(); weekMoment.valueOf() < termEnd.valueOf(); weekMoment = weekMoment.clone().add(1, 'week').startOf('week')) {\r\n                _loop_1(weekMoment);\r\n            }\r\n            //\r\n            // lastSteps\r\n            //\r\n            var lastStepWeek = currentSchoolTerm.getLastStepWeek(intl.locale);\r\n            var lastStepKedWeek_1 = KEDWeek(termEnd.year(), lastStepWeek);\r\n            this.lastSteps = weekplanValues.filter(function (wp) {\r\n                return wp.dateTime >= lastStepKedWeek_1.notBefore &&\r\n                    wp.dateTime <= lastStepKedWeek_1.notAfter &&\r\n                    (wp.isFinalStep &&\r\n                        wp.term === currentTerm_1 || intl.locale === \"sv\");\r\n            })[0] || {\r\n                id: createUUID(),\r\n                dateTime: moment(termEnd).clone().week(lastStepWeek).startOf('week').valueOf(),\r\n                cellValues: {},\r\n                weekNumber: lastStepWeek,\r\n                term: currentTerm_1,\r\n                isFinalStep: true\r\n            };\r\n            this.completedSteps = {};\r\n            this.termGoals = {};\r\n            var maxSubjectStep = {};\r\n            try {\r\n                for (var courses_1 = tslib_1.__values(courses), courses_1_1 = courses_1.next(); !courses_1_1.done; courses_1_1 = courses_1.next()) {\r\n                    var course = courses_1_1.value;\r\n                    var columnHeader = getColumnHeaderFromCourse(course);\r\n                    try {\r\n                        //\r\n                        // completedSteps\r\n                        //\r\n                        for (var _e = (e_2 = void 0, tslib_1.__values(course.courseSteps)), _f = _e.next(); !_f.done; _f = _e.next()) {\r\n                            var step = _f.value;\r\n                            if (step.isCompleted) {\r\n                                this.completedSteps[columnHeader + step.shortName] = true;\r\n                                //set the maximum value of the completed step for each subject\r\n                                var currentStepValue = parseInt(step.shortName);\r\n                                if (!isNaN(currentStepValue) && currentStepValue > (maxSubjectStep[columnHeader] ? maxSubjectStep[columnHeader] : 0)) {\r\n                                    maxSubjectStep[columnHeader] = currentStepValue;\r\n                                }\r\n                                /*const weekPlans = findWeekPlansByStep(this.weekPlans, step.ShortName);\r\n                                weekPlans.forEach(weekPlan => {\r\n                                    this.completedSteps[weekPlan.week + columnHeader] = true;\r\n                                })*/\r\n                            }\r\n                        }\r\n                    }\r\n                    catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (_f && !_f.done && (_c = _e.return)) _c.call(_e);\r\n                        }\r\n                        finally { if (e_2) throw e_2.error; }\r\n                    }\r\n                    //\r\n                    // termGoals\r\n                    //\r\n                    this.termGoals[columnHeader] = course.periodGoalGrade;\r\n                }\r\n            }\r\n            catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n            finally {\r\n                try {\r\n                    if (courses_1_1 && !courses_1_1.done && (_b = courses_1.return)) _b.call(courses_1);\r\n                }\r\n                finally { if (e_1) throw e_1.error; }\r\n            }\r\n            if (courses) {\r\n                //init\r\n                columnHeaders.forEach(function (elem) {\r\n                    _this.subjectProgress[elem] = { finalStepCompleted: false, value: 0 };\r\n                });\r\n                //compute charts by computing  completed goal (saved data from kedbackend is not taken into account)/lastStepValue\r\n                Object.keys(this.lastSteps.cellValues).forEach(function (val) {\r\n                    //exclude the fixed columns. Charts should not be displayed for those\r\n                    if (!fixedColumns_1[val]) {\r\n                        var hasNoFinalStepValue = isNaN(parseInt(_this.lastSteps.cellValues[val])) || !_this.lastSteps.cellValues[val];\r\n                        var finalStepValue = hasNoFinalStepValue ? 0 : parseInt(_this.lastSteps.cellValues[val]);\r\n                        var percenValue = finalStepValue > 0 ? maxSubjectStep[val] * 100 / finalStepValue : 0;\r\n                        _this.subjectProgress[val] = { finalStepCompleted: !hasNoFinalStepValue, value: percenValue };\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    }\r\n    return ViewModel;\r\n}());\r\nexport { ViewModel };\r\nfunction findWeekPlansByStep(weekPlans, step) {\r\n    return weekPlans.filter(function (wp) { return Object.keys(wp.cellValues).map(function (column) { return wp.cellValues[column] === step; }); });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../utils/utils';\r\nimport env from '../../globals/KED.env';\r\nvar LatestAssessments = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LatestAssessments, _super);\r\n    function LatestAssessments(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            assessments: [],\r\n            error: null,\r\n            loading: false\r\n        };\r\n        return _this;\r\n    }\r\n    LatestAssessments.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    LatestAssessments.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var assessments, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ loading: true });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 3, , 4]);\r\n                        return [4 /*yield*/, env.edsClient.getLatestAssessments(this.props.limit)];\r\n                    case 2:\r\n                        assessments = _a.sent();\r\n                        this.setState({ assessments: assessments });\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        error_1 = _a.sent();\r\n                        this.setState({ error: error_1 });\r\n                        return [3 /*break*/, 4];\r\n                    case 4:\r\n                        this.setState({ loading: false });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    LatestAssessments.prototype.render = function () {\r\n        var hasGrades = this.state.assessments.some(function (a) { return !!a.gradeName; });\r\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n            React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Senaste bed\\u00F6mningar\"], [\"Senaste bed\\u00F6mningar\"])))),\r\n            React.createElement(\"hr\", null),\r\n            React.createElement(\"ul\", { className: \"latest-assesments zebra\" }, this.state.assessments.map(function (a, i) {\r\n                return React.createElement(\"li\", { key: i },\r\n                    (hasGrades && a.gradeName != \"\") && React.createElement(\"span\", { className: \"grade pill pull-right\" }, a.gradeName),\r\n                    React.createElement(\"span\", { className: \"date pill pull-left\" }, a.publishDateTime.substr(0, 10)),\r\n                    a.courseName == a.courseUnitName ?\r\n                        React.createElement(\"h5\", null,\r\n                            React.createElement(\"strong\", null, a.courseName)) : React.createElement(\"h5\", null,\r\n                        React.createElement(\"strong\", null, a.courseName),\r\n                        \" / \",\r\n                        React.createElement(\"em\", null, a.courseUnitName)),\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(\"p\", null, a.text));\r\n            })));\r\n    };\r\n    return LatestAssessments;\r\n}(React.Component));\r\nexport { LatestAssessments };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { getLearningGoalsAndTasks } from '../../apis/ked-learninggoals';\r\nimport { LearningGoalsList } from '../course-viewer/subcomponents/learning-goals-list';\r\nimport { setupIntl } from '../utility-components/SetupLanguageIntl';\r\nimport { injectIntl } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar _LearningTasks = /** @class */ (function (_super) {\r\n    tslib_1.__extends(_LearningTasks, _super);\r\n    function _LearningTasks(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            data: null\r\n        };\r\n        return _this;\r\n    }\r\n    _LearningTasks.prototype.componentDidMount = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, getLearningGoalsAndTasks(this.props.apiPath, this.props.pageId)];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        this.setState({ data: data });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    _LearningTasks.prototype.render = function () {\r\n        if (!this.state.data)\r\n            return React.createElement(\"div\", null);\r\n        var _a = this.state.data, moduleName = _a.moduleName, subject = _a.subject, commonTasks = _a.commonTasks, learningGoals = _a.learningGoals, step = _a.step;\r\n        var intl = this.props.intl;\r\n        //const step = undefined; // moduleName.toLowerCase().startsWith(\"steg \") && parseInt(moduleName.substr(5));\r\n        var commonTasksList = commonTasks.map(function (task) { return ({\r\n            id: task.id,\r\n            name: task.name,\r\n            url: task.url,\r\n            courseName: subject.name,\r\n            learningGoal: step && learningGoals.length > 0 ? moduleName + \" - \\u00F6vergripande\" : moduleName\r\n        }); });\r\n        var learningGoalsList = learningGoals.map(function (learningGoal) { return ({\r\n            name: learningGoal.name,\r\n            learningTasks: learningGoal.tasks.map(function (task) { return ({\r\n                id: task.id,\r\n                name: task.name,\r\n                url: task.url,\r\n                courseName: subject.name,\r\n                learningGoal: learningGoal.name\r\n            }); })\r\n        }); });\r\n        if (step) {\r\n            commonTasksList.forEach(function (task) { return task.step = step; });\r\n            learningGoalsList.forEach(function (lg) { return lg.learningTasks.forEach(function (task) { return task.step = step; }); });\r\n        }\r\n        return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n            React.createElement(LearningGoalsList, { commonTasks: commonTasksList, learningGoals: learningGoalsList }));\r\n    };\r\n    return _LearningTasks;\r\n}(React.Component));\r\nexport var LearningTasks = setupIntl(injectIntl(_LearningTasks));\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport { showInfo, L } from \"../../utils/utils\";\r\nimport { Spinner } from \"../course-builder/sub-components/spinner\";\r\nimport { parseQueryString, generateQueryString } from \"../../utils/query-string\";\r\nimport { preserveImpersonationQuery } from '../../access-control/index';\r\nimport { hiddenCoursesRepo } from '../../repos/hidden-courses-repo';\r\nvar ListCourses = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ListCourses, _super);\r\n    function ListCourses(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isLoading: true,\r\n            courses: [],\r\n            headerOpen: false\r\n        };\r\n        _this.updateHiddenCourses = _this.updateHiddenCourses.bind(_this);\r\n        return _this;\r\n    }\r\n    ListCourses.prototype.componentWillMount = function () {\r\n        hiddenCoursesRepo.subscribe(this.updateHiddenCourses, { fullCourse: true });\r\n    };\r\n    ListCourses.prototype.componentWillUnmount = function () {\r\n        hiddenCoursesRepo.unsubscribe(this.updateHiddenCourses);\r\n    };\r\n    ListCourses.prototype.updateHiddenCourses = function (courses) {\r\n        this.setState({ courses: courses, isLoading: false });\r\n    };\r\n    ListCourses.prototype.hideCourse = function (course) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        showInfo(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Sparar...\"], [\"Sparar...\"]))));\r\n                        return [4 /*yield*/, hiddenCoursesRepo.hideCourse(course)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        showInfo(\"\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ListCourses.prototype.showCourse = function (course) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        showInfo(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Sparar...\"], [\"Sparar...\"]))));\r\n                        return [4 /*yield*/, hiddenCoursesRepo.showCourse(course)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        showInfo(\"\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ListCourses.prototype.render = function () {\r\n        var _this = this;\r\n        if (this.state.isLoading)\r\n            return React.createElement(Spinner, null);\r\n        var courses = this.state.courses;\r\n        var visibleCourses = courses.filter(function (course) { return course.visible; });\r\n        var hiddenCourses = courses.filter(function (course) { return !course.visible; });\r\n        var query = parseQueryString(location.search);\r\n        var viewCourseUrl = cfg.KED_COURSE_VIEWER_URL;\r\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n            React.createElement(\"h3\", null, \"Skolans kurser\"),\r\n            React.createElement(\"div\", { className: \"taskContainer odd-even\" }, visibleCourses.map(function (course) {\r\n                return React.createElement(\"div\", { className: \"studentCourse\", key: course.id },\r\n                    React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\r\n                            React.createElement(\"a\", { className: \"hideItem\", onClick: function () { return _this.hideCourse(course); } })),\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                            React.createElement(\"a\", { href: preserveImpersonationQuery(viewCourseUrl, { courseId: course.id }) }, course.name))),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"p\", { className: \"small\" }, course.description)));\r\n            })),\r\n            React.createElement(\"div\", { className: \"openClose\" + (this.state.headerOpen ? \" open\" : \"\") },\r\n                React.createElement(\"div\", { className: \"openHeader\", onClick: function () { return _this.setState({ headerOpen: !_this.state.headerOpen }); } },\r\n                    React.createElement(\"h5\", null, \"Dolda kurser\")),\r\n                React.createElement(\"div\", { className: \"openContent\" },\r\n                    React.createElement(\"div\", { className: \"taskContainer odd-even\" }, hiddenCourses.map(function (course) {\r\n                        return React.createElement(\"div\", { className: \"studentCourse\", key: course.id },\r\n                            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                                React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\r\n                                    React.createElement(\"a\", { className: \"showItem\", onClick: function () { return _this.showCourse(course); } })),\r\n                                React.createElement(\"a\", { href: generateQueryString(tslib_1.__assign({}, query, { courseId: course.id })) }, course.name)),\r\n                            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                React.createElement(\"p\", { className: \"small\" }, course.description)));\r\n                    })))));\r\n    };\r\n    return ListCourses;\r\n}(React.Component));\r\nexport { ListCourses };\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { hiddenCoursesRepo } from '../../repos/hidden-courses-repo';\r\nimport { preserveImpersonationQuery } from '../../access-control';\r\nvar MyCourses = /** @class */ (function (_super) {\r\n    tslib_1.__extends(MyCourses, _super);\r\n    function MyCourses(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            courses: [],\r\n            isLoading: true\r\n        };\r\n        _this.updateHiddenCoursesState = _this.updateHiddenCoursesState.bind(_this);\r\n        return _this;\r\n    }\r\n    MyCourses.prototype.componentDidMount = function () {\r\n        hiddenCoursesRepo.subscribe(this.updateHiddenCoursesState, { fullCourse: false });\r\n    };\r\n    MyCourses.prototype.updateHiddenCoursesState = function (courses) {\r\n        this.setState({ courses: courses, isLoading: false });\r\n    };\r\n    MyCourses.prototype.componentWillUnmount = function () {\r\n        hiddenCoursesRepo.unsubscribe(this.updateHiddenCoursesState);\r\n    };\r\n    MyCourses.prototype.getCourseUrl = function (courseId) {\r\n        return preserveImpersonationQuery(this.props.viewCourseUrl, { courseId: courseId });\r\n    };\r\n    MyCourses.prototype.render = function () {\r\n        var _this = this;\r\n        var viewCourseUrl = this.props.viewCourseUrl;\r\n        var _a = this.state, isLoading = _a.isLoading, error = _a.error, courses = _a.courses;\r\n        var visibleCourses = this.state.courses.filter(function (c) { return c.visible; });\r\n        return (React.createElement(React.Fragment, null, isLoading ? (React.createElement(\"li\", { className: \"lvl2 header\" },\r\n            React.createElement(\"a\", null, \"Laddar...\"))) : error ? (React.createElement(\"li\", { className: \"lv12\" },\r\n            React.createElement(\"a\", null, \"Kunde inte ladda kurser.\"))) : (visibleCourses.map(function (_a) {\r\n            var name = _a.name, id = _a.id;\r\n            return (React.createElement(\"li\", { key: id, className: \"lvl2\" },\r\n                React.createElement(\"a\", { href: _this.getCourseUrl(id) }, name)));\r\n        }))));\r\n    };\r\n    return MyCourses;\r\n}(React.Component));\r\nexport { MyCourses };\r\n","import { env } from \"../../globals/KED.env\";\r\nimport { db, globalId } from \"../../globals/db\";\r\nimport { preserveImpersonationQuery } from \"../../access-control\";\r\nimport * as React from \"react\";\r\nimport { cfg } from \"../../globals/KED.cfg\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nvar STATIC_COURSES = new Emitter([{\r\n        id: \"https://ks.kunskapsporten.se/steg/matematik.4.47f6b323168938151ef8161c.html\",\r\n        name: \"Matematik\",\r\n        type: \"step-course\",\r\n        tags: [\"static\"],\r\n    }]).toCollection(function (x) { return x; });\r\nexport function MySubjectsInner(_a) {\r\n    var user = env.currentUser;\r\n    var schoolGrade = user.schoolGrade;\r\n    var isPrimarySchoolStudent = (\"\" + user.schoolType).toLowerCase() !== \"gymnasium\";\r\n    var subjectPlannerURL = cfg.KED_SUBJECT_PLANNER_URL;\r\n    var schoolName = user.school;\r\n    if (!schoolGrade || !isPrimarySchoolStudent) {\r\n        return (React.createElement(\"li\", { className: \"lvl2 header\" },\r\n            React.createElement(\"a\", null, \"Listning endast f\\u00F6r grundskolan\")));\r\n    }\r\n    var _b = db.courseInstances\r\n        .hasEdgesFrom([globalId])\r\n        //.tags(\"active\") // Workaround: Multiple criterias disables the use of useSP\r\n        .cacheOptimized()\r\n        .filter(function (c) { return c.tags.includes(\"active\"); })\r\n        .map(function (_a) {\r\n        var id = _a.id, name = _a.name, type = _a.type, tags = _a.tags;\r\n        return ({\r\n            id: id,\r\n            name: name,\r\n            type: type,\r\n            tags: tags\r\n        });\r\n    })\r\n        .concat(STATIC_COURSES)\r\n        .orderBy(\"name\")\r\n        .groupBy(\"type\")\r\n        .map(function (arraysByType) { return ({\r\n        themeCourses: arraysByType[\"theme-course\"],\r\n        stepCourses: arraysByType[\"step-course\"]\r\n    }); }).read(), themeCourses = _b.themeCourses, stepCourses = _b.stepCourses;\r\n    return (React.createElement(React.Fragment, null,\r\n        React.createElement(\"li\", { className: \"lvl2 header\" },\r\n            React.createElement(\"a\", null, \"Stegkurser\")),\r\n        stepCourses.map(function (course) { return (React.createElement(\"li\", { key: course.id, className: \"lvl2\" },\r\n            React.createElement(\"a\", { href: preserveImpersonationQuery(course.tags.includes(\"static\") ?\r\n                    course.id :\r\n                    subjectPlannerURL + \"#/\" + schoolName + \"/courses/\" + course.id, {}) }, course.name))); }),\r\n        React.createElement(\"li\", { className: \"lvl2 header\" },\r\n            React.createElement(\"a\", null, \"Temakurser\")),\r\n        themeCourses\r\n            .filter(function (_a) {\r\n            var tags = _a.tags;\r\n            return tags.includes(\"grade:\" + schoolGrade);\r\n        })\r\n            .map(function (course) { return (React.createElement(\"li\", { key: course.id, className: \"lvl2\" },\r\n            React.createElement(\"a\", { href: preserveImpersonationQuery(course.tags.includes(\"static\") ?\r\n                    course.id :\r\n                    subjectPlannerURL + \"#/\" + schoolName + \"/courses/\" + course.id, {}) }, course.name))); })));\r\n}\r\n","import * as React from 'react';\r\nimport { EllipsisLoader } from '../course-builder/sub-components/ellipsis-loader';\r\nimport { Observe } from '../utility-components/observe';\r\nimport { MySubjectsInner } from './my-subjects-inner';\r\nexport function MySubjects(_a) {\r\n    var viewCourseUrl = _a.viewCourseUrl;\r\n    return (React.createElement(Observe, { fallback: React.createElement(EllipsisLoader, null) },\r\n        React.createElement(MySubjectsInner, { viewCourseUrl: viewCourseUrl })));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../../globals/KED.env';\r\nimport React from 'react';\r\nimport { compareProps } from '../../utils/utils';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport tutorEnv from '../../globals/KED.tutorEnv';\r\nimport { requestTutoredTokens } from '../../utils/request-tutored-tokens';\r\nvar TutorsSelect = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TutorsSelect, _super);\r\n    function TutorsSelect(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isLoading: true,\r\n            students: []\r\n        };\r\n        return _this;\r\n    }\r\n    TutorsSelect.prototype.componentDidMount = function () {\r\n        this.load();\r\n    };\r\n    TutorsSelect.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var edsStudents, students, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 3, 5, 6]);\r\n                        return [4 /*yield*/, env.edsClient.getTeacherTutorStudents()];\r\n                    case 1:\r\n                        edsStudents = _a.sent();\r\n                        edsStudents.sort(compareProps([\"lastName\", \"firstName\"]));\r\n                        students = edsStudents.length > 0 ?\r\n                            edsStudents.map(function (_a) {\r\n                                var email = _a.email, firstName = _a.firstName, lastName = _a.lastName;\r\n                                return ({\r\n                                    mail: email,\r\n                                    displayName: firstName + \" \" + lastName\r\n                                });\r\n                            }) :\r\n                            [env.currentUser];\r\n                        return [4 /*yield*/, this.setState({ students: students })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 3:\r\n                        error_1 = _a.sent();\r\n                        console.error(\"Could not list tutor students\", error_1);\r\n                        return [4 /*yield*/, this.setState({ students: [env.currentUser] })];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 5:\r\n                        this.setState({ isLoading: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TutorsSelect.prototype.onSelectUser = function (email) {\r\n        var choosenStudent = this.state.students.filter(function (s) { return s.mail === email; })[0];\r\n        var user = tslib_1.__assign({}, choosenStudent, { roles: [\"USER\"] });\r\n        tutorEnv.setNewEnv(user, function () { return requestTutoredTokens(email, email); });\r\n    };\r\n    TutorsSelect.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, isLoading = _a.isLoading, students = _a.students;\r\n        if (isLoading)\r\n            return React.createElement(Spinner, null);\r\n        return React.createElement(\"div\", { className: \"tutors-select\" },\r\n            React.createElement(\"select\", { onChange: function (ev) { return ev.target.value && _this.onSelectUser(ev.target.value); } },\r\n                React.createElement(\"option\", { value: \"\" }, \"V\\u00E4lj elev\"),\r\n                students.map(function (student) {\r\n                    return React.createElement(\"option\", { key: student.mail, value: student.mail },\r\n                        student.displayName,\r\n                        \" (\",\r\n                        student.mail,\r\n                        \")\");\r\n                })));\r\n    };\r\n    return TutorsSelect;\r\n}(React.Component));\r\nexport { TutorsSelect };\r\n","import * as React from 'react';\r\nexport var LanguageContext = React.createContext({ intl: null });\r\n","import * as tslib_1 from \"tslib\";\r\nimport { IntlProvider, addLocaleData } from 'react-intl';\r\nimport locale_en from 'react-intl/locale-data/en';\r\nimport locale_sv from 'react-intl/locale-data/sv';\r\nimport messages_sv from \"../../translations/sv.json\";\r\nimport messages_en from \"../../translations/en.json\";\r\nimport * as React from 'react';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport moment from 'moment';\r\nexport var setupIntl = function (Component) {\r\n    return /** @class */ (function (_super) {\r\n        tslib_1.__extends(_SetupLanguageIntl, _super);\r\n        function _SetupLanguageIntl(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            addLocaleData(tslib_1.__spread(locale_en, locale_sv));\r\n            _this.messages = {\r\n                'sv': messages_sv,\r\n                'en': messages_en\r\n            };\r\n            moment().locale(cfg.KED_LOCALE);\r\n            return _this;\r\n        }\r\n        _SetupLanguageIntl.prototype.render = function () {\r\n            return React.createElement(IntlProvider, { locale: cfg.KED_LOCALE, messages: this.messages[cfg.KED_LOCALE] },\r\n                React.createElement(Component, tslib_1.__assign({}, this.props)));\r\n        };\r\n        return _SetupLanguageIntl;\r\n    }(React.Component));\r\n};\r\n","import React from 'react';\r\nexport var UICheckbox = function (_a) {\r\n    var state = _a.state, label = _a.label, onChange = _a.onChange;\r\n    return React.createElement(\"label\", { className: 'ui-checkbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\nexport var UIAddbox = function (_a) {\r\n    var state = _a.state, label = _a.label, _b = _a.onChange, onChange = _b === void 0 ? function () { return null; } : _b;\r\n    return React.createElement(\"label\", { className: 'ui-addbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar ContentEditableField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ContentEditableField, _super);\r\n    function ContentEditableField(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.myself = React.createRef();\r\n        _this.state = {\r\n            text: props.text || ''\r\n        };\r\n        return _this;\r\n    }\r\n    ContentEditableField.prototype.render = function () {\r\n        var _a = this.props, tag = _a.tag, text = _a.text, readOnly = _a.readOnly;\r\n        var TagType = tag;\r\n        return React.createElement(TagType, { contentEditable: !readOnly, \"data-placeholder\": this.props.placeholder, ref: this.myself, className: this.props.className, onChange: this.onChange.bind(this), onKeyDown: this.onKeyDown.bind(this), onKeyUp: this.onKeyUp.bind(this), onBlur: this.onBlur.bind(this), onPaste: this.onPaste.bind(this), dangerouslySetInnerHTML: { __html: text } });\r\n    };\r\n    ContentEditableField.prototype.onChange = function (e) {\r\n        this.setState({ text: this.myself.current.innerText });\r\n    };\r\n    /**\r\n     * Take action depending on key-event\r\n     * @param e event from field\r\n     *\r\n     * If allowNavigation then listen to arrow-keys\r\n     * Limits to maxChars\r\n     */\r\n    ContentEditableField.prototype.onKeyDown = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        if (e.key === 'Escape') {\r\n            this.myself.current.innerText = this.props.text || \"\";\r\n            this.myself.current.blur();\r\n            e.stopPropagation();\r\n        }\r\n        else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            this.navigate(text, 'down');\r\n        }\r\n        else if (e.key === 'Tab') {\r\n            this.propagateOnChange(text);\r\n        }\r\n        else if (text.length >= this.props.maxChars && (/^[\\d\\w\\s]$/.test(e.key) && !(e.metaKey || e.ctrlKey))) {\r\n            e.preventDefault();\r\n        }\r\n        if (this.props.allowNavigation === true) {\r\n            var navDir = e.key.startsWith('Arrow') ? e.key.replace('Arrow', '').toLowerCase() : false;\r\n            var caret = document.getSelection().getRangeAt(0).endOffset; // only works for plaintext\r\n            if (navDir && text.length == 0) {\r\n                this.navigate(text, navDir);\r\n            }\r\n            else if (navDir && (navDir == 'up' || navDir == 'down')) {\r\n                this.navigate(text, navDir);\r\n            }\r\n            else if (navDir && ((navDir == 'left' && caret == 0) ||\r\n                (navDir == 'right' && caret == text.length))) {\r\n                this.navigate(text, navDir);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     *\r\n     * @param e event from field\r\n     * Solely used to hande validations-issues\r\n     */\r\n    ContentEditableField.prototype.onKeyUp = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        if (this.props.validateValue !== undefined && !this.props.validateValue.test(text)) {\r\n            this.myself.current.innerText = this.props.text || \"\";\r\n            this.myself.current.blur();\r\n            e.preventDefault();\r\n        }\r\n    };\r\n    /**\r\n     * Update value and pass to parents navigate-funciton\r\n     * @param text\r\n     * @param direction\r\n     */\r\n    ContentEditableField.prototype.navigate = function (text, direction) {\r\n        // first update cell\r\n        this.propagateOnChange(text);\r\n        this.setState({ text: text });\r\n        // then navigate away\r\n        this.props.onNavigate(direction);\r\n    };\r\n    /**\r\n     * Make sure pasted text is pure text\r\n     * @param e the paset event\r\n     */\r\n    ContentEditableField.prototype.onPaste = function (e) {\r\n        e.preventDefault();\r\n        var text = (e.clipboardData && e.clipboardData.getData) ? e.clipboardData.getData(\"text/plain\") : '';\r\n        document.execCommand(\"insertHTML\", false, text);\r\n    };\r\n    /**\r\n     * Update value on exit from field\r\n     * @param e\r\n     */\r\n    ContentEditableField.prototype.onBlur = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        this.propagateOnChange(text);\r\n        this.setState({ text: text });\r\n    };\r\n    /**\r\n     * Only update value if it has changed\r\n     * @param newValue\r\n     */\r\n    ContentEditableField.prototype.propagateOnChange = function (newValue) {\r\n        if (this.propagatedOnChange != newValue) {\r\n            this.propagatedOnChange = newValue;\r\n            this.props.onChange(newValue);\r\n        }\r\n    };\r\n    return ContentEditableField;\r\n}(React.PureComponent));\r\nexport { ContentEditableField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { RemoveItem } from '../course-builder/sub-components/remove-item';\r\nimport { findDOMNode } from 'react-dom';\r\nimport $ from 'jquery';\r\nvar Dialogs = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Dialogs, _super);\r\n    function Dialogs(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    Dialogs.prototype.componentDidUpdate = function (prevProps) {\r\n        if (this.lastDiv !== null && prevProps.dialogs.length > this.props.dialogs.length) {\r\n            // A dialog was closed. Now focus the last dialog:\r\n            $(findDOMNode(this.lastDiv)).find(':input').first().focus();\r\n        }\r\n    };\r\n    Dialogs.prototype.render = function () {\r\n        var _this = this;\r\n        this.lastDiv = null;\r\n        var _a = this.props, dialogs = _a.dialogs, popDialog = _a.popDialog;\r\n        $('body').attr('aria-disabled', dialogs.length > 0);\r\n        $('body').css('overflow', dialogs.length > 0 ? 'hidden' : 'auto');\r\n        return dialogs.length > 0 && React.createElement(\"div\", null, dialogs.map(function (dialog, idx) {\r\n            var div;\r\n            function onKeyPress(ev) {\r\n                if (ev.which === 13 && (!ev.target || ev.target.tagName !== 'TEXTAREA')) {\r\n                    $(findDOMNode(div)).find('.btn-default').click();\r\n                }\r\n                ev.stopPropagation();\r\n            }\r\n            function onKeyDown(ev) {\r\n                if (ev.which === 27) { // Escape\r\n                    popDialog();\r\n                    ev.stopPropagation();\r\n                    return;\r\n                }\r\n                if (ev.which === 83 && (ev.ctrlKey || ev.metaKey)) { // CTRL-S\r\n                    var domNode = findDOMNode(div);\r\n                    ev.preventDefault();\r\n                    var defaultButton = $(domNode).find('.btn-default');\r\n                    defaultButton.click();\r\n                    ev.stopPropagation();\r\n                }\r\n            }\r\n            return React.createElement(\"div\", { key: idx },\r\n                React.createElement(\"div\", { className: \"darken\" }),\r\n                React.createElement(\"div\", { className: \"modal-page-wrap\" },\r\n                    React.createElement(\"div\", { className: \"modal-page\", ref: function (elem) {\r\n                            div = elem;\r\n                            if (idx === dialogs.length - 1)\r\n                                _this.lastDiv = elem;\r\n                        }, tabIndex: 0, \"aria-disabled\": idx < dialogs.length - 1, onKeyPress: onKeyPress, onKeyDown: onKeyDown },\r\n                        dialog,\r\n                        React.createElement(RemoveItem, { onClick: popDialog }),\r\n                        React.createElement(\"div\", { className: \"stopFloats\" }))));\r\n        }));\r\n    };\r\n    return Dialogs;\r\n}(React.Component));\r\nexport { Dialogs };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextInput = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextInput, _super);\r\n    function TextInput(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextInput.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label },\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"text\", autoFocus: this.props.autoFocus, id: this.props.id, size: this.props.size || 35, value: this.props.value, onChange: this.props.onChange && (function (ev) { return _this.props.onChange(ev.target.value); }), disabled: this.props.disabled, placeholder: this.props.placeholder }))));\r\n    };\r\n    return TextInput;\r\n}(React.Component));\r\nexport { TextInput };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextAreaFormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextAreaFormField, _super);\r\n    function TextAreaFormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextAreaFormField.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label, id: this.props.id },\r\n            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"textarea\", { autoFocus: this.props.autoFocus, id: this.props.id, cols: 35, rows: this.props.rows || 5, value: this.props.value, onChange: function (ev) { return _this.props.onChange(ev.target.value); }, placeholder: this.props.placeholder })),\r\n                !!this.props.children && React.createElement(\"div\", { className: \"horizontalItem\" }, this.props.children))));\r\n    };\r\n    return TextAreaFormField;\r\n}(React.Component));\r\nexport { TextAreaFormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nfunction findId(node) {\r\n    var recucheck = new Set();\r\n    return (function findId(node) {\r\n        if (typeof node === 'string')\r\n            return null;\r\n        if (recucheck.has(node)) {\r\n            return;\r\n        }\r\n        recucheck.add(node);\r\n        if (node.props) {\r\n            if (node.props.id)\r\n                return node.props.id;\r\n            if (node.props.children) {\r\n                return findId(node.props.children);\r\n            }\r\n            return;\r\n        }\r\n        if (node.length) {\r\n            for (var i = 0; i < node.length; ++i) {\r\n                var child = node[i];\r\n                if (child) {\r\n                    var childId = findId(child);\r\n                    if (childId)\r\n                        return childId;\r\n                    //console.log(child);\r\n                }\r\n            }\r\n        }\r\n    })(node);\r\n}\r\nvar FormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(FormField, _super);\r\n    function FormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    FormField.prototype.render = function () {\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"label\", { className: \"kclabel\", htmlFor: this.props.id || findId(this.props.children) }, this.props.label),\r\n            this.props.children);\r\n    };\r\n    return FormField;\r\n}(React.Component));\r\nexport { FormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { FiberContext } from \"kedbackend/observable\";\r\nimport React, { Suspense } from 'react';\r\nimport { L } from '../../utils/utils';\r\nvar FiberContextReact = React.createContext(null);\r\nvar ReactSharedInternals = Object.keys(React).filter(function (key) { return key.includes(\"_INTERNALS\"); }).map(function (k) { return React[k]; })[0];\r\nvar ReactCurrentDispatcher = ReactSharedInternals.ReactCurrentDispatcher;\r\nFiberContext.addProvider(function () {\r\n    // Here we actuall do useContext(FiberContext) but without logging to internal debug logs\r\n    // Normally, react hooks are sensitive in which order they are called (useState(), etc)\r\n    // but useContext() is not sensitive about that at all.\r\n    // Still, the debug version of react will log calls to useHook() and throw if a render\r\n    // doesn't use the same number of hooks every time. This check should not apply\r\n    // to useHook() since it is not sensitive to the order in which it was called.\r\n    // And we need to be able to call it from within contitional expressions / statements,\r\n    // so we must bypass this debug logging here by accessing readContext() directly.\r\n    return ReactCurrentDispatcher.current && ReactCurrentDispatcher.current.readContext(FiberContextReact);\r\n});\r\nvar Observe = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Observe, _super);\r\n    function Observe(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.subscriptions = [];\r\n        _this.outerSubscription = {\r\n            unsubscribe: function () {\r\n                _this.subscriptions.forEach(function (s) { return s.unsubscribe(); });\r\n                _this.subscriptions = [];\r\n            }\r\n        };\r\n        _this.observer = function (value, error, subscription) {\r\n            if (error) {\r\n                _this.setState({ error: error });\r\n            }\r\n            else {\r\n                _this.setState(function (_a) {\r\n                    var counter = _a.counter;\r\n                    return ({ counter: counter + 1, error: error });\r\n                });\r\n            }\r\n        };\r\n        _this.state = {\r\n            counter: 0,\r\n            error: null\r\n        };\r\n        return _this;\r\n    }\r\n    Observe.prototype.componentDidCatch = function (error, info) {\r\n        if (!error || !error.name)\r\n            error = new Error('' + error);\r\n        this.setState({ error: error, info: info });\r\n        console.log(error, info);\r\n    };\r\n    Observe.prototype.componentWillMount = function () {\r\n        this.outerSubscription.unsubscribe();\r\n    };\r\n    Observe.prototype.render = function () {\r\n        if (this.state.error) {\r\n            return this.props.errorFallback || React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde inte ladda inneh\\u00E5llet\"], [\"Kunde inte ladda inneh\\u00E5llet\"]))));\r\n        }\r\n        this.outerSubscription.unsubscribe();\r\n        return React.createElement(Suspense, { fallback: this.props.fallback || null },\r\n            React.createElement(FiberContextReact.Provider, { value: this }, this.props.children));\r\n    };\r\n    return Observe;\r\n}(React.Component));\r\nexport { Observe };\r\nvar templateObject_1;\r\n","/* REFACTOR: Move this component outside coursebuilder!\r\n   This is a general-purpose component\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { GoalProgress } from '../charts/goal-progress';\r\nvar OpenCloseBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(OpenCloseBox, _super);\r\n    function OpenCloseBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    OpenCloseBox.prototype.componentWillReceiveProps = function (nextProps) {\r\n        if (nextProps.headerOpen !== this.props.headerOpen) {\r\n            this.setState({ headerOpen: nextProps.headerOpen });\r\n        }\r\n    };\r\n    OpenCloseBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, className = _a.className, children = _a.children, headerClassName = _a.headerClassName, contentClassName = _a.contentClassName, displayProgress = _a.displayProgress, progressData = _a.progressData, inactivated = _a.inactivated, inactivatedRender = _a.inactivatedRender;\r\n        var headerOpen = this.state.headerOpen;\r\n        if (inactivated)\r\n            return inactivatedRender === 'titleAndChildren' ? React.createElement(React.Fragment, null,\r\n                React.createElement(React.Fragment, null, title),\r\n                React.createElement(React.Fragment, null, children)) : React.createElement(React.Fragment, null, children);\r\n        //var currentProgressData = //progressData();\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\" + (headerClassName ? \" \" + headerClassName : \"\"), onClick: function () {\r\n                    if (_this.props.onOpenClose)\r\n                        _this.props.onOpenClose(!_this.state.headerOpen);\r\n                    _this.setState({ headerOpen: !_this.state.headerOpen });\r\n                } },\r\n                React.createElement(\"div\", { className: \"openHeaderContainer\" },\r\n                    React.createElement(\"div\", null, title),\r\n                    displayProgress && React.createElement(GoalProgress, tslib_1.__assign({}, progressData)))),\r\n            React.createElement(\"div\", { className: \"openContent\" + (contentClassName ? \" \" + contentClassName : \"\") }, children));\r\n    };\r\n    return OpenCloseBox;\r\n}(React.Component));\r\nexport { OpenCloseBox };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport currentUserEnv from '../../globals/KED.env';\r\nimport tutorEnv from '../../globals/KED.tutorEnv';\r\nvar TutorableComponent = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TutorableComponent, _super);\r\n    function TutorableComponent(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.onEnvUpdated = _this.onEnvUpdated.bind(_this);\r\n        _this.state = {\r\n            env: props.tutored ? null : currentUserEnv\r\n        };\r\n        return _this;\r\n    }\r\n    TutorableComponent.prototype.componentDidMount = function () {\r\n        if (this.props.tutored) {\r\n            tutorEnv.subscribe(this.onEnvUpdated);\r\n        }\r\n    };\r\n    TutorableComponent.prototype.componentWillUnmount = function () {\r\n        if (this.props.tutored) {\r\n            tutorEnv.unsubscribe(this.onEnvUpdated);\r\n        }\r\n    };\r\n    TutorableComponent.prototype.onEnvUpdated = function (env) {\r\n        this.setState({ env: env });\r\n    };\r\n    TutorableComponent.prototype.render = function () {\r\n        var env = this.state.env;\r\n        if (!env)\r\n            return React.createElement(\"div\", null);\r\n        if (!env.kedBackendClient) {\r\n            return React.createElement(\"div\", null, \"Laddar...\");\r\n        }\r\n        //const {currentUser, edsClient, kedBackendClient, kgTermPlannerRepo} = env;\r\n        //const {tutored} = this.props;\r\n        return this.props.createComponent(env);\r\n    };\r\n    return TutorableComponent;\r\n}(React.Component));\r\nexport { TutorableComponent };\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>F</b>',\r\n        title: 'Fetstil',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>K</i>',\r\n        title: 'Kursiv',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Understruken',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Struken',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Rubrik 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Rubrik 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Rubrik 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraf',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Citat',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '<i class=\"fa fa-list-ol\" aria-hidden=\"true\"></i>',\r\n        title: 'Ordnad lista',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '<i class=\"fa fa-list\" aria-hidden=\"true\"></i>',\r\n        title: 'Punktlista',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Minska indrag',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'Öka indrag',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Programkod',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Vågrät linje',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '<i class=\"fa fa-link\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga länk',\r\n        result: function () {\r\n            var url = window.prompt('Ange länkens URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '<i class=\"fa fa-picture-o\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga bild',\r\n        promptMsg: 'Ange bildens URL',\r\n        result: function (ev, component) {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url) {\r\n                //exec('insertImage', url);\r\n                var img = document.createElement(\"img\");\r\n                img.src = url;\r\n                img.tabIndex = 1;\r\n                insertElement(img);\r\n                img.onfocus = component.onFocus;\r\n                img.onblur = component.onBlur;\r\n                component.props.onChange(component.contentDiv.innerHTML);\r\n            }\r\n        }\r\n    }\r\n};\r\nfunction insertElement(element) {\r\n    var sel, range;\r\n    if (window.getSelection && (sel = window.getSelection()).rangeCount) {\r\n        range = sel.getRangeAt(0);\r\n        range.collapse(true);\r\n        range.insertNode(element);\r\n        // Move the caret immediately after the inserted span\r\n        range.setStartAfter(element);\r\n        range.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(range);\r\n    }\r\n}\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>B</b>',\r\n        title: 'Bold',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>I</i>',\r\n        title: 'Italic',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Underline',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Strike-through',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Heading 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Heading 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Heading 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraph',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Quote',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '&#35;',\r\n        title: 'Ordered List',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '&#8226;',\r\n        title: 'Unordered List',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Outdent',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'Indent',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Code',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Horizontal Line',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '&#128279;',\r\n        title: 'Link',\r\n        result: function () {\r\n            var url = window.prompt('Enter the link URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '&#128247;',\r\n        title: 'Image',\r\n        promptMsg: 'Enter the URL of the image',\r\n        result: function () {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url)\r\n                exec('insertImage', url);\r\n        }\r\n    }\r\n};\r\n","export default (function (command, value) {\r\n    if (value === void 0) { value = null; }\r\n    document.execCommand(command, false, value);\r\n});\r\n","export function patchElement(element) {\r\n    var modified = false;\r\n    if (element.tagName === \"A\") {\r\n        var href = element.getAttribute(\"href\");\r\n        var target = element.getAttribute(\"target\");\r\n        if (href) {\r\n            if (href.startsWith(\"javascript:\")) {\r\n                // Fix \"javascript:window.open('...')\" URLS\r\n                var url = href;\r\n                var windowOpen = \"window.open('\";\r\n                var pWindowOpen = url.indexOf(windowOpen);\r\n                if (pWindowOpen >= 0) {\r\n                    var urlEnd = url.substr(pWindowOpen + windowOpen.length);\r\n                    var pUrlEnd = urlEnd.indexOf(\"'\");\r\n                    if (pUrlEnd >= 0) {\r\n                        var newUrl = urlEnd.substr(0, pUrlEnd);\r\n                        element.setAttribute(\"href\", newUrl);\r\n                        element.setAttribute(\"target\", \"_blank\"); // The reason they use JS links is for opening in new tab\r\n                        modified = true;\r\n                    }\r\n                }\r\n            }\r\n            else if (href.startsWith(\"https://\") || href.startsWith(\"http://\")) {\r\n                try {\r\n                    var url = new URL(href);\r\n                    // Fix digilär URLs:\r\n                    if (url.host === \"xn--digilr-fua.se\") {\r\n                        if (url.search[0] === '?') {\r\n                            var pSecondQ = url.search.indexOf('?', 1);\r\n                            if (pSecondQ > 0) {\r\n                                url.search = url.search.substr(0, pSecondQ) + \"&\" + url.search.substr(pSecondQ + 1);\r\n                                element.setAttribute(\"href\", url.href);\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                    // Fix so that external URLS are opened in separate tabs\r\n                    if (location.hostname !== 'localhost') {\r\n                        if (url.host !== location.host) {\r\n                            if (!element.getAttribute(\"target\")) {\r\n                                element.setAttribute(\"target\", \"_blank\");\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                catch (error) {\r\n                    element.removeAttribute(\"a\");\r\n                    modified = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n","export default function imageEditActions(cb) {\r\n    return [{\r\n            name: 'float-left',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-right\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; left:-4px;top:0; transform: scale(0.5); transform-origin: left top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Låt bilden flyta vänster om text',\r\n            result: function () { return cb('float-left'); }\r\n        }, {\r\n            name: 'float-right',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-left\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; right:-4px;top:0; transform: scale(0.5); transform-origin: right top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Låt bilden flyta höger om text',\r\n            result: function () { return cb('float-right'); }\r\n        }, {\r\n            name: 'unfloat',\r\n            icon: \"<div style=\\\"position:relative;\\\" aria-hidden=\\\"true\\\">\\n      <div style=\\\"position:absolute;top:0;left:0\\\">&#8254;</div>\\n      <div style=\\\"position:absolute;top:0:left:0;transform: scale(0.5); transform-origin: left bottom\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n      <div style=\\\"position:absolute;top:0;left:0\\\">_</div>\\n    </div>\",\r\n            title: 'Placera bilden på egen rad',\r\n            result: function () { return cb('unfloat'); }\r\n        }];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport exec from './exec';\r\nimport { washHtml } from './wash-html';\r\nimport imageEditActions from './image-edit-actions';\r\nimport actions from './actions';\r\nvar classes = {\r\n    actionbar: 'wysiwyg-actionbar',\r\n    button: 'wysiwyg-button',\r\n    content: 'wysiwyg-content',\r\n    focusrect: 'wysiwyg-focusrect',\r\n    focuspoint: 'wysiwyg-focuspoint',\r\n    readonlyContent: 'wysiwyg-content readonly'\r\n};\r\nvar Wysiwyg = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Wysiwyg, _super);\r\n    function Wysiwyg(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { focusRect: null };\r\n        _this.onFocus = _this.onFocus.bind(_this);\r\n        _this.onBlur = _this.onBlur.bind(_this);\r\n        _this.onMouseDown = _this.onMouseDown.bind(_this);\r\n        _this.onMouseMove = _this.onMouseMove.bind(_this);\r\n        _this.onMouseUp = _this.onMouseUp.bind(_this);\r\n        return _this;\r\n    }\r\n    Wysiwyg.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        if (!this.props.readOnly) {\r\n            Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n                .forEach(function (elem) {\r\n                elem.tabIndex = 1;\r\n                elem.onfocus = _this.onFocus;\r\n                elem.onblur = _this.onBlur;\r\n            });\r\n        }\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.componentDidUpdate = function () {\r\n        var _this = this;\r\n        Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n            .forEach(function (elem) {\r\n            elem.tabIndex = 1;\r\n            elem.onfocus = _this.onFocus;\r\n            elem.onblur = _this.onBlur;\r\n        });\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.shouldComponentUpdate = function (nextProps, nextState) {\r\n        //this.contentDiv.onfocus = this.onFocus;\r\n        //this.contentDiv.onblur = this.onBlur;\r\n        return !this.contentDiv ||\r\n            nextState != this.state ||\r\n            nextProps.readOnly !== this.props.readOnly ||\r\n            washHtml(nextProps.html) !== washHtml(this.contentDiv.innerHTML);\r\n    };\r\n    Wysiwyg.prototype.triggerOnChange = function (html) {\r\n        this.props.onChange && this.props.onChange(washHtml(html));\r\n    };\r\n    Wysiwyg.prototype.onFocus = function (ev) {\r\n        var elem = ev.target;\r\n        if (!elem || !elem.tagName)\r\n            return;\r\n        if (elem.tagName !== 'IMG' && elem.tagName !== 'A')\r\n            return;\r\n        var contentParent = this.contentDiv.parentElement;\r\n        var newState = {\r\n            focusRect: getRelatativeClientRect(contentParent, elem),\r\n        };\r\n        switch (elem.tagName) {\r\n            case 'A':\r\n            case 'IMG':\r\n            default: break;\r\n        }\r\n        this.setState(newState);\r\n        this.focusElem = elem;\r\n    };\r\n    Wysiwyg.prototype.onBlur = function (ev) {\r\n        /*if (ev.relatedTarget) {\r\n          const relatedTarget = ev.relatedTarget as HTMLElement;\r\n          if (relatedTarget.className && relatedTarget.className.split(' ').indexOf(classes.button) >= 0) {\r\n            // A image action button was pressed\r\n            set\r\n            return;\r\n          }\r\n        }*/\r\n        if ((ev.target === this.focusElem && ev.relatedTarget !== this.focusRectDiv) ||\r\n            ev.target === this.focusRectDiv) {\r\n            this.setState({ focusRect: null });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.makeClickable = function (elem) {\r\n        elem.tabIndex = 1;\r\n    };\r\n    Wysiwyg.prototype.onMouseDown = function (ev) {\r\n        if ((ev.target.className || \"\").split(' ').indexOf(classes.focuspoint) >= 0) {\r\n            var corner = this.getRectCorner(ev);\r\n            this.corner = corner;\r\n            this.resizeStartX = ev.clientX;\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseMove = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            ev.preventDefault();\r\n            // TODO: Räkna ut baserat på this.corner hur bildens storlek borde ändras.\r\n            // Leta upp bilden per ID från this.contentDiv\r\n            // Sätt DIV:ens style attribut width till ny width.\r\n            // Om DIV:en redan hade height, sätt ny height med samma aspect ratio som innan,\r\n            // annars, sätt inte height alls (eller möjligtvis till auto))\r\n            var focusRect = this.focusRectDiv.getBoundingClientRect();\r\n            if (focusRect.width < 32)\r\n                return;\r\n            //const currentWidth = focusRect.width;\r\n            //const currentHeight = focusRect.height;\r\n            //const hasHeightStyle = !this.focusElem.style.height || this.focusElem.style.height === \"auto\";\r\n            var newWidth = Math.max(32, this.corner.endsWith('l') ?\r\n                focusRect.width + (this.resizeStartX - ev.clientX) :\r\n                //focusRect.right - ev.clientX :\r\n                focusRect.width - (this.resizeStartX - ev.clientX));\r\n            this.resizeStartX = ev.clientX;\r\n            //ev.clientX - focusRect.left;\r\n            var factor = newWidth / focusRect.width;\r\n            var newHeight = focusRect.height * factor;\r\n            this.focusElem.style.width = newWidth + \"px\";\r\n            this.focusElem.style.height = newHeight + \"px\";\r\n            this.setState({\r\n                focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem),\r\n            });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseUp = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            this.corner = null;\r\n            this.triggerOnChange(this.contentDiv.innerHTML);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.getRectCorner = function (ev) {\r\n        var e_1, _a;\r\n        try {\r\n            for (var _b = tslib_1.__values((ev.target.className || '').split(' ')), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var className = _c.value;\r\n                switch (className) {\r\n                    case 'fpul':\r\n                        return 'ul';\r\n                    case 'fpur':\r\n                        return 'fpur';\r\n                    case 'fplr':\r\n                        return 'lr';\r\n                    case 'fpll':\r\n                        return 'll';\r\n                }\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n        return null;\r\n    };\r\n    Wysiwyg.prototype.execImageEditAction = function (cmd) {\r\n        //console.log(cmd);\r\n        if (!this.focusElem)\r\n            return;\r\n        //console.log(\"doing it\");\r\n        switch (cmd) {\r\n            case 'float-left':\r\n                this.focusElem.style.cssFloat = 'left';\r\n                break;\r\n            case 'float-right':\r\n                this.focusElem.style.cssFloat = 'right';\r\n                break;\r\n            case 'unfloat':\r\n                this.focusElem.style.cssFloat = '';\r\n                break;\r\n        }\r\n        this.triggerOnChange(this.contentDiv.innerHTML);\r\n        this.setState({ focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem) });\r\n    };\r\n    Wysiwyg.prototype.render = function () {\r\n        var _this = this;\r\n        var defaultActions = this.props.defaultActions || actions;\r\n        var actionsToUse = this.props.actions ? this.props.actions.map(function (action) {\r\n            return typeof action === 'string' ?\r\n                defaultActions[action] :\r\n                defaultActions[action.name] ? tslib_1.__assign({}, defaultActions[action.name], action) :\r\n                    action;\r\n        })\r\n            : Object.keys(defaultActions).map(function (action) { return defaultActions[action]; });\r\n        if (this.state.focusRect) {\r\n            actionsToUse = actionsToUse.concat(imageEditActions(function (cmd) { return _this.execImageEditAction(cmd); }));\r\n        }\r\n        var focusRect = this.state.focusRect;\r\n        var _a = this.props, readOnly = _a.readOnly, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\r\n        return React.createElement(\"div\", { className: this.props.className },\r\n            !readOnly && React.createElement(\"div\", { className: classes.actionbar }, actionsToUse.map(function (action, idx) {\r\n                return React.createElement(\"button\", { key: idx, className: classes.button, dangerouslySetInnerHTML: { __html: action.icon }, title: action.title, onMouseDown: function (ev) { action.result(ev, _this); }, onMouseUp: function (ev) { return setTimeout(function () { return _this.contentDiv.focus(); }, 10); } });\r\n            })),\r\n            React.createElement(\"div\", { className: readOnly ? classes.readonlyContent : classes.content, style: { position: 'relative', top: 0, left: 0 }, onMouseMove: this.onMouseMove, onMouseDown: this.onMouseDown, onMouseUp: this.onMouseUp },\r\n                React.createElement(\"div\", { className: \"editor\", ref: function (div) { return _this.contentDiv = div; }, dangerouslySetInnerHTML: { __html: washHtml(this.props.html) }, contentEditable: !readOnly, onPaste: function (ev) {\r\n                        if (!isNaN(maxChars)) {\r\n                            var target = ev.target, currentTarget = ev.currentTarget;\r\n                            //const textBeingOverwritten = (target as any).innerText || \"\";\r\n                            var editorText = (currentTarget && currentTarget.innerText) || \"\";\r\n                            var textBeingPasted = ev.clipboardData.getData(\"text/plain\") || \"\";\r\n                            if (editorText.length + textBeingPasted.length > maxChars) {\r\n                                ev.preventDefault();\r\n                            }\r\n                        }\r\n                    }, onKeyUp: reportNumChars ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        reportNumChars(innerText ? innerText.length : 0);\r\n                    } : null, onKeyPress: !isNaN(maxChars) ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        if (innerText && innerText.length >= maxChars) {\r\n                            ev.preventDefault();\r\n                        }\r\n                    } : null, onInput: function (ev) { return _this.triggerOnChange(ev.target.innerHTML); }, onKeyDown: function (ev) {\r\n                        if (readOnly)\r\n                            return;\r\n                        if (reportNumChars && ev.currentTarget) {\r\n                            reportNumChars((ev.currentTarget.innerText || \"\").length);\r\n                        }\r\n                        //console.log(\"Key: \" + ev.which);\r\n                        if (ev.which >= 35 && ev.which <= 40) { // home/end/up/down/left/right\r\n                            ev.stopPropagation(); // Prevent entire page from scrolling??\r\n                        }\r\n                        if (ev.which === 9) {\r\n                            ev.preventDefault(); // TAB\r\n                            if (ev.shiftKey) {\r\n                                exec(\"outdent\");\r\n                            }\r\n                            else {\r\n                                exec(\"indent\");\r\n                            }\r\n                        }\r\n                        if ((ev.keyCode === 8 || ev.keyCode === 46) && // Delete or Back buttons\r\n                            _this.focusElem && _this.state.focusRect) {\r\n                            if (_this.focusElem && _this.focusElem.parentElement) {\r\n                                _this.focusElem.parentElement.removeChild(_this.focusElem); // Remove marked image\r\n                            }\r\n                            _this.focusElem = null;\r\n                            _this.setState({ focusRect: null });\r\n                            _this.triggerOnChange(_this.contentDiv.innerHTML);\r\n                        }\r\n                    } }),\r\n                focusRect && React.createElement(\"div\", { ref: function (div) { return _this.focusRectDiv = div; }, className: classes.focusrect, onBlur: this.onBlur, tabIndex: 1, style: {\r\n                        outline: 0,\r\n                        position: 'absolute',\r\n                        top: this.state.focusRect.top,\r\n                        left: this.state.focusRect.left,\r\n                        width: this.state.focusRect.width,\r\n                        height: this.state.focusRect.height\r\n                    } },\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpul\", style: { position: 'absolute', top: 0, left: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpur\", style: { position: 'absolute', top: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fplr\", style: { position: 'absolute', bottom: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpll\", style: { position: 'absolute', bottom: 0, left: 0 } }))));\r\n    };\r\n    return Wysiwyg;\r\n}(React.Component));\r\nexport { Wysiwyg };\r\nfunction getRelatativeClientRect(parent, child) {\r\n    var parentRect = parent.getBoundingClientRect();\r\n    var childRect = child.getBoundingClientRect();\r\n    return {\r\n        top: childRect.top - parentRect.top + parent.scrollTop,\r\n        left: childRect.left - parentRect.left + parent.scrollLeft,\r\n        bottom: childRect.bottom - parentRect.top + parent.scrollTop,\r\n        right: childRect.right - parentRect.left + parent.scrollLeft,\r\n        width: childRect.width,\r\n        height: childRect.height\r\n    };\r\n}\r\n","import { patchElement } from './html-patch-policy';\r\nvar parser = new DOMParser();\r\n/** Tags / Attributes Whitelist\r\n *\r\n */\r\nvar HTML_WASH_POLICY = {\r\n    b: {},\r\n    i: {},\r\n    p: {},\r\n    u: {},\r\n    strike: {},\r\n    pre: {},\r\n    h1: {},\r\n    h2: {},\r\n    h3: {},\r\n    h4: {},\r\n    h5: {},\r\n    img: { src: true, class: true, style: true, tabindex: true },\r\n    a: { href: true, target: true, tabindex: true },\r\n    ul: {},\r\n    ol: {},\r\n    li: {},\r\n    hr: {},\r\n    br: {},\r\n    div: {},\r\n    span: {},\r\n    // table tags:\r\n    table: { border: true },\r\n    tbody: {},\r\n    thead: {},\r\n    tfoot: {},\r\n    tr: {},\r\n    td: { headers: true, colspan: true, rowspan: true },\r\n    th: { abbr: true, headers: true, scope: true, sorted: true, colspan: true, rowspan: true }\r\n};\r\nexport function washHtml(html) {\r\n    var doc = parser.parseFromString(html, \"text/html\");\r\n    var childNodes = doc.body.childNodes;\r\n    var modified = false;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified ?\r\n        doc.body.innerHTML :\r\n        html; // By returning the original HTML string, we spare the user from refreshing the edit area,\r\n    // which would otherwise put the cursor at the top, losing the position where user where.\r\n}\r\nfunction washNode(node) {\r\n    var modified = false;\r\n    if (isElement(node)) {\r\n        if (washElement(node)) {\r\n            modified = true;\r\n        }\r\n    }\r\n    if (washChildNodes(node)) {\r\n        modified = true;\r\n    }\r\n    return modified;\r\n}\r\nfunction washChildNodes(node) {\r\n    var modified = false;\r\n    var childNodes = node.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n/** Replace an element with its child nodes.\r\n *\r\n */\r\nfunction removeMiddleElement(element) {\r\n    var childNodes = element.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        element.parentNode.insertBefore(childNodes.item(i), element);\r\n    }\r\n    element.remove();\r\n}\r\nfunction washElement(element) {\r\n    var modified = patchElement(element);\r\n    var policy = element.tagName && HTML_WASH_POLICY[element.tagName.toLowerCase()];\r\n    if (!policy) {\r\n        console.warn(\"Wysiwyg: not allowed tag\", element.tagName);\r\n        washChildNodes(element);\r\n        removeMiddleElement(element);\r\n        return true;\r\n    }\r\n    for (var i = 0; i < element.attributes.length; ++i) {\r\n        var attr = element.attributes.item(i);\r\n        var allowed = attr.name && !!policy[attr.name.toLowerCase()];\r\n        if (!allowed) {\r\n            modified = true;\r\n            console.warn(\"Wysiwyg: not allowed attribute\", attr.name, \"Tag: \", element.tagName);\r\n            element.removeAttribute(attr.name);\r\n        }\r\n    }\r\n    return modified;\r\n}\r\nfunction isElement(node) {\r\n    return !!node.tagName;\r\n}\r\n","export * from './week-notebook';\r\nexport * from './root-week-notebook';\r\n","import * as React from 'react';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { WeekNotebook } from '.';\r\nexport function RootWeekNotebook(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(WeekNotebook, null));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { weekNotesRepo } from '../../repos/week-notes-repo';\r\nimport { PendingJob } from '../../utils/pending-job';\r\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\r\nimport env from '../../globals/KED.env';\r\nimport { Wysiwyg } from '../utility-components/wysiwyg';\r\nimport actions_swedish from '../utility-components/wysiwyg/actions-sv';\r\nimport actions_en from '../utility-components/wysiwyg/actions';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { ifTakesTime } from '../../utils/if-takes-time';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar MAX_NOTE_LENGTH = 16384;\r\nvar WeekNotebook = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekNotebook, _super);\r\n    function WeekNotebook(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.onChange = _this.onChange.bind(_this);\r\n        _this.autoSaver = new PendingJob(function () { return _this.save(); });\r\n        _this.state = {\r\n            isLoading: true,\r\n            showLoadingProgress: false,\r\n            showSavingProgress: false,\r\n            everEdited: false,\r\n            notes: \"\",\r\n        };\r\n        return _this;\r\n    }\r\n    WeekNotebook.prototype.componentDidMount = function () {\r\n        this.showProgressIfLoadingTakesTime();\r\n        weekNotesRepo.mem.subscribe(this.onChange);\r\n    };\r\n    WeekNotebook.prototype.showProgressIfLoadingTakesTime = function () {\r\n        var _this = this;\r\n        this.timeoutHandle = setTimeout(function () { return _this.state.isLoading && _this.setState({ showLoadingProgress: true }); }, 300);\r\n    };\r\n    WeekNotebook.prototype.componentWillUnmount = function () {\r\n        weekNotesRepo.mem.unsubscribe(this.onChange);\r\n        this.autoSaver.stop();\r\n        clearTimeout(this.timeoutHandle);\r\n    };\r\n    WeekNotebook.prototype._save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var maxIterations;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        maxIterations = 3;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(this.isNotesEdited() && maxIterations)) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, weekNotesRepo.upsert(this.state.weekNote, function (wn) {\r\n                                wn.content = _this.state.notes;\r\n                            })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        --maxIterations;\r\n                        return [3 /*break*/, 1];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekNotebook.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var err_1;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(!this.state.showSavingProgress && !this.state.isLoading && this.isNotesEdited())) return [3 /*break*/, 8];\r\n                        return [4 /*yield*/, this.setState({ error: undefined })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        _a.trys.push([2, 4, 6, 8]);\r\n                        return [4 /*yield*/, ifTakesTime(300, function () { return _this._save(); }, function () { return _this.setState({ showSavingProgress: true }); })];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 8];\r\n                    case 4:\r\n                        err_1 = _a.sent();\r\n                        console.error(err_1);\r\n                        return [4 /*yield*/, this.setState({ error: this.context.intl.formatMessage({ id: \"common.errorSavingData\", defaultMessage: \"Kunde inte spara.\" }) })];\r\n                    case 5:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 8];\r\n                    case 6: return [4 /*yield*/, this.setState({ showSavingProgress: false })];\r\n                    case 7:\r\n                        _a.sent();\r\n                        return [7 /*endfinally*/];\r\n                    case 8: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekNotebook.prototype.isNotesEdited = function () {\r\n        var _a = this.state, weekNote = _a.weekNote, notes = _a.notes;\r\n        return !!weekNote && (notes !== weekNote.content);\r\n    };\r\n    //If the notebook should be used in multiple modules, move this functions into an utility file\r\n    WeekNotebook.prototype.getTranslatedActions = function (intl) {\r\n        //actions might have different icons for each language\r\n        //we keep the same structure of the actions, but we replace the texts with the ones from the translated files\r\n        var localeActions = Object.assign({}, intl.locale === \"sv\" ? actions_swedish : actions_en);\r\n        Object.keys(localeActions).forEach(function (elem) {\r\n            var currentTitle = actions_swedish[elem].title;\r\n            localeActions[elem].title = intl.formatMessage({ id: \"wysiwyg.\" + elem, defaultMessage: currentTitle });\r\n            //because the image action needs a custom translation, we treat this separately\r\n            if (elem === \"image\") {\r\n                localeActions[elem].promptMsg = intl.formatMessage({ id: \"wysiwyg.imagePromptMsg\", defaultMessage: actions_swedish[elem].promptMsg });\r\n            }\r\n        });\r\n        return localeActions;\r\n    };\r\n    WeekNotebook.prototype.onChange = function (weekNotes) {\r\n        var weekNote = weekNotes.length > 0 ?\r\n            weekNotes[weekNotes.length - 1] :\r\n            {\r\n                id: createUUID(),\r\n                dateTime: Date.now(),\r\n                //dateTime: weekNotesRepo.getCurrentWeek().toDate().getTime(),\r\n                content: \"\",\r\n                acl: [\r\n                    // Default ACL: Let user self have full control over this item:\r\n                    new DocumentAccess(\"email\", env.currentUser.mail, \"S\")\r\n                ].map(function (ac) { return ac.toString(); })\r\n            };\r\n        var newState = {\r\n            weekNote: weekNote,\r\n            //week: weekNotesRepo.getCurrentWeek().week(),\r\n            isLoading: false,\r\n            showLoadingProgress: false\r\n        };\r\n        if (!this.state.weekNote || this.state.weekNote.id !== weekNote.id || weekNotes.length === 0) {\r\n            newState.notes = weekNote.content;\r\n        }\r\n        this.setState(newState);\r\n    };\r\n    /*async changeWeek(direction: number) {\r\n      try {\r\n        await this.setState({\r\n          isLoading: true,\r\n          everEdited: false,\r\n          weekNote: null,\r\n          error: undefined\r\n        });\r\n        this.showProgressIfLoadingTakesTime();\r\n        await weekNotesRepo.changeWeek(direction);\r\n      } catch (err) {\r\n        console.error(err);\r\n        await this.setState({error: \"Kunde inte ladda data\"});\r\n      }\r\n    }\r\n  \r\n    prevWeek() {\r\n      this.changeWeek(-1);\r\n    }\r\n  \r\n    nextWeek() {\r\n      this.changeWeek(1);\r\n    }*/\r\n    WeekNotebook.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, notes = _a.notes, showLoadingProgress = _a.showLoadingProgress, isLoading = _a.isLoading, showSavingProgress = _a.showSavingProgress, error = _a.error, everEdited = _a.everEdited;\r\n        var intl = this.context.intl;\r\n        return (React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"ked_boxed kedNotepad\" },\r\n                React.createElement(\"h3\", null,\r\n                    React.createElement(FormattedMessage, { id: \"weekNotebook.title\", defaultMessage: \"Anteckningar\" })),\r\n                React.createElement(Wysiwyg, { actions: [\r\n                        \"bold\",\r\n                        \"italic\",\r\n                        \"underline\",\r\n                        \"strikethrough\",\r\n                        \"olist\",\r\n                        \"ulist\",\r\n                        \"outdent\",\r\n                        \"indent\",\r\n                        \"line\"\r\n                    ], defaultActions: this.getTranslatedActions(intl), html: isLoading ? \"<div></div>\" : notes.substr(0, MAX_NOTE_LENGTH), onChange: !isLoading && (function (html) {\r\n                        _this.setState({\r\n                            notes: html.substr(0, MAX_NOTE_LENGTH),\r\n                            everEdited: true\r\n                        });\r\n                        _this.autoSaver.triggerChange(500);\r\n                    }) }),\r\n                React.createElement(\"hr\", null),\r\n                error ?\r\n                    React.createElement(\"p\", { className: \"error\" }, error) :\r\n                    showLoadingProgress ?\r\n                        React.createElement(\"span\", null,\r\n                            React.createElement(FormattedMessage, { id: \"common.loading\", defaultMessage: \"Laddar...\" }),\r\n                            React.createElement(Spinner, null)) :\r\n                        showSavingProgress ? React.createElement(React.Fragment, null,\r\n                            React.createElement(\"span\", null,\r\n                                React.createElement(FormattedMessage, { id: \"common.saving\", defaultMessage: \"Sparar...\" }),\r\n                                \" \\u00A0 \"),\r\n                            React.createElement(Spinner, null)) :\r\n                            this.isNotesEdited() ?\r\n                                React.createElement(React.Fragment, null, \"\\u00A0\") :\r\n                                everEdited ?\r\n                                    React.createElement(FormattedMessage, { id: \"common.saved\", defaultMessage: \"Sparad\" }) :\r\n                                    React.createElement(React.Fragment, null, \"\\u00A0\"))));\r\n    };\r\n    WeekNotebook.contextType = LanguageContext;\r\n    return WeekNotebook;\r\n}(React.Component));\r\nexport { WeekNotebook };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { env } from '../../globals/KED.env';\r\nvar AddCustomGoal = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddCustomGoal, _super);\r\n    function AddCustomGoal(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            learningGoal: props.learningGoal || ''\r\n        };\r\n        return _this;\r\n    }\r\n    AddCustomGoal.prototype.render = function () {\r\n        var _this = this;\r\n        var learningGoal = this.state.learningGoal;\r\n        var onSave = this.props.onSave;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till rubrik\" }) :\r\n                    React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget l\\u00E4randem\\u00E5l\" })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchool\", defaultMessage: \"Rubrik\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchool\", defaultMessage: \"M\\u00E5l\" })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, autoFocus: true, value: learningGoal, onChange: function (e) { return _this.setState({ learningGoal: e.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(learningGoal); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"save\" }))));\r\n    };\r\n    return AddCustomGoal;\r\n}(React.Component));\r\nexport { AddCustomGoal };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { env } from '../../globals/KED.env';\r\nvar AddCustomTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddCustomTask, _super);\r\n    function AddCustomTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            name: '',\r\n            description: '',\r\n            url: ''\r\n        };\r\n        return _this;\r\n    }\r\n    AddCustomTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        var _b = this.props, isTask = _b.isTask, onSave = _b.onSave;\r\n        var intl = this.context.intl;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till uppgift\" }) :\r\n                    React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget arbetsm\\u00E5l\" })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.nameLabel', defaultMessage: 'Namn' }), id: \"AddCustomTask:name\", placeholder: intl.formatMessage({ id: 'customTask.enterNamePlhd', defaultMessage: 'Ange namn...' }), value: name, autoFocus: true, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n                React.createElement(TextAreaFormField, { rows: 7, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddCustomTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: \"Lägg till en beskrivning...\" }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Länk' }), id: \"AddCustomTask:url\", placeholder: \"http://www...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(name, description, url); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\r\n    };\r\n    AddCustomTask.contextType = LanguageContext;\r\n    return AddCustomTask;\r\n}(React.Component));\r\nexport { AddCustomTask };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar AddOrEditSubTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddOrEditSubTask, _super);\r\n    function AddOrEditSubTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        if (props.mode === 'edit') {\r\n            var subTask = props.subTask;\r\n            _this.state = {\r\n                name: subTask.name || '',\r\n                description: subTask.description || '',\r\n                url: subTask.url || ''\r\n            };\r\n        }\r\n        else {\r\n            _this.state = {\r\n                name: '',\r\n                description: '',\r\n                url: ''\r\n            };\r\n        }\r\n        return _this;\r\n    }\r\n    AddOrEditSubTask.prototype.save = function () {\r\n        // Update repo:\r\n        var props = this.props;\r\n        var userTask = props.userTask, closeDialog = props.closeDialog, userTasksRepo = props.userTasksRepo;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        if (props.mode === 'edit') {\r\n            // Edit existing:\r\n            userTasksRepo.update([userTask], function (ut) {\r\n                var subTasks = ut.subTasks;\r\n                if (subTasks) {\r\n                    ut.subTasks = subTasks.map(function (st) {\r\n                        return st.id === props.subTask.id ? tslib_1.__assign({}, st, { name: name, description: description, url: url }) : tslib_1.__assign({}, st);\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            // Create new task\r\n            var newSubTask_1 = {\r\n                id: createUUID(),\r\n                name: name,\r\n                description: description,\r\n                url: url\r\n            };\r\n            // Update repo:\r\n            userTasksRepo.update([userTask], function (ut) {\r\n                if (!ut.subTasks) {\r\n                    ut.subTasks = [];\r\n                }\r\n                ut.subTasks = ut.subTasks.concat(newSubTask_1);\r\n            });\r\n        }\r\n        // Close dialog\r\n        closeDialog();\r\n    };\r\n    AddOrEditSubTask.prototype.delete = function () {\r\n        // Update repo:\r\n        var props = this.props;\r\n        if (props.mode !== 'edit') {\r\n            throw new Error(\"Can only delete in edit mode\");\r\n        }\r\n        props.userTasksRepo.update([props.userTask], function (ut) {\r\n            if (ut.subTasks) {\r\n                ut.subTasks = ut.subTasks.filter(function (t) { return t.id !== props.subTask.id; });\r\n            }\r\n        });\r\n        // Close dialog:\r\n        props.closeDialog();\r\n    };\r\n    AddOrEditSubTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        var props = this.props;\r\n        var isEditMode = props.mode === 'edit';\r\n        var intl = this.context.intl;\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isEditMode ? React.createElement(FormattedMessage, { id: \"addeditsubtask.editSubtask\", defaultMessage: 'Redigera underuppgift' }) : React.createElement(FormattedMessage, { id: \"addeditsubtask.addSubtask\", defaultMessage: 'L\\u00E4gg till underuppgift' })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(TextInput, { autoFocus: true, label: intl.formatMessage({ id: 'addeditsubtask.nameLabel', defaultMessage: 'Underuppgiftens namn' }), id: \"AddUserSubTask:name\", placeholder: \"\", value: this.state.name, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n                React.createElement(TextAreaFormField, { label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddUserSubTask:description\", rows: 7, placeholder: \"\", value: this.state.description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Länk' }), id: \"AddUserSubTask:url\", placeholder: \"\", value: this.state.url, onChange: function (url) { return _this.setState({ url: url }); } }),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                props.mode === 'edit' && React.createElement(\"button\", { className: \"btn btn-warning btn-large pull-right\", onClick: function (ev) { return _this.delete(); } },\r\n                    React.createElement(FormattedMessage, { id: \"addeditsubtask.deleteSubtask\", defaultMessage: \"Ta bort underuppgift\" })),\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\r\n    };\r\n    AddOrEditSubTask.contextType = LanguageContext;\r\n    return AddOrEditSubTask;\r\n}(React.Component));\r\nexport { AddOrEditSubTask };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { getTaskType } from './get-task-type';\r\nimport ReactDatePicker from 'react-datepicker';\r\nimport '../../globals/moment-sv-locale';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport moment from 'moment';\r\nimport { FormField } from '../utility-components/form-field';\r\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from \"../utility-components/LanguageContext\";\r\nvar EditUserTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditUserTask, _super);\r\n    function EditUserTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTask: props.userTask,\r\n            name: props.userTask.name,\r\n            description: props.userTask.description,\r\n            url: props.userTask.url,\r\n            deadline: props.userTask.deadline,\r\n            subTasks: props.userTask.subTasks\r\n        };\r\n        _this.onUserTasksChanged = _this.onUserTasksChanged.bind(_this);\r\n        return _this;\r\n    }\r\n    EditUserTask.prototype.componentDidMount = function () {\r\n        this.props.userTasksRepo.subscribe(this.onUserTasksChanged);\r\n    };\r\n    EditUserTask.prototype.onUserTasksChanged = function (userTasks) {\r\n        var _this = this;\r\n        var myUserTask = userTasks.find(function (ut) { return ut.id === _this.props.userTask.id; });\r\n        if (!myUserTask) {\r\n            this.props.closeDialog();\r\n            return;\r\n        }\r\n        this.setState({\r\n            userTask: myUserTask,\r\n            subTasks: myUserTask.subTasks\r\n        });\r\n    };\r\n    EditUserTask.prototype.componentWillUnmount = function () {\r\n        this.props.userTasksRepo.unsubscribe(this.onUserTasksChanged);\r\n    };\r\n    EditUserTask.prototype.isModified = function () {\r\n        // Don't count subtask changes! They live their own life and is maintained\r\n        // in add-or-edit-sub-task.tsx. Reason: User would expect added /edited subtasks\r\n        // to be persisted right away. May click away this dialog.\r\n        // Also reason: Can invoke that dialog by itself from other components. From WeekPlanner\r\n        // when clicking the subtask for example!\r\n        var _a = this.state, deadline = _a.deadline, description = _a.description, name = _a.name, url = _a.url, userTask = _a.userTask;\r\n        return (deadline !== userTask.deadline ||\r\n            description !== userTask.description ||\r\n            name !== userTask.name ||\r\n            url !== userTask.url);\r\n    };\r\n    EditUserTask.prototype.addSubTask = function () {\r\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"add\", userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\r\n    };\r\n    EditUserTask.prototype.editSubTask = function (subTask) {\r\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"edit\", subTask: subTask, userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\r\n    };\r\n    EditUserTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url, deadline = _a.deadline, subTasks = _a.subTasks, showCalendar = _a.showCalendar, userTask = _a.userTask;\r\n        var id = userTask.id, courseName = userTask.courseName;\r\n        var _b = this.props, onUpdate = _b.onUpdate, onDelete = _b.onDelete;\r\n        var isModified = this.isModified();\r\n        var taskType = getTaskType(userTask);\r\n        var isCustomTask = taskType === 'customTask';\r\n        var expired = moment(userTask.deadline) < moment();\r\n        var intl = this.context.intl;\r\n        return React.createElement(\"div\", { className: \"editTaskDialog sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n            React.createElement(\"h2\", null, isCustomTask ?\r\n                React.createElement(FormattedMessage, { id: \"task.editWorkGoals\", defaultMessage: 'Redigera arbetsm\\u00E5l' }) :\r\n                React.createElement(FormattedMessage, { id: \"task.editTask\", defaultMessage: 'Redigera uppgift' })),\r\n            React.createElement(\"hr\", null),\r\n            React.createElement(TextInput, { autoFocus: true, label: isCustomTask ? intl.formatMessage({ id: 'task.targetNameLabel', defaultMessage: 'Arbetsmålets namn' }) : intl.formatMessage({ id: 'task.taskNameLabel', defaultMessage: 'Uppgiftens namn' }), id: \"EditUserTask:name\", placeholder: isCustomTask ? intl.formatMessage({ id: 'task.whatShouldYouDoPlhd', defaultMessage: 'Vad ska du göra?' }) : intl.formatMessage({ id: 'task.enterTaskNamePlhd', defaultMessage: 'Ange uppgiftens namn...' }), value: name, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n            isCustomTask && React.createElement(React.Fragment, null,\r\n                React.createElement(TextAreaFormField, { rows: 5, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"EditUserTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: 'Lägg till en beskrivning...' }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: \"Länk\" }), id: \"EdutUserTask:url\", placeholder: \"http(s)://...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\r\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.setDeadline', defaultMessage: 'Ange deadline' }) }, (deadline || showCalendar) ?\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(ReactDatePicker, { ref: function (elem) { return _this.datePicker = elem; }, id: \"EditUserTask:deadline\", nextMonthButtonLabel: \"\", previousMonthButtonLabel: \"\", showWeekNumbers: true, selected: deadline && moment(deadline).toDate(), autoFocus: showCalendar, dateFormat: \"yyyy-MM-dd\", className: expired ? \"expired\" : undefined, locale: intl.locale, popperPlacement: isCustomTask ? \"top-start\" : \"bottom-start\", onBlur: function () { return _this.setState({ showCalendar: false }); }, onChange: function (value) {\r\n                                _this.setState({\r\n                                    deadline: value && moment(value).format(\"YYYY-MM-DD\"),\r\n                                    showCalendar: false\r\n                                });\r\n                            } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { className: \"deleteDate\", href: \"#\", title: intl.formatMessage({ id: 'task.removeDeadline', defaultMessage: 'Ta bort deadline' }), onClick: function (ev) {\r\n                                ev.preventDefault();\r\n                                _this.setState({ deadline: null, showCalendar: false });\r\n                            } }))) :\r\n                React.createElement(\"div\", { className: \"top\", ref: function () { _this.datePicker = null; } },\r\n                    React.createElement(\"a\", { className: \"btn\", onClick: function (ev) {\r\n                            if (_this.datePicker) {\r\n                                _this.datePicker.setOpen(true);\r\n                            }\r\n                            _this.setState({\r\n                                showCalendar: true\r\n                            });\r\n                        } },\r\n                        React.createElement(\"i\", { className: \"fa fa-calendar\", \"aria-hidden\": \"true\" }),\r\n                        React.createElement(FormattedMessage, { id: \"task.setDeadlineLabel\", defaultMessage: \"Ange deadline...\" })))),\r\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.subTasks', defaultMessage: 'Underuppgifter' }) },\r\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\r\n                    React.createElement(\"div\", { className: \"taskContainer\" }, subTasks && subTasks.map(function (subTask) { return React.createElement(\"div\", { key: subTask.id, className: \"align-horizontal\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                            React.createElement(\"a\", { onClick: function () { return _this.editSubTask(subTask); }, href: \"#\" }, subTask.name))); }))),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"top\" },\r\n                        React.createElement(\"button\", { id: \"EditUserTask:addSubTask\", className: \"btn\", onClick: function () { return _this.addSubTask(); } },\r\n                            React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                            \" \",\r\n                            React.createElement(FormattedMessage, { id: \"task.addSubtask\", defaultMessage: \"L\\u00E4gg till underuppgift\" }))))),\r\n            React.createElement(\"div\", { className: \"divider large\" }),\r\n            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-default\", onClick: function () {\r\n                            isModified ? onUpdate(function (userTask) {\r\n                                userTask.name = name;\r\n                                userTask.description = description;\r\n                                userTask.url = url;\r\n                                userTask.deadline = deadline;\r\n                            }) : _this.props.closeDialog();\r\n                        } },\r\n                        React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))),\r\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn\", onClick: function () {\r\n                            _this.props.closeDialog();\r\n                        } },\r\n                        React.createElement(FormattedMessage, { id: \"common.cancel\", defaultMessage: \"Avbryt\" }))),\r\n                React.createElement(\"div\", { className: \"confirm top pull-right\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-warning\", onClick: function () {\r\n                            onDelete(id);\r\n                        } }, isCustomTask ?\r\n                        React.createElement(FormattedMessage, { id: \"task.removeWorkGoals\", defaultMessage: \"Ta bort arbetsm\\u00E5l\" }) :\r\n                        React.createElement(FormattedMessage, { id: \"task.removeThisTask\", defaultMessage: \"Ta bort den h\\u00E4r uppgiften\" })))));\r\n    };\r\n    EditUserTask.contextType = LanguageContext;\r\n    return EditUserTask;\r\n}(React.Component));\r\nexport { EditUserTask };\r\n","export function getTaskType(userTask) {\r\n    return userTask.course && userTask.task && userTask.course.length > 0 && userTask.task.length > 0 ?\r\n        'courseBuilderTask' :\r\n        userTask.siteVisionPageId ?\r\n            'siteVisionTask' :\r\n            userTask.courseInfo ?\r\n                'subjectPlannerTask' :\r\n                'customTask';\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { arrayToLookup, compareProp } from \"../../utils/utils\";\r\nexport function refine(tasks) {\r\n    var e_1, _a, e_2, _b;\r\n    var result = [];\r\n    var mapper = {};\r\n    var tasksPerCourse = arrayToLookup(tasks, function (t) { return t.courseName || ''; });\r\n    try {\r\n        for (var _c = tslib_1.__values(Object.keys(tasksPerCourse).sort().filter(function (x) { return x; }).concat(tasksPerCourse[''] ?\r\n            [''] : [])), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n            var courseName = _d.value;\r\n            var courseTasks = tasksPerCourse[courseName] || tasksPerCourse[''];\r\n            var tasksPerLearningGoal = arrayToLookup(courseTasks, function (t) { return t.learningGoal; });\r\n            var resultLearningGoals = [];\r\n            try {\r\n                for (var _e = (e_2 = void 0, tslib_1.__values(Object.keys(tasksPerLearningGoal))), _f = _e.next(); !_f.done; _f = _e.next()) {\r\n                    var learningGoal = _f.value;\r\n                    var lgTasks = tasksPerLearningGoal[learningGoal].sort(compareProp(\"dateTime\"));\r\n                    var learningGoalTask = lgTasks\r\n                        .filter(function (t) { return t.name == null; }) // If name is undefined or null, this represents a learning goal\r\n                    [0];\r\n                    var url = learningGoalTask && learningGoalTask.url;\r\n                    resultLearningGoals.push({\r\n                        name: learningGoal,\r\n                        allTasks: lgTasks,\r\n                        url: url,\r\n                        step: lgTasks.map(function (t) { return t.step; }).filter(function (step) { return step; })[0],\r\n                        tasks: lgTasks.filter(function (t) { return t.name; })\r\n                    });\r\n                }\r\n            }\r\n            catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n            finally {\r\n                try {\r\n                    if (_f && !_f.done && (_b = _e.return)) _b.call(_e);\r\n                }\r\n                finally { if (e_2) throw e_2.error; }\r\n            }\r\n            result.push({\r\n                courseName: courseName,\r\n                learningGoals: resultLearningGoals\r\n            });\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from '../utility-components/open-close-box';\r\nimport { preserveImpersonationQuery } from '../../access-control';\r\nimport { courseNameToCssClass } from '../calendar/course-name-to-css-class';\r\nimport { getTaskType } from './get-task-type';\r\nimport moment from 'moment';\r\nimport { Features } from '../../features';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { env } from '../../globals/KED.env';\r\n;\r\nvar UserTasksBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UserTasksBox, _super);\r\n    function UserTasksBox(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    UserTasksBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, courseName = _a.courseName, learningGoals = _a.learningGoals, progressData = _a.progressData, displayProgress = _a.displayProgress;\r\n        var isOpen = !!this.props.openCourses[courseName];\r\n        var features = new Features();\r\n        var intl = this.context.intl;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null, courseName || (isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"userTasks.gymnasiumSchoolGoals\", defaultMessage: \"\\u00D6vriga uppgifter\" }) : React.createElement(FormattedMessage, { id: \"userTasks.primarySchoolGoals\", defaultMessage: \"Egna l\\u00E4randem\\u00E5l\" }))), headerOpen: isOpen, className: courseName && courseNameToCssClass('wp-course-', courseName), onOpenClose: function (becameOpen) { return _this.props.setIsOpen(courseName, becameOpen); }, displayProgress: displayProgress, progressData: progressData }, learningGoals.map(function (lg) {\r\n            return React.createElement(\"div\", { key: lg.name, className: \"learningGoalContainer\" },\r\n                lg.step && React.createElement(\"div\", { className: \"stepIndicator\" }, lg.step),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"learningGoalText horizontalItem top\" }, lg.name),\r\n                    React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                        \"\\u00A0\",\r\n                        React.createElement(\"a\", { className: \"trash\", href: \"#\", title: intl.formatMessage({ id: 'userTasks.deleteLearningGoal', defaultMessage: 'Ta bort lärandemålet och dess uppgifter' }), onClick: function (ev) {\r\n                                ev.preventDefault();\r\n                                _this.props.removeLearningGoal(lg);\r\n                            } },\r\n                            React.createElement(\"i\", { className: \"fa fa-trash\" })))),\r\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\r\n                    React.createElement(\"div\", { className: \"taskContainer\" }, lg.tasks.map(function (userTask) {\r\n                        var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting' || userTask.$meta === 'updating';\r\n                        var taskType = getTaskType(userTask);\r\n                        var expired = moment(userTask.deadline).startOf('day') < moment().startOf('day');\r\n                        return React.createElement(\"div\", { key: userTask.id, style: isWorking ? { opacity: 0.5 } : {} },\r\n                            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                    React.createElement(\"div\", { className: \"checkBox\" + (userTask.done ? \" checked\" : \"\"), onClick: function (ev) { return !isWorking && _this.props.setTaskDone(userTask, !userTask.done); } })),\r\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                    taskType === 'courseBuilderTask' ?\r\n                                        React.createElement(\"a\", { href: getTaskUrl(userTask, _this.props.viewCourseUrl) }, userTask.name) :\r\n                                        taskType === 'subjectPlannerTask' ?\r\n                                            React.createElement(\"a\", { href: getSubjectPlannerTaskUrl(userTask) }, userTask.name) :\r\n                                            taskType === 'siteVisionTask' ?\r\n                                                React.createElement(\"a\", { href: userTask.url }, userTask.name) :\r\n                                                React.createElement(\"a\", { className: !userTask.url ? \"link-less\" : \"\", href: userTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\r\n                                                        \"_self\" :\r\n                                                        \"_blank\" }, userTask.name),\r\n                                    userTask.deadline && React.createElement(\"div\", { className: \"dateSet\" + (expired ? ' expired' : '') },\r\n                                        React.createElement(\"i\", { title: moment(userTask.deadline).format(\"YYYY-MM-DD\"), className: \"fa fa-calendar\", \"aria-hidden\": \"true\", onClick: function () { } }))),\r\n                                React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\r\n                                    React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editTask(userTask); } }))),\r\n                            userTask.subTasks && React.createElement(\"div\", { className: \"subtasks\" }, userTask.subTasks.map(function (subTask) {\r\n                                return React.createElement(\"div\", { key: subTask.id },\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                        React.createElement(\"div\", { className: \"checkBox\" + (subTask.done ? \" checked\" : \"\"), onClick: function (ev) {\r\n                                                return !isWorking &&\r\n                                                    _this.props.setSubTaskDone(userTask, subTask, !subTask.done);\r\n                                            } })),\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                        React.createElement(\"a\", { href: subTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\r\n                                                \"_self\" :\r\n                                                \"_blank\", className: subTask.url ?\r\n                                                undefined :\r\n                                                'link-less' }, subTask.name)),\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\r\n                                        React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editSubTask(userTask, subTask); } })));\r\n                            })));\r\n                    }))),\r\n                React.createElement(\"div\", { className: \"learningGoalTools\" },\r\n                    React.createElement(\"div\", { className: \"btn addOwnGoal\", onClick: function () { return _this.props.addOwnTask(_this.props.courseName, lg.name); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                        \" \",\r\n                        isGymnasiumStudent ?\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) :\r\n                            React.createElement(FormattedMessage, { id: 'userTasks.addLearningGoal', defaultMessage: 'Eget arbetsm\\u00E5l' }))),\r\n                React.createElement(\"br\", null));\r\n        }));\r\n    };\r\n    UserTasksBox.contextType = LanguageContext;\r\n    return UserTasksBox;\r\n}(React.Component));\r\nexport { UserTasksBox };\r\nfunction getTaskUrl(userTask, viewCourseUrl) {\r\n    if (userTask.course && userTask.course.length > 0 && userTask.task && userTask.task.length > 0) {\r\n        var courseUrl = preserveImpersonationQuery(viewCourseUrl, { courseId: userTask.course[0].id });\r\n        return courseUrl + \"#/task/\" + userTask.task[0].id;\r\n    }\r\n    return userTask.url;\r\n}\r\nfunction getSubjectPlannerTaskUrl(userTask) {\r\n    if (userTask.courseInfo && userTask.task && userTask.task.length > 0) {\r\n        var _a = userTask.courseInfo, school = _a.school, course = _a.course, tab = _a.tab;\r\n        var courseUrl = preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL, {});\r\n        return courseUrl + \"#/\" + school + \"/courses/\" + course + \"/tabs/\" + tab + \"/tasks/\" + userTask.task[0].id;\r\n    }\r\n    return userTask.url;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nimport { localMoment } from '../../globals/moment-sv-locale';\r\nvar WeekPlannerPersistedState = /** @class */ (function () {\r\n    function WeekPlannerPersistedState(userOrCopy) {\r\n        if (typeof userOrCopy === 'string') {\r\n            this.user = userOrCopy;\r\n            this.lastWrite = Date.now();\r\n            this.weekDate = localMoment().startOf('week').valueOf();\r\n            this.openCourses = {};\r\n        }\r\n        else {\r\n            Object.assign(this, userOrCopy);\r\n        }\r\n    }\r\n    WeekPlannerPersistedState.load = function (user) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var cookie, storedData, state;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                cookie = localStorage.getItem('WeekPlannerPersistedState2');\r\n                storedData = cookie && JSON.parse(cookie);\r\n                state = new WeekPlannerPersistedState(user);\r\n                if (storedData)\r\n                    Object.assign(state, storedData);\r\n                return [2 /*return*/, state.user === user && !state.isExpired(moment()) ?\r\n                        state : new WeekPlannerPersistedState(user)];\r\n            });\r\n        });\r\n    };\r\n    WeekPlannerPersistedState.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var json;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.lastWrite = Date.now();\r\n                json = JSON.stringify(this);\r\n                localStorage.setItem('WeekPlannerPersistedState2', json);\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    WeekPlannerPersistedState.prototype.isExpired = function (asOf) {\r\n        return moment(this.lastWrite)\r\n            .isBefore(asOf.add(0 - WeekPlannerPersistedState.EXPIRATION_HOURS, 'hours'));\r\n    };\r\n    WeekPlannerPersistedState.EXPIRATION_HOURS = 12;\r\n    WeekPlannerPersistedState.VERSION = 2;\r\n    return WeekPlannerPersistedState;\r\n}());\r\nexport { WeekPlannerPersistedState };\r\n","import * as React from 'react';\r\nimport { WeekPlanner } from './weekplanner';\r\nimport env from '../../globals/KED.env';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport '../../repos/user-tasks-repo';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nexport function WeekPlannerSelf(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(WeekPlanner, { env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL }));\r\n}\r\n","import * as React from 'react';\r\nimport { WeekPlanner } from './weekplanner';\r\nimport { TutorableComponent } from '../utility-components/tutorable-component';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport cfg from '../../globals/KED.cfg';\r\nexport function WeekPlannerTutored(props) {\r\n    var intl = props.intl;\r\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\r\n                return React.createElement(WeekPlanner, { key: env.currentUser.mail, env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL });\r\n            } }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { UserTasksBox } from './user-tasks-box';\r\nimport { createUUID } from \"kedbackend/client\";\r\nimport { refine } from './refiner';\r\nimport { env } from '../../globals/KED.env';\r\nimport { compareProp } from '../../utils/utils';\r\nimport moment from 'moment';\r\nimport { Dialogs } from '../utility-components/dialogs';\r\nimport { AddCustomGoal } from './add-custom-goal';\r\nimport { AddCustomTask } from './add-custom-task';\r\nimport { EditUserTask } from './edit-user-task';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { OpenCloseBox } from '../utility-components/open-close-box';\r\nimport { PendingJob } from '../../utils/pending-job';\r\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\r\nimport { getAdjustedWeek, KEDWeek, getNextWeekDate, getPrevWeekDate } from '../../utils/weekutil';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { Progress } from '../charts/progress';\r\nimport { getWeekplannerProgressData } from '../charts/charts-utils';\r\nimport { features } from '../../features';\r\nvar MAX_STRATEGY_LENGTH = 16384;\r\nvar MAX_ASSESSMENT_LENGTH = 16384;\r\nvar WeekPlanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekPlanner, _super);\r\n    function WeekPlanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTasks: [],\r\n            weekDate: Date.now(),\r\n            openCourses: {},\r\n            dialogs: [],\r\n            saving: false,\r\n            weekTextsUT: null,\r\n            isLoading: true,\r\n            isCopyingTasks: false\r\n        };\r\n        _this.onChange = _this.onChange.bind(_this);\r\n        _this.weekTextsSavingJob = new PendingJob(function () { return _this.saveWeekTexts(); });\r\n        return _this;\r\n    }\r\n    WeekPlanner.prototype.componentDidMount = function () {\r\n        this.props.env.userTasksRepo.subscribe(this.onChange);\r\n    };\r\n    WeekPlanner.prototype.componentWillUnmount = function () {\r\n        this.props.env.userTasksRepo.unsubscribe(this.onChange);\r\n        this.weekTextsSavingJob.stop();\r\n    };\r\n    WeekPlanner.prototype.onChange = function (userTasks, persisted, weekTextsUT) {\r\n        var newState = {\r\n            userTasks: userTasks,\r\n            weekDate: persisted.weekDate,\r\n            openCourses: persisted.openCourses,\r\n            weekTextsUT: weekTextsUT,\r\n            isLoading: false\r\n        };\r\n        if (!this.state.weekTextsUT || (weekTextsUT.dateTime !== this.state.weekTextsUT.dateTime)) {\r\n            // Changing week. Reset to new week's values\r\n            newState.strategy = weekTextsUT.weekTexts.strategy;\r\n            newState.assessment = weekTextsUT.weekTexts.assessment;\r\n        }\r\n        this.setState(newState); // React's use of Pick instead of Partial makes things complex here.\r\n    };\r\n    WeekPlanner.prototype.isWeekTextsEdited = function () {\r\n        var _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\r\n        return !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy || assessment !== weekTextsUT.weekTexts.assessment);\r\n    };\r\n    WeekPlanner.prototype.saveWeekTexts = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, strategy, assessment, weekTextsUT;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        console.log(\"Saving texts...\");\r\n                        _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\r\n                        if (!this.isWeekTextsEdited()) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.upsert(weekTextsUT, function (ut) {\r\n                                ut.weekTexts = { strategy: strategy, assessment: assessment };\r\n                            })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.prevWeek = function () {\r\n        //this.saveWeekTexts(); \r\n        var prevWeekObj = getPrevWeekDate(moment(this.state.weekDate));\r\n        this.props.env.userTasksRepo.changeWeek(prevWeekObj.nextDate, prevWeekObj.adjusted);\r\n    };\r\n    WeekPlanner.prototype.nextWeek = function () {\r\n        //this.saveWeekTexts();\r\n        var nextWeekObj = getNextWeekDate(moment(this.state.weekDate));\r\n        this.props.env.userTasksRepo.changeWeek(nextWeekObj.nextDate, nextWeekObj.adjusted);\r\n    };\r\n    WeekPlanner.prototype.openDialog = function (dialog) {\r\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\r\n    };\r\n    WeekPlanner.prototype.openAddGoalDialog = function () {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddCustomGoal, { onSave: function (learningGoal) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            if (!learningGoal)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.emptyLearningGoalErr', defaultMessage: 'Lärandemålet kan inte vara tomt' }));\r\n                            if (!!this.state.saving) return [3 /*break*/, 5];\r\n                            this.setState({ saving: true });\r\n                            _a.label = 1;\r\n                        case 1:\r\n                            _a.trys.push([1, , 3, 4]);\r\n                            return [4 /*yield*/, this.addCustomGoal(learningGoal)];\r\n                        case 2:\r\n                            _a.sent();\r\n                            return [3 /*break*/, 4];\r\n                        case 3:\r\n                            this.setState({ saving: false });\r\n                            return [7 /*endfinally*/];\r\n                        case 4:\r\n                            this.closeDialog();\r\n                            _a.label = 5;\r\n                        case 5: return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); } }));\r\n    };\r\n    WeekPlanner.prototype.openAddOwnTaskDialog = function (courseName, learningGoalName) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddCustomTask, { isTask: !courseName, onSave: function (name, description, url) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            if (!name)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameCannotBeEmpty', defaultMessage: 'Namnet kan inte vara tomt' }));\r\n                            if (!!this.state.saving) return [3 /*break*/, 5];\r\n                            this.setState({ saving: true });\r\n                            _a.label = 1;\r\n                        case 1:\r\n                            _a.trys.push([1, , 3, 4]);\r\n                            return [4 /*yield*/, this.addCustomTask(courseName, learningGoalName, name, description, url)];\r\n                        case 2:\r\n                            _a.sent();\r\n                            return [3 /*break*/, 4];\r\n                        case 3:\r\n                            this.setState({ saving: false });\r\n                            return [7 /*endfinally*/];\r\n                        case 4:\r\n                            this.closeDialog();\r\n                            _a.label = 5;\r\n                        case 5: return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); } }));\r\n    };\r\n    WeekPlanner.prototype.editTask = function (userTask) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(EditUserTask, { userTasksRepo: this.props.env.userTasksRepo, userTask: userTask, onUpdate: function (updater) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var test;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            test = tslib_1.__assign({}, userTask);\r\n                            updater(test);\r\n                            if (!test.name)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameMustNotBeEmpty', defaultMessage: 'Namnet får inte vara tomt' }));\r\n                            this.closeDialog();\r\n                            return [4 /*yield*/, this.props.env.userTasksRepo.update([userTask], updater)];\r\n                        case 1:\r\n                            _a.sent();\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); }, onDelete: function (id) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            this.closeDialog();\r\n                            return [4 /*yield*/, this.props.env.userTasksRepo.delete([id])];\r\n                        case 1:\r\n                            _a.sent();\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); }, openDialog: function (dialog) { return _this.openDialog(dialog); }, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    WeekPlanner.prototype.editSubTask = function (userTask, subTask) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddOrEditSubTask, { userTasksRepo: this.props.env.userTasksRepo, mode: \"edit\", userTask: userTask, subTask: subTask, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    WeekPlanner.prototype.closeDialog = function () {\r\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\r\n    };\r\n    WeekPlanner.prototype.addCustomGoal = function (learningGoal) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var latestTimeStamp;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    learningGoal: learningGoal,\r\n                                    dateTime: latestTimeStamp + 2000\r\n                                }])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.setWeekPlannerBoxOpen(\"\", true)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.removeLearningGoal = function (learningGoal) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (learningGoal.tasks.length > 0) {\r\n                            if (!confirm(this.context.intl.formatMessage({ id: 'weekplanner.confirmRemoveLearningObjectives', defaultMessage: 'Ta bort lärandemål samt {learningGoalsNumber} uppgifter?' }, { learningGoalsNumber: learningGoal.tasks.length }))) {\r\n                                return [2 /*return*/];\r\n                            }\r\n                        }\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.delete(learningGoal.allTasks.map(function (t) { return t.id; }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.addCustomTask = function (courseName, learningGoal, name, description, url) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var latestTimeStamp;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\r\n                          ut.name == null &&\r\n                          !ut.courseName &&\r\n                          ut.learningGoal === learningGoal);\r\n                    \r\n                        if (emptyLearningGoalPlaceholder) {\r\n                          // Hijack learning-goal placeholder and make it the real task.\r\n                          // This will make the learning goal disappear once this task\r\n                          // is deleted.\r\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\r\n                            Object.assign(ut, { name, description, url });\r\n                          });\r\n                        } else {*/\r\n                        // Add another task to same learning-goal\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    dateTime: latestTimeStamp + 2000,\r\n                                    courseName: courseName,\r\n                                    learningGoal: learningGoal,\r\n                                    name: name,\r\n                                    description: description,\r\n                                    url: url\r\n                                }])];\r\n                    case 1:\r\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\r\n                          ut.name == null &&\r\n                          !ut.courseName &&\r\n                          ut.learningGoal === learningGoal);\r\n                    \r\n                        if (emptyLearningGoalPlaceholder) {\r\n                          // Hijack learning-goal placeholder and make it the real task.\r\n                          // This will make the learning goal disappear once this task\r\n                          // is deleted.\r\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\r\n                            Object.assign(ut, { name, description, url });\r\n                          });\r\n                        } else {*/\r\n                        // Add another task to same learning-goal\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.setIsOpen = function (courseName, isOpen) {\r\n        this.props.env.userTasksRepo.setWeekPlannerBoxOpen(courseName, isOpen);\r\n    };\r\n    WeekPlanner.prototype.setTaskDone = function (task, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setTaskDoneState(task, done)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.setSubTaskDone = function (task, subTask, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setSubTaskDoneState(task, subTask.id, done)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.copyFromPreviousWeek = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, userTasks_1, openCourses, weekDate, prevWeek, prevWeekNo, prevKEDWeek, prevTasks, test, latestTimeStamp_1, copies;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, this.setState({ isCopyingTasks: true })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        _b.trys.push([2, , 5, 6]);\r\n                        _a = this.state, userTasks_1 = _a.userTasks, openCourses = _a.openCourses, weekDate = _a.weekDate;\r\n                        prevWeek = moment(weekDate).add(-1, 'week');\r\n                        prevWeekNo = getAdjustedWeek(prevWeek);\r\n                        prevKEDWeek = KEDWeek(prevWeek.year(), prevWeekNo);\r\n                        return [4 /*yield*/, this.props.env.kedBackendClient.list(\"usertasks\", {\r\n                                from: prevKEDWeek.notBefore,\r\n                                to: prevKEDWeek.notAfter,\r\n                                role: \"USER\",\r\n                                include: [\"task\", \"course\", \"acl\"],\r\n                                flags: [\"includeIdsOnly\"]\r\n                            })];\r\n                    case 3:\r\n                        prevTasks = _b.sent();\r\n                        prevTasks = prevTasks\r\n                            .filter(function (prevTask) { return !prevTask.done; }) // Don't copy done tasks\r\n                            .filter(function (prevTask) { return !!prevTask.name; }) // Don't copy empty learning goals\r\n                            .filter(function (prevTask) { return !userTasks_1.some(function (taskOfCurrentWeek) {\r\n                            return taskOfCurrentWeek.name === prevTask.name &&\r\n                                taskOfCurrentWeek.learningGoal === prevTask.learningGoal &&\r\n                                taskOfCurrentWeek.courseName === prevTask.courseName;\r\n                        }); }); // Ignore identical tasks (already copied)\r\n                        test = [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; }));\r\n                        latestTimeStamp_1 = Math.max.apply(Math.max, [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; })));\r\n                        copies = prevTasks.sort(compareProp(\"dateTime\")).map(function (task) {\r\n                            var copy = tslib_1.__assign({}, task, { dateTime: latestTimeStamp_1 += 1000 });\r\n                            copy.id = createUUID();\r\n                            if (copy.subTasks) {\r\n                                copy.subTasks = copy.subTasks.filter(function (st) { return !st.done; });\r\n                            }\r\n                            delete copy.$etag;\r\n                            return copy;\r\n                        });\r\n                        // Store it\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert(copies)];\r\n                    case 4:\r\n                        // Store it\r\n                        _b.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 5:\r\n                        this.setState({ isCopyingTasks: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.getHeaderTitle = function () {\r\n        return React.createElement(\"h4\", null,\r\n            React.createElement(FormattedMessage, { id: \"weekplanner.logBook\", defaultMessage: \"Loggbok\" }));\r\n    };\r\n    WeekPlanner.prototype.render = function () {\r\n        var _this = this;\r\n        var weekNumber = moment(this.state.weekDate).week();\r\n        var showProgressCharts = features.weekplannerCharts;\r\n        //console.log(\"Weekydate: \"  + new Date(this.state.weekDate) + \" which is week no \" + weekNumber);\r\n        var currentWeek = moment().week();\r\n        var taskSets = refine(this.state.userTasks);\r\n        var _a = this.state, dialogs = _a.dialogs, weekTextsUT = _a.weekTextsUT, strategy = _a.strategy, assessment = _a.assessment, isLoading = _a.isLoading, isCopyingTasks = _a.isCopyingTasks;\r\n        var isSaving = weekTextsUT && (weekTextsUT.$meta === 'adding' || weekTextsUT.$meta === 'updating');\r\n        var isStrategyEdited = !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy);\r\n        var isAssessmentEdited = !!weekTextsUT && (assessment !== weekTextsUT.weekTexts.assessment);\r\n        var enableSaveButton = !isSaving && (isStrategyEdited || isAssessmentEdited);\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        var chartTasks = getWeekplannerProgressData(taskSets);\r\n        var percentage = chartTasks.totalNumberOfTasks > 0 ? chartTasks.completedTasks / chartTasks.totalNumberOfTasks * 100 : 0;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"ked_boxed weekPlanner\" + (weekNumber === currentWeek ? \" currentWeek\" : \"\"), onKeyDown: function (ev) {\r\n                    if (ev.which === 83 && ev.ctrlKey) {\r\n                        ev.preventDefault();\r\n                        if (!isSaving && _this.isWeekTextsEdited()) {\r\n                            _this.weekTextsSavingJob.triggerChange(0);\r\n                        }\r\n                    }\r\n                } },\r\n                showProgressCharts && chartTasks.totalNumberOfTasks > 0 && this.getHeaderTitle(),\r\n                React.createElement(\"div\", { className: \"widgets\" },\r\n                    showProgressCharts && chartTasks.totalNumberOfTasks > 0 ? React.createElement(\"div\", { className: \"progressBar\" },\r\n                        React.createElement(Progress, { percentage: percentage })) : this.getHeaderTitle(),\r\n                    React.createElement(\"div\", { className: \"weekSelect\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"p\", null,\r\n                                React.createElement(FormattedMessage, { id: \"weekplanner.weekNumber\", values: { weekNumber: weekNumber }, defaultMessage: \"Vecka {weekNumber}\" }))),\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"div\", { className: \"btn-group\" },\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.prevWeek(); } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.nextWeek(); } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" })))))),\r\n                taskSets.length > 0 && React.createElement(\"hr\", null),\r\n                taskSets.map(function (props) {\r\n                    return React.createElement(UserTasksBox, tslib_1.__assign({ key: props.courseName }, props, { courseName: props.courseName, learningGoals: props.learningGoals, viewCourseUrl: _this.props.viewCourseUrl, openCourses: _this.state.openCourses, addOwnTask: function (courseName, learningGoalName) { return _this.openAddOwnTaskDialog(courseName, learningGoalName); }, setIsOpen: _this.setIsOpen.bind(_this), setTaskDone: _this.setTaskDone.bind(_this), setSubTaskDone: _this.setSubTaskDone.bind(_this), editTask: function (task) { return _this.editTask(task); }, editSubTask: function (task, subTask) { return _this.editSubTask(task, subTask); }, removeLearningGoal: function (lg) { return _this.removeLearningGoal(lg); }, displayProgress: showProgressCharts, progressData: chartTasks.subjectData[props.courseName] }));\r\n                }),\r\n                React.createElement(\"hr\", null),\r\n                isLoading ? React.createElement(Spinner, null) : React.createElement(\"div\", null,\r\n                    React.createElement(\"div\", { className: \"btn\", onClick: function (ev) { return _this.openAddGoalDialog(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-list-alt\", \"aria-hidden\": \"true\" }),\r\n                        isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalPrimary\", defaultMessage: \"Eget l\\u00E4randem\\u00E5l\" })),\r\n                    React.createElement(\"div\", { className: \"btn\", style: isCopyingTasks ? { opacity: 0.5 } : undefined, onClick: function (ev) { return (!isCopyingTasks) && _this.copyFromPreviousWeek(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-clone\", \"aria-hidden\": \"true\" }),\r\n                        React.createElement(FormattedMessage, { id: \"weekplanner.copyPreviousWeekTaks\", defaultMessage: \"Kopiera ej klara fr\\u00E5n f\\u00F6reg\\u00E5ende vecka\" })),\r\n                    React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyAndEvaluation\", defaultMessage: \"Strategi & Utv\\u00E4rdering\" })), headerOpen: this.state.openCourses[\"StratUtv\"], onOpenClose: function (becameOpen) { return _this.setIsOpen(\"StratUtv\", becameOpen); } },\r\n                        React.createElement(\"h3\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategy\", defaultMessage: \"Strategi\" })),\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyDescription\", defaultMessage: \"Hur jag ska g\\u00F6ra f\\u00F6r att l\\u00E4ra mig.\" })),\r\n                        React.createElement(\"hr\", null),\r\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", disabled: this.props.env.tutored, value: strategy && strategy.substr(0, MAX_STRATEGY_LENGTH), onChange: function (ev) {\r\n                                _this.setState({ strategy: (ev.target.value || '').substr(0, MAX_STRATEGY_LENGTH) });\r\n                                _this.weekTextsSavingJob.triggerChange(500);\r\n                            } }),\r\n                        React.createElement(\"h3\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluation\", defaultMessage: \"Utv\\u00E4rdering\" })),\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluationDescription\", defaultMessage: \"Reflektion kring din arbetsinsats och dina valda strategier under veckan.Utv\\u00E4rdera i f\\u00F6rh\\u00E5llande till dina m\\u00E5l.\" })),\r\n                        React.createElement(\"hr\", null),\r\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", value: assessment && assessment.substr(0, MAX_ASSESSMENT_LENGTH), disabled: this.props.env.tutored, onChange: function (ev) {\r\n                                _this.setState({ assessment: (ev.target.value || '').substr(0, MAX_ASSESSMENT_LENGTH) });\r\n                                _this.weekTextsSavingJob.triggerChange(500);\r\n                            } }),\r\n                        React.createElement(\"div\", { className: \"btn\", tabIndex: 0, style: enableSaveButton ? {} : { opacity: 0.5 }, onClick: function () { return !isSaving && _this.weekTextsSavingJob.triggerChange(0); } },\r\n                            React.createElement(\"i\", { className: \"fa fa-floppy-o\", \"aria-hidden\": \"true\" }),\r\n                            enableSaveButton ? React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \" Spara\" }) : React.createElement(FormattedMessage, { id: \"common.saved\", defaultMessage: \" Sparad\" }))))),\r\n            React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () {\r\n                    _this.setState(function (_a) {\r\n                        var dialogs = _a.dialogs;\r\n                        return ({ dialogs: dialogs.slice(0, dialogs.length - 1) });\r\n                    });\r\n                } }));\r\n    };\r\n    WeekPlanner.contextType = LanguageContext;\r\n    return WeekPlanner;\r\n}(React.Component));\r\nexport { WeekPlanner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as kedComponents from './kedcomponents';\r\nimport { setupIntl } from '../../components/utility-components/SetupLanguageIntl';\r\nimport { injectIntl } from 'react-intl';\r\n// <TEMPORARY FIX>\r\n// Need as current production has the old SubjectPlanner URLs,\r\n// while the newest version has new pages for them!\r\n// REMOVE AFTER GOING TO PRODUCTION AND HAVING THE VALUE CONFIGURED IN ELEMENTS!\r\nimport { cfg } from '../../globals/KED.cfg';\r\ncfg.KED_SUBJECT_PLANNER_URL = '/ap/amnesplaneraren';\r\ncfg.KED_SUBJECT_PLANNER_ADMIN_URL = '/ap/amnesplanerarenadmin';\r\n// </TEMPORARY FIX>\r\nvar intlComponents = {};\r\nObject.keys(kedComponents).forEach(function (k) {\r\n    intlComponents[k] = setupIntl(injectIntl(kedComponents[k]));\r\n});\r\nexport var components = tslib_1.__assign({}, intlComponents);\r\n","import '../../global-setters/set-all';\r\nimport env from '../../globals/KED.env';\r\nenv.bearerProvider.getBearer(); // Start getting bearer as soon as possible.\r\nenv.googleTokenProvider.getBearer(); // Start getting google bearer as soon as possible.\r\n// Common components\r\nexport { CalendarSelf as Calendar, } from '../../components/calendar/calendar-self';\r\nexport { CalendarTutored } from '../../components/calendar/calendar-tutored';\r\nexport { WeekPlannerSelf as WeekPlanner } from '../../components/weekplanner/weekplanner-self';\r\nexport { WeekPlannerTutored } from '../../components/weekplanner/weekplanner-tutored';\r\nexport { LatestAssessments } from '../../components/latest-assessments/latest-assessments';\r\nexport { LearningTasks } from '../../components/learning-tasks';\r\nexport { RootWeekNotebook as WeekNotebook } from '../../components/week-notebook';\r\nexport { TutorsSelect } from '../../components/tutors-select/tutors-select';\r\n// KG only\r\nexport { KGTermPlannerSelf as KGTermPlanner } from '../../components/kg-termplanner/kg-termplanner-self';\r\nexport { KGTermPlannerTutored } from '../../components/kg-termplanner/kg-termplanner-tutored';\r\nexport { ListCourses } from '../../components/list-courses/list-courses';\r\n// KS only\r\nexport { KSTermPlannerSelf as KSTermPlanner } from '../../components/ks-termplanner/ks-termplanner-self';\r\nexport { KSTermPlannerTutored } from '../../components/ks-termplanner/ks-termplanner-tutored';\r\nexport { KSGoals } from '../../components/ks-goals/goals';\r\nexport { MyCourses } from '../../components/my-courses/my-courses';\r\nexport { MySubjects } from '../../components/my-subjects/my-subjects';\r\n","import * as tslib_1 from \"tslib\";\r\nimport KED from '../../globals/KED';\r\nimport { components } from './kedcomponents.client';\r\nKED.components = tslib_1.__assign({}, KED.components, components);\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString } from '../utils/query-string';\r\nimport FeatureDescriptions from './feature-flags.json';\r\nimport { cfg } from '../globals/KED.cfg';\r\nvar Features = /** @class */ (function () {\r\n    function Features() {\r\n        var e_1, _a;\r\n        this._initialized = false;\r\n        var _loop_1 = function (featureName) {\r\n            Object.defineProperty(this_1, featureName, {\r\n                get: function () {\r\n                    if (!this._initialized)\r\n                        this.init();\r\n                    return this._features[featureName];\r\n                },\r\n                set: function (value) {\r\n                    throw new Error('Feature flags cannot be set here');\r\n                }\r\n            });\r\n        };\r\n        var this_1 = this;\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                _loop_1(featureName);\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n    }\r\n    Features.prototype.init = function () {\r\n        var e_2, _a;\r\n        if (this._initialized)\r\n            return;\r\n        var turnedOnFeatures = (cfg.KED_FEATURES || \"\").split(',').map(function (name) { return name.trim().toLowerCase(); });\r\n        var query = parseQueryString(location.search, { toLower: true });\r\n        if (query.testversion) {\r\n            turnedOnFeatures = [\"*\"];\r\n        }\r\n        if (query.features) {\r\n            turnedOnFeatures = query.features\r\n                .split(',')\r\n                .map(function (feature) { return feature.trim().toLowerCase(); });\r\n        }\r\n        var turnOnAll = turnedOnFeatures.includes('*');\r\n        this._features = {};\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                this._features[featureName] = turnOnAll ||\r\n                    turnedOnFeatures.includes(featureName.toLowerCase());\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        this._initialized = true;\r\n    };\r\n    return Features;\r\n}());\r\nexport { Features };\r\nexport var features = new Features();\r\n","export * from './features';\r\n","import cfg from '../globals/KED.cfg';\r\ncfg.ENVIRONMENT = process.env.ENVIRONMENT;\r\ncfg.KED_API_URL = process.env.KED_API_URL; // \"https://kedbackendtest.azurewebsites.net/api/\"\r\ncfg.EDS_API_URL = process.env.EDS_API_URL; // \"https://edsportalowinapi.azurewebsites.net/api/\"\r\ncfg.KED_TOKEN_URL = process.env.KED_TOKEN_URL; // \"https://kedauthtest.azurewebsites.net/token\"\r\ncfg.KED_CLIENT_ID = process.env.KED_CLIENT_ID; // \"devclient\", \"testclient\", \"...\"\r\ncfg.KED_CLIENT_SECRET = process.env.KED_CLIENT_SECRET;\r\ncfg.KED_REALM = process.env.KED_REALM; // \"SE1\"\r\ncfg.KED_LOCALE = cfg.KED_LOCALE || process.env.KED_LOCALE; // \"sv\", \"en\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_SCHOOL_LOCALE = cfg.KED_SCHOOL_LOCALE || process.env.KED_SCHOOL_LOCALE; // \"sv\", \"en_sin\", \"en_nin\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_RESOURCES_URL = cfg.KED_RESOURCES_URL || process.env.KED_RESOURCES_URL;\r\n","/* These scripts assume some of the global vars have already been set:\r\n  * KED.cfg\r\n  * KED.env.currentUser\r\n\r\n  The rest will be set here (client side)\r\n*/\r\nimport './configure';\r\nimport './set-bearer-providers';\r\nimport './set-ked-backend-client';\r\nimport './set-eds-client';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString, generateQueryString, splitUrlAndQuery } from \"../utils/query-string\";\r\nimport { WebServerBearerProvider, isomorphic, storage } from 'kedbackend/clientweb';\r\nimport { KedBearerProvider } from 'kedbackend/client';\r\nimport cfg from '../globals/KED.cfg';\r\nimport env from '../globals/KED.env';\r\nimport { IMPERSONATION_QUERY_PARAMS } from \"../access-control/index\";\r\nimport { cherryPickProps } from \"../utils/utils\";\r\nvar employeeClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.profile.emails\",\r\n    \"https://www.googleapis.com/auth/classroom.rosters\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.students\"\r\n];\r\nvar studentClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.me\"\r\n];\r\nfunction getMergedTokenPath(tokenPath, locationSearch, scopes) {\r\n    // Merge configured query params of token path with params given to current page\r\n    var currentQuery = parseQueryString(locationSearch);\r\n    var impersonationProps = cherryPickProps(currentQuery, IMPERSONATION_QUERY_PARAMS);\r\n    var _a = tslib_1.__read(splitUrlAndQuery(tokenPath), 2), tokenPathWithoutQuery = _a[0], tokenQueryString = _a[1];\r\n    var tokenPathQuery = parseQueryString(tokenQueryString);\r\n    return tokenPathWithoutQuery + generateQueryString(tslib_1.__assign({}, tokenPathQuery, impersonationProps, { scopes: scopes.join(',') }));\r\n}\r\nfunction getTokenId(mergedTokenPath, userEmail) {\r\n    return mergedTokenPath + \"/\" + userEmail;\r\n}\r\nfunction saveUserInfo(user, tokenId) {\r\n    env.currentUser = user;\r\n    var schoolgrade = parseQueryString(location.search, { toLower: true }).schoolgrade;\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n    sessionStorage.setItem(\"userInfo\" + tokenId, JSON.stringify(user));\r\n}\r\nfunction loadUserInfo(tokenId) {\r\n    var storedSessionUser = sessionStorage.getItem(\"userInfo\" + tokenId);\r\n    if (storedSessionUser) {\r\n        env.currentUser = JSON.parse(storedSessionUser);\r\n    }\r\n}\r\nfunction createBearerProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        if (res.user) {\r\n            saveUserInfo(res.user, tokenId);\r\n        }\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createGoogleTokenProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createTestTokenProvider(tokenUrl, user, scopes) {\r\n    return new KedBearerProvider(isomorphic, storage, tokenUrl + user.mail + location.search, cfg.KED_CLIENT_ID, cfg.KED_CLIENT_SECRET, tokenUrl, {\r\n        email: user.mail.toLowerCase(),\r\n        roles: user.roles,\r\n        school: user.school,\r\n        schoolType: user.schoolType,\r\n        scopes: scopes,\r\n        name: user.displayName\r\n    });\r\n}\r\n// env.currentUser.mail is set by SiteVision server initially.\r\n// A response from /api/token may change the mail attribute of the current\r\n// user, so env.currentUser.mail may be different after getting a response.\r\n// However, the initial value is valuable always in order to distinguish the case\r\n// when one normal user logs out and another user logs in.\r\nvar initialUserEmail = env.currentUser && env.currentUser.mail; // Initial value of mail. May change.\r\nif (initialUserEmail) {\r\n    // KED\r\n    if (cfg.KED_TOKEN_PATH) {\r\n        //\r\n        //\r\n        // Production / SiteVision proxied /api/token to request tokens from:\r\n        //\r\n        //\r\n        var mergedTokenPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        env.bearerProvider = createBearerProvider(mergedTokenPath, initialUserEmail);\r\n        loadUserInfo(getTokenId(mergedTokenPath, initialUserEmail));\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        // Google\r\n        var googleMergedPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, scopes);\r\n        env.googleTokenProvider = createGoogleTokenProvider(googleMergedPath, initialUserEmail);\r\n    }\r\n    else if (cfg.KED_TOKEN_URL && cfg.KED_CLIENT_ID && cfg.KED_CLIENT_SECRET) {\r\n        //\r\n        //\r\n        // Test - go directly to KEDAUTH server to retrieve tokens\r\n        //\r\n        //\r\n        env.bearerProvider = createTestTokenProvider(cfg.KED_TOKEN_URL, env.currentUser, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        env.googleTokenProvider = createTestTokenProvider(cfg.KED_TOKEN_URL + \"/google\", env.currentUser, scopes);\r\n    }\r\n    else {\r\n        throw new Error(\"Missing configuration parameter KED_TOKEN_PATH\");\r\n    }\r\n}\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { isomorphic } from 'kedbackend/clientweb';\r\nimport { EdsClient } from '../apis/edsclient';\r\nenv.edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, env.bearerProvider, function () { return env.currentUser.mail; });\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { KedBackendClientWeb } from 'kedbackend/clientweb';\r\nenv.kedBackendClient = new KedBackendClientWeb(cfg.KED_API_URL, env.bearerProvider);\r\n","import KED from './KED';\r\n;\r\nif (!KED.cfg)\r\n    KED.cfg = {};\r\nexport default KED.cfg;\r\nexport var cfg = KED.cfg;\r\n","import KED from './ked';\r\nif (!KED.env)\r\n    KED.env = {};\r\nexport default KED.env;\r\nexport var env = KED.env;\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import * as tslib_1 from \"tslib\";\r\nimport KED from './ked';\r\nvar TutorEnv = /** @class */ (function () {\r\n    function TutorEnv() {\r\n        this.subscribers = [];\r\n        this.env = null;\r\n        this.version = 1;\r\n    }\r\n    //promise: Promise<Env | null> = Promise.resolve(null);\r\n    TutorEnv.prototype.subscribe = function (subscriber) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.subscribers.push(subscriber);\r\n                subscriber(this.env);\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    TutorEnv.prototype.unsubscribe = function (subscriber) {\r\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\r\n    };\r\n    TutorEnv.prototype.notifySubscribers = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.subscribers.forEach(function (s) { return s(_this.env); });\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    TutorEnv.prototype.setNewEnv = function (user, envGetter) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var version, env;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        version = ++this.version;\r\n                        this.env = { currentUser: user, tutored: true };\r\n                        this.notifySubscribers(); // Make subscriber display \"Loading... user name\"\r\n                        return [4 /*yield*/, envGetter().catch(function (err) { return ({\r\n                                currentUser: user,\r\n                                tutored: true,\r\n                                error: err\r\n                            }); })];\r\n                    case 1:\r\n                        env = _a.sent();\r\n                        if (version === this.version) {\r\n                            // No one else has called setEnv during this call.\r\n                            ++this.version;\r\n                            this.env = tslib_1.__assign({}, env, { tutored: true });\r\n                            this.notifySubscribers(); // Make subscribers display the data.\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return TutorEnv;\r\n}());\r\nexport { TutorEnv };\r\nif (!KED.tutorEnv)\r\n    KED.tutorEnv = new TutorEnv();\r\nexport default KED.tutorEnv;\r\n","import env from './KED.env';\r\nimport { KedBackendRepo } from 'kedbackend/repo';\r\nimport { getGlobalId, createUUID } from 'kedbackend/client';\r\nimport cfg from './KED.cfg';\r\nif (!env.db) {\r\n    // Put db on env so that it is shared between subject planner and other components!\r\n    env.db = new KedBackendRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser ?\r\n        env.currentUser.mail :\r\n        \"\"; }, function () { return env.currentUser ?\r\n        env.currentUser.displayName || env.currentUser.mail :\r\n        \"\"; });\r\n}\r\nexport var db = env.db;\r\nexport var globalId = getGlobalId(cfg.KED_REALM);\r\nexport var Schools = {\r\n    standardSchool: db.schools.name(\"standard\").cacheOptimized().single(),\r\n    get mySchool() { return db.schools.name(env.currentUser.school).cacheOptimized().single(); }\r\n};\r\nexport var CourseInstances = {\r\n    getBranchId: function (school, courseId) {\r\n        return school.switchMap(function (school) {\r\n            return db.branches\r\n                .hasEdgesFrom([school.officialBranchId])\r\n                .name(\"draft\")\r\n                .tags(courseId)\r\n                .idsOnly()\r\n                .map(function (_a) {\r\n                var id = _a.id;\r\n                return id;\r\n            })\r\n                .toValue()\r\n                .map(function (ids) { return ids.length > 0 ? ids[0] : undefined; });\r\n        });\r\n    },\r\n    /** Get a DRAFT branch for given course ID and given school.\r\n     * If there is not yet such a branch, create it using mutationsOnEmpty() which will\r\n     * lead to the C# code DocumentRepository.ReadOrMutate() via DocumentController.\r\n     */\r\n    getOrCreateBranchId: function (school, courseId) {\r\n        return db.courseInstances.idsOnly().id(courseId).switchMap(function () {\r\n            return school.switchMap(function (school) {\r\n                return db.branches\r\n                    .hasEdgesFrom([school.officialBranchId])\r\n                    .name(\"draft\")\r\n                    .tags(courseId)\r\n                    .idsOnly()\r\n                    .mutationsOnEmpty(function (tx) {\r\n                    // These 2 mutations will occur server side, atomically.\r\n                    // Will be sent on each request in the query, but will only execute if query results in zero items.\r\n                    //console.log(\"School:\", school);\r\n                    var id = createUUID();\r\n                    tx.add(\"branches\", {\r\n                        id: id,\r\n                        acl: [\r\n                            \"role:USER:R\",\r\n                            \"schoolRole:\" + school.name + \"/EMPLOYEE:S\"\r\n                        ],\r\n                        name: 'draft',\r\n                        schoolId: school.id,\r\n                        treeParentId: school.officialBranchId,\r\n                        tags: [courseId]\r\n                    });\r\n                    // Approving the branch makes sure that it was created by an EMPLOYEE on given school.\r\n                    tx.link2(\"branches\", school.officialBranchId, \"approvedChildren\", id);\r\n                })\r\n                    .single()\r\n                    .map(function (_a) {\r\n                    var id = _a.id;\r\n                    return id;\r\n                });\r\n            });\r\n        });\r\n    },\r\n    getAllDescendantIds: function (courseId) {\r\n        return db.courseBlocks.tags(courseId).idsOnly().concat(db.courseContents.tags(courseId).idsOnly()).concat(db.courseTabs.tags(courseId).idsOnly()).concat(db.tasks.tags(courseId).idsOnly())\r\n            .map(function (x) { return x.id; });\r\n    }\r\n};\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import moment from 'moment';\r\nimport cfg from '../globals/KED.cfg';\r\nif (cfg.KED_LOCALE === \"sv\") {\r\n    moment.updateLocale('sv', {\r\n        months: 'januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december'.split('_'),\r\n        monthsShort: 'jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec'.split('_'),\r\n        weekdays: 'söndag_måndag_tisdag_onsdag_torsdag_fredag_lördag'.split('_'),\r\n        weekdaysShort: 'sön_mån_tis_ons_tor_fre_lör'.split('_'),\r\n        weekdaysMin: 'sö_må_ti_on_to_fr_lö'.split('_'),\r\n        longDateFormat: {\r\n            LT: 'HH:mm',\r\n            LTS: 'HH:mm:ss',\r\n            L: 'YYYY-MM-DD',\r\n            LL: 'D MMMM YYYY',\r\n            LLL: 'D MMMM YYYY [kl.] HH:mm',\r\n            LLLL: 'dddd D MMMM YYYY [kl.] HH:mm',\r\n            lll: 'D MMM YYYY HH:mm',\r\n            llll: 'ddd D MMM YYYY HH:mm'\r\n        },\r\n        calendar: {\r\n            sameDay: '[Idag] LT',\r\n            nextDay: '[Imorgon] LT',\r\n            lastDay: '[Igår] LT',\r\n            nextWeek: '[På] dddd LT',\r\n            lastWeek: '[I] dddd[s] LT',\r\n            sameElse: 'L'\r\n        },\r\n        relativeTime: {\r\n            future: 'om %s',\r\n            past: 'för %s sedan',\r\n            s: 'några sekunder',\r\n            ss: '%d sekunder',\r\n            m: 'en minut',\r\n            mm: '%d minuter',\r\n            h: 'en timme',\r\n            hh: '%d timmar',\r\n            d: 'en dag',\r\n            dd: '%d dagar',\r\n            M: 'en månad',\r\n            MM: '%d månader',\r\n            y: 'ett år',\r\n            yy: '%d år'\r\n        },\r\n        dayOfMonthOrdinalParse: /\\d{1,2}(e|a)/,\r\n        ordinal: function (number) {\r\n            var b = number % 10, output = (~~(number % 100 / 10) === 1) ? 'e' :\r\n                (b === 1) ? 'a' :\r\n                    (b === 2) ? 'a' :\r\n                        (b === 3) ? 'e' : 'e';\r\n            return number + output;\r\n        },\r\n        week: {\r\n            dow: 1,\r\n            doy: 4 // The week that contains Jan 4th is the first week of the year.\r\n        }\r\n    });\r\n}\r\nexport var localMoment = function () {\r\n    return moment.apply(this, arguments).locale(cfg.KED_LOCALE);\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport env from '../globals/KED.env';\r\nimport { showError, flatten, compareProp, arrayToMap } from '../utils/utils';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { EDSPeriod } from '../apis/edsclient';\r\nimport { getSchoolMoment } from '../utils/school-moment';\r\nimport moment from 'moment';\r\nexport var hiddenCoursesRepo = env.hiddenCoursesRepo;\r\nvar HiddenCoursesRepo = /** @class */ (function () {\r\n    function HiddenCoursesRepo() {\r\n        var _this = this;\r\n        this.result = null;\r\n        this.subscribers = [];\r\n        this.fullCourse = false;\r\n        this.notifySubscriber = function (subscriber, options) {\r\n            try {\r\n                subscriber(options.fullCourse ? _this.result : _this.result.filter(function (c) { return c.visible; }));\r\n            }\r\n            catch (err) {\r\n                console.error(err);\r\n            }\r\n        };\r\n        this.kedRepo = new KedRepo({\r\n            getClient: function () { return env.kedBackendClient; },\r\n            optimistic: true,\r\n            table: \"userhiddencourses\",\r\n            user: env.currentUser ? env.currentUser.mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/, ({ role: \"USER\" })];\r\n            }); }); },\r\n        });\r\n        var initPromise = this.init();\r\n        Promise.all([\r\n            initPromise,\r\n            this.kedCoursesPromise,\r\n            this.edsCoursesPromise\r\n        ]).catch(function (err) { return showError(err); });\r\n    }\r\n    HiddenCoursesRepo.prototype.init = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var bearerPromise, resolveUserHiddenCoursesPromise, userHiddenCoursesResolved;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        bearerPromise = env.bearerProvider ? env.bearerProvider.getBearer() : Promise.resolve({});\r\n                        // In parallell, we request:\r\n                        //  1) KEDBackend: Schools.activeCourses\r\n                        //  2) EDS.getActiveAcourses()\r\n                        //  3) (via subscription): KEDBackend: userHiddenCourses\r\n                        this.kedCoursesPromise = bearerPromise.then(function () { return _this.listKedCourses(); });\r\n                        this.edsCoursesPromise = bearerPromise.then(function () { return _this.listEDSCourses(); });\r\n                        userHiddenCoursesResolved = false;\r\n                        this.userHiddenCoursesPromise = new Promise(function (resolve) { return resolveUserHiddenCoursesPromise = function (x) {\r\n                            if (userHiddenCoursesResolved) {\r\n                                _this.userHiddenCoursesPromise = Promise.resolve(x);\r\n                            }\r\n                            else {\r\n                                userHiddenCoursesResolved = true;\r\n                                resolve(x);\r\n                            }\r\n                        }; });\r\n                        return [4 /*yield*/, bearerPromise];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.kedRepo.mem.subscribe(function (userHiddenCourses) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var _a, activeCourses, edsActiveCourses, _b;\r\n                            var _this = this;\r\n                            return tslib_1.__generator(this, function (_c) {\r\n                                switch (_c.label) {\r\n                                    case 0: return [4 /*yield*/, Promise.all([\r\n                                            this.kedCoursesPromise,\r\n                                            this.edsCoursesPromise\r\n                                        ])];\r\n                                    case 1:\r\n                                        _a = tslib_1.__read.apply(void 0, [_c.sent(), 2]), activeCourses = _a[0], edsActiveCourses = _a[1];\r\n                                        // Refine the three results into a single result\r\n                                        _b = this;\r\n                                        return [4 /*yield*/, this.createCoursesList(edsActiveCourses, userHiddenCourses, activeCourses)];\r\n                                    case 2:\r\n                                        // Refine the three results into a single result\r\n                                        _b.result = _c.sent();\r\n                                        // Notify our subscribers:\r\n                                        this.subscribers.forEach(function (subscriber) { return _this.notifySubscriber(subscriber.subscriber, subscriber.options); });\r\n                                        resolveUserHiddenCoursesPromise(userHiddenCourses);\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.listKedCourses = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var fullCourse, schools, activeCourses;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        fullCourse = this.fullCourse;\r\n                        console.log(\"FullCourse: \" + fullCourse);\r\n                        return [4 /*yield*/, env.kedBackendClient.list('schools', {\r\n                                role: \"USER\",\r\n                                name: env.currentUser.school,\r\n                                include: \"activeCourses\",\r\n                                flags: fullCourse ? [] : [\"includeIdsAndNamesOnly\"],\r\n                                cacheBust: env.currentUser.username\r\n                            })];\r\n                    case 1:\r\n                        schools = _a.sent();\r\n                        activeCourses = flatten(schools.map(function (school) { return school.activeCourses; })).sort(compareProp(\"name\"));\r\n                        return [2 /*return*/, activeCourses];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.listEDSCourses = function () {\r\n        var periodName = new EDSPeriod(getSchoolMoment(moment())).period;\r\n        return env.currentUser.roles.indexOf('EMPLOYEE') === -1 ?\r\n            // STUDENTs should, by default, only show courses that is listed in EDS\r\n            env.edsClient.getActiveCourses({ periodName: periodName }) :\r\n            // EMPLOYEEs should, by default, show all courses on school - no need to query EDS\r\n            null;\r\n    };\r\n    HiddenCoursesRepo.prototype.createCoursesList = function (edsActiveCourses, userHiddenCourses, activeCourses) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var hiddenCoursesMap, visibleCoursesMap, isStudent, edsCourseMap, result;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        hiddenCoursesMap = arrayToMap(userHiddenCourses.filter(function (hc) { return !hc.show; }), function (hc) { return hc.name; });\r\n                        visibleCoursesMap = arrayToMap(userHiddenCourses.filter(function (hc) { return hc.show; }), function (hc) { return hc.name; });\r\n                        isStudent = env.currentUser.roles.some(function (role) { return role === 'STUDENT'; });\r\n                        edsCourseMap = edsActiveCourses ?\r\n                            arrayToMap(edsActiveCourses, function (c) { return c.name; }) :\r\n                            {};\r\n                        return [4 /*yield*/, Promise.all(activeCourses.map(function (_a) {\r\n                                var id = _a.id, name = _a.name, description = _a.description, modifiedBy = _a.modifiedBy;\r\n                                return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                                    var edsCourse, defaultVisible, visible;\r\n                                    return tslib_1.__generator(this, function (_b) {\r\n                                        edsCourse = edsCourseMap[name];\r\n                                        defaultVisible = isStudent ?\r\n                                            edsCourse != null : // Course name also listed in EDS\r\n                                            true;\r\n                                        visible = defaultVisible ?\r\n                                            !hiddenCoursesMap[id] : // Visible unless user has overridden that.\r\n                                            !!visibleCoursesMap[id];\r\n                                        // Resolve description:\r\n                                        if (modifiedBy && modifiedBy.name && !description) {\r\n                                            description = modifiedBy.name + \"s version\";\r\n                                        }\r\n                                        return [2 /*return*/, {\r\n                                                id: id,\r\n                                                name: name,\r\n                                                description: description,\r\n                                                visible: visible,\r\n                                                defaultVisible: defaultVisible\r\n                                            }];\r\n                                    });\r\n                                });\r\n                            }))];\r\n                    case 1:\r\n                        result = _a.sent();\r\n                        return [2 /*return*/, result.sort(function (_a, _b) {\r\n                                var a = _a.name;\r\n                                var b = _b.name;\r\n                                return a < b ? -1 : a > b ? 1 : 0;\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.hideCourse = function (c) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var overrides;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        overrides = this.kedRepo.mem.items.filter(function (hc) { return hc.name === c.id; });\r\n                        if (!c.defaultVisible) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.kedRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    name: c.id\r\n                                }])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.kedRepo.delete(overrides.map(function (ov) { return ov.id; }))];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.showCourse = function (c) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var overrides;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        overrides = this.kedRepo.mem.items.filter(function (hc) { return hc.name === c.id; });\r\n                        if (!c.defaultVisible) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.kedRepo.delete(overrides.map(function (ov) { return ov.id; }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.kedRepo.insert([{\r\n                                id: createUUID(),\r\n                                name: c.id,\r\n                                show: true\r\n                            }])];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.subscribe = function (subscriber, options) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, activeCourses, edsActiveCourses, userHiddenCourses, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!(!this.fullCourse && options.fullCourse)) return [3 /*break*/, 3];\r\n                        // The subscriber demands full courses\r\n                        // Need to query that before notifying\r\n                        // Also affect state for future internal notification\r\n                        this.fullCourse = options.fullCourse;\r\n                        this.kedCoursesPromise = this.listKedCourses(); // Redo this call, now loading full courses\r\n                        return [4 /*yield*/, Promise.all([\r\n                                this.kedCoursesPromise,\r\n                                this.edsCoursesPromise,\r\n                                this.userHiddenCoursesPromise\r\n                            ])];\r\n                    case 1:\r\n                        _a = tslib_1.__read.apply(void 0, [_c.sent(), 3]), activeCourses = _a[0], edsActiveCourses = _a[1], userHiddenCourses = _a[2];\r\n                        // Assemble result:\r\n                        _b = this;\r\n                        return [4 /*yield*/, this.createCoursesList(edsActiveCourses, userHiddenCourses, activeCourses)];\r\n                    case 2:\r\n                        // Assemble result:\r\n                        _b.result = _c.sent();\r\n                        _c.label = 3;\r\n                    case 3: return [4 /*yield*/, this.userHiddenCoursesPromise];\r\n                    case 4:\r\n                        _c.sent(); // So we know that this.result is there.\r\n                        this.notifySubscriber(subscriber, options);\r\n                        this.subscribers.push({ subscriber: subscriber, options: options });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    HiddenCoursesRepo.prototype.unsubscribe = function (subscriber) {\r\n        this.subscribers = this.subscribers.filter(function (s) { return s.subscriber !== subscriber; });\r\n    };\r\n    return HiddenCoursesRepo;\r\n}());\r\nif (!hiddenCoursesRepo) {\r\n    hiddenCoursesRepo = env.hiddenCoursesRepo = new HiddenCoursesRepo();\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Repo } from './repo';\r\nimport { BatchRunner, createUUID } from 'kedbackend/client';\r\nvar KedRepo = /** @class */ (function () {\r\n    function KedRepo(options) {\r\n        var _this = this;\r\n        var table = options.table, getClient = options.getClient, getQueryOptions = options.getQueryOptions;\r\n        this.mem = new Repo({ query: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var queryOptions;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0: return [4 /*yield*/, getQueryOptions()];\r\n                        case 1:\r\n                            queryOptions = _a.sent();\r\n                            return [4 /*yield*/, getClient().list(table, tslib_1.__assign({}, queryOptions, { cacheBust: this.getCacheBust() }))];\r\n                        case 2: return [2 /*return*/, _a.sent()];\r\n                    }\r\n                });\r\n            }); } });\r\n        this.options = options;\r\n    }\r\n    KedRepo.prototype.getCacheBust = function () {\r\n        var _a = this.options, table = _a.table, user = _a.user;\r\n        var cacheBust = localStorage.getItem('cache-bust-' + table + '-' + user);\r\n        return cacheBust || this.regenerateCacheBust();\r\n    };\r\n    KedRepo.prototype.regenerateCacheBust = function () {\r\n        var _a = this.options, table = _a.table, user = _a.user;\r\n        var cacheBust = createUUID();\r\n        localStorage.setItem('cache-bust-' + table + '-' + user, cacheBust);\r\n        return cacheBust;\r\n    };\r\n    KedRepo.prototype.upsert = function (item, updater) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var updatedItem;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!!item.$etag) return [3 /*break*/, 2];\r\n                        updatedItem = Object.assign({}, item);\r\n                        updater(updatedItem);\r\n                        return [4 /*yield*/, this.insert([updatedItem])];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                    case 2: \r\n                    // We have an $etag, so we can expect it to live on the server.\r\n                    // However, take care of the unlikely situation that it was deleted from server,\r\n                    // and if so, insert it again.\r\n                    return [4 /*yield*/, this.update([item], updater).catch(function (e) {\r\n                            if (e.name === \"http404\") {\r\n                                var updatedItem = Object.assign({}, item);\r\n                                updater(updatedItem);\r\n                                return _this.insert([updatedItem]);\r\n                            }\r\n                            return Promise.reject(e);\r\n                        })];\r\n                    case 3:\r\n                        // We have an $etag, so we can expect it to live on the server.\r\n                        // However, take care of the unlikely situation that it was deleted from server,\r\n                        // and if so, insert it again.\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.update = function (items, updater) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, modifiedItems, res;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        modifiedItems = items.map(function (item) {\r\n                            var memRepoItem = _this.mem.items.find(function (it) { return it.id === item.id; });\r\n                            item = Object.assign({}, memRepoItem || item);\r\n                            updater(item);\r\n                            return item;\r\n                        });\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(modifiedItems.map(function (x) { return Object.assign({}, x, { $meta: 'updating' }); }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); })\r\n                            .catch(function (e) { return e.name === \"http409\" ? // conflict\r\n                            // Get a fresh version from server:\r\n                            client.list(table, { ids: items.map(function (item) { return item.id; }) }, { cache: 'no-cache' }).then(function (freshItems) {\r\n                                // Update local version:\r\n                                var modifiedItems = freshItems.map(function (freshItem) {\r\n                                    // Clone the fresh item\r\n                                    var modified = Object.assign({}, freshItem);\r\n                                    // Re-run the updater on the clone:\r\n                                    updater(modified);\r\n                                    return modified;\r\n                                });\r\n                                // Re-do the the put operation towards the server.\r\n                                return client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); });\r\n                            }) :\r\n                            // Other unexpected error:\r\n                            Promise.resolve(optimistic &&\r\n                                _this.mem.update(items)) // Undo optimistic update\r\n                                .then(function () {\r\n                                return Promise.reject(e); // Reject with the error no matter.\r\n                            }); })];\r\n                    case 3:\r\n                        res = _b.sent();\r\n                        this.regenerateCacheBust();\r\n                        modifiedItems.forEach(function (item) {\r\n                            item.$etag = res.newEtags[item.id];\r\n                            item.$meta = undefined;\r\n                        });\r\n                        return [4 /*yield*/, this.mem.update(modifiedItems)];\r\n                    case 4:\r\n                        _b.sent(); // Ensures new etag is is applied on next action.\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.stripGraphs = function (items, graphs) {\r\n        return items.map(function (item) {\r\n            var clone = Object.assign({}, item);\r\n            graphs.forEach(function (graph) {\r\n                if (item[graph]) {\r\n                    clone[graph] = item[graph].map(function (doc) { return ({ id: doc.id }); });\r\n                }\r\n            });\r\n            return clone;\r\n        });\r\n    };\r\n    KedRepo.prototype.insert = function (items) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, getQueryOptions, client, queryOptions, graphs, stripped, br, _loop_1, stripped_1, stripped_1_1, item, res;\r\n            var e_1, _b;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table, getQueryOptions = _a.getQueryOptions;\r\n                        client = getClient();\r\n                        return [4 /*yield*/, getQueryOptions()];\r\n                    case 1:\r\n                        queryOptions = _c.sent();\r\n                        graphs = [].concat(queryOptions.include);\r\n                        // Give IDs to each item:\r\n                        items = items.map(function (item) { return item.id ? item : Object.assign({}, item, { id: createUUID() }); });\r\n                        stripped = this.stripGraphs(items, graphs);\r\n                        if (!optimistic) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.mem.insert(stripped.map(function (x) { return Object.assign({}, x, { $meta: 'adding' }); }))];\r\n                    case 2:\r\n                        _c.sent();\r\n                        _c.label = 3;\r\n                    case 3:\r\n                        br = new BatchRunner();\r\n                        _loop_1 = function (item) {\r\n                            var e_2, _a;\r\n                            var _loop_2 = function (graph) {\r\n                                var foreignItems = item[graph];\r\n                                if (foreignItems) {\r\n                                    foreignItems.forEach(function (doc) {\r\n                                        br.link2(table, item.id, graph, doc.id);\r\n                                    });\r\n                                }\r\n                            };\r\n                            try {\r\n                                // Also add links to all foreign related items:\r\n                                for (var graphs_1 = (e_2 = void 0, tslib_1.__values(graphs)), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\r\n                                    var graph = graphs_1_1.value;\r\n                                    _loop_2(graph);\r\n                                }\r\n                            }\r\n                            catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\r\n                                }\r\n                                finally { if (e_2) throw e_2.error; }\r\n                            }\r\n                            br.add(table, item);\r\n                        };\r\n                        try {\r\n                            for (stripped_1 = tslib_1.__values(stripped), stripped_1_1 = stripped_1.next(); !stripped_1_1.done; stripped_1_1 = stripped_1.next()) {\r\n                                item = stripped_1_1.value;\r\n                                _loop_1(item);\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (stripped_1_1 && !stripped_1_1.done && (_b = stripped_1.return)) _b.call(stripped_1);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        return [4 /*yield*/, client.batch(br.mutationRequests).catch(function (e) {\r\n                                if (optimistic)\r\n                                    _this.mem.delete(items.map(function (item) { return item.id; }));\r\n                                return Promise.reject(e);\r\n                            })];\r\n                    case 4:\r\n                        res = _c.sent();\r\n                        this.regenerateCacheBust();\r\n                        items.forEach(function (item) { return item.$etag = res.newEtags[item.id]; });\r\n                        if (!optimistic) return [3 /*break*/, 6];\r\n                        return [4 /*yield*/, this.mem.update(items)];\r\n                    case 5:\r\n                        _c.sent(); // Update with new $etag.\r\n                        return [3 /*break*/, 8];\r\n                    case 6: return [4 /*yield*/, this.mem.insert(items)];\r\n                    case 7:\r\n                        _c.sent();\r\n                        _c.label = 8;\r\n                    case 8: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.delete = function (ids) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, res;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(ids\r\n                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\r\n                                .filter(function (x) { return x; })\r\n                                .map(function (x) { return Object.assign({}, x, { $meta: 'deleting' }); }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.do(function (br) { return ids.forEach(function (id) { return br.delete(table, id); }); }).catch(function (e) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var _this = this;\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0:\r\n                                        if (!optimistic) return [3 /*break*/, 2];\r\n                                        return [4 /*yield*/, this.mem.update(ids\r\n                                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\r\n                                                .filter(function (x) { return x; })\r\n                                                .map(function (x) {\r\n                                                x = Object.assign({}, x);\r\n                                                delete x.$meta;\r\n                                                return x;\r\n                                            }))];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        _a.label = 2;\r\n                                    case 2: throw e;\r\n                                }\r\n                            });\r\n                        }); })];\r\n                    case 3:\r\n                        res = _b.sent();\r\n                        this.regenerateCacheBust();\r\n                        return [4 /*yield*/, this.mem.delete(ids)];\r\n                    case 4:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedRepo;\r\n}());\r\nexport { KedRepo };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport env from '../globals/KED.env';\r\nimport { getTermStarEndDate } from '../utils/school-moment';\r\nvar KGTermPlannerRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KGTermPlannerRepo, _super);\r\n    function KGTermPlannerRepo(getClient, getCurrentUser) {\r\n        var _this = this;\r\n        var currentUser = getCurrentUser();\r\n        var now = new Date();\r\n        var _a = tslib_1.__read(getTermStarEndDate(now, now.getMonth() >= 7), 2), termStart = _a[0], termEnd = _a[1];\r\n        _this = _super.call(this, {\r\n            getClient: getClient,\r\n            optimistic: true,\r\n            table: \"weekplans\",\r\n            user: currentUser ? currentUser.mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    return [2 /*return*/, {\r\n                            from: termStart.startOf('week').add(-2, 'days').toDate().valueOf(),\r\n                            to: termEnd.startOf('week').add(5, 'days').toDate().valueOf(),\r\n                            role: \"USER\"\r\n                        }];\r\n                });\r\n            }); }\r\n        }) || this;\r\n        return _this;\r\n    }\r\n    return KGTermPlannerRepo;\r\n}(KedRepo));\r\nexport { KGTermPlannerRepo };\r\nexport var termPlannerRepo = new KGTermPlannerRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\r\nenv.kgTermPlannerRepo = termPlannerRepo;\r\n","import env from '../globals/KED.env';\r\nimport { KSTermPlannerRepo } from './ks-termplanner-repo';\r\nexport var termPlannerRepoKS = new KSTermPlannerRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\r\nenv.ksTermPlannerRepo = termPlannerRepoKS;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport moment from 'moment';\r\nvar KSTermPlannerRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KSTermPlannerRepo, _super);\r\n    function KSTermPlannerRepo(getClient, getCurrentUser) {\r\n        var _this = this;\r\n        var currentUser = getCurrentUser();\r\n        _this = _super.call(this, {\r\n            getClient: getClient,\r\n            optimistic: true,\r\n            table: \"weekplans-ks\",\r\n            user: currentUser ? currentUser.mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var startDateValue, endDateValue;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    startDateValue = (this.startDate && this.startDate.valueOf()) || moment().valueOf();\r\n                    endDateValue = (this.endDate && this.endDate.valueOf()) || moment().valueOf();\r\n                    return [2 /*return*/, {\r\n                            from: startDateValue,\r\n                            to: endDateValue,\r\n                            role: \"USER\"\r\n                        }];\r\n                });\r\n            }); }\r\n        }) || this;\r\n        return _this;\r\n    }\r\n    KSTermPlannerRepo.prototype.refreshData = function (dateInterval) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = tslib_1.__read(dateInterval, 2), this.startDate = _a[0], this.endDate = _a[1];\r\n                        return [4 /*yield*/, this.mem.refreshFromServer()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KSTermPlannerRepo;\r\n}(KedRepo));\r\nexport { KSTermPlannerRepo };\r\n","import * as tslib_1 from \"tslib\";\r\nvar Repo = /** @class */ (function () {\r\n    function Repo(comm) {\r\n        this.comm = comm;\r\n        this.listPromise = null;\r\n        this.items = null;\r\n        this.subscribers = [];\r\n    }\r\n    Repo.prototype.subscribe = function (subscriber) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            subscriber(_this.items, _this.error);\r\n            _this.subscribers.push(subscriber);\r\n        });\r\n    };\r\n    Repo.prototype.unsubscribe = function (subscriber) {\r\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\r\n    };\r\n    Repo.prototype.notifySubscribers = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (s) { return s(_this.items, _this.error); });\r\n    };\r\n    Repo.prototype.ensureHasData = function () {\r\n        if (!this.listPromise)\r\n            this.refreshFromServer();\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.refreshFromServer = function () {\r\n        var _this = this;\r\n        this.listPromise = this.comm.query().then(function (items) {\r\n            _this.items = items;\r\n            _this.error = null;\r\n            _this.notifySubscribers();\r\n        }).catch(function (error) {\r\n            _this.error = error;\r\n            _this.items = _this.items || [];\r\n            _this.notifySubscribers();\r\n        });\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.update = function (item) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var updatedItems;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureHasData()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        updatedItems = Array.isArray(item) ? item : [item];\r\n                        this.items = this.items.map(function (it) {\r\n                            var updatedItem = updatedItems.find(function (_a) {\r\n                                var id = _a.id;\r\n                                return it.id === id;\r\n                            });\r\n                            return updatedItem ?\r\n                                Object.assign({}, updatedItem) :\r\n                                it;\r\n                        });\r\n                        this.notifySubscribers();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    Repo.prototype.insert = function (item) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.concat(item);\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    Repo.prototype.delete = function (id) {\r\n        var _this = this;\r\n        var ids = Array.isArray(id) ? id : [id];\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.filter(function (it) { return !ids.some(function (id) { return it.id === id; }); });\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    return Repo;\r\n}());\r\nexport { Repo };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport env from '../globals/KED.env';\r\nimport { WeekPlannerPersistedState } from \"../components/weekplanner/weekplanner-persisted-state\";\r\nimport moment from 'moment';\r\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\r\nimport { KEDWeek } from '../utils/weekutil';\r\nexport var userTasksRepo = env.userTasksRepo;\r\nvar UserTasksRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UserTasksRepo, _super);\r\n    function UserTasksRepo(getClient, getCurrentUser) {\r\n        var _this = _super.call(this, {\r\n            getClient: getClient,\r\n            optimistic: true,\r\n            table: \"usertasks\",\r\n            user: getCurrentUser() ? getCurrentUser().mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var currentUser, userEmail, _a, weekDate, weekNumber, kedWeek;\r\n                return tslib_1.__generator(this, function (_b) {\r\n                    switch (_b.label) {\r\n                        case 0:\r\n                            currentUser = getCurrentUser();\r\n                            userEmail = currentUser ? currentUser.mail : \"\";\r\n                            if (!!this.persistedState) return [3 /*break*/, 2];\r\n                            _a = this;\r\n                            return [4 /*yield*/, WeekPlannerPersistedState.load(userEmail)];\r\n                        case 1:\r\n                            _a.persistedState = _b.sent();\r\n                            _b.label = 2;\r\n                        case 2:\r\n                            weekDate = this.persistedState.weekDate;\r\n                            weekNumber = moment(weekDate).week();\r\n                            kedWeek = KEDWeek(moment(weekDate).year(), weekNumber);\r\n                            /*const [from, to] = [moment(weekDate).startOf('week'), moment(weekDate).endOf('week')]\r\n                              .map(m => m.toDate().getTime());*/\r\n                            return [2 /*return*/, {\r\n                                    from: kedWeek.notBefore,\r\n                                    to: kedWeek.notAfter,\r\n                                    role: \"USER\",\r\n                                    include: [\"task\", \"course\"],\r\n                                    flags: [\"includeIdsOnly\"],\r\n                                }];\r\n                    }\r\n                });\r\n            }); }\r\n        }) || this;\r\n        _this.persistedState = null;\r\n        _this.getCurrentUser = getCurrentUser;\r\n        return _this;\r\n    }\r\n    UserTasksRepo.prototype.updatePersistedState = function (stateChanges) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        Object.assign(this.persistedState, stateChanges);\r\n                        return [4 /*yield*/, this.persistedState.save()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.mem.notifySubscribers();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setTaskDoneState = function (userTask, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, modifiedItem, similarTasks, identicalTasks;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        modifiedItem = Object.assign({}, userTask, { done: done });\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(Object.assign({}, modifiedItem, { $meta: 'updating' }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.list('usertasks', {\r\n                            name: userTask.name,\r\n                            role: \"USER\",\r\n                            include: [\"task\", \"course\"],\r\n                            flags: [\"includeIdsOnly\"],\r\n                            from: moment(this.persistedState.weekDate).add(-3, 'weeks').valueOf(),\r\n                            to: moment(this.persistedState.weekDate).add(3, 'weeks').valueOf()\r\n                        }, {\r\n                            cache: 'no-cache'\r\n                        })];\r\n                    case 3:\r\n                        similarTasks = _b.sent();\r\n                        identicalTasks = similarTasks.filter(function (t) {\r\n                            return t.courseName === userTask.courseName &&\r\n                                t.learningGoal === userTask.learningGoal &&\r\n                                (!userTask.task || t.task.map(function (t) { return t.id; }).join('') === userTask.task.map(function (t) { return t.id; }).join('')) &&\r\n                                (!userTask.course || t.course.map(function (c) { return c.id; }).join('') === userTask.course.map(function (c) { return c.id; }).join(''));\r\n                        });\r\n                        if (identicalTasks.length === 0) {\r\n                            // Workaround for issue in SubjectPlanner migration (usertasks with long names is not found)\r\n                            identicalTasks.push(userTask);\r\n                        }\r\n                        return [4 /*yield*/, this.update(identicalTasks, function (t) { return t.done = done; })];\r\n                    case 4:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setSubTaskDoneState = function (userTask, subTaskId, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        return [4 /*yield*/, this.update([userTask], function (t) { return t.subTasks && t.subTasks.filter(function (st) { return st.id === subTaskId; })\r\n                                .forEach(function (st) { return st.done = done; }); })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setWeekPlannerBoxOpen = function (courseName, isOpen) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var openCourses;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        openCourses = tslib_1.__assign({}, this.persistedState.openCourses);\r\n                        if (isOpen)\r\n                            openCourses[courseName] = true;\r\n                        else\r\n                            delete openCourses[courseName];\r\n                        return [4 /*yield*/, this.updatePersistedState({ openCourses: openCourses })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.changeWeek = function (weekDate, keepCurrentDate) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedState, newPersisted;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        persistedState = this.persistedState;\r\n                        if (!!persistedState) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, WeekPlannerPersistedState.load(this.options.user)];\r\n                    case 1:\r\n                        persistedState = _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        newPersisted = new WeekPlannerPersistedState(persistedState);\r\n                        newPersisted.weekDate = keepCurrentDate ? moment(weekDate).valueOf() : moment(weekDate).startOf('week').valueOf();\r\n                        newPersisted.save();\r\n                        this.persistedState = newPersisted;\r\n                        return [4 /*yield*/, this.mem.refreshFromServer()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.subscribe = function (subscriber) {\r\n        var _this = this;\r\n        var proxySubscriber = function (userTasks) {\r\n            subscriber(userTasks.filter(function (ut) { return !ut.weekTexts; }), _this.persistedState, userTasks.filter(function (ut) { return !!ut.weekTexts; })[0] || {\r\n                id: createUUID(),\r\n                dateTime: _this.persistedState.weekDate,\r\n                weekTexts: { assessment: '', strategy: '' },\r\n                acl: [\r\n                    // Default ACL: Let user self have full control over this item:\r\n                    new DocumentAccess(\"email\", _this.getCurrentUser().mail, \"S\"),\r\n                    // Additional ACL: Let employees on same school have read access to it.\r\n                    // This currently only applies to tasks that refer to course tasks (not own tasks!)\r\n                    new DocumentAccess(\"schoolRole\", _this.getCurrentUser().school + \"/EMPLOYEE\", \"R\")\r\n                ].map(function (ac) { return ac.toString(); })\r\n            });\r\n        };\r\n        proxySubscriber[\"subscriber\"] = subscriber;\r\n        this.mem.subscribe(proxySubscriber);\r\n    };\r\n    UserTasksRepo.prototype.unsubscribe = function (subscriber) {\r\n        this.mem.subscribers = this.mem.subscribers.filter(function (s) { return s[\"subscriber\"] !== subscriber; });\r\n    };\r\n    return UserTasksRepo;\r\n}(KedRepo));\r\nexport { UserTasksRepo };\r\nif (!userTasksRepo) {\r\n    userTasksRepo = env.userTasksRepo = new UserTasksRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\r\n    userTasksRepo.mem.ensureHasData();\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport env from '../globals/KED.env';\r\nexport var weekNotesRepo = env.weekNotesRepo;\r\nvar WeekNotesRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekNotesRepo, _super);\r\n    /*private currentWeek: moment.Moment;\r\n  \r\n    getCurrentWeek() {\r\n      if (!this.currentWeek) {\r\n        const {weekMillis, expire} = JSON.parse(sessionStorage.getItem(\"week-notes-week\") || \"{}\") as {weekMillis?: number, expire?: number};\r\n        this.currentWeek = weekMillis && expire && expire > Date.now() ?\r\n          moment(new Date(weekMillis)) :\r\n          moment().startOf('week').add(1, 'days');\r\n      }\r\n      return this.currentWeek.clone();\r\n    }\r\n  \r\n    setCurrentWeek(newWeekMoment: moment.Moment) {\r\n      this.currentWeek = newWeekMoment;\r\n      sessionStorage.setItem(\"week-notes-week\", JSON.stringify({\r\n        weekMillis: newWeekMoment.toDate().getTime(),\r\n        expire: moment().add(8, \"hours\").toDate().getTime()\r\n      }))\r\n    }*/\r\n    function WeekNotesRepo() {\r\n        var _this = _super.call(this, {\r\n            getClient: function () { return env.kedBackendClient; },\r\n            optimistic: false,\r\n            table: \"notes\",\r\n            user: env.currentUser ? env.currentUser.mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    //const userEmail = env.currentUser ? env.currentUser.mail : \"\";\r\n                    //const currentWeek = this.getCurrentWeek();\r\n                    //const weekNumber = currentWeek.week();\r\n                    //const kedWeek = KEDWeek(currentWeek.year(), weekNumber);\r\n                    return [2 /*return*/, {\r\n                            //from: kedWeek.notBefore,\r\n                            //to: kedWeek.notAfter,\r\n                            role: \"USER\"\r\n                        }];\r\n                });\r\n            }); }\r\n        }) || this;\r\n        return _this;\r\n        //this.currentWeek = null;\r\n    }\r\n    return WeekNotesRepo;\r\n}(KedRepo));\r\nexport { WeekNotesRepo };\r\nif (!weekNotesRepo) {\r\n    weekNotesRepo = env.weekNotesRepo = new WeekNotesRepo();\r\n}\r\n","\r\nexport const SECOND = 1000;\r\nexport const MINUTE = SECOND * 60;\r\nexport const HOUR = MINUTE * 60;\r\n\r\n","import moment from 'moment';\r\nimport { getCurrentAcademicYear } from './generic-school-utils';\r\nimport { LAST_STEP_SPRING, LAST_STEP_AUTUMN } from '../components/ks-termplanner/termplanner-utils';\r\nvar GenericSchoolTerm = /** @class */ (function () {\r\n    function GenericSchoolTerm(currentDate, currentLocale, academicYearStructure) {\r\n        this.locale = currentLocale || \"sv\";\r\n        this.selectedDate = currentDate;\r\n        this.schoolMoment = academicYearStructure ? getCurrentAcademicYear(moment(currentDate), academicYearStructure) : null;\r\n    }\r\n    GenericSchoolTerm.prototype.getTermStartAndEnd = function (includeExtraWeek) {\r\n        //In case that the week start date is a date from the previous year\r\n        //Consider the start of the week ( start date) as the day of the 01.01.year\r\n        var startOfTermWeek = this.schoolMoment.academicYearStructure.startDate.clone().startOf('week');\r\n        if (startOfTermWeek.year() < this.schoolMoment.academicYearStructure.startDate.year()) {\r\n            startOfTermWeek = this.schoolMoment.academicYearStructure.startDate;\r\n        }\r\n        var endOfTermWeek = this.schoolMoment.academicYearStructure.endDate;\r\n        if (this.locale === \"sv\" && includeExtraWeek && this.schoolMoment.term === \"ST\") {\r\n            endOfTermWeek = endOfTermWeek.clone().add(3, 'weeks').endOf('week');\r\n        }\r\n        else if (includeExtraWeek) {\r\n            if (this.locale != \"sv\") {\r\n                // for india the end date can be in the middle of the week\r\n                endOfTermWeek = this.schoolMoment.academicYearStructure.endDate.clone();\r\n            }\r\n            endOfTermWeek = this.schoolMoment.academicYearStructure.endDate.clone().add(1, 'week').endOf('week');\r\n        }\r\n        return [startOfTermWeek, endOfTermWeek];\r\n    };\r\n    GenericSchoolTerm.prototype.getFirstAndLastWeekOfTerm = function () {\r\n        return [this.schoolMoment.academicYearStructure.startDate.week(), this.schoolMoment.academicYearStructure.endDate.week()];\r\n    };\r\n    GenericSchoolTerm.prototype.isCurrentWeek = function (dateTime) {\r\n        var termDate = moment(dateTime);\r\n        return termDate.year() === moment().year() && termDate.week() === moment().week();\r\n    };\r\n    GenericSchoolTerm.prototype.getLastStepWeek = function (locale) {\r\n        //TODO: this should be refactored. The generic method should be used\r\n        if (locale === \"sv\") {\r\n            return this.schoolMoment.term === \"ST\" ? LAST_STEP_SPRING : LAST_STEP_AUTUMN;\r\n        }\r\n        return this.schoolMoment.academicYearStructure.endDate.clone().add(1, \"week\").week();\r\n    };\r\n    GenericSchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\r\n        if (this.schoolMoment) {\r\n            var year = this.schoolMoment.academicYearStructure.endDate.year().toString();\r\n            var academicYear = this.schoolMoment.academicYearStructure.academicYear;\r\n            if (shortYear && intl.locale === 'sv') {\r\n                year = year.substr(2);\r\n            }\r\n            else {\r\n                year = academicYear;\r\n            }\r\n            return this.schoolMoment.term === 'AT' ? intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'HT {year}' }, { year: year }) :\r\n                intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'VT {year}' }, { year: year });\r\n        }\r\n        return null;\r\n    };\r\n    GenericSchoolTerm.prototype.nextTerm = function () {\r\n        //switch to next semester, we set the current date as adding 3 months to the end of the current semester\r\n        var endDate = this.schoolMoment ? this.schoolMoment.academicYearStructure.endDate.clone() : moment();\r\n        var nextDate = endDate.add(3, 'months');\r\n        return new GenericSchoolTerm(nextDate.toDate(), this.locale);\r\n    };\r\n    GenericSchoolTerm.prototype.prevTerm = function () {\r\n        //to switch to next semester, we set the current date as subtracting 3 months from the start of the current semester\r\n        var startDate = this.schoolMoment ? this.schoolMoment.academicYearStructure.startDate.clone() : moment();\r\n        var prevDate = startDate.subtract(3, 'months');\r\n        return new GenericSchoolTerm(prevDate.toDate(), this.locale);\r\n    };\r\n    GenericSchoolTerm.prototype.getEdsPeriodName = function () {\r\n        return (this.schoolMoment.term === 'AT' ? \"HT\" : \"VT\") + this.schoolMoment.academicYearStructure.endDate.year();\r\n    };\r\n    return GenericSchoolTerm;\r\n}());\r\nexport { GenericSchoolTerm };\r\n","import moment from 'moment';\r\nexport function getCurrentAcademicYear(currentDate, academicYear) {\r\n    var firstTermStartDate = moment(new Date(academicYear.firstTerm.startDate));\r\n    var firstTermEndDate = moment(new Date(academicYear.firstTerm.endDate));\r\n    var secondTermStartDate = moment(new Date(academicYear.secondTerm.startDate));\r\n    var secondTermEndDate = moment(new Date(academicYear.secondTerm.endDate));\r\n    var academicPeriod = firstTermStartDate.year().toString().substr(2) + \"/\" + secondTermEndDate.year().toString().substr(2);\r\n    var holidays = _getTermHolidays(academicYear.holidays, firstTermStartDate, firstTermEndDate);\r\n    if (currentDate < firstTermEndDate) {\r\n        //compute academic week numbers\r\n        var academicStartWeek = 1;\r\n        var academicEndWeek = firstTermEndDate.week() - firstTermStartDate.week();\r\n        //get current term holidays\r\n        return { term: 'AT', academicYearStructure: { academicYear: academicPeriod, startDate: firstTermStartDate, endDate: firstTermEndDate, academicStartWeek: academicStartWeek, academicEndWeek: academicEndWeek, holidays: holidays } };\r\n    }\r\n    //compute the number of first term holidays week numbers\r\n    var numberOfHolidayWeeks = _getHolidayWeeksNumber(holidays);\r\n    //compute academic week numbers\r\n    var academicStartWeek = secondTermStartDate.clone().add(1, 'week').week() - firstTermStartDate.week() - numberOfHolidayWeeks;\r\n    var academicEndWeek = secondTermEndDate.clone().add().add(1, 'week').week() - firstTermStartDate.week() - numberOfHolidayWeeks;\r\n    //get current term holidays\r\n    var holidays = _getTermHolidays(academicYear.holidays, secondTermStartDate, secondTermEndDate);\r\n    return { term: 'ST', academicYearStructure: { academicYear: academicPeriod, startDate: secondTermStartDate, endDate: secondTermEndDate, academicStartWeek: academicStartWeek, academicEndWeek: academicEndWeek, holidays: holidays } };\r\n}\r\nexport function getSchoolTranslatedSubjects(schoolLocale, intl) {\r\n    var translatedColumns = {};\r\n    //these are fixed for all school locales\r\n    translatedColumns[\"Kurs\"] = intl.formatMessage({ id: \"termplanner.course\", defaultMessage: \"Kurs\" });\r\n    translatedColumns[\"Kommentar\"] = intl.formatMessage({ id: \"termplanner.comments\", defaultMessage: \"Kommentar\" });\r\n    if (schoolLocale === 'sv') {\r\n        translatedColumns[\"M.spr\"] = intl.formatMessage({ id: \"termplanner.modernLanguage\", defaultMessage: \"M.spr\" });\r\n        translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.maths\", defaultMessage: \"Ma\" });\r\n        translatedColumns[\"Sv/SvA\"] = intl.formatMessage({ id: \"termplanner.swedishLanguage\", defaultMessage: \"Sv/SvA\" });\r\n        translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguage\", defaultMessage: \"Eng\" });\r\n    }\r\n    else {\r\n        translatedColumns[\"MFL\"] = intl.formatMessage({ id: \"termplanner.modernLanguage\", defaultMessage: \"MFL\" });\r\n        translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.maths\", defaultMessage: \"Maths\" });\r\n        translatedColumns[\"Hi\"] = intl.formatMessage({ id: \"termplanner.hindiLanguage\", defaultMessage: \"Hindi\" });\r\n        translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguage\", defaultMessage: \"English\" });\r\n        translatedColumns[\"Yoga\"] = intl.formatMessage({ id: \"termplanner.yoga\", defaultMessage: \"Yoga\" });\r\n        translatedColumns[\"ICT\"] = intl.formatMessage({ id: \"termplanner.ict\", defaultMessage: \"ICT\" });\r\n    }\r\n    return translatedColumns;\r\n}\r\n//this is related to charts. It is used only for sv locale\r\nexport function getSchoolTranslatedSubjectFullname(intl) {\r\n    var translatedColumns = {};\r\n    translatedColumns[\"M.spr\"] = intl.formatMessage({ id: \"termplanner.modernLanguageFullname\", defaultMessage: \"M.språk\" });\r\n    translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.mathsFullname\", defaultMessage: \"Matematik\" });\r\n    translatedColumns[\"Sv/SvA\"] = intl.formatMessage({ id: \"termplanner.swedishLanguageFullName\", defaultMessage: \"Svenska\" });\r\n    translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguageFullName\", defaultMessage: \"Engelska\" });\r\n    return translatedColumns;\r\n}\r\nfunction _getTermHolidays(holidays, termStartDate, termEndDate) {\r\n    return holidays.filter(function (elem) {\r\n        return moment(elem.startDate).isBetween(termStartDate, termEndDate);\r\n    });\r\n}\r\nfunction _getHolidayWeeksNumber(holidays) {\r\n    var numberOfWeeks = 0;\r\n    holidays.forEach(function (elem) {\r\n        //the number of weeks is the difference + 1\r\n        numberOfWeeks += moment(elem.endDate).add(1, 'week').week() - moment(elem.startDate).week();\r\n    });\r\n    return numberOfWeeks;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nexport function ifTakesTime(ms, task, action) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var timeoutReached, th, rv;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    timeoutReached = false;\r\n                    th = setTimeout(function () {\r\n                        timeoutReached = true;\r\n                        action();\r\n                    }, ms);\r\n                    return [4 /*yield*/, task()];\r\n                case 1:\r\n                    rv = _a.sent();\r\n                    if (!timeoutReached)\r\n                        clearTimeout(th);\r\n                    return [2 /*return*/, rv];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar DEFAULT_CACHE_EXPIRATION = 30 * 60 * 1000; // 30 minutes.\r\nvar defaultOptions = {\r\n    isApiMethod: function (f) { return typeof f === 'function'; },\r\n    cacheExpiration: DEFAULT_CACHE_EXPIRATION\r\n};\r\nexport function makeSuspenseApi(api, options) {\r\n    if (options === void 0) { options = defaultOptions; }\r\n    options = tslib_1.__assign({}, defaultOptions, options);\r\n    var isApiMethod = options.isApiMethod, cacheExpiration = options.cacheExpiration;\r\n    var rv = Object.create(api);\r\n    var cache = {};\r\n    // Walk the instance + prototype chain to generate suspense version of each promise returning method\r\n    for (var proto = api; proto && proto !== Object.prototype; proto = Object.getPrototypeOf(proto)) {\r\n        suspendify(proto);\r\n    }\r\n    function suspendify(proto) {\r\n        Object.keys(proto).forEach(function (prop) {\r\n            if (!rv.hasOwnProperty(prop) && isApiMethod(prop)) {\r\n                rv[prop] = function () {\r\n                    var args = [];\r\n                    for (var _i = 0; _i < arguments.length; _i++) {\r\n                        args[_i] = arguments[_i];\r\n                    }\r\n                    var key = JSON.stringify(tslib_1.__spread([prop], args));\r\n                    var cachedEntry = cache[key];\r\n                    if (cachedEntry !== undefined) {\r\n                        if (cachedEntry.promise)\r\n                            throw cachedEntry.promise;\r\n                        if (cachedEntry.error)\r\n                            throw cachedEntry.error;\r\n                        if (cachedEntry.timeout > Date.now()) {\r\n                            return cachedEntry.value;\r\n                        }\r\n                    }\r\n                    try {\r\n                        var promise = proto[prop].apply(api, args).then(function (result) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, value: result };\r\n                        }).catch(function (error) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                        });\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, promise: promise };\r\n                        throw promise;\r\n                    }\r\n                    catch (error) {\r\n                        if (error.then)\r\n                            throw error;\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                    }\r\n                };\r\n            }\r\n        });\r\n    }\r\n    return rv;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar PendingJob = /** @class */ (function () {\r\n    function PendingJob(callback) {\r\n        this.timeoutId = null;\r\n        this.cancelled = false;\r\n        this.pending = false;\r\n        this.isJobExecuting = false;\r\n        this.jobCallback = callback;\r\n    }\r\n    PendingJob.prototype.triggerChange = function (throttle) {\r\n        var _this = this;\r\n        if (this.cancelled)\r\n            return;\r\n        this.pending = true;\r\n        if (this.timeoutId !== null)\r\n            clearTimeout(this.timeoutId);\r\n        this.timeoutId = setTimeout(function () { return _this.launchJob(); }, throttle);\r\n    };\r\n    PendingJob.prototype.stop = function () {\r\n        if (this.timeoutId !== null)\r\n            clearTimeout(this.timeoutId);\r\n        this.timeoutId = null;\r\n        this.cancelled = true;\r\n    };\r\n    PendingJob.prototype.launchJob = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.cancelled)\r\n                            return [2 /*return*/];\r\n                        if (!this.pending)\r\n                            return [2 /*return*/];\r\n                        if (this.isJobExecuting)\r\n                            return [2 /*return*/];\r\n                        this.timeoutId = null;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, , 3, 4]);\r\n                        this.isJobExecuting = true;\r\n                        this.pending = false;\r\n                        return [4 /*yield*/, this.jobCallback()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        this.isJobExecuting = false;\r\n                        return [7 /*endfinally*/];\r\n                    case 4:\r\n                        if (!this.pending) return [3 /*break*/, 6];\r\n                        return [4 /*yield*/, this.launchJob()];\r\n                    case 5:\r\n                        _a.sent();\r\n                        _a.label = 6;\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return PendingJob;\r\n}());\r\nexport { PendingJob };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function parseQueryString(locationSearch, options) {\r\n    var toLower = (options || {}).toLower;\r\n    var result = {};\r\n    if (locationSearch && locationSearch.length > 1)\r\n        locationSearch.substr(1)\r\n            .split('&')\r\n            .map(function (part) { return part.split('=').map(function (s) { return decodeURIComponent(s.trim()); }); })\r\n            .forEach(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];\r\n            return result[toLower ? key.toLowerCase() : key] = value;\r\n        });\r\n    return result;\r\n}\r\nfunction encodeParams(params) {\r\n    return Object.keys(params).filter(function (key) { return params[key] !== undefined; }).map(function (key) { return encodeURIComponent(key) + \"=\" + encodeURIComponent(params[key]); }).join('&');\r\n}\r\nexport function generateQueryString(params) {\r\n    return \"?\" + encodeParams(params);\r\n}\r\nexport function parseHashQueryString(locationHash, options) {\r\n    return parseQueryString(locationHash, options);\r\n}\r\nexport function generateHashQueryString(params) {\r\n    return \"#\" + encodeParams(params);\r\n}\r\nexport function splitUrlAndQuery(urlWithPossibleQuery) {\r\n    var pQuery = urlWithPossibleQuery.indexOf('?');\r\n    return pQuery >= 0 ?\r\n        [urlWithPossibleQuery.substr(0, pQuery), urlWithPossibleQuery.substr(pQuery)] :\r\n        [urlWithPossibleQuery, \"\"];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { KedBackendClient, HttpError } from 'kedbackend/client';\r\nimport { EdsClient } from '../apis/edsclient';\r\nimport { isomorphic } from 'kedbackend/clientweb';\r\nimport { KSTermPlannerRepo } from '../repos/ks-termplanner-repo';\r\nimport { KGTermPlannerRepo } from '../repos/kg-termplanner-repo';\r\nimport { UserTasksRepo } from '../repos/user-tasks-repo';\r\nexport function requestTutoredTokens(userEmail, displayName) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        function createBearerProvider(client, tokenUrl, query) {\r\n            var bearerPromise = null;\r\n            return {\r\n                getBearer: function () {\r\n                    return bearerPromise || this.refreshBearer();\r\n                },\r\n                refreshBearer: function () {\r\n                    return (bearerPromise = retrieveToken());\r\n                },\r\n            };\r\n            function retrieveToken() {\r\n                return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                    var res, _a, _b, _c;\r\n                    return tslib_1.__generator(this, function (_d) {\r\n                        switch (_d.label) {\r\n                            case 0: return [4 /*yield*/, client.get(tokenUrl, query)];\r\n                            case 1:\r\n                                res = _d.sent();\r\n                                if (!(res.status === 200)) return [3 /*break*/, 3];\r\n                                return [4 /*yield*/, res.json()];\r\n                            case 2: return [2 /*return*/, (_d.sent())];\r\n                            case 3:\r\n                                _a = HttpError.bind;\r\n                                _b = [void 0, res.status];\r\n                                _c = \"Could not retrieve tutor token for \" +\r\n                                    userEmail +\r\n                                    \". Error Message: \";\r\n                                return [4 /*yield*/, res.text()];\r\n                            case 4: throw new (_a.apply(HttpError, _b.concat([_c + (_d.sent())])))();\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n        }\r\n        var currentUser, bearerProvider, tutoredKedBackendClient, googleTokenProvider, edsClient, tutorEnv;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    currentUser = {\r\n                        mail: userEmail,\r\n                        displayName: displayName,\r\n                        roles: [\"USER\"],\r\n                        school: env.currentUser.school,\r\n                        tutorFor: userEmail\r\n                    };\r\n                    bearerProvider = createBearerProvider(env.kedBackendClient.http, \"tutor/token\", { userEmail: userEmail });\r\n                    tutoredKedBackendClient = new KedBackendClient(isomorphic, bearerProvider, cfg.KED_API_URL);\r\n                    googleTokenProvider = createBearerProvider(tutoredKedBackendClient.http, \"tutor/convert-token/google\");\r\n                    edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, bearerProvider, function () { return userEmail; });\r\n                    tutorEnv = {\r\n                        currentUser: currentUser,\r\n                        bearerProvider: bearerProvider,\r\n                        edsClient: edsClient,\r\n                        googleTokenProvider: googleTokenProvider,\r\n                        kedBackendClient: tutoredKedBackendClient,\r\n                        tutored: true\r\n                    };\r\n                    tutorEnv.ksTermPlannerRepo = new KSTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\r\n                    tutorEnv.kgTermPlannerRepo = new KGTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\r\n                    tutorEnv.userTasksRepo = new UserTasksRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\r\n                    return [4 /*yield*/, bearerProvider.getBearer().catch(function (error) {\r\n                            console.error(error);\r\n                        })];\r\n                case 1:\r\n                    _a.sent();\r\n                    return [2 /*return*/, tutorEnv];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nexport function getFirstAndLastWeekOfTerm(term) {\r\n    return term === 'AT' ?\r\n        [32, 51] :\r\n        [1, 25];\r\n}\r\n//Not used anymore\r\n// export function getTermStartAndEnd(now: moment.Moment) : moment.Moment[] {\r\n//     return now.month() >= 6 ? // 6 = July in JS Dates and in moment as well!\r\n//     [moment(new Date(now.year(), 7, 1)), moment(new Date(now.year(), 11, 31))] : // aug1 - dec31\r\n//     [moment(new Date(now.year(), 0, 1)), moment(new Date(now.year(), 6, 31))]; // jan1 - july31\r\n// }\r\nexport function getTermStarEndDate(date, isFirstTerm) {\r\n    var addYear = date.getMonth() >= 7;\r\n    var termYear = null;\r\n    if (addYear) {\r\n        termYear = isFirstTerm ? date.getFullYear() : date.getFullYear() + 1;\r\n    }\r\n    else {\r\n        termYear = isFirstTerm ? date.getFullYear() - 1 : date.getFullYear();\r\n    }\r\n    var termYearMoment = moment(termYear.toString(), \"YYYY\");\r\n    if (termYearMoment.week() != 1) {\r\n        termYearMoment = termYearMoment.clone().add(1, 'week');\r\n    }\r\n    return isFirstTerm ? [moment(termYearMoment.clone()).week(32).startOf('week'), moment(termYearMoment.clone()).week(51).endOf('week')] :\r\n        [moment(termYearMoment.clone()), moment(termYearMoment.clone()).week(25).endOf('week')];\r\n}\r\nexport function getSchoolMoment(m) {\r\n    var thisYear = m.year();\r\n    var isAutumn = m.month() >= 6; // determine \r\n    var _a = tslib_1.__read(isAutumn ?\r\n        [thisYear, thisYear + 1] :\r\n        [thisYear - 1, thisYear], 2), autumnYear = _a[0], springYear = _a[1];\r\n    var academicYear = '' + autumnYear + '/' + springYear;\r\n    var term = isAutumn ? 'AT' : 'ST';\r\n    var week = m.week();\r\n    return { academicYear: academicYear, term: term, week: week };\r\n}\r\nexport function addYear(aYear, numYearsToAdd) {\r\n    return aYear.split('/')\r\n        .map(function (yearStr) { return parseInt(yearStr) + numYearsToAdd; })\r\n        .map(function (year) { return '' + year; })\r\n        .join('/');\r\n}\r\nexport function nextAcademicYear(aYear) {\r\n    return addYear(aYear, 1);\r\n}\r\nexport function prevAcademicYear(aYear) {\r\n    return addYear(aYear, -1);\r\n}\r\n","import moment from 'moment';\r\nimport { getSchoolMoment, addYear } from './school-moment';\r\nfunction isSchoolMoment(obj) {\r\n    return 'academicYear' in obj;\r\n}\r\nvar SchoolTerm = /** @class */ (function () {\r\n    function SchoolTerm(dateOrSchoolMoment) {\r\n        var schoolMoment = isSchoolMoment(dateOrSchoolMoment) ?\r\n            dateOrSchoolMoment : getSchoolMoment(moment(dateOrSchoolMoment));\r\n        this.academicYear = schoolMoment.academicYear;\r\n        this.term = schoolMoment.term;\r\n    }\r\n    Object.defineProperty(SchoolTerm.prototype, \"year\", {\r\n        get: function () {\r\n            return parseInt(this.academicYear\r\n                .split('/')[this.term === 'AT' ? 0 : 1]);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    SchoolTerm.prototype.nextTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: this.academicYear\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: addYear(this.academicYear, 1)\r\n            });\r\n    };\r\n    SchoolTerm.prototype.prevTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: addYear(this.academicYear, -1)\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: this.academicYear\r\n            });\r\n    };\r\n    SchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\r\n        var year = this.term === 'AT' ?\r\n            this.academicYear.split('/')[0] :\r\n            this.academicYear.split('/')[1];\r\n        if (shortYear)\r\n            year = year.substr(2);\r\n        return this.term === 'AT' ? intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'HT {year}' }, { year: year }) :\r\n            intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'VT {year}' }, { year: year });\r\n    };\r\n    return SchoolTerm;\r\n}());\r\nexport { SchoolTerm };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function capitalizeFirst(str) {\r\n    for (var i = 0, l = str.length; i < l; ++i) {\r\n        if (str.charCodeAt(i) < 0x2000) {\r\n            return str.substr(0, i) + str[i].toLocaleUpperCase() + str.substr(i + 1);\r\n        }\r\n    }\r\n    return str;\r\n}\r\nexport function extend(obj, extension) {\r\n    if (typeof extension !== 'object')\r\n        return obj;\r\n    Object.keys(extension).forEach(function (key) {\r\n        obj[key] = extension[key];\r\n    });\r\n    return obj;\r\n}\r\nexport function clone(obj, extension) {\r\n    var clone = {};\r\n    Object.getOwnPropertyNames(obj).forEach(function (key) {\r\n        Object.defineProperty(clone, key, Object.getOwnPropertyDescriptor(obj, key));\r\n    });\r\n    if (extension)\r\n        extend(clone, extension);\r\n    return clone;\r\n}\r\nvar concat = [].concat;\r\nexport function flatten(a) {\r\n    return concat.apply([], a);\r\n}\r\nexport function compareProp(prop) {\r\n    return function (a, b) {\r\n        var aProp = a[prop], bProp = b[prop];\r\n        return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n    };\r\n}\r\nexport function compareProps(props, locales, options) {\r\n    props = Array.isArray(props) ? props : [props];\r\n    var localeCompare = function (a, b) {\r\n        return typeof a === 'string' ?\r\n            a.localeCompare(b, locales, options) :\r\n            a < b ? -1 : a > b ? 1 : 0;\r\n    };\r\n    function cmpPart(a, b, firstPart, rest) {\r\n        var firstA = a[firstPart];\r\n        var firstB = b[firstPart];\r\n        if (firstA === firstB)\r\n            return 0;\r\n        if (firstA == null)\r\n            return -1;\r\n        if (firstB == null)\r\n            return 1;\r\n        return rest.length === 0 ?\r\n            localeCompare(firstA, firstB) :\r\n            cmpPart(firstA, firstB, rest[0], rest.slice(1));\r\n    }\r\n    return props\r\n        .map(function (prop) { return prop.split('.'); })\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a), firstPart = _b[0], rest = _b.slice(1);\r\n        return function (a, b) { return cmpPart(a, b, firstPart, rest); };\r\n    })\r\n        .reduce(function (cmp1, cmp2) {\r\n        return function (a, b) { return cmp1(a, b) || cmp2(a, b); };\r\n    });\r\n}\r\nexport function L(text) {\r\n    var args = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        args[_i - 1] = arguments[_i];\r\n    }\r\n    var first = text[0];\r\n    return buildMessage(text, args);\r\n}\r\nfunction buildMessage(text, args) {\r\n    var rv = text[0];\r\n    for (var i = 1, l = text.length; i < l; ++i) {\r\n        rv += args[i - 1] + text[i];\r\n    }\r\n    return rv;\r\n}\r\nvar TC = /** @class */ (function () {\r\n    function TC(template) {\r\n        extend(this, template);\r\n    }\r\n    return TC;\r\n}());\r\nexport { TC };\r\nexport function dateTimeReviver(key, value) {\r\n    var a;\r\n    if (typeof value === 'string') {\r\n        a = /\\/Date\\((\\d*)\\)\\//.exec(value);\r\n        if (a) {\r\n            return new Date(+a[1]);\r\n        }\r\n    }\r\n    return value;\r\n}\r\n//let infoSerial = 1;\r\nexport function showInfo(msg) {\r\n    var event = new CustomEvent('info', { 'detail': msg });\r\n    window.dispatchEvent(event);\r\n}\r\nexport function showError(errMsg) {\r\n    var msg = typeof errMsg === 'string' ? errMsg : errMsg.message;\r\n    var event = new CustomEvent('customerror', { 'detail': msg });\r\n    console.error(errMsg);\r\n    window.dispatchEvent(event);\r\n}\r\nexport function maxLength(str, maxLen) {\r\n    return str.length > maxLen ?\r\n        str.substr(0, maxLen - 3) + \"...\" :\r\n        str;\r\n}\r\nexport function arrayToLookup(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        var array = result[key];\r\n        if (array)\r\n            array.push(item);\r\n        else\r\n            result[key] = [item];\r\n    }\r\n    return result;\r\n}\r\nexport function arrayToMap(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        result[key] = item;\r\n    }\r\n    return result;\r\n}\r\nexport function cherryPickProps(obj, propsToPick) {\r\n    var e_1, _a;\r\n    var result = {};\r\n    try {\r\n        for (var propsToPick_1 = tslib_1.__values(propsToPick), propsToPick_1_1 = propsToPick_1.next(); !propsToPick_1_1.done; propsToPick_1_1 = propsToPick_1.next()) {\r\n            var param = propsToPick_1_1.value;\r\n            if (param in obj)\r\n                result[param] = obj[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (propsToPick_1_1 && !propsToPick_1_1.done && (_a = propsToPick_1.return)) _a.call(propsToPick_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\nexport function distinct(a, keyAccessor) {\r\n    var map = arrayToMap(a, keyAccessor || (function (x) { return x; }));\r\n    return Object.keys(map).map(function (key) { return map[key]; });\r\n}\r\nexport function shallowEquals(a, b) {\r\n    if (a === b)\r\n        return true;\r\n    if (!a || !b)\r\n        return false;\r\n    if (typeof a !== 'object' || typeof b !== 'object')\r\n        return false;\r\n    var keysA = Object.keys(a);\r\n    var keysB = Object.keys(b);\r\n    if (keysA.length !== keysB.length)\r\n        return false;\r\n    for (var i = 0, l = keysA.length; i < l; ++i) {\r\n        var key = keysA[i];\r\n        if (keysB[i] !== key)\r\n            return false;\r\n        if (a[key] !== b[key])\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\n","import moment from \"moment\";\r\nexport function KEDWeek(year, week) {\r\n    var m = moment(new Date(year, 1, 1)).week(week);\r\n    var res = {\r\n        year: year,\r\n        week: week,\r\n        notBefore: m.clone().startOf('week').add(-2, 'days').toDate().getTime(),\r\n        notAfter: m.clone().startOf('week').add(5, 'days').toDate().getTime()\r\n    };\r\n    return res;\r\n}\r\nexport function getNextWeekDate(date) {\r\n    var nextDate = moment(date).add(1, 'week');\r\n    //Set the 01.01 of the next year in case the next week is in the same year \r\n    //and the previous week is the last week of the year\r\n    if (date.week() === date.weeksInYear() && nextDate.year() === date.year()) {\r\n        return { adjusted: true, nextDate: moment(date.year() + 1 + \"-01-01\").toDate() };\r\n    }\r\n    return { adjusted: false, nextDate: nextDate.toDate() };\r\n}\r\nexport function getPrevWeekDate(date) {\r\n    var prevDate = moment(date).add(-1, 'week');\r\n    //Set the 01.01 of the current year in case the prev week is in the previous year\r\n    if (date.week() === 2 && prevDate.year() !== date.year()) {\r\n        return { adjusted: true, nextDate: moment(date.year() + \"-01-01\").toDate() };\r\n    }\r\n    return { adjusted: false, nextDate: prevDate.toDate() };\r\n}\r\nexport function getAdjustedWeek(m) {\r\n    var clone = m.clone();\r\n    return m.weekday() >= 5 ? // Lördag 00:00 / Söndag 00:00?\r\n        m.week() + 1 : // Tillhör nästa vecka\r\n        m.week();\r\n}\r\n/*export function getWeekLimits (m: Moment) {\r\n  const clonedSwedish = m.clone().locale('sv');\r\n  const limits = {\r\n    notBefore: clonedSwedish.startOf('week').add(-2, 'days'),\r\n    notAfter: clonedSwedish.startOf('week').add(5, 'days')\r\n  };\r\n}\r\n*/\r\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AClBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACnPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC1FA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/JA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3NA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9NA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjCA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACPA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrVA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;ACFA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9IA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5GA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9bA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClFA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxCA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3HA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtGA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvRA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzcA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5QA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/QA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtMA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}