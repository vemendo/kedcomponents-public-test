{"version":3,"file":"kedcomponents.js","sources":["webpack://[name]/webpack/bootstrap","webpack://[name]/./kedbackend/client.js","webpack://[name]/./kedbackend/clientweb.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/bearer-storage-sessionstorage.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/hash-restorer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/access-control.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/http-error.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/ked-bearer-provider.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/restclient.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/cache-bust.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/apply-mutations-on-deltas.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-cache.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-merge.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-query.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-repo.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-subscription.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-writer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/mutation-queue.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/query-set.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-course.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-task.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate.js","webpack://[name]/./kedbackend/js/dist/js/observable/collection.js","webpack://[name]/./kedbackend/js/dist/js/observable/emitter.js","webpack://[name]/./kedbackend/js/dist/js/observable/fiber-context.js","webpack://[name]/./kedbackend/js/dist/js/observable/index.js","webpack://[name]/./kedbackend/js/dist/js/observable/map.js","webpack://[name]/./kedbackend/js/dist/js/observable/mixin.js","webpack://[name]/./kedbackend/js/dist/js/observable/observable.js","webpack://[name]/./kedbackend/js/dist/js/observable/value.js","webpack://[name]/./kedbackend/observable.js","webpack://[name]/./kedbackend/repo.js","webpack://[name]/./src/access-control/get-user-claims.ts","webpack://[name]/./src/access-control/index.ts","webpack://[name]/./src/apis/edsclient.ts","webpack://[name]/./src/apis/google-calendar.ts","webpack://[name]/./src/apis/google-client.ts","webpack://[name]/./src/apis/ked-learninggoals.ts","webpack://[name]/./src/components/calendar/calendar-self.tsx","webpack://[name]/./src/components/calendar/calendar-tutored.tsx","webpack://[name]/./src/components/calendar/course-name-to-css-class.ts","webpack://[name]/./src/components/calendar/crunch-colliding-events.ts","webpack://[name]/./src/components/calendar/day-view-event.tsx","webpack://[name]/./src/components/calendar/day-view.tsx","webpack://[name]/./src/components/calendar/hour-marker.tsx","webpack://[name]/./src/components/calendar/index.tsx","webpack://[name]/./src/components/calendar/should-include-calendar.ts","webpack://[name]/./src/components/calendar/status-bar.tsx","webpack://[name]/./src/components/calendar/time-lines.tsx","webpack://[name]/./src/components/calendar/week-view.tsx","webpack://[name]/./src/components/charts/charts-utils.ts","webpack://[name]/./src/components/charts/doughnut.tsx","webpack://[name]/./src/components/charts/goal-progress.tsx","webpack://[name]/./src/components/charts/progress.tsx","webpack://[name]/./src/components/course-builder-ks/common/dialog-context.ts","webpack://[name]/./src/components/course-builder/sub-components/ellipsis-loader.tsx","webpack://[name]/./src/components/course-builder/sub-components/remove-item.tsx","webpack://[name]/./src/components/course-builder/sub-components/spinner.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/confirmation.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/learning-goals-list.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/task-list.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner-self.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner-tutored.tsx","webpack://[name]/./src/components/kg-termplanner/kg-termplanner.tsx","webpack://[name]/./src/components/kg-termplanner/week-note-dialog.tsx","webpack://[name]/./src/components/ks-goals/future-abilities-table.tsx","webpack://[name]/./src/components/ks-goals/future-abilities-viewmodel.ts","webpack://[name]/./src/components/ks-goals/goals-viewmodel.ts","webpack://[name]/./src/components/ks-goals/goals.tsx","webpack://[name]/./src/components/ks-termplanner/ks-termplanner-self.tsx","webpack://[name]/./src/components/ks-termplanner/ks-termplanner-tutored.tsx","webpack://[name]/./src/components/ks-termplanner/termplanner-utils.ts","webpack://[name]/./src/components/ks-termplanner/termplanner.tsx","webpack://[name]/./src/components/ks-termplanner/tutor-dialog.tsx","webpack://[name]/./src/components/ks-termplanner/viewmodel.ts","webpack://[name]/./src/components/latest-assessments/latest-assessments.tsx","webpack://[name]/./src/components/learning-tasks/index.tsx","webpack://[name]/./src/components/list-courses/list-courses.tsx","webpack://[name]/./src/components/my-courses/my-courses.tsx","webpack://[name]/./src/components/my-subjects/my-subjects-inner.tsx","webpack://[name]/./src/components/my-subjects/my-subjects.tsx","webpack://[name]/./src/components/tutors-select/tutors-select.tsx","webpack://[name]/./src/components/utility-components/LanguageContext.tsx","webpack://[name]/./src/components/utility-components/SetupLanguageIntl.tsx","webpack://[name]/./src/components/utility-components/align-horizontal.tsx","webpack://[name]/./src/components/utility-components/checkbox.tsx","webpack://[name]/./src/components/utility-components/content-editable-field.tsx","webpack://[name]/./src/components/utility-components/dialogs.tsx","webpack://[name]/./src/components/utility-components/form-field-text-input.tsx","webpack://[name]/./src/components/utility-components/form-field-textarea.tsx","webpack://[name]/./src/components/utility-components/form-field.tsx","webpack://[name]/./src/components/utility-components/horizontal-item.tsx","webpack://[name]/./src/components/utility-components/observe.tsx","webpack://[name]/./src/components/utility-components/open-close-box.tsx","webpack://[name]/./src/components/utility-components/tutorable-component.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/action-helpers/insert-element.ts","webpack://[name]/./src/components/utility-components/wysiwyg/action-helpers/insert-image.ts","webpack://[name]/./src/components/utility-components/wysiwyg/action-helpers/link-dialog.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/action-helpers/open-link-dialog.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/actions-sv.ts","webpack://[name]/./src/components/utility-components/wysiwyg/actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/exec.ts","webpack://[name]/./src/components/utility-components/wysiwyg/html-patch-policy.ts","webpack://[name]/./src/components/utility-components/wysiwyg/image-edit-actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/index.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/restore-selection.ts","webpack://[name]/./src/components/utility-components/wysiwyg/wash-html.ts","webpack://[name]/./src/components/week-notebook/index.ts","webpack://[name]/./src/components/week-notebook/root-week-notebook.tsx","webpack://[name]/./src/components/week-notebook/week-notebook.tsx","webpack://[name]/./src/components/weekplanner/add-custom-goal.tsx","webpack://[name]/./src/components/weekplanner/add-custom-task.tsx","webpack://[name]/./src/components/weekplanner/add-or-edit-sub-task.tsx","webpack://[name]/./src/components/weekplanner/edit-user-task.tsx","webpack://[name]/./src/components/weekplanner/get-task-type.ts","webpack://[name]/./src/components/weekplanner/refiner.ts","webpack://[name]/./src/components/weekplanner/user-tasks-box.tsx","webpack://[name]/./src/components/weekplanner/weekplanner-persisted-state.ts","webpack://[name]/./src/components/weekplanner/weekplanner-self.tsx","webpack://[name]/./src/components/weekplanner/weekplanner-tutored.tsx","webpack://[name]/./src/components/weekplanner/weekplanner.tsx","webpack://[name]/./src/elements/KEDComponents/kedcomponents.client.ts","webpack://[name]/./src/elements/KEDComponents/kedcomponents.ts","webpack://[name]/./src/elements/KEDComponents/webpack-entry.ts","webpack://[name]/./src/features/features.ts","webpack://[name]/./src/features/index.ts","webpack://[name]/./src/global-setters/configure.ts","webpack://[name]/./src/global-setters/set-all.ts","webpack://[name]/./src/global-setters/set-bearer-providers.ts","webpack://[name]/./src/global-setters/set-eds-client.ts","webpack://[name]/./src/global-setters/set-ked-backend-client.ts","webpack://[name]/./src/globals/KED.cfg.ts","webpack://[name]/./src/globals/KED.env.ts","webpack://[name]/./src/globals/KED.ts","webpack://[name]/./src/globals/KED.tutorEnv.ts","webpack://[name]/./src/globals/db.ts","webpack://[name]/./src/globals/ked.ts","webpack://[name]/./src/globals/moment-sv-locale.ts","webpack://[name]/./src/repos/hidden-courses-repo.ts","webpack://[name]/./src/repos/ked-repo.ts","webpack://[name]/./src/repos/kg-termplanner-repo.ts","webpack://[name]/./src/repos/ks-termplanner-repo-instance.ts","webpack://[name]/./src/repos/ks-termplanner-repo.ts","webpack://[name]/./src/repos/repo.ts","webpack://[name]/./src/repos/user-tasks-repo.ts","webpack://[name]/./src/repos/week-notes-repo.ts","webpack://[name]/./src/utils/constants.js","webpack://[name]/./src/utils/generic-school-term.ts","webpack://[name]/./src/utils/generic-school-utils.ts","webpack://[name]/./src/utils/if-takes-time.ts","webpack://[name]/./src/utils/make-suspense-api.ts","webpack://[name]/./src/utils/pending-job.ts","webpack://[name]/./src/utils/query-string.ts","webpack://[name]/./src/utils/request-tutored-tokens.ts","webpack://[name]/./src/utils/school-moment.ts","webpack://[name]/./src/utils/school-term.ts","webpack://[name]/./src/utils/utils.ts","webpack://[name]/./src/utils/weekutil.ts"],"sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"kedcomponents\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp_name_\"] = window[\"webpackJsonp_name_\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([\"./src/elements/KEDComponents/webpack-entry.ts\",\"vendors\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","export * from './js/dist/js/ked-backend-client';","export * from './js/dist/js/ked-backend-client-web';","var BearerStorageSessionStorage = /** @class */ (function () {\n    function BearerStorageSessionStorage() {\n    }\n    BearerStorageSessionStorage.prototype.save = function (id, tokenInfo) {\n        sessionStorage.setItem(\"bearer-\" + id, JSON.stringify(tokenInfo));\n    };\n    BearerStorageSessionStorage.prototype.load = function (id) {\n        try {\n            var json = sessionStorage.getItem(\"bearer-\" + id);\n            return Promise.resolve(json ? JSON.parse(json) : { token: null, expires: 0 });\n        }\n        catch (ex) {\n            return Promise.resolve({ token: null, expires: 0 });\n        }\n    };\n    return BearerStorageSessionStorage;\n}());\nexport { BearerStorageSessionStorage };\n//# sourceMappingURL=bearer-storage-sessionstorage.js.map","var redirHash = sessionStorage.getItem(\"redir-hash\");\nif (redirHash)\n    try {\n        var _a = JSON.parse(redirHash), time = _a.time, hash = _a.hash;\n        if (time && time > Date.now() - 60000) {\n            sessionStorage.removeItem(\"redir-hash\");\n            location.hash = hash;\n        }\n    }\n    catch (_) { }\nexport function rememberHashLocation() {\n    sessionStorage.setItem(\"redir-hash\", JSON.stringify({ time: Date.now(), hash: location.hash }));\n}\n//# sourceMappingURL=hash-restorer.js.map","import * as tslib_1 from \"tslib\";\nimport { KedBackendClient, HttpError } from '../ked-backend-client';\nimport { BearerStorageSessionStorage } from \"./bearer-storage-sessionstorage\";\nimport { avoidSimultanousCalls } from '../ked-backend-client/utils';\nimport { KedModelMigratorMixin } from '../ked-model-migrator';\nimport './hash-restorer';\nimport { rememberHashLocation } from './hash-restorer';\nKedModelMigratorMixin(KedBackendClient.prototype);\nexport var storage = new BearerStorageSessionStorage();\nvar timeOfPageLoad = Date.now();\nvar WebServerBearerProvider = /** @class */ (function () {\n    function WebServerBearerProvider(tokenPath, tokenResponseMapper, tokenId) {\n        this.tokenPath = tokenPath;\n        this.tokenResponseMapper = tokenResponseMapper;\n        this.tokenId = tokenId;\n        this.tokenInfo = { token: null, expires: 0 };\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\n    }\n    WebServerBearerProvider.prototype.getBearer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        if (!!this.tokenInfo.token) return [3 /*break*/, 2];\n                        if (!this.tokenId) return [3 /*break*/, 2];\n                        _a = this;\n                        return [4 /*yield*/, storage.load(this.tokenId)];\n                    case 1:\n                        _a.tokenInfo = _b.sent();\n                        _b.label = 2;\n                    case 2:\n                        if (!(this.tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\n                        return [4 /*yield*/, this.refreshBearer()];\n                    case 3:\n                        _b.sent();\n                        _b.label = 4;\n                    case 4: return [2 /*return*/, this.tokenInfo];\n                }\n            });\n        });\n    };\n    WebServerBearerProvider.prototype.refreshBearer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, _c, _d;\n            return tslib_1.__generator(this, function (_e) {\n                switch (_e.label) {\n                    case 0: return [4 /*yield*/, fetch(this.tokenPath, {\n                            headers: { Accept: \"text/plain; application/json\" },\n                            redirect: 'manual',\n                            cache: 'no-cache',\n                            credentials: \"same-origin\"\n                        })];\n                    case 1:\n                        res = _e.sent();\n                        if (res.status === 302 || (!res.status && res.type === \"opaqueredirect\")) {\n                            // User session timed out and server wants to redirect entire page to login page\n                            // Time to reload current page to force a redirect of the entire page instead for\n                            // just redirecting to /api/token or whatever.\n                            if (Date.now() - timeOfPageLoad > 60000) { // prohibit endless loop of reloading self.\n                                this.wantsRedirect = true; // So that listeners to onbeforeunload could show alternate message.\n                                console.log(\"Redirect wanted. Reload page.\");\n                                rememberHashLocation();\n                                window.location.reload(true);\n                                throw new HttpError(302, \"Redirected\");\n                            }\n                        }\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = Error.bind;\n                        _b = \"HTTP\" + res.status + \" \";\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(Error, [void 0, _b + (_e.sent())]))();\n                    case 3:\n                        _c = this;\n                        _d = this.tokenResponseMapper;\n                        return [4 /*yield*/, res.text()];\n                    case 4:\n                        _c.tokenInfo = _d.apply(this, [_e.sent()]);\n                        storage.save(this.tokenId, this.tokenInfo);\n                        return [2 /*return*/, this.tokenInfo];\n                }\n            });\n        });\n    };\n    return WebServerBearerProvider;\n}());\nexport { WebServerBearerProvider };\nexport var isomorphic = { fetch: fetch.bind(self), btoa: btoa.bind(self) };\nvar KedBackendClientWeb = /** @class */ (function (_super) {\n    tslib_1.__extends(KedBackendClientWeb, _super);\n    function KedBackendClientWeb(apiBaseUrl, providerOrTokenPath, options) {\n        var _this = this;\n        var bearerProvider = typeof providerOrTokenPath !== 'string' ?\n            providerOrTokenPath :\n            new WebServerBearerProvider(providerOrTokenPath, (options && options.tokenResponseMapper) || (function (x) { return ({ token: x, expires: Date.now() + 59 * 60 * 60 }); }), options && options.tokenId);\n        _this = _super.call(this, isomorphic, bearerProvider, apiBaseUrl) || this;\n        return _this;\n    }\n    return KedBackendClientWeb;\n}(KedBackendClient));\nexport { KedBackendClientWeb };\n//# sourceMappingURL=index.js.map","var DocumentAccess = /** @class */ (function () {\n    function DocumentAccess(accessClaimType, accessClaimValue, right) {\n        this.accessClaimType = accessClaimType;\n        this.accessClaimValue = accessClaimValue;\n        this.right = right;\n    }\n    DocumentAccess.fromString = function (ac) {\n        if (!ac)\n            return null;\n        var split = ac.split(':');\n        if (split.length < 3)\n            throw new Error(\"Invalid access string: \" + ac);\n        var claimType = DocumentAccess.unescape(split[0]);\n        var claimValue = DocumentAccess.unescape(split[1]);\n        var right = split[2];\n        if (right !== 'R' && right !== 'W' && right !== 'S')\n            throw new Error(\"Invalid access string: \" + ac);\n        return new DocumentAccess(claimType, claimValue, right);\n    };\n    DocumentAccess.escape = function (accessComponent) {\n        return accessComponent.replace(/\\%/g, \"%25\").replace(/\\:/g, \"%3A\");\n    };\n    DocumentAccess.unescape = function (accessComponent) {\n        return accessComponent.replace(/\\%3A/g, \":\").replace(/\\%25/g, \"%\");\n    };\n    DocumentAccess.prototype.toString = function () {\n        return DocumentAccess.escape(this.accessClaimType) + \":\" +\n            DocumentAccess.escape(this.accessClaimValue) + \":\" +\n            this.right;\n    };\n    DocumentAccess.fromStringArray = function (acl) {\n        return acl\n            .map(function (ac) { return DocumentAccess.fromString(ac); })\n            .filter(function (ac) { return ac; });\n    };\n    DocumentAccess.toStringArray = function (acl) {\n        return acl.map(function (ac) { return ac.toString(); });\n    };\n    return DocumentAccess;\n}());\nexport { DocumentAccess };\nexport function hasAccess(acl, userClaims, requestedRight) {\n    if (userClaims.some(function (claim) { return claim.type === 'role' && claim.value === \"ADMIN\"; }))\n        return true;\n    return acl.some(function (a) {\n        return userClaims.some(function (c) {\n            return a.accessClaimType === c.type &&\n                a.accessClaimValue === c.value && ((a.right === 'R' && requestedRight === 'R') ||\n                (a.right === 'W' && ['R', 'W'].indexOf(requestedRight) >= 0) ||\n                (a.right === 'S'));\n        });\n    });\n}\n//# sourceMappingURL=access-control.js.map","import * as tslib_1 from \"tslib\";\nvar HttpError = /** @class */ (function (_super) {\n    tslib_1.__extends(HttpError, _super);\n    function HttpError(code, message) {\n        var _this = _super.call(this, \"HTTP\" + code + \" \" + message) || this;\n        _this.code = code;\n        _this.message = message;\n        _this.name = \"http\" + code;\n        _this.message = \"HTTP\" + code + \" \" + message;\n        return _this;\n    }\n    return HttpError;\n}(Error));\nexport { HttpError };\n//# sourceMappingURL=http-error.js.map","import * as tslib_1 from \"tslib\";\nimport { RestClient } from './restclient';\nexport * from './utils';\nexport { KedBearerProvider } from './ked-bearer-provider';\nexport * from './access-control';\nexport { RestClient };\nimport { HttpError } from './http-error';\nexport { HttpError };\nexport * from './restclient';\nimport * as schema from 'kedbackend-schema/schema.json';\n;\n// | 'otherFlag' | 'thirdFlag';...\nvar KedBackendClient = /** @class */ (function () {\n    function KedBackendClient(isomorphic, bearerProvider, baseUrl) {\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\n    }\n    KedBackendClient.prototype.getMyClaims = function (table, fetchOptions) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"me/claims/\" + (table || \"\"), null, fetchOptions)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.get = function (table, id, options, fetchOptions) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(table + \"/\" + id, options, fetchOptions)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.list = function (table, options, fetchOptions) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var query, tableSchema_1, includedTables, res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        query = tslib_1.__assign({}, options);\n                        if (typeof location === 'undefined' || !location.search.includes('dontUseSP')) {\n                            tableSchema_1 = schema.tables[table];\n                            includedTables = null;\n                            if (options.include) {\n                                if (tableSchema_1)\n                                    includedTables = [].concat(options.include)\n                                        .filter(function (graph) { return graph !== 'acl'; })\n                                        .map(function (graph) { return tableSchema_1.relationships[graph]; });\n                            }\n                            if (!query.from &&\n                                !query.to &&\n                                [query.hasEdgesFrom, query.hasEdgesTo, query.ids].filter(function (x) { return !!x; }).length <= 1 &&\n                                (tableSchema_1 && tableSchema_1.isPublic) &&\n                                (!includedTables || includedTables.every(function (table) { return schema.tables[table] && schema.tables[table].isPublic; }))) {\n                                query.flags = (query.flags || []).concat(['useSP']);\n                            }\n                        }\n                        if (options && options.mutationsOnEmpty)\n                            query.mutationsOnEmpty = JSON.stringify(options.mutationsOnEmpty);\n                        return [4 /*yield*/, this.http.get(\"\" + table, query, fetchOptions)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.batch = function (reqs, fetchOptions) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        // Reorder operations so that 'add's come first and 'delete's come last:\n                        reqs = reqs.slice().sort(function (req1, req2) {\n                            return req1.op === 'add' ? -1 : req2.op === 'add' ? 1 :\n                                req1.op === 'delete' ? 1 : req2.op === 'delete' ? -1 : 0;\n                        });\n                        return [4 /*yield*/, this.http.post(\"batch\", reqs, fetchOptions)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.do = function (scopeFn) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var runner;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        runner = new BatchRunner();\n                        scopeFn(runner);\n                        return [4 /*yield*/, this.batch(runner.mutationRequests)];\n                    case 1: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.deleteRealm = function (realm) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.delete(\"realms/\" + realm)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    KedBackendClient.prototype.add = function (table, doc, branchId) {\n        return this.do(function (r) { return r.add(table, doc); });\n    };\n    KedBackendClient.prototype.put = function (table, doc) {\n        return this.do(function (r) { return r.put(table, doc); });\n    };\n    KedBackendClient.prototype.update = function (table, id, deltaDoc, branchId) {\n        return this.do(function (r) { return r.update(table, id, deltaDoc, branchId); });\n    };\n    KedBackendClient.prototype.merge = function (branchId, targetBranchId) {\n        return this.do(function (r) { return r.merge(branchId, targetBranchId); });\n    };\n    KedBackendClient.prototype.clearBranch = function (branchId) {\n        return this.do(function (r) { return r.clearBranch(branchId); });\n    };\n    KedBackendClient.prototype.delete = function (table, id) {\n        return this.do(function (r) { return r.delete(table, id); });\n    };\n    KedBackendClient.prototype.share = function (table, id, acl) {\n        return this.do(function (r) { return r.share(table, id, acl); });\n    };\n    KedBackendClient.prototype.unshare = function (table, id, acl) {\n        return this.do(function (r) { return r.unshare(table, id, acl); });\n    };\n    KedBackendClient.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\n        return this.do(function (r) { return r.link(sourceTable, sourceId, targetTable, targetId, label); });\n    };\n    KedBackendClient.prototype.link2 = function (sourceTable, sourceId, targetId, label, branchId) {\n        return this.do(function (r) { return r.link2(sourceTable, sourceId, label, targetId, branchId); });\n    };\n    KedBackendClient.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\n        return this.do(function (r) { return r.unlink(sourceTable, sourceId, targetTable, targetId, label); });\n    };\n    KedBackendClient.prototype.unlink2 = function (sourceTable, sourceId, targetId, label, branchId) {\n        return this.do(function (r) { return r.unlink2(sourceTable, sourceId, label, targetId, branchId); });\n    };\n    KedBackendClient.prototype.undoLink = function (sourceTable, sourceId, targetId, label, branchId) {\n        return this.do(function (r) { return r.undoLink(sourceTable, sourceId, label, targetId, branchId); });\n    };\n    return KedBackendClient;\n}());\nexport { KedBackendClient };\nvar BatchRunner = /** @class */ (function () {\n    function BatchRunner() {\n        this.mutationRequests = [];\n    }\n    BatchRunner.prototype.add = function (table, doc, branchId) {\n        this.mutationRequests.push({ op: 'add', table: table, doc: doc, branchId: branchId });\n        return this;\n    };\n    BatchRunner.prototype.put = function (table, doc) {\n        doc = tslib_1.__assign({}, doc);\n        delete doc.acl; // Forbidden to send acl with put() calls.\n        this.mutationRequests.push({ op: 'put', table: table, doc: doc });\n        return this;\n    };\n    BatchRunner.prototype.update = function (table, id, deltaDoc, branchId) {\n        deltaDoc = tslib_1.__assign({}, deltaDoc);\n        this.mutationRequests.push({ op: 'update', table: table, id: id, deltaDoc: deltaDoc, branchId: branchId });\n    };\n    BatchRunner.prototype.merge = function (branchId, targetBranchId) {\n        this.mutationRequests.push({ op: 'merge', branchId: branchId, targetBranchId: targetBranchId });\n    };\n    BatchRunner.prototype.clearBranch = function (branchId) {\n        this.mutationRequests.push({ op: 'clear-branch', branchId: branchId });\n    };\n    BatchRunner.prototype.delete = function (table, id) {\n        this.mutationRequests.push({ op: 'delete', table: table, id: id });\n        return this;\n    };\n    BatchRunner.prototype.share = function (table, id, acl) {\n        this.mutationRequests.push({ op: 'share', table: table, id: id, acl: acl });\n        return this;\n    };\n    BatchRunner.prototype.unshare = function (table, id, acl) {\n        this.mutationRequests.push({ op: 'unshare', table: table, id: id, acl: acl });\n        return this;\n    };\n    BatchRunner.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\n        return this;\n    };\n    BatchRunner.prototype.link2 = function (sourceTable, sourceId, label, targetId, branchId) {\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\n    };\n    BatchRunner.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\n        return this;\n    };\n    BatchRunner.prototype.unlink2 = function (sourceTable, sourceId, label, targetId, branchId) {\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\n        return this;\n    };\n    BatchRunner.prototype.undoLink = function (sourceTable, sourceId, label, targetId, branchId) {\n        this.mutationRequests.push({ op: 'undo-link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\n    };\n    return BatchRunner;\n}());\nexport { BatchRunner };\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\nimport { RestClient } from './restclient';\nimport { avoidSimultanousCalls } from './utils';\nvar KedBearerProvider = /** @class */ (function () {\n    function KedBearerProvider(isomorphic, storage, tokenId, clientId, clientSecret, tokenUrl, tokenQuery) {\n        this.isomorphic = isomorphic;\n        this.storage = storage;\n        this.tokenId = tokenId;\n        this.clientId = clientId;\n        this.clientSecret = clientSecret;\n        this.tokenUrl = tokenUrl;\n        this.tokenQuery = tokenQuery;\n        this.tokenInfo = { token: null, expires: 0 };\n        this.client = new RestClient(isomorphic, \"\", {\n            username: this.clientId,\n            password: this.clientSecret\n        });\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\n    }\n    KedBearerProvider.prototype.getBearer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, token, expires, _b, e_1;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = this.tokenInfo, token = _a.token, expires = _a.expires;\n                        if (token && expires >= Date.now())\n                            return [2 /*return*/, this.tokenInfo];\n                        _c.label = 1;\n                    case 1:\n                        _c.trys.push([1, 4, , 6]);\n                        _b = this;\n                        return [4 /*yield*/, this.storage.load(this.clientId + \"/\" + this.tokenId)];\n                    case 2:\n                        _b.tokenInfo = _c.sent();\n                        if (this.tokenInfo.token && this.tokenInfo.expires >= Date.now())\n                            return [2 /*return*/, this.tokenInfo];\n                        return [4 /*yield*/, this.refreshBearer()];\n                    case 3:\n                        _c.sent();\n                        return [2 /*return*/, this.tokenInfo];\n                    case 4:\n                        e_1 = _c.sent();\n                        return [4 /*yield*/, this.refreshBearer()];\n                    case 5:\n                        _c.sent();\n                        return [2 /*return*/, this.tokenInfo];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBearerProvider.prototype.refreshBearer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, retries, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        retries = 0;\n                        _c.label = 1;\n                    case 1:\n                        if (!(retries < 6)) return [3 /*break*/, 5];\n                        console.log(\"Retrieving token for \" + this.tokenId);\n                        return [4 /*yield*/, this.client.get(this.tokenUrl, this.tokenQuery, { cache: 'reload' })];\n                    case 2:\n                        res = _c.sent();\n                        if (res.status !== 200) {\n                            console.warn(\"Got \" + res.status + \" \" + res.statusText);\n                            return [3 /*break*/, 4];\n                        }\n                        _a = this;\n                        _b = {};\n                        return [4 /*yield*/, res.text()];\n                    case 3:\n                        _a.tokenInfo = (_b.token = _c.sent(), _b.expires = Date.now() + 59 * 60 * 1000, _b);\n                        console.log(\"Got token for \" + this.tokenId + \": \" + JSON.stringify(this.tokenInfo));\n                        this.storage.save(this.clientId + \"/\" + this.tokenId, this.tokenInfo);\n                        return [2 /*return*/, this.tokenInfo];\n                    case 4:\n                        ++retries;\n                        return [3 /*break*/, 1];\n                    case 5: throw new Error(\"Failed to retrieve token for \" + JSON.stringify(this.tokenId));\n                }\n            });\n        });\n    };\n    return KedBearerProvider;\n}());\nexport { KedBearerProvider };\n//# sourceMappingURL=ked-bearer-provider.js.map","/*\ndeclare var Buffer; // node built-in\n\n\nfunction basicAuthHeader(username, password) {\n    return \"Basic \" + new Buffer(username + \":\" + password).toString(\"base64\");\n}\n*/\nimport * as tslib_1 from \"tslib\";\nimport { createUUID } from \"./utils\";\nimport { Emitter } from '../observable/emitter';\nvar RestClient = /** @class */ (function () {\n    function RestClient(isomorphic, baseUrl, options) {\n        this.isomorphic = isomorphic;\n        this.baseUrl = baseUrl;\n        this.options = options;\n        this.numOutstandingOperations = 0;\n        this.cache = {}; //, timeout: number}};\n        this._status = new Emitter(this);\n        this.fetchOptions = { mode: 'cors' };\n        this.authHeader = options.bearer ?\n            \"Bearer \" + options.bearer :\n            options.username ?\n                \"Basic \" + isomorphic.btoa(options.username + \":\" + (options.password || \"\")) :\n                null;\n        this.bearerProvider = options.bearerProvider || null;\n    }\n    Object.defineProperty(RestClient.prototype, \"status\", {\n        get: function () {\n            return this._status;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    RestClient.prototype.suspenseFetch = function (path, method, headers, query, fetchOptions) {\n        var _this = this;\n        var key = method + \" \" + path + \" \" + JSON.stringify(headers) + \" \" + JSON.stringify(query) + \" \" + JSON.stringify(fetchOptions);\n        var entry = this.cache[key];\n        if (entry) {\n            // Entry found. Is it still being fetched?\n            if ('promise' in entry)\n                throw entry.promise; // Still being fetched. Multiple parallell fetches should work on same promise!\n            // Promise has resolved. Return result.\n            return entry.result;\n        }\n        else {\n            // We are the first to do this request. Start doing it:\n            var promise = this.fetch(path, method, headers, query, fetchOptions).then(function (res) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var status, text;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            status = res.status;\n                            return [4 /*yield*/, res.text()];\n                        case 1:\n                            text = _a.sent();\n                            this.cache[key] = {\n                                result: {\n                                    status: status,\n                                    text: function () { return text; },\n                                    json: function () { return JSON.parse(text); }\n                                }\n                            };\n                            return [2 /*return*/];\n                    }\n                });\n            }); });\n            // Immediately put the promise in the cache. Multiple parallell fetches should work on the same promise!\n            this.cache[key] = { promise: promise };\n            // Suspend until promise is resolved. At that time, the cache will contain an answer!\n            throw promise;\n        }\n    };\n    RestClient.prototype.fetch = function (path, method, headers, query, fetchOptions) {\n        var _this = this;\n        ++this.numOutstandingOperations;\n        this._status.dispatch(this);\n        return this._fetch(path, method, headers, query, fetchOptions)\n            .then(function (res) {\n            --_this.numOutstandingOperations;\n            _this._status.dispatch(_this);\n            return res;\n        }).catch(function (err) {\n            --_this.numOutstandingOperations;\n            _this._status.dispatch(_this);\n            return Promise.reject(err);\n        });\n    };\n    RestClient.prototype._fetch = function (path, method, headers, query, fetchOptions) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var queryStr, _a, authHeader, tokenInfo, bearerProvider, _b, _c, url, res, wwwauth, _d;\n            return tslib_1.__generator(this, function (_e) {\n                switch (_e.label) {\n                    case 0:\n                        if (fetchOptions && fetchOptions.cache === 'no-cache') {\n                            // Workaround for back-button not respecting cache control in Chrome/Opera.\n                            // Append a query parameter to force a cache entry\n                            query = tslib_1.__assign({}, query, { nocache: createUUID() });\n                        }\n                        queryStr = query && Object.keys(query).filter(function (key) { return query[key] !== undefined; }).map(function (key) {\n                            return encodeURIComponent(key) +\n                                \"=\" +\n                                encodeURIComponent(query[key]);\n                        })\n                            .join('&');\n                        _a = this, authHeader = _a.authHeader, tokenInfo = _a.tokenInfo, bearerProvider = _a.bearerProvider;\n                        if (!(!authHeader && !tokenInfo && bearerProvider)) return [3 /*break*/, 2];\n                        _b = this;\n                        return [4 /*yield*/, bearerProvider.getBearer()];\n                    case 1:\n                        _b.tokenInfo = tokenInfo = _e.sent();\n                        _e.label = 2;\n                    case 2:\n                        if (!tokenInfo) return [3 /*break*/, 5];\n                        if (!(tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\n                        console.log(\"Token expired. Refresh it:\");\n                        _c = this;\n                        return [4 /*yield*/, bearerProvider.refreshBearer()];\n                    case 3:\n                        _c.tokenInfo = tokenInfo = _e.sent();\n                        _e.label = 4;\n                    case 4:\n                        authHeader = \"Bearer \" + tokenInfo.token;\n                        _e.label = 5;\n                    case 5:\n                        // In one way or another, we've concluded an Authorization header to use:\n                        if (authHeader) {\n                            headers.Authorization = authHeader;\n                        }\n                        url = this.baseUrl + path + (queryStr ? \"?\" + queryStr : \"\");\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\n                    case 6:\n                        res = _e.sent();\n                        if (!(res.status == 401 && this.bearerProvider)) return [3 /*break*/, 9];\n                        wwwauth = res.headers.get(\"www-authenticate\");\n                        console.log(\"Got \" + res.status + \" from \" + (this.baseUrl + path));\n                        if (!(wwwauth && /Bearer/i.test(wwwauth))) return [3 /*break*/, 9];\n                        _d = this;\n                        return [4 /*yield*/, this.bearerProvider.refreshBearer()];\n                    case 7:\n                        _d.tokenInfo = _e.sent();\n                        headers.Authorization = \"Bearer \" + this.tokenInfo.token;\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\n                    case 8:\n                        res = _e.sent();\n                        _e.label = 9;\n                    case 9: return [2 /*return*/, res];\n                }\n            });\n        });\n    };\n    RestClient.prototype.get = function (path, query, fetchOptions) {\n        return this.fetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\n    };\n    RestClient.prototype.suspenseGet = function (path, query, fetchOptions) {\n        return this.suspenseFetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\n    };\n    RestClient.prototype.post = function (path, data, fetchOptions) {\n        return this.fetch(path, \"POST\", {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/json\"\n        }, null, tslib_1.__assign({}, fetchOptions, { body: JSON.stringify(data) }));\n    };\n    RestClient.prototype.delete = function (path, query, body, fetchOptions) {\n        return this.fetch(path, \"DELETE\", { Accept: \"application/json; text/plain\" }, query, tslib_1.__assign({}, fetchOptions, { body: body }));\n    };\n    return RestClient;\n}());\nexport { RestClient };\n//# sourceMappingURL=restclient.js.map","import * as tslib_1 from \"tslib\";\nexport function createUUID() {\n    // Decent solution from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript\n    var d = Date.now();\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n        var r = (d + Math.random() * 16) % 16 | 0;\n        d = Math.floor(d / 16);\n        return (c === 'x' ? r : (r & 0x7 | 0x8)).toString(16);\n    });\n    return uuid;\n}\nexport function avoidSimultanousCalls(method) {\n    var ongoingPromise = null;\n    return function () {\n        if (!ongoingPromise) {\n            ongoingPromise = method.apply(this, arguments).then(function (result) {\n                ongoingPromise = null;\n                return result;\n            });\n        }\n        return ongoingPromise;\n    };\n}\nexport function getGlobalId(realm) {\n    var prefix = 'ec96b3be-45fc-41d3-b69e-';\n    var pad = ['50', '08', 'e1', '40', 'e4', 'e7'];\n    if (realm.length > 6)\n        throw new Error(\"Too long realm\");\n    for (var i = 0; i < realm.length; ++i) {\n        var hex = realm.charCodeAt(i).toString(16);\n        pad[i] = hex.length === 2 ?\n            hex :\n            '0' + hex;\n    }\n    return prefix + pad.join('');\n}\nexport function computePredestinatedId(input) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n        var encoder, data, digest, _a, i;\n        return tslib_1.__generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    encoder = new TextEncoder();\n                    data = encoder.encode(input);\n                    _a = Uint8Array.bind;\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', data)];\n                case 1:\n                    digest = new (_a.apply(Uint8Array, [void 0, _b.sent()]))();\n                    i = 0;\n                    return [2 /*return*/, 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n                            var nibble = digest[i++] % 16 | 0;\n                            var washedNibble = c === 'x' ?\n                                nibble :\n                                nibble & 0x7 | 0x8;\n                            return washedNibble.toString(16);\n                        })];\n            }\n        });\n    });\n}\nexport function simpleDigest(input) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n        var encoder, inputBytes, digestBytes, _a;\n        return tslib_1.__generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    encoder = new TextEncoder();\n                    inputBytes = encoder.encode(input);\n                    _a = Uint8Array.bind;\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', inputBytes)];\n                case 1:\n                    digestBytes = new (_a.apply(Uint8Array, [void 0, _b.sent(), 0, 16]))();\n                    return [2 /*return*/, buf2hex(digestBytes)];\n            }\n        });\n    });\n}\nvar simpleDigestCache = {};\nexport function simpleDigestSuspense(inputs) {\n    var results = inputs.map(function (input) { return simpleDigestCache[input]; });\n    var unresolvedInputs = [];\n    results.forEach(function (result, index) {\n        if (!result)\n            unresolvedInputs.push(inputs[index]);\n    });\n    if (unresolvedInputs.length === 0)\n        return results;\n    throw Promise.all(unresolvedInputs.map(function (input) { return simpleDigest(input).then(function (result) { return simpleDigestCache[input] = result; }); }));\n}\nexport function buf2hex(buffer) {\n    return Array.prototype.map.call(buffer, function (x) { return ('00' + x.toString(16)).slice(-2); }).join('');\n}\nexport function updateArray(a, mapper) {\n    var retval = a;\n    for (var i = 0, l = a.length; i < l; ++i) {\n        var t = a[i];\n        var mapped = mapper(t);\n        if (mapped !== t) {\n            if (retval === a)\n                retval = a.slice();\n            retval[i] = mapped;\n        }\n    }\n    return retval;\n}\n/*\nexport function updateArray<T>(a: T[], mapper: (t: T) => T | false): T[] {\n  let retval = a;\n  let j = 0;\n  for (let i=0,l=a.length; i<l; ++i, ++j) {\n    const t = a[i];\n    const mapped = mapper(t);\n    if (mapped === false) {\n      // Mapper wants to delete this doc.\n      if (retval === a) retval = a.slice();\n      retval.splice(j, 1);\n      --j; // compensate for ++j\n    } else if (mapped !== t) {\n      if (retval === a) retval = a.slice();\n      retval[j] = mapped;\n    }\n  }\n  return retval;\n}\n*/ \n//# sourceMappingURL=utils.js.map","import * as JsonSchema from \"kedbackend-schema/schema.json\";\nimport { getTableFromLabel } from \"./utils\";\nvar CacheBust = /** @class */ (function () {\n    function CacheBust() {\n    }\n    CacheBust.getCacheBust = function (table, query, user, includes) {\n        var involvedItems = CacheBust.getInvolvedItems(table, query, includes);\n        return involvedItems\n            .map(function (item) { return localStorage.getItem(\"cache-bust-\" + user + \"-\" + item); })\n            .filter(function (value) { return !!value; })\n            .join('/') || 'static';\n    };\n    CacheBust.invalidateCache = function (reqs, user) {\n        for (var _i = 0, _a = CacheBust.getCacheInvalidations(reqs); _i < _a.length; _i++) {\n            var item = _a[_i];\n            localStorage.setItem(\"cache-bust-\" + user + \"-\" + item, '' + Date.now());\n        }\n    };\n    CacheBust.getInvolvedItems = function (table, query, includes) {\n        var hasEdgesFrom = query.hasEdgesFrom;\n        var relatedTables = includes\n            .map(function (label) { return JsonSchema.tables[table].relationships[label]; })\n            .filter(function (table) { return !!table; });\n        if (hasEdgesFrom)\n            relatedTables.push(\"hef\" + table);\n        return [table, 'master', query.branchId].filter(function (x) { return !!x; }).concat(relatedTables).sort();\n    };\n    CacheBust.getCacheInvalidations = function (reqs) {\n        var invalidationSet = {};\n        reqs.forEach(function (req) {\n            switch (req.op) {\n                case 'add':\n                case 'put':\n                case 'delete':\n                case 'update':\n                    invalidationSet[req.table] = true;\n                    break;\n                case 'link':\n                case 'unlink':\n                case 'undo-link':\n                    invalidationSet[req.sourceTable] = true;\n                    invalidationSet[\"hef-\" + getTableFromLabel(req.sourceTable, req.label)] = true;\n                    break;\n                case 'clear-branch':\n                    invalidationSet[req.branchId] = true;\n                    break;\n                case 'merge':\n                    invalidationSet[req.branchId] = true;\n                    invalidationSet[req.targetBranchId || \"master\"] = true;\n                    break;\n            }\n        });\n        return Object.keys(invalidationSet);\n    };\n    return CacheBust;\n}());\nexport { CacheBust };\n//# sourceMappingURL=cache-bust.js.map","import * as tslib_1 from \"tslib\";\nimport { mergeDeltas } from '../delta-merge';\nexport function applyMutationsOnDeltas(branchId, deltas, mutations, optimistic, userDisplayName, hasAdditionalFilter) {\n    var _loop_1 = function (m) {\n        switch (m.op) {\n            case 'add-related':\n                //\n                // AddRelated RepoMutation\n                //\n                if (!hasAdditionalFilter && m.branchId === branchId) {\n                    deltas = [{\n                            type: 'add',\n                            sourceId: m.id,\n                            targetId: m.relatedDoc.id,\n                            label: m.graphProp,\n                            sourceTable: m.table,\n                            $meta: optimistic ? 'adding' : 'persisted',\n                            dateTime: Date.now(),\n                            targetName: m.relatedDoc.name,\n                            contributor: userDisplayName\n                        }].concat(deltas);\n                }\n                break;\n            case 'clear-branch':\n                //\n                // ClearBranch RepoMutation\n                //\n                if (m.branchId === branchId) {\n                    deltas = [];\n                }\n                break;\n            case 'delete':\n                //\n                // Delete RepoMutation\n                //\n                // This type of mutation can not be performed onto branches. There's no branchId property on m.\n                break;\n            case 'merge':\n                //\n                // Merge RepoMutation\n                //\n                if (m.branchId === branchId) {\n                    deltas = [];\n                }\n                else if (m.targetBranchId === branchId) {\n                    // This change will append new deltas to our deltas array but we don't know what would come.\n                    // Need to refetch from server.\n                    if (!optimistic)\n                        return { value: null }; // Caller should check for null and re-fetch data from server.\n                }\n                break;\n            case 'remove-related':\n                //\n                // Remove-Related RepoMutation\n                //\n                if (hasAdditionalFilter || m.branchId !== branchId)\n                    return \"continue\";\n                deltas = [{\n                        type: 'remove',\n                        sourceId: m.id,\n                        targetId: m.relatedDoc.id,\n                        targetName: m.relatedDoc.name,\n                        label: m.graphProp,\n                        sourceTable: m.table,\n                        contributor: userDisplayName,\n                        dateTime: Date.now(),\n                        $meta: optimistic ? 'adding' : 'persisted'\n                    }].concat(deltas);\n                break;\n            case 'undo-link':\n                //\n                // Undo-Link RepoMutation\n                //\n                if (m.branchId !== branchId)\n                    return \"continue\";\n                {\n                    var idx = deltas.findIndex(function (d) {\n                        return (d.type === 'add' || d.type === 'remove' || d.type === 'undo-link') &&\n                            d.sourceId === m.id &&\n                            d.targetId === m.relatedId;\n                    });\n                    if (idx < 0)\n                        return \"continue\";\n                    // Found an \"add\" or \"remove\" delta to change:\n                    if (optimistic) {\n                        var deltaRelation = deltas[idx];\n                        // Mark the existing add/remove delta as currenlty being deleted\n                        deltas = deltas.slice(0, idx).concat([\n                            tslib_1.__assign({}, deltaRelation, { $meta: optimistic ? 'removing' : 'persisted' })\n                        ], deltas.slice(idx + 1));\n                    }\n                    else {\n                        // Persisted. Just remove it:\n                        deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\n                    }\n                }\n                break;\n            case 'update':\n                //\n                // Update RepoMutation\n                //\n                if (m.branchId !== branchId)\n                    return \"continue\";\n                {\n                    var idx = deltas.findIndex(function (delta) {\n                        return delta.type === 'modify' &&\n                            delta.targetId === m.id;\n                    });\n                    if (idx < 0 && !hasAdditionalFilter) {\n                        deltas = [{\n                                type: 'modify',\n                                table: m.table,\n                                targetId: m.id,\n                                targetName: m.targetName,\n                                data: m.deltaDoc,\n                                dateTime: Date.now(),\n                                contributors: [userDisplayName],\n                                $meta: optimistic ? 'adding' : 'persisted',\n                            }].concat(deltas);\n                    }\n                    else {\n                        var existingDeltaDoc = deltas[idx];\n                        var contributors = existingDeltaDoc.contributors.slice();\n                        if (!contributors.includes(userDisplayName)) {\n                            contributors.push(userDisplayName);\n                        }\n                        var newData = mergeDeltas(existingDeltaDoc.data, m.deltaDoc, { removeUnsetProps: true });\n                        if (!optimistic && Object.keys(newData).length === 0) {\n                            // Committed mutation that resets a deltaDoc. Remove the deltaDoc entirely:\n                            deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\n                        }\n                        else {\n                            // \n                            deltas = [\n                                {\n                                    type: 'modify',\n                                    table: m.table,\n                                    targetId: m.id,\n                                    targetName: m.targetName,\n                                    data: newData,\n                                    dateTime: Date.now(),\n                                    contributors: contributors,\n                                    $meta: optimistic ? 'updating' : 'persisted',\n                                }\n                            ].concat(deltas.slice(0, idx), deltas.slice(idx + 1));\n                        }\n                    }\n                }\n                break;\n        }\n    };\n    for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\n        var m = mutations_1[_i];\n        var state_1 = _loop_1(m);\n        if (typeof state_1 === \"object\")\n            return state_1.value;\n    }\n    return deltas;\n}\n//# sourceMappingURL=apply-mutations-on-deltas.js.map","import * as tslib_1 from \"tslib\";\nimport { HttpError } from '../../ked-backend-client';\nimport { applyMutationsOnDeltas } from './apply-mutations-on-deltas';\nvar DeltaCache = /** @class */ (function () {\n    function DeltaCache(getClient, getUser, getUserDisplayName) {\n        this.getClient = getClient;\n        this.getUser = getUser;\n        this.getUserDisplayName = getUserDisplayName;\n        this.lookup = {};\n    }\n    DeltaCache.prototype.applyMutations = function (mutations, _a) {\n        var optimistic = (_a === void 0 ? { optimistic: false } : _a).optimistic;\n        // Apply mutations locally onto the DeltaCache and notify their subscribers\n        for (var _i = 0, _b = Object.keys(this.lookup); _i < _b.length; _i++) {\n            var queryKey = _b[_i];\n            var cacheEntry = this.lookup[queryKey];\n            if (cacheEntry.value) {\n                // Instead here: Store the mutations on cacheEntry. No matter if it yet has value or not.\n                // Then apply mutation whenever subscribing! (Better handling of mutations that arrives before fetch() is done)\n                // (See how I handle this in query-set.ts)\n                var newValue = applyMutationsOnDeltas(cacheEntry.query.branchId, cacheEntry.value, mutations, optimistic, this.getUserDisplayName(), !!cacheEntry.query.tags);\n                if (newValue === null) {\n                    // The mutation requires cacheEntry to be refetched from server\n                    if (!optimistic) {\n                        // Caller has successfully performed the mutations and got success back from server.\n                        // It's ok to refetch the deltas from server now:\n                        cacheEntry.fetch();\n                        // After fetch completes, it will notify the subscribers.\n                    }\n                }\n                if (newValue !== cacheEntry.value) {\n                    cacheEntry.optimisticValue = newValue;\n                    if (!optimistic)\n                        cacheEntry.value = newValue;\n                    cacheEntry.notify(newValue);\n                }\n            }\n        }\n    };\n    DeltaCache.prototype.subscribe = function (query, observer) {\n        var _this = this;\n        var cacheEntry = this.lookup[query.branchId + query.tags];\n        if (!cacheEntry) {\n            cacheEntry = new DeltaCacheEntry(this.getClient(), query);\n            this.lookup[query.branchId + query.tags] = cacheEntry;\n        }\n        if (cacheEntry.cleanupTimer) {\n            clearTimeout(cacheEntry.cleanupTimer);\n            cacheEntry.cleanupTimer = null;\n        }\n        var subscription = {\n            unsubscribe: function () {\n                cacheEntry.subscribers = cacheEntry.subscribers.filter(function (_a) {\n                    var o = _a.observer;\n                    return o !== observer;\n                });\n                if (cacheEntry.subscribers.length === 0) {\n                    cacheEntry.cleanupTimer = setTimeout(function () {\n                        if (cacheEntry.subscribers.length === 0) {\n                            delete _this.lookup[query.branchId + query.tags];\n                        }\n                    }, 100);\n                }\n            }\n        };\n        cacheEntry.subscribers.push({ observer: observer, subscription: subscription });\n        if (cacheEntry.value) {\n            // Value has been successfully retrieved already. Pick from cache.\n            observer(cacheEntry.optimisticValue || cacheEntry.value, null, subscription);\n        }\n        else if (cacheEntry.isFetching) {\n            // A value is on its way. Sit back and relax. All registered\n            // observers (including this one) will be notified when data arrives\n            // or fails.\n        }\n        else if (cacheEntry.error) {\n            observer(null, cacheEntry.error, subscription);\n        }\n        else {\n            cacheEntry.fetch();\n        }\n        return subscription;\n    };\n    return DeltaCache;\n}());\nexport { DeltaCache };\nvar DeltaCacheEntry = /** @class */ (function () {\n    function DeltaCacheEntry(client, query) {\n        this.fetchOperationId = 0; // Makes sure a re-fetch will discard the result from any ongoing fetch.\n        this.client = client;\n        this.query = query;\n        this.value = null;\n        this.error = null;\n        this.optimisticValue = null;\n        this.subscribers = [];\n        this.isFetching = false;\n        this.cleanupTimer = null;\n    }\n    DeltaCacheEntry.prototype.fetch = function () {\n        var _this = this;\n        var fetchOperationId = ++this.fetchOperationId;\n        this.isFetching = true;\n        this.fetchFromServer().then(function (value) {\n            // Success\n            if (fetchOperationId === _this.fetchOperationId) {\n                _this.isFetching = false;\n                value.sort(function (a, b) { return b.dateTime - a.dateTime; }); // Latest first\n                _this.value = value;\n                _this.optimisticValue = value;\n                _this.notify(value);\n            }\n        }).catch(function (error) {\n            // Fail\n            if (fetchOperationId === _this.fetchOperationId) {\n                _this.isFetching = false;\n                _this.error = error;\n                _this.fail(error);\n            }\n        });\n    };\n    DeltaCacheEntry.prototype.fetchFromServer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        if (!this.query.branchId)\n                            throw new Error('Deltas only available on branches');\n                        return [4 /*yield*/, this.client.http.get('deltas', this.query)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status >= 300 || res.status < 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4: return [2 /*return*/, _c.sent()];\n                }\n            });\n        });\n    };\n    DeltaCacheEntry.prototype.notify = function (value) {\n        for (var _i = 0, _a = this.subscribers; _i < _a.length; _i++) {\n            var _b = _a[_i], observer = _b.observer, subscription = _b.subscription;\n            observer(value, null, subscription);\n        }\n    };\n    DeltaCacheEntry.prototype.fail = function (error) {\n        var copy = this.subscribers.slice();\n        this.subscribers = [];\n        for (var _i = 0, copy_1 = copy; _i < copy_1.length; _i++) {\n            var _a = copy_1[_i], observer = _a.observer, subscription = _a.subscription;\n            observer(null, error, subscription);\n        }\n    };\n    return DeltaCacheEntry;\n}());\n//# sourceMappingURL=delta-cache.js.map","import * as tslib_1 from \"tslib\";\nimport { Collection } from '../../observable';\nvar DeltaCollection = /** @class */ (function (_super) {\n    tslib_1.__extends(DeltaCollection, _super);\n    function DeltaCollection(deltaCache, query) {\n        var _this = _super.call(this, function (observer) { return _this.deltaCache.subscribe(query, observer); }) || this;\n        _this.deltaCache = deltaCache;\n        _this.query = query;\n        return _this;\n    }\n    DeltaCollection.prototype.tags = function () {\n        var tags = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            tags[_i] = arguments[_i];\n        }\n        return new DeltaCollection(this.deltaCache, tslib_1.__assign({}, this.query, { tags: tags }));\n    };\n    return DeltaCollection;\n}(Collection));\nexport { DeltaCollection };\n//# sourceMappingURL=delta-collection.js.map","import * as tslib_1 from \"tslib\";\nexport function applyDelta(doc, delta) {\n    var keys = Object.keys(delta);\n    var targetDoc = doc;\n    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\n        var key = keys_1[_i];\n        if (targetDoc === doc)\n            targetDoc = tslib_1.__assign({}, doc);\n        var val = delta[key];\n        if (val && typeof val === 'object') {\n            var metaInstructions = Object.keys(val)\n                .filter(function (key) { return key.startsWith('$'); });\n            if (metaInstructions.length > 0) {\n                var _loop_1 = function (mi) {\n                    var miValue = val[mi];\n                    switch (mi) {\n                        case \"$unset\": {\n                            // Do nothing on target doc!\n                            targetDoc.$wasUnset = true; // Just mark it for re-retrieval after successful posting changes.\n                            break;\n                        }\n                        case \"$add\": {\n                            var valuesToAdd = miValue;\n                            if (!Array.isArray(valuesToAdd)) {\n                                throw new Error(\"$add instruction must contain array\");\n                            }\n                            var targetArray = targetDoc[key];\n                            if (!Array.isArray(targetArray)) {\n                                targetArray = [];\n                            }\n                            else {\n                                targetArray = targetArray.slice(); // On JS side, we must be immutable\n                            }\n                            targetDoc[key] = targetArray;\n                            for (var _i = 0, valuesToAdd_1 = valuesToAdd; _i < valuesToAdd_1.length; _i++) {\n                                var v = valuesToAdd_1[_i];\n                                if (!targetArray.includes(v)) { // avoid dups\n                                    targetArray.push(v);\n                                }\n                            }\n                            break;\n                        }\n                        case \"$remove\": {\n                            var valuesToRemove_1 = miValue;\n                            if (!Array.isArray(valuesToRemove_1)) {\n                                throw new Error(\"$remove instruction must contain array\");\n                            }\n                            var targetArray = targetDoc[key];\n                            if (!Array.isArray(targetArray)) {\n                                targetArray = [];\n                            }\n                            targetDoc[key] = targetArray.filter(function (t) { return !valuesToRemove_1.includes(t); });\n                            break;\n                        }\n                    }\n                };\n                for (var _a = 0, metaInstructions_1 = metaInstructions; _a < metaInstructions_1.length; _a++) {\n                    var mi = metaInstructions_1[_a];\n                    _loop_1(mi);\n                }\n                continue;\n            }\n        }\n        targetDoc[key] = val;\n    }\n    return targetDoc;\n}\n// {name: \"Ulla\"}, {name: {$unset:0}\n// {tags: {$add: \"hej\"}}, {tags: {$unset:0}\"}\nexport function mergeDeltas(delta1, delta2, _a) {\n    var removeUnsetProps = (_a === void 0 ? { removeUnsetProps: false } : _a).removeUnsetProps;\n    //return {...delta1, ...delta2};\n    var keys = Object.keys(delta2);\n    var targetDelta = tslib_1.__assign({}, delta1);\n    for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {\n        var key = keys_2[_i];\n        var val = delta2[key];\n        if (val && typeof val === 'object') {\n            var metaInstructions = Object.keys(val)\n                .filter(function (key) { return key.startsWith('$'); });\n            if (metaInstructions.length > 0) {\n                var _loop_2 = function (mi) {\n                    var miValue = val[mi];\n                    switch (mi) {\n                        case \"$unset\": {\n                            if (removeUnsetProps) {\n                                delete targetDelta[key];\n                            }\n                            else {\n                                // No matter if targetDelta is empty or has value. Set it to {$unset:0}\n                                // to make sure the very end result will have {$unset:0}\n                                targetDelta[key] = { $unset: 0 };\n                            }\n                            break;\n                        }\n                        case \"$add\": {\n                            var valuesToAdd_2 = miValue;\n                            if (!Array.isArray(valuesToAdd_2)) {\n                                throw new Error(\"$add instruction must contain array\");\n                            }\n                            var targetMetaProp = targetDelta[key];\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\n                            targetDelta[key] = targetMetaProp;\n                            // First, just check if target metaProp has {$remove: [...items]}\n                            // If so, remove any equal items from there before merging the {$add: [...]} arrays.\n                            var targetRemoveArray = targetMetaProp.$remove;\n                            if (Array.isArray(targetRemoveArray)) {\n                                targetMetaProp.$remove =\n                                    targetRemoveArray.filter(function (t) { return !valuesToAdd_2.includes(t); });\n                                if (targetMetaProp.$remove.length === 0) {\n                                    // If $remove array became emtpy. Remove the $remove prop.\n                                    delete targetMetaProp.$remove;\n                                }\n                            }\n                            // Now it's time to merge or create target $add array.\n                            var targetAddArray = targetMetaProp.$add;\n                            targetAddArray = targetAddArray ? targetAddArray.concat(valuesToAdd_2) : valuesToAdd_2.slice();\n                            targetMetaProp.$add = targetAddArray;\n                            break;\n                        }\n                        case \"$remove\": {\n                            var valuesToRemove_2 = miValue;\n                            if (!Array.isArray(valuesToRemove_2)) {\n                                throw new Error(\"$remove instruction must contain array\");\n                            }\n                            var targetMetaProp = targetDelta[key];\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\n                            targetDelta[key] = targetMetaProp;\n                            // First, just check if target metaProp has {$add: [...items]}\n                            // If so, remove any equal items from there before merging the {$remove: [...]} arrays.\n                            var targetAddArray = targetMetaProp.$remove;\n                            if (Array.isArray(targetAddArray)) {\n                                targetMetaProp.$add =\n                                    targetAddArray.filter(function (t) { return !valuesToRemove_2.includes(t); });\n                                if (targetMetaProp.$add.length === 0) {\n                                    // If $add array became emtpy. Remove the $add prop.\n                                    delete targetMetaProp.$add;\n                                }\n                            }\n                            // Now it's time to merge or create target $remove array.\n                            var targetRemoveArray = targetMetaProp.$remove;\n                            targetRemoveArray = targetRemoveArray ? targetRemoveArray.concat(valuesToRemove_2) : valuesToRemove_2.slice();\n                            targetMetaProp.$remove = targetRemoveArray;\n                            break;\n                        }\n                    }\n                };\n                for (var _b = 0, metaInstructions_2 = metaInstructions; _b < metaInstructions_2.length; _b++) {\n                    var mi = metaInstructions_2[_b];\n                    _loop_2(mi);\n                }\n                continue;\n            }\n        }\n        targetDelta[key] = val;\n    }\n    return targetDelta;\n}\n//# sourceMappingURL=delta-merge.js.map","export * from './kedbackend-collection';\nexport * from './kedbackend-query';\nexport * from './kedbackend-repo';\nexport * from './kedbackend-subscription';\nexport * from './kedbackend-writer';\nexport * from './mutation-queue';\nexport * from './query-set';\nexport * from '../observable/mixin';\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\nimport { BatchRunner } from '../ked-backend-client';\nimport { KedBackendSubscription } from \"./kedbackend-subscription\";\nimport { CacheBust } from './cache-bust';\nimport { KedBackendQuery } from './kedbackend-query';\nimport { Collection } from '../observable/collection';\n/**\n * Represents a \"live\" query against a table or filtered table.\n */\nvar KedBackendCollection = /** @class */ (function (_super) {\n    tslib_1.__extends(KedBackendCollection, _super);\n    function KedBackendCollection(repo, table, query) {\n        var _this = _super.call(this, function (observer) {\n            var subscription = new KedBackendSubscription(observer, _this);\n            _this.repo.querySet.subscribe(subscription);\n            return subscription;\n        }) || this;\n        _this.repo = repo;\n        _this.table = table;\n        _this.query = query;\n        return _this;\n    }\n    Object.defineProperty(KedBackendCollection.prototype, \"queryKey\", {\n        get: function () {\n            return KedBackendQuery.queryKey(this.table, this.query);\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(KedBackendCollection.prototype, \"includes\", {\n        get: function () {\n            return this._includes || (this._includes = [].concat(this.query.include || []));\n        },\n        enumerable: true,\n        configurable: true\n    });\n    KedBackendCollection.prototype.applyQuery = function (query) {\n        return new KedBackendCollection(this.repo, this.table, tslib_1.__assign({}, this.query, query));\n    };\n    KedBackendCollection.prototype.addToQueryArrayProp = function (arrayProp, entries) {\n        var _a;\n        return this.applyQuery((_a = {}, _a[arrayProp] = (this.query[arrayProp] || []).concat(entries), _a));\n    };\n    KedBackendCollection.prototype.addFlags = function () {\n        var flags = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            flags[_i] = arguments[_i];\n        }\n        return this.addToQueryArrayProp(\"flags\", flags);\n    };\n    KedBackendCollection.prototype.debug = function () {\n        return this.applyQuery({ debug: true });\n    };\n    KedBackendCollection.prototype.idsOnly = function () {\n        return this.addFlags(\"idsOnly\");\n    };\n    KedBackendCollection.prototype.idsAndNamesOnly = function () {\n        return this.addFlags(\"idsAndNamesOnly\");\n    };\n    KedBackendCollection.prototype.includeIdsOnly = function () {\n        return this.addFlags(\"includeIdsOnly\");\n    };\n    KedBackendCollection.prototype.includeIdsAndNamesOnly = function () {\n        return this.addFlags(\"includeIdsAndNamesOnly\");\n    };\n    KedBackendCollection.prototype.between = function (from, to) {\n        return this.applyQuery({ from: from, to: to });\n    };\n    KedBackendCollection.prototype.role = function (role) {\n        return this.applyQuery({ role: role });\n    };\n    KedBackendCollection.prototype.hasEdgesFrom = function (ids) {\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\n            throw new Error(\"Invalid id list given to Collection.hasEdgesFrom(\" + JSON.stringify(ids) + \")\");\n        var hef = this.addToQueryArrayProp(\"hasEdgesFrom\", ids);\n        return hef;\n    };\n    KedBackendCollection.prototype.hasEdgesTo = function (ids) {\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\n            throw new Error(\"Invalid id list given to Collection.hasEdgesTo(\" + JSON.stringify(ids) + \")\");\n        var het = this.addToQueryArrayProp(\"hasEdgesTo\", ids);\n        return het;\n    };\n    KedBackendCollection.prototype.id = function (id) {\n        var _this = this;\n        return this.applyQuery({ ids: [id] }).single({\n            onZero: function () { throw new Error(\"Could not find entity in \" + _this.table + \" with id \" + id); },\n            onMany: function () { throw new Error(\"Multiple entries in \" + _this.table + \" with id \" + id); },\n        });\n    };\n    KedBackendCollection.prototype.ids = function (ids) {\n        return this.applyQuery({ ids: ids });\n    };\n    KedBackendCollection.prototype.name = function (name) {\n        return this.applyQuery({ name: name });\n    };\n    KedBackendCollection.prototype.tags = function () {\n        var tags = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            tags[_i] = arguments[_i];\n        }\n        return this.applyQuery({ tags: tags });\n    };\n    KedBackendCollection.prototype.branchId = function (branchId) {\n        return this.applyQuery({ branchId: branchId });\n    };\n    KedBackendCollection.prototype.include = function () {\n        var graphs = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            graphs[_i] = arguments[_i];\n        }\n        return this.addToQueryArrayProp(\"include\", graphs);\n    };\n    KedBackendCollection.prototype.cacheOptimized = function (onOrOff) {\n        return onOrOff === undefined || onOrOff === true ?\n            this.applyQuery({ cacheBust: CacheBust.getCacheBust(this.table, this.query, this.repo.getUser(), this.includes) }) :\n            this.applyQuery({ cacheBust: undefined });\n    };\n    KedBackendCollection.prototype.mutationsOnEmpty = function (mutationFactory) {\n        var tx = new BatchRunner();\n        mutationFactory(tx);\n        return this.applyQuery({ mutationsOnEmpty: tx.mutationRequests });\n    };\n    KedBackendCollection.prototype.single = function (throwers) {\n        var _this = this;\n        var _a = throwers || {}, onZero = _a.onZero, onMany = _a.onMany;\n        return this.toValue().map(function (items) {\n            if (items.length === 0) {\n                if (onZero)\n                    onZero();\n                else\n                    throw new Error(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but none was found.\");\n            }\n            if (items.length > 1) {\n                debugger;\n                if (onMany)\n                    onMany();\n                else\n                    console.log(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but \" + items.length + \" was found.\");\n            }\n            return items[0];\n        });\n    };\n    /*combineLatest<TOther>(other: QueryObservable<TOther>) {\n      return this.render(x => x).combineLatest(other);\n    }*/\n    KedBackendCollection.prototype.update = function (doc, changes, debounce) {\n        if (debounce === void 0) { debounce = 1000; }\n        this.repo.writer.mutate([{\n                op: 'update',\n                table: this.table,\n                branchId: this.query.branchId,\n                id: doc.id,\n                deltaDoc: changes,\n                targetName: doc.name\n            }], debounce);\n    };\n    KedBackendCollection.prototype.addRelated = function (id, label, relatedDoc) {\n        this.repo.writer.mutate([{\n                op: 'add-related',\n                table: this.table,\n                branchId: this.query.branchId,\n                id: id,\n                graphProp: label,\n                relatedDoc: relatedDoc\n            }], 0);\n    };\n    KedBackendCollection.prototype.add = function (doc) {\n        this.repo.writer.mutate([{\n                op: 'add',\n                id: doc.id,\n                table: this.table,\n                doc: doc\n            }], 0);\n    };\n    KedBackendCollection.prototype.removeRelated = function (id, label, relatedDoc) {\n        this.repo.writer.mutate([{\n                op: 'remove-related',\n                table: this.table,\n                branchId: this.query.branchId,\n                id: id,\n                graphProp: label,\n                relatedDoc: relatedDoc\n            }], 0);\n    };\n    KedBackendCollection.prototype.undoLink = function (id, label, relatedId) {\n        if (!this.query.branchId)\n            throw new Error(\"undo links can only be performed on branches\");\n        this.repo.writer.mutate([{\n                op: 'undo-link',\n                table: this.table,\n                branchId: this.query.branchId,\n                id: id,\n                graphProp: label,\n                relatedId: relatedId\n            }], 0);\n    };\n    KedBackendCollection.prototype.delete = function () {\n        var _this = this;\n        var ids = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            ids[_i] = arguments[_i];\n        }\n        this.repo.writer.mutate(ids.map(function (id) { return ({\n            op: 'delete',\n            table: _this.table,\n            id: id\n        }); }), 0);\n    };\n    KedBackendCollection.prototype.unsubscribe = function (subscription) {\n        this.repo.querySet.unsubscribe(subscription);\n    };\n    return KedBackendCollection;\n}(Collection));\nexport { KedBackendCollection };\n/*mixin(\n  KedBackendCollection.prototype,\n  MappedCollection.prototype,\n  \"map\", \"flat\", \"concat\", \"render\", \"load\");*/\n//# sourceMappingURL=kedbackend-collection.js.map","import * as tslib_1 from \"tslib\";\nimport { updateArray } from '../ked-backend-client/utils';\nimport { branchSensitive, getTableFromLabel } from './utils';\nimport { applyDelta } from './delta-merge';\nvar KedBackendQuery = /** @class */ (function () {\n    function KedBackendQuery(table, query, user, repo, mutationQueue) {\n        this.table = table;\n        this.query = query;\n        this.user = user;\n        this.repo = repo;\n        this.mutationQueue = mutationQueue;\n        this.subscriptions = [];\n        this.data = [];\n        this.gotInitialResponse = false;\n        this.invalid = false;\n        this.loadedVersion = 0;\n        this._loadPromise = null;\n        this.includes = query.include ?\n            typeof query.include === 'string' ?\n                [query.include] :\n                query.include :\n            [];\n    }\n    KedBackendQuery.queryKey = function (table, query) {\n        var mutationsOnEmpty = query.mutationsOnEmpty, comparableProps = tslib_1.__rest(query, [\"mutationsOnEmpty\"]);\n        return table + JSON.stringify(comparableProps);\n    };\n    Object.defineProperty(KedBackendQuery.prototype, \"queryKey\", {\n        get: function () {\n            return KedBackendQuery.queryKey(this.table, this.query);\n        },\n        enumerable: true,\n        configurable: true\n    });\n    KedBackendQuery.prototype.subscribe = function (subscription) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var data, data;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.subscriptions.push(subscription);\n                        if (!(this.gotInitialResponse && !this.invalid)) return [3 /*break*/, 1];\n                        data = this.getDataWithMutationsApplied(this.mutationQueue.get(), true, this.data);\n                        subscription.notifySubscriber(data, this.error);\n                        return [3 /*break*/, 4];\n                    case 1:\n                        data = this.queryLocally();\n                        if (!data) return [3 /*break*/, 2];\n                        this.data = data;\n                        this.error = null;\n                        subscription.notifySubscriber(data, this.error);\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, this.load()];\n                    case 3:\n                        _a.sent();\n                        _a.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype.load = function (version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var loadPromise;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.gotInitialResponse) {\n                            // mutationsOnEmpty should never be used twice.\n                            delete this.query.mutationsOnEmpty;\n                        }\n                        if (!(!version && this._loadPromise)) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this._loadPromise];\n                    case 1: \n                    // loading is ongoing, and caller does not require a recent refresh.\n                    // wait for the ongoing load to complete\n                    return [2 /*return*/, _a.sent()];\n                    case 2:\n                        version = version || this.repo.writer.persistedVersion.value;\n                        loadPromise = this._loadPromise = this._load(version).then(function (data) {\n                            if (_this._loadPromise === loadPromise) {\n                                _this.data = data;\n                                _this.loadedVersion = Math.max(_this.loadedVersion, version);\n                            }\n                        }).catch(function (error) {\n                            if (_this._loadPromise === loadPromise) {\n                                // Noone has refreshed our load. The error is the final result. Set it.\n                                _this.error = error;\n                            }\n                        }).then(function () {\n                            if (_this._loadPromise === loadPromise) {\n                                // Noone has refreshed our load. We're finished. Data or error is already set.\n                                // Mark gotInitialResponse to true and notify subscribers.\n                                _this._loadPromise = null;\n                                _this.gotInitialResponse = true;\n                                _this.notifySubscribers(_this.mutationQueue.get());\n                            }\n                            else {\n                                // A more recent call to load() is ongoing, OR was ongoing but responded\n                                // before us.\n                                // In any case return this._loadPromise. If it's ongoing we'll wait for it\n                                // to finish. If it's null, we'll be returning finally here without\n                                // any action, because the action was taken by the refresher.\n                                return _this._loadPromise; // Wait for the refreshed load to complete\n                            }\n                        });\n                        return [4 /*yield*/, loadPromise];\n                    case 3:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype._load = function (version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.mutationQueue.affectsQuery(this.table, this.query, this.includes)) return [3 /*break*/, 2];\n                        // There are outgoing mutations that affects this query.\n                        // Need to wait till they reach server and server responds with OK before querying\n                        // the server. Otherwise, we may get inaccurate data from server.\n                        return [4 /*yield*/, this.repo.writer.waitForVersionToPersist(version)];\n                    case 1:\n                        // There are outgoing mutations that affects this query.\n                        // Need to wait till they reach server and server responds with OK before querying\n                        // the server. Otherwise, we may get inaccurate data from server.\n                        _a.sent();\n                        _a.label = 2;\n                    case 2: return [4 /*yield*/, this.queryServer()];\n                    case 3: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype.unsubscribe = function (subscription) {\n        this.subscriptions = this.subscriptions.filter(function (s) { return s !== subscription; });\n    };\n    KedBackendQuery.prototype.commitMutations = function (mutations, version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _i, mutations_1, m, data;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.data) return [3 /*break*/, 9];\n                        _i = 0, mutations_1 = mutations;\n                        _a.label = 1;\n                    case 1:\n                        if (!(_i < mutations_1.length)) return [3 /*break*/, 8];\n                        m = mutations_1[_i];\n                        if (!(m.op === 'clear-branch' && (m.branchId === this.query.branchId))) return [3 /*break*/, 3];\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\n                    case 2:\n                        _a.sent();\n                        return [2 /*return*/];\n                    case 3:\n                        if (!(m.op === 'merge' && (!m.targetBranchId ||\n                            m.branchId === this.query.branchId ||\n                            m.targetBranchId === this.query.branchId))) return [3 /*break*/, 5];\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\n                    case 4:\n                        _a.sent();\n                        return [2 /*return*/];\n                    case 5:\n                        if (!(m.op === 'update' && ((m.deltaDoc.tags && this.query.tags) ||\n                            (m.deltaDoc.name && this.query.name)))) return [3 /*break*/, 7];\n                        // A tag may have been added, or renamed, and\n                        // the query is dependent on the same property.\n                        // The query must be refreshed from server as we cannot\n                        // commit the mutations locally as we don't have all info.\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\n                    case 6:\n                        // A tag may have been added, or renamed, and\n                        // the query is dependent on the same property.\n                        // The query must be refreshed from server as we cannot\n                        // commit the mutations locally as we don't have all info.\n                        _a.sent();\n                        return [2 /*return*/];\n                    case 7:\n                        _i++;\n                        return [3 /*break*/, 1];\n                    case 8:\n                        data = this.getDataWithMutationsApplied(mutations, false, this.data);\n                        this.data = data;\n                        _a.label = 9;\n                    case 9: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype.refreshOrInvalidate = function (version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!(this.subscriptions.length === 0)) return [3 /*break*/, 1];\n                        this.invalid = true;\n                        return [3 /*break*/, 3];\n                    case 1: return [4 /*yield*/, this.load(version)];\n                    case 2:\n                        _a.sent();\n                        _a.label = 3;\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype.notifySubscribers = function (optimisticMutations) {\n        var _this = this;\n        if (this.data && this.gotInitialResponse) {\n            var data_1 = this.getDataWithMutationsApplied(optimisticMutations, true, this.data);\n            this.subscriptions.forEach(function (s) {\n                s.notifySubscriber(data_1, _this.error);\n            });\n        }\n    };\n    KedBackendQuery.prototype.queryLocally = function () {\n        return this.repo.querySet.queryLocally(this.table, this.query, this.includes);\n    };\n    KedBackendQuery.prototype.queryServer = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var data;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.repo.getClient().list(this.table, tslib_1.__assign({}, this.query))];\n                    case 1:\n                        data = _a.sent();\n                        return [2 /*return*/, data];\n                }\n            });\n        });\n    };\n    KedBackendQuery.prototype.getDataWithMutationsApplied = function (mutations, optimistic, data) {\n        var _this = this;\n        mutations.forEach(function (mutation) {\n            data = _this.applyMutationsOnData(data, mutation, optimistic);\n        });\n        return data;\n    };\n    KedBackendQuery.prototype.applyMutationsOnData = function (data, m, optimistic) {\n        if (branchSensitive(m) && m.branchId != this.query.branchId)\n            return data;\n        var _a = this, table = _a.table, includes = _a.includes, listOptions = _a.query;\n        var sourceIds = listOptions.hasEdgesFrom ? [].concat(listOptions.hasEdgesFrom || []) : [];\n        var requestedTags = listOptions.tags ? [].concat(listOptions.tags || []) : [];\n        switch (m.op) {\n            case 'update': {\n                return updateArray(data, function (doc) {\n                    if (doc.id === m.id) {\n                        // Apply delta on updated document\n                        var updatedDoc = applyDelta(doc, m.deltaDoc);\n                        if (optimistic)\n                            updatedDoc.$meta = 'updating';\n                        return updatedDoc;\n                    }\n                    // If id does not apply to this doc, search in graphs the id is found\n                    // among graph included docs, and if so, update that one:\n                    includes.forEach(function (label) {\n                        var _a;\n                        var includedDocs = doc[label];\n                        if (includedDocs) {\n                            var updatedArray = updateArray(includedDocs, function (related) {\n                                if (related.id !== m.id)\n                                    return related;\n                                var updatedRelated = applyDelta(related, m.deltaDoc);\n                                if (optimistic)\n                                    updatedRelated.$meta = 'updating';\n                                return updatedRelated;\n                            });\n                            if (updatedArray !== includedDocs) {\n                                doc = tslib_1.__assign({}, doc, (_a = {}, _a[label] = updatedArray, _a));\n                            }\n                        }\n                    });\n                    return doc;\n                });\n            }\n            case 'add':\n                if (table === m.table) {\n                    if (listOptions.tags) {\n                        var queriedTags_1 = [].concat(listOptions.tags); // tag can be either string or string[]. Make is string[] always.\n                        if (m.doc.tags && m.doc.tags.some(function (tag) { return queriedTags_1.includes(tag); })) {\n                            return data.concat([m.doc]); // Make the added doc appear in the result (optimistic mutation)\n                        }\n                    }\n                    // Todo, apply also for other list options, like ids:\n                    // The above code for 'add' was only written to cover the use case of teachers-page notifications!\n                }\n                return data; // fallback case - query was not affected.\n            case 'add-related':\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\n                    // If expression is `db.courseBlocks....whatever.. .include(\"abilities\")`, detect: db.courseBlocks.addRelated(blockId, 'abilities', ...)\n                    // ...because table = 'courseBlocks' and includes has \"abilities\".\n                    return updateArray(data, function (doc) {\n                        var _a;\n                        if (doc.id !== m.id)\n                            return doc;\n                        var relatedDoc = tslib_1.__assign({}, m.relatedDoc);\n                        if (optimistic)\n                            relatedDoc.$meta = 'adding';\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = doc[m.graphProp].concat([relatedDoc]), _a));\n                    });\n                }\n                if (listOptions.hasEdgesFrom) {\n                    if (sourceIds.includes(m.id)) {\n                        // If expression is:\n                        //   `db.courseBlocks.hasEdgesFrom([courseId])`  (meaning table='courseBlocks' and sourceIds includes courseId)\n                        // , detect: db.courseInstances.addRelated(courseId, 'courseBlocks', ....) // m.graphProp === 'blocks'--> getTableFromLabel --> 'courseBlocks'\n                        if (table === getTableFromLabel(m.table, m.graphProp)) {\n                            if (!listOptions.tags)\n                                return data.concat(this.setGraphProps(m.relatedDoc));\n                            if (m.relatedDoc.tags && requestedTags.some(function (tag) { return m.relatedDoc.tags.includes(tag); })) {\n                                return data.concat(this.setGraphProps(m.relatedDoc));\n                            }\n                        }\n                    }\n                }\n                if (listOptions.ids && listOptions.ids.some(function (id) { return id === m.relatedDoc.id; })) {\n                    // A certain ID is observed. A doc with this id is being added.\n                    // Add the doc to the result. Exactly this WILL happen in the following typical scenario:\n                    // 1. User adds a related document to a list.\n                    // 2. Document remains within the MutationQueue while batch-request is being processed by server.\n                    // 3. User clicks the added item to edit or view it (or our component redirects to its editor)\n                    // 4. A new query of that particular ID is subscribed to {ids=[theId]}\n                    //    KedBackendQuery.subscribe then does this:\n                    //      1. Call queryLocally() before querying server\n                    //      2. queryLocally() inspects mutations and finds a match, returning an empty list\n                    //         (assumes as we are adding it, it can't exist on the server anyway)\n                    //      3. KedBackendQUery applies mutations onto the empty list, and ends up here to add\n                    //         it optimistically.\n                    //      4. When server responds with 200 OK, calls us here again with optimistic=false\n                    //         to \"persist\" it in the query's data array.\n                    //      4B: If not 200 OK, mutation may be gone and the subscriber will se an error page\n                    //         \"Could not find entity with id X.\" along with a red error message on the screen\n                    //         about that it failed to save on server.\n                    return data.concat(this.setGraphProps(m.relatedDoc));\n                }\n                return data;\n            case 'remove-related':\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\n                    return updateArray(data, function (doc) {\n                        var _a;\n                        var includedDocs = doc[m.graphProp];\n                        if (!includedDocs)\n                            return doc;\n                        if (doc.id !== m.id)\n                            return doc;\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = optimistic ?\n                            // Mark related-doc-to-remove with $meta: 'deleting'\n                            includedDocs.map(function (d) { return d.id !== m.relatedDoc.id ?\n                                d : tslib_1.__assign({}, d, { $meta: 'deleting' }); }) :\n                            // Delete related-doc-to-remove from doc[grapProp]:\n                            includedDocs.filter(function (d) { return d.id !== m.relatedDoc.id; }), _a));\n                    });\n                }\n                if (listOptions.hasEdgesFrom) {\n                    if (sourceIds.includes(m.id))\n                        return optimistic ?\n                            data.map(function (d) { return d.id === m.relatedDoc.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\n                            data.filter(function (d) { return d.id !== m.relatedDoc.id; });\n                }\n                return data;\n            case 'delete':\n                if (table === m.table) {\n                    return data.filter(function (d) { return d.id !== m.id; });\n                }\n                else if (listOptions.include) {\n                    var includedTables = includes\n                        .map(function (label) { return ({ label: label, table: getTableFromLabel(table, label) }); });\n                    var labels_1 = includedTables.filter(function (_a) {\n                        var table = _a.table;\n                        return table === m.table;\n                    });\n                    if (labels_1.length > 0) {\n                        return updateArray(data, function (doc) {\n                            labels_1.forEach(function (_a) {\n                                var label = _a.label;\n                                var _b;\n                                var relatedDocs = doc[label];\n                                if (relatedDocs) {\n                                    doc = tslib_1.__assign({}, doc, (_b = {}, _b[label] = optimistic ?\n                                        relatedDocs.map(function (d) { return d.id === m.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\n                                        relatedDocs.filter(function (_a) {\n                                            var id = _a.id;\n                                            return id !== m.id;\n                                        }), _b));\n                                }\n                            });\n                            return doc;\n                        });\n                    }\n                }\n                return data;\n            default:\n                return data;\n        }\n    };\n    KedBackendQuery.prototype.setGraphProps = function (doc) {\n        var copy = tslib_1.__assign({}, doc);\n        this.includes.forEach(function (label) { return copy[label] = copy[label] || []; });\n        return copy;\n    };\n    return KedBackendQuery;\n}());\nexport { KedBackendQuery };\n//# sourceMappingURL=kedbackend-query.js.map","import * as tslib_1 from \"tslib\";\nimport { tables } from 'kedbackend-schema/schema.json';\nimport { KedBackendCollection } from './kedbackend-collection';\nimport { QuerySet } from './query-set';\nimport { MutationQueue } from './mutation-queue';\nimport { KedBackendWriter } from './kedbackend-writer';\nimport { DeltaCollection } from './delta-collection/delta-collection';\nvar KedBackendRepo = /** @class */ (function () {\n    function KedBackendRepo(getClient, getUser, getUserDisplayName, defaultQueryOptions, mutationQueue, querySet, writer, cacheOptimized) {\n        var _this = this;\n        this.getClient = getClient;\n        this.getUser = getUser;\n        this.getUserDisplayName = getUserDisplayName;\n        this.defaultQueryOptions = defaultQueryOptions;\n        this.mutationQueue = mutationQueue;\n        this.querySet = querySet;\n        this.writer = writer;\n        this.cacheOptimized = cacheOptimized;\n        if (!defaultQueryOptions)\n            this.defaultQueryOptions = {};\n        if (!mutationQueue)\n            this.mutationQueue = new MutationQueue();\n        if (!querySet)\n            this.querySet = new QuerySet(this.mutationQueue);\n        if (!writer)\n            this.writer = new KedBackendWriter(this.mutationQueue, this.querySet, getClient, getUser, getUserDisplayName);\n        Object.keys(tables).forEach(function (table) {\n            var collection = new KedBackendCollection(_this, table, defaultQueryOptions || {});\n            if (cacheOptimized) {\n                collection = collection.cacheOptimized();\n            }\n            _this[table] = collection;\n        });\n        this.deltas = new DeltaCollection(this.writer.deltaCache, {\n            branchId: this.defaultQueryOptions.branchId // If branchId is undefined. DeltaCollection will respond with Error on subscribe()\n        });\n    }\n    KedBackendRepo.prototype.table = function (tableName) {\n        var collection = new KedBackendCollection(this, tableName, this.defaultQueryOptions);\n        if (this.cacheOptimized)\n            collection = collection.cacheOptimized();\n        return collection;\n    };\n    KedBackendRepo.prototype._clone = function (queryOptions, cacheOptimized) {\n        var clone = new KedBackendRepo(this.getClient, this.getUser, this.getUserDisplayName, tslib_1.__assign({}, this.defaultQueryOptions, queryOptions), this.mutationQueue, this.querySet, this.writer, cacheOptimized === undefined ? this.cacheOptimized : cacheOptimized);\n        return clone;\n    };\n    KedBackendRepo.prototype.branch = function (branchId) {\n        return this._clone({ branchId: branchId });\n    };\n    KedBackendRepo.prototype.role = function (role) {\n        return this._clone({ role: role });\n    };\n    KedBackendRepo.prototype.optimizeCache = function () {\n        return this._clone({}, true);\n    };\n    KedBackendRepo.prototype.clearBranch = function () {\n        if (!this.defaultQueryOptions.branchId)\n            throw new Error(\"Cannot clear master branch\");\n        this.writer.mutate([{ op: 'clear-branch', branchId: this.defaultQueryOptions.branchId }], 0);\n    };\n    KedBackendRepo.prototype.merge = function (targetBranchId) {\n        if (!this.defaultQueryOptions.branchId)\n            throw new Error(\"Cannot merge from master branch\");\n        this.writer.mutate([{ op: 'merge', branchId: this.defaultQueryOptions.branchId, targetBranchId: targetBranchId }], 0);\n    };\n    KedBackendRepo.prototype.saveNow = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.writer.waitForVersionToPersist(this.writer.currentVersion)];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return KedBackendRepo;\n}());\nexport { KedBackendRepo };\n//# sourceMappingURL=kedbackend-repo.js.map","var KedBackendSubscription = /** @class */ (function () {\n    function KedBackendSubscription(subscriber, collection) {\n        this.subscriber = subscriber;\n        this.collection = collection;\n    }\n    KedBackendSubscription.prototype.notifySubscriber = function (data, error) {\n        try {\n            if (error)\n                this.subscriber([], error, this);\n            else if (data !== this.lastNotifiedData) { // Will in-fact be equal by reference if data is same as last notification (as we use an immutable approach on data)\n                this.lastNotifiedData = data;\n                this.subscriber(data, error, this);\n            }\n        }\n        catch (ex) {\n            try {\n                this.subscriber([], ex, this);\n            }\n            catch (ex2) {\n                console.error(\"Error while notifying KedBackendSubscriber:\", ex2, 'originally notified error:', ex);\n            }\n        }\n    };\n    KedBackendSubscription.prototype.unsubscribe = function () {\n        this.collection.unsubscribe(this);\n    };\n    return KedBackendSubscription;\n}());\nexport { KedBackendSubscription };\n//# sourceMappingURL=kedbackend-subscription.js.map","import * as tslib_1 from \"tslib\";\nimport { MutationQueue } from './mutation-queue';\nimport { BatchRunner } from '../ked-backend-client';\nimport { tables } from 'kedbackend-schema/schema.json';\nimport { CacheBust } from './cache-bust';\nimport { Emitter } from '../observable';\nimport { DeltaCache } from './delta-collection/delta-cache';\nvar KedBackendWriter = /** @class */ (function () {\n    function KedBackendWriter(mutationQueue, querySet, getClient, getUser, getUserDisplayName) {\n        this.mutationQueue = mutationQueue;\n        this.querySet = querySet;\n        this.getClient = getClient;\n        this.getUser = getUser;\n        this.getUserDisplayName = getUserDisplayName;\n        this._timeoutId = null;\n        this._isSavingPromise = null;\n        this.currentVersion = 0;\n        this.persistedVersion = new Emitter(0);\n        this.errorSubscribers = [];\n        this.stateSubscribers = [];\n        this.deltaCache = new DeltaCache(getClient, getUser, getUserDisplayName);\n    }\n    Object.defineProperty(KedBackendWriter.prototype, \"isSaving\", {\n        get: function () { return !!this._isSavingPromise; },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(KedBackendWriter.prototype, \"isEdited\", {\n        get: function () { return this.mutationQueue.get().length > 0; },\n        enumerable: true,\n        configurable: true\n    });\n    KedBackendWriter.prototype.onError = function (callback) {\n        this.errorSubscribers.push(callback);\n    };\n    KedBackendWriter.prototype.onStateChange = function (callback) {\n        this.stateSubscribers.push(callback);\n    };\n    KedBackendWriter.prototype.off = function (callback) {\n        this.errorSubscribers = this.errorSubscribers.filter(function (s) { return s !== callback; });\n        this.stateSubscribers = this.stateSubscribers.filter(function (s) { return s !== callback; });\n    };\n    KedBackendWriter.prototype.dispatchError = function (error, retryable) {\n        var _this = this;\n        this.errorSubscribers.forEach(function (callback) {\n            try {\n                callback(error, retryable, _this);\n            }\n            catch (_) { }\n        });\n    };\n    KedBackendWriter.prototype.dispatchStateChange = function () {\n        var _this = this;\n        this.stateSubscribers.forEach(function (callback) {\n            try {\n                callback(_this);\n            }\n            catch (_) { }\n        });\n    };\n    KedBackendWriter.prototype.mutate = function (mutations, debounce) {\n        this.mutationQueue.add(mutations);\n        ++this.currentVersion;\n        this.dispatchStateChange();\n        this.querySet.notifySubscribers();\n        this.deltaCache.applyMutations(this.mutationQueue.get(), { optimistic: true });\n        if (!this._isSavingPromise) {\n            if (this._timeoutId)\n                clearTimeout(this._timeoutId);\n            this._timeoutId = setTimeout(this.save.bind(this), debounce);\n        }\n        // If isSaving, we don't need to do anything, becase it will re-check if additional\n        // mutations have come, when saving is done.\n    };\n    KedBackendWriter.prototype.retrySave = function () {\n        return this.save();\n    };\n    KedBackendWriter.prototype.waitForVersionToPersist = function (version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var persistedVersion;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.persistedVersion.load()];\n                    case 1:\n                        persistedVersion = _a.sent();\n                        if (!(persistedVersion < version)) return [3 /*break*/, 3];\n                        this.save(); // Be more eager to save\n                        return [4 /*yield*/, this.persistedVersion.filter(function (persistedVersion) { return persistedVersion >= version; }).load()];\n                    case 2:\n                        _a.sent();\n                        _a.label = 3;\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendWriter.prototype.save = function () {\n        var _this = this;\n        if (this._timeoutId)\n            clearTimeout(this._timeoutId);\n        if (this._isSavingPromise)\n            return this._isSavingPromise;\n        if (!this.isEdited)\n            return Promise.resolve();\n        this._timeoutId = null;\n        this._isSavingPromise = this._save();\n        this._isSavingPromise.catch(function () { }).then(function () { return _this._isSavingPromise = null; });\n        return this._isSavingPromise;\n    };\n    KedBackendWriter.prototype._save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var mutations, version, mutationRequests, res_1, etagMutations, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.dispatchStateChange();\n                        mutations = this.mutationQueue.get();\n                        version = this.currentVersion;\n                        this.mutationQueue.moveToSavingQueue();\n                        mutationRequests = this.mapMutations(mutations);\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 6, 11, 12]);\n                        return [4 /*yield*/, this.getClient().batch(mutationRequests)];\n                    case 2:\n                        res_1 = _a.sent();\n                        etagMutations = Object.keys(res_1.newEtags).map(function (id) { return ({\n                            op: 'update',\n                            table: null,\n                            id: id,\n                            deltaDoc: { $etag: res_1.newEtags[id] },\n                            targetName: null // We don't have the target name. But this mutation won't be visible in a DeltaCollection anyway, so it wont be used.\n                        }); });\n                        // Invalidate cache\n                        CacheBust.invalidateCache(mutationRequests, this.getUser());\n                        // Commmit mutations along with etagMutations into queries cached data\n                        this.persistedVersion.dispatch(version);\n                        this.deltaCache.applyMutations(mutations, { optimistic: false });\n                        return [4 /*yield*/, this.querySet.commitMutations(MutationQueue.merge(mutations, etagMutations), version)];\n                    case 3:\n                        _a.sent();\n                        // On success, clear saving queue as the mutations will now be committed to all query's data instead.\n                        this.mutationQueue.clearSavingQueue();\n                        this.dispatchStateChange(); // isEdited may have turned to false\n                        // Finally, notify subscribers so that views get updated with committed results\n                        this.querySet.notifySubscribers();\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 5];\n                        // Additional mutations happend while we were saving. Handle them as well.\n                        return [4 /*yield*/, this._save()];\n                    case 4:\n                        // Additional mutations happend while we were saving. Handle them as well.\n                        _a.sent();\n                        _a.label = 5;\n                    case 5: return [3 /*break*/, 12];\n                    case 6:\n                        error_1 = _a.sent();\n                        this.persistedVersion.dispatchError(error_1);\n                        if (!(error_1 && error_1.name && error_1.name.startsWith(\"http4\"))) return [3 /*break*/, 9];\n                        // Access Control denied, bad request or similar. Throw mutations away.\n                        this.dispatchError(error_1, false);\n                        this.mutationQueue.clearSavingQueue();\n                        this.dispatchStateChange(); // isEdited may have turned to false\n                        this.querySet.notifySubscribers();\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 8];\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\n                        return [4 /*yield*/, this._save()];\n                    case 7:\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\n                        _a.sent();\n                        _a.label = 8;\n                    case 8: return [3 /*break*/, 10];\n                    case 9:\n                        this.dispatchError(error_1, true);\n                        _a.label = 10;\n                    case 10: return [3 /*break*/, 12];\n                    case 11:\n                        this.dispatchStateChange();\n                        return [7 /*endfinally*/];\n                    case 12: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedBackendWriter.prototype.mapMutations = function (mutations) {\n        var br = new BatchRunner();\n        mutations.forEach(function (m) {\n            switch (m.op) {\n                case 'update':\n                    br.update(m.table, m.id, m.deltaDoc, m.branchId);\n                    break;\n                case 'add':\n                    br.add(m.table, m.doc);\n                    break;\n                case 'add-related':\n                    if (!m.relatedDoc.$etag) {\n                        // No $etag means this is a new document. Add it before linking to it:\n                        br.add(tables[m.table].relationships[m.graphProp], m.relatedDoc, m.branchId);\n                    }\n                    br.link2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\n                    break;\n                case 'remove-related':\n                    br.unlink2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\n                    break;\n                case 'undo-link':\n                    br.undoLink(m.table, m.id, m.graphProp, m.relatedId, m.branchId);\n                    break;\n                case 'delete':\n                    br.delete(m.table, m.id);\n                    break;\n                case 'clear-branch':\n                    br.clearBranch(m.branchId);\n                    break;\n                case 'merge':\n                    br.merge(m.branchId, m.targetBranchId);\n                    break;\n            }\n        });\n        return br.mutationRequests;\n    };\n    return KedBackendWriter;\n}());\nexport { KedBackendWriter };\n//# sourceMappingURL=kedbackend-writer.js.map","import * as tslib_1 from \"tslib\";\nimport { getTableFromLabel, branchSensitive, globalOp } from './utils';\nimport { mergeDeltas } from './delta-merge';\nvar MutationQueue = /** @class */ (function () {\n    function MutationQueue() {\n        this.queue = [];\n        this.savingQueue = [];\n    }\n    MutationQueue.prototype.add = function (mutations) {\n        this.queue = MutationQueue.merge(this.queue, mutations);\n    };\n    MutationQueue.prototype.moveToSavingQueue = function () {\n        this.savingQueue = MutationQueue.merge(this.savingQueue, this.queue);\n        this.queue = [];\n    };\n    MutationQueue.prototype.clearSavingQueue = function () {\n        this.savingQueue = [];\n    };\n    MutationQueue.prototype.get = function () {\n        return this.savingQueue.concat(this.queue);\n    };\n    MutationQueue.prototype.affectsQuery = function (table, query, includes) {\n        var mutations = this.get();\n        if (mutations.some(function (m) { return m.op === 'merge' || m.op === 'clear-branch'; }))\n            return true;\n        if (query.ids) {\n            // A query with \"ids\" filter will be easy to detect a no-match on:\n            return mutations.some(function (m) { return globalOp(m) || (!branchSensitive(m) || m.branchId === query.branchId) &&\n                query.ids.includes(m.id); });\n        }\n        // Otherwise, check if mutations affect same branch and table. Could be done more fine grained,\n        // but that would only be a suboptimization.\n        return mutations.some(function (m) {\n            return m.op === 'add' ?\n                m.table === table :\n                m.op === 'delete' ?\n                    m.table === table || (includes.some(function (label) { return getTableFromLabel(table, label) === m.table; })) :\n                    globalOp(m) ? true :\n                        m.branchId == query.branchId &&\n                            (m.table === table || (m.op !== 'update' && ([table].concat(includes.map(function (label) { return getTableFromLabel(table, label); })).some(function (table) { return getTableFromLabel(m.table, m.graphProp) === table; }))));\n        });\n    };\n    MutationQueue.merge = function (queue1, queue2) {\n        var mutableQueue1 = queue1.slice();\n        var mutableQueue2 = queue2.slice();\n        //if (mutableQueue1.length > 0) debugger;\n        var len = queue1.length;\n        var _loop_1 = function (i) {\n            var m = queue1[i];\n            if (m.op === 'update') {\n                var overlappingIdOpIdx = mutableQueue2.findIndex(function (newMut) {\n                    return newMut.op === 'update' &&\n                        newMut.branchId === m.branchId &&\n                        newMut.id === m.id;\n                });\n                if (overlappingIdOpIdx >= 0) {\n                    mutableQueue1[i] = tslib_1.__assign({}, m, { deltaDoc: mergeDeltas(m.deltaDoc, mutableQueue2[overlappingIdOpIdx].deltaDoc) });\n                    mutableQueue2.splice(overlappingIdOpIdx, 1);\n                }\n            }\n        };\n        for (var i = 0; i < len; ++i) {\n            _loop_1(i);\n        }\n        return mutableQueue1.concat(mutableQueue2);\n    };\n    return MutationQueue;\n}());\nexport { MutationQueue };\n//# sourceMappingURL=mutation-queue.js.map","import * as tslib_1 from \"tslib\";\nimport { KedBackendQuery } from './kedbackend-query';\nimport * as JsonSchema from 'kedbackend-schema/schema.json';\nimport { queryArray } from './utils';\nvar QuerySet = /** @class */ (function () {\n    function QuerySet(mutationQueue) {\n        this.mutationQueue = mutationQueue;\n        this.queries = [];\n    }\n    QuerySet.prototype.commitMutations = function (mutations, version) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, Promise.all(this.queries.map(function (q) { return q.commitMutations(mutations, version); }))];\n                    case 1:\n                        _a.sent();\n                        this.cleanupInvalidQueries();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    QuerySet.prototype.cleanupInvalidQueries = function () {\n        this.queries = this.queries.filter(function (q) {\n            if (q.invalid) {\n                if (q.timeoutHandle) {\n                    clearTimeout(q.timeoutHandle);\n                    q.timeoutHandle = null;\n                }\n                return false;\n            }\n            return true;\n        });\n    };\n    QuerySet.prototype.notifySubscribers = function () {\n        var optimisticMutations = this.mutationQueue.get();\n        this.queries.forEach(function (q) {\n            q.notifySubscribers(optimisticMutations);\n        });\n    };\n    QuerySet.prototype.findQuery = function (table, query) {\n        return this.queries.find(function (q) { return q.queryKey === KedBackendQuery.queryKey(table, query); });\n    };\n    QuerySet.prototype.queryLocally = function (table, query, includes) {\n        // For now, only handle this very common and special case (which\n        // will save a lot of unnescessary network traffic if I am thinking right...)\n        var mutations = this.mutationQueue.get();\n        // Check if the query wants to get a single entity by its ID:\n        if (query.ids && query.ids.length === 1) {\n            // And if so, if we have an outgoing mutation to create that entity:\n            if (mutations.some(function (m) { return m.op === 'add-related' && m.relatedDoc.id === query.ids[0]; })) {\n                // Then return an EMPTY response, signalling that we can resolve this locally,\n                // but let the optistic feature of KedBackendQuery apply the mutation before\n                // notifying subscribers (we don't want it to be persistent before the server\n                // has accepted the mutation)\n                return [];\n            }\n        }\n        // OK, another quite common case is when we ask for a certain ID and that ID replies\n        // within another query\n        if (query.hasEdgesFrom || query.hasEdgesTo)\n            return null; // Not possible to handle\n        if (!query.ids)\n            return null; // For now, just take hight for this particular and most common case!\n        var _loop_1 = function (q) {\n            if (!q.gotInitialResponse)\n                return \"continue\";\n            if (q.query.branchId !== query.branchId)\n                return \"continue\";\n            if (q.query.flags)\n                return \"continue\"; // It would be complex to support various flags. Query's data may include ids only. Can't rely on the query.\n            var qIncludes = q.includes;\n            if (qIncludes.length > 0 && (!query.include || query.include.length === 0)) {\n                // We don't include, but this query does. Check if we can find our result within it.\n                var label = qIncludes.find(function (l) { return JsonSchema.tables[q.table][\"relationships\"][l] === table; });\n                if (label) {\n                    var res_1 = {};\n                    for (var _i = 0, _a = q.data; _i < _a.length; _i++) {\n                        var entity = _a[_i];\n                        var subData = queryArray(query, entity[label]);\n                        subData.forEach(function (r) { return res_1[r.id] = r; });\n                    }\n                    var result_1 = Object.keys(res_1).map(function (id) { return res_1[id]; });\n                    // Only return result if we could look up every requested ID:\n                    if (!query.ids.every(function (id) { return result_1.some(function (x) { return x.id === id; }); }))\n                        return \"continue\";\n                    return { value: result_1 };\n                }\n            }\n            if (!includes.every(function (label) { return qIncludes.includes(label); }))\n                return \"continue\";\n            // Lastly, if the query includes all graphs that we do, pick the subset from that query.\n            // Concrete example: We observe a certain Task by ID and want its knowledgeRequirements along with it,\n            // and there's another query of all tasks that also includes knowledgeRequirements. Use it. \n            if (q.table === table) {\n                var result_2 = queryArray(query, q.data);\n                // Only return result if we could look up every requested ID:\n                if (!query.ids.every(function (id) { return result_2.some(function (x) { return x.id === id; }); }))\n                    return \"continue\";\n                return { value: result_2 };\n            }\n        };\n        for (var _i = 0, _a = this.queries; _i < _a.length; _i++) {\n            var q = _a[_i];\n            var state_1 = _loop_1(q);\n            if (typeof state_1 === \"object\")\n                return state_1.value;\n        }\n    };\n    QuerySet.prototype.subscribe = function (subscription) {\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\n        var kbQuery = this.findQuery(table, query);\n        if (!kbQuery) {\n            kbQuery = new KedBackendQuery(table, query, repo.getUser(), repo, this.mutationQueue);\n            this.queries.push(kbQuery);\n        }\n        else {\n            if (kbQuery.timeoutHandle) {\n                clearTimeout(kbQuery.timeoutHandle);\n                kbQuery.timeoutHandle = null;\n            }\n        }\n        kbQuery.subscribe(subscription);\n    };\n    QuerySet.prototype.unsubscribe = function (subscription) {\n        var _this = this;\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\n        var kbQuery = this.findQuery(table, query);\n        if (kbQuery) {\n            // Prohibit further notifications to this subscription:\n            kbQuery.unsubscribe(subscription);\n            // Release unnescessary memory when there are no more subscriptions of this query, by removing the query itself\n            // To that in a delayed manner, so that an unsubscribe() followed by an immediate subscribe() don't have to re-query the server:\n            if (kbQuery.subscriptions.length === 0) {\n                // Schedule for garbage collection in 5 minutes:\n                kbQuery.timeoutHandle = setTimeout(function () {\n                    // Check if kbQuery still has no subscriptions (not certain! A new subscriber may have come along...)\n                    if (kbQuery.subscriptions.length === 0) {\n                        // Still no subscriptions on it, time to release some memory and forget the in-memory cache of the query result\n                        _this.queries = _this.queries.filter(function (q) { return q !== kbQuery; });\n                    }\n                }, this.queries.length > 50 ?\n                    500 : // Don't host too many queries. Garbage collect this within 500 ms\n                    5 * 60000); // Allow query in memory for another 5 minutes\n            }\n        }\n    };\n    return QuerySet;\n}());\nexport { QuerySet };\n//# sourceMappingURL=query-set.js.map","import { tables } from 'kedbackend-schema/schema.json';\nexport function getTableFromLabel(table, label) {\n    return tables[table].relationships[label];\n}\nexport function queryArray(query, data) {\n    var filter = getFilterFromQuery(query);\n    return data.filter(filter);\n}\nexport function AND(filter1, filter2) {\n    return function (x) { return filter1(x) && filter2(x); };\n}\nexport function getFilterFromQuery(query) {\n    var filter = function (x) { return true; };\n    if (query.from)\n        return AND(filter, function (x) { return x.dateTime >= query.from; });\n    if (query.to)\n        return AND(filter, function (x) { return x.dateTime < query.to; });\n    if (query.ids)\n        return AND(filter, function (x) { return query.ids.includes(x.id); });\n    if (query.name)\n        return AND(filter, function (x) { return x.name === query.name; });\n    if (query.tags)\n        return AND(filter, function (x) { return x.tags && [].concat(query.tags || []).some(function (tag) { return x.tags.includes(tag); }); });\n    // query.hasEdgesFrom and query.hasEdgesTo cannot by filtered here\n    return filter;\n}\nexport function branchSensitive(m) {\n    return m.op !== 'delete';\n}\nexport function globalOp(m) {\n    return m.op === 'clear-branch' || m.op === 'merge';\n}\n//# sourceMappingURL=utils.js.map","import migrate from './migrate';\nexport var KedModelMigratorMixin = function (client) {\n    if (client.__migrator_mixed_in)\n        return;\n    client.__migrator_mixed_in = true;\n    var get = client.get;\n    var list = client.list;\n    client.get = function (table, id, options) {\n        var include = options && options.include;\n        return get.apply(this, arguments).then(function (result) {\n            migrate(result, table, include && include.toString().split(','));\n            return result;\n        });\n    };\n    client.list = function (table, options) {\n        var include = options && options.include;\n        return list.apply(this, arguments).then(function (result) {\n            result.forEach(function (doc) { return migrate(doc, table, include && include.toString().split(',')); });\n            return result;\n        });\n    };\n    return client;\n};\n//# sourceMappingURL=index.js.map","import migrateTask from './migrate-task';\nexport default function migrateCourse(course, graphs) {\n    if (!course.modules)\n        course.modules = [];\n    course.modules.forEach(function (module) {\n        if (!module.resources) {\n            module.resources = [];\n        }\n        if (!module.taskIds) {\n            module.taskIds = [];\n        }\n    });\n    if (!course.responsibleTeachers) {\n        course.responsibleTeachers = [];\n    }\n    // Earlier wrong spelling of resources\n    if ('resourses' in course && !('resources' in course)) {\n        course.resources = course.resourses;\n        delete course.resourses;\n    }\n    if (!course.resources) {\n        course.resources = [];\n    }\n    if (graphs) {\n        graphs.forEach(function (label) {\n            switch (label) {\n                case 'tasks':\n                    course.tasks.forEach(function (task) { return migrateTask(task); });\n                    break;\n            }\n        });\n    }\n}\n//# sourceMappingURL=migrate-course.js.map","export default function migrateTask(task) {\n    if (!task.resources)\n        task.resources = [];\n}\n//# sourceMappingURL=migrate-task.js.map","import migrateCourse from './migrate-course';\nimport migrateTask from './migrate-task';\nexport default function migrate(doc, table, graphs) {\n    switch (table) {\n        case \"courses\":\n            migrateCourse(doc, graphs);\n            break;\n        case \"tasks\":\n            migrateTask(doc);\n            break;\n    }\n}\n//# sourceMappingURL=migrate.js.map","import * as tslib_1 from \"tslib\";\nimport { Observable } from \"./observable\";\nimport { initMapMethod } from \"./map\";\nimport { Value } from \"./value\";\nimport { Emitter } from \"./emitter\";\nvar Collection = /** @class */ (function (_super) {\n    tslib_1.__extends(Collection, _super);\n    function Collection(subscribe) {\n        return _super.call(this, subscribe) || this;\n    }\n    Collection.prototype._map = function (mapper) {\n        throw \"mixedin\";\n    };\n    Collection.from = function (x) {\n        if (x.subscribe)\n            return new Collection(function (s) { return x.subscribe(s); });\n        if (Array.isArray(x)) {\n            var emitter_1 = new Emitter(x);\n            return new Collection(function (s) { return emitter_1.subscribe(s); });\n        }\n        throw new Error(\"ObservableCollection.from() can only take arrays or observables\");\n    };\n    Collection.prototype.map = function (mapper) {\n        return this._map(function (items) { return items.map(function (item) { return mapper(item); }); });\n    };\n    Collection.prototype.flat = function () {\n        return this._map(function (items) { return [].concat.apply([], items); });\n    };\n    Collection.prototype.filter = function (filter) {\n        return this._map(function (items) { return items.filter(filter); });\n    };\n    Collection.prototype.concat = function (other) {\n        return Collection.from(this.toValue().combineLatest(other).map(function (_a) {\n            var me = _a[0], other = _a[1];\n            return me.concat(other);\n        }));\n    };\n    Collection.prototype.orderBy = function (prop) {\n        return this.toValue().map(function (array) { return array.slice().sort(function (a, b) {\n            var aProp = a && a[prop];\n            var bProp = b && b[prop];\n            return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\n        }); }).toCollection(function (x) { return x; });\n    };\n    Collection.prototype.toValue = function () {\n        var _this = this;\n        return new Value(function (s) { return _this.subscribe(s); });\n    };\n    Collection.prototype.groupBy = function (prop) {\n        return this.toValue().map(function (items) {\n            var rv = {};\n            items.forEach(function (item) {\n                var list = rv[item[prop]] || (rv[item[prop]] = []);\n                list.push(item);\n            });\n            return rv;\n        });\n    };\n    Collection.prototype.first = function () {\n        return this.toValue().map(function (arr) { return arr[0]; });\n    };\n    return Collection;\n}(Observable));\nexport { Collection };\nCollection.prototype._map = initMapMethod(Collection);\n//# sourceMappingURL=collection.js.map","import * as tslib_1 from \"tslib\";\nimport { Value } from \"./value\";\nvar Emitter = /** @class */ (function (_super) {\n    tslib_1.__extends(Emitter, _super);\n    function Emitter(initialValue) {\n        var _this = _super.call(this, function (observer) {\n            var subscription = {\n                unsubscribe: function () { return _this.subscribers = _this.subscribers.filter(function (_a) {\n                    var s = _a[0];\n                    return s !== observer;\n                }); },\n            };\n            _this.subscribers.push([observer, subscription]);\n            if (_this.error)\n                observer(null, _this.error, subscription);\n            else\n                observer(_this.value, undefined, subscription);\n            return subscription;\n        }) || this;\n        _this.subscribers = [];\n        _this.value = initialValue;\n        return _this;\n    }\n    Emitter.prototype.dispatch = function (value) {\n        this.value = value;\n        this.error = undefined;\n        this._dispatch();\n    };\n    Emitter.prototype.dispatchError = function (error) {\n        this.error = error;\n        this._dispatch();\n    };\n    Emitter.prototype._dispatch = function () {\n        var _this = this;\n        this.subscribers.forEach(function (_a) {\n            var observer = _a[0], subscription = _a[1];\n            try {\n                observer(_this.value, _this.error, subscription);\n            }\n            catch (err) {\n                observer(null, err, subscription);\n            }\n        });\n    };\n    return Emitter;\n}(Value));\nexport { Emitter };\n//# sourceMappingURL=emitter.js.map","var stack = [];\nvar currentFiber = null;\nvar providers = [function () { return currentFiber; }];\nfunction pushFiber(fiber) {\n    stack.push(currentFiber);\n    currentFiber = fiber;\n}\nfunction popFiber() {\n    currentFiber = stack.pop();\n}\nvar _FiberContext = {\n    get current() { return currentFiber; },\n    /*run: function rerun<R>(fiber: Fiber, fn: ()=>R): R | Promise<R> {\n      pushFiber(fiber);\n      try {\n        return Promise.resolve(fn());\n      } catch (p) {\n        if (p && typeof p.then === 'function') {\n          return p.then(()=>rerun(fiber, fn));\n        } else {\n          return Promise.reject(p);\n        }\n      } finally {\n        popFiber();\n      }\n    },*/\n    addProvider: function (getCurrentFiber) {\n        providers.push(getCurrentFiber);\n        setCurrentGetterFromProviders();\n    },\n    removeProvider: function (getCurrentFiber) {\n        providers = providers.filter(function (p) { return p !== getCurrentFiber; });\n        setCurrentGetterFromProviders();\n    }\n};\nfunction setCurrentGetterFromProviders() {\n    Object.defineProperty(_FiberContext, \"current\", {\n        get: providers.reduce(function (p, c) { return function () { return p() || c(); }; }),\n        set: function () { throw new Error(\"Use FiberContext.push() to change current fiber\"); }\n    });\n}\nvar _global = (typeof self === 'undefined' ? global : self);\nif (!_global[\"KEDFiberContext\"]) {\n    _global[\"KEDFiberContext\"] = _FiberContext;\n}\nexport var FiberContext = _global[\"KEDFiberContext\"];\n//# sourceMappingURL=fiber-context.js.map","export * from './observable';\nexport * from './value';\nexport * from './collection';\nexport * from './emitter';\nexport * from './fiber-context';\n//# sourceMappingURL=index.js.map","export function initMapMethod(ctor) {\n    return function (mapper) {\n        var _this = this;\n        return new ctor(function (observer) { return _this.subscribe(function (value, error, subscription) {\n            if (error)\n                observer(null, error, subscription);\n            else\n                try {\n                    observer(mapper(value), error, subscription);\n                }\n                catch (err) {\n                    observer(null, err, subscription);\n                }\n        }); });\n    };\n}\n//# sourceMappingURL=map.js.map","export function mixin(targetProto, mixinProto) {\n    var props = [];\n    for (var _i = 2; _i < arguments.length; _i++) {\n        props[_i - 2] = arguments[_i];\n    }\n    props.forEach(function (prop) { return targetProto[prop] = mixinProto[prop]; });\n}\n//# sourceMappingURL=mixin.js.map","var Observable = /** @class */ (function () {\n    //static get [Symbol.species]() { return this; }\n    function Observable(_subscribe) {\n        this._subscribe = _subscribe;\n    }\n    Observable.prototype.subscribe = function (observer) {\n        try {\n            return this._subscribe(function (items, error, subscription) {\n                try {\n                    observer(items, error, subscription);\n                }\n                catch (err) {\n                    observer(null, err, subscription);\n                }\n            });\n        }\n        catch (error) {\n            observer(null, error, { unsubscribe: function () { } });\n        }\n    };\n    return Observable;\n}());\nexport { Observable };\n//# sourceMappingURL=observable.js.map","import * as tslib_1 from \"tslib\";\nimport { Observable } from \"./observable\";\nimport { initMapMethod } from \"./map\";\nimport { Collection } from \"./collection\";\nimport { FiberContext } from './fiber-context';\nvar Value = /** @class */ (function (_super) {\n    tslib_1.__extends(Value, _super);\n    function Value(subscribe) {\n        return _super.call(this, subscribe) || this;\n    }\n    Value.from = function (x) {\n        if (x.subscribe)\n            return new Value(function (s) { return x.subscribe(s); });\n        throw new Error(\"Value.from() can only take observables\");\n    };\n    Value.prototype.read = function () {\n        var resolved = false, result, err, notify;\n        var subscription = this.subscribe(function (value, error, subsciption) {\n            resolved = true;\n            result = value;\n            err = error;\n            if (error && notify)\n                notify(null, error, subsciption);\n            else if (notify)\n                notify(value, null, subsciption);\n        });\n        if (resolved) {\n            var currentFiber = FiberContext.current;\n            if (!currentFiber) {\n                subscription.unsubscribe();\n                throw new Error(\"Invalid Fiber Context\");\n            }\n            if (err) {\n                subscription.unsubscribe();\n                throw err;\n            }\n            var subscriptions = currentFiber.subscriptions, observer = currentFiber.observer;\n            subscriptions.push(subscription);\n            notify = observer;\n            return result;\n        }\n        throw new Promise(function (resolve, reject) {\n            notify = function (value, error, subscription) {\n                subscription.unsubscribe();\n                if (error)\n                    reject(error);\n                else\n                    resolve(value);\n            };\n        });\n    };\n    Value.prototype.load = function () {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            _this.subscribe(function (value, error, subsciption) {\n                if (error)\n                    reject(error);\n                else\n                    resolve(value);\n                subsciption.unsubscribe();\n            });\n        });\n    };\n    Value.prototype.filter = function (fn) {\n        var _this = this;\n        return new Value(function (observer) { return _this.subscribe(function (value, error, subscription) {\n            if (error)\n                observer(null, error, subscription);\n            else if (fn(value))\n                observer(value, error, subscription);\n        }); });\n    };\n    Value.prototype.log = function (prefix) {\n        return this.map(function (x) {\n            console.log(prefix, x);\n            return x;\n        });\n    };\n    Value.prototype.toCollection = function (mapper) {\n        var _this = this;\n        return new Collection(function (s) { return _this.map(mapper).subscribe(s); });\n    };\n    Value.prototype.combineLatest = function (other) {\n        var _this = this;\n        return new Value(function (observer) {\n            var values = [null, null];\n            var mySubscription, otherSubscription;\n            var subscription = {\n                unsubscribe: function () {\n                    mySubscription.unsubscribe();\n                    otherSubscription.unsubscribe();\n                }\n            };\n            mySubscription = _this.subscribe(function (items, error, s) {\n                if (error) {\n                    s.unsubscribe();\n                    observer(null, error, subscription);\n                }\n                values[0] = items;\n                if (values[1] !== null)\n                    observer(values, null, subscription);\n            });\n            otherSubscription = other.subscribe(function (value, error, s) {\n                if (error) {\n                    s.unsubscribe();\n                    observer(null, error, subscription);\n                }\n                values[1] = value;\n                if (values[0] !== null)\n                    observer(values, null, subscription);\n            });\n            return subscription;\n        });\n    };\n    Value.prototype.switchMap = function (mapper) {\n        var _this = this;\n        return new Value(function (observer) {\n            var mappedSubscription = null;\n            var subscription = null;\n            var returnedSubscription = {\n                unsubscribe: function () {\n                    subscription.unsubscribe();\n                    if (mappedSubscription) {\n                        mappedSubscription.unsubscribe();\n                        mappedSubscription = null;\n                    }\n                }\n            };\n            subscription = _this.subscribe(function (item, error, s) {\n                subscription = s;\n                if (mappedSubscription) {\n                    mappedSubscription.unsubscribe();\n                    mappedSubscription = null;\n                }\n                if (error)\n                    observer(null, error, returnedSubscription);\n                else {\n                    try {\n                        var observableOrValue = mapper(item);\n                        if (observableOrValue && typeof observableOrValue.subscribe === 'function') {\n                            mappedSubscription = observableOrValue.subscribe(function (value, error, s) {\n                                mappedSubscription = s;\n                                observer(value, error, returnedSubscription);\n                            });\n                        }\n                        else {\n                            observer(observableOrValue, null, subscription);\n                        }\n                    }\n                    catch (error) {\n                        observer(null, error, subscription);\n                    }\n                }\n            });\n            return returnedSubscription;\n        });\n    };\n    return Value;\n}(Observable));\nexport { Value };\nValue.prototype.map = initMapMethod(Value);\n//# sourceMappingURL=value.js.map","export * from './js/dist/js/observable';\n","export * from './js/dist/js/ked-backend-repo';\n","export default function getUserClaims(user) {\n    return [{\n            type: \"email\",\n            value: user.mail\n        }, {\n            type: \"school\",\n            value: user.school\n        }].concat(user.roles.map(function (role) { return ({\n        type: \"role\",\n        value: role\n    }); })).concat(user.roles.map(function (role) { return ({\n        type: \"schoolRole\",\n        value: user.school + \"/\" + role\n    }); }));\n}\n","import * as tslib_1 from \"tslib\";\nimport { DocumentAccess, hasAccess as _hasAccess } from 'kedbackend/client';\nimport getUserClaims from './get-user-claims';\nimport { parseQueryString, generateQueryString } from \"../utils/query-string\";\nexport { getUserClaims };\nexport var IMPERSONATION_QUERY_PARAMS = [\n    \"user\",\n    \"role\",\n    \"school\",\n    \"debug\",\n    \"testVersion\",\n    \"testversion\",\n    \"features\",\n    \"schoolGrade\",\n    \"schoolgrade\",\n    \"schoolType\",\n    \"schooltype\"\n];\nexport function hasAccess(user, doc, requestedRight) {\n    var claims = getUserClaims(user);\n    if (requestedRight !== 'R' && user.tutorFor) {\n        claims = claims.filter(function (claim) { return claim.type !== 'email'; });\n    }\n    var result = _hasAccess(DocumentAccess.fromStringArray(doc.acl || []), claims, requestedRight);\n    //console.log(`Has ${requestedRight} access to ${doc.name}/${doc.id}: ${result}`);\n    return result;\n}\nexport function hasReadAccess(user, doc) {\n    return hasAccess(user, doc, 'R');\n}\nexport function hasWriteAccess(user, doc) {\n    return hasAccess(user, doc, 'W');\n}\nexport function hasShareAccess(user, doc) {\n    return hasAccess(user, doc, 'S');\n}\nexport function isTeacherAtSchool(user, school) {\n    var isTeacher = user.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\n    var belongsToSchool = (school || \"\").toLowerCase() === user.school.toLowerCase();\n    return (isTeacher && belongsToSchool);\n}\nexport function isAdminOrTeacherAtSchool(user, school) {\n    return user.roles.includes(\"ADMIN\") || isTeacherAtSchool(user, school);\n}\nexport var impersonationEnv = {\n    actAs: function (options) {\n        var role = options.role, school = options.school, url = options.url;\n        var currentQuery = parseQueryString(location.search);\n        var newQuery = tslib_1.__assign({}, currentQuery, { role: role, school: school });\n        var newQueryString = generateQueryString(newQuery);\n        if (url) {\n            location.href = \"\" + url + newQueryString;\n        }\n        else {\n            location.hash = \"#\";\n            location.search = newQueryString;\n        }\n    }\n};\nexport function actAs(options) {\n    impersonationEnv.actAs(options);\n}\nexport function preserveImpersonationQuery(url, query) {\n    var e_1, _a;\n    var currentQuery = parseQueryString(location.search);\n    var preservedQuery = {};\n    try {\n        for (var IMPERSONATION_QUERY_PARAMS_1 = tslib_1.__values(IMPERSONATION_QUERY_PARAMS), IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next(); !IMPERSONATION_QUERY_PARAMS_1_1.done; IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next()) {\n            var param = IMPERSONATION_QUERY_PARAMS_1_1.value;\n            if (currentQuery[param])\n                preservedQuery[param] = currentQuery[param];\n        }\n    }\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\n    finally {\n        try {\n            if (IMPERSONATION_QUERY_PARAMS_1_1 && !IMPERSONATION_QUERY_PARAMS_1_1.done && (_a = IMPERSONATION_QUERY_PARAMS_1.return)) _a.call(IMPERSONATION_QUERY_PARAMS_1);\n        }\n        finally { if (e_1) throw e_1.error; }\n    }\n    var newQueryString = generateQueryString(tslib_1.__assign({}, preservedQuery, query));\n    var pHash = url.indexOf('#');\n    return pHash >= 0 ?\n        \"\" + url.substr(0, pHash) + newQueryString + url.substr(pHash) :\n        \"\" + url + newQueryString;\n}\n","import * as tslib_1 from \"tslib\";\nimport { RestClient } from 'kedbackend/client';\nimport { HttpError } from 'kedbackend/client';\nimport { getTermStarEndDate } from '../utils/school-moment';\nimport { SchoolTerm } from '../utils/school-term';\nimport { dateTimeReviver, L } from '../utils/utils';\nimport mockJsonFile from './mock/mock-eds-data.json';\nimport moment from 'moment';\nimport { makeSuspenseApi } from '../utils/make-suspense-api';\nvar EdsClient = /** @class */ (function () {\n    function EdsClient(isomorphic, baseUrl, bearerProvider, userEmailGetter) {\n        var _this = this;\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\n        this.userEmailGetter = userEmailGetter;\n        var isApiMethod = function (m) {\n            return typeof _this[m] === 'function' &&\n                m !== 'constructor' && // Since makeSuspenseApi() walks prototype chain\n                m !== 'privatizingCacheBust' &&\n                m !== 'userEmailGetter';\n        } // List non-API methods here...\n        ;\n        Object.keys(EdsClient.prototype).forEach(function (method) {\n            if (isApiMethod(method)) {\n                _this[method] = avoidSimultanousCalls(_this[method]);\n            }\n        });\n        this.suspense = makeSuspenseApi(this, { isApiMethod: isApiMethod });\n    }\n    EdsClient.prototype.privatizingCacheBust = function () {\n        return { user: this.userEmailGetter() };\n    };\n    /**\n       * Retrieve active courses for current logged in student.\n       *\n       * @param courseCode Short-name of the course. Optional.\n       */\n    EdsClient.prototype.getActiveCourses = function (q) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var query, res, _a, _b, json, ex_1;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _c.trys.push([0, 5, , 6]);\n                        query = this.privatizingCacheBust();\n                        if (q) {\n                            if (q.courseCode)\n                                query.CourseCode = q.courseCode;\n                            if (q.periodName)\n                                query.PeriodName = q.periodName;\n                        }\n                        return [4 /*yield*/, this.http.get(\"studentactivecourses\", query)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.courses];\n                    case 5:\n                        ex_1 = _c.sent();\n                        console.error(\"Error from EDS: \" + ex_1);\n                        throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"], [\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"]))));\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Retrieve latest assessments for current logged in user.\n     *\n     * @param limit Optional limit\n     */\n    EdsClient.prototype.getLatestAssessments = function (limit) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var query, res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        query = this.privatizingCacheBust();\n                        if (!isNaN(limit))\n                            query.Count = limit;\n                        return [4 /*yield*/, this.http.get(\"studentassessments\", query)];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.assessments];\n                }\n            });\n        });\n    };\n    /**\n     * Retrieve studyplans for current logged-in user\n     */\n    EdsClient.prototype.getStudentGoals = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"studentgoals\", this.privatizingCacheBust())];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.studentGoals];\n                }\n            });\n        });\n    };\n    EdsClient.prototype.getStudentFutureAbilities = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"studentFutureAbilities\", this.privatizingCacheBust())];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.studentFutureAbilities];\n                }\n            });\n        });\n    };\n    EdsClient.prototype.getTeacherTutorStudents = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"teachertutorstudents\", this.privatizingCacheBust())];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.students];\n                }\n            });\n        });\n    };\n    /**\n     * getSchoolTuitionGroups()\n     *\n     * Return tuitiongroups for school\n     *\n     * @param schoolName - name of school\n     * @param courseCode - Skolverkets code for course\n     */\n    EdsClient.prototype.getSchoolTuitionGroups = function (q) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTuitionGroups\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.schoolTuitionGroups];\n                }\n            });\n        });\n    };\n    /**\n     * getTuitionGroupStudents()\n     *\n     * Return name and mailadresses for tutitiongroups in schools\n     *\n     * @param schoolName - name of school\n     * @param tuitionGroupName - tuition gruop name in EDS\n     */\n    EdsClient.prototype.getTuitionGroupStudents = function (q) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"TuitionGroupStudents\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.tuitionGroupStudents];\n                }\n            });\n        });\n    };\n    /**\n     * getSchoolTeachers()\n     *\n     * Return name and mailadresses for tutitiongroups in schools\n     *\n     * @param schoolName - name of school\n     */\n    EdsClient.prototype.getSchoolTeachers = function (q) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, _a, _b, json;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTeachers\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\n                    case 1:\n                        res = _c.sent();\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\n                        _a = HttpError.bind;\n                        _b = [void 0, res.status];\n                        return [4 /*yield*/, res.text()];\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\n                    case 3: return [4 /*yield*/, res.json()];\n                    case 4:\n                        json = _c.sent();\n                        return [2 /*return*/, json.schoolTeachers];\n                }\n            });\n        });\n    };\n    // we assume that the EDS will return the current academic year dates determined by the current date\n    EdsClient.prototype.getAcademicYearTerms = function (schoolLocale, date) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var holidays, firstTermMoment, secondTermMoment, startFirstTermDate, startSecondTermDate, endFirstTermDate, endSecondTermDate, firstTerm, secondTerm;\n            return tslib_1.__generator(this, function (_a) {\n                // mock data\n                switch (schoolLocale) {\n                    case 'en_sin':\n                        return [2 /*return*/, mockJsonFile.SouthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\n                    case 'en_nin':\n                        return [2 /*return*/, mockJsonFile.NorthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\n                    case 'sv':\n                        {\n                            holidays = [];\n                            firstTermMoment = getTermStarEndDate(date, true);\n                            secondTermMoment = getTermStarEndDate(date, false);\n                            startFirstTermDate = firstTermMoment[0];\n                            startSecondTermDate = secondTermMoment[0];\n                            endFirstTermDate = firstTermMoment[1];\n                            endSecondTermDate = secondTermMoment[1];\n                            firstTerm = { startDate: new Date(startFirstTermDate.year(), startFirstTermDate.month(), startFirstTermDate.date()).toDateString(), endDate: new Date(startFirstTermDate.year(), endFirstTermDate.month(), endFirstTermDate.date()).toDateString() };\n                            secondTerm = { startDate: new Date(startSecondTermDate.year(), startSecondTermDate.month(), startSecondTermDate.date()).toDateString(), endDate: new Date(startSecondTermDate.year(), endSecondTermDate.month(), endSecondTermDate.date()).toDateString() };\n                            return [2 /*return*/, { firstTerm: firstTerm, secondTerm: secondTerm, holidays: holidays }];\n                        }\n                }\n                return [2 /*return*/];\n            });\n        });\n    };\n    return EdsClient;\n}());\nexport { EdsClient };\nvar EDSPeriod = /** @class */ (function () {\n    function EDSPeriod(periodStringOrSchoolTerm) {\n        if (typeof periodStringOrSchoolTerm === 'string') {\n            this.period = periodStringOrSchoolTerm;\n            this.term = this.period.startsWith('HT') ? 'AT' : 'ST';\n            this.year = parseInt(this.period.substr(2));\n            if (isNaN(this.year))\n                throw new Error(\"Invalid period: \" + this.period);\n        }\n        else {\n            var schoolTerm = new SchoolTerm(periodStringOrSchoolTerm);\n            this.period = (schoolTerm.term === 'AT' ? \"HT\" : \"VT\") + schoolTerm.year;\n            this.term = schoolTerm.term;\n            this.year = schoolTerm.year;\n        }\n    }\n    Object.defineProperty(EDSPeriod.prototype, \"schoolTerm\", {\n        get: function () {\n            return new SchoolTerm({\n                academicYear: this.term === 'AT' ?\n                    this.year + \"/\" + (this.year + 1) :\n                    this.year - 1 + \"/\" + this.year,\n                term: this.term\n            });\n        },\n        enumerable: true,\n        configurable: true\n    });\n    EDSPeriod.prototype.toString = function () {\n        return this.period;\n    };\n    EDSPeriod.prototype.valueOf = function () {\n        return this.year + \":\" + (this.term === 'ST' ? \"1\" : \"2\");\n    };\n    return EDSPeriod;\n}());\nexport { EDSPeriod };\nexport function parseJsonDate_old(jsonDateStr) {\n    var date = dateTimeReviver(\"\", jsonDateStr);\n    if (!(date instanceof Date))\n        throw new Error(\"Invalid JSON date string: \" + jsonDateStr);\n    return date;\n}\nfunction avoidSimultanousCalls(method) {\n    var ongoingPromises = {};\n    return function () {\n        var argsJson = JSON.stringify([].slice.call(arguments));\n        if (!ongoingPromises[argsJson]) {\n            ongoingPromises[argsJson] = method.apply(this, arguments).then(function (result) {\n                delete ongoingPromises[argsJson];\n                return result;\n            });\n        }\n        return ongoingPromises[argsJson];\n    };\n}\nvar templateObject_1;\n","import * as tslib_1 from \"tslib\";\nimport { GoogleClient } from './google-client';\nvar GoogleCalendar = /** @class */ (function (_super) {\n    tslib_1.__extends(GoogleCalendar, _super);\n    function GoogleCalendar(googleTokenProvider) {\n        var _this = _super.call(this, { discoveryDocs: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest' }) || this;\n        _this.setBearerProvider(googleTokenProvider);\n        return _this;\n    }\n    GoogleCalendar.prototype.listCalendars = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res, err_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.ensureInited()];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2:\n                        _a.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, gapi.client.calendar.calendarList.list({})];\n                    case 3:\n                        res = _a.sent();\n                        // TODO: What is the normal res.status? 200? Throw if not 200?\n                        return [2 /*return*/, res.result.items];\n                    case 4:\n                        err_1 = _a.sent();\n                        // TODO: Parse out error from err (which is an object!)\n                        throw err_1.error; // Is this correct? Test!\n                    case 5: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    GoogleCalendar.prototype.batchEvents = function (_a) {\n        var calendarList = _a.calendarList, timeMin = _a.timeMin, timeMax = _a.timeMax;\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var batch_1;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this.ensureInited()];\n                    case 1:\n                        _b.sent();\n                        try {\n                            batch_1 = gapi.client.newBatch();\n                            calendarList.forEach(function (cal) {\n                                batch_1.add(gapi.client.calendar.events.list({\n                                    'calendarId': cal.id || 'primary',\n                                    'timeMin': timeMin && (new Date(timeMin)).toISOString(),\n                                    'timeMax': timeMax && (new Date(timeMax)).toISOString(),\n                                    'showDeleted': false,\n                                    'singleEvents': true,\n                                    'fields': 'items/id,items/start,items/end,items/summary,items/location,items/htmlLink,items/description',\n                                    'maxResults': 2500,\n                                    'orderBy': 'startTime'\n                                }), { 'id': cal.id });\n                            });\n                            return [2 /*return*/, batch_1.then(function (resp) {\n                                    var newCals = {};\n                                    for (var i in calendarList) {\n                                        var calId = calendarList[i].id;\n                                        var events = resp.result[calId].result.items;\n                                        newCals[calId] = { calendar: calendarList[i], events: events };\n                                    }\n                                    return newCals;\n                                })];\n                        }\n                        catch (err) {\n                            throw err.error;\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return GoogleCalendar;\n}(GoogleClient));\nexport { GoogleCalendar };\n","import * as tslib_1 from \"tslib\";\nimport { env } from '../globals/KED.env';\nvar GoogleClient = /** @class */ (function () {\n    function GoogleClient(_a) {\n        var discoveryDocs = _a.discoveryDocs;\n        this.googleTokenProvider = env.googleTokenProvider;\n        this.discoveryDocs = [];\n        this.discoveryDocs.push(discoveryDocs);\n    }\n    GoogleClient.prototype.setBearerProvider = function (googleTokenProvider) {\n        this.googleTokenProvider = googleTokenProvider;\n    };\n    GoogleClient.prototype.ensureInited = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var tokenResult;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!(typeof gapi === 'undefined')) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.loadGapi()];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2:\n                        if (!(!this.tokenExpiration || this.tokenExpiration < new Date())) return [3 /*break*/, 4];\n                        return [4 /*yield*/, this.googleTokenProvider.getBearer()];\n                    case 3:\n                        tokenResult = _a.sent();\n                        this.tokenExpiration = new Date(tokenResult.expires);\n                        this.token = tokenResult.token;\n                        _a.label = 4;\n                    case 4: \n                    // Load all discovyerDocs\n                    return [4 /*yield*/, gapi.client.init({\n                            discoveryDocs: this.discoveryDocs\n                        })];\n                    case 5:\n                        // Load all discovyerDocs\n                        _a.sent();\n                        return [4 /*yield*/, gapi.client.setToken({\n                                access_token: this.token\n                            })];\n                    case 6:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    GoogleClient.prototype.loadGapi = function () {\n        return new Promise(function (resolve) {\n            if (typeof gapi !== 'undefined')\n                return resolve();\n            var script = document.createElement('script');\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\n            window.gaapi_loaded = resolve;\n        });\n    };\n    return GoogleClient;\n}());\nexport { GoogleClient };\n","import * as tslib_1 from \"tslib\";\nexport function getLearningGoalsAndTasks(apiPath, pageId) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n        var res, data;\n        return tslib_1.__generator(this, function (_a) {\n            switch (_a.label) {\n                case 0: return [4 /*yield*/, fetch(apiPath + \"?nodeID=\" + pageId, { credentials: \"same-origin\" })];\n                case 1:\n                    res = _a.sent();\n                    return [4 /*yield*/, res.json()];\n                case 2:\n                    data = _a.sent();\n                    return [2 /*return*/, data];\n            }\n        });\n    });\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport env from '../../globals/KED.env';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { Calendar } from './index';\nexport function CalendarSelf(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(Calendar, tslib_1.__assign({}, tslib_1.__assign({}, props, { env: env }))));\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { Calendar } from './index';\nimport { TutorableComponent } from '../utility-components/tutorable-component';\nexport function CalendarTutored(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\n                return React.createElement(Calendar, tslib_1.__assign({ key: env.currentUser.mail }, props, { env: env }));\n            } }));\n}\n","export function courseNameToCssClass(cssPrefix, courseName) {\n    return \"\" + cssPrefix + courseName.substr(0, 3).toLowerCase();\n}\n","import * as tslib_1 from \"tslib\";\nimport { flatten, distinct, compareProp } from '../../utils/utils';\nexport function crunchCollidingEvents(events, isLastCall) {\n    var result = [];\n    events.forEach(function (event, eventIndex) {\n        var overlaps = result.filter(function (x) { return x.startMoment && x.endMoment &&\n            (x.startMoment <= event.startMoment) &&\n            (x.endMoment > event.startMoment); });\n        var allOverlaps = overlaps.concat(flatten(overlaps.map(function (o) { return o.prevOverlaps; })));\n        allOverlaps = distinct(allOverlaps, function (o) { return o.index; });\n        allOverlaps.sort(compareProp(\"startMoment\"));\n        var width; // = Math.round(100 / Math.max((allOverlaps.length + 1), 1));\n        var pos = 0;\n        allOverlaps.forEach(function (overlap, i) {\n            if (i % 4 === 0) {\n                width = Math.max(25, Math.round(100 / Math.max(allOverlaps.length - i + 1, 1)));\n                pos = 0;\n            }\n            overlap.width = width;\n            overlap.className = (overlap.className || \"\").split(' ')\n                .filter(function (cn) { return cn !== 'splitted'; })\n                .concat(\"splitted\")\n                .join(' '),\n                overlap.pos = pos;\n            pos += width;\n        });\n        result.push(tslib_1.__assign({}, event, { index: eventIndex, pos: pos, width: width, className: width < 100 ?\n                (event.className ? event.className + \" splitted\" : \"splitted\") :\n                event.className, prevOverlaps: allOverlaps }));\n        /*if (isLastCall && moment(event.start).day() === 1) {\n          if (/Sve2/.test(event.text)) {\n            debugger;\n          }\n          if (/Franska/.test(event.text)) {\n            debugger;\n          }\n          if (/Tyska/.test(event.text)) {\n            debugger;\n          }\n          if (/spansk/.test(event.text)) debugger;\n          if (/Eng6/.test(event.text)) debugger;\n        }*/\n    });\n    return result;\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport moment from 'moment';\nimport { MINUTE } from '../../utils/constants';\nimport { L } from '../../utils/utils';\nexport default function DayViewEvent(_a) {\n    var id = _a.id, dayStart = _a.dayStart, startMoment = _a.startMoment, endMoment = _a.endMoment, text = _a.text, location = _a.location, description = _a.description, width = _a.width, pos = _a.pos, locale = _a.locale, zoom = _a.zoom, htmlLink = _a.htmlLink, className = _a.className;\n    var top = (moment(startMoment).diff(dayStart) / MINUTE) * zoom;\n    var height = (moment(endMoment).diff(startMoment) / MINUTE) * zoom;\n    var localeTimeOptions = { hour: 'numeric', minute: '2-digit' };\n    var localeStartTime = startMoment.toDate().toLocaleTimeString(locale, localeTimeOptions);\n    var localeEndTime = endMoment.toDate().toLocaleTimeString(locale, localeTimeOptions);\n    return React.createElement(\"div\", { className: \"dayviewevent \" + className, style: {\n            position: 'absolute',\n            boxSizing: 'border-box',\n            top: top,\n            left: (pos || 0) + \"%\",\n            width: (width || 100) + '%',\n            height: height,\n            maxHeight: height,\n            overflow: 'hidden'\n        }, title: localeStartTime + \" - \" + localeEndTime + \" \" + text +\n            (location ?\n                \"\\n\" + L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Plats: \", \"\"], [\"Plats: \", \"\"])), location) :\n                \"\") +\n            (description ?\n                \"\\n\" + description :\n                \"\") },\n        React.createElement(\"a\", { className: \"event-title\", href: htmlLink, target: \"calendar-event\" }, text),\n        React.createElement(\"p\", { className: \"event-period\" },\n            localeStartTime,\n            \" - \",\n            localeEndTime),\n        location &&\n            React.createElement(\"p\", { className: \"event-location\" }, location),\n        description &&\n            React.createElement(\"p\", { className: \"event-description\" }, description));\n}\nvar templateObject_1;\n","import * as React from 'react';\nimport moment from 'moment';\nimport DayViewEvent from './day-view-event';\nimport TimeLines from './time-lines';\nimport { MINUTE } from '../../utils/constants';\nimport { crunchCollidingEvents } from './crunch-colliding-events';\nexport default function DayView(_a) {\n    var dayStart = _a.dayStart, // Milliseconds at start of the day (for example 08:00 the day)\n    dayEnd = _a.dayEnd, // Milliseconds at end of the day (for example 17:00 the day)\n    events = _a.events, // Events to show\n    locale = _a.locale, zoom = _a.zoom, isLastCall = _a.isLastCall;\n    var height = (moment(dayEnd).diff(dayStart) / MINUTE) * zoom;\n    var crunchedEvents = crunchCollidingEvents(events, isLastCall);\n    return (React.createElement(\"div\", { className: \"dayview\", style: {\n            top: 0,\n            height: height,\n            maxHeight: height,\n            position: 'relative',\n            overflow: 'hidden'\n        } },\n        React.createElement(TimeLines, { dayStart: dayStart, dayEnd: dayEnd, zoom: zoom }),\n        crunchedEvents.map(function (ev) { return React.createElement(DayViewEvent, { key: ev.id, id: ev.id, className: ev.className, dayStart: dayStart, startMoment: ev.startMoment, endMoment: ev.endMoment, text: ev.text, location: ev.location, description: ev.description, width: ev.width, pos: ev.pos, locale: locale, zoom: zoom, htmlLink: ev.htmlLink }); })));\n}\n","import * as React from 'react';\nimport moment from 'moment';\nexport default function HourMarker(_a) {\n    var startHour = _a.startHour, endHour = _a.endHour, locale = _a.locale, zoom = _a.zoom;\n    var hourPixels = 60 * zoom;\n    var hours = [];\n    for (var hour = startHour; hour <= endHour; ++hour) {\n        hours.push(hour);\n    }\n    return React.createElement(\"div\", { className: \"hourmarker\", style: {\n            position: 'relative',\n            left: 0,\n            top: 0,\n            overflow: 'visible',\n            height: (endHour - startHour) * hourPixels\n        } }, hours.map(function (hour, i) {\n        var ypos = i * hourPixels;\n        return React.createElement(\"span\", { key: hour },\n            React.createElement(\"div\", { style: {\n                    position: 'absolute',\n                    left: 0,\n                    top: ypos,\n                    marginTop: '-4px',\n                    padding: 0\n                } }, moment().hour(hour).minute(0).toDate().toLocaleString(locale, { hour: \"2-digit\", minute: \"2-digit\" })));\n    }));\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport WeekView from './week-view';\nimport { GoogleCalendar } from '../../apis/google-calendar';\nimport moment from 'moment';\nimport { flatten } from '../../utils/utils';\nimport { courseNameToCssClass } from './course-name-to-css-class';\nimport { shouldIncludeCalendar } from './should-include-calendar';\nimport env from '../../globals/KED.env';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nvar Calendar = /** @class */ (function (_super) {\n    tslib_1.__extends(Calendar, _super);\n    function Calendar(props) {\n        var _this = _super.call(this, props) || this;\n        // Props\n        var firstDay = props.firstDay;\n        if (typeof firstDay === 'string' || typeof firstDay === 'number') {\n            firstDay = moment().startOf('week').weekday(firstDay);\n        }\n        var _a = _this.props, initialStartHour = _a.initialStartHour, initialEndHour = _a.initialEndHour, initialZoom = _a.initialZoom;\n        // State\n        _this.state = {\n            firstDay: firstDay,\n            startHour: initialStartHour,\n            endHour: initialEndHour,\n            zoom: initialZoom,\n            calendars: {},\n            calendarsBeingLoaded: [],\n            status: 'Loading calendars... (authenticating...)',\n            error: null\n        };\n        var googleTokenProvider = (props.env || env).googleTokenProvider;\n        _this.gcal = new GoogleCalendar(googleTokenProvider);\n        // Start calling on Google API right away. Store promise in property.\n        _this.gcal.ensureInited().then(function () {\n            return _this.loadData(firstDay);\n        }).catch(function (error) {\n            _this.handleError(error);\n        });\n        return _this;\n    }\n    Calendar.prototype.handleError = function (error) {\n        if (!error)\n            error = \"Unknown error\";\n        this.setState({ error: error });\n        console.error(error.stack || error); // Keep!\n    };\n    Calendar.prototype.loadData = function (firstDay) {\n        var _this = this;\n        // Props\n        var numDays = this.props.numDays;\n        var intl = this.context.intl;\n        this.setState({\n            firstDay: firstDay,\n            calendars: {},\n            calendarsBeingLoaded: [],\n            error: null,\n            status: intl.formatMessage({ id: \"calendar.loadingCalendar\", defaultMessage: \"Loading calendars... (listing...)\" })\n        });\n        // Important to return the Promise so that caller will catch any error.\n        return this.gcal.listCalendars().then(function (calendars) {\n            // Ignore the \"week numbers\" calendar as we already include week numbers in our view\n            calendars = calendars.filter(function (cal) { return shouldIncludeCalendar(cal); });\n            //!/Week Numbers/ig.test(c.summary)\n            //console.log(calendars.map(c => ({bgColor: c.backgroundColor, primary: c.primary, summary: c.summary, x: c})));\n            // Calendars Successfully listed.\n            _this.setState({\n                status: intl.formatMessage({ id: \"calendar.loadCalendarEvents\", defaultMessage: \"Load calendar events...\" })\n            });\n            _this.gcal.batchEvents({\n                calendarList: calendars,\n                timeMin: moment(firstDay).startOf('day'),\n                timeMax: moment(firstDay).add(numDays, 'days').endOf('day')\n            }).then(function (result) {\n                _this.setState({ calendars: result, status: '' });\n            });\n        });\n    };\n    Calendar.prototype.navigateToPreviousWeek = function () {\n        var _this = this;\n        this.loadData(moment(this.state.firstDay).add(-1, \"week\")).catch(function (error) {\n            _this.handleError(error);\n        });\n    };\n    Calendar.prototype.navigateToNextWeek = function () {\n        var _this = this;\n        this.loadData(moment(this.state.firstDay).add(1, \"week\")).catch(function (error) {\n            _this.handleError(error);\n        });\n    };\n    Calendar.prototype.render = function () {\n        var _this = this;\n        // Props\n        var numDays = this.props.numDays;\n        var intl = this.context.intl;\n        // State\n        var _a = this.state, firstDay = _a.firstDay, startHour = _a.startHour, endHour = _a.endHour, zoom = _a.zoom, calendars = _a.calendars, status = _a.status, error = _a.error;\n        var eventSets = Object.keys(calendars)\n            .map(function (calendarId) { return calendars[calendarId]; })\n            .map(function (_a) {\n            var calendar = _a.calendar, events = _a.events;\n            var isSchedule = calendar.summary === 'Skolschema' && calendar.description === \"Synchronized\";\n            var isHoliday = /holiday/.test(calendar.id);\n            var isClassRoom = /classroom/.test(calendar.id);\n            var classNames = [];\n            if (calendar.colorId)\n                classNames.push(\"gcal-palette-\" + calendar.colorId);\n            if (isSchedule)\n                classNames.push(\"course-event\");\n            if (isHoliday)\n                classNames.push(\"holiday-event\");\n            // Map Google Calendar events to our own format:\n            return events.map(function (event) { return ({\n                id: event.id,\n                start: event.start,\n                end: event.end,\n                text: event.summary,\n                location: event.location,\n                description: event.description,\n                //bgColor: calendar.backgroundColor,\n                //fgColor: calendar.foregroundColor,\n                htmlLink: event.htmlLink,\n                className: (isSchedule && event.summary ?\n                    classNames.concat(courseNameToCssClass('course-event-', event.summary)) :\n                    classNames).join(\" \")\n            }); });\n        });\n        var events = flatten(eventSets);\n        // Else, render the WeekView now. Any error should be displayed as red status\n        return React.createElement(\"div\", { style: { position: 'relative', top: 0, left: 0 } },\n            React.createElement(\"div\", { className: \"btn-toolbar week-navigation\" },\n                React.createElement(\"div\", { className: \"btn-group\" },\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.navigateToPreviousWeek(); } },\n                        React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.navigateToNextWeek(); } },\n                        React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" }))),\n                React.createElement(\"div\", { className: \"btn-group\" }, intl.formatMessage({ id: \"calendar.currentDate\", defaultMessage: \"Vecka {week}, {year}\" }, { week: moment(firstDay).week(), year: moment(firstDay).year() }))),\n            React.createElement(WeekView, { locale: intl.locale, firstDay: firstDay, startHour: startHour, endHour: endHour, numDays: numDays, zoom: zoom, events: events, status: status, error: error }));\n    };\n    Calendar.contextType = LanguageContext;\n    return Calendar;\n}(React.Component));\nexport { Calendar };\n","/* Calendars to show:\n\n    summary: \"Matsedel\",\n    summary: \"Skolschema\",\n    primary: true\n    id.includes('classroom')\n    id.includes('holiday')\n*/\nexport function shouldIncludeCalendar(cal) {\n    var summary = cal.summary || \"\";\n    var isOwner = /owner/ig.test(cal.accessRole);\n    var isPrimary = !!cal.primary;\n    var isClassroomCalendar = /classroom/ig.test(cal.id);\n    var isHolidayCalendar = /holiday/ig.test(cal.id);\n    return (isPrimary ||\n        isClassroomCalendar ||\n        isHolidayCalendar ||\n        ///matsedel/ig.test(summary) ||\n        (/schema/ig.test(summary) && isOwner));\n}\n","import * as React from 'react';\nexport default function StatusBar(_a) {\n    var status = _a.status, error = _a.error;\n    if (!status && !error)\n        return null;\n    return React.createElement(\"div\", { className: \"statusbar\" }, error ?\n        React.createElement(\"p\", { className: \"error\" }, '' + error) :\n        React.createElement(\"p\", { className: \"status\" }, status));\n}\n","import * as React from 'react';\nimport moment from 'moment';\nexport default function TimeLines(_a) {\n    var dayStart = _a.dayStart, dayEnd = _a.dayEnd, zoom = _a.zoom;\n    var hourPixels = 60 * zoom;\n    var startHour = moment(dayStart).hour();\n    var endHour = moment(dayEnd).hour();\n    var hours = [];\n    for (var hour = startHour; hour <= endHour; ++hour) {\n        hours.push(hour);\n    }\n    return React.createElement(\"div\", null, hours.map(function (hour) {\n        return React.createElement(\"div\", { key: hour, className: \"timeline\", style: {\n                width: '100%',\n                boxSizing: 'border-box',\n                margin: hourPixels / 2 + \"px 0 0 0\",\n                height: hourPixels / 2\n            } });\n    }));\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport moment from 'moment';\nimport DayView from './day-view';\nimport HourMarker from './hour-marker';\nimport { capitalizeFirst, clone } from '../../utils/utils';\nimport StatusBar from './status-bar';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nvar WeekView = /** @class */ (function (_super) {\n    tslib_1.__extends(WeekView, _super);\n    function WeekView() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    WeekView.prototype.render = function () {\n        // Props:\n        var _a = this.props, firstDay = _a.firstDay, // {moment} The day to start with (normally a monday)\n        startHour = _a.startHour, // {number} The hour to start on\n        endHour = _a.endHour, // {number} The hour to end rendering per day\n        numDays = _a.numDays, // {number} Number of days, normally 5.\n        events = _a.events, // Array of events to display in the week.\n        locale = _a.locale, // Locale to use for showing week days and hour marks.\n        zoom = _a.zoom, // {number} Zoom where 1 means that 1 minute = 1 pixel.  \n        status = _a.status, error = _a.error;\n        var intl = this.context.intl;\n        // Prepare DayView datas \n        var dayDatas = [];\n        var day = moment(firstDay);\n        var _loop_1 = function (i) {\n            var dayStart = moment(day).hour(startHour);\n            var dayEnd = moment(day).hour(endHour);\n            var dayDate = moment(day).format('yyyy-MM-DD');\n            var isToday = moment(dayStart).startOf(\"day\").valueOf() === moment().startOf(\"day\").valueOf();\n            dayDatas.push({\n                name: capitalizeFirst(dayStart.toDate().toLocaleString(locale, {\n                    weekday: 'long',\n                    day: 'numeric',\n                    month: 'short'\n                })),\n                dayStart: dayStart,\n                dayEnd: dayEnd,\n                isToday: isToday,\n                events: events.filter(function (event) {\n                    return event.start && event.end && event.start.dateTime && event.end.dateTime &&\n                        (moment(event.start.dateTime).isBetween(dayStart, dayEnd) ||\n                            moment(event.end.dateTime).isBetween(dayStart, dayEnd));\n                })\n                    // Change start / end to directly point to the dateTime\n                    .map(function (event) { return clone(event, { startMoment: moment(event.start.dateTime), endMoment: moment(event.end.dateTime) }); })\n                    .sort(function (a, b) { return a.startMoment.valueOf > b.startMoment.valueOf ? 1 : a.startMoment < b.startMoment ? -1 : 0; }),\n                fullDayEvents: events.filter(function (event) {\n                    // Verify that it is a full-day-event\n                    return event.start && event.end && event.start.date && event.end.date &&\n                        // Verify it applies to current day\n                        (event.start.date <= dayDate && event.end.date > dayDate);\n                })\n                    // Change start / end to directly point to the date object\n                    .map(function (event) { return clone(event, {\n                    startDate: event.start.date,\n                    endDate: event.end.date\n                }); })\n            });\n            day = moment(day) // clone it\n                .add(1, 'days'); // Add another day\n        };\n        for (var i = 0; i < numDays; ++i) {\n            _loop_1(i);\n        }\n        // Render\n        return React.createElement(\"div\", { className: \"vemendo-weekview\" },\n            React.createElement(\"table\", null,\n                React.createElement(\"tbody\", null,\n                    React.createElement(\"tr\", null,\n                        React.createElement(\"td\", { style: { border: 0 } }),\n                        dayDatas.map(function (d) { return React.createElement(\"td\", { key: d.dayStart.toISOString(), className: d.isToday ? \"today\" : null },\n                            React.createElement(\"p\", { className: \"dayname\" }, d.name)); })),\n                    React.createElement(\"tr\", null,\n                        React.createElement(\"td\", { style: { border: 0 } },\n                            React.createElement(\"p\", { className: \"week-number\" }, intl.formatMessage({ id: \"calendar.weekNumber\", defaultMessage: \"V{weekNumber}\" }, { weekNumber: moment(firstDay).week() }))),\n                        dayDatas.map(function (day) {\n                            return React.createElement(\"td\", { key: day.dayStart.toISOString(), className: day.isToday ? \"today\" : null }, day.fullDayEvents.map(function (_a) {\n                                var id = _a.id, text = _a.text, location = _a.location, description = _a.description, htmlLink = _a.htmlLink, className = _a.className;\n                                return React.createElement(\"div\", { key: id, className: \"dayviewevent full-day \" + className, title: \"\" + text + (location ?\n                                        \"\\n\" + intl.formatMessage({ id: \"calendar.fullDayEventLocation\", defaultMessage: \"Plats: {location}\" }, { location: location }) :\n                                        \"\") +\n                                        (description ?\n                                            \"\\n\" + description :\n                                            \"\") },\n                                    React.createElement(\"a\", { className: \"event-title\", href: htmlLink, target: \"calendar-event\" }, text),\n                                    location &&\n                                        React.createElement(\"p\", { className: \"event-location\" }, location),\n                                    description &&\n                                        React.createElement(\"p\", { className: \"event-description\" }, description));\n                            }));\n                        })),\n                    React.createElement(\"tr\", null,\n                        React.createElement(\"td\", { style: { border: 0 } },\n                            React.createElement(HourMarker, { startHour: startHour, endHour: endHour, locale: locale, zoom: zoom })),\n                        dayDatas.map(function (day) { return React.createElement(\"td\", { key: day.dayStart.toISOString(), className: day.isToday ? \"today\" : null },\n                            React.createElement(DayView, { key: day.dayStart.toISOString(), dayStart: day.dayStart, dayEnd: day.dayEnd, events: day.events, locale: locale, zoom: zoom, isLastCall: status == '' }),\n                            \" \"); })),\n                    (status || error) && (!error || error.name !== \"UnauthorizedError\") &&\n                        //\n                        // Show status / error\n                        //\n                        React.createElement(\"tr\", null,\n                            React.createElement(\"td\", { style: { border: 0 } }),\n                            React.createElement(\"td\", { style: { border: 0 }, colSpan: numDays },\n                                React.createElement(StatusBar, { status: status, error: error }))))));\n    };\n    WeekView.contextType = LanguageContext;\n    return WeekView;\n}(React.Component));\nexport default WeekView;\n","export function getWeekplannerProgressData(taskSets) {\n    var chartTasks = { completedTasks: 0, totalNumberOfTasks: 0, subjectData: {} };\n    taskSets.forEach(function (elem) { return elem.learningGoals.forEach(function (x) {\n        var subjectCompletedTasks = x.tasks.filter(function (t) { return t.done; }).length;\n        var courseSubjectData = chartTasks.subjectData[elem.courseName];\n        if (!courseSubjectData) {\n            courseSubjectData = chartTasks.subjectData[elem.courseName] = {\n                completedNumberOfTasks: 0,\n                numberOfTasks: 0\n            };\n        }\n        courseSubjectData.completedNumberOfTasks += subjectCompletedTasks;\n        courseSubjectData.numberOfTasks += x.tasks.length;\n        chartTasks.completedTasks += subjectCompletedTasks;\n        chartTasks.totalNumberOfTasks += x.tasks.length;\n    }); });\n    return chartTasks;\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nvar Doughnut = /** @class */ (function (_super) {\n    tslib_1.__extends(Doughnut, _super);\n    function Doughnut() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    Doughnut.prototype.render = function () {\n        var _a = this.props, percentage = _a.percentage, errorMessage = _a.errorMessage, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\n        //default values\n        var stroke = 2;\n        //equals with he circumference/2II\n        var radius = 100 / (2 * 3.14);\n        //take into account the stroke\n        var center = radius + stroke;\n        var viewboxW = center * 2;\n        var viewvboxH = center * 2;\n        var roundedPercentage = Math.round(percentage);\n        var startErrorText = 10;\n        return (React.createElement(\"svg\", { className: \"doughnut-chart\", viewBox: \"0 0 \" + viewboxW + \" \" + viewvboxH, width: \"100%\", height: \"100%\" },\n            React.createElement(\"circle\", { className: \"circle-chart-background\", stroke: backgroundColor, strokeWidth: stroke + 1, fill: \"none\", cx: center, cy: center, r: radius }),\n            React.createElement(\"circle\", { className: \"circle-chart-circle\", stroke: progressColor, ref: \"progressCircle\", strokeWidth: stroke, style: { strokeDasharray: roundedPercentage + \", 100\" }, strokeLinecap: \"round\", fill: \"none\", cx: center, cy: center, r: radius }),\n            React.createElement(\"g\", { className: \"circle-chart-info\" }, !errorMessage ? React.createElement(\"text\", { className: \"circle-chart-percent\", x: center, y: center, alignmentBaseline: \"central\", textAnchor: \"middle\" }, roundedPercentage + \"%\") :\n                React.createElement(\"text\", { className: \"circle-chart-percent-error\", x: center, y: center, alignmentBaseline: \"central\", fontSize: \"5\", textAnchor: \"middle\" }, errorMessage.split(' ').map(function (element) {\n                    var tspan = React.createElement(\"tspan\", { key: element, x: center, y: startErrorText }, element);\n                    startErrorText += 5;\n                    return tspan;\n                })))));\n    };\n    Doughnut.defaultProps = {\n        backgroundColor: \"#efefef\",\n        progressColor: \"#3dbca2\",\n        errorMessage: null\n    };\n    return Doughnut;\n}(React.Component));\nexport { Doughnut };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nvar GoalProgress = /** @class */ (function (_super) {\n    tslib_1.__extends(GoalProgress, _super);\n    function GoalProgress() {\n        var _this = _super !== null && _super.apply(this, arguments) || this;\n        _this.createProgress = function () {\n            var _a = _this.props, numberOfTasks = _a.numberOfTasks, completedNumberOfTasks = _a.completedNumberOfTasks, maximumTasksDisplayed = _a.maximumTasksDisplayed, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\n            var progress = [];\n            if (numberOfTasks > maximumTasksDisplayed) {\n                return React.createElement(\"div\", { className: \"progress-overview\" },\n                    \" \",\n                    completedNumberOfTasks,\n                    \" / \",\n                    numberOfTasks,\n                    \" \");\n            }\n            for (var taskNo = 1; taskNo <= numberOfTasks; taskNo++) {\n                progress.push(React.createElement(\"svg\", { key: taskNo },\n                    React.createElement(\"circle\", { className: \"circle-chart-background\", fill: taskNo > completedNumberOfTasks ? backgroundColor : progressColor, cx: \"8\", cy: \"8\", r: \"8\" })));\n            }\n            return progress;\n        };\n        return _this;\n    }\n    GoalProgress.prototype.render = function () {\n        return React.createElement(\"div\", { className: \"goals-progress\" }, this.createProgress());\n    };\n    GoalProgress.defaultProps = {\n        numberofTasks: 0,\n        completedNumberOfTasks: 0,\n        maximumTasksDisplayed: 10,\n        backgroundColor: \"lightgrey\",\n        progressColor: \"#3dbca2\",\n    };\n    return GoalProgress;\n}(React.Component));\nexport { GoalProgress };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nvar Progress = /** @class */ (function (_super) {\n    tslib_1.__extends(Progress, _super);\n    function Progress() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    Progress.prototype.render = function () {\n        var _a = this.props, percentage = _a.percentage, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\n        var roundedPercentage = Math.round(percentage);\n        return (React.createElement(\"svg\", { className: \"progress-chart\", width: \"100%\", height: \"25\" },\n            React.createElement(\"rect\", { fill: backgroundColor, width: \"100%\", height: \"100%\", rx: \"4\" }),\n            React.createElement(\"rect\", { className: \"fill\", fill: progressColor, width: roundedPercentage + \"%\", height: \"100%\", rx: \"4\" }),\n            React.createElement(\"text\", { className: \"filled-text\", textAnchor: \"middle\", x: \"50%\", y: \"50%\", dy: \".3em\" }, roundedPercentage + \"%\")));\n    };\n    Progress.defaultProps = {\n        percentage: 0,\n        backgroundColor: \"#F1F5F4\",\n        progressColor: \"#3dbca2\",\n    };\n    return Progress;\n}(React.Component));\nexport { Progress };\n","import React from 'react';\nexport var DialogsContext = React.createContext({ openDialog: null, closeDialog: null });\n","import * as React from 'react';\nexport var EllipsisLoader = function () {\n    return React.createElement(\"img\", { style: { border: 0, margin: 0, padding: 0 }, className: \"ellipsis-loader\" });\n};\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { L } from \"../../../utils/utils\";\n;\nexport var RemoveItem = function (_a) {\n    var onClick = _a.onClick, className = _a.className, style = _a.style, title = _a.title;\n    return React.createElement(\"div\", { title: title || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Radera\"], [\"Radera\"]))), className: \"removeItem \" + (className || \"\"), onClick: onClick, style: style });\n};\nvar templateObject_1;\n","import * as React from 'react';\nexport var Spinner = function (_a) {\n    var _b = _a.label, label = _b === void 0 ? \"\" : _b;\n    return React.createElement(\"span\", null,\n        React.createElement(\"i\", { className: \"fa fa-spinner fa-spin\", \"aria-hidden\": \"true\" }),\n        \"\\u00A0\",\n        label);\n};\n","import * as React from 'react';\nexport function Confirmation(props) {\n    return React.createElement(\"div\", { className: \"confirmation-box \" + props.className + (props.visible ? \" visible\" : \"\") },\n        React.createElement(\"p\", null, props.text),\n        React.createElement(\"button\", { onClick: function () { return props.onConfirm(); } }, \"OK\"),\n        React.createElement(\"button\", { onClick: function () { return props.onCancel(); } }, \"Avbryt\"));\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { TaskList } from './task-list';\nimport { LanguageContext } from '../../utility-components/LanguageContext';\nvar LearningGoalsList = /** @class */ (function (_super) {\n    tslib_1.__extends(LearningGoalsList, _super);\n    function LearningGoalsList() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    LearningGoalsList.prototype.render = function () {\n        var _a = this.props, commonTasks = _a.commonTasks, learningGoals = _a.learningGoals;\n        var intl = this.context.intl;\n        return React.createElement(\"div\", null,\n            learningGoals.map(function (lg) { return React.createElement(\"div\", { key: lg.name },\n                React.createElement(\"h5\", null, lg.name),\n                React.createElement(TaskList, { learningTasks: lg.learningTasks })); }),\n            commonTasks.length > 0 && React.createElement(\"div\", null,\n                learningGoals.length > 0 && React.createElement(\"h5\", null, intl.formatMessage({ id: \"learningGoalsLost.overall\", defaultMessage: \"Övergripande\" })),\n                React.createElement(TaskList, { learningTasks: commonTasks })));\n    };\n    LearningGoalsList.contextType = LanguageContext;\n    return LearningGoalsList;\n}(React.Component));\nexport { LearningGoalsList };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport env from '../../../globals/KED.env';\nimport moment from 'moment';\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\nimport { userTasksRepo } from '../../../repos/user-tasks-repo';\nimport { arrayToMap } from '../../../utils/utils';\nimport { Confirmation } from './confirmation';\nimport { LanguageContext } from '../../utility-components/LanguageContext';\nimport { UIAddbox } from '../../utility-components/checkbox';\nvar TaskList = /** @class */ (function (_super) {\n    tslib_1.__extends(TaskList, _super);\n    function TaskList(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            userTasks: [],\n            weekDate: Date.now(),\n            confirmations: []\n        };\n        _this.onChange = _this.onChange.bind(_this);\n        return _this;\n    }\n    TaskList.prototype.onChange = function (userTasks, persisted) {\n        if (persisted.weekDate !== this.state.weekDate) {\n            this.setState({\n                confirmations: []\n            });\n        }\n        this.setState({\n            userTasks: userTasks,\n            weekDate: persisted.weekDate\n        });\n    };\n    TaskList.prototype.componentDidMount = function () {\n        userTasksRepo.subscribe(this.onChange);\n    };\n    TaskList.prototype.componentWillUnmount = function () {\n        userTasksRepo.unsubscribe(this.onChange);\n    };\n    TaskList.prototype.toggleTask = function (learningTask) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var userTasks, weekDate, latestTimeStamp, userTask;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        userTasks = this.state.userTasks.filter(function (ut) {\n                            return learningTask.task ?\n                                ut.task && ut.task.some(function (t) { return t.id === learningTask.id; }) :\n                                ut.siteVisionPageId === learningTask.id;\n                        });\n                        weekDate = this.state.weekDate;\n                        if (!(userTasks.length === 0)) return [3 /*break*/, 2];\n                        latestTimeStamp = Math.max.apply(Math.max, [weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\n                        userTask = {\n                            id: createUUID(),\n                            courseName: learningTask.courseName,\n                            dateTime: latestTimeStamp + 2000,\n                            learningGoal: learningTask.learningGoal,\n                            name: learningTask.name,\n                            url: learningTask.url,\n                            acl: [\n                                // Default ACL: Let user self have full control over this item:\n                                new DocumentAccess(\"email\", env.currentUser.mail, \"S\"),\n                                // Additional ACL: Let employees on same school have read access to it.\n                                // This currently only applies to tasks that refer to course tasks (not custom tasks!)\n                                new DocumentAccess(\"schoolRole\", env.currentUser.school + \"/EMPLOYEE\", \"R\")\n                            ].map(function (ac) { return ac.toString(); })\n                        };\n                        if (learningTask.task && learningTask.task.deadline) {\n                            userTask.deadline = learningTask.task.deadline;\n                        }\n                        if (learningTask.task) {\n                            userTask.task = [learningTask.task];\n                            if (learningTask.course) {\n                                userTask.course = [learningTask.course];\n                            }\n                            else if (learningTask.courseInfo) {\n                                userTask.courseInfo = learningTask.courseInfo;\n                            }\n                        }\n                        else {\n                            userTask.siteVisionPageId = learningTask.id;\n                        }\n                        if (learningTask.step) {\n                            userTask.step = learningTask.step;\n                        }\n                        return [4 /*yield*/, Promise.all([\n                                userTasksRepo.setWeekPlannerBoxOpen(learningTask.courseName, true),\n                                userTasksRepo.insert([userTask])\n                            ])];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 2: \n                    // Already present in weekplanner. It's time to delete those that matched us.\n                    return [4 /*yield*/, userTasksRepo.delete(userTasks.map(function (t) { return t.id; }))];\n                    case 3:\n                        // Already present in weekplanner. It's time to delete those that matched us.\n                        _a.sent();\n                        _a.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    TaskList.prototype.render = function () {\n        var _this = this;\n        var intl = this.context.intl;\n        var learningTasks = this.props.learningTasks;\n        var userTasks = arrayToMap(this.state.userTasks, function (ut) { return ut.task && ut.task.length > 0 ?\n            ut.task.map(function (t) { return t.id; })[0] : // course-builder tasks looked up by id\n            ut.siteVisionPageId ? ut.siteVisionPageId : // non-course-builder tasks\n                ut.url; });\n        var confirmations = this.state.confirmations;\n        var weekPlannerWeek = moment(this.state.weekDate).week();\n        var currentWeek = moment().week();\n        var forWeekString = weekPlannerWeek === currentWeek ? \"\" :\n            weekPlannerWeek === currentWeek + 1 ? intl.formatMessage({ id: \"taskList.nextWeekTask\", defaultMessage: \"för nästa vecka (v{week})\" }, { week: weekPlannerWeek }) :\n                weekPlannerWeek === currentWeek - 1 ? intl.formatMessage({ id: \"taskList.lastWeekTask\", defaultMessage: \"för förra veckan (v{week})\" }, { week: weekPlannerWeek }) :\n                    intl.formatMessage({ id: \"taskList.currentWeekTask\", defaultMessage: \"för vecka {week}\" }, { week: weekPlannerWeek });\n        return React.createElement(\"div\", { className: \"taskContainer\" }, learningTasks.map(function (learningTask, idx) {\n            var taskLookupId = learningTask.id;\n            var userTask = userTasks[taskLookupId] || { $meta: 'deleted' }; // No exist = $meta: 'deleted'\n            var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting';\n            var selected = userTask.$meta !== 'deleted' && userTask.$meta !== 'deleting';\n            var describedAction = selected ?\n                intl.formatMessage({ id: \"taskList.removeTaskFromWeeklyPlanning\", defaultMessage: \"Ta bort uppgiften från egen veckoplanering {week}\" }, { week: forWeekString }) :\n                intl.formatMessage({ id: \"taskList.addTaskToWeeklyPlanning\", defaultMessage: \"Lägg till uppgiften i egen veckoplanering {week}\" }, { week: forWeekString });\n            var confirmationVisible = confirmations.some(function (tid) { return taskLookupId === tid; });\n            return React.createElement(\"div\", { key: idx },\n                React.createElement(UIAddbox, { state: selected ? 'checked' : '', onChange: function () { return !isWorking && weekPlannerWeek === currentWeek ?\n                        _this.toggleTask(learningTask) :\n                        confirmationVisible ?\n                            _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) }) :\n                            _this.setState({ confirmations: tslib_1.__spread(confirmations).concat(taskLookupId) }); }, label: React.createElement(\"a\", { title: describedAction, href: learningTask.url }, learningTask.name) }),\n                React.createElement(Confirmation, { visible: confirmationVisible, text: describedAction, onConfirm: function () {\n                        _this.toggleTask(learningTask);\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\n                    }, onCancel: function () {\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\n                    } }));\n        }));\n    };\n    TaskList.contextType = LanguageContext;\n    return TaskList;\n}(React.Component));\nexport { TaskList };\n","import * as React from 'react';\nimport { KGTermPlanner } from './kg-termplanner';\nimport env from '../../globals/KED.env';\nexport function KGTermPlannerSelf() {\n    return React.createElement(KGTermPlanner, { env: env, tutored: false });\n}\n","import * as React from 'react';\nimport { KGTermPlanner } from './kg-termplanner';\nimport { TutorableComponent } from '../utility-components/tutorable-component';\nexport function KGTermPlannerTutored() {\n    return React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\n            return React.createElement(KGTermPlanner, { key: env.currentUser.mail, env: env, tutored: true });\n        } });\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { EDSPeriod } from '../../apis/edsclient';\nimport { getSchoolMoment, getFirstAndLastWeekOfTerm, getTermStarEndDate } from '../../utils/school-moment';\nimport moment from 'moment';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport { Dialogs } from '../utility-components/dialogs';\nimport { WeekNoteDialog } from './week-note-dialog';\nimport { distinct } from '../../utils/utils';\nimport { KEDWeek } from '../../utils/weekutil';\nimport { DocumentAccess, createUUID } from 'kedbackend/client';\nimport { TutorDialog } from '../ks-termplanner/tutor-dialog';\nimport { features } from '../../features';\nvar KGTermPlanner = /** @class */ (function (_super) {\n    tslib_1.__extends(KGTermPlanner, _super);\n    function KGTermPlanner(props) {\n        var _this = _super.call(this, props) || this;\n        var now = new Date();\n        _this.state = {\n            now: now,\n            courses: [],\n            weekPlans: [],\n            isLoadingCourses: true,\n            isLoadingWeekPlans: true,\n            dialogs: []\n            //goals: []\n        };\n        _this.updateWeekPlans = _this.updateWeekPlans.bind(_this);\n        return _this;\n    }\n    KGTermPlanner.prototype.componentDidMount = function () {\n        this.loadEDSCourses();\n        this.props.env.kgTermPlannerRepo.mem.subscribe(this.updateWeekPlans);\n    };\n    KGTermPlanner.prototype.componentWillUnmount = function () {\n        this.props.env.kgTermPlannerRepo.mem.unsubscribe(this.updateWeekPlans);\n    };\n    KGTermPlanner.prototype.updateWeekPlans = function (weekPlans) {\n        this.setState({ weekPlans: weekPlans, isLoadingWeekPlans: false });\n    };\n    KGTermPlanner.prototype.loadEDSCourses = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var schoolMoment, periodName, courses, _a;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _b.trys.push([0, , 2, 3]);\n                        schoolMoment = getSchoolMoment(moment(this.state.now));\n                        periodName = new EDSPeriod(schoolMoment).period;\n                        _a = distinct;\n                        return [4 /*yield*/, this.props.env.edsClient.getActiveCourses({ periodName: periodName })];\n                    case 1:\n                        courses = _a.apply(void 0, [_b.sent(), function (course) { return course.name; }]);\n                        //console.log(\"courses:\" + JSON.stringify(courses, null, 2));\n                        this.setState({ courses: courses });\n                        return [3 /*break*/, 3];\n                    case 2:\n                        this.setState({ isLoadingCourses: false });\n                        return [7 /*endfinally*/];\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KGTermPlanner.prototype.onNoteClick = function (weekNumber, weekDate, courseName, weekPlan, note) {\n        var _this = this;\n        this.openDialog(React.createElement(WeekNoteDialog, { weekNumber: weekNumber, weekDate: weekDate, courseName: courseName, weekPlan: weekPlan, note: note, env: this.props.env, closeDialog: function () { return _this.closeDialog(); } }));\n    };\n    /**\n   *\n   * @param weekNumber\n   * @param comment\n   *\n   * Add a comment from tutor\n   */\n    KGTermPlanner.prototype.onTutorClick = function (tutorNote, weekNumber) {\n        var _this = this;\n        this.openDialog(React.createElement(TutorDialog, { weekNumber: weekNumber, comment: tutorNote.value, updateData: function (newValue) { return _this.updateTutorNoteField(tutorNote, newValue); }, deleteNoteData: function () { return _this.deleteTutorNoteField(tutorNote.id); }, closeDialog: function () { return _this.closeDialog(); } }));\n    };\n    KGTermPlanner.prototype.deleteTutorNoteField = function (noteId) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var showError_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this.props.env.kgTermPlannerRepo.delete([noteId])];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        showError_1 = _a.sent();\n                        return [3 /*break*/, 3];\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KGTermPlanner.prototype.updateTutorNoteField = function (tutorNote, newValue) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var oldValue, showError_2;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        oldValue = (tutorNote && tutorNote.value) || \"\";\n                        if (oldValue === newValue)\n                            return [2 /*return*/];\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        tutorNote.value = newValue;\n                        //set document ACL\n                        tutorNote.acl = [\n                            new DocumentAccess(\"tutorFor\", this.props.env.currentUser.mail, \"S\").toString(),\n                            new DocumentAccess(\"email\", this.props.env.currentUser.mail, \"R\").toString(),\n                        ];\n                        return [4 /*yield*/, this.props.env.kgTermPlannerRepo.upsert(tutorNote, function (note) { return note.value = newValue; })];\n                    case 2: return [2 /*return*/, _a.sent()];\n                    case 3:\n                        showError_2 = _a.sent();\n                        return [3 /*break*/, 4];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KGTermPlanner.prototype.openDialog = function (dialog) {\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\n    };\n    KGTermPlanner.prototype.closeDialog = function () {\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\n    };\n    KGTermPlanner.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, courses = _a.courses, now = _a.now, isLoadingCourses = _a.isLoadingCourses, isLoadingWeekPlans = _a.isLoadingWeekPlans, weekPlans = _a.weekPlans, dialogs = _a.dialogs;\n        var isLoading = isLoadingCourses || isLoadingWeekPlans;\n        var weeks = [];\n        var tutorNotes = [];\n        var schoolMoment = getSchoolMoment(moment(now));\n        var _b = tslib_1.__read(getTermStarEndDate(now, schoolMoment.term === 'AT'), 2), termStart = _b[0], termEnd = _b[1];\n        var _c = tslib_1.__read(getFirstAndLastWeekOfTerm(schoolMoment.term), 2), firstWeek = _c[0], lastWeek = _c[1];\n        var showKgTutorCommentField = features.kgTutorComment;\n        var currentWeekPlans = weekPlans.filter(function (x) { return !x.type; });\n        var currentTutorNotes = weekPlans.filter(function (x) { return x.type === 'tutor-note'; });\n        var _loop_1 = function (weekMoment) {\n            var weekNumber = weekMoment.week();\n            var weekYear = weekMoment.year();\n            var kedWeek = KEDWeek(weekYear, weekNumber);\n            if (weekNumber >= firstWeek && weekNumber <= lastWeek) {\n                var weekPlan = currentWeekPlans.filter(function (wp) {\n                    return wp.dateTime >= kedWeek.notBefore &&\n                        wp.dateTime <= kedWeek.notAfter;\n                })[0];\n                var tutorNote = currentTutorNotes.filter(function (wp) {\n                    return wp.dateTime >= kedWeek.notBefore &&\n                        wp.dateTime <= kedWeek.notAfter;\n                })[0];\n                var startOfWeek = weekMoment.clone().startOf('week').valueOf();\n                weeks.push({\n                    weekNumber: weekNumber,\n                    weekDate: startOfWeek,\n                    weekPlan: weekPlan\n                });\n                tutorNotes.push({\n                    weekNumber: weekNumber,\n                    tutorValue: tutorNote || { value: '', dateTime: startOfWeek, id: createUUID(), type: 'tutor-note' }\n                });\n            }\n        };\n        for (var weekMoment = termStart.clone(); weekMoment.valueOf() < termEnd.valueOf(); weekMoment = weekMoment.clone().add(1, 'week').startOf('week')) {\n            _loop_1(weekMoment);\n        }\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\n            React.createElement(\"h4\", null, \"Terminsplanering\"),\n            React.createElement(\"hr\", null),\n            isLoading ?\n                React.createElement(Spinner, null) : courses.length === 0 ? React.createElement(\"div\", null, \"Terminsplaneraren aktiveras n\\u00E4r du skrivits in p\\u00E5 dina kurser\") :\n                React.createElement(\"table\", { className: \"termplanner-table zebra\" },\n                    React.createElement(\"thead\", null,\n                        React.createElement(\"tr\", null,\n                            React.createElement(\"th\", null, \"Vecka\"),\n                            courses.map(function (c, idx) { return React.createElement(\"th\", { key: idx, className: \"kgCourseHeader\" }, c.name); }),\n                            showKgTutorCommentField && React.createElement(\"th\", { className: \"tutorHeader\" }))),\n                    React.createElement(\"tbody\", null, weeks.map(function (w, idx) {\n                        var isCurrentWeek = w.weekNumber === moment().week();\n                        var noteValue = tutorNotes && tutorNotes.find(function (tn) { return tn.weekNumber === w.weekNumber; });\n                        return React.createElement(\"tr\", { key: idx, className: isCurrentWeek ? \"currentWeek\" : \"\" },\n                            React.createElement(\"td\", null, w.weekNumber),\n                            courses.map(function (c, idx) {\n                                var note = w.weekPlan && w.weekPlan.plans[c.name];\n                                return React.createElement(\"td\", { key: idx, className: note ? \"courseNote note-color-\" + note.color : \"courseNote\", \"data-tooltip\": note && note.description, title: note && note.description, onClick: function () { return _this.onNoteClick(w.weekNumber, w.weekDate, c.name, w.weekPlan, note); } }, note ? React.createElement(\"i\", { className: \"fas fa-align-center\" }) : '');\n                            }),\n                            showKgTutorCommentField && (_this.props.tutored ?\n                                React.createElement(\"td\", { key: idx, onClick: function () { return _this.onTutorClick(noteValue.tutorValue, w.weekNumber); }, className: \"tutorCell\" }, noteValue.tutorValue.value ? React.createElement(\"div\", { key: idx, \"data-tooltip\": noteValue.tutorValue.value },\n                                    React.createElement(\"i\", { className: \"fas fa-comment-dots\" })) : React.createElement(\"div\", { key: idx },\n                                    React.createElement(\"i\", { className: \"fas fa-comment-medical\" })))\n                                :\n                                    noteValue.tutorValue.value ? React.createElement(\"td\", { className: \"tutorCell\" },\n                                        React.createElement(\"div\", { \"data-tooltip\": noteValue.tutorValue.value },\n                                            React.createElement(\"i\", { className: \"far fa-comment-dots\" }))) : React.createElement(\"td\", null)));\n                    })),\n                    React.createElement(\"tfoot\", null,\n                        React.createElement(\"tr\", null,\n                            React.createElement(\"th\", { key: \"points\" }, \"Po\\u00E4ng\"),\n                            courses.map(function (c, idx) { return React.createElement(\"th\", { key: idx, className: \"stepCell\" }, c.credits); })),\n                        React.createElement(\"tr\", null,\n                            React.createElement(\"th\", null, \"Betygsm\\u00E5l\"),\n                            courses.map(function (c, idx) {\n                                return React.createElement(\"th\", { key: idx, className: \"stepCell\" }, c.periodGoalGrade);\n                            })))),\n            React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () { return _this.setState({ dialogs: dialogs.slice(0, dialogs.length - 1) }); } }));\n    };\n    return KGTermPlanner;\n}(React.Component));\nexport { KGTermPlanner };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { createUUID } from 'kedbackend/client';\nvar WeekNoteDialog = /** @class */ (function (_super) {\n    tslib_1.__extends(WeekNoteDialog, _super);\n    function WeekNoteDialog(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            description: props.note ? props.note.description : '',\n            color: props.note ? props.note.color : 'yellow'\n        };\n        return _this;\n    }\n    WeekNoteDialog.prototype.delete = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, weekNumber, weekDate, courseName, weekPlan, note, closeDialog, env, _b, description, color;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = this.props, weekNumber = _a.weekNumber, weekDate = _a.weekDate, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, closeDialog = _a.closeDialog, env = _a.env;\n                        _b = this.state, description = _b.description, color = _b.color;\n                        closeDialog();\n                        if (!(Object.keys(weekPlan.plans).length === 1)) return [3 /*break*/, 2];\n                        return [4 /*yield*/, env.kgTermPlannerRepo.delete([weekPlan.id])];\n                    case 1:\n                        _c.sent();\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, env.kgTermPlannerRepo.update([weekPlan], function (wp) {\n                            delete wp.plans[courseName];\n                        })];\n                    case 3:\n                        _c.sent();\n                        _c.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekNoteDialog.prototype.save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, weekNumber, weekDate, courseName, weekPlan, note, closeDialog, env, _b, description, color, plans;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = this.props, weekNumber = _a.weekNumber, weekDate = _a.weekDate, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, closeDialog = _a.closeDialog, env = _a.env;\n                        _b = this.state, description = _b.description, color = _b.color;\n                        closeDialog();\n                        if (description.length == 0) {\n                            return [2 /*return*/];\n                        }\n                        if (!weekPlan) return [3 /*break*/, 2];\n                        return [4 /*yield*/, env.kgTermPlannerRepo.update([weekPlan], function (wp) { return wp.plans[courseName] = { description: description, color: color }; })];\n                    case 1:\n                        _c.sent();\n                        return [3 /*break*/, 4];\n                    case 2:\n                        plans = {};\n                        plans[courseName] = { description: description, color: color };\n                        return [4 /*yield*/, env.kgTermPlannerRepo.insert([{\n                                    id: createUUID(),\n                                    dateTime: weekDate,\n                                    plans: plans\n                                }])];\n                    case 3:\n                        _c.sent();\n                        _c.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekNoteDialog.prototype.render = function () {\n        var _this = this;\n        var _a = this.props, weekNumber = _a.weekNumber, courseName = _a.courseName, weekPlan = _a.weekPlan, note = _a.note, env = _a.env;\n        var _b = this.state, description = _b.description, color = _b.color;\n        var readOnly = env.tutored;\n        return React.createElement(\"div\", null,\n            React.createElement(\"div\", null,\n                React.createElement(\"h2\", null,\n                    \"H\\u00E4ndelse f\\u00F6r vecka \",\n                    weekNumber,\n                    \" och \",\n                    courseName),\n                React.createElement(\"hr\", null),\n                React.createElement(\"div\", { className: \"align-table\" },\n                    React.createElement(\"div\", null, \"Beskrivning:\"),\n                    React.createElement(\"div\", { className: \"fullWidth\" },\n                        React.createElement(\"textarea\", { autoFocus: true, value: description, disabled: readOnly, onChange: function (ev) { return _this.setState({ description: ev.target.value }); } }))),\n                React.createElement(\"div\", { className: \"align-table\" },\n                    React.createElement(\"div\", null, \"F\\u00E4rg:\"),\n                    React.createElement(\"div\", null,\n                        React.createElement(\"select\", { value: color, disabled: readOnly, onChange: function (ev) { return _this.setState({ color: ev.target.value }); } },\n                            React.createElement(\"option\", { value: \"yellow\" }, \"Gul\"),\n                            React.createElement(\"option\", { value: \"yellowLight\" }, \"Ljusgul\"),\n                            React.createElement(\"option\", { value: \"cyan\" }, \"Gr\\u00F6n\"),\n                            React.createElement(\"option\", { value: \"cyanLight\" }, \"Ljusgr\\u00F6n\"),\n                            React.createElement(\"option\", { value: \"purple\" }, \"Lila\"),\n                            React.createElement(\"option\", { value: \"purpleLight\" }, \"Ljuslila\"),\n                            React.createElement(\"option\", { value: \"red\" }, \"R\\u00F6d\"),\n                            React.createElement(\"option\", { value: \"redLight\" }, \"Rosa\"))))),\n            React.createElement(\"div\", null, readOnly ?\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.props.closeDialog(); } }, \"Avbryt\") :\n                React.createElement(React.Fragment, null,\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } }, \"Spara\"),\n                    note && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return _this.delete(); } }, \"Ta bort\"))));\n    };\n    return WeekNoteDialog;\n}(React.Component));\nexport { WeekNoteDialog };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport env from '../../globals/KED.env';\nimport { FutureAbilitiesViewModel } from './future-abilities-viewmodel';\nvar FutureAbilitiesTable = /** @class */ (function (_super) {\n    tslib_1.__extends(FutureAbilitiesTable, _super);\n    function FutureAbilitiesTable(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            loading: false,\n            data: [],\n            error: null\n        };\n        return _this;\n    }\n    FutureAbilitiesTable.prototype.componentWillMount = function () {\n        this.load();\n    };\n    FutureAbilitiesTable.prototype.load = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var data, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.setState({ loading: true });\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, env.edsClient.getStudentFutureAbilities()];\n                    case 2:\n                        data = _a.sent();\n                        this.setState({ data: data });\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_1 = _a.sent();\n                        this.setState({ error: error_1 });\n                        return [3 /*break*/, 4];\n                    case 4:\n                        this.setState({ loading: false });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    FutureAbilitiesTable.prototype.render = function () {\n        var viewModel = new FutureAbilitiesViewModel(this.state.data);\n        var columnHeaders = viewModel.columnHeaders, vtHts = viewModel.vtHts, capabRows = viewModel.capabRows;\n        return React.createElement(\"div\", null,\n            React.createElement(\"h5\", null, \"Framtidsf\\u00F6rm\\u00E5gor\"),\n            React.createElement(\"div\", { className: \"partialEditStudyPlanViewMode\" },\n                React.createElement(\"table\", { style: { width: '100%' }, className: \"smallFont\" },\n                    React.createElement(\"thead\", null,\n                        React.createElement(\"tr\", null, columnHeaders.map(function (_a, i) {\n                            var name = _a.name, type = _a.type;\n                            return type === 'header' ?\n                                React.createElement(\"th\", { key: i, rowSpan: 2 }, name) :\n                                React.createElement(\"th\", { key: i, colSpan: 2 }, name);\n                        })),\n                        React.createElement(\"tr\", { className: \"header\" }, vtHts.map(function (vtHt, i) { return React.createElement(\"th\", { key: i }, vtHt); }))),\n                    React.createElement(\"tbody\", null, capabRows.map(function (row, i) { return React.createElement(\"tr\", { key: i, className: (Math.floor(i / 3) % 2) && 'tableOdd' }, row.map(function (col, i) { return col.type === 'ability' ?\n                        React.createElement(\"td\", { key: i, rowSpan: 3, className: \"goalsSubject\" }, col.name) :\n                        col.type === 'capability' ?\n                            React.createElement(\"td\", { key: i, className: \"goalsSubject\" }, col.name) :\n                            col.selected ?\n                                React.createElement(\"td\", { key: i, className: \"edsSelected\" },\n                                    React.createElement(\"div\", { className: \"markedItem\" })) :\n                                React.createElement(\"td\", { key: i }); })); })))));\n    };\n    return FutureAbilitiesTable;\n}(React.Component));\nexport { FutureAbilitiesTable };\n","import { flatten } from '../../utils/utils';\nvar FutureAbilitiesViewModel = /** @class */ (function () {\n    function FutureAbilitiesViewModel(data) {\n        // Will build the total years\n        var formNames = {};\n        data.forEach(function (a) { return a.capabilities.forEach(function (c) { return formNames[c.formName] = true; }); });\n        var years = Object.keys(formNames);\n        // columnHeaders\n        this.columnHeaders = [{\n                name: \"Framtidsförmåga\",\n                type: \"header\"\n            }, {\n                name: \"Område\",\n                type: \"header\"\n            }].concat(years.map(function (year) { return ({\n            name: year,\n            type: 'year'\n        }); }));\n        // vtHts\n        this.vtHts = flatten(years.map(function (year) { return [\"HT\", \"VT\"]; }));\n        // cababRows\n        var rows = [];\n        data.forEach(function (a) {\n            var row = [{ type: 'ability', name: a.abilityName }];\n            var addedCapabs = {};\n            a.capabilities.forEach(function (c) {\n                var cells = [\n                    { type: 'term', selected: c.htHasValue !== false },\n                    { type: 'term', selected: c.vtHasValue !== false }\n                ];\n                //if (c.htHasValue || c.vtHasValue) debugger;\n                if (!addedCapabs[c.capabilityName]) {\n                    //if (!isFirstCapability) rows.push(row);\n                    if (row.length > 1) {\n                        rows.push(row);\n                        row = [];\n                    }\n                    addedCapabs[c.capabilityName] = true;\n                    row.push({ type: 'capability', name: c.capabilityName });\n                    cells.forEach(function (cell) { return row.push(cell); });\n                }\n                else if (row) {\n                    //addedCapabs[c.capabilityName].concat(cells);\n                    cells.forEach(function (cell) { return row.push(cell); });\n                }\n            });\n            if (row)\n                rows.push(row);\n        });\n        this.capabRows = rows;\n    }\n    return FutureAbilitiesViewModel;\n}());\nexport { FutureAbilitiesViewModel };\n","import { EDSPeriod } from '../../apis/edsclient';\nvar ViewModel = /** @class */ (function () {\n    function ViewModel(studyPlans) {\n        this.subjects = studyPlans.map(function (sp) {\n            var periodGoals = sp.periodGoals\n                .map(function (g) { return ({ period: new EDSPeriod(g.periodName), goal: g.gradeName }); });\n            return {\n                name: sp.courseUnitName,\n                atGoal: periodGoals.filter(function (_a) {\n                    var period = _a.period;\n                    return period.term === 'AT';\n                }).map(function (_a) {\n                    var goal = _a.goal;\n                    return goal;\n                })[0],\n                stGoal: periodGoals.filter(function (_a) {\n                    var period = _a.period;\n                    return period.term === 'ST';\n                }).map(function (_a) {\n                    var goal = _a.goal;\n                    return goal;\n                })[0],\n                finalGoal: sp.finalGoalGrade,\n                strategies: sp.strategyText\n            };\n        });\n    }\n    return ViewModel;\n}());\nexport { ViewModel };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { L } from '../../utils/utils';\nimport { ViewModel } from './goals-viewmodel';\nimport env from '../../globals/KED.env';\nimport { FutureAbilitiesTable } from './future-abilities-table';\nvar KSGoals = /** @class */ (function (_super) {\n    tslib_1.__extends(KSGoals, _super);\n    function KSGoals(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            loadingStudyPlans: false,\n            studyPlans: [],\n            error: null\n        };\n        return _this;\n    }\n    KSGoals.prototype.componentWillMount = function () {\n        this.load();\n    };\n    KSGoals.prototype.load = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var studyPlans, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.setState({ loadingStudyPlans: true });\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, env.edsClient.getStudentGoals()];\n                    case 2:\n                        studyPlans = _a.sent();\n                        this.setState({ studyPlans: studyPlans });\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_1 = _a.sent();\n                        this.setState({ error: error_1 });\n                        return [3 /*break*/, 4];\n                    case 4:\n                        this.setState({ loadingStudyPlans: false });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KSGoals.prototype.render = function () {\n        var viewModel = new ViewModel(this.state.studyPlans);\n        var showTermGoals = ('' + env.currentUser.schoolType).toLowerCase() !== \"gymnasium\";\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\n            React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"M\\u00E5l\"], [\"M\\u00E5l\"])))),\n            React.createElement(\"hr\", null),\n            React.createElement(\"table\", { className: \"smallFont\" },\n                React.createElement(\"thead\", null,\n                    React.createElement(\"tr\", null,\n                        React.createElement(\"th\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"])))),\n                        showTermGoals && React.createElement(\"th\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"HT\"], [\"HT\"])))),\n                        showTermGoals && React.createElement(\"th\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"VT\"], [\"VT\"])))),\n                        React.createElement(\"th\", null, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Slutm\\u00E5l\"], [\"Slutm\\u00E5l\"])))),\n                        React.createElement(\"th\", null, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Strategier\"], [\"Strategier\"])))))),\n                React.createElement(\"tbody\", null, viewModel.subjects.map(function (s, i) {\n                    return React.createElement(\"tr\", { key: s.name, className: i % 2 && \"tableOdd\" },\n                        React.createElement(\"td\", { className: \"goalsSubject\" }, s.name),\n                        showTermGoals && React.createElement(\"td\", { className: \"goalsTerm\" }, s.atGoal),\n                        showTermGoals && React.createElement(\"td\", { className: \"goalsTerm\" }, s.stGoal),\n                        React.createElement(\"td\", { className: \"goalsEnd\" }, s.finalGoal),\n                        React.createElement(\"td\", null, s.strategies));\n                }))),\n            React.createElement(\"div\", { className: \"divider\" }),\n            React.createElement(FutureAbilitiesTable, null));\n    };\n    return KSGoals;\n}(React.Component));\nexport { KSGoals };\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\n","import * as React from 'react';\nimport { KSTermPlanner } from './termplanner';\nimport env from '../../globals/KED.env';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nexport function KSTermPlannerSelf(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(KSTermPlanner, { env: env, tutored: false, initialDate: new Date() }));\n}\n","import * as React from 'react';\nimport { KSTermPlanner } from './termplanner';\nimport { TutorableComponent } from '../utility-components/tutorable-component';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nexport function KSTermPlannerTutored(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\n                return React.createElement(KSTermPlanner, { key: env.currentUser.mail, env: env, tutored: true, initialDate: new Date() });\n            } }));\n}\n","export function getFirstAndLastWeek(term) {\n    return term === 'AT' ?\n        [33, 50] : // This is a guess! Need data! Should be possible to get from skola24?\n        [2, 23]; // This is a guess! Need data!\n}\nexport var LAST_STEP_SPRING = 28; // Week 28 is in summer. Use it as placeholder for \"last step\"\nexport var LAST_STEP_AUTUMN = 52; // Week must be valid. Use it as placeholder for \"last step\"\n/**\n * Note that this function is tightly coupled to the swedish school.\n */\nexport function findCourseFromColumnHeader(courses, columnHeader) {\n    switch (columnHeader) {\n        case 'M.spr': return courses\n            .filter(function (course) { return course.shortName !== 'MA' && course.shortName.startsWith('M'); })[0] || null;\n        case 'Ma': return courses.filter(function (c) { return c.shortName === \"MA\"; })[0] || null;\n        case 'Sv/SvA': return courses.filter(function (c) { return c.shortName.startsWith(\"SV\"); })[0] || null;\n        case 'Eng': return courses.filter(function (c) { return c.shortName === \"EN\"; })[0] || null;\n    }\n    return null;\n}\nexport function getColumnsHeader(locale) {\n    switch (locale) {\n        case 'sv':\n            return ['M.spr', 'Ma', 'Sv/SvA', 'Eng'];\n        case 'en_sin':\n            return ['MFL', 'Ma', 'Hi', 'Eng', 'Yoga', 'ICT'];\n        case 'en_nin':\n            return ['MFL', 'Ma', 'Hi', 'Eng', 'Yoga', 'ICT'];\n    }\n}\n/**\n * Note that this function is tightly coupled to the swedish school.\n */\nexport function getColumnHeaderFromCourse(course) {\n    var shortName = course.shortName;\n    if (shortName === \"MA\")\n        return 'Ma';\n    if (shortName === \"EN\")\n        return 'Eng';\n    if (shortName.startsWith(\"SV\"))\n        return 'Sv/SvA';\n    if (shortName.startsWith(\"M2\"))\n        return 'M.spr';\n    return null;\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { GenericSchoolTerm } from '../../utils/generic-school-term';\nimport { ViewModel } from './viewmodel';\nimport { ContentEditableField } from '../utility-components/content-editable-field';\nimport '../../repos/ks-termplanner-repo-instance';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { FormattedMessage } from 'react-intl';\nimport cfg from '../../globals/KED.cfg';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport { Doughnut } from '../charts/doughnut';\nimport { getSchoolTranslatedSubjectFullname } from '../../utils/generic-school-utils';\nimport { Dialogs } from '../utility-components/dialogs';\nimport { TutorDialog } from './tutor-dialog';\nimport { DocumentAccess } from 'kedbackend/client';\nimport { features } from '../../features';\nimport { OpenCloseBox } from '../utility-components/open-close-box';\nvar KSTermPlanner = /** @class */ (function (_super) {\n    tslib_1.__extends(KSTermPlanner, _super);\n    function KSTermPlanner(props) {\n        var _this = _super.call(this, props) || this;\n        _this.unmounted = false;\n        _this.state = {\n            schoolTerm: new GenericSchoolTerm(props.initialDate),\n            activeCourses: [],\n            weekPlans: [],\n            error: null,\n            loadingActiveCourses: false,\n            loadingWeekPlans: false,\n            initialLoad: true,\n            dialogs: []\n        };\n        _this.flowId = 1;\n        _this.updateWeekPlans = _this.updateWeekPlans.bind(_this);\n        return _this;\n    }\n    KSTermPlanner.prototype.componentDidMount = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.load(this.state.schoolTerm)];\n                    case 1:\n                        _a.sent();\n                        if (!this.unmounted)\n                            this.props.env.ksTermPlannerRepo.mem.subscribe(this.updateWeekPlans);\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KSTermPlanner.prototype.componentWillUnmount = function () {\n        this.unmounted = true;\n        this.props.env.ksTermPlannerRepo.mem.unsubscribe(this.updateWeekPlans);\n    };\n    KSTermPlanner.prototype.updateWeekPlans = function (weekPlansOrTutorComm, error) {\n        this.setState({ weekPlans: weekPlansOrTutorComm, loadingWeekPlans: false, error: error || null });\n    };\n    KSTermPlanner.prototype.load = function (schoolTerm) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var flowId, ksTermPlannerRepo, term, currentSchoolTerm, activeCourses, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        flowId = ++this.flowId;\n                        this.fields = [];\n                        this.setState({\n                            //loadingWeekPlans: true,\n                            loadingActiveCourses: true\n                        });\n                        ksTermPlannerRepo = this.props.env.ksTermPlannerRepo;\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 4, , 5]);\n                        return [4 /*yield*/, this.loadAcademicYearDates(schoolTerm, cfg.KED_SCHOOL_LOCALE)];\n                    case 2:\n                        term = _a.sent();\n                        if (this.flowId !== flowId)\n                            return [2 /*return*/];\n                        currentSchoolTerm = new GenericSchoolTerm(schoolTerm.selectedDate, this.context.intl.locale, term);\n                        //refresh saved data\n                        ksTermPlannerRepo.refreshData(currentSchoolTerm.getTermStartAndEnd(true));\n                        return [4 /*yield*/, this.loadActiveCourses(currentSchoolTerm)];\n                    case 3:\n                        activeCourses = _a.sent();\n                        if (this.flowId !== flowId)\n                            return [2 /*return*/];\n                        this.setState({ schoolTerm: currentSchoolTerm, initialLoad: false, activeCourses: activeCourses, loadingActiveCourses: false });\n                        return [3 /*break*/, 5];\n                    case 4:\n                        error_1 = _a.sent();\n                        if (this.flowId !== flowId)\n                            return [2 /*return*/];\n                        this.setState({ schoolTerm: currentSchoolTerm, loadingActiveCourses: false, error: error_1 });\n                        return [3 /*break*/, 5];\n                    case 5: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KSTermPlanner.prototype.loadAcademicYearDates = function (schoolTerm, schoolLocale) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var termDates;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.props.env.edsClient.getAcademicYearTerms(schoolLocale, schoolTerm.selectedDate)];\n                    case 1:\n                        termDates = _a.sent();\n                        return [2 /*return*/, termDates];\n                }\n            });\n        });\n    };\n    KSTermPlanner.prototype.loadActiveCourses = function (schoolTerm) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var periodName, activeCourses;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        periodName = schoolTerm.getEdsPeriodName();\n                        return [4 /*yield*/, this.props.env.edsClient.getActiveCourses({ periodName: periodName })];\n                    case 1:\n                        activeCourses = _a.sent();\n                        return [2 /*return*/, activeCourses];\n                }\n            });\n        });\n    };\n    KSTermPlanner.prototype.updateCell = function (weekPlan, columnName, newValue) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var oldValue, error_2;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        oldValue = (weekPlan && weekPlan.cellValues[columnName]) || \"\";\n                        if (oldValue === newValue)\n                            return [2 /*return*/];\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        weekPlan.cellValues[columnName] = newValue;\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.upsert(weekPlan, function (wp) { return wp.cellValues[columnName] = newValue; })];\n                    case 2: return [2 /*return*/, _a.sent()];\n                    case 3:\n                        error_2 = _a.sent();\n                        console.error(error_2.stack || error_2);\n                        if (error_2.name === \"http403\") {\n                            this.setState({ error: this.context.intl({ id: \"common.changesNotSavedUnauthorized\", defaultMessage: \"Ändringarna sparades inte p.g.a. otillräcklig behörighet.\" }) });\n                        }\n                        else {\n                            this.setState({ error: this.context.intl({ id: \"common.changesNotSavedErrorOccured\", defaultMessage: \"För tillfället problem att spara data. Dina ändringar sparades inte.\" }) });\n                        }\n                        return [3 /*break*/, 4];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     *\n     * @param tutorNote\n     * @param newValue\n     *\n     * Update tutor field value\n     */\n    KSTermPlanner.prototype.updateTutorNoteField = function (tutorNote, newValue) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var oldValue, showError_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        oldValue = (tutorNote && tutorNote.content) || \"\";\n                        if (oldValue === newValue)\n                            return [2 /*return*/];\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        tutorNote.content = newValue;\n                        //set document ACL\n                        tutorNote.acl = [\n                            new DocumentAccess(\"tutorFor\", this.props.env.currentUser.mail, \"S\").toString(),\n                            new DocumentAccess(\"email\", this.props.env.currentUser.mail, \"R\").toString(),\n                        ];\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.upsert(tutorNote, function (note) { return note.content = newValue; })];\n                    case 2: return [2 /*return*/, _a.sent()];\n                    case 3:\n                        showError_1 = _a.sent();\n                        return [3 /*break*/, 4];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Delete tutor comment by Id\n     * @param noteId\n     */\n    KSTermPlanner.prototype.deleteTutorNoteField = function (noteId) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var showError_2;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this.props.env.ksTermPlannerRepo.delete([noteId])];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        showError_2 = _a.sent();\n                        return [3 /*break*/, 3];\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Add a comment from tutor\n     * @param weekNumber\n     * @param comment\n     *\n     */\n    KSTermPlanner.prototype.onTutorClick = function (note) {\n        var _this = this;\n        this.openDialog(React.createElement(TutorDialog, { weekNumber: note.weekNumber, comment: note.content, intl: this.context.intl, updateData: function (val) { return _this.updateTutorNoteField(note, val); }, deleteNoteData: function () { return _this.deleteTutorNoteField(note.id); }, closeDialog: function () { return _this.closeDialog(); } }));\n    };\n    KSTermPlanner.prototype.openDialog = function (dialog) {\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\n    };\n    KSTermPlanner.prototype.closeDialog = function () {\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\n    };\n    /**\n     * Navigate to adjacent field depending on direction\n     * @param pos current position in field-matrix\n     * @param direction direction to take\n     */\n    KSTermPlanner.prototype.navigate = function (pos, direction) {\n        var newpos = tslib_1.__assign({}, pos);\n        var maxRows = this.fields.length;\n        var maxCols = Math.max.apply(Math, tslib_1.__spread(this.fields.map(function (row) { return row.length; })));\n        switch (direction) {\n            case 'up':\n                newpos.row = Math.max(pos.row - 1, 0);\n                break;\n            case 'down':\n                newpos.row = Math.min(pos.row + 1, maxRows);\n                break;\n            case 'left':\n                newpos.col = Math.max(pos.col - 1, 0);\n                break;\n            case 'right':\n                newpos.col = Math.min(pos.col + 1, maxCols);\n                break;\n        }\n        if (this.fields[newpos.row] && this.fields[newpos.row][newpos.col])\n            this.fields[newpos.row][newpos.col].myself.current.focus();\n    };\n    /**\n     * Adds field to field-matrix to enable navigation in thee table\n     * @param field current field\n     * @param pos position of field in field-matrix\n     */\n    KSTermPlanner.prototype.addField = function (field, pos) {\n        if (this.fields[pos.row] === undefined) {\n            this.fields[pos.row] = [];\n        }\n        this.fields[pos.row][pos.col] = field;\n    };\n    /**\n     * Creates the cell in the termplanner table\n     * @param rowIndex index of row in table\n     * @param colIndex index of column in table\n     * @param subjectName name field\n     * @param model --unused?\n     * @param weekPlan current row from weekPlan\n     * @param readOnlyCells if cells are readonly\n     */\n    KSTermPlanner.prototype.getTableCell = function (rowIndex, colIndex, subjectName, model, weekPlan, readOnlyCells, colType) {\n        var _this = this;\n        var completedSteps = model.completedSteps;\n        var pos = { row: rowIndex, col: colIndex };\n        var uniqueKey = subjectName + rowIndex;\n        if (colType === 'Tutor') {\n            var tutoredWeekPlan = weekPlan;\n            var content = tutoredWeekPlan.content;\n            if (this.props.tutored) {\n                return React.createElement(\"td\", { key: \"tutornote\" + uniqueKey, onClick: function () { return _this.onTutorClick(tutoredWeekPlan); }, className: \"tutorCell\" }, content ? React.createElement(\"div\", { key: uniqueKey, \"data-tooltip\": content },\n                    React.createElement(\"i\", { className: \"fas fa-comment-dots\" })) :\n                    React.createElement(\"div\", { key: uniqueKey },\n                        React.createElement(\"i\", { className: \"fas fa-comment-medical\" })));\n            }\n            return React.createElement(\"td\", { key: \"tutornote\" + uniqueKey, className: \"tutorCell\" }, content && React.createElement(\"div\", { key: uniqueKey, \"data-tooltip\": content },\n                React.createElement(\"i\", { className: \"far fa-comment-dots\" })));\n        }\n        else {\n            var currentWeekPlan = weekPlan;\n            var cellValues = currentWeekPlan.cellValues;\n            // an outer td cell and inner div is used to regulate the height and allow for ellipses on text-overflow\n            return React.createElement(\"td\", { key: \"tutornote\" + uniqueKey, className: this.getCellClassName(completedSteps, cellValues, subjectName) },\n                React.createElement(ContentEditableField, { key: uniqueKey, ref: function (field) { return _this.addField(field, pos); }, text: cellValues[subjectName], tag: 'div', validateValue: colType == 'Step' ? /^\\d*$/ : undefined, maxChars: colType == 'Comment' ? 100 : (colType == 'Course' ? 30 : 3), onChange: this.updateCell.bind(this, weekPlan, subjectName), readOnly: readOnlyCells || colType == 'Tutor', allowNavigation: true, onNavigate: this.navigate.bind(this, pos) }));\n        }\n    };\n    /**\n     * Get classname for cell\n     * @param completedSteps\n     * @param cellValues\n     * @param subjectName\n     */\n    KSTermPlanner.prototype.getCellClassName = function (completedSteps, cellValues, subjectName) {\n        var colType = this.getColumnType(subjectName);\n        if (colType == 'Step' && completedSteps[subjectName + cellValues[subjectName]]) {\n            return 'stepCell completedStep';\n        }\n        return colType.toLowerCase() + 'Cell';\n    };\n    /**\n     * Creates the cell in the termplanner tables footer\n     * @param rowIndex index of row in table\n     * @param colIndex index of column in table\n     * @param subjectName name field\n     * @param model\n     * @param readOnlyCells if cells are readonly\n     */\n    KSTermPlanner.prototype.getFooterCell = function (rowIndex, colIndex, subjectName, model, readOnlyCells) {\n        var _this = this;\n        var pos = { row: rowIndex, col: colIndex };\n        var colType = this.getColumnType(subjectName);\n        return React.createElement(\"th\", { className: colType + \"Footer\" },\n            React.createElement(ContentEditableField, { key: \"stepFooterCell\" + colIndex, ref: function (field) { return _this.addField(field, pos); }, tag: 'div', text: model.lastSteps.cellValues[subjectName], onChange: this.updateCell.bind(this, model.lastSteps, subjectName), readOnly: readOnlyCells, maxChars: 10, allowNavigation: true, onNavigate: this.navigate.bind(this, pos) }));\n    };\n    KSTermPlanner.prototype.getStepHeaderColumn = function (index, translatedColumnHeader, colType) {\n        return React.createElement(\"th\", { key: \"stepHeaderCell_\" + index, className: colType.toLowerCase() + \"Header\" }, colType != 'Tutor' ? translatedColumnHeader : '');\n    };\n    KSTermPlanner.prototype.getColumnType = function (name) {\n        var colTypes = { 'Kommentar': 'Comment', 'Kurs': 'Course', 'TutorComment': 'Tutor' };\n        return colTypes.hasOwnProperty(name) ? colTypes[name] : 'Step';\n    };\n    KSTermPlanner.prototype.openCloseProgressCharts = function (value) {\n        localStorage.setItem('TermplannerBoxCharts', value);\n    };\n    KSTermPlanner.prototype.getStepCharts = function (columns, subjectProgress) {\n        var _this = this;\n        var chartsBoxState = JSON.parse(localStorage.getItem('TermplannerBoxCharts'));\n        return React.createElement(OpenCloseBox, { headerOpen: chartsBoxState, onOpenClose: this.openCloseProgressCharts, title: this.context.intl.formatMessage({ id: \"termplanner.chartsBoxTitle\", defaultMessage: \"Min progression\" }) },\n            React.createElement(\"div\", { className: \"charts-container\" }, columns.map(function (element) {\n                if (!element.isFixed) {\n                    var percentage = subjectProgress[element.name] ? subjectProgress[element.name].value : 0;\n                    var errorMessage = subjectProgress[element.name].finalStepCompleted ? null :\n                        _this.context.intl.formatMessage({ id: \"termplanner.noFinalStepAvailable\", defaultMessage: \"Inget slutsteg tillgängligt\" });\n                    var translatedColumns = getSchoolTranslatedSubjectFullname(_this.context.intl);\n                    return React.createElement(\"div\", { key: element.name, className: \"chart-box\" },\n                        React.createElement(\"h4\", null, translatedColumns[element.name]),\n                        React.createElement(\"div\", { key: element.name, className: \"inner-chart-box\" },\n                            React.createElement(Doughnut, { key: element.name, percentage: percentage, errorMessage: errorMessage })));\n                }\n            })));\n    };\n    KSTermPlanner.prototype.getWeekTutorNote = function (weekPlansOrTutorNote, weekNumber) {\n        return weekPlansOrTutorNote.find(function (x) { return x.type === \"tutor-note\" && x.weekNumber === weekNumber; });\n    };\n    KSTermPlanner.prototype.render = function () {\n        var _this = this;\n        var intl = this.context.intl;\n        var showTutorCommentField = features.ksTutorComment;\n        var showDoughnutCharts = features.termplannerCharts;\n        var model = new ViewModel(this.state.weekPlans, this.state.activeCourses, this.state.schoolTerm, cfg.KED_SCHOOL_LOCALE, intl, showTutorCommentField);\n        var termGoals = model.termGoals, columns = model.columns;\n        var tutored = this.props.tutored;\n        var _a = this.state, loadingWeekPlans = _a.loadingWeekPlans, error = _a.error, dbWeekPlans = _a.weekPlans, dialogs = _a.dialogs;\n        var failedInitialLoad = dbWeekPlans.length === 0 && !!error;\n        var readOnlyCells = failedInitialLoad || tutored || loadingWeekPlans;\n        var rowOffset = 0;\n        var filteredWeekplans = model.weekPlansOrTutorNote.filter(function (x) { return !x.type; });\n        return this.state.initialLoad ? React.createElement(\"p\", null,\n            React.createElement(Spinner, null),\n            React.createElement(FormattedMessage, { id: \"termplanner.loadingTermplanner\", defaultMessage: \"V.g. v\\u00E4nta medan terminsplaner laddas...\" })) :\n            React.createElement(\"div\", { className: \"termplanner\" +\n                    (this.state.loadingWeekPlans ? \" loading-weekplans\" : \"\") +\n                    (this.state.loadingActiveCourses ? \" loading-courses\" : \"\") },\n                showDoughnutCharts && this.state.activeCourses.length > 0 && this.getStepCharts(columns, model.subjectProgress),\n                React.createElement(\"div\", { className: \"ked_boxed\" },\n                    React.createElement(\"div\", { className: \"weekSelect\" },\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\n                            React.createElement(\"p\", null, this.state.schoolTerm.toLocaleString(intl, true))),\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\n                            React.createElement(\"div\", { className: \"btn-group\" },\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () {\n                                        var term = _this.state.schoolTerm.prevTerm();\n                                        _this.load(term);\n                                    } },\n                                    React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () {\n                                        var term = _this.state.schoolTerm.nextTerm();\n                                        _this.load(term);\n                                    } },\n                                    React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" }))))),\n                    React.createElement(FormattedMessage, { id: \"termplanner.termPlanning\", defaultMessage: \"Terminsplanering\", tagName: \"h4\" }),\n                    React.createElement(\"hr\", null),\n                    React.createElement(\"table\", { className: \"termplanner-table zebra\" },\n                        React.createElement(\"thead\", null,\n                            React.createElement(\"tr\", null,\n                                React.createElement(\"th\", { className: \"weekColumn\" },\n                                    React.createElement(FormattedMessage, { id: \"termplanner.weekNumber\", defaultMessage: \"Vecka\" })),\n                                columns.map(function (elem, index) {\n                                    var colType = _this.getColumnType(elem.name);\n                                    return _this.getStepHeaderColumn(index, elem.translatedName, colType);\n                                }))),\n                        React.createElement(\"tbody\", null, filteredWeekplans.filter(function (wk) { return wk.cellValues; }).map(function (weekPlan, rowIndex) {\n                            rowOffset = rowIndex;\n                            var weekNumber = weekPlan.weekNumber, academicWeekNumber = weekPlan.academicWeekNumber;\n                            var week = weekNumber;\n                            var displayWeek = intl.locale === \"sv\" ? week : academicWeekNumber;\n                            var isCurrentWeek = _this.state.schoolTerm.isCurrentWeek(weekPlan.dateTime);\n                            return React.createElement(\"tr\", { key: model.year + ':' + week, className: isCurrentWeek ? \"currentWeek\" : \"\" },\n                                React.createElement(\"td\", null, displayWeek),\n                                columns.map(function (elem, colIndex) {\n                                    var colType = _this.getColumnType(elem.name);\n                                    var tutorValue = _this.getWeekTutorNote(model.weekPlansOrTutorNote, weekNumber);\n                                    return colType === \"Tutor\" ?\n                                        tutorValue && showTutorCommentField && _this.getTableCell(rowIndex, colIndex, elem.name, model, tutorValue, readOnlyCells, colType) :\n                                        _this.getTableCell(rowIndex, colIndex, elem.name, model, weekPlan, readOnlyCells, colType);\n                                }));\n                        })),\n                        React.createElement(\"tfoot\", null,\n                            React.createElement(\"tr\", null,\n                                React.createElement(\"th\", null,\n                                    React.createElement(FormattedMessage, { id: \"termplanner.finalStep\", defaultMessage: \"Slutsteg\" })),\n                                columns.filter(function (c) { return !c.isFixed; }).map(function (elem, index) {\n                                    return _this.getFooterCell(rowOffset + 1, index, elem.name, model, readOnlyCells);\n                                }),\n                                React.createElement(\"th\", null, \"-\"),\n                                React.createElement(\"th\", null),\n                                showTutorCommentField && React.createElement(\"th\", null)),\n                            React.createElement(\"tr\", null,\n                                React.createElement(\"th\", null,\n                                    React.createElement(FormattedMessage, { id: \"termplanner.edsGoalGrades\", defaultMessage: \"Terminsm\\u00E5l\" })),\n                                columns.filter(function (c) { return !c.isFixed; }).map(function (elem, index) {\n                                    var colType = _this.getColumnType(elem.name).toLowerCase();\n                                    return React.createElement(\"th\", { key: \"grades_\" + index, className: colType + \"Footer\" }, termGoals[elem.name]);\n                                }),\n                                React.createElement(\"th\", null, \"-\"),\n                                React.createElement(\"th\", null, this.state.error && React.createElement(\"p\", { className: \"error\" }, '' + this.state.error)),\n                                showTutorCommentField && React.createElement(\"th\", null))))),\n                React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () { return _this.setState({ dialogs: dialogs.slice(0, dialogs.length - 1) }); } }));\n    };\n    KSTermPlanner.contextType = LanguageContext;\n    return KSTermPlanner;\n}(React.Component));\nexport { KSTermPlanner };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nvar TutorDialog = /** @class */ (function (_super) {\n    tslib_1.__extends(TutorDialog, _super);\n    function TutorDialog(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            comment: props.comment ? props.comment : ''\n        };\n        return _this;\n    }\n    TutorDialog.prototype.delete = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var closeDialog;\n            return tslib_1.__generator(this, function (_a) {\n                closeDialog = this.props.closeDialog;\n                closeDialog();\n                this.props.deleteNoteData();\n                return [2 /*return*/];\n            });\n        });\n    };\n    TutorDialog.prototype.save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var closeDialog, comment;\n            return tslib_1.__generator(this, function (_a) {\n                closeDialog = this.props.closeDialog;\n                comment = this.state.comment;\n                closeDialog();\n                this.props.updateData(comment);\n                return [2 /*return*/];\n            });\n        });\n    };\n    TutorDialog.prototype.render = function () {\n        var _this = this;\n        var _a = this.props, weekNumber = _a.weekNumber, intl = _a.intl;\n        var comment = this.state.comment;\n        return React.createElement(\"div\", null,\n            React.createElement(\"div\", null,\n                React.createElement(\"h2\", null, intl ? intl.formatMessage({ id: \"tutorNoteDialog.weekComment\", defaultMessage: \"Kommentar för vecka {weekNumber}\" }, { weekNumber: weekNumber }) : \"Kommentar f\\u00F6r vecka \" + weekNumber),\n                React.createElement(\"hr\", null),\n                React.createElement(\"div\", { className: \"align-table\" },\n                    React.createElement(\"div\", { className: \"fullWidth\" },\n                        React.createElement(\"textarea\", { autoFocus: true, value: comment, onChange: function (ev) { return _this.setState({ comment: ev.target.value }); } })))),\n            React.createElement(\"div\", null, React.createElement(React.Fragment, null,\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } },\n                    intl ? intl.formatMessage({ id: \"common.save\", defaultMessage: \"Spara\" }) : 'Spara',\n                    \" \"),\n                comment && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return _this.delete(); } }, intl ? intl.formatMessage({ id: \"common.remove\", defaultMessage: \"Ta bort\" }) : \"Ta bort\"))));\n    };\n    return TutorDialog;\n}(React.Component));\nexport { TutorDialog };\n","import * as tslib_1 from \"tslib\";\nimport { getColumnsHeader, getColumnHeaderFromCourse, } from './termplanner-utils';\nimport moment from 'moment';\nimport { createUUID } from 'kedbackend/client';\nimport { KEDWeek } from '../../utils/weekutil';\nimport { getSchoolTranslatedSubjects } from '../../utils/generic-school-utils';\nvar ViewModel = /** @class */ (function () {\n    function ViewModel(dbWeekPlans, \n    //dbTutorNotes: TermPlannerTutorNote[],\n    courses, currentSchoolTerm, currentSchoolLocale, intl, showTutorCommentField) {\n        var _a, e_1, _b;\n        var _this = this;\n        this.subjectProgress = {};\n        this.columns = [];\n        this.weekPlansOrTutorNote = [];\n        if (currentSchoolTerm.schoolMoment) {\n            var _c = tslib_1.__read(currentSchoolTerm.getTermStartAndEnd(), 2), termStart = _c[0], termEnd = _c[1];\n            this.year = termStart.year();\n            //init columns\n            var columnHeaders = getColumnsHeader(currentSchoolLocale);\n            columnHeaders.forEach(function (c) { return _this.columns.push({ name: c }); });\n            //define fixed columns - we keep these separated, in case that the other columns will be dynamically retrieved\n            var fixedColumns_1 = [{ name: \"Kurs\", isFixed: true }, { name: \"Kommentar\", isFixed: true }];\n            if (showTutorCommentField) {\n                fixedColumns_1.push({ name: \"TutorComment\", isFixed: true });\n            }\n            //Add fixed columns names\n            (_a = this.columns).push.apply(_a, tslib_1.__spread(fixedColumns_1));\n            //populate translations\n            var translatedColumns = getSchoolTranslatedSubjects(currentSchoolLocale, intl);\n            this.columns.forEach(function (element) {\n                element.translatedName = translatedColumns[element.name];\n            });\n            var currentTermHolidays = currentSchoolTerm.schoolMoment.academicYearStructure.holidays;\n            var currentTerm_1 = currentSchoolTerm.schoolMoment.term;\n            //\n            // weekPlans\n            //\n            var weekplanValues = dbWeekPlans.filter(function (x) { return !x.type; });\n            var tutorValues = dbWeekPlans.filter(function (w) { return w.type === 'tutor-note'; });\n            var startAcademicYearNumber = currentSchoolTerm.schoolMoment.academicYearStructure.academicStartWeek;\n            var _loop_1 = function (weekMoment) {\n                holidayPeriod = currentTermHolidays.filter(function (h) { return weekMoment.week() >= moment(h.startDate).startOf(\"week\").week() &&\n                    weekMoment.week() <= moment(h.endDate).endOf('week').week(); });\n                //if the current week is a holiday week, skip it\n                if (holidayPeriod.length > 0) {\n                    return \"continue\";\n                }\n                var weekNumber = weekMoment.week();\n                var kedWeek = KEDWeek(weekMoment.year(), weekNumber);\n                //A term can end and start on the same week for India\n                //in this case we should filter them by the term\n                //This is not the case for sv locale and we want to skip this check \n                //because data is already saved in the database\n                var weekPlan = weekplanValues.filter(function (wp) {\n                    return wp.dateTime >= kedWeek.notBefore &&\n                        wp.dateTime <= kedWeek.notAfter &&\n                        (!wp.isFinalStep &&\n                            wp.term === currentTerm_1 || intl.locale === \"sv\");\n                })[0];\n                var tutorNote = tutorValues.filter(function (wp) {\n                    return wp.dateTime >= kedWeek.notBefore &&\n                        wp.dateTime <= kedWeek.notAfter &&\n                        (wp.term === currentTerm_1 || intl.locale === \"sv\");\n                })[0];\n                this_1.weekPlansOrTutorNote.push(tslib_1.__assign({}, weekPlan || {}, { id: weekPlan ? weekPlan.id : createUUID(), dateTime: weekPlan ? weekPlan.dateTime : weekMoment.valueOf(), cellValues: weekPlan ? weekPlan.cellValues : {}, weekNumber: weekNumber, academicWeekNumber: startAcademicYearNumber++, term: currentTerm_1 }));\n                this_1.weekPlansOrTutorNote.push(tslib_1.__assign({}, tutorNote || {}, { id: tutorNote ? tutorNote.id : createUUID(), type: 'tutor-note', dateTime: tutorNote ? tutorNote.dateTime : weekMoment.valueOf(), content: tutorNote ? tutorNote.content : '', weekNumber: weekNumber, term: currentTerm_1 }));\n            };\n            var this_1 = this, holidayPeriod;\n            for (var weekMoment = termStart.clone(); weekMoment.valueOf() < termEnd.valueOf(); weekMoment = weekMoment.clone().add(1, 'week').startOf('week')) {\n                _loop_1(weekMoment);\n            }\n            //\n            // lastSteps\n            //\n            var lastStepWeek = currentSchoolTerm.getLastStepWeek(intl.locale);\n            var lastStepKedWeek_1 = KEDWeek(termEnd.year(), lastStepWeek);\n            this.lastSteps = weekplanValues.filter(function (wp) {\n                return wp.dateTime >= lastStepKedWeek_1.notBefore &&\n                    wp.dateTime <= lastStepKedWeek_1.notAfter &&\n                    (wp.isFinalStep &&\n                        wp.term === currentTerm_1 || intl.locale === \"sv\");\n            })[0] || {\n                id: createUUID(),\n                dateTime: moment(termEnd).clone().week(lastStepWeek).startOf('week').valueOf(),\n                cellValues: {},\n                weekNumber: lastStepWeek,\n                term: currentTerm_1,\n                isFinalStep: true\n            };\n            this.completedSteps = {};\n            this.termGoals = {};\n            var courseProgress = {};\n            var _loop_2 = function (course) {\n                var e_2, _a;\n                var columnHeader = getColumnHeaderFromCourse(course);\n                //\n                // Calculate \n                //\n                hasNoFinalStepValue = isNaN(parseInt(this_2.lastSteps.cellValues[columnHeader])) || !this_2.lastSteps.cellValues[columnHeader];\n                finalStepValue = hasNoFinalStepValue ? 0 : parseInt(this_2.lastSteps.cellValues[columnHeader]);\n                courseProgress[columnHeader] = null;\n                if (!hasNoFinalStepValue && finalStepValue > 0) {\n                    // Find the first step number\n                    var savedCourseValues = this_2.weekPlansOrTutorNote.filter(function (wp) { return wp.cellValues && wp.cellValues[columnHeader] != null; }).map(function (wp) { return wp.cellValues[columnHeader]; });\n                    var currentCourseValues = savedCourseValues.filter(function (cVal) { return !isNaN(parseInt(cVal)); });\n                    var firstStep = currentCourseValues.length > 0 && currentCourseValues.reduce(function (prev, curr) {\n                        return parseInt(prev) < parseInt(curr) ? prev : curr;\n                    });\n                    var firstStepValue_1 = firstStep ? parseInt(firstStep) : 0;\n                    if (firstStep && firstStepValue_1 <= finalStepValue) {\n                        //calculate the number of completed steps lower than the specified Slutsteg Value\n                        var rangeItems = course.courseSteps.filter(function (x) { return parseInt(x.shortName) <= finalStepValue && parseInt(x.shortName) >= firstStepValue_1; });\n                        var completedItems = rangeItems.filter(function (x) { return x.isCompleted; }).length;\n                        //set the progress for each EDS course\n                        courseProgress[columnHeader] = completedItems / rangeItems.length * 100;\n                    }\n                    else {\n                        courseProgress[columnHeader] = 0;\n                    }\n                }\n                try {\n                    //\n                    // completedSteps\n                    //\n                    for (var _b = (e_2 = void 0, tslib_1.__values(course.courseSteps)), _c = _b.next(); !_c.done; _c = _b.next()) {\n                        var step = _c.value;\n                        if (step.isCompleted) {\n                            this_2.completedSteps[columnHeader + step.shortName] = true;\n                        }\n                    }\n                }\n                catch (e_2_1) { e_2 = { error: e_2_1 }; }\n                finally {\n                    try {\n                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n                    }\n                    finally { if (e_2) throw e_2.error; }\n                }\n                //\n                // termGoals\n                //\n                this_2.termGoals[columnHeader] = course.periodGoalGrade;\n            };\n            var this_2 = this, hasNoFinalStepValue, finalStepValue;\n            try {\n                for (var courses_1 = tslib_1.__values(courses), courses_1_1 = courses_1.next(); !courses_1_1.done; courses_1_1 = courses_1.next()) {\n                    var course = courses_1_1.value;\n                    _loop_2(course);\n                }\n            }\n            catch (e_1_1) { e_1 = { error: e_1_1 }; }\n            finally {\n                try {\n                    if (courses_1_1 && !courses_1_1.done && (_b = courses_1.return)) _b.call(courses_1);\n                }\n                finally { if (e_1) throw e_1.error; }\n            }\n            if (courses) {\n                //init\n                columnHeaders.forEach(function (elem) {\n                    _this.subjectProgress[elem] = { finalStepCompleted: false, value: 0 };\n                });\n                //compute charts by computing  completed goal (saved data from kedbackend is not taken into account)/lastStepValue\n                Object.keys(this.lastSteps.cellValues).forEach(function (val) {\n                    //exclude the fixed columns. Charts should not be displayed for those\n                    if (!fixedColumns_1[val]) {\n                        _this.subjectProgress[val] = { finalStepCompleted: courseProgress[val] !== null, value: courseProgress[val] };\n                    }\n                });\n            }\n        }\n    }\n    return ViewModel;\n}());\nexport { ViewModel };\nfunction findWeekPlansByStep(weekPlans, step) {\n    return weekPlans.filter(function (wp) { return Object.keys(wp.cellValues).map(function (column) { return wp.cellValues[column] === step; }); });\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { L } from '../../utils/utils';\nimport env from '../../globals/KED.env';\nvar LatestAssessments = /** @class */ (function (_super) {\n    tslib_1.__extends(LatestAssessments, _super);\n    function LatestAssessments(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            assessments: [],\n            error: null,\n            loading: false\n        };\n        return _this;\n    }\n    LatestAssessments.prototype.componentWillMount = function () {\n        this.load();\n    };\n    LatestAssessments.prototype.load = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var assessments, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.setState({ loading: true });\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, env.edsClient.getLatestAssessments(this.props.limit)];\n                    case 2:\n                        assessments = _a.sent();\n                        this.setState({ assessments: assessments });\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_1 = _a.sent();\n                        this.setState({ error: error_1 });\n                        return [3 /*break*/, 4];\n                    case 4:\n                        this.setState({ loading: false });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    LatestAssessments.prototype.render = function () {\n        var hasGrades = this.state.assessments.some(function (a) { return !!a.gradeName; });\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\n            React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Senaste bed\\u00F6mningar\"], [\"Senaste bed\\u00F6mningar\"])))),\n            React.createElement(\"hr\", null),\n            React.createElement(\"ul\", { className: \"latest-assesments zebra\" }, this.state.assessments.map(function (a, i) {\n                return React.createElement(\"li\", { key: i },\n                    (hasGrades && a.gradeName != \"\") && React.createElement(\"span\", { className: \"grade pill pull-right\" }, a.gradeName),\n                    React.createElement(\"span\", { className: \"date pill pull-left\" }, a.publishDateTime.substr(0, 10)),\n                    a.courseName == a.courseUnitName ?\n                        React.createElement(\"h5\", null,\n                            React.createElement(\"strong\", null, a.courseName)) : React.createElement(\"h5\", null,\n                        React.createElement(\"strong\", null, a.courseName),\n                        \" / \",\n                        React.createElement(\"em\", null, a.courseUnitName)),\n                    React.createElement(\"br\", null),\n                    React.createElement(\"p\", null, a.text));\n            })));\n    };\n    return LatestAssessments;\n}(React.Component));\nexport { LatestAssessments };\nvar templateObject_1;\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { getLearningGoalsAndTasks } from '../../apis/ked-learninggoals';\nimport { LearningGoalsList } from '../course-viewer/subcomponents/learning-goals-list';\nimport { setupIntl } from '../utility-components/SetupLanguageIntl';\nimport { injectIntl } from 'react-intl';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nvar _LearningTasks = /** @class */ (function (_super) {\n    tslib_1.__extends(_LearningTasks, _super);\n    function _LearningTasks(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            data: null\n        };\n        return _this;\n    }\n    _LearningTasks.prototype.componentDidMount = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var data;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, getLearningGoalsAndTasks(this.props.apiPath, this.props.pageId)];\n                    case 1:\n                        data = _a.sent();\n                        this.setState({ data: data });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    _LearningTasks.prototype.render = function () {\n        if (!this.state.data)\n            return React.createElement(\"div\", null);\n        var _a = this.state.data, moduleName = _a.moduleName, subject = _a.subject, commonTasks = _a.commonTasks, learningGoals = _a.learningGoals, step = _a.step;\n        var intl = this.props.intl;\n        //const step = undefined; // moduleName.toLowerCase().startsWith(\"steg \") && parseInt(moduleName.substr(5));\n        var commonTasksList = commonTasks.map(function (task) { return ({\n            id: task.id,\n            name: task.name,\n            url: task.url,\n            courseName: subject.name,\n            learningGoal: step && learningGoals.length > 0 ? moduleName + \" - \\u00F6vergripande\" : moduleName\n        }); });\n        var learningGoalsList = learningGoals.map(function (learningGoal) { return ({\n            name: learningGoal.name,\n            learningTasks: learningGoal.tasks.map(function (task) { return ({\n                id: task.id,\n                name: task.name,\n                url: task.url,\n                courseName: subject.name,\n                learningGoal: learningGoal.name\n            }); })\n        }); });\n        if (step) {\n            commonTasksList.forEach(function (task) { return task.step = step; });\n            learningGoalsList.forEach(function (lg) { return lg.learningTasks.forEach(function (task) { return task.step = step; }); });\n        }\n        return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n            React.createElement(LearningGoalsList, { commonTasks: commonTasksList, learningGoals: learningGoalsList }));\n    };\n    return _LearningTasks;\n}(React.Component));\nexport var LearningTasks = setupIntl(injectIntl(_LearningTasks));\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport cfg from '../../globals/KED.cfg';\nimport { showInfo, L } from \"../../utils/utils\";\nimport { Spinner } from \"../course-builder/sub-components/spinner\";\nimport { parseQueryString, generateQueryString } from \"../../utils/query-string\";\nimport { preserveImpersonationQuery } from '../../access-control/index';\nimport { hiddenCoursesRepo } from '../../repos/hidden-courses-repo';\nvar ListCourses = /** @class */ (function (_super) {\n    tslib_1.__extends(ListCourses, _super);\n    function ListCourses(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            isLoading: true,\n            courses: [],\n            headerOpen: false\n        };\n        _this.updateHiddenCourses = _this.updateHiddenCourses.bind(_this);\n        return _this;\n    }\n    ListCourses.prototype.componentWillMount = function () {\n        hiddenCoursesRepo.subscribe(this.updateHiddenCourses, { fullCourse: true });\n    };\n    ListCourses.prototype.componentWillUnmount = function () {\n        hiddenCoursesRepo.unsubscribe(this.updateHiddenCourses);\n    };\n    ListCourses.prototype.updateHiddenCourses = function (courses) {\n        this.setState({ courses: courses, isLoading: false });\n    };\n    ListCourses.prototype.hideCourse = function (course) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        showInfo(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Sparar...\"], [\"Sparar...\"]))));\n                        return [4 /*yield*/, hiddenCoursesRepo.hideCourse(course)];\n                    case 1:\n                        _a.sent();\n                        showInfo(\"\");\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    ListCourses.prototype.showCourse = function (course) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        showInfo(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Sparar...\"], [\"Sparar...\"]))));\n                        return [4 /*yield*/, hiddenCoursesRepo.showCourse(course)];\n                    case 1:\n                        _a.sent();\n                        showInfo(\"\");\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    ListCourses.prototype.render = function () {\n        var _this = this;\n        if (this.state.isLoading)\n            return React.createElement(Spinner, null);\n        var courses = this.state.courses;\n        var visibleCourses = courses.filter(function (course) { return course.visible; });\n        var hiddenCourses = courses.filter(function (course) { return !course.visible; });\n        var query = parseQueryString(location.search);\n        var viewCourseUrl = cfg.KED_COURSE_VIEWER_URL;\n        return React.createElement(\"div\", { className: \"ked_boxed\" },\n            React.createElement(\"h3\", null, \"Skolans kurser\"),\n            React.createElement(\"div\", { className: \"taskContainer odd-even\" }, visibleCourses.map(function (course) {\n                return React.createElement(\"div\", { className: \"studentCourse\", key: course.id },\n                    React.createElement(\"div\", { className: \"align-horizontal\" },\n                        React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\n                            React.createElement(\"a\", { className: \"hideItem\", onClick: function () { return _this.hideCourse(course); } })),\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\n                            React.createElement(\"a\", { href: preserveImpersonationQuery(viewCourseUrl, { courseId: course.id }) }, course.name))),\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                        React.createElement(\"p\", { className: \"small\" }, course.description)));\n            })),\n            React.createElement(\"div\", { className: \"openClose\" + (this.state.headerOpen ? \" open\" : \"\") },\n                React.createElement(\"div\", { className: \"openHeader\", onClick: function () { return _this.setState({ headerOpen: !_this.state.headerOpen }); } },\n                    React.createElement(\"h5\", null, \"Dolda kurser\")),\n                React.createElement(\"div\", { className: \"openContent\" },\n                    React.createElement(\"div\", { className: \"taskContainer odd-even\" }, hiddenCourses.map(function (course) {\n                        return React.createElement(\"div\", { className: \"studentCourse\", key: course.id },\n                            React.createElement(\"div\", { className: \"align-horizontal\" },\n                                React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\n                                    React.createElement(\"a\", { className: \"showItem\", onClick: function () { return _this.showCourse(course); } })),\n                                React.createElement(\"a\", { href: generateQueryString(tslib_1.__assign({}, query, { courseId: course.id })) }, course.name)),\n                            React.createElement(\"div\", { className: \"horizontalItem top\" },\n                                React.createElement(\"p\", { className: \"small\" }, course.description)));\n                    })))));\n    };\n    return ListCourses;\n}(React.Component));\nexport { ListCourses };\nvar templateObject_1, templateObject_2;\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { hiddenCoursesRepo } from '../../repos/hidden-courses-repo';\nimport { preserveImpersonationQuery } from '../../access-control';\nvar MyCourses = /** @class */ (function (_super) {\n    tslib_1.__extends(MyCourses, _super);\n    function MyCourses(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            courses: [],\n            isLoading: true\n        };\n        _this.updateHiddenCoursesState = _this.updateHiddenCoursesState.bind(_this);\n        return _this;\n    }\n    MyCourses.prototype.componentDidMount = function () {\n        hiddenCoursesRepo.subscribe(this.updateHiddenCoursesState, { fullCourse: false });\n    };\n    MyCourses.prototype.updateHiddenCoursesState = function (courses) {\n        this.setState({ courses: courses, isLoading: false });\n    };\n    MyCourses.prototype.componentWillUnmount = function () {\n        hiddenCoursesRepo.unsubscribe(this.updateHiddenCoursesState);\n    };\n    MyCourses.prototype.getCourseUrl = function (courseId) {\n        return preserveImpersonationQuery(this.props.viewCourseUrl, { courseId: courseId });\n    };\n    MyCourses.prototype.render = function () {\n        var _this = this;\n        var viewCourseUrl = this.props.viewCourseUrl;\n        var _a = this.state, isLoading = _a.isLoading, error = _a.error, courses = _a.courses;\n        var visibleCourses = this.state.courses.filter(function (c) { return c.visible; });\n        return (React.createElement(React.Fragment, null, isLoading ? (React.createElement(\"li\", { className: \"lvl2 header\" },\n            React.createElement(\"a\", null, \"Laddar...\"))) : error ? (React.createElement(\"li\", { className: \"lv12\" },\n            React.createElement(\"a\", null, \"Kunde inte ladda kurser.\"))) : (visibleCourses.map(function (_a) {\n            var name = _a.name, id = _a.id;\n            return (React.createElement(\"li\", { key: id, className: \"lvl2\" },\n                React.createElement(\"a\", { href: _this.getCourseUrl(id) }, name)));\n        }))));\n    };\n    return MyCourses;\n}(React.Component));\nexport { MyCourses };\n","import { env } from \"../../globals/KED.env\";\nimport { db, globalId } from \"../../globals/db\";\nimport { preserveImpersonationQuery } from \"../../access-control\";\nimport * as React from \"react\";\nimport { cfg } from \"../../globals/KED.cfg\";\nimport { Emitter } from 'kedbackend/observable';\nvar STATIC_COURSES = new Emitter([{\n        id: \"https://ks.kunskapsporten.se/steg/matematik.4.47f6b323168938151ef8161c.html\",\n        name: \"Matematik\",\n        type: \"step-course\",\n        tags: [\"static\"],\n    }]).toCollection(function (x) { return x; });\nexport function MySubjectsInner(_a) {\n    var user = env.currentUser;\n    var schoolGrade = user.schoolGrade;\n    var isPrimarySchoolStudent = (\"\" + user.schoolType).toLowerCase() !== \"gymnasium\";\n    var subjectPlannerURL = cfg.KED_SUBJECT_PLANNER_URL;\n    var schoolName = user.school;\n    if (!schoolGrade || !isPrimarySchoolStudent) {\n        return (React.createElement(\"li\", { className: \"lvl2 header\" },\n            React.createElement(\"a\", null, \"Listning endast f\\u00F6r grundskolan\")));\n    }\n    var _b = db.courseInstances\n        .hasEdgesFrom([globalId])\n        //.tags(\"active\") // Workaround: Multiple criterias disables the use of useSP\n        .cacheOptimized()\n        .filter(function (c) { return c.tags.includes(\"active\"); })\n        .map(function (_a) {\n        var id = _a.id, name = _a.name, type = _a.type, tags = _a.tags;\n        return ({\n            id: id,\n            name: name,\n            type: type,\n            tags: tags\n        });\n    })\n        .concat(STATIC_COURSES)\n        .orderBy(\"name\")\n        .groupBy(\"type\")\n        .map(function (arraysByType) { return ({\n        themeCourses: arraysByType[\"theme-course\"],\n        stepCourses: arraysByType[\"step-course\"]\n    }); }).read(), themeCourses = _b.themeCourses, stepCourses = _b.stepCourses;\n    return (React.createElement(React.Fragment, null,\n        React.createElement(\"li\", { className: \"lvl2 header\" },\n            React.createElement(\"a\", null, \"Stegkurser\")),\n        stepCourses.map(function (course) { return (React.createElement(\"li\", { key: course.id, className: \"lvl2\" },\n            React.createElement(\"a\", { href: preserveImpersonationQuery(course.tags.includes(\"static\") ?\n                    course.id :\n                    subjectPlannerURL + \"#/\" + schoolName + \"/courses/\" + course.id, {}) }, course.name))); }),\n        React.createElement(\"li\", { className: \"lvl2 header\" },\n            React.createElement(\"a\", null, \"Temakurser\")),\n        themeCourses\n            .filter(function (_a) {\n            var tags = _a.tags;\n            return tags.includes(\"grade:\" + schoolGrade);\n        })\n            .map(function (course) { return (React.createElement(\"li\", { key: course.id, className: \"lvl2\" },\n            React.createElement(\"a\", { href: preserveImpersonationQuery(course.tags.includes(\"static\") ?\n                    course.id :\n                    subjectPlannerURL + \"#/\" + schoolName + \"/courses/\" + course.id, {}) }, course.name))); })));\n}\n","import * as React from 'react';\nimport { EllipsisLoader } from '../course-builder/sub-components/ellipsis-loader';\nimport { Observe } from '../utility-components/observe';\nimport { MySubjectsInner } from './my-subjects-inner';\nexport function MySubjects(_a) {\n    var viewCourseUrl = _a.viewCourseUrl;\n    return (React.createElement(Observe, { fallback: React.createElement(EllipsisLoader, null) },\n        React.createElement(MySubjectsInner, { viewCourseUrl: viewCourseUrl })));\n}\n","import * as tslib_1 from \"tslib\";\nimport env from '../../globals/KED.env';\nimport React from 'react';\nimport { compareProps } from '../../utils/utils';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport tutorEnv from '../../globals/KED.tutorEnv';\nimport { requestTutoredTokens } from '../../utils/request-tutored-tokens';\nvar TutorsSelect = /** @class */ (function (_super) {\n    tslib_1.__extends(TutorsSelect, _super);\n    function TutorsSelect(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            isLoading: true,\n            students: []\n        };\n        return _this;\n    }\n    TutorsSelect.prototype.componentDidMount = function () {\n        this.load();\n    };\n    TutorsSelect.prototype.load = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var edsStudents, students, error_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 3, 5, 6]);\n                        return [4 /*yield*/, env.edsClient.getTeacherTutorStudents()];\n                    case 1:\n                        edsStudents = _a.sent();\n                        edsStudents.sort(compareProps([\"lastName\", \"firstName\"]));\n                        students = edsStudents.length > 0 ?\n                            edsStudents.map(function (_a) {\n                                var email = _a.email, firstName = _a.firstName, lastName = _a.lastName;\n                                return ({\n                                    mail: email,\n                                    displayName: firstName + \" \" + lastName\n                                });\n                            }) :\n                            [env.currentUser];\n                        return [4 /*yield*/, this.setState({ students: students })];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 3:\n                        error_1 = _a.sent();\n                        console.error(\"Could not list tutor students\", error_1);\n                        return [4 /*yield*/, this.setState({ students: [env.currentUser] })];\n                    case 4:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 5:\n                        this.setState({ isLoading: false });\n                        return [7 /*endfinally*/];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    TutorsSelect.prototype.onSelectUser = function (email) {\n        var choosenStudent = this.state.students.filter(function (s) { return s.mail === email; })[0];\n        var user = tslib_1.__assign({}, choosenStudent, { roles: [\"USER\"] });\n        tutorEnv.setNewEnv(user, function () { return requestTutoredTokens(email, email); });\n    };\n    TutorsSelect.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, isLoading = _a.isLoading, students = _a.students;\n        if (isLoading)\n            return React.createElement(Spinner, null);\n        return React.createElement(\"div\", { className: \"tutors-select\" },\n            React.createElement(\"select\", { onChange: function (ev) { return ev.target.value && _this.onSelectUser(ev.target.value); } },\n                React.createElement(\"option\", { value: \"\" }, \"V\\u00E4lj elev\"),\n                students.map(function (student) {\n                    return React.createElement(\"option\", { key: student.mail, value: student.mail },\n                        student.displayName,\n                        \" (\",\n                        student.mail,\n                        \")\");\n                })));\n    };\n    return TutorsSelect;\n}(React.Component));\nexport { TutorsSelect };\n","import * as React from 'react';\nexport var LanguageContext = React.createContext({ intl: null });\n","import * as tslib_1 from \"tslib\";\nimport { IntlProvider, addLocaleData } from 'react-intl';\nimport locale_en from 'react-intl/locale-data/en';\nimport locale_sv from 'react-intl/locale-data/sv';\nimport messages_sv from \"../../translations/sv.json\";\nimport messages_en from \"../../translations/en.json\";\nimport * as React from 'react';\nimport cfg from '../../globals/KED.cfg';\nimport moment from 'moment';\nexport var setupIntl = function (Component) {\n    return /** @class */ (function (_super) {\n        tslib_1.__extends(_SetupLanguageIntl, _super);\n        function _SetupLanguageIntl(props) {\n            var _this = _super.call(this, props) || this;\n            addLocaleData(tslib_1.__spread(locale_en, locale_sv));\n            _this.messages = {\n                'sv': messages_sv,\n                'en': messages_en\n            };\n            moment().locale(cfg.KED_LOCALE);\n            return _this;\n        }\n        _SetupLanguageIntl.prototype.render = function () {\n            return React.createElement(IntlProvider, { locale: cfg.KED_LOCALE, messages: this.messages[cfg.KED_LOCALE] },\n                React.createElement(Component, tslib_1.__assign({}, this.props)));\n        };\n        return _SetupLanguageIntl;\n    }(React.Component));\n};\n","import * as tslib_1 from \"tslib\";\nimport React from 'react';\nexport var AlignHorizontal = function (_a) {\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"align-horizontal\"]).join(' ') }, children));\n};\n","import React from 'react';\nexport var UICheckbox = function (_a) {\n    var state = _a.state, label = _a.label, onChange = _a.onChange;\n    return React.createElement(\"label\", { className: 'ui-checkbox' },\n        label,\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\n        React.createElement(\"span\", { className: \"custom-element\" }));\n};\nexport var UIAddbox = function (_a) {\n    var state = _a.state, label = _a.label, _b = _a.onChange, onChange = _b === void 0 ? function () { return null; } : _b;\n    return React.createElement(\"label\", { className: 'ui-addbox' },\n        label,\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\n        React.createElement(\"span\", { className: \"custom-element\" }));\n};\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nvar ContentEditableField = /** @class */ (function (_super) {\n    tslib_1.__extends(ContentEditableField, _super);\n    function ContentEditableField(props) {\n        var _this = _super.call(this, props) || this;\n        _this.myself = React.createRef();\n        _this.state = {\n            text: props.text || ''\n        };\n        return _this;\n    }\n    ContentEditableField.prototype.render = function () {\n        var _a = this.props, tag = _a.tag, text = _a.text, readOnly = _a.readOnly;\n        var TagType = tag;\n        return React.createElement(TagType, { contentEditable: !readOnly, \"data-placeholder\": this.props.placeholder, ref: this.myself, className: this.props.className, onChange: this.onChange.bind(this), onKeyDown: this.onKeyDown.bind(this), onKeyUp: this.onKeyUp.bind(this), onBlur: this.onBlur.bind(this), onPaste: this.onPaste.bind(this), dangerouslySetInnerHTML: { __html: text } });\n    };\n    ContentEditableField.prototype.onChange = function (e) {\n        this.setState({ text: this.myself.current.innerText });\n    };\n    /**\n     * Take action depending on key-event\n     * @param e event from field\n     *\n     * If allowNavigation then listen to arrow-keys\n     * Limits to maxChars\n     */\n    ContentEditableField.prototype.onKeyDown = function (e) {\n        var text = this.myself.current.innerText;\n        if (e.key === 'Escape') {\n            this.myself.current.innerText = this.props.text || \"\";\n            this.myself.current.blur();\n            e.stopPropagation();\n        }\n        else if (e.key === 'Enter') {\n            e.preventDefault();\n            this.navigate(text, 'down');\n        }\n        else if (e.key === 'Tab') {\n            this.propagateOnChange(text);\n        }\n        else if (text.length >= this.props.maxChars && (/^[\\d\\w\\s]$/.test(e.key) && !(e.metaKey || e.ctrlKey))) {\n            e.preventDefault();\n        }\n        if (this.props.allowNavigation === true) {\n            var navDir = e.key.startsWith('Arrow') ? e.key.replace('Arrow', '').toLowerCase() : false;\n            var caret = document.getSelection().getRangeAt(0).endOffset; // only works for plaintext\n            if (navDir && text.length == 0) {\n                this.navigate(text, navDir);\n            }\n            else if (navDir && (navDir == 'up' || navDir == 'down')) {\n                this.navigate(text, navDir);\n            }\n            else if (navDir && ((navDir == 'left' && caret == 0) ||\n                (navDir == 'right' && caret == text.length))) {\n                this.navigate(text, navDir);\n            }\n        }\n    };\n    /**\n     *\n     * @param e event from field\n     * Solely used to hande validations-issues\n     */\n    ContentEditableField.prototype.onKeyUp = function (e) {\n        var text = this.myself.current.innerText;\n        if (this.props.validateValue !== undefined && !this.props.validateValue.test(text)) {\n            this.myself.current.innerText = this.props.text || \"\";\n            this.myself.current.blur();\n            e.preventDefault();\n        }\n    };\n    /**\n     * Update value and pass to parents navigate-funciton\n     * @param text\n     * @param direction\n     */\n    ContentEditableField.prototype.navigate = function (text, direction) {\n        // first update cell\n        this.propagateOnChange(text);\n        this.setState({ text: text });\n        // then navigate away\n        this.props.onNavigate(direction);\n    };\n    /**\n     * Make sure pasted text is pure text\n     * @param e the paset event\n     */\n    ContentEditableField.prototype.onPaste = function (e) {\n        e.preventDefault();\n        var text = (e.clipboardData && e.clipboardData.getData) ? e.clipboardData.getData(\"text/plain\") : '';\n        document.execCommand(\"insertHTML\", false, text);\n    };\n    /**\n     * Update value on exit from field\n     * @param e\n     */\n    ContentEditableField.prototype.onBlur = function (e) {\n        var text = this.myself.current.innerText;\n        this.propagateOnChange(text);\n        this.setState({ text: text });\n    };\n    /**\n     * Only update value if it has changed\n     * @param newValue\n     */\n    ContentEditableField.prototype.propagateOnChange = function (newValue) {\n        if (this.propagatedOnChange != newValue) {\n            this.propagatedOnChange = newValue;\n            this.props.onChange(newValue);\n        }\n    };\n    return ContentEditableField;\n}(React.PureComponent));\nexport { ContentEditableField };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { RemoveItem } from '../course-builder/sub-components/remove-item';\nimport { findDOMNode } from 'react-dom';\nimport $ from 'jquery';\nvar Dialogs = /** @class */ (function (_super) {\n    tslib_1.__extends(Dialogs, _super);\n    function Dialogs(props) {\n        return _super.call(this, props) || this;\n    }\n    Dialogs.prototype.componentDidUpdate = function (prevProps) {\n        if (this.lastDiv !== null && prevProps.dialogs.length > this.props.dialogs.length) {\n            // A dialog was closed. Now focus the last dialog:\n            $(findDOMNode(this.lastDiv)).find(':input').first().focus();\n        }\n    };\n    Dialogs.prototype.render = function () {\n        var _this = this;\n        this.lastDiv = null;\n        var _a = this.props, dialogs = _a.dialogs, popDialog = _a.popDialog;\n        $('body').attr('aria-disabled', dialogs.length > 0);\n        $('body').css('overflow', dialogs.length > 0 ? 'hidden' : 'auto');\n        return dialogs.length > 0 && React.createElement(\"div\", null, dialogs.map(function (dialog, idx) {\n            var div;\n            function onKeyPress(ev) {\n                if (ev.which === 13 && (!ev.target || ev.target.tagName !== 'TEXTAREA')) {\n                    $(findDOMNode(div)).find('.btn-default').click();\n                }\n                ev.stopPropagation();\n            }\n            function onKeyDown(ev) {\n                if (ev.which === 27) { // Escape\n                    popDialog();\n                    ev.stopPropagation();\n                    return;\n                }\n                if (ev.which === 83 && (ev.ctrlKey || ev.metaKey)) { // CTRL-S\n                    var domNode = findDOMNode(div);\n                    ev.preventDefault();\n                    var defaultButton = $(domNode).find('.btn-default');\n                    defaultButton.click();\n                    ev.stopPropagation();\n                }\n            }\n            return React.createElement(\"div\", { key: idx },\n                React.createElement(\"div\", { className: \"darken\" }),\n                React.createElement(\"div\", { className: \"modal-page-wrap\" },\n                    React.createElement(\"div\", { className: \"modal-page\", ref: function (elem) {\n                            div = elem;\n                            if (idx === dialogs.length - 1)\n                                _this.lastDiv = elem;\n                        }, tabIndex: 0, \"aria-disabled\": idx < dialogs.length - 1, onKeyPress: onKeyPress, onKeyDown: onKeyDown },\n                        dialog,\n                        React.createElement(RemoveItem, { onClick: popDialog }),\n                        React.createElement(\"div\", { className: \"stopFloats\" }))));\n        }));\n    };\n    return Dialogs;\n}(React.Component));\nexport { Dialogs };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { FormField } from './form-field';\nvar TextInput = /** @class */ (function (_super) {\n    tslib_1.__extends(TextInput, _super);\n    function TextInput(props) {\n        return _super.call(this, props) || this;\n    }\n    TextInput.prototype.componentDidMount = function () {\n        var _this = this;\n        if (this.props.autoSelect) {\n            setTimeout(function () {\n                try {\n                    _this.input.select();\n                    _this.input.focus();\n                }\n                catch (e) { }\n            }, 50);\n        }\n    };\n    TextInput.prototype.render = function () {\n        var _this = this;\n        return (React.createElement(FormField, { label: this.props.label },\n            React.createElement(\"div\", null,\n                React.createElement(\"input\", { type: \"text\", autoFocus: this.props.autoFocus, id: this.props.id, size: this.props.size || 35, value: this.props.value, onChange: this.props.onChange && (function (ev) { return _this.props.onChange(ev.target.value); }), disabled: this.props.disabled, placeholder: this.props.placeholder, ref: function (elem) { return _this.input = elem; } }),\n                this.props.additionalJsx)));\n    };\n    return TextInput;\n}(React.Component));\nexport { TextInput };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { FormField } from './form-field';\nvar TextAreaFormField = /** @class */ (function (_super) {\n    tslib_1.__extends(TextAreaFormField, _super);\n    function TextAreaFormField(props) {\n        return _super.call(this, props) || this;\n    }\n    TextAreaFormField.prototype.render = function () {\n        var _this = this;\n        return (React.createElement(FormField, { label: this.props.label, id: this.props.id },\n            React.createElement(\"div\", { className: \"align-horizontal\" },\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\n                    React.createElement(\"textarea\", { autoFocus: this.props.autoFocus, id: this.props.id, cols: 35, rows: this.props.rows || 5, value: this.props.value, onChange: function (ev) { return _this.props.onChange(ev.target.value); }, placeholder: this.props.placeholder })),\n                !!this.props.children && React.createElement(\"div\", { className: \"horizontalItem\" }, this.props.children))));\n    };\n    return TextAreaFormField;\n}(React.Component));\nexport { TextAreaFormField };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nfunction findId(node) {\n    var recucheck = new Set();\n    return (function findId(node) {\n        if (typeof node === 'string')\n            return null;\n        if (recucheck.has(node)) {\n            return;\n        }\n        recucheck.add(node);\n        if (node.props) {\n            if (node.props.id)\n                return node.props.id;\n            if (node.props.children) {\n                return findId(node.props.children);\n            }\n            return;\n        }\n        if (node.length) {\n            for (var i = 0; i < node.length; ++i) {\n                var child = node[i];\n                if (child) {\n                    var childId = findId(child);\n                    if (childId)\n                        return childId;\n                    //console.log(child);\n                }\n            }\n        }\n    })(node);\n}\nvar FormField = /** @class */ (function (_super) {\n    tslib_1.__extends(FormField, _super);\n    function FormField(props) {\n        return _super.call(this, props) || this;\n    }\n    FormField.prototype.render = function () {\n        return React.createElement(React.Fragment, null,\n            React.createElement(\"label\", { className: \"kclabel\", htmlFor: this.props.id || findId(this.props.children) }, this.props.label),\n            this.props.children);\n    };\n    return FormField;\n}(React.Component));\nexport { FormField };\n","import * as tslib_1 from \"tslib\";\nimport React from 'react';\nexport var HorizontalItem = function (_a) {\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"horizontalItem\"]).join(' ') }, children));\n};\n","import * as tslib_1 from \"tslib\";\nimport { FiberContext } from \"kedbackend/observable\";\nimport React, { Suspense } from 'react';\nimport { L } from '../../utils/utils';\nvar FiberContextReact = React.createContext(null);\nvar ReactSharedInternals = Object.keys(React).filter(function (key) { return key.includes(\"_INTERNALS\"); }).map(function (k) { return React[k]; })[0];\nvar ReactCurrentDispatcher = ReactSharedInternals.ReactCurrentDispatcher;\nFiberContext.addProvider(function () {\n    // Here we actuall do useContext(FiberContext) but without logging to internal debug logs\n    // Normally, react hooks are sensitive in which order they are called (useState(), etc)\n    // but useContext() is not sensitive about that at all.\n    // Still, the debug version of react will log calls to useHook() and throw if a render\n    // doesn't use the same number of hooks every time. This check should not apply\n    // to useHook() since it is not sensitive to the order in which it was called.\n    // And we need to be able to call it from within contitional expressions / statements,\n    // so we must bypass this debug logging here by accessing readContext() directly.\n    return ReactCurrentDispatcher.current && ReactCurrentDispatcher.current.readContext(FiberContextReact);\n});\nvar Observe = /** @class */ (function (_super) {\n    tslib_1.__extends(Observe, _super);\n    function Observe(props) {\n        var _this = _super.call(this, props) || this;\n        _this.subscriptions = [];\n        _this.outerSubscription = {\n            unsubscribe: function () {\n                _this.subscriptions.forEach(function (s) { return s.unsubscribe(); });\n                _this.subscriptions = [];\n            }\n        };\n        _this.observer = function (value, error, subscription) {\n            if (error) {\n                _this.setState({ error: error });\n            }\n            else {\n                _this.setState(function (_a) {\n                    var counter = _a.counter;\n                    return ({ counter: counter + 1, error: error });\n                });\n            }\n        };\n        _this.state = {\n            counter: 0,\n            error: null\n        };\n        return _this;\n    }\n    Observe.prototype.componentDidCatch = function (error, info) {\n        if (!error || !error.name)\n            error = new Error('' + error);\n        this.setState({ error: error, info: info });\n        console.log(error, info);\n    };\n    Observe.prototype.componentWillMount = function () {\n        this.outerSubscription.unsubscribe();\n    };\n    Observe.prototype.render = function () {\n        if (this.state.error) {\n            return this.props.errorFallback || React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde inte ladda inneh\\u00E5llet\"], [\"Kunde inte ladda inneh\\u00E5llet\"]))));\n        }\n        this.outerSubscription.unsubscribe();\n        return React.createElement(Suspense, { fallback: this.props.fallback || null },\n            React.createElement(FiberContextReact.Provider, { value: this }, this.props.children));\n    };\n    return Observe;\n}(React.Component));\nexport { Observe };\nvar templateObject_1;\n","/* REFACTOR: Move this component outside coursebuilder!\n   This is a general-purpose component\n*/\nimport * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { GoalProgress } from '../charts/goal-progress';\nvar OpenCloseBox = /** @class */ (function (_super) {\n    tslib_1.__extends(OpenCloseBox, _super);\n    function OpenCloseBox(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            headerOpen: props.headerOpen || false\n        };\n        return _this;\n    }\n    OpenCloseBox.prototype.componentWillReceiveProps = function (nextProps) {\n        if (nextProps.headerOpen !== this.props.headerOpen) {\n            this.setState({ headerOpen: nextProps.headerOpen });\n        }\n    };\n    OpenCloseBox.prototype.render = function () {\n        var _this = this;\n        var _a = this.props, title = _a.title, className = _a.className, children = _a.children, headerClassName = _a.headerClassName, contentClassName = _a.contentClassName, displayProgress = _a.displayProgress, progressData = _a.progressData, inactivated = _a.inactivated, inactivatedRender = _a.inactivatedRender;\n        var headerOpen = this.state.headerOpen;\n        if (inactivated)\n            return inactivatedRender === 'titleAndChildren' ? React.createElement(React.Fragment, null,\n                React.createElement(React.Fragment, null, title),\n                React.createElement(React.Fragment, null, children)) : React.createElement(React.Fragment, null, children);\n        //var currentProgressData = //progressData();\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\n            React.createElement(\"div\", { className: \"openHeader\" + (headerClassName ? \" \" + headerClassName : \"\"), onClick: function () {\n                    if (_this.props.onOpenClose)\n                        _this.props.onOpenClose(!_this.state.headerOpen);\n                    _this.setState({ headerOpen: !_this.state.headerOpen });\n                } },\n                React.createElement(\"div\", { className: \"openHeaderContainer\" },\n                    React.createElement(\"div\", null, title),\n                    displayProgress && React.createElement(GoalProgress, tslib_1.__assign({}, progressData)))),\n            React.createElement(\"div\", { className: \"openContent\" + (contentClassName ? \" \" + contentClassName : \"\") }, children));\n    };\n    return OpenCloseBox;\n}(React.Component));\nexport { OpenCloseBox };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport currentUserEnv from '../../globals/KED.env';\nimport tutorEnv from '../../globals/KED.tutorEnv';\nvar TutorableComponent = /** @class */ (function (_super) {\n    tslib_1.__extends(TutorableComponent, _super);\n    function TutorableComponent(props) {\n        var _this = _super.call(this, props) || this;\n        _this.onEnvUpdated = _this.onEnvUpdated.bind(_this);\n        _this.state = {\n            env: props.tutored ? null : currentUserEnv\n        };\n        return _this;\n    }\n    TutorableComponent.prototype.componentDidMount = function () {\n        if (this.props.tutored) {\n            tutorEnv.subscribe(this.onEnvUpdated);\n        }\n    };\n    TutorableComponent.prototype.componentWillUnmount = function () {\n        if (this.props.tutored) {\n            tutorEnv.unsubscribe(this.onEnvUpdated);\n        }\n    };\n    TutorableComponent.prototype.onEnvUpdated = function (env) {\n        this.setState({ env: env });\n    };\n    TutorableComponent.prototype.render = function () {\n        var env = this.state.env;\n        if (!env)\n            return React.createElement(\"div\", null);\n        if (!env.kedBackendClient) {\n            return React.createElement(\"div\", null, \"Laddar...\");\n        }\n        //const {currentUser, edsClient, kedBackendClient, kgTermPlannerRepo} = env;\n        //const {tutored} = this.props;\n        return this.props.createComponent(env);\n    };\n    return TutorableComponent;\n}(React.Component));\nexport { TutorableComponent };\n","export function insertElement(element) {\n    var sel, range;\n    if (window.getSelection && (sel = window.getSelection()).rangeCount) {\n        range = sel.getRangeAt(0);\n        range.collapse(true);\n        range.insertNode(element);\n        // Move the caret immediately after the inserted span\n        range.setStartAfter(element);\n        range.collapse(true);\n        sel.removeAllRanges();\n        sel.addRange(range);\n    }\n}\n","import { insertElement } from './insert-element';\nexport function insertImage(promptMsg, editor) {\n    var url = window.prompt(promptMsg);\n    if (url) {\n        var img = document.createElement(\"img\");\n        img.src = url;\n        img.tabIndex = 1;\n        img.onblur = editor.onBlur;\n        insertElement(img);\n        editor.triggerOnChange();\n    }\n}\n","import * as tslib_1 from \"tslib\";\nimport React, { useState } from \"react\";\nimport { TextInput } from \"../../form-field-text-input\";\nimport { L } from \"../../../../utils/utils\";\nimport { cfg } from \"../../../../globals/KED.cfg\";\nimport { FormattedMessage } from \"react-intl\";\nimport { AlignHorizontal } from \"../../align-horizontal\";\nimport { HorizontalItem } from \"../../horizontal-item\";\nexport function LinkDialog(_a) {\n    var onSubmit = _a.onSubmit, onDelete = _a.onDelete, onCancel = _a.onCancel, props = tslib_1.__rest(_a, [\"onSubmit\", \"onDelete\", \"onCancel\"]);\n    var _b = tslib_1.__read(useState(props.url), 2), url = _b[0], setUrl = _b[1];\n    var _c = tslib_1.__read(useState(\"_blank\"), 2), target = _c[0], setTarget = _c[1]; //useState(props.target);\n    var _d = tslib_1.__read(useState(props.text), 2), text = _d[0], setText = _d[1];\n    return (React.createElement(React.Fragment, null,\n        React.createElement(\"div\", null,\n            React.createElement(\"h3\", null, props.url ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Redigera l\\u00E4nk\"], [\"Redigera l\\u00E4nk\"]))) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Skapa l\\u00E4nk\"], [\"Skapa l\\u00E4nk\"])))),\n            React.createElement(\"span\", { style: { fontSize: \"8pt\" } },\n                \"F\\u00F6lj l\\u00E4nken: \",\n                React.createElement(\"a\", { href: url, style: { marginLeft: \"12px\" }, target: \"_blank\" }, url)),\n            React.createElement(TextInput, { label: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"URL\"], [\"URL\"]))), id: \"LinkDialog:URL\", placeholder: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Ange URL\"], [\"Ange URL\"]))), value: url, autoFocus: !url, autoSelect: !url, onChange: function (url) { return setUrl(url); } }),\n            React.createElement(TextInput, { label: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Text\"], [\"Text\"]))), id: \"LinkDialog:Text\", placeholder: L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Ange l\\u00E4nktext\"], [\"Ange l\\u00E4nktext\"]))), value: text, autoFocus: !!url, autoSelect: !!url, onChange: function (text) { return setText(text); } })),\n        React.createElement(AlignHorizontal, null,\n            React.createElement(HorizontalItem, null,\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () {\n                        return url\n                            ? onSubmit({ url: url, target: target, text: text })\n                            : props.url\n                                ? onDelete()\n                                : onCancel();\n                    } },\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))),\n            React.createElement(HorizontalItem, null,\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-warning\", onClick: function () { return onDelete(); } },\n                    React.createElement(FormattedMessage, { id: \"url.remove\", defaultMessage: \"Ta bort l\\u00E4nken\" }))))));\n}\n// TODO: Move to some logic in common lib so that migration scripts and washHtml can also use this logic:\nfunction urlDefaultTarget(url) {\n    return url.startsWith(location.protocol + \"//\" + location.host)\n        ? null\n        : url.startsWith(\"/content\")\n            ? \"_blank\"\n            : url.startsWith(cfg.KED_WORDBANKS_URL)\n                ? \"_blank\"\n                : url.startsWith(\"/\")\n                    ? null\n                    : \"_blank\";\n}\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\n","import React from \"react\";\nimport { saveSelection, restoreSelection } from \"../restore-selection\";\nimport { LinkDialog } from \"./link-dialog\";\nexport function openLinkDialog(ev, _a) {\n    var openDialog = _a.openDialog, closeDialog = _a.closeDialog;\n    var currentSelection = saveSelection();\n    var selection = document.getSelection();\n    var currentText = selection.toString();\n    var node = selection.anchorNode;\n    var currentHTML = node[\"innerHTML\"];\n    var url = \"\";\n    var target = null;\n    if (node.nodeType === 1) {\n        var element = node;\n        if (element.tagName === \"A\") {\n            url = element.getAttribute(\"href\");\n            target = element.getAttribute(\"target\");\n        }\n    }\n    openDialog(React.createElement(LinkDialog, { url: url, text: currentText, target: target, onSubmit: function (_a) {\n            var url = _a.url, target = _a.target, text = _a.text;\n            closeDialog();\n            restoreSelection(currentSelection);\n            var elem = document.createElement(\"a\");\n            elem.href = url;\n            if (target)\n                elem.target = target;\n            elem.appendChild(document.createTextNode(text));\n            document.execCommand(\"insertHTML\", false, elem.outerHTML);\n        }, onDelete: function () {\n            closeDialog();\n            restoreSelection(currentSelection);\n            document.execCommand(\"delete\");\n            document.execCommand(\"insertHTML\", false, currentHTML);\n        }, onCancel: function () {\n            closeDialog();\n            restoreSelection(currentSelection);\n        } }));\n}\n","import exec from './exec';\nimport { openLinkDialog } from './action-helpers/open-link-dialog';\nimport { insertImage } from './action-helpers/insert-image';\nexport default {\n    bold: {\n        icon: '<b>F</b>',\n        title: 'Fetstil',\n        result: function () { return exec('bold'); }\n    },\n    italic: {\n        icon: '<i>K</i>',\n        title: 'Kursiv',\n        result: function () { return exec('italic'); }\n    },\n    underline: {\n        icon: '<u>U</u>',\n        title: 'Understruken',\n        result: function () { return exec('underline'); }\n    },\n    strikethrough: {\n        icon: '<strike>S</strike>',\n        title: 'Struken',\n        result: function () { return exec('strikeThrough'); }\n    },\n    heading1: {\n        icon: '<b>H<sub>1</sub></b>',\n        title: 'Rubrik 1',\n        result: function () { return exec('formatBlock', '<H1>'); }\n    },\n    heading2: {\n        icon: '<b>H<sub>2</sub></b>',\n        title: 'Rubrik 2',\n        result: function () { return exec('formatBlock', '<H2>'); }\n    },\n    heading3: {\n        icon: '<b>H<sub>3</sub></b>',\n        title: 'Rubrik 3',\n        result: function () { return exec('formatBlock', '<H3>'); }\n    },\n    paragraph: {\n        icon: '&#182;',\n        title: 'Paragraf',\n        result: function () { return exec('formatBlock', '<P>'); }\n    },\n    quote: {\n        icon: '&#8220; &#8221;',\n        title: 'Citat',\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\n    },\n    olist: {\n        icon: '<i class=\"fa fa-list-ol\" aria-hidden=\"true\"></i>',\n        title: 'Ordnad lista',\n        result: function () { return exec('insertOrderedList'); }\n    },\n    ulist: {\n        icon: '<i class=\"fa fa-list\" aria-hidden=\"true\"></i>',\n        title: 'Punktlista',\n        result: function () { return exec('insertUnorderedList'); }\n    },\n    outdent: {\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\n        title: 'Minska indrag',\n        result: function () { return exec(\"outdent\"); }\n    },\n    indent: {\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\n        title: 'Öka indrag',\n        result: function () { return exec(\"indent\"); },\n    },\n    code: {\n        icon: '&lt;/&gt;',\n        title: 'Programkod',\n        result: function () { return exec('formatBlock', '<PRE>'); }\n    },\n    line: {\n        icon: '&#8213;',\n        title: 'Vågrät linje',\n        result: function () { return exec('insertHorizontalRule'); }\n    },\n    link: {\n        icon: '<i class=\"fa fa-link\" aria-hidden=\"true\"></i>',\n        title: 'Infoga länk',\n        result: openLinkDialog\n    },\n    image: {\n        icon: '<i class=\"fa fa-picture-o\" aria-hidden=\"true\"></i>',\n        title: 'Infoga bild',\n        promptMsg: 'Ange bildens URL',\n        result: function (ev, editor) {\n            insertImage(this.promptMsg, editor);\n        }\n    }\n};\n","import exec from './exec';\nimport { openLinkDialog } from './action-helpers/open-link-dialog';\nimport { insertImage } from './action-helpers/insert-image';\nexport default {\n    bold: {\n        icon: '<b>B</b>',\n        title: 'Bold',\n        result: function () { return exec('bold'); }\n    },\n    italic: {\n        icon: '<i>I</i>',\n        title: 'Italic',\n        result: function () { return exec('italic'); }\n    },\n    underline: {\n        icon: '<u>U</u>',\n        title: 'Underline',\n        result: function () { return exec('underline'); }\n    },\n    strikethrough: {\n        icon: '<strike>S</strike>',\n        title: 'Strike-through',\n        result: function () { return exec('strikeThrough'); }\n    },\n    heading1: {\n        icon: '<b>H<sub>1</sub></b>',\n        title: 'Heading 1',\n        result: function () { return exec('formatBlock', '<H1>'); }\n    },\n    heading2: {\n        icon: '<b>H<sub>2</sub></b>',\n        title: 'Heading 2',\n        result: function () { return exec('formatBlock', '<H2>'); }\n    },\n    heading3: {\n        icon: '<b>H<sub>3</sub></b>',\n        title: 'Heading 3',\n        result: function () { return exec('formatBlock', '<H3>'); }\n    },\n    paragraph: {\n        icon: '&#182;',\n        title: 'Paragraph',\n        result: function () { return exec('formatBlock', '<P>'); }\n    },\n    quote: {\n        icon: '&#8220; &#8221;',\n        title: 'Quote',\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\n    },\n    olist: {\n        icon: '&#35;',\n        title: 'Ordered List',\n        result: function () { return exec('insertOrderedList'); }\n    },\n    ulist: {\n        icon: '&#8226;',\n        title: 'Unordered List',\n        result: function () { return exec('insertUnorderedList'); }\n    },\n    outdent: {\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\n        title: 'Outdent',\n        result: function () { return exec(\"outdent\"); }\n    },\n    indent: {\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\n        title: 'Indent',\n        result: function () { return exec(\"indent\"); },\n    },\n    code: {\n        icon: '&lt;/&gt;',\n        title: 'Code',\n        result: function () { return exec('formatBlock', '<PRE>'); }\n    },\n    line: {\n        icon: '&#8213;',\n        title: 'Horizontal Line',\n        result: function () { return exec('insertHorizontalRule'); }\n    },\n    link: {\n        icon: '&#128279;',\n        title: 'Link',\n        result: openLinkDialog\n    },\n    image: {\n        icon: '&#128247;',\n        title: 'Image',\n        promptMsg: 'Enter the URL of the image',\n        result: function (ev, editor) {\n            insertImage(this.promptMsg, editor);\n        }\n    }\n};\n","export default (function (command, value) {\n    if (value === void 0) { value = null; }\n    document.execCommand(command, false, value);\n});\n","export function patchElement(element) {\n    var modified = false;\n    if (element.tagName === \"A\") {\n        var href = element.getAttribute(\"href\");\n        var target = element.getAttribute(\"target\");\n        if (href) {\n            if (href.startsWith(\"javascript:\")) {\n                // Fix \"javascript:window.open('...')\" URLS\n                var url = href;\n                var windowOpen = \"window.open('\";\n                var pWindowOpen = url.indexOf(windowOpen);\n                if (pWindowOpen >= 0) {\n                    var urlEnd = url.substr(pWindowOpen + windowOpen.length);\n                    var pUrlEnd = urlEnd.indexOf(\"'\");\n                    if (pUrlEnd >= 0) {\n                        var newUrl = urlEnd.substr(0, pUrlEnd);\n                        element.setAttribute(\"href\", newUrl);\n                        element.setAttribute(\"target\", \"_blank\"); // The reason they use JS links is for opening in new tab\n                        modified = true;\n                    }\n                }\n            }\n            else if (href.startsWith(\"https://\") || href.startsWith(\"http://\")) {\n                try {\n                    var url = new URL(href);\n                    // Fix digilär URLs:\n                    if (url.host === \"xn--digilr-fua.se\") {\n                        if (url.search[0] === '?') {\n                            var pSecondQ = url.search.indexOf('?', 1);\n                            if (pSecondQ > 0) {\n                                url.search = url.search.substr(0, pSecondQ) + \"&\" + url.search.substr(pSecondQ + 1);\n                                element.setAttribute(\"href\", url.href);\n                                modified = true;\n                            }\n                        }\n                    }\n                    // Fix so that external URLS are opened in separate tabs\n                    if (location.hostname !== 'localhost') {\n                        if (url.host !== location.host) {\n                            if (!element.getAttribute(\"target\")) {\n                                element.setAttribute(\"target\", \"_blank\");\n                                modified = true;\n                            }\n                        }\n                    }\n                }\n                catch (error) {\n                    element.removeAttribute(\"a\");\n                    modified = true;\n                }\n            }\n            else if (href.startsWith(\"/content?\")) { // Should maybe use KED.cfg.KED_RESOURCES_URL instead of hardcoding \"/content?\".\n                if (!element.getAttribute(\"target\")) {\n                    element.setAttribute(\"target\", \"_blank\");\n                    modified = true;\n                }\n            }\n            else if (href.startsWith(\"ks.kunskapsporten.se/content?\")) {\n                // Rewriting the effect of earlier bug. This if-statement can be removed some time or\n                // replaced by a script  to make sure there are no such links there anymore\n                var pSlash = href.indexOf('/');\n                element.setAttribute(\"href\", href.substr(pSlash));\n                element.setAttribute(\"target\", \"_blank\");\n                modified = true;\n            }\n        }\n    }\n    return modified;\n}\n","export default function imageEditActions(cb) {\n    return [{\n            name: 'float-left',\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-right\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; left:-4px;top:0; transform: scale(0.5); transform-origin: left top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\n            title: 'Låt bilden flyta vänster om text',\n            result: function () { return cb('float-left'); }\n        }, {\n            name: 'float-right',\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-left\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; right:-4px;top:0; transform: scale(0.5); transform-origin: right top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\n            title: 'Låt bilden flyta höger om text',\n            result: function () { return cb('float-right'); }\n        }, {\n            name: 'unfloat',\n            icon: \"<div style=\\\"position:relative;\\\" aria-hidden=\\\"true\\\">\\n      <div style=\\\"position:absolute;top:0;left:0\\\">&#8254;</div>\\n      <div style=\\\"position:absolute;top:0:left:0;transform: scale(0.5); transform-origin: left bottom\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n      <div style=\\\"position:absolute;top:0;left:0\\\">_</div>\\n    </div>\",\n            title: 'Placera bilden på egen rad',\n            result: function () { return cb('unfloat'); }\n        }];\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport exec from './exec';\nimport { washHtml } from './wash-html';\nimport imageEditActions from './image-edit-actions';\nimport actions from './actions';\nimport { selectAllText } from './restore-selection';\nimport { DialogsContext } from '../../course-builder-ks/common/dialog-context';\nvar classes = {\n    actionbar: 'wysiwyg-actionbar',\n    button: 'wysiwyg-button',\n    content: 'wysiwyg-content',\n    focusrect: 'wysiwyg-focusrect',\n    focuspoint: 'wysiwyg-focuspoint',\n    readonlyContent: 'wysiwyg-content readonly'\n};\nexport function Wysiwyg(props) {\n    var dialogCtx = React.useContext(DialogsContext);\n    return React.createElement(WysiwygInner, tslib_1.__assign({}, props, { openDialog: dialogCtx && dialogCtx.openDialog, closeDialog: dialogCtx && dialogCtx.closeDialog }));\n}\nvar WysiwygInner = /** @class */ (function (_super) {\n    tslib_1.__extends(WysiwygInner, _super);\n    function WysiwygInner(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = { focusRect: null };\n        _this.onClick = _this.onClick.bind(_this);\n        //this.onFocus = this.onFocus.bind(this);\n        _this.onBlur = _this.onBlur.bind(_this);\n        _this.onMouseDown = _this.onMouseDown.bind(_this);\n        _this.onMouseMove = _this.onMouseMove.bind(_this);\n        _this.onMouseUp = _this.onMouseUp.bind(_this);\n        _this.openDialog = props.openDialog;\n        _this.closeDialog = props.closeDialog;\n        return _this;\n    }\n    Object.defineProperty(WysiwygInner.prototype, \"focusElem\", {\n        get: function () {\n            return this.contentDiv && this.contentDiv.querySelector(\".focusElem\");\n        },\n        enumerable: true,\n        configurable: true\n    });\n    WysiwygInner.prototype.componentDidMount = function () {\n        var _this = this;\n        if (!this.props.readOnly) {\n            //this.contentDiv.onfocus = this.onFocus;\n            this.contentDiv.onblur = this.onBlur;\n            this.contentDiv.onclick = this.onClick;\n            Array.from(this.contentDiv.querySelectorAll(\"img\")).map(function (elem) { return elem; })\n                .forEach(function (elem) {\n                elem.tabIndex = 1; // Need onBlur event to trigger removal of focusRect.\n                // and for onBlur event to occur on img elements, they must explicitely have a tabIndex\n                elem.onblur = _this.onBlur;\n            });\n        }\n        if (this.props.reportNumChars) {\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\n        }\n    };\n    WysiwygInner.prototype.componentDidUpdate = function () {\n        var _this = this;\n        if (!this.props.readOnly) {\n            //this.contentDiv.onfocus = this.onFocus;\n            this.contentDiv.onblur = this.onBlur;\n            this.contentDiv.onclick = this.onClick;\n            Array.from(this.contentDiv.querySelectorAll(\"img\")).map(function (elem) { return elem; })\n                .forEach(function (elem) {\n                elem.tabIndex = 1;\n                //elem.onfocus = this.onFocus; // TODO: Fixthis!\n                elem.onblur = _this.onBlur;\n            });\n            if (this.props.reportNumChars) {\n                this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\n            }\n        }\n    };\n    WysiwygInner.prototype.shouldComponentUpdate = function (nextProps, nextState) {\n        //this.contentDiv.onfocus = this.onFocus;\n        //this.contentDiv.onblur = this.onBlur;\n        return !this.contentDiv ||\n            nextState != this.state ||\n            nextProps.readOnly !== this.props.readOnly ||\n            washHtml(nextProps.html) !== washHtml(this.contentDiv.innerHTML);\n    };\n    WysiwygInner.prototype.triggerOnChangeInternal = function (html) {\n        this.props.onChange && this.props.onChange(washHtml(html));\n    };\n    WysiwygInner.prototype.triggerOnChange = function () {\n        this.triggerOnChangeInternal(this.contentDiv.innerHTML);\n    };\n    WysiwygInner.prototype.onClick = function (ev) {\n        var elem = closest(ev.target, \".editor A,.editor IMG\");\n        if (!elem)\n            return;\n        switch (elem.tagName) {\n            case \"A\":\n                // Re-open the link dialog\n                var linkAction = this.getActionsToUse().filter(function (a) { return a.name === \"link\"; })[0];\n                if (linkAction) {\n                    selectAllText(elem);\n                    linkAction.result(ev, this);\n                }\n                break;\n            case \"IMG\":\n                var contentParent = this.contentDiv.parentElement;\n                var newState = {\n                    focusRect: getRelatativeClientRect(contentParent, elem),\n                };\n                this.setState(newState);\n                // Add the .focusElem class so we can find focusElem\n                // This DOM could be replaced so we cannot store a reference to the\n                // focusElem itself. \n                // Before, we did that but strange bugs occurred when trying to\n                // drag the focusRect corners on a newly inserted image.\n                this.removeAllFocusElemClasses();\n                elem.className = (elem.className || \"\") + \" focusElem\";\n                break;\n        }\n    };\n    WysiwygInner.prototype.onBlur = function (ev) {\n        var focusElem = this.focusElem;\n        if (!focusElem || (ev.target === focusElem && ev.relatedTarget !== this.focusRectDiv) ||\n            ev.target === this.focusRectDiv) {\n            this.removeFocusRect();\n        }\n    };\n    WysiwygInner.prototype.onMouseDown = function (ev) {\n        if ((ev.target.className || \"\").split(' ').indexOf(classes.focuspoint) >= 0) {\n            var corner = this.getRectCorner(ev);\n            this.corner = corner;\n            this.resizeStartX = ev.clientX;\n        }\n    };\n    WysiwygInner.prototype.onMouseMove = function (ev) {\n        var focusElem = this.focusElem;\n        if (this.corner && this.state.focusRect && focusElem) {\n            ev.preventDefault();\n            // TODO: Räkna ut baserat på this.corner hur bildens storlek borde ändras.\n            // Leta upp bilden per ID från this.contentDiv\n            // Sätt DIV:ens style attribut width till ny width.\n            // Om DIV:en redan hade height, sätt ny height med samma aspect ratio som innan,\n            // annars, sätt inte height alls (eller möjligtvis till auto))\n            var focusRect = this.focusRectDiv.getBoundingClientRect();\n            if (focusRect.width < 32)\n                return;\n            //const currentWidth = focusRect.width;\n            //const currentHeight = focusRect.height;\n            //const hasHeightStyle = !this.focusElem.style.height || this.focusElem.style.height === \"auto\";\n            var newWidth = Math.max(32, this.corner.endsWith('l') ?\n                focusRect.width + (this.resizeStartX - ev.clientX) :\n                //focusRect.right - ev.clientX :\n                focusRect.width - (this.resizeStartX - ev.clientX));\n            this.resizeStartX = ev.clientX;\n            //ev.clientX - focusRect.left;\n            var factor = newWidth / focusRect.width;\n            var newHeight = focusRect.height * factor;\n            focusElem.style.width = newWidth + \"px\";\n            focusElem.style.height = newHeight + \"px\";\n            this.setState({\n                focusRect: getRelatativeClientRect(this.contentDiv.parentElement, focusElem)\n            });\n        }\n    };\n    WysiwygInner.prototype.onMouseUp = function (ev) {\n        if (this.corner && this.state.focusRect && this.focusElem) {\n            this.corner = null;\n            this.triggerOnChange();\n        }\n    };\n    WysiwygInner.prototype.getRectCorner = function (ev) {\n        var e_1, _a;\n        try {\n            for (var _b = tslib_1.__values((ev.target.className || '').split(' ')), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var className = _c.value;\n                switch (className) {\n                    case 'fpul':\n                        return 'ul';\n                    case 'fpur':\n                        return 'fpur';\n                    case 'fplr':\n                        return 'lr';\n                    case 'fpll':\n                        return 'll';\n                }\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n        return null;\n    };\n    WysiwygInner.prototype.execImageEditAction = function (cmd) {\n        //console.log(cmd);\n        var focusElem = this.focusElem;\n        if (!focusElem)\n            return;\n        //console.log(\"doing it\");\n        switch (cmd) {\n            case 'float-left':\n                focusElem.style.cssFloat = 'left';\n                break;\n            case 'float-right':\n                focusElem.style.cssFloat = 'right';\n                break;\n            case 'unfloat':\n                focusElem.style.cssFloat = '';\n                break;\n        }\n        this.triggerOnChange();\n        this.setState({ focusRect: getRelatativeClientRect(this.contentDiv.parentElement, focusElem) });\n    };\n    WysiwygInner.prototype.getActionsToUse = function () {\n        var _this = this;\n        var defaultActions = this.props.defaultActions || actions;\n        var actionsToUse = this.props.actions ? this.props.actions.map(function (action) {\n            return typeof action === 'string' ? tslib_1.__assign({ name: action }, defaultActions[action]) :\n                defaultActions[action.name] ? tslib_1.__assign({}, defaultActions[action.name], action) :\n                    action;\n        })\n            : Object.keys(defaultActions).map(function (action) { return (tslib_1.__assign({ name: action }, defaultActions[action])); });\n        if (this.state.focusRect) {\n            actionsToUse = actionsToUse.concat(imageEditActions(function (cmd) { return _this.execImageEditAction(cmd); }));\n        }\n        return actionsToUse;\n    };\n    WysiwygInner.prototype.removeAllFocusElemClasses = function () {\n        this.contentDiv && this.contentDiv.querySelectorAll(\".focusElem\").forEach(function (elem) {\n            elem.className = elem.className.split(' ').filter(function (cn) { return cn !== \"focusElem\"; }).join(' ');\n        });\n    };\n    WysiwygInner.prototype.removeFocusRect = function () {\n        this.removeAllFocusElemClasses();\n        this.setState({ focusRect: null });\n    };\n    WysiwygInner.prototype.render = function () {\n        var _this = this;\n        var actionsToUse = this.getActionsToUse();\n        var focusRect = this.state.focusRect;\n        var _a = this.props, readOnly = _a.readOnly, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\n        return React.createElement(\"div\", { className: this.props.className },\n            !readOnly && React.createElement(\"div\", { className: classes.actionbar }, actionsToUse.map(function (action, idx) {\n                return React.createElement(\"button\", { key: idx, className: classes.button, dangerouslySetInnerHTML: { __html: action.icon }, title: action.title, onMouseDown: function (ev) { action.result(ev, _this); }, onMouseUp: function (ev) { return setTimeout(function () { return _this.contentDiv.focus(); }, 10); } });\n            })),\n            React.createElement(\"div\", { className: readOnly ? classes.readonlyContent : classes.content, style: { position: 'relative', top: 0, left: 0 }, onMouseMove: this.onMouseMove, onMouseDown: this.onMouseDown, onMouseUp: this.onMouseUp },\n                React.createElement(\"div\", { className: \"editor\", ref: function (div) { return _this.contentDiv = div; }, dangerouslySetInnerHTML: { __html: washHtml(this.props.html) }, contentEditable: !readOnly, onPaste: function (ev) {\n                        if (!isNaN(maxChars)) {\n                            var target = ev.target, currentTarget = ev.currentTarget;\n                            //const textBeingOverwritten = (target as any).innerText || \"\";\n                            var editorText = (currentTarget && currentTarget.innerText) || \"\";\n                            var textBeingPasted = ev.clipboardData.getData(\"text/plain\") || \"\";\n                            if (editorText.length + textBeingPasted.length > maxChars) {\n                                ev.preventDefault();\n                            }\n                        }\n                    }, onKeyUp: reportNumChars ? function (ev) {\n                        var innerText = ev.target.innerText;\n                        reportNumChars(innerText ? innerText.length : 0);\n                    } : null, onKeyPress: !isNaN(maxChars) ? function (ev) {\n                        var innerText = ev.target.innerText;\n                        if (innerText && innerText.length >= maxChars) {\n                            ev.preventDefault();\n                        }\n                    } : null, onInput: function (ev) { return _this.triggerOnChangeInternal(ev.target.innerHTML); }, onKeyDown: function (ev) {\n                        if (readOnly)\n                            return;\n                        if (reportNumChars && ev.currentTarget) {\n                            reportNumChars((ev.currentTarget.innerText || \"\").length);\n                        }\n                        //console.log(\"Key: \" + ev.which);\n                        if (ev.which >= 35 && ev.which <= 40) { // home/end/up/down/left/right\n                            ev.stopPropagation(); // Prevent entire page from scrolling??\n                        }\n                        if (ev.which === 9) {\n                            ev.preventDefault(); // TAB\n                            if (ev.shiftKey) {\n                                exec(\"outdent\");\n                            }\n                            else {\n                                exec(\"indent\");\n                            }\n                        }\n                        var focusElem = _this.focusElem;\n                        if ((ev.keyCode === 8 || ev.keyCode === 46) && // Delete or Back buttons\n                            focusElem && _this.state.focusRect) {\n                            if (focusElem && focusElem.parentElement) {\n                                focusElem.parentElement.removeChild(focusElem); // Remove marked image\n                            }\n                            _this.removeFocusRect();\n                            _this.triggerOnChange();\n                        }\n                    } }),\n                focusRect && React.createElement(\"div\", { ref: function (div) { return _this.focusRectDiv = div; }, className: classes.focusrect, tabIndex: 1, onBlur: function (ev) { return _this.removeFocusRect(); }, style: {\n                        outline: 0,\n                        position: 'absolute',\n                        top: this.state.focusRect.top,\n                        left: this.state.focusRect.left,\n                        width: this.state.focusRect.width,\n                        height: this.state.focusRect.height\n                    } },\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpul\", style: { position: 'absolute', top: 0, left: 0 } }),\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpur\", style: { position: 'absolute', top: 0, right: 0 } }),\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fplr\", style: { position: 'absolute', bottom: 0, right: 0 } }),\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpll\", style: { position: 'absolute', bottom: 0, left: 0 } }))));\n    };\n    return WysiwygInner;\n}(React.Component));\nfunction getRelatativeClientRect(parent, child) {\n    var parentRect = parent.getBoundingClientRect();\n    var childRect = child.getBoundingClientRect();\n    return {\n        top: childRect.top - parentRect.top + parent.scrollTop,\n        left: childRect.left - parentRect.left + parent.scrollLeft,\n        bottom: childRect.bottom - parentRect.top + parent.scrollTop,\n        right: childRect.right - parentRect.left + parent.scrollLeft,\n        width: childRect.width,\n        height: childRect.height\n    };\n}\nfunction closest(target, selector) {\n    if (target && target[\"nodeType\"] === 1) {\n        var element = target;\n        return element.closest(selector);\n    }\n    return null;\n}\n","export function saveSelection() {\n    if (window.getSelection) {\n        var sel = window.getSelection();\n        if (sel.getRangeAt && sel.rangeCount) {\n            return sel.getRangeAt(0);\n        }\n    }\n    else if (document[\"selection\"] && document[\"selection\"].createRange) {\n        return document[\"selection\"].createRange();\n    }\n    return null;\n}\nexport function restoreSelection(range) {\n    if (range) {\n        if (window.getSelection) {\n            var sel = window.getSelection();\n            sel.removeAllRanges();\n            sel.addRange(range);\n        }\n        else if (document[\"selection\"] && range.select) {\n            range.select();\n        }\n    }\n}\nexport function selectAllText(elem) {\n    var range, selection;\n    // A jQuery selector should pass through too\n    //elem = (elem.jquery && elem.length) ? elem[0] : elem;\n    if (!elem) {\n        return;\n    }\n    else if (elem.nodeName.match(/^(INPUT|TEXTAREA)$/i)) {\n        elem.focus();\n        elem.select();\n    }\n    else if (typeof window.getSelection === \"function\") {\n        selection = window.getSelection();\n        if (typeof selection.setBaseAndExtent === \"function\") {\n            // Safari\n            selection.setBaseAndExtent(elem, 0, elem, 1);\n        }\n        else if (typeof selection.addRange === \"function\"\n            && typeof selection.removeAllRanges === \"function\"\n            && typeof document.createRange === \"function\") {\n            // Mozilla or Opera 10.5+\n            range = document.createRange();\n            range.selectNodeContents(elem);\n            selection.removeAllRanges();\n            selection.addRange(range);\n        }\n    }\n}\n","import { patchElement } from './html-patch-policy';\nvar parser = new DOMParser();\n/** Tags / Attributes Whitelist\n *\n */\nvar HTML_WASH_POLICY = {\n    b: {},\n    i: {},\n    p: {},\n    u: {},\n    strike: {},\n    pre: {},\n    h1: {},\n    h2: {},\n    h3: {},\n    h4: {},\n    h5: {},\n    img: { src: true, class: true, style: true, tabindex: true },\n    a: { href: true, target: true, tabindex: true },\n    ul: {},\n    ol: {},\n    li: {},\n    hr: {},\n    br: {},\n    div: {},\n    span: { style: true },\n    // table tags:\n    table: { border: true },\n    tbody: {},\n    thead: {},\n    tfoot: {},\n    tr: {},\n    td: { headers: true, colspan: true, rowspan: true },\n    th: { abbr: true, headers: true, scope: true, sorted: true, colspan: true, rowspan: true },\n    blockquote: { style: true },\n};\nexport function washHtml(html) {\n    var doc = parser.parseFromString(html, \"text/html\");\n    var childNodes = doc.body.childNodes;\n    var modified = false;\n    for (var i = 0; i < childNodes.length; ++i) {\n        if (washNode(childNodes.item(i))) {\n            modified = true;\n        }\n    }\n    return modified ?\n        doc.body.innerHTML :\n        html; // By returning the original HTML string, we spare the user from refreshing the edit area,\n    // which would otherwise put the cursor at the top, losing the position where user where.\n}\nfunction washNode(node) {\n    var modified = false;\n    if (isElement(node)) {\n        if (washElement(node)) {\n            modified = true;\n        }\n    }\n    if (washChildNodes(node)) {\n        modified = true;\n    }\n    return modified;\n}\nfunction washChildNodes(node) {\n    var modified = false;\n    var childNodes = node.childNodes;\n    for (var i = 0; i < childNodes.length; ++i) {\n        if (washNode(childNodes.item(i))) {\n            modified = true;\n        }\n    }\n    return modified;\n}\n/** Replace an element with its child nodes.\n *\n */\nfunction removeMiddleElement(element) {\n    var childNodes = element.childNodes;\n    for (var i = 0; i < childNodes.length; ++i) {\n        element.parentNode.insertBefore(childNodes.item(i), element);\n    }\n    element.remove();\n}\nfunction washElement(element) {\n    var modified = patchElement(element);\n    var policy = element.tagName && HTML_WASH_POLICY[element.tagName.toLowerCase()];\n    if (!policy) {\n        console.warn(\"Wysiwyg: not allowed tag\", element.tagName);\n        washChildNodes(element);\n        removeMiddleElement(element);\n        return true;\n    }\n    for (var i = 0; i < element.attributes.length; ++i) {\n        var attr = element.attributes.item(i);\n        var allowed = attr.name && !!policy[attr.name.toLowerCase()];\n        if (!allowed) {\n            modified = true;\n            console.warn(\"Wysiwyg: not allowed attribute\", attr.name, \"Tag: \", element.tagName);\n            element.removeAttribute(attr.name);\n        }\n    }\n    return modified;\n}\nfunction isElement(node) {\n    return !!node.tagName;\n}\n","export * from './week-notebook';\nexport * from './root-week-notebook';\n","import * as React from 'react';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { WeekNotebook } from '.';\nexport function RootWeekNotebook(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(WeekNotebook, null));\n}\n","import * as tslib_1 from \"tslib\";\nimport React from 'react';\nimport { weekNotesRepo } from '../../repos/week-notes-repo';\nimport { PendingJob } from '../../utils/pending-job';\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\nimport env from '../../globals/KED.env';\nimport { Wysiwyg } from '../utility-components/wysiwyg';\nimport actions_swedish from '../utility-components/wysiwyg/actions-sv';\nimport actions_en from '../utility-components/wysiwyg/actions';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport { ifTakesTime } from '../../utils/if-takes-time';\nimport { FormattedMessage } from 'react-intl';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nvar MAX_NOTE_LENGTH = 16384;\nvar WeekNotebook = /** @class */ (function (_super) {\n    tslib_1.__extends(WeekNotebook, _super);\n    function WeekNotebook(props) {\n        var _this = _super.call(this, props) || this;\n        _this.onChange = _this.onChange.bind(_this);\n        _this.autoSaver = new PendingJob(function () { return _this.save(); });\n        _this.state = {\n            isLoading: true,\n            showLoadingProgress: false,\n            showSavingProgress: false,\n            everEdited: false,\n            notes: \"\",\n        };\n        return _this;\n    }\n    WeekNotebook.prototype.componentDidMount = function () {\n        this.showProgressIfLoadingTakesTime();\n        weekNotesRepo.mem.subscribe(this.onChange);\n    };\n    WeekNotebook.prototype.showProgressIfLoadingTakesTime = function () {\n        var _this = this;\n        this.timeoutHandle = setTimeout(function () { return _this.state.isLoading && _this.setState({ showLoadingProgress: true }); }, 300);\n    };\n    WeekNotebook.prototype.componentWillUnmount = function () {\n        weekNotesRepo.mem.unsubscribe(this.onChange);\n        this.autoSaver.stop();\n        clearTimeout(this.timeoutHandle);\n    };\n    WeekNotebook.prototype._save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var maxIterations;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        maxIterations = 3;\n                        _a.label = 1;\n                    case 1:\n                        if (!(this.isNotesEdited() && maxIterations)) return [3 /*break*/, 4];\n                        return [4 /*yield*/, weekNotesRepo.upsert(this.state.weekNote, function (wn) {\n                                wn.content = _this.state.notes;\n                            })];\n                    case 2:\n                        _a.sent();\n                        _a.label = 3;\n                    case 3:\n                        --maxIterations;\n                        return [3 /*break*/, 1];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekNotebook.prototype.save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var err_1;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!(!this.state.showSavingProgress && !this.state.isLoading && this.isNotesEdited())) return [3 /*break*/, 8];\n                        return [4 /*yield*/, this.setState({ error: undefined })];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2:\n                        _a.trys.push([2, 4, 6, 8]);\n                        return [4 /*yield*/, ifTakesTime(300, function () { return _this._save(); }, function () { return _this.setState({ showSavingProgress: true }); })];\n                    case 3:\n                        _a.sent();\n                        return [3 /*break*/, 8];\n                    case 4:\n                        err_1 = _a.sent();\n                        console.error(err_1);\n                        return [4 /*yield*/, this.setState({ error: this.context.intl.formatMessage({ id: \"common.errorSavingData\", defaultMessage: \"Kunde inte spara.\" }) })];\n                    case 5:\n                        _a.sent();\n                        return [3 /*break*/, 8];\n                    case 6: return [4 /*yield*/, this.setState({ showSavingProgress: false })];\n                    case 7:\n                        _a.sent();\n                        return [7 /*endfinally*/];\n                    case 8: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekNotebook.prototype.isNotesEdited = function () {\n        var _a = this.state, weekNote = _a.weekNote, notes = _a.notes;\n        return !!weekNote && (notes !== weekNote.content);\n    };\n    //If the notebook should be used in multiple modules, move this functions into an utility file\n    WeekNotebook.prototype.getTranslatedActions = function (intl) {\n        //actions might have different icons for each language\n        //we keep the same structure of the actions, but we replace the texts with the ones from the translated files\n        var localeActions = Object.assign({}, intl.locale === \"sv\" ? actions_swedish : actions_en);\n        Object.keys(localeActions).forEach(function (elem) {\n            var currentTitle = actions_swedish[elem].title;\n            localeActions[elem].title = intl.formatMessage({ id: \"wysiwyg.\" + elem, defaultMessage: currentTitle });\n            //because the image action needs a custom translation, we treat this separately\n            if (elem === \"image\") {\n                localeActions[elem].promptMsg = intl.formatMessage({ id: \"wysiwyg.imagePromptMsg\", defaultMessage: actions_swedish[elem].promptMsg });\n            }\n        });\n        return localeActions;\n    };\n    WeekNotebook.prototype.onChange = function (weekNotes) {\n        var weekNote = weekNotes.length > 0 ?\n            weekNotes[weekNotes.length - 1] :\n            {\n                id: createUUID(),\n                dateTime: Date.now(),\n                //dateTime: weekNotesRepo.getCurrentWeek().toDate().getTime(),\n                content: \"\",\n                acl: [\n                    // Default ACL: Let user self have full control over this item:\n                    new DocumentAccess(\"email\", env.currentUser.mail, \"S\")\n                ].map(function (ac) { return ac.toString(); })\n            };\n        var newState = {\n            weekNote: weekNote,\n            //week: weekNotesRepo.getCurrentWeek().week(),\n            isLoading: false,\n            showLoadingProgress: false\n        };\n        if (!this.state.weekNote || this.state.weekNote.id !== weekNote.id || weekNotes.length === 0) {\n            newState.notes = weekNote.content;\n        }\n        this.setState(newState);\n    };\n    /*async changeWeek(direction: number) {\n      try {\n        await this.setState({\n          isLoading: true,\n          everEdited: false,\n          weekNote: null,\n          error: undefined\n        });\n        this.showProgressIfLoadingTakesTime();\n        await weekNotesRepo.changeWeek(direction);\n      } catch (err) {\n        console.error(err);\n        await this.setState({error: \"Kunde inte ladda data\"});\n      }\n    }\n  \n    prevWeek() {\n      this.changeWeek(-1);\n    }\n  \n    nextWeek() {\n      this.changeWeek(1);\n    }*/\n    WeekNotebook.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, notes = _a.notes, showLoadingProgress = _a.showLoadingProgress, isLoading = _a.isLoading, showSavingProgress = _a.showSavingProgress, error = _a.error, everEdited = _a.everEdited;\n        var intl = this.context.intl;\n        return (React.createElement(\"div\", null,\n            React.createElement(\"div\", { className: \"ked_boxed kedNotepad\" },\n                React.createElement(\"h3\", null,\n                    React.createElement(FormattedMessage, { id: \"weekNotebook.title\", defaultMessage: \"Anteckningar\" })),\n                React.createElement(Wysiwyg, { actions: [\n                        \"bold\",\n                        \"italic\",\n                        \"underline\",\n                        \"strikethrough\",\n                        \"olist\",\n                        \"ulist\",\n                        \"outdent\",\n                        \"indent\",\n                        \"line\"\n                    ], defaultActions: this.getTranslatedActions(intl), html: isLoading ? \"<div></div>\" : notes.substr(0, MAX_NOTE_LENGTH), onChange: !isLoading && (function (html) {\n                        _this.setState({\n                            notes: html.substr(0, MAX_NOTE_LENGTH),\n                            everEdited: true\n                        });\n                        _this.autoSaver.triggerChange(500);\n                    }) }),\n                React.createElement(\"hr\", null),\n                error ?\n                    React.createElement(\"p\", { className: \"error\" }, error) :\n                    showLoadingProgress ?\n                        React.createElement(\"span\", null,\n                            React.createElement(FormattedMessage, { id: \"common.loading\", defaultMessage: \"Laddar...\" }),\n                            React.createElement(Spinner, null)) :\n                        showSavingProgress ? React.createElement(React.Fragment, null,\n                            React.createElement(\"span\", null,\n                                React.createElement(FormattedMessage, { id: \"common.saving\", defaultMessage: \"Sparar...\" }),\n                                \" \\u00A0 \"),\n                            React.createElement(Spinner, null)) :\n                            this.isNotesEdited() ?\n                                React.createElement(React.Fragment, null, \"\\u00A0\") :\n                                everEdited ?\n                                    React.createElement(FormattedMessage, { id: \"common.saved\", defaultMessage: \"Sparad\" }) :\n                                    React.createElement(React.Fragment, null, \"\\u00A0\"))));\n    };\n    WeekNotebook.contextType = LanguageContext;\n    return WeekNotebook;\n}(React.Component));\nexport { WeekNotebook };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { FormattedMessage } from 'react-intl';\nimport { env } from '../../globals/KED.env';\nvar AddCustomGoal = /** @class */ (function (_super) {\n    tslib_1.__extends(AddCustomGoal, _super);\n    function AddCustomGoal(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            learningGoal: props.learningGoal || ''\n        };\n        return _this;\n    }\n    AddCustomGoal.prototype.render = function () {\n        var _this = this;\n        var learningGoal = this.state.learningGoal;\n        var onSave = this.props.onSave;\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\n        return React.createElement(\"div\", null,\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till rubrik\" }) :\n                    React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget l\\u00E4randem\\u00E5l\" })),\n                React.createElement(\"hr\", null),\n                React.createElement(\"div\", { className: \"align-horizontal\" },\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchool\", defaultMessage: \"Rubrik\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchool\", defaultMessage: \"M\\u00E5l\" })),\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, autoFocus: true, value: learningGoal, onChange: function (e) { return _this.setState({ learningGoal: e.target.value }); } })),\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\n                React.createElement(\"br\", null)),\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(learningGoal); } },\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"save\" }))));\n    };\n    return AddCustomGoal;\n}(React.Component));\nexport { AddCustomGoal };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { TextInput } from '../utility-components/form-field-text-input';\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { FormattedMessage } from 'react-intl';\nimport { env } from '../../globals/KED.env';\nvar AddCustomTask = /** @class */ (function (_super) {\n    tslib_1.__extends(AddCustomTask, _super);\n    function AddCustomTask(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            name: '',\n            description: '',\n            url: ''\n        };\n        return _this;\n    }\n    AddCustomTask.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\n        var _b = this.props, isTask = _b.isTask, onSave = _b.onSave;\n        var intl = this.context.intl;\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\n        return React.createElement(\"div\", null,\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till uppgift\" }) :\n                    React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget arbetsm\\u00E5l\" })),\n                React.createElement(\"hr\", null),\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.nameLabel', defaultMessage: 'Namn' }), id: \"AddCustomTask:name\", placeholder: intl.formatMessage({ id: 'customTask.enterNamePlhd', defaultMessage: 'Ange namn...' }), value: name, autoFocus: true, onChange: function (name) { return _this.setState({ name: name }); } }),\n                React.createElement(TextAreaFormField, { rows: 7, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddCustomTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: \"Lägg till en beskrivning...\" }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Länk' }), id: \"AddCustomTask:url\", placeholder: \"http://www...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(name, description, url); } },\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\n    };\n    AddCustomTask.contextType = LanguageContext;\n    return AddCustomTask;\n}(React.Component));\nexport { AddCustomTask };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { TextInput } from '../utility-components/form-field-text-input';\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\nimport { createUUID } from 'kedbackend/client';\nimport { FormattedMessage } from 'react-intl';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nvar AddOrEditSubTask = /** @class */ (function (_super) {\n    tslib_1.__extends(AddOrEditSubTask, _super);\n    function AddOrEditSubTask(props) {\n        var _this = _super.call(this, props) || this;\n        if (props.mode === 'edit') {\n            var subTask = props.subTask;\n            _this.state = {\n                name: subTask.name || '',\n                description: subTask.description || '',\n                url: subTask.url || ''\n            };\n        }\n        else {\n            _this.state = {\n                name: '',\n                description: '',\n                url: ''\n            };\n        }\n        return _this;\n    }\n    AddOrEditSubTask.prototype.save = function () {\n        // Update repo:\n        var props = this.props;\n        var userTask = props.userTask, closeDialog = props.closeDialog, userTasksRepo = props.userTasksRepo;\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\n        if (props.mode === 'edit') {\n            // Edit existing:\n            userTasksRepo.update([userTask], function (ut) {\n                var subTasks = ut.subTasks;\n                if (subTasks) {\n                    ut.subTasks = subTasks.map(function (st) {\n                        return st.id === props.subTask.id ? tslib_1.__assign({}, st, { name: name, description: description, url: url }) : tslib_1.__assign({}, st);\n                    });\n                }\n            });\n        }\n        else {\n            // Create new task\n            var newSubTask_1 = {\n                id: createUUID(),\n                name: name,\n                description: description,\n                url: url\n            };\n            // Update repo:\n            userTasksRepo.update([userTask], function (ut) {\n                if (!ut.subTasks) {\n                    ut.subTasks = [];\n                }\n                ut.subTasks = ut.subTasks.concat(newSubTask_1);\n            });\n        }\n        // Close dialog\n        closeDialog();\n    };\n    AddOrEditSubTask.prototype.delete = function () {\n        // Update repo:\n        var props = this.props;\n        if (props.mode !== 'edit') {\n            throw new Error(\"Can only delete in edit mode\");\n        }\n        props.userTasksRepo.update([props.userTask], function (ut) {\n            if (ut.subTasks) {\n                ut.subTasks = ut.subTasks.filter(function (t) { return t.id !== props.subTask.id; });\n            }\n        });\n        // Close dialog:\n        props.closeDialog();\n    };\n    AddOrEditSubTask.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\n        var props = this.props;\n        var isEditMode = props.mode === 'edit';\n        var intl = this.context.intl;\n        return React.createElement(React.Fragment, null,\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\n                React.createElement(\"h2\", null, isEditMode ? React.createElement(FormattedMessage, { id: \"addeditsubtask.editSubtask\", defaultMessage: 'Redigera underuppgift' }) : React.createElement(FormattedMessage, { id: \"addeditsubtask.addSubtask\", defaultMessage: 'L\\u00E4gg till underuppgift' })),\n                React.createElement(\"hr\", null),\n                React.createElement(TextInput, { autoFocus: true, label: intl.formatMessage({ id: 'addeditsubtask.nameLabel', defaultMessage: 'Underuppgiftens namn' }), id: \"AddUserSubTask:name\", placeholder: \"\", value: this.state.name, onChange: function (name) { return _this.setState({ name: name }); } }),\n                React.createElement(TextAreaFormField, { label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddUserSubTask:description\", rows: 7, placeholder: \"\", value: this.state.description, onChange: function (description) { return _this.setState({ description: description }); } }),\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Länk' }), id: \"AddUserSubTask:url\", placeholder: \"\", value: this.state.url, onChange: function (url) { return _this.setState({ url: url }); } }),\n                React.createElement(\"br\", null)),\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\n                props.mode === 'edit' && React.createElement(\"button\", { className: \"btn btn-warning btn-large pull-right\", onClick: function (ev) { return _this.delete(); } },\n                    React.createElement(FormattedMessage, { id: \"addeditsubtask.deleteSubtask\", defaultMessage: \"Ta bort underuppgift\" })),\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } },\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\n    };\n    AddOrEditSubTask.contextType = LanguageContext;\n    return AddOrEditSubTask;\n}(React.Component));\nexport { AddOrEditSubTask };\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { getTaskType } from './get-task-type';\nimport ReactDatePicker from 'react-datepicker';\nimport '../../globals/moment-sv-locale';\nimport { TextInput } from '../utility-components/form-field-text-input';\nimport moment from 'moment';\nimport { FormField } from '../utility-components/form-field';\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\nimport { FormattedMessage } from 'react-intl';\nimport { LanguageContext } from \"../utility-components/LanguageContext\";\nvar EditUserTask = /** @class */ (function (_super) {\n    tslib_1.__extends(EditUserTask, _super);\n    function EditUserTask(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            userTask: props.userTask,\n            name: props.userTask.name,\n            description: props.userTask.description,\n            url: props.userTask.url,\n            deadline: props.userTask.deadline,\n            subTasks: props.userTask.subTasks\n        };\n        _this.onUserTasksChanged = _this.onUserTasksChanged.bind(_this);\n        return _this;\n    }\n    EditUserTask.prototype.componentDidMount = function () {\n        this.props.userTasksRepo.subscribe(this.onUserTasksChanged);\n    };\n    EditUserTask.prototype.onUserTasksChanged = function (userTasks) {\n        var _this = this;\n        var myUserTask = userTasks.find(function (ut) { return ut.id === _this.props.userTask.id; });\n        if (!myUserTask) {\n            this.props.closeDialog();\n            return;\n        }\n        this.setState({\n            userTask: myUserTask,\n            subTasks: myUserTask.subTasks\n        });\n    };\n    EditUserTask.prototype.componentWillUnmount = function () {\n        this.props.userTasksRepo.unsubscribe(this.onUserTasksChanged);\n    };\n    EditUserTask.prototype.isModified = function () {\n        // Don't count subtask changes! They live their own life and is maintained\n        // in add-or-edit-sub-task.tsx. Reason: User would expect added /edited subtasks\n        // to be persisted right away. May click away this dialog.\n        // Also reason: Can invoke that dialog by itself from other components. From WeekPlanner\n        // when clicking the subtask for example!\n        var _a = this.state, deadline = _a.deadline, description = _a.description, name = _a.name, url = _a.url, userTask = _a.userTask;\n        return (deadline !== userTask.deadline ||\n            description !== userTask.description ||\n            name !== userTask.name ||\n            url !== userTask.url);\n    };\n    EditUserTask.prototype.addSubTask = function () {\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"add\", userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\n    };\n    EditUserTask.prototype.editSubTask = function (subTask) {\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"edit\", subTask: subTask, userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\n    };\n    EditUserTask.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url, deadline = _a.deadline, subTasks = _a.subTasks, showCalendar = _a.showCalendar, userTask = _a.userTask;\n        var id = userTask.id, courseName = userTask.courseName;\n        var _b = this.props, onUpdate = _b.onUpdate, onDelete = _b.onDelete;\n        var isModified = this.isModified();\n        var taskType = getTaskType(userTask);\n        var isCustomTask = taskType === 'customTask';\n        var expired = moment(userTask.deadline) < moment();\n        var intl = this.context.intl;\n        return React.createElement(\"div\", { className: \"editTaskDialog sv-html-portlet sv-portlet sv-skip-spacer\" },\n            React.createElement(\"h2\", null, isCustomTask ?\n                React.createElement(FormattedMessage, { id: \"task.editWorkGoals\", defaultMessage: 'Redigera arbetsm\\u00E5l' }) :\n                React.createElement(FormattedMessage, { id: \"task.editTask\", defaultMessage: 'Redigera uppgift' })),\n            React.createElement(\"hr\", null),\n            React.createElement(TextInput, { autoFocus: true, label: isCustomTask ? intl.formatMessage({ id: 'task.targetNameLabel', defaultMessage: 'Arbetsmålets namn' }) : intl.formatMessage({ id: 'task.taskNameLabel', defaultMessage: 'Uppgiftens namn' }), id: \"EditUserTask:name\", placeholder: isCustomTask ? intl.formatMessage({ id: 'task.whatShouldYouDoPlhd', defaultMessage: 'Vad ska du göra?' }) : intl.formatMessage({ id: 'task.enterTaskNamePlhd', defaultMessage: 'Ange uppgiftens namn...' }), value: name, onChange: function (name) { return _this.setState({ name: name }); } }),\n            isCustomTask && React.createElement(React.Fragment, null,\n                React.createElement(TextAreaFormField, { rows: 5, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"EditUserTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: 'Lägg till en beskrivning...' }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: \"Länk\" }), id: \"EdutUserTask:url\", placeholder: \"http(s)://...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.setDeadline', defaultMessage: 'Ange deadline' }) }, (deadline || showCalendar) ?\n                React.createElement(\"div\", { className: \"align-horizontal\" },\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                        React.createElement(ReactDatePicker, { ref: function (elem) { return _this.datePicker = elem; }, id: \"EditUserTask:deadline\", nextMonthButtonLabel: \"\", previousMonthButtonLabel: \"\", showWeekNumbers: true, selected: deadline && moment(deadline).toDate(), autoFocus: showCalendar, dateFormat: \"yyyy-MM-dd\", className: expired ? \"expired\" : undefined, locale: intl.locale, popperPlacement: isCustomTask ? \"top-start\" : \"bottom-start\", onBlur: function () { return _this.setState({ showCalendar: false }); }, onChange: function (value) {\n                                _this.setState({\n                                    deadline: value && moment(value).format(\"YYYY-MM-DD\"),\n                                    showCalendar: false\n                                });\n                            } })),\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                        React.createElement(\"a\", { className: \"deleteDate\", href: \"#\", title: intl.formatMessage({ id: 'task.removeDeadline', defaultMessage: 'Ta bort deadline' }), onClick: function (ev) {\n                                ev.preventDefault();\n                                _this.setState({ deadline: null, showCalendar: false });\n                            } }))) :\n                React.createElement(\"div\", { className: \"top\", ref: function () { _this.datePicker = null; } },\n                    React.createElement(\"a\", { className: \"btn\", onClick: function (ev) {\n                            if (_this.datePicker) {\n                                _this.datePicker.setOpen(true);\n                            }\n                            _this.setState({\n                                showCalendar: true\n                            });\n                        } },\n                        React.createElement(\"i\", { className: \"fa fa-calendar\", \"aria-hidden\": \"true\" }),\n                        React.createElement(FormattedMessage, { id: \"task.setDeadlineLabel\", defaultMessage: \"Ange deadline...\" })))),\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.subTasks', defaultMessage: 'Underuppgifter' }) },\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\n                    React.createElement(\"div\", { className: \"taskContainer\" }, subTasks && subTasks.map(function (subTask) { return React.createElement(\"div\", { key: subTask.id, className: \"align-horizontal\" },\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\n                            React.createElement(\"a\", { onClick: function () { return _this.editSubTask(subTask); }, href: \"#\" }, subTask.name))); }))),\n                React.createElement(\"div\", { className: \"align-horizontal\" },\n                    React.createElement(\"div\", { className: \"top\" },\n                        React.createElement(\"button\", { id: \"EditUserTask:addSubTask\", className: \"btn\", onClick: function () { return _this.addSubTask(); } },\n                            React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\n                            \" \",\n                            React.createElement(FormattedMessage, { id: \"task.addSubtask\", defaultMessage: \"L\\u00E4gg till underuppgift\" }))))),\n            React.createElement(\"div\", { className: \"divider large\" }),\n            React.createElement(\"div\", { className: \"align-horizontal\" },\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-default\", onClick: function () {\n                            isModified ? onUpdate(function (userTask) {\n                                userTask.name = name;\n                                userTask.description = description;\n                                userTask.url = url;\n                                userTask.deadline = deadline;\n                            }) : _this.props.closeDialog();\n                        } },\n                        React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))),\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn\", onClick: function () {\n                            _this.props.closeDialog();\n                        } },\n                        React.createElement(FormattedMessage, { id: \"common.cancel\", defaultMessage: \"Avbryt\" }))),\n                React.createElement(\"div\", { className: \"confirm top pull-right\" },\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-warning\", onClick: function () {\n                            onDelete(id);\n                        } }, isCustomTask ?\n                        React.createElement(FormattedMessage, { id: \"task.removeWorkGoals\", defaultMessage: \"Ta bort arbetsm\\u00E5l\" }) :\n                        React.createElement(FormattedMessage, { id: \"task.removeThisTask\", defaultMessage: \"Ta bort den h\\u00E4r uppgiften\" })))));\n    };\n    EditUserTask.contextType = LanguageContext;\n    return EditUserTask;\n}(React.Component));\nexport { EditUserTask };\n","export function getTaskType(userTask) {\n    return userTask.course && userTask.task && userTask.course.length > 0 && userTask.task.length > 0 ?\n        'courseBuilderTask' :\n        userTask.siteVisionPageId ?\n            'siteVisionTask' :\n            userTask.courseInfo ?\n                'subjectPlannerTask' :\n                'customTask';\n}\n","import * as tslib_1 from \"tslib\";\nimport { arrayToLookup, compareProp } from \"../../utils/utils\";\nexport function refine(tasks) {\n    var e_1, _a, e_2, _b;\n    var result = [];\n    var mapper = {};\n    var tasksPerCourse = arrayToLookup(tasks, function (t) { return t.courseName || ''; });\n    try {\n        for (var _c = tslib_1.__values(Object.keys(tasksPerCourse).sort().filter(function (x) { return x; }).concat(tasksPerCourse[''] ?\n            [''] : [])), _d = _c.next(); !_d.done; _d = _c.next()) {\n            var courseName = _d.value;\n            var courseTasks = tasksPerCourse[courseName] || tasksPerCourse[''];\n            var tasksPerLearningGoal = arrayToLookup(courseTasks, function (t) { return t.learningGoal; });\n            var resultLearningGoals = [];\n            try {\n                for (var _e = (e_2 = void 0, tslib_1.__values(Object.keys(tasksPerLearningGoal))), _f = _e.next(); !_f.done; _f = _e.next()) {\n                    var learningGoal = _f.value;\n                    var lgTasks = tasksPerLearningGoal[learningGoal].sort(compareProp(\"dateTime\"));\n                    var learningGoalTask = lgTasks\n                        .filter(function (t) { return t.name == null; }) // If name is undefined or null, this represents a learning goal\n                    [0];\n                    var url = learningGoalTask && learningGoalTask.url;\n                    resultLearningGoals.push({\n                        name: learningGoal,\n                        allTasks: lgTasks,\n                        url: url,\n                        step: lgTasks.map(function (t) { return t.step; }).filter(function (step) { return step; })[0],\n                        tasks: lgTasks.filter(function (t) { return t.name; })\n                    });\n                }\n            }\n            catch (e_2_1) { e_2 = { error: e_2_1 }; }\n            finally {\n                try {\n                    if (_f && !_f.done && (_b = _e.return)) _b.call(_e);\n                }\n                finally { if (e_2) throw e_2.error; }\n            }\n            result.push({\n                courseName: courseName,\n                learningGoals: resultLearningGoals\n            });\n        }\n    }\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\n    finally {\n        try {\n            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);\n        }\n        finally { if (e_1) throw e_1.error; }\n    }\n    return result;\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { OpenCloseBox } from '../utility-components/open-close-box';\nimport { preserveImpersonationQuery } from '../../access-control';\nimport { courseNameToCssClass } from '../calendar/course-name-to-css-class';\nimport { getTaskType } from './get-task-type';\nimport moment from 'moment';\nimport { Features } from '../../features';\nimport cfg from '../../globals/KED.cfg';\nimport { FormattedMessage } from 'react-intl';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { env } from '../../globals/KED.env';\n;\nvar UserTasksBox = /** @class */ (function (_super) {\n    tslib_1.__extends(UserTasksBox, _super);\n    function UserTasksBox(props) {\n        return _super.call(this, props) || this;\n    }\n    UserTasksBox.prototype.render = function () {\n        var _this = this;\n        var _a = this.props, courseName = _a.courseName, learningGoals = _a.learningGoals, progressData = _a.progressData, displayProgress = _a.displayProgress;\n        var isOpen = !!this.props.openCourses[courseName];\n        var features = new Features();\n        var intl = this.context.intl;\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null, courseName || (isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"userTasks.gymnasiumSchoolGoals\", defaultMessage: \"\\u00D6vriga uppgifter\" }) : React.createElement(FormattedMessage, { id: \"userTasks.primarySchoolGoals\", defaultMessage: \"Egna l\\u00E4randem\\u00E5l\" }))), headerOpen: isOpen, className: courseName && courseNameToCssClass('wp-course-', courseName), onOpenClose: function (becameOpen) { return _this.props.setIsOpen(courseName, becameOpen); }, displayProgress: displayProgress, progressData: progressData }, learningGoals.map(function (lg) {\n            return React.createElement(\"div\", { key: lg.name, className: \"learningGoalContainer\" },\n                lg.step && React.createElement(\"div\", { className: \"stepIndicator\" }, lg.step),\n                React.createElement(\"div\", { className: \"align-horizontal\" },\n                    React.createElement(\"div\", { className: \"learningGoalText horizontalItem top\" }, lg.name),\n                    React.createElement(\"div\", { className: \"horizontalItem\" },\n                        \"\\u00A0\",\n                        React.createElement(\"a\", { className: \"trash\", href: \"#\", title: intl.formatMessage({ id: 'userTasks.deleteLearningGoal', defaultMessage: 'Ta bort lärandemålet och dess uppgifter' }), onClick: function (ev) {\n                                ev.preventDefault();\n                                _this.props.removeLearningGoal(lg);\n                            } },\n                            React.createElement(\"i\", { className: \"fa fa-trash\" })))),\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\n                    React.createElement(\"div\", { className: \"taskContainer\" }, lg.tasks.map(function (userTask) {\n                        var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting' || userTask.$meta === 'updating';\n                        var taskType = getTaskType(userTask);\n                        var expired = moment(userTask.deadline).startOf('day') < moment().startOf('day');\n                        return React.createElement(\"div\", { key: userTask.id, style: isWorking ? { opacity: 0.5 } : {} },\n                            React.createElement(\"div\", { className: \"align-horizontal\" },\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\n                                    React.createElement(\"div\", { className: \"checkBox\" + (userTask.done ? \" checked\" : \"\"), onClick: function (ev) { return !isWorking && _this.props.setTaskDone(userTask, !userTask.done); } })),\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\n                                    taskType === 'courseBuilderTask' ?\n                                        React.createElement(\"a\", { href: getTaskUrl(userTask, _this.props.viewCourseUrl) }, userTask.name) :\n                                        taskType === 'subjectPlannerTask' ?\n                                            React.createElement(\"a\", { href: getSubjectPlannerTaskUrl(userTask) }, userTask.name) :\n                                            taskType === 'siteVisionTask' ?\n                                                React.createElement(\"a\", { href: userTask.url }, userTask.name) :\n                                                React.createElement(\"a\", { className: !userTask.url ? \"link-less\" : \"\", href: userTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\n                                                        \"_self\" :\n                                                        \"_blank\" }, userTask.name),\n                                    userTask.deadline && React.createElement(\"div\", { className: \"dateSet\" + (expired ? ' expired' : '') },\n                                        React.createElement(\"i\", { title: moment(userTask.deadline).format(\"YYYY-MM-DD\"), className: \"fa fa-calendar\", \"aria-hidden\": \"true\", onClick: function () { } }))),\n                                React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\n                                    React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editTask(userTask); } }))),\n                            userTask.subTasks && React.createElement(\"div\", { className: \"subtasks\" }, userTask.subTasks.map(function (subTask) {\n                                return React.createElement(\"div\", { key: subTask.id },\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                                        React.createElement(\"div\", { className: \"checkBox\" + (subTask.done ? \" checked\" : \"\"), onClick: function (ev) {\n                                                return !isWorking &&\n                                                    _this.props.setSubTaskDone(userTask, subTask, !subTask.done);\n                                            } })),\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\n                                        React.createElement(\"a\", { href: subTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\n                                                \"_self\" :\n                                                \"_blank\", className: subTask.url ?\n                                                undefined :\n                                                'link-less' }, subTask.name)),\n                                    React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\n                                        React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editSubTask(userTask, subTask); } })));\n                            })));\n                    }))),\n                React.createElement(\"div\", { className: \"learningGoalTools\" },\n                    React.createElement(\"div\", { className: \"btn addOwnGoal\", onClick: function () { return _this.props.addOwnTask(_this.props.courseName, lg.name); } },\n                        React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\n                        \" \",\n                        isGymnasiumStudent ?\n                            React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) :\n                            React.createElement(FormattedMessage, { id: 'userTasks.addLearningGoal', defaultMessage: 'Eget arbetsm\\u00E5l' }))),\n                React.createElement(\"br\", null));\n        }));\n    };\n    UserTasksBox.contextType = LanguageContext;\n    return UserTasksBox;\n}(React.Component));\nexport { UserTasksBox };\nfunction getTaskUrl(userTask, viewCourseUrl) {\n    if (userTask.course && userTask.course.length > 0 && userTask.task && userTask.task.length > 0) {\n        var courseUrl = preserveImpersonationQuery(viewCourseUrl, { courseId: userTask.course[0].id });\n        return courseUrl + \"#/task/\" + userTask.task[0].id;\n    }\n    return userTask.url;\n}\nfunction getSubjectPlannerTaskUrl(userTask) {\n    if (userTask.courseInfo && userTask.task && userTask.task.length > 0) {\n        var _a = userTask.courseInfo, school = _a.school, course = _a.course, tab = _a.tab;\n        var courseUrl = preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL, {});\n        return courseUrl + \"#/\" + school + \"/courses/\" + course + \"/tabs/\" + tab + \"/tasks/\" + userTask.task[0].id;\n    }\n    return userTask.url;\n}\n","import * as tslib_1 from \"tslib\";\nimport moment from 'moment';\nimport { localMoment } from '../../globals/moment-sv-locale';\nvar WeekPlannerPersistedState = /** @class */ (function () {\n    function WeekPlannerPersistedState(userOrCopy) {\n        if (typeof userOrCopy === 'string') {\n            this.user = userOrCopy;\n            this.lastWrite = Date.now();\n            this.weekDate = localMoment().startOf('week').valueOf();\n            this.openCourses = {};\n        }\n        else {\n            Object.assign(this, userOrCopy);\n        }\n    }\n    WeekPlannerPersistedState.load = function (user) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var cookie, storedData, state;\n            return tslib_1.__generator(this, function (_a) {\n                cookie = localStorage.getItem('WeekPlannerPersistedState2');\n                storedData = cookie && JSON.parse(cookie);\n                state = new WeekPlannerPersistedState(user);\n                if (storedData)\n                    Object.assign(state, storedData);\n                return [2 /*return*/, state.user === user && !state.isExpired(moment()) ?\n                        state : new WeekPlannerPersistedState(user)];\n            });\n        });\n    };\n    WeekPlannerPersistedState.prototype.save = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var json;\n            return tslib_1.__generator(this, function (_a) {\n                this.lastWrite = Date.now();\n                json = JSON.stringify(this);\n                localStorage.setItem('WeekPlannerPersistedState2', json);\n                return [2 /*return*/];\n            });\n        });\n    };\n    WeekPlannerPersistedState.prototype.isExpired = function (asOf) {\n        return moment(this.lastWrite)\n            .isBefore(asOf.add(0 - WeekPlannerPersistedState.EXPIRATION_HOURS, 'hours'));\n    };\n    WeekPlannerPersistedState.EXPIRATION_HOURS = 12;\n    WeekPlannerPersistedState.VERSION = 2;\n    return WeekPlannerPersistedState;\n}());\nexport { WeekPlannerPersistedState };\n","import * as React from 'react';\nimport { WeekPlanner } from './weekplanner';\nimport env from '../../globals/KED.env';\nimport cfg from '../../globals/KED.cfg';\nimport '../../repos/user-tasks-repo';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nexport function WeekPlannerSelf(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(WeekPlanner, { env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL }));\n}\n","import * as React from 'react';\nimport { WeekPlanner } from './weekplanner';\nimport { TutorableComponent } from '../utility-components/tutorable-component';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport cfg from '../../globals/KED.cfg';\nexport function WeekPlannerTutored(props) {\n    var intl = props.intl;\n    return React.createElement(LanguageContext.Provider, { value: { intl: intl } },\n        React.createElement(TutorableComponent, { tutored: true, createComponent: function (env) {\n                return React.createElement(WeekPlanner, { key: env.currentUser.mail, env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL });\n            } }));\n}\n","import * as tslib_1 from \"tslib\";\nimport * as React from 'react';\nimport { UserTasksBox } from './user-tasks-box';\nimport { createUUID } from \"kedbackend/client\";\nimport { refine } from './refiner';\nimport { env } from '../../globals/KED.env';\nimport { compareProp } from '../../utils/utils';\nimport moment from 'moment';\nimport { Dialogs } from '../utility-components/dialogs';\nimport { AddCustomGoal } from './add-custom-goal';\nimport { AddCustomTask } from './add-custom-task';\nimport { EditUserTask } from './edit-user-task';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport { OpenCloseBox } from '../utility-components/open-close-box';\nimport { PendingJob } from '../../utils/pending-job';\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\nimport { getAdjustedWeek, KEDWeek, getNextWeekDate, getPrevWeekDate } from '../../utils/weekutil';\nimport { FormattedMessage } from 'react-intl';\nimport { LanguageContext } from '../utility-components/LanguageContext';\nimport { Progress } from '../charts/progress';\nimport { getWeekplannerProgressData } from '../charts/charts-utils';\nimport { features } from '../../features';\nvar MAX_STRATEGY_LENGTH = 16384;\nvar MAX_ASSESSMENT_LENGTH = 16384;\nvar WeekPlanner = /** @class */ (function (_super) {\n    tslib_1.__extends(WeekPlanner, _super);\n    function WeekPlanner(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            userTasks: [],\n            weekDate: Date.now(),\n            openCourses: {},\n            dialogs: [],\n            saving: false,\n            weekTextsUT: null,\n            isLoading: true,\n            isCopyingTasks: false\n        };\n        _this.onChange = _this.onChange.bind(_this);\n        _this.weekTextsSavingJob = new PendingJob(function () { return _this.saveWeekTexts(); });\n        return _this;\n    }\n    WeekPlanner.prototype.componentDidMount = function () {\n        this.props.env.userTasksRepo.subscribe(this.onChange);\n    };\n    WeekPlanner.prototype.componentWillUnmount = function () {\n        this.props.env.userTasksRepo.unsubscribe(this.onChange);\n        this.weekTextsSavingJob.stop();\n    };\n    WeekPlanner.prototype.onChange = function (userTasks, persisted, weekTextsUT) {\n        var newState = {\n            userTasks: userTasks,\n            weekDate: persisted.weekDate,\n            openCourses: persisted.openCourses,\n            weekTextsUT: weekTextsUT,\n            isLoading: false\n        };\n        if (!this.state.weekTextsUT || (weekTextsUT.dateTime !== this.state.weekTextsUT.dateTime)) {\n            // Changing week. Reset to new week's values\n            newState.strategy = weekTextsUT.weekTexts.strategy;\n            newState.assessment = weekTextsUT.weekTexts.assessment;\n        }\n        this.setState(newState); // React's use of Pick instead of Partial makes things complex here.\n    };\n    WeekPlanner.prototype.isWeekTextsEdited = function () {\n        var _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\n        return !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy || assessment !== weekTextsUT.weekTexts.assessment);\n    };\n    WeekPlanner.prototype.saveWeekTexts = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, strategy, assessment, weekTextsUT;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        console.log(\"Saving texts...\");\n                        _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\n                        if (!this.isWeekTextsEdited()) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.props.env.userTasksRepo.upsert(weekTextsUT, function (ut) {\n                                ut.weekTexts = { strategy: strategy, assessment: assessment };\n                            })];\n                    case 1:\n                        _b.sent();\n                        _b.label = 2;\n                    case 2: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.prevWeek = function () {\n        //this.saveWeekTexts(); \n        var prevWeekObj = getPrevWeekDate(moment(this.state.weekDate));\n        this.props.env.userTasksRepo.changeWeek(prevWeekObj.nextDate, prevWeekObj.adjusted);\n    };\n    WeekPlanner.prototype.nextWeek = function () {\n        //this.saveWeekTexts();\n        var nextWeekObj = getNextWeekDate(moment(this.state.weekDate));\n        this.props.env.userTasksRepo.changeWeek(nextWeekObj.nextDate, nextWeekObj.adjusted);\n    };\n    WeekPlanner.prototype.openDialog = function (dialog) {\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\n    };\n    WeekPlanner.prototype.openAddGoalDialog = function () {\n        var _this = this;\n        this.openDialog(React.createElement(AddCustomGoal, { onSave: function (learningGoal) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            if (!learningGoal)\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.emptyLearningGoalErr', defaultMessage: 'Lärandemålet kan inte vara tomt' }));\n                            if (!!this.state.saving) return [3 /*break*/, 5];\n                            this.setState({ saving: true });\n                            _a.label = 1;\n                        case 1:\n                            _a.trys.push([1, , 3, 4]);\n                            return [4 /*yield*/, this.addCustomGoal(learningGoal)];\n                        case 2:\n                            _a.sent();\n                            return [3 /*break*/, 4];\n                        case 3:\n                            this.setState({ saving: false });\n                            return [7 /*endfinally*/];\n                        case 4:\n                            this.closeDialog();\n                            _a.label = 5;\n                        case 5: return [2 /*return*/];\n                    }\n                });\n            }); } }));\n    };\n    WeekPlanner.prototype.openAddOwnTaskDialog = function (courseName, learningGoalName) {\n        var _this = this;\n        this.openDialog(React.createElement(AddCustomTask, { isTask: !courseName, onSave: function (name, description, url) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            if (!name)\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameCannotBeEmpty', defaultMessage: 'Namnet kan inte vara tomt' }));\n                            if (!!this.state.saving) return [3 /*break*/, 5];\n                            this.setState({ saving: true });\n                            _a.label = 1;\n                        case 1:\n                            _a.trys.push([1, , 3, 4]);\n                            return [4 /*yield*/, this.addCustomTask(courseName, learningGoalName, name, description, url)];\n                        case 2:\n                            _a.sent();\n                            return [3 /*break*/, 4];\n                        case 3:\n                            this.setState({ saving: false });\n                            return [7 /*endfinally*/];\n                        case 4:\n                            this.closeDialog();\n                            _a.label = 5;\n                        case 5: return [2 /*return*/];\n                    }\n                });\n            }); } }));\n    };\n    WeekPlanner.prototype.editTask = function (userTask) {\n        var _this = this;\n        this.openDialog(React.createElement(EditUserTask, { userTasksRepo: this.props.env.userTasksRepo, userTask: userTask, onUpdate: function (updater) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var test;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            test = tslib_1.__assign({}, userTask);\n                            updater(test);\n                            if (!test.name)\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameMustNotBeEmpty', defaultMessage: 'Namnet får inte vara tomt' }));\n                            this.closeDialog();\n                            return [4 /*yield*/, this.props.env.userTasksRepo.update([userTask], updater)];\n                        case 1:\n                            _a.sent();\n                            return [2 /*return*/];\n                    }\n                });\n            }); }, onDelete: function (id) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            this.closeDialog();\n                            return [4 /*yield*/, this.props.env.userTasksRepo.delete([id])];\n                        case 1:\n                            _a.sent();\n                            return [2 /*return*/];\n                    }\n                });\n            }); }, openDialog: function (dialog) { return _this.openDialog(dialog); }, closeDialog: function () { return _this.closeDialog(); } }));\n    };\n    WeekPlanner.prototype.editSubTask = function (userTask, subTask) {\n        var _this = this;\n        this.openDialog(React.createElement(AddOrEditSubTask, { userTasksRepo: this.props.env.userTasksRepo, mode: \"edit\", userTask: userTask, subTask: subTask, closeDialog: function () { return _this.closeDialog(); } }));\n    };\n    WeekPlanner.prototype.closeDialog = function () {\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\n    };\n    WeekPlanner.prototype.addCustomGoal = function (learningGoal) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var latestTimeStamp;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\n                                    id: createUUID(),\n                                    learningGoal: learningGoal,\n                                    dateTime: latestTimeStamp + 2000\n                                }])];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.props.env.userTasksRepo.setWeekPlannerBoxOpen(\"\", true)];\n                    case 2:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.removeLearningGoal = function (learningGoal) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (learningGoal.tasks.length > 0) {\n                            if (!confirm(this.context.intl.formatMessage({ id: 'weekplanner.confirmRemoveLearningObjectives', defaultMessage: 'Ta bort lärandemål samt {learningGoalsNumber} uppgifter?' }, { learningGoalsNumber: learningGoal.tasks.length }))) {\n                                return [2 /*return*/];\n                            }\n                        }\n                        return [4 /*yield*/, this.props.env.userTasksRepo.delete(learningGoal.allTasks.map(function (t) { return t.id; }))];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.addCustomTask = function (courseName, learningGoal, name, description, url) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var latestTimeStamp;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\n                          ut.name == null &&\n                          !ut.courseName &&\n                          ut.learningGoal === learningGoal);\n                    \n                        if (emptyLearningGoalPlaceholder) {\n                          // Hijack learning-goal placeholder and make it the real task.\n                          // This will make the learning goal disappear once this task\n                          // is deleted.\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\n                            Object.assign(ut, { name, description, url });\n                          });\n                        } else {*/\n                        // Add another task to same learning-goal\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\n                                    id: createUUID(),\n                                    dateTime: latestTimeStamp + 2000,\n                                    courseName: courseName,\n                                    learningGoal: learningGoal,\n                                    name: name,\n                                    description: description,\n                                    url: url\n                                }])];\n                    case 1:\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\n                          ut.name == null &&\n                          !ut.courseName &&\n                          ut.learningGoal === learningGoal);\n                    \n                        if (emptyLearningGoalPlaceholder) {\n                          // Hijack learning-goal placeholder and make it the real task.\n                          // This will make the learning goal disappear once this task\n                          // is deleted.\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\n                            Object.assign(ut, { name, description, url });\n                          });\n                        } else {*/\n                        // Add another task to same learning-goal\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.setIsOpen = function (courseName, isOpen) {\n        this.props.env.userTasksRepo.setWeekPlannerBoxOpen(courseName, isOpen);\n    };\n    WeekPlanner.prototype.setTaskDone = function (task, done) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setTaskDoneState(task, done)];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.setSubTaskDone = function (task, subTask, done) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setSubTaskDoneState(task, subTask.id, done)];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.copyFromPreviousWeek = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, userTasks_1, openCourses, weekDate, prevWeek, prevWeekNo, prevKEDWeek, prevTasks, test, latestTimeStamp_1, copies;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this.setState({ isCopyingTasks: true })];\n                    case 1:\n                        _b.sent();\n                        _b.label = 2;\n                    case 2:\n                        _b.trys.push([2, , 5, 6]);\n                        _a = this.state, userTasks_1 = _a.userTasks, openCourses = _a.openCourses, weekDate = _a.weekDate;\n                        prevWeek = moment(weekDate).add(-1, 'week');\n                        prevWeekNo = getAdjustedWeek(prevWeek);\n                        prevKEDWeek = KEDWeek(prevWeek.year(), prevWeekNo);\n                        return [4 /*yield*/, this.props.env.kedBackendClient.list(\"usertasks\", {\n                                from: prevKEDWeek.notBefore,\n                                to: prevKEDWeek.notAfter,\n                                role: \"USER\",\n                                include: [\"task\", \"course\", \"acl\"],\n                                flags: [\"includeIdsOnly\"]\n                            })];\n                    case 3:\n                        prevTasks = _b.sent();\n                        prevTasks = prevTasks\n                            .filter(function (prevTask) { return !prevTask.done; }) // Don't copy done tasks\n                            .filter(function (prevTask) { return !!prevTask.name; }) // Don't copy empty learning goals\n                            .filter(function (prevTask) { return !userTasks_1.some(function (taskOfCurrentWeek) {\n                            return taskOfCurrentWeek.name === prevTask.name &&\n                                taskOfCurrentWeek.learningGoal === prevTask.learningGoal &&\n                                taskOfCurrentWeek.courseName === prevTask.courseName;\n                        }); }); // Ignore identical tasks (already copied)\n                        test = [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; }));\n                        latestTimeStamp_1 = Math.max.apply(Math.max, [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; })));\n                        copies = prevTasks.sort(compareProp(\"dateTime\")).map(function (task) {\n                            var copy = tslib_1.__assign({}, task, { dateTime: latestTimeStamp_1 += 1000 });\n                            copy.id = createUUID();\n                            if (copy.subTasks) {\n                                copy.subTasks = copy.subTasks.filter(function (st) { return !st.done; });\n                            }\n                            delete copy.$etag;\n                            return copy;\n                        });\n                        // Store it\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert(copies)];\n                    case 4:\n                        // Store it\n                        _b.sent();\n                        return [3 /*break*/, 6];\n                    case 5:\n                        this.setState({ isCopyingTasks: false });\n                        return [7 /*endfinally*/];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WeekPlanner.prototype.getHeaderTitle = function () {\n        return React.createElement(\"h4\", null,\n            React.createElement(FormattedMessage, { id: \"weekplanner.logBook\", defaultMessage: \"Loggbok\" }));\n    };\n    WeekPlanner.prototype.render = function () {\n        var _this = this;\n        var weekNumber = moment(this.state.weekDate).week();\n        var showProgressCharts = features.weekplannerCharts;\n        //console.log(\"Weekydate: \"  + new Date(this.state.weekDate) + \" which is week no \" + weekNumber);\n        var currentWeek = moment().week();\n        var taskSets = refine(this.state.userTasks);\n        var _a = this.state, dialogs = _a.dialogs, weekTextsUT = _a.weekTextsUT, strategy = _a.strategy, assessment = _a.assessment, isLoading = _a.isLoading, isCopyingTasks = _a.isCopyingTasks;\n        var isSaving = weekTextsUT && (weekTextsUT.$meta === 'adding' || weekTextsUT.$meta === 'updating');\n        var isStrategyEdited = !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy);\n        var isAssessmentEdited = !!weekTextsUT && (assessment !== weekTextsUT.weekTexts.assessment);\n        var enableSaveButton = !isSaving && (isStrategyEdited || isAssessmentEdited);\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\n        var chartTasks = getWeekplannerProgressData(taskSets);\n        var percentage = chartTasks.totalNumberOfTasks > 0 ? chartTasks.completedTasks / chartTasks.totalNumberOfTasks * 100 : 0;\n        return React.createElement(\"div\", null,\n            React.createElement(\"div\", { className: \"ked_boxed weekPlanner\" + (weekNumber === currentWeek ? \" currentWeek\" : \"\"), onKeyDown: function (ev) {\n                    if (ev.which === 83 && ev.ctrlKey) {\n                        ev.preventDefault();\n                        if (!isSaving && _this.isWeekTextsEdited()) {\n                            _this.weekTextsSavingJob.triggerChange(0);\n                        }\n                    }\n                } },\n                showProgressCharts && chartTasks.totalNumberOfTasks > 0 && this.getHeaderTitle(),\n                React.createElement(\"div\", { className: \"widgets\" },\n                    showProgressCharts && chartTasks.totalNumberOfTasks > 0 ? React.createElement(\"div\", { className: \"progressBar\" },\n                        React.createElement(Progress, { percentage: percentage })) : this.getHeaderTitle(),\n                    React.createElement(\"div\", { className: \"weekSelect\" },\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\n                            React.createElement(\"p\", null,\n                                React.createElement(FormattedMessage, { id: \"weekplanner.weekNumber\", values: { weekNumber: weekNumber }, defaultMessage: \"Vecka {weekNumber}\" }))),\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\n                            React.createElement(\"div\", { className: \"btn-group\" },\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.prevWeek(); } },\n                                    React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.nextWeek(); } },\n                                    React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" })))))),\n                taskSets.length > 0 && React.createElement(\"hr\", null),\n                taskSets.map(function (props) {\n                    return React.createElement(UserTasksBox, tslib_1.__assign({ key: props.courseName }, props, { courseName: props.courseName, learningGoals: props.learningGoals, viewCourseUrl: _this.props.viewCourseUrl, openCourses: _this.state.openCourses, addOwnTask: function (courseName, learningGoalName) { return _this.openAddOwnTaskDialog(courseName, learningGoalName); }, setIsOpen: _this.setIsOpen.bind(_this), setTaskDone: _this.setTaskDone.bind(_this), setSubTaskDone: _this.setSubTaskDone.bind(_this), editTask: function (task) { return _this.editTask(task); }, editSubTask: function (task, subTask) { return _this.editSubTask(task, subTask); }, removeLearningGoal: function (lg) { return _this.removeLearningGoal(lg); }, displayProgress: showProgressCharts, progressData: chartTasks.subjectData[props.courseName] }));\n                }),\n                React.createElement(\"hr\", null),\n                isLoading ? React.createElement(Spinner, null) : React.createElement(\"div\", null,\n                    React.createElement(\"div\", { className: \"btn\", onClick: function (ev) { return _this.openAddGoalDialog(); } },\n                        React.createElement(\"i\", { className: \"fa fa-list-alt\", \"aria-hidden\": \"true\" }),\n                        isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalPrimary\", defaultMessage: \"Eget l\\u00E4randem\\u00E5l\" })),\n                    React.createElement(\"div\", { className: \"btn\", style: isCopyingTasks ? { opacity: 0.5 } : undefined, onClick: function (ev) { return (!isCopyingTasks) && _this.copyFromPreviousWeek(); } },\n                        React.createElement(\"i\", { className: \"fa fa-clone\", \"aria-hidden\": \"true\" }),\n                        React.createElement(FormattedMessage, { id: \"weekplanner.copyPreviousWeekTaks\", defaultMessage: \"Kopiera ej klara fr\\u00E5n f\\u00F6reg\\u00E5ende vecka\" })),\n                    React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null,\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyAndEvaluation\", defaultMessage: \"Strategi & Utv\\u00E4rdering\" })), headerOpen: this.state.openCourses[\"StratUtv\"], onOpenClose: function (becameOpen) { return _this.setIsOpen(\"StratUtv\", becameOpen); } },\n                        React.createElement(\"h3\", null,\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategy\", defaultMessage: \"Strategi\" })),\n                        React.createElement(\"p\", null,\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyDescription\", defaultMessage: \"Hur jag ska g\\u00F6ra f\\u00F6r att l\\u00E4ra mig.\" })),\n                        React.createElement(\"hr\", null),\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", disabled: this.props.env.tutored, value: strategy && strategy.substr(0, MAX_STRATEGY_LENGTH), onChange: function (ev) {\n                                _this.setState({ strategy: (ev.target.value || '').substr(0, MAX_STRATEGY_LENGTH) });\n                                _this.weekTextsSavingJob.triggerChange(500);\n                            } }),\n                        React.createElement(\"h3\", null,\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluation\", defaultMessage: \"Utv\\u00E4rdering\" })),\n                        React.createElement(\"p\", null,\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluationDescription\", defaultMessage: \"Reflektion kring din arbetsinsats och dina valda strategier under veckan.Utv\\u00E4rdera i f\\u00F6rh\\u00E5llande till dina m\\u00E5l.\" })),\n                        React.createElement(\"hr\", null),\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", value: assessment && assessment.substr(0, MAX_ASSESSMENT_LENGTH), disabled: this.props.env.tutored, onChange: function (ev) {\n                                _this.setState({ assessment: (ev.target.value || '').substr(0, MAX_ASSESSMENT_LENGTH) });\n                                _this.weekTextsSavingJob.triggerChange(500);\n                            } }),\n                        React.createElement(\"div\", { className: \"btn\", tabIndex: 0, style: enableSaveButton ? {} : { opacity: 0.5 }, onClick: function () { return !isSaving && _this.weekTextsSavingJob.triggerChange(0); } },\n                            React.createElement(\"i\", { className: \"fa fa-floppy-o\", \"aria-hidden\": \"true\" }),\n                            enableSaveButton ? React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \" Spara\" }) : React.createElement(FormattedMessage, { id: \"common.saved\", defaultMessage: \" Sparad\" }))))),\n            React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () {\n                    _this.setState(function (_a) {\n                        var dialogs = _a.dialogs;\n                        return ({ dialogs: dialogs.slice(0, dialogs.length - 1) });\n                    });\n                } }));\n    };\n    WeekPlanner.contextType = LanguageContext;\n    return WeekPlanner;\n}(React.Component));\nexport { WeekPlanner };\n","import * as tslib_1 from \"tslib\";\nimport * as kedComponents from './kedcomponents';\nimport { setupIntl } from '../../components/utility-components/SetupLanguageIntl';\nimport { injectIntl } from 'react-intl';\n// <TEMPORARY FIX>\n// Need as current production has the old SubjectPlanner URLs,\n// while the newest version has new pages for them!\n// REMOVE AFTER GOING TO PRODUCTION AND HAVING THE VALUE CONFIGURED IN ELEMENTS!\nimport { cfg } from '../../globals/KED.cfg';\ncfg.KED_SUBJECT_PLANNER_URL = '/ap/amnesplaneraren';\ncfg.KED_SUBJECT_PLANNER_ADMIN_URL = '/ap/amnesplanerarenadmin';\n// </TEMPORARY FIX>\nvar intlComponents = {};\nObject.keys(kedComponents).forEach(function (k) {\n    intlComponents[k] = setupIntl(injectIntl(kedComponents[k]));\n});\nexport var components = tslib_1.__assign({}, intlComponents);\n","import '../../global-setters/set-all';\nimport env from '../../globals/KED.env';\nenv.bearerProvider.getBearer(); // Start getting bearer as soon as possible.\nenv.googleTokenProvider.getBearer(); // Start getting google bearer as soon as possible.\n// Common components\nexport { CalendarSelf as Calendar, } from '../../components/calendar/calendar-self';\nexport { CalendarTutored } from '../../components/calendar/calendar-tutored';\nexport { WeekPlannerSelf as WeekPlanner } from '../../components/weekplanner/weekplanner-self';\nexport { WeekPlannerTutored } from '../../components/weekplanner/weekplanner-tutored';\nexport { LatestAssessments } from '../../components/latest-assessments/latest-assessments';\nexport { LearningTasks } from '../../components/learning-tasks';\nexport { RootWeekNotebook as WeekNotebook } from '../../components/week-notebook';\nexport { TutorsSelect } from '../../components/tutors-select/tutors-select';\n// KG only\nexport { KGTermPlannerSelf as KGTermPlanner } from '../../components/kg-termplanner/kg-termplanner-self';\nexport { KGTermPlannerTutored } from '../../components/kg-termplanner/kg-termplanner-tutored';\nexport { ListCourses } from '../../components/list-courses/list-courses';\n// KS only\nexport { KSTermPlannerSelf as KSTermPlanner } from '../../components/ks-termplanner/ks-termplanner-self';\nexport { KSTermPlannerTutored } from '../../components/ks-termplanner/ks-termplanner-tutored';\nexport { KSGoals } from '../../components/ks-goals/goals';\nexport { MyCourses } from '../../components/my-courses/my-courses';\nexport { MySubjects } from '../../components/my-subjects/my-subjects';\n","import * as tslib_1 from \"tslib\";\nimport KED from '../../globals/KED';\nimport { components } from './kedcomponents.client';\nKED.components = tslib_1.__assign({}, KED.components, components);\n","import * as tslib_1 from \"tslib\";\nimport { parseQueryString } from '../utils/query-string';\nimport FeatureDescriptions from './feature-flags.json';\nimport { cfg } from '../globals/KED.cfg';\nvar Features = /** @class */ (function () {\n    function Features() {\n        var e_1, _a;\n        this._initialized = false;\n        var _loop_1 = function (featureName) {\n            Object.defineProperty(this_1, featureName, {\n                get: function () {\n                    if (!this._initialized)\n                        this.init();\n                    return this._features[featureName];\n                },\n                set: function (value) {\n                    throw new Error('Feature flags cannot be set here');\n                }\n            });\n        };\n        var this_1 = this;\n        try {\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var featureName = _c.value;\n                _loop_1(featureName);\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n    }\n    Features.prototype.init = function () {\n        var e_2, _a;\n        if (this._initialized)\n            return;\n        var turnedOnFeatures = (cfg.KED_FEATURES || \"\").split(',').map(function (name) { return name.trim().toLowerCase(); });\n        var query = parseQueryString(location.search, { toLower: true });\n        if (query.testversion) {\n            turnedOnFeatures = [\"*\"];\n        }\n        if (query.features) {\n            turnedOnFeatures = query.features\n                .split(',')\n                .map(function (feature) { return feature.trim().toLowerCase(); });\n        }\n        var turnOnAll = turnedOnFeatures.includes('*');\n        this._features = {};\n        try {\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var featureName = _c.value;\n                this._features[featureName] = turnOnAll ||\n                    turnedOnFeatures.includes(featureName.toLowerCase());\n            }\n        }\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_2) throw e_2.error; }\n        }\n        this._initialized = true;\n    };\n    return Features;\n}());\nexport { Features };\nexport var features = new Features();\n","export * from './features';\n","import cfg from '../globals/KED.cfg';\ncfg.ENVIRONMENT = process.env.ENVIRONMENT;\ncfg.KED_API_URL = process.env.KED_API_URL; // \"https://kedbackendtest.azurewebsites.net/api/\"\ncfg.EDS_API_URL = process.env.EDS_API_URL; // \"https://edsportalowinapi.azurewebsites.net/api/\"\ncfg.KED_TOKEN_URL = process.env.KED_TOKEN_URL; // \"https://kedauthtest.azurewebsites.net/token\"\ncfg.KED_CLIENT_ID = process.env.KED_CLIENT_ID; // \"devclient\", \"testclient\", \"...\"\ncfg.KED_CLIENT_SECRET = process.env.KED_CLIENT_SECRET;\ncfg.KED_REALM = process.env.KED_REALM; // \"SE1\"\ncfg.KED_LOCALE = cfg.KED_LOCALE || process.env.KED_LOCALE; // \"sv\", \"en\". Only set from process.env if not set from SiteVision element config.\ncfg.KED_SCHOOL_LOCALE = cfg.KED_SCHOOL_LOCALE || process.env.KED_SCHOOL_LOCALE; // \"sv\", \"en_sin\", \"en_nin\". Only set from process.env if not set from SiteVision element config.\ncfg.KED_RESOURCES_URL = cfg.KED_RESOURCES_URL || process.env.KED_RESOURCES_URL;\n","/* These scripts assume some of the global vars have already been set:\n  * KED.cfg\n  * KED.env.currentUser\n\n  The rest will be set here (client side)\n*/\nimport './configure';\nimport './set-bearer-providers';\nimport './set-ked-backend-client';\nimport './set-eds-client';\n","import * as tslib_1 from \"tslib\";\nimport { parseQueryString, generateQueryString, splitUrlAndQuery } from \"../utils/query-string\";\nimport { WebServerBearerProvider, isomorphic, storage } from 'kedbackend/clientweb';\nimport { KedBearerProvider } from 'kedbackend/client';\nimport cfg from '../globals/KED.cfg';\nimport env from '../globals/KED.env';\nimport { IMPERSONATION_QUERY_PARAMS } from \"../access-control/index\";\nimport { cherryPickProps } from \"../utils/utils\";\nvar employeeClassroomScopes = [\n    \"https://www.googleapis.com/auth/classroom.courses\",\n    \"https://www.googleapis.com/auth/classroom.profile.emails\",\n    \"https://www.googleapis.com/auth/classroom.rosters\",\n    \"https://www.googleapis.com/auth/classroom.coursework.students\"\n];\nvar studentClassroomScopes = [\n    \"https://www.googleapis.com/auth/classroom.courses\",\n    \"https://www.googleapis.com/auth/classroom.coursework.me\"\n];\nfunction getMergedTokenPath(tokenPath, locationSearch, scopes) {\n    // Merge configured query params of token path with params given to current page\n    var currentQuery = parseQueryString(locationSearch);\n    var impersonationProps = cherryPickProps(currentQuery, IMPERSONATION_QUERY_PARAMS);\n    var _a = tslib_1.__read(splitUrlAndQuery(tokenPath), 2), tokenPathWithoutQuery = _a[0], tokenQueryString = _a[1];\n    var tokenPathQuery = parseQueryString(tokenQueryString);\n    return tokenPathWithoutQuery + generateQueryString(tslib_1.__assign({}, tokenPathQuery, impersonationProps, { scopes: scopes.join(',') }));\n}\nfunction getTokenId(mergedTokenPath, userEmail) {\n    return mergedTokenPath + \"/\" + userEmail;\n}\nfunction saveUserInfo(user, tokenId) {\n    env.currentUser = user;\n    var schoolgrade = parseQueryString(location.search, { toLower: true }).schoolgrade;\n    if (schoolgrade) {\n        var schoolGradeInt = parseInt(schoolgrade);\n        env.currentUser.schoolGrade = schoolGradeInt;\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\n    }\n    sessionStorage.setItem(\"userInfo\" + tokenId, JSON.stringify(user));\n}\nfunction loadUserInfo(tokenId) {\n    var storedSessionUser = sessionStorage.getItem(\"userInfo\" + tokenId);\n    if (storedSessionUser) {\n        env.currentUser = JSON.parse(storedSessionUser);\n    }\n}\nfunction createBearerProvider(mergedTokenPath, userEmail) {\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\n        var res = JSON.parse(responseText);\n        if (!res.ok)\n            throw new Error(res.error);\n        if (res.user) {\n            saveUserInfo(res.user, tokenId);\n        }\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\n    }, tokenId);\n}\nfunction createGoogleTokenProvider(mergedTokenPath, userEmail) {\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\n        var res = JSON.parse(responseText);\n        if (!res.ok)\n            throw new Error(res.error);\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\n    }, tokenId);\n}\nfunction createTestTokenProvider(tokenUrl, user, scopes) {\n    return new KedBearerProvider(isomorphic, storage, tokenUrl + user.mail + location.search, cfg.KED_CLIENT_ID, cfg.KED_CLIENT_SECRET, tokenUrl, {\n        email: user.mail.toLowerCase(),\n        roles: user.roles,\n        school: user.school,\n        schoolType: user.schoolType,\n        scopes: scopes,\n        name: user.displayName\n    });\n}\n// env.currentUser.mail is set by SiteVision server initially.\n// A response from /api/token may change the mail attribute of the current\n// user, so env.currentUser.mail may be different after getting a response.\n// However, the initial value is valuable always in order to distinguish the case\n// when one normal user logs out and another user logs in.\nvar initialUserEmail = env.currentUser && env.currentUser.mail; // Initial value of mail. May change.\nif (initialUserEmail) {\n    // KED\n    if (cfg.KED_TOKEN_PATH) {\n        //\n        //\n        // Production / SiteVision proxied /api/token to request tokens from:\n        //\n        //\n        var mergedTokenPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, [\n            \"kedbackend\",\n            \"EDS\",\n        ]);\n        env.bearerProvider = createBearerProvider(mergedTokenPath, initialUserEmail);\n        loadUserInfo(getTokenId(mergedTokenPath, initialUserEmail));\n        var scopes = [\n            \"https://www.googleapis.com/auth/calendar.readonly\",\n            \"https://www.googleapis.com/auth/drive\"\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\n            ? employeeClassroomScopes\n            : studentClassroomScopes);\n        // Google\n        var googleMergedPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, scopes);\n        env.googleTokenProvider = createGoogleTokenProvider(googleMergedPath, initialUserEmail);\n    }\n    else if (cfg.KED_TOKEN_URL && cfg.KED_CLIENT_ID && cfg.KED_CLIENT_SECRET) {\n        //\n        //\n        // Test - go directly to KEDAUTH server to retrieve tokens\n        //\n        //\n        env.bearerProvider = createTestTokenProvider(cfg.KED_TOKEN_URL, env.currentUser, [\n            \"kedbackend\",\n            \"EDS\",\n        ]);\n        var scopes = [\n            \"https://www.googleapis.com/auth/calendar.readonly\",\n            \"https://www.googleapis.com/auth/drive\"\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\n            ? employeeClassroomScopes\n            : studentClassroomScopes);\n        env.googleTokenProvider = createTestTokenProvider(cfg.KED_TOKEN_URL + \"/google\", env.currentUser, scopes);\n    }\n    else {\n        throw new Error(\"Missing configuration parameter KED_TOKEN_PATH\");\n    }\n}\n","import env from '../globals/KED.env';\nimport cfg from '../globals/KED.cfg';\nimport { isomorphic } from 'kedbackend/clientweb';\nimport { EdsClient } from '../apis/edsclient';\nenv.edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, env.bearerProvider, function () { return env.currentUser.mail; });\n","import env from '../globals/KED.env';\nimport cfg from '../globals/KED.cfg';\nimport { KedBackendClientWeb } from 'kedbackend/clientweb';\nenv.kedBackendClient = new KedBackendClientWeb(cfg.KED_API_URL, env.bearerProvider);\n","import KED from './KED';\n;\nif (!KED.cfg)\n    KED.cfg = {};\nexport default KED.cfg;\nexport var cfg = KED.cfg;\n","import KED from './ked';\nif (!KED.env)\n    KED.env = {};\nexport default KED.env;\nexport var env = KED.env;\n","export var KED_NAMESPACE = \"KED\";\nvar result = typeof KED === 'undefined' ? {} : KED;\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\n    window[KED_NAMESPACE] = result;\n}\nexport default result;\n","import * as tslib_1 from \"tslib\";\nimport KED from './ked';\nvar TutorEnv = /** @class */ (function () {\n    function TutorEnv() {\n        this.subscribers = [];\n        this.env = null;\n        this.version = 1;\n    }\n    //promise: Promise<Env | null> = Promise.resolve(null);\n    TutorEnv.prototype.subscribe = function (subscriber) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                this.subscribers.push(subscriber);\n                subscriber(this.env);\n                return [2 /*return*/];\n            });\n        });\n    };\n    TutorEnv.prototype.unsubscribe = function (subscriber) {\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\n    };\n    TutorEnv.prototype.notifySubscribers = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                this.subscribers.forEach(function (s) { return s(_this.env); });\n                return [2 /*return*/];\n            });\n        });\n    };\n    TutorEnv.prototype.setNewEnv = function (user, envGetter) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var version, env;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        version = ++this.version;\n                        this.env = { currentUser: user, tutored: true };\n                        this.notifySubscribers(); // Make subscriber display \"Loading... user name\"\n                        return [4 /*yield*/, envGetter().catch(function (err) { return ({\n                                currentUser: user,\n                                tutored: true,\n                                error: err\n                            }); })];\n                    case 1:\n                        env = _a.sent();\n                        if (version === this.version) {\n                            // No one else has called setEnv during this call.\n                            ++this.version;\n                            this.env = tslib_1.__assign({}, env, { tutored: true });\n                            this.notifySubscribers(); // Make subscribers display the data.\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return TutorEnv;\n}());\nexport { TutorEnv };\nif (!KED.tutorEnv)\n    KED.tutorEnv = new TutorEnv();\nexport default KED.tutorEnv;\n","import env from './KED.env';\nimport { KedBackendRepo } from 'kedbackend/repo';\nimport { getGlobalId, createUUID } from 'kedbackend/client';\nimport cfg from './KED.cfg';\nif (!env.db) {\n    // Put db on env so that it is shared between subject planner and other components!\n    env.db = new KedBackendRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser ?\n        env.currentUser.mail :\n        \"\"; }, function () { return env.currentUser ?\n        env.currentUser.displayName || env.currentUser.mail :\n        \"\"; });\n}\nexport var db = env.db;\nexport var globalId = getGlobalId(cfg.KED_REALM);\nexport var Schools = {\n    standardSchool: db.schools.name(\"standard\").cacheOptimized().single(),\n    get mySchool() { return db.schools.name(env.currentUser.school).cacheOptimized().single(); }\n};\nexport var CourseInstances = {\n    getBranchId: function (school, courseId) {\n        return school.switchMap(function (school) {\n            return db.branches\n                .hasEdgesFrom([school.officialBranchId])\n                .name(\"draft\")\n                .tags(courseId)\n                .idsOnly()\n                .map(function (_a) {\n                var id = _a.id;\n                return id;\n            })\n                .toValue()\n                .map(function (ids) { return ids.length > 0 ? ids[0] : undefined; });\n        });\n    },\n    /** Get a DRAFT branch for given course ID and given school.\n     * If there is not yet such a branch, create it using mutationsOnEmpty() which will\n     * lead to the C# code DocumentRepository.ReadOrMutate() via DocumentController.\n     */\n    getOrCreateBranchId: function (school, courseId) {\n        return db.courseInstances.idsOnly().id(courseId).switchMap(function () {\n            return school.switchMap(function (school) {\n                return db.branches\n                    .hasEdgesFrom([school.officialBranchId])\n                    .name(\"draft\")\n                    .tags(courseId)\n                    .idsOnly()\n                    .mutationsOnEmpty(function (tx) {\n                    // These 2 mutations will occur server side, atomically.\n                    // Will be sent on each request in the query, but will only execute if query results in zero items.\n                    //console.log(\"School:\", school);\n                    var id = createUUID();\n                    tx.add(\"branches\", {\n                        id: id,\n                        acl: [\n                            \"role:USER:R\",\n                            \"schoolRole:\" + school.name + \"/EMPLOYEE:S\"\n                        ],\n                        name: 'draft',\n                        schoolId: school.id,\n                        treeParentId: school.officialBranchId,\n                        tags: [courseId]\n                    });\n                    // Approving the branch makes sure that it was created by an EMPLOYEE on given school.\n                    tx.link2(\"branches\", school.officialBranchId, \"approvedChildren\", id);\n                })\n                    .single()\n                    .map(function (_a) {\n                    var id = _a.id;\n                    return id;\n                });\n            });\n        });\n    },\n    getAllDescendantIds: function (courseId) {\n        return db.courseBlocks.tags(courseId).idsOnly().concat(db.courseContents.tags(courseId).idsOnly()).concat(db.courseTabs.tags(courseId).idsOnly()).concat(db.tasks.tags(courseId).idsOnly())\n            .map(function (x) { return x.id; });\n    }\n};\n","export var KED_NAMESPACE = \"KED\";\nvar result = typeof KED === 'undefined' ? {} : KED;\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\n    window[KED_NAMESPACE] = result;\n}\nexport default result;\n","import moment from 'moment';\nimport cfg from '../globals/KED.cfg';\nif (cfg.KED_LOCALE === \"sv\") {\n    moment.updateLocale('sv', {\n        months: 'januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december'.split('_'),\n        monthsShort: 'jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec'.split('_'),\n        weekdays: 'söndag_måndag_tisdag_onsdag_torsdag_fredag_lördag'.split('_'),\n        weekdaysShort: 'sön_mån_tis_ons_tor_fre_lör'.split('_'),\n        weekdaysMin: 'sö_må_ti_on_to_fr_lö'.split('_'),\n        longDateFormat: {\n            LT: 'HH:mm',\n            LTS: 'HH:mm:ss',\n            L: 'YYYY-MM-DD',\n            LL: 'D MMMM YYYY',\n            LLL: 'D MMMM YYYY [kl.] HH:mm',\n            LLLL: 'dddd D MMMM YYYY [kl.] HH:mm',\n            lll: 'D MMM YYYY HH:mm',\n            llll: 'ddd D MMM YYYY HH:mm'\n        },\n        calendar: {\n            sameDay: '[Idag] LT',\n            nextDay: '[Imorgon] LT',\n            lastDay: '[Igår] LT',\n            nextWeek: '[På] dddd LT',\n            lastWeek: '[I] dddd[s] LT',\n            sameElse: 'L'\n        },\n        relativeTime: {\n            future: 'om %s',\n            past: 'för %s sedan',\n            s: 'några sekunder',\n            ss: '%d sekunder',\n            m: 'en minut',\n            mm: '%d minuter',\n            h: 'en timme',\n            hh: '%d timmar',\n            d: 'en dag',\n            dd: '%d dagar',\n            M: 'en månad',\n            MM: '%d månader',\n            y: 'ett år',\n            yy: '%d år'\n        },\n        dayOfMonthOrdinalParse: /\\d{1,2}(e|a)/,\n        ordinal: function (number) {\n            var b = number % 10, output = (~~(number % 100 / 10) === 1) ? 'e' :\n                (b === 1) ? 'a' :\n                    (b === 2) ? 'a' :\n                        (b === 3) ? 'e' : 'e';\n            return number + output;\n        },\n        week: {\n            dow: 1,\n            doy: 4 // The week that contains Jan 4th is the first week of the year.\n        }\n    });\n}\nexport var localMoment = function () {\n    return moment.apply(this, arguments).locale(cfg.KED_LOCALE);\n};\n","import * as tslib_1 from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport env from '../globals/KED.env';\nimport { showError, flatten, compareProp, arrayToMap } from '../utils/utils';\nimport { createUUID } from 'kedbackend/client';\nimport { EDSPeriod } from '../apis/edsclient';\nimport { getSchoolMoment } from '../utils/school-moment';\nimport moment from 'moment';\nexport var hiddenCoursesRepo = env.hiddenCoursesRepo;\nvar HiddenCoursesRepo = /** @class */ (function () {\n    function HiddenCoursesRepo() {\n        var _this = this;\n        this.result = null;\n        this.subscribers = [];\n        this.fullCourse = false;\n        this.notifySubscriber = function (subscriber, options) {\n            try {\n                subscriber(options.fullCourse ? _this.result : _this.result.filter(function (c) { return c.visible; }));\n            }\n            catch (err) {\n                console.error(err);\n            }\n        };\n        this.kedRepo = new KedRepo({\n            getClient: function () { return env.kedBackendClient; },\n            optimistic: true,\n            table: \"userhiddencourses\",\n            user: env.currentUser ? env.currentUser.mail : \"\",\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {\n                return [2 /*return*/, ({ role: \"USER\" })];\n            }); }); },\n        });\n        var initPromise = this.init();\n        Promise.all([\n            initPromise,\n            this.kedCoursesPromise,\n            this.edsCoursesPromise\n        ]).catch(function (err) { return showError(err); });\n    }\n    HiddenCoursesRepo.prototype.init = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var bearerPromise, resolveUserHiddenCoursesPromise, userHiddenCoursesResolved;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        bearerPromise = env.bearerProvider ? env.bearerProvider.getBearer() : Promise.resolve({});\n                        // In parallell, we request:\n                        //  1) KEDBackend: Schools.activeCourses\n                        //  2) EDS.getActiveAcourses()\n                        //  3) (via subscription): KEDBackend: userHiddenCourses\n                        this.kedCoursesPromise = bearerPromise.then(function () { return _this.listKedCourses(); });\n                        this.edsCoursesPromise = bearerPromise.then(function () { return _this.listEDSCourses(); });\n                        userHiddenCoursesResolved = false;\n                        this.userHiddenCoursesPromise = new Promise(function (resolve) { return resolveUserHiddenCoursesPromise = function (x) {\n                            if (userHiddenCoursesResolved) {\n                                _this.userHiddenCoursesPromise = Promise.resolve(x);\n                            }\n                            else {\n                                userHiddenCoursesResolved = true;\n                                resolve(x);\n                            }\n                        }; });\n                        return [4 /*yield*/, bearerPromise];\n                    case 1:\n                        _a.sent();\n                        this.kedRepo.mem.subscribe(function (userHiddenCourses) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                            var _a, activeCourses, edsActiveCourses, _b;\n                            var _this = this;\n                            return tslib_1.__generator(this, function (_c) {\n                                switch (_c.label) {\n                                    case 0: return [4 /*yield*/, Promise.all([\n                                            this.kedCoursesPromise,\n                                            this.edsCoursesPromise\n                                        ])];\n                                    case 1:\n                                        _a = tslib_1.__read.apply(void 0, [_c.sent(), 2]), activeCourses = _a[0], edsActiveCourses = _a[1];\n                                        // Refine the three results into a single result\n                                        _b = this;\n                                        return [4 /*yield*/, this.createCoursesList(edsActiveCourses, userHiddenCourses, activeCourses)];\n                                    case 2:\n                                        // Refine the three results into a single result\n                                        _b.result = _c.sent();\n                                        // Notify our subscribers:\n                                        this.subscribers.forEach(function (subscriber) { return _this.notifySubscriber(subscriber.subscriber, subscriber.options); });\n                                        resolveUserHiddenCoursesPromise(userHiddenCourses);\n                                        return [2 /*return*/];\n                                }\n                            });\n                        }); });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.listKedCourses = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var fullCourse, schools, activeCourses;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        fullCourse = this.fullCourse;\n                        console.log(\"FullCourse: \" + fullCourse);\n                        return [4 /*yield*/, env.kedBackendClient.list('schools', {\n                                role: \"USER\",\n                                name: env.currentUser.school,\n                                include: \"activeCourses\",\n                                flags: fullCourse ? [] : [\"includeIdsAndNamesOnly\"],\n                                cacheBust: env.currentUser.username\n                            })];\n                    case 1:\n                        schools = _a.sent();\n                        activeCourses = flatten(schools.map(function (school) { return school.activeCourses; })).sort(compareProp(\"name\"));\n                        return [2 /*return*/, activeCourses];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.listEDSCourses = function () {\n        var periodName = new EDSPeriod(getSchoolMoment(moment())).period;\n        return env.currentUser.roles.indexOf('EMPLOYEE') === -1 ?\n            // STUDENTs should, by default, only show courses that is listed in EDS\n            env.edsClient.getActiveCourses({ periodName: periodName }) :\n            // EMPLOYEEs should, by default, show all courses on school - no need to query EDS\n            null;\n    };\n    HiddenCoursesRepo.prototype.createCoursesList = function (edsActiveCourses, userHiddenCourses, activeCourses) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var hiddenCoursesMap, visibleCoursesMap, isStudent, edsCourseMap, result;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        hiddenCoursesMap = arrayToMap(userHiddenCourses.filter(function (hc) { return !hc.show; }), function (hc) { return hc.name; });\n                        visibleCoursesMap = arrayToMap(userHiddenCourses.filter(function (hc) { return hc.show; }), function (hc) { return hc.name; });\n                        isStudent = env.currentUser.roles.some(function (role) { return role === 'STUDENT'; });\n                        edsCourseMap = edsActiveCourses ?\n                            arrayToMap(edsActiveCourses, function (c) { return c.name; }) :\n                            {};\n                        return [4 /*yield*/, Promise.all(activeCourses.map(function (_a) {\n                                var id = _a.id, name = _a.name, description = _a.description, modifiedBy = _a.modifiedBy;\n                                return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                                    var edsCourse, defaultVisible, visible;\n                                    return tslib_1.__generator(this, function (_b) {\n                                        edsCourse = edsCourseMap[name];\n                                        defaultVisible = isStudent ?\n                                            edsCourse != null : // Course name also listed in EDS\n                                            true;\n                                        visible = defaultVisible ?\n                                            !hiddenCoursesMap[id] : // Visible unless user has overridden that.\n                                            !!visibleCoursesMap[id];\n                                        // Resolve description:\n                                        if (modifiedBy && modifiedBy.name && !description) {\n                                            description = modifiedBy.name + \"s version\";\n                                        }\n                                        return [2 /*return*/, {\n                                                id: id,\n                                                name: name,\n                                                description: description,\n                                                visible: visible,\n                                                defaultVisible: defaultVisible\n                                            }];\n                                    });\n                                });\n                            }))];\n                    case 1:\n                        result = _a.sent();\n                        return [2 /*return*/, result.sort(function (_a, _b) {\n                                var a = _a.name;\n                                var b = _b.name;\n                                return a < b ? -1 : a > b ? 1 : 0;\n                            })];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.hideCourse = function (c) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var overrides;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        overrides = this.kedRepo.mem.items.filter(function (hc) { return hc.name === c.id; });\n                        if (!c.defaultVisible) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.kedRepo.insert([{\n                                    id: createUUID(),\n                                    name: c.id\n                                }])];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, this.kedRepo.delete(overrides.map(function (ov) { return ov.id; }))];\n                    case 3:\n                        _a.sent();\n                        _a.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.showCourse = function (c) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var overrides;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        overrides = this.kedRepo.mem.items.filter(function (hc) { return hc.name === c.id; });\n                        if (!c.defaultVisible) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.kedRepo.delete(overrides.map(function (ov) { return ov.id; }))];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, this.kedRepo.insert([{\n                                id: createUUID(),\n                                name: c.id,\n                                show: true\n                            }])];\n                    case 3:\n                        _a.sent();\n                        _a.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.subscribe = function (subscriber, options) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, activeCourses, edsActiveCourses, userHiddenCourses, _b;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        if (!(!this.fullCourse && options.fullCourse)) return [3 /*break*/, 3];\n                        // The subscriber demands full courses\n                        // Need to query that before notifying\n                        // Also affect state for future internal notification\n                        this.fullCourse = options.fullCourse;\n                        this.kedCoursesPromise = this.listKedCourses(); // Redo this call, now loading full courses\n                        return [4 /*yield*/, Promise.all([\n                                this.kedCoursesPromise,\n                                this.edsCoursesPromise,\n                                this.userHiddenCoursesPromise\n                            ])];\n                    case 1:\n                        _a = tslib_1.__read.apply(void 0, [_c.sent(), 3]), activeCourses = _a[0], edsActiveCourses = _a[1], userHiddenCourses = _a[2];\n                        // Assemble result:\n                        _b = this;\n                        return [4 /*yield*/, this.createCoursesList(edsActiveCourses, userHiddenCourses, activeCourses)];\n                    case 2:\n                        // Assemble result:\n                        _b.result = _c.sent();\n                        _c.label = 3;\n                    case 3: return [4 /*yield*/, this.userHiddenCoursesPromise];\n                    case 4:\n                        _c.sent(); // So we know that this.result is there.\n                        this.notifySubscriber(subscriber, options);\n                        this.subscribers.push({ subscriber: subscriber, options: options });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    HiddenCoursesRepo.prototype.unsubscribe = function (subscriber) {\n        this.subscribers = this.subscribers.filter(function (s) { return s.subscriber !== subscriber; });\n    };\n    return HiddenCoursesRepo;\n}());\nif (!hiddenCoursesRepo) {\n    hiddenCoursesRepo = env.hiddenCoursesRepo = new HiddenCoursesRepo();\n}\n","import * as tslib_1 from \"tslib\";\nimport { Repo } from './repo';\nimport { BatchRunner, createUUID } from 'kedbackend/client';\nvar KedRepo = /** @class */ (function () {\n    function KedRepo(options) {\n        var _this = this;\n        var table = options.table, getClient = options.getClient, getQueryOptions = options.getQueryOptions;\n        this.mem = new Repo({ query: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var queryOptions;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0: return [4 /*yield*/, getQueryOptions()];\n                        case 1:\n                            queryOptions = _a.sent();\n                            return [4 /*yield*/, getClient().list(table, tslib_1.__assign({}, queryOptions, { cacheBust: this.getCacheBust() }))];\n                        case 2: return [2 /*return*/, _a.sent()];\n                    }\n                });\n            }); } });\n        this.options = options;\n    }\n    KedRepo.prototype.getCacheBust = function () {\n        var _a = this.options, table = _a.table, user = _a.user;\n        var cacheBust = localStorage.getItem('cache-bust-' + table + '-' + user);\n        return cacheBust || this.regenerateCacheBust();\n    };\n    KedRepo.prototype.regenerateCacheBust = function () {\n        var _a = this.options, table = _a.table, user = _a.user;\n        var cacheBust = createUUID();\n        localStorage.setItem('cache-bust-' + table + '-' + user, cacheBust);\n        return cacheBust;\n    };\n    KedRepo.prototype.upsert = function (item, updater) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var updatedItem;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!!item.$etag) return [3 /*break*/, 2];\n                        updatedItem = Object.assign({}, item);\n                        updater(updatedItem);\n                        return [4 /*yield*/, this.insert([updatedItem])];\n                    case 1: return [2 /*return*/, _a.sent()];\n                    case 2: \n                    // We have an $etag, so we can expect it to live on the server.\n                    // However, take care of the unlikely situation that it was deleted from server,\n                    // and if so, insert it again.\n                    return [4 /*yield*/, this.update([item], updater).catch(function (e) {\n                            if (e.name === \"http404\") {\n                                var updatedItem = Object.assign({}, item);\n                                updater(updatedItem);\n                                return _this.insert([updatedItem]);\n                            }\n                            return Promise.reject(e);\n                        })];\n                    case 3:\n                        // We have an $etag, so we can expect it to live on the server.\n                        // However, take care of the unlikely situation that it was deleted from server,\n                        // and if so, insert it again.\n                        _a.sent();\n                        _a.label = 4;\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedRepo.prototype.update = function (items, updater) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, getClient, optimistic, table, client, modifiedItems, res;\n            var _this = this;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\n                        client = getClient();\n                        modifiedItems = items.map(function (item) {\n                            var memRepoItem = _this.mem.items.find(function (it) { return it.id === item.id; });\n                            item = Object.assign({}, memRepoItem || item);\n                            updater(item);\n                            return item;\n                        });\n                        if (!optimistic) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.mem.update(modifiedItems.map(function (x) { return Object.assign({}, x, { $meta: 'updating' }); }))];\n                    case 1:\n                        _b.sent();\n                        _b.label = 2;\n                    case 2: return [4 /*yield*/, client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); })\n                            .catch(function (e) { return e.name === \"http409\" ? // conflict\n                            // Get a fresh version from server:\n                            client.list(table, { ids: items.map(function (item) { return item.id; }) }, { cache: 'no-cache' }).then(function (freshItems) {\n                                // Update local version:\n                                var modifiedItems = freshItems.map(function (freshItem) {\n                                    // Clone the fresh item\n                                    var modified = Object.assign({}, freshItem);\n                                    // Re-run the updater on the clone:\n                                    updater(modified);\n                                    return modified;\n                                });\n                                // Re-do the the put operation towards the server.\n                                return client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); });\n                            }) :\n                            // Other unexpected error:\n                            Promise.resolve(optimistic &&\n                                _this.mem.update(items)) // Undo optimistic update\n                                .then(function () {\n                                return Promise.reject(e); // Reject with the error no matter.\n                            }); })];\n                    case 3:\n                        res = _b.sent();\n                        this.regenerateCacheBust();\n                        modifiedItems.forEach(function (item) {\n                            item.$etag = res.newEtags[item.id];\n                            item.$meta = undefined;\n                        });\n                        return [4 /*yield*/, this.mem.update(modifiedItems)];\n                    case 4:\n                        _b.sent(); // Ensures new etag is is applied on next action.\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedRepo.prototype.stripGraphs = function (items, graphs) {\n        return items.map(function (item) {\n            var clone = Object.assign({}, item);\n            graphs.forEach(function (graph) {\n                if (item[graph]) {\n                    clone[graph] = item[graph].map(function (doc) { return ({ id: doc.id }); });\n                }\n            });\n            return clone;\n        });\n    };\n    KedRepo.prototype.insert = function (items) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, getClient, optimistic, table, getQueryOptions, client, queryOptions, graphs, stripped, br, _loop_1, stripped_1, stripped_1_1, item, res;\n            var e_1, _b;\n            var _this = this;\n            return tslib_1.__generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table, getQueryOptions = _a.getQueryOptions;\n                        client = getClient();\n                        return [4 /*yield*/, getQueryOptions()];\n                    case 1:\n                        queryOptions = _c.sent();\n                        graphs = [].concat(queryOptions.include);\n                        // Give IDs to each item:\n                        items = items.map(function (item) { return item.id ? item : Object.assign({}, item, { id: createUUID() }); });\n                        stripped = this.stripGraphs(items, graphs);\n                        if (!optimistic) return [3 /*break*/, 3];\n                        return [4 /*yield*/, this.mem.insert(stripped.map(function (x) { return Object.assign({}, x, { $meta: 'adding' }); }))];\n                    case 2:\n                        _c.sent();\n                        _c.label = 3;\n                    case 3:\n                        br = new BatchRunner();\n                        _loop_1 = function (item) {\n                            var e_2, _a;\n                            var _loop_2 = function (graph) {\n                                var foreignItems = item[graph];\n                                if (foreignItems) {\n                                    foreignItems.forEach(function (doc) {\n                                        br.link2(table, item.id, graph, doc.id);\n                                    });\n                                }\n                            };\n                            try {\n                                // Also add links to all foreign related items:\n                                for (var graphs_1 = (e_2 = void 0, tslib_1.__values(graphs)), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\n                                    var graph = graphs_1_1.value;\n                                    _loop_2(graph);\n                                }\n                            }\n                            catch (e_2_1) { e_2 = { error: e_2_1 }; }\n                            finally {\n                                try {\n                                    if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\n                                }\n                                finally { if (e_2) throw e_2.error; }\n                            }\n                            br.add(table, item);\n                        };\n                        try {\n                            for (stripped_1 = tslib_1.__values(stripped), stripped_1_1 = stripped_1.next(); !stripped_1_1.done; stripped_1_1 = stripped_1.next()) {\n                                item = stripped_1_1.value;\n                                _loop_1(item);\n                            }\n                        }\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n                        finally {\n                            try {\n                                if (stripped_1_1 && !stripped_1_1.done && (_b = stripped_1.return)) _b.call(stripped_1);\n                            }\n                            finally { if (e_1) throw e_1.error; }\n                        }\n                        return [4 /*yield*/, client.batch(br.mutationRequests).catch(function (e) {\n                                if (optimistic)\n                                    _this.mem.delete(items.map(function (item) { return item.id; }));\n                                return Promise.reject(e);\n                            })];\n                    case 4:\n                        res = _c.sent();\n                        this.regenerateCacheBust();\n                        items.forEach(function (item) { return item.$etag = res.newEtags[item.id]; });\n                        if (!optimistic) return [3 /*break*/, 6];\n                        return [4 /*yield*/, this.mem.update(items)];\n                    case 5:\n                        _c.sent(); // Update with new $etag.\n                        return [3 /*break*/, 8];\n                    case 6: return [4 /*yield*/, this.mem.insert(items)];\n                    case 7:\n                        _c.sent();\n                        _c.label = 8;\n                    case 8: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    KedRepo.prototype.delete = function (ids) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, getClient, optimistic, table, client, res;\n            var _this = this;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\n                        client = getClient();\n                        if (!optimistic) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.mem.update(ids\n                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\n                                .filter(function (x) { return x; })\n                                .map(function (x) { return Object.assign({}, x, { $meta: 'deleting' }); }))];\n                    case 1:\n                        _b.sent();\n                        _b.label = 2;\n                    case 2: return [4 /*yield*/, client.do(function (br) { return ids.forEach(function (id) { return br.delete(table, id); }); }).catch(function (e) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                            var _this = this;\n                            return tslib_1.__generator(this, function (_a) {\n                                switch (_a.label) {\n                                    case 0:\n                                        if (!optimistic) return [3 /*break*/, 2];\n                                        return [4 /*yield*/, this.mem.update(ids\n                                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\n                                                .filter(function (x) { return x; })\n                                                .map(function (x) {\n                                                x = Object.assign({}, x);\n                                                delete x.$meta;\n                                                return x;\n                                            }))];\n                                    case 1:\n                                        _a.sent();\n                                        _a.label = 2;\n                                    case 2: throw e;\n                                }\n                            });\n                        }); })];\n                    case 3:\n                        res = _b.sent();\n                        this.regenerateCacheBust();\n                        return [4 /*yield*/, this.mem.delete(ids)];\n                    case 4:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return KedRepo;\n}());\nexport { KedRepo };\n","import * as tslib_1 from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport env from '../globals/KED.env';\nimport { getTermStarEndDate } from '../utils/school-moment';\nvar KGTermPlannerRepo = /** @class */ (function (_super) {\n    tslib_1.__extends(KGTermPlannerRepo, _super);\n    function KGTermPlannerRepo(getClient, getCurrentUser) {\n        var _this = this;\n        var currentUser = getCurrentUser();\n        var now = new Date();\n        var _a = tslib_1.__read(getTermStarEndDate(now, now.getMonth() >= 7), 2), termStart = _a[0], termEnd = _a[1];\n        _this = _super.call(this, {\n            getClient: getClient,\n            optimistic: true,\n            table: \"weekplans\",\n            user: currentUser ? currentUser.mail : \"\",\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    return [2 /*return*/, {\n                            from: termStart.startOf('week').add(-2, 'days').toDate().valueOf(),\n                            to: termEnd.startOf('week').add(5, 'days').toDate().valueOf(),\n                            role: \"USER\"\n                        }];\n                });\n            }); }\n        }) || this;\n        return _this;\n    }\n    return KGTermPlannerRepo;\n}(KedRepo));\nexport { KGTermPlannerRepo };\nexport var termPlannerRepo = new KGTermPlannerRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\nenv.kgTermPlannerRepo = termPlannerRepo;\n","import env from '../globals/KED.env';\nimport { KSTermPlannerRepo } from './ks-termplanner-repo';\nexport var termPlannerRepoKS = new KSTermPlannerRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\nenv.ksTermPlannerRepo = termPlannerRepoKS;\n","import * as tslib_1 from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport moment from 'moment';\nvar KSTermPlannerRepo = /** @class */ (function (_super) {\n    tslib_1.__extends(KSTermPlannerRepo, _super);\n    function KSTermPlannerRepo(getClient, getCurrentUser) {\n        var _this = this;\n        var currentUser = getCurrentUser();\n        _this = _super.call(this, {\n            getClient: getClient,\n            optimistic: true,\n            table: \"weekplans-ks\",\n            user: currentUser ? currentUser.mail : \"\",\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var startDateValue, endDateValue;\n                return tslib_1.__generator(this, function (_a) {\n                    startDateValue = (this.startDate && this.startDate.valueOf()) || moment().valueOf();\n                    endDateValue = (this.endDate && this.endDate.valueOf()) || moment().valueOf();\n                    return [2 /*return*/, {\n                            from: startDateValue,\n                            to: endDateValue,\n                            role: \"USER\"\n                        }];\n                });\n            }); }\n        }) || this;\n        return _this;\n    }\n    KSTermPlannerRepo.prototype.refreshData = function (dateInterval) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = tslib_1.__read(dateInterval, 2), this.startDate = _a[0], this.endDate = _a[1];\n                        return [4 /*yield*/, this.mem.refreshFromServer()];\n                    case 1:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return KSTermPlannerRepo;\n}(KedRepo));\nexport { KSTermPlannerRepo };\n","import * as tslib_1 from \"tslib\";\nvar Repo = /** @class */ (function () {\n    function Repo(comm) {\n        this.comm = comm;\n        this.listPromise = null;\n        this.items = null;\n        this.subscribers = [];\n    }\n    Repo.prototype.subscribe = function (subscriber) {\n        var _this = this;\n        return this.ensureHasData().then(function () {\n            subscriber(_this.items, _this.error);\n            _this.subscribers.push(subscriber);\n        });\n    };\n    Repo.prototype.unsubscribe = function (subscriber) {\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\n    };\n    Repo.prototype.notifySubscribers = function () {\n        var _this = this;\n        this.subscribers.forEach(function (s) { return s(_this.items, _this.error); });\n    };\n    Repo.prototype.ensureHasData = function () {\n        if (!this.listPromise)\n            this.refreshFromServer();\n        return this.listPromise;\n    };\n    Repo.prototype.refreshFromServer = function () {\n        var _this = this;\n        this.listPromise = this.comm.query().then(function (items) {\n            _this.items = items;\n            _this.error = null;\n            _this.notifySubscribers();\n        }).catch(function (error) {\n            _this.error = error;\n            _this.items = _this.items || [];\n            _this.notifySubscribers();\n        });\n        return this.listPromise;\n    };\n    Repo.prototype.update = function (item) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var updatedItems;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.ensureHasData()];\n                    case 1:\n                        _a.sent();\n                        updatedItems = Array.isArray(item) ? item : [item];\n                        this.items = this.items.map(function (it) {\n                            var updatedItem = updatedItems.find(function (_a) {\n                                var id = _a.id;\n                                return it.id === id;\n                            });\n                            return updatedItem ?\n                                Object.assign({}, updatedItem) :\n                                it;\n                        });\n                        this.notifySubscribers();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Repo.prototype.insert = function (item) {\n        var _this = this;\n        return this.ensureHasData().then(function () {\n            _this.items = _this.items.concat(item);\n            _this.notifySubscribers();\n        });\n    };\n    Repo.prototype.delete = function (id) {\n        var _this = this;\n        var ids = Array.isArray(id) ? id : [id];\n        return this.ensureHasData().then(function () {\n            _this.items = _this.items.filter(function (it) { return !ids.some(function (id) { return it.id === id; }); });\n            _this.notifySubscribers();\n        });\n    };\n    return Repo;\n}());\nexport { Repo };\n","import * as tslib_1 from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport env from '../globals/KED.env';\nimport { WeekPlannerPersistedState } from \"../components/weekplanner/weekplanner-persisted-state\";\nimport moment from 'moment';\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\nimport { KEDWeek } from '../utils/weekutil';\nexport var userTasksRepo = env.userTasksRepo;\nvar UserTasksRepo = /** @class */ (function (_super) {\n    tslib_1.__extends(UserTasksRepo, _super);\n    function UserTasksRepo(getClient, getCurrentUser) {\n        var _this = _super.call(this, {\n            getClient: getClient,\n            optimistic: true,\n            table: \"usertasks\",\n            user: getCurrentUser() ? getCurrentUser().mail : \"\",\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var currentUser, userEmail, _a, weekDate, weekNumber, kedWeek;\n                return tslib_1.__generator(this, function (_b) {\n                    switch (_b.label) {\n                        case 0:\n                            currentUser = getCurrentUser();\n                            userEmail = currentUser ? currentUser.mail : \"\";\n                            if (!!this.persistedState) return [3 /*break*/, 2];\n                            _a = this;\n                            return [4 /*yield*/, WeekPlannerPersistedState.load(userEmail)];\n                        case 1:\n                            _a.persistedState = _b.sent();\n                            _b.label = 2;\n                        case 2:\n                            weekDate = this.persistedState.weekDate;\n                            weekNumber = moment(weekDate).week();\n                            kedWeek = KEDWeek(moment(weekDate).year(), weekNumber);\n                            /*const [from, to] = [moment(weekDate).startOf('week'), moment(weekDate).endOf('week')]\n                              .map(m => m.toDate().getTime());*/\n                            return [2 /*return*/, {\n                                    from: kedWeek.notBefore,\n                                    to: kedWeek.notAfter,\n                                    role: \"USER\",\n                                    include: [\"task\", \"course\"],\n                                    flags: [\"includeIdsOnly\"],\n                                }];\n                    }\n                });\n            }); }\n        }) || this;\n        _this.persistedState = null;\n        _this.getCurrentUser = getCurrentUser;\n        return _this;\n    }\n    UserTasksRepo.prototype.updatePersistedState = function (stateChanges) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        Object.assign(this.persistedState, stateChanges);\n                        return [4 /*yield*/, this.persistedState.save()];\n                    case 1:\n                        _a.sent();\n                        this.mem.notifySubscribers();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    UserTasksRepo.prototype.setTaskDoneState = function (userTask, done) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, getClient, optimistic, table, client, modifiedItem, similarTasks, identicalTasks;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\n                        client = getClient();\n                        modifiedItem = Object.assign({}, userTask, { done: done });\n                        if (!optimistic) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.mem.update(Object.assign({}, modifiedItem, { $meta: 'updating' }))];\n                    case 1:\n                        _b.sent();\n                        _b.label = 2;\n                    case 2: return [4 /*yield*/, client.list('usertasks', {\n                            name: userTask.name,\n                            role: \"USER\",\n                            include: [\"task\", \"course\"],\n                            flags: [\"includeIdsOnly\"],\n                            from: moment(this.persistedState.weekDate).add(-3, 'weeks').valueOf(),\n                            to: moment(this.persistedState.weekDate).add(3, 'weeks').valueOf()\n                        }, {\n                            cache: 'no-cache'\n                        })];\n                    case 3:\n                        similarTasks = _b.sent();\n                        identicalTasks = similarTasks.filter(function (t) {\n                            return t.courseName === userTask.courseName &&\n                                t.learningGoal === userTask.learningGoal &&\n                                (!userTask.task || t.task.map(function (t) { return t.id; }).join('') === userTask.task.map(function (t) { return t.id; }).join('')) &&\n                                (!userTask.course || t.course.map(function (c) { return c.id; }).join('') === userTask.course.map(function (c) { return c.id; }).join(''));\n                        });\n                        if (identicalTasks.length === 0) {\n                            // Workaround for issue in SubjectPlanner migration (usertasks with long names is not found)\n                            identicalTasks.push(userTask);\n                        }\n                        return [4 /*yield*/, this.update(identicalTasks, function (t) { return t.done = done; })];\n                    case 4:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    UserTasksRepo.prototype.setSubTaskDoneState = function (userTask, subTaskId, done) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, getClient, optimistic, table, client;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\n                        client = getClient();\n                        return [4 /*yield*/, this.update([userTask], function (t) { return t.subTasks && t.subTasks.filter(function (st) { return st.id === subTaskId; })\n                                .forEach(function (st) { return st.done = done; }); })];\n                    case 1:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    UserTasksRepo.prototype.setWeekPlannerBoxOpen = function (courseName, isOpen) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var openCourses;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        openCourses = tslib_1.__assign({}, this.persistedState.openCourses);\n                        if (isOpen)\n                            openCourses[courseName] = true;\n                        else\n                            delete openCourses[courseName];\n                        return [4 /*yield*/, this.updatePersistedState({ openCourses: openCourses })];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    UserTasksRepo.prototype.changeWeek = function (weekDate, keepCurrentDate) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var persistedState, newPersisted;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        persistedState = this.persistedState;\n                        if (!!persistedState) return [3 /*break*/, 2];\n                        return [4 /*yield*/, WeekPlannerPersistedState.load(this.options.user)];\n                    case 1:\n                        persistedState = _a.sent();\n                        _a.label = 2;\n                    case 2:\n                        newPersisted = new WeekPlannerPersistedState(persistedState);\n                        newPersisted.weekDate = keepCurrentDate ? moment(weekDate).valueOf() : moment(weekDate).startOf('week').valueOf();\n                        newPersisted.save();\n                        this.persistedState = newPersisted;\n                        return [4 /*yield*/, this.mem.refreshFromServer()];\n                    case 3:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    UserTasksRepo.prototype.subscribe = function (subscriber) {\n        var _this = this;\n        var proxySubscriber = function (userTasks) {\n            subscriber(userTasks.filter(function (ut) { return !ut.weekTexts; }), _this.persistedState, userTasks.filter(function (ut) { return !!ut.weekTexts; })[0] || {\n                id: createUUID(),\n                dateTime: _this.persistedState.weekDate,\n                weekTexts: { assessment: '', strategy: '' },\n                acl: [\n                    // Default ACL: Let user self have full control over this item:\n                    new DocumentAccess(\"email\", _this.getCurrentUser().mail, \"S\"),\n                    // Additional ACL: Let employees on same school have read access to it.\n                    // This currently only applies to tasks that refer to course tasks (not own tasks!)\n                    new DocumentAccess(\"schoolRole\", _this.getCurrentUser().school + \"/EMPLOYEE\", \"R\")\n                ].map(function (ac) { return ac.toString(); })\n            });\n        };\n        proxySubscriber[\"subscriber\"] = subscriber;\n        this.mem.subscribe(proxySubscriber);\n    };\n    UserTasksRepo.prototype.unsubscribe = function (subscriber) {\n        this.mem.subscribers = this.mem.subscribers.filter(function (s) { return s[\"subscriber\"] !== subscriber; });\n    };\n    return UserTasksRepo;\n}(KedRepo));\nexport { UserTasksRepo };\nif (!userTasksRepo) {\n    userTasksRepo = env.userTasksRepo = new UserTasksRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\n    userTasksRepo.mem.ensureHasData();\n}\n","import * as tslib_1 from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport env from '../globals/KED.env';\nexport var weekNotesRepo = env.weekNotesRepo;\nvar WeekNotesRepo = /** @class */ (function (_super) {\n    tslib_1.__extends(WeekNotesRepo, _super);\n    /*private currentWeek: moment.Moment;\n  \n    getCurrentWeek() {\n      if (!this.currentWeek) {\n        const {weekMillis, expire} = JSON.parse(sessionStorage.getItem(\"week-notes-week\") || \"{}\") as {weekMillis?: number, expire?: number};\n        this.currentWeek = weekMillis && expire && expire > Date.now() ?\n          moment(new Date(weekMillis)) :\n          moment().startOf('week').add(1, 'days');\n      }\n      return this.currentWeek.clone();\n    }\n  \n    setCurrentWeek(newWeekMoment: moment.Moment) {\n      this.currentWeek = newWeekMoment;\n      sessionStorage.setItem(\"week-notes-week\", JSON.stringify({\n        weekMillis: newWeekMoment.toDate().getTime(),\n        expire: moment().add(8, \"hours\").toDate().getTime()\n      }))\n    }*/\n    function WeekNotesRepo() {\n        var _this = _super.call(this, {\n            getClient: function () { return env.kedBackendClient; },\n            optimistic: false,\n            table: \"notes\",\n            user: env.currentUser ? env.currentUser.mail : \"\",\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    //const userEmail = env.currentUser ? env.currentUser.mail : \"\";\n                    //const currentWeek = this.getCurrentWeek();\n                    //const weekNumber = currentWeek.week();\n                    //const kedWeek = KEDWeek(currentWeek.year(), weekNumber);\n                    return [2 /*return*/, {\n                            //from: kedWeek.notBefore,\n                            //to: kedWeek.notAfter,\n                            role: \"USER\"\n                        }];\n                });\n            }); }\n        }) || this;\n        return _this;\n        //this.currentWeek = null;\n    }\n    return WeekNotesRepo;\n}(KedRepo));\nexport { WeekNotesRepo };\nif (!weekNotesRepo) {\n    weekNotesRepo = env.weekNotesRepo = new WeekNotesRepo();\n}\n","\nexport const SECOND = 1000;\nexport const MINUTE = SECOND * 60;\nexport const HOUR = MINUTE * 60;\n\n","import moment from 'moment';\nimport { getCurrentAcademicYear } from './generic-school-utils';\nimport { LAST_STEP_SPRING, LAST_STEP_AUTUMN } from '../components/ks-termplanner/termplanner-utils';\nvar GenericSchoolTerm = /** @class */ (function () {\n    function GenericSchoolTerm(currentDate, currentLocale, academicYearStructure) {\n        this.locale = currentLocale || \"sv\";\n        this.selectedDate = currentDate;\n        this.schoolMoment = academicYearStructure ? getCurrentAcademicYear(moment(currentDate), academicYearStructure) : null;\n    }\n    GenericSchoolTerm.prototype.getTermStartAndEnd = function (includeExtraWeek) {\n        //In case that the week start date is a date from the previous year\n        //Consider the start of the week ( start date) as the day of the 01.01.year\n        var startOfTermWeek = this.schoolMoment.academicYearStructure.startDate.clone().startOf('week');\n        if (startOfTermWeek.year() < this.schoolMoment.academicYearStructure.startDate.year()) {\n            startOfTermWeek = this.schoolMoment.academicYearStructure.startDate;\n        }\n        var endOfTermWeek = this.schoolMoment.academicYearStructure.endDate;\n        if (this.locale === \"sv\" && includeExtraWeek && this.schoolMoment.term === \"ST\") {\n            endOfTermWeek = endOfTermWeek.clone().add(3, 'weeks').endOf('week');\n        }\n        else if (includeExtraWeek) {\n            if (this.locale != \"sv\") {\n                // for india the end date can be in the middle of the week\n                endOfTermWeek = this.schoolMoment.academicYearStructure.endDate.clone();\n            }\n            endOfTermWeek = this.schoolMoment.academicYearStructure.endDate.clone().add(1, 'week').endOf('week');\n        }\n        return [startOfTermWeek, endOfTermWeek];\n    };\n    GenericSchoolTerm.prototype.getFirstAndLastWeekOfTerm = function () {\n        return [this.schoolMoment.academicYearStructure.startDate.week(), this.schoolMoment.academicYearStructure.endDate.week()];\n    };\n    GenericSchoolTerm.prototype.isCurrentWeek = function (dateTime) {\n        var termDate = moment(dateTime);\n        return termDate.year() === moment().year() && termDate.week() === moment().week();\n    };\n    GenericSchoolTerm.prototype.getLastStepWeek = function (locale) {\n        //TODO: this should be refactored. The generic method should be used\n        if (locale === \"sv\") {\n            return this.schoolMoment.term === \"ST\" ? LAST_STEP_SPRING : LAST_STEP_AUTUMN;\n        }\n        return this.schoolMoment.academicYearStructure.endDate.clone().add(1, \"week\").week();\n    };\n    GenericSchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\n        if (this.schoolMoment) {\n            var year = this.schoolMoment.academicYearStructure.endDate.year().toString();\n            var academicYear = this.schoolMoment.academicYearStructure.academicYear;\n            if (shortYear && intl.locale === 'sv') {\n                year = year.substr(2);\n            }\n            else {\n                year = academicYear;\n            }\n            return this.schoolMoment.term === 'AT' ? intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'HT {year}' }, { year: year }) :\n                intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'VT {year}' }, { year: year });\n        }\n        return null;\n    };\n    GenericSchoolTerm.prototype.nextTerm = function () {\n        //switch to next semester, we set the current date as adding 3 months to the end of the current semester\n        var endDate = this.schoolMoment ? this.schoolMoment.academicYearStructure.endDate.clone() : moment();\n        var nextDate = endDate.add(3, 'months');\n        return new GenericSchoolTerm(nextDate.toDate(), this.locale);\n    };\n    GenericSchoolTerm.prototype.prevTerm = function () {\n        //to switch to next semester, we set the current date as subtracting 3 months from the start of the current semester\n        var startDate = this.schoolMoment ? this.schoolMoment.academicYearStructure.startDate.clone() : moment();\n        var prevDate = startDate.subtract(3, 'months');\n        return new GenericSchoolTerm(prevDate.toDate(), this.locale);\n    };\n    GenericSchoolTerm.prototype.getEdsPeriodName = function () {\n        return (this.schoolMoment.term === 'AT' ? \"HT\" : \"VT\") + this.schoolMoment.academicYearStructure.endDate.year();\n    };\n    return GenericSchoolTerm;\n}());\nexport { GenericSchoolTerm };\n","import moment from 'moment';\nexport function getCurrentAcademicYear(currentDate, academicYear) {\n    var firstTermStartDate = moment(new Date(academicYear.firstTerm.startDate));\n    var firstTermEndDate = moment(new Date(academicYear.firstTerm.endDate));\n    var secondTermStartDate = moment(new Date(academicYear.secondTerm.startDate));\n    var secondTermEndDate = moment(new Date(academicYear.secondTerm.endDate));\n    var academicPeriod = firstTermStartDate.year().toString().substr(2) + \"/\" + secondTermEndDate.year().toString().substr(2);\n    var holidays = _getTermHolidays(academicYear.holidays, firstTermStartDate, firstTermEndDate);\n    if (currentDate < firstTermEndDate) {\n        //compute academic week numbers\n        var academicStartWeek = 1;\n        var academicEndWeek = firstTermEndDate.week() - firstTermStartDate.week();\n        //get current term holidays\n        return { term: 'AT', academicYearStructure: { academicYear: academicPeriod, startDate: firstTermStartDate, endDate: firstTermEndDate, academicStartWeek: academicStartWeek, academicEndWeek: academicEndWeek, holidays: holidays } };\n    }\n    //compute the number of first term holidays week numbers\n    var numberOfHolidayWeeks = _getHolidayWeeksNumber(holidays);\n    //compute academic week numbers\n    var academicStartWeek = secondTermStartDate.clone().add(1, 'week').week() - firstTermStartDate.week() - numberOfHolidayWeeks;\n    var academicEndWeek = secondTermEndDate.clone().add().add(1, 'week').week() - firstTermStartDate.week() - numberOfHolidayWeeks;\n    //get current term holidays\n    var holidays = _getTermHolidays(academicYear.holidays, secondTermStartDate, secondTermEndDate);\n    return { term: 'ST', academicYearStructure: { academicYear: academicPeriod, startDate: secondTermStartDate, endDate: secondTermEndDate, academicStartWeek: academicStartWeek, academicEndWeek: academicEndWeek, holidays: holidays } };\n}\nexport function getSchoolTranslatedSubjects(schoolLocale, intl) {\n    var translatedColumns = {};\n    //these are fixed for all school locales\n    translatedColumns[\"Kurs\"] = intl.formatMessage({ id: \"termplanner.course\", defaultMessage: \"Kurs\" });\n    translatedColumns[\"Kommentar\"] = intl.formatMessage({ id: \"termplanner.comments\", defaultMessage: \"Kommentar\" });\n    if (schoolLocale === 'sv') {\n        translatedColumns[\"M.spr\"] = intl.formatMessage({ id: \"termplanner.modernLanguage\", defaultMessage: \"M.spr\" });\n        translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.maths\", defaultMessage: \"Ma\" });\n        translatedColumns[\"Sv/SvA\"] = intl.formatMessage({ id: \"termplanner.swedishLanguage\", defaultMessage: \"Sv/SvA\" });\n        translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguage\", defaultMessage: \"Eng\" });\n    }\n    else {\n        translatedColumns[\"MFL\"] = intl.formatMessage({ id: \"termplanner.modernLanguage\", defaultMessage: \"MFL\" });\n        translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.maths\", defaultMessage: \"Maths\" });\n        translatedColumns[\"Hi\"] = intl.formatMessage({ id: \"termplanner.hindiLanguage\", defaultMessage: \"Hindi\" });\n        translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguage\", defaultMessage: \"English\" });\n        translatedColumns[\"Yoga\"] = intl.formatMessage({ id: \"termplanner.yoga\", defaultMessage: \"Yoga\" });\n        translatedColumns[\"ICT\"] = intl.formatMessage({ id: \"termplanner.ict\", defaultMessage: \"ICT\" });\n    }\n    return translatedColumns;\n}\n//this is related to charts. It is used only for sv locale\nexport function getSchoolTranslatedSubjectFullname(intl) {\n    var translatedColumns = {};\n    translatedColumns[\"M.spr\"] = intl.formatMessage({ id: \"termplanner.modernLanguageFullname\", defaultMessage: \"M.språk\" });\n    translatedColumns[\"Ma\"] = intl.formatMessage({ id: \"termplanner.mathsFullname\", defaultMessage: \"Matematik\" });\n    translatedColumns[\"Sv/SvA\"] = intl.formatMessage({ id: \"termplanner.swedishLanguageFullName\", defaultMessage: \"Svenska\" });\n    translatedColumns[\"Eng\"] = intl.formatMessage({ id: \"termplanner.englishLanguageFullName\", defaultMessage: \"Engelska\" });\n    return translatedColumns;\n}\nfunction _getTermHolidays(holidays, termStartDate, termEndDate) {\n    return holidays.filter(function (elem) {\n        return moment(elem.startDate).isBetween(termStartDate, termEndDate);\n    });\n}\nfunction _getHolidayWeeksNumber(holidays) {\n    var numberOfWeeks = 0;\n    holidays.forEach(function (elem) {\n        //the number of weeks is the difference + 1\n        numberOfWeeks += moment(elem.endDate).add(1, 'week').week() - moment(elem.startDate).week();\n    });\n    return numberOfWeeks;\n}\n","import * as tslib_1 from \"tslib\";\nexport function ifTakesTime(ms, task, action) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n        var timeoutReached, th, rv;\n        return tslib_1.__generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    timeoutReached = false;\n                    th = setTimeout(function () {\n                        timeoutReached = true;\n                        action();\n                    }, ms);\n                    return [4 /*yield*/, task()];\n                case 1:\n                    rv = _a.sent();\n                    if (!timeoutReached)\n                        clearTimeout(th);\n                    return [2 /*return*/, rv];\n            }\n        });\n    });\n}\n","import * as tslib_1 from \"tslib\";\nvar DEFAULT_CACHE_EXPIRATION = 30 * 60 * 1000; // 30 minutes.\nvar defaultOptions = {\n    isApiMethod: function (f) { return typeof f === 'function'; },\n    cacheExpiration: DEFAULT_CACHE_EXPIRATION\n};\nexport function makeSuspenseApi(api, options) {\n    if (options === void 0) { options = defaultOptions; }\n    options = tslib_1.__assign({}, defaultOptions, options);\n    var isApiMethod = options.isApiMethod, cacheExpiration = options.cacheExpiration;\n    var rv = Object.create(api);\n    var cache = {};\n    // Walk the instance + prototype chain to generate suspense version of each promise returning method\n    for (var proto = api; proto && proto !== Object.prototype; proto = Object.getPrototypeOf(proto)) {\n        suspendify(proto);\n    }\n    function suspendify(proto) {\n        Object.keys(proto).forEach(function (prop) {\n            if (!rv.hasOwnProperty(prop) && isApiMethod(prop)) {\n                rv[prop] = function () {\n                    var args = [];\n                    for (var _i = 0; _i < arguments.length; _i++) {\n                        args[_i] = arguments[_i];\n                    }\n                    var key = JSON.stringify(tslib_1.__spread([prop], args));\n                    var cachedEntry = cache[key];\n                    if (cachedEntry !== undefined) {\n                        if (cachedEntry.promise)\n                            throw cachedEntry.promise;\n                        if (cachedEntry.error)\n                            throw cachedEntry.error;\n                        if (cachedEntry.timeout > Date.now()) {\n                            return cachedEntry.value;\n                        }\n                    }\n                    try {\n                        var promise = proto[prop].apply(api, args).then(function (result) {\n                            cache[key] = { timeout: Date.now() + cacheExpiration, value: result };\n                        }).catch(function (error) {\n                            cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\n                        });\n                        cache[key] = { timeout: Date.now() + cacheExpiration, promise: promise };\n                        throw promise;\n                    }\n                    catch (error) {\n                        if (error.then)\n                            throw error;\n                        cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\n                    }\n                };\n            }\n        });\n    }\n    return rv;\n}\n","import * as tslib_1 from \"tslib\";\nvar PendingJob = /** @class */ (function () {\n    function PendingJob(callback) {\n        this.timeoutId = null;\n        this.cancelled = false;\n        this.pending = false;\n        this.isJobExecuting = false;\n        this.jobCallback = callback;\n    }\n    PendingJob.prototype.triggerChange = function (throttle) {\n        var _this = this;\n        if (this.cancelled)\n            return;\n        this.pending = true;\n        if (this.timeoutId !== null)\n            clearTimeout(this.timeoutId);\n        this.timeoutId = setTimeout(function () { return _this.launchJob(); }, throttle);\n    };\n    PendingJob.prototype.stop = function () {\n        if (this.timeoutId !== null)\n            clearTimeout(this.timeoutId);\n        this.timeoutId = null;\n        this.cancelled = true;\n    };\n    PendingJob.prototype.launchJob = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.cancelled)\n                            return [2 /*return*/];\n                        if (!this.pending)\n                            return [2 /*return*/];\n                        if (this.isJobExecuting)\n                            return [2 /*return*/];\n                        this.timeoutId = null;\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, , 3, 4]);\n                        this.isJobExecuting = true;\n                        this.pending = false;\n                        return [4 /*yield*/, this.jobCallback()];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 3:\n                        this.isJobExecuting = false;\n                        return [7 /*endfinally*/];\n                    case 4:\n                        if (!this.pending) return [3 /*break*/, 6];\n                        return [4 /*yield*/, this.launchJob()];\n                    case 5:\n                        _a.sent();\n                        _a.label = 6;\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return PendingJob;\n}());\nexport { PendingJob };\n","import * as tslib_1 from \"tslib\";\nexport function parseQueryString(locationSearch, options) {\n    var toLower = (options || {}).toLower;\n    var result = {};\n    if (locationSearch && locationSearch.length > 1)\n        locationSearch.substr(1)\n            .split('&')\n            .map(function (part) { return part.split('=').map(function (s) { return decodeURIComponent(s.trim()); }); })\n            .forEach(function (_a) {\n            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];\n            return result[toLower ? key.toLowerCase() : key] = value;\n        });\n    return result;\n}\nfunction encodeParams(params) {\n    return Object.keys(params).filter(function (key) { return params[key] !== undefined; }).map(function (key) { return encodeURIComponent(key) + \"=\" + encodeURIComponent(params[key]); }).join('&');\n}\nexport function generateQueryString(params) {\n    return \"?\" + encodeParams(params);\n}\nexport function parseHashQueryString(locationHash, options) {\n    return parseQueryString(locationHash, options);\n}\nexport function generateHashQueryString(params) {\n    return \"#\" + encodeParams(params);\n}\nexport function splitUrlAndQuery(urlWithPossibleQuery) {\n    var pQuery = urlWithPossibleQuery.indexOf('?');\n    return pQuery >= 0 ?\n        [urlWithPossibleQuery.substr(0, pQuery), urlWithPossibleQuery.substr(pQuery)] :\n        [urlWithPossibleQuery, \"\"];\n}\n","import * as tslib_1 from \"tslib\";\nimport env from '../globals/KED.env';\nimport cfg from '../globals/KED.cfg';\nimport { KedBackendClient, HttpError } from 'kedbackend/client';\nimport { EdsClient } from '../apis/edsclient';\nimport { isomorphic } from 'kedbackend/clientweb';\nimport { KSTermPlannerRepo } from '../repos/ks-termplanner-repo';\nimport { KGTermPlannerRepo } from '../repos/kg-termplanner-repo';\nimport { UserTasksRepo } from '../repos/user-tasks-repo';\nexport function requestTutoredTokens(userEmail, displayName) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n        function createBearerProvider(client, tokenUrl, query) {\n            var bearerPromise = null;\n            return {\n                getBearer: function () {\n                    return bearerPromise || this.refreshBearer();\n                },\n                refreshBearer: function () {\n                    return (bearerPromise = retrieveToken());\n                },\n            };\n            function retrieveToken() {\n                return tslib_1.__awaiter(this, void 0, void 0, function () {\n                    var res, _a, _b, _c;\n                    return tslib_1.__generator(this, function (_d) {\n                        switch (_d.label) {\n                            case 0: return [4 /*yield*/, client.get(tokenUrl, query)];\n                            case 1:\n                                res = _d.sent();\n                                if (!(res.status === 200)) return [3 /*break*/, 3];\n                                return [4 /*yield*/, res.json()];\n                            case 2: return [2 /*return*/, (_d.sent())];\n                            case 3:\n                                _a = HttpError.bind;\n                                _b = [void 0, res.status];\n                                _c = \"Could not retrieve tutor token for \" +\n                                    userEmail +\n                                    \". Error Message: \";\n                                return [4 /*yield*/, res.text()];\n                            case 4: throw new (_a.apply(HttpError, _b.concat([_c + (_d.sent())])))();\n                        }\n                    });\n                });\n            }\n        }\n        var currentUser, bearerProvider, tutoredKedBackendClient, googleTokenProvider, edsClient, tutorEnv;\n        return tslib_1.__generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    currentUser = {\n                        mail: userEmail,\n                        displayName: displayName,\n                        roles: [\"USER\"],\n                        school: env.currentUser.school,\n                        tutorFor: userEmail\n                    };\n                    bearerProvider = createBearerProvider(env.kedBackendClient.http, \"tutor/token\", { userEmail: userEmail });\n                    tutoredKedBackendClient = new KedBackendClient(isomorphic, bearerProvider, cfg.KED_API_URL);\n                    googleTokenProvider = createBearerProvider(tutoredKedBackendClient.http, \"tutor/convert-token/google\");\n                    edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, bearerProvider, function () { return userEmail; });\n                    tutorEnv = {\n                        currentUser: currentUser,\n                        bearerProvider: bearerProvider,\n                        edsClient: edsClient,\n                        googleTokenProvider: googleTokenProvider,\n                        kedBackendClient: tutoredKedBackendClient,\n                        tutored: true\n                    };\n                    tutorEnv.ksTermPlannerRepo = new KSTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    tutorEnv.kgTermPlannerRepo = new KGTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    tutorEnv.userTasksRepo = new UserTasksRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    return [4 /*yield*/, bearerProvider.getBearer().catch(function (error) {\n                            console.error(error);\n                        })];\n                case 1:\n                    _a.sent();\n                    return [2 /*return*/, tutorEnv];\n            }\n        });\n    });\n}\n","import * as tslib_1 from \"tslib\";\nimport moment from 'moment';\nexport function getFirstAndLastWeekOfTerm(term) {\n    return term === 'AT' ?\n        [32, 51] :\n        [1, 25];\n}\n//Not used anymore\n// export function getTermStartAndEnd(now: moment.Moment) : moment.Moment[] {\n//     return now.month() >= 6 ? // 6 = July in JS Dates and in moment as well!\n//     [moment(new Date(now.year(), 7, 1)), moment(new Date(now.year(), 11, 31))] : // aug1 - dec31\n//     [moment(new Date(now.year(), 0, 1)), moment(new Date(now.year(), 6, 31))]; // jan1 - july31\n// }\nexport function getTermStarEndDate(date, isFirstTerm) {\n    var addYear = date.getMonth() >= 7;\n    var termYear = null;\n    if (addYear) {\n        termYear = isFirstTerm ? date.getFullYear() : date.getFullYear() + 1;\n    }\n    else {\n        termYear = isFirstTerm ? date.getFullYear() - 1 : date.getFullYear();\n    }\n    var termYearMoment = moment(termYear.toString(), \"YYYY\");\n    if (termYearMoment.week() != 1) {\n        termYearMoment = termYearMoment.clone().add(1, 'week');\n    }\n    return isFirstTerm ? [moment(termYearMoment.clone()).week(32).startOf('week'), moment(termYearMoment.clone()).week(51).endOf('week')] :\n        [moment(termYearMoment.clone()), moment(termYearMoment.clone()).week(25).endOf('week')];\n}\nexport function getSchoolMoment(m) {\n    var thisYear = m.year();\n    var isAutumn = m.month() >= 6; // determine \n    var _a = tslib_1.__read(isAutumn ?\n        [thisYear, thisYear + 1] :\n        [thisYear - 1, thisYear], 2), autumnYear = _a[0], springYear = _a[1];\n    var academicYear = '' + autumnYear + '/' + springYear;\n    var term = isAutumn ? 'AT' : 'ST';\n    var week = m.week();\n    return { academicYear: academicYear, term: term, week: week };\n}\nexport function addYear(aYear, numYearsToAdd) {\n    return aYear.split('/')\n        .map(function (yearStr) { return parseInt(yearStr) + numYearsToAdd; })\n        .map(function (year) { return '' + year; })\n        .join('/');\n}\nexport function nextAcademicYear(aYear) {\n    return addYear(aYear, 1);\n}\nexport function prevAcademicYear(aYear) {\n    return addYear(aYear, -1);\n}\n","import moment from 'moment';\nimport { getSchoolMoment, addYear } from './school-moment';\nfunction isSchoolMoment(obj) {\n    return 'academicYear' in obj;\n}\nvar SchoolTerm = /** @class */ (function () {\n    function SchoolTerm(dateOrSchoolMoment) {\n        var schoolMoment = isSchoolMoment(dateOrSchoolMoment) ?\n            dateOrSchoolMoment : getSchoolMoment(moment(dateOrSchoolMoment));\n        this.academicYear = schoolMoment.academicYear;\n        this.term = schoolMoment.term;\n    }\n    Object.defineProperty(SchoolTerm.prototype, \"year\", {\n        get: function () {\n            return parseInt(this.academicYear\n                .split('/')[this.term === 'AT' ? 0 : 1]);\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SchoolTerm.prototype.nextTerm = function () {\n        return new SchoolTerm(this.term === 'AT' ?\n            {\n                term: 'ST',\n                academicYear: this.academicYear\n            } :\n            {\n                term: 'AT',\n                academicYear: addYear(this.academicYear, 1)\n            });\n    };\n    SchoolTerm.prototype.prevTerm = function () {\n        return new SchoolTerm(this.term === 'AT' ?\n            {\n                term: 'ST',\n                academicYear: addYear(this.academicYear, -1)\n            } :\n            {\n                term: 'AT',\n                academicYear: this.academicYear\n            });\n    };\n    SchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\n        var year = this.term === 'AT' ?\n            this.academicYear.split('/')[0] :\n            this.academicYear.split('/')[1];\n        if (shortYear)\n            year = year.substr(2);\n        return this.term === 'AT' ? intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'HT {year}' }, { year: year }) :\n            intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'VT {year}' }, { year: year });\n    };\n    return SchoolTerm;\n}());\nexport { SchoolTerm };\n","import * as tslib_1 from \"tslib\";\nexport function capitalizeFirst(str) {\n    for (var i = 0, l = str.length; i < l; ++i) {\n        if (str.charCodeAt(i) < 0x2000) {\n            return str.substr(0, i) + str[i].toLocaleUpperCase() + str.substr(i + 1);\n        }\n    }\n    return str;\n}\nexport function extend(obj, extension) {\n    if (typeof extension !== 'object')\n        return obj;\n    Object.keys(extension).forEach(function (key) {\n        obj[key] = extension[key];\n    });\n    return obj;\n}\nexport function clone(obj, extension) {\n    var clone = {};\n    Object.getOwnPropertyNames(obj).forEach(function (key) {\n        Object.defineProperty(clone, key, Object.getOwnPropertyDescriptor(obj, key));\n    });\n    if (extension)\n        extend(clone, extension);\n    return clone;\n}\nvar concat = [].concat;\nexport function flatten(a) {\n    return concat.apply([], a);\n}\nexport function compareProp(prop) {\n    return function (a, b) {\n        var aProp = a[prop], bProp = b[prop];\n        return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\n    };\n}\nexport function compareProps(props, locales, options) {\n    props = Array.isArray(props) ? props : [props];\n    var localeCompare = function (a, b) {\n        return typeof a === 'string' ?\n            a.localeCompare(b, locales, options) :\n            a < b ? -1 : a > b ? 1 : 0;\n    };\n    function cmpPart(a, b, firstPart, rest) {\n        var firstA = a[firstPart];\n        var firstB = b[firstPart];\n        if (firstA === firstB)\n            return 0;\n        if (firstA == null)\n            return -1;\n        if (firstB == null)\n            return 1;\n        return rest.length === 0 ?\n            localeCompare(firstA, firstB) :\n            cmpPart(firstA, firstB, rest[0], rest.slice(1));\n    }\n    return props\n        .map(function (prop) { return prop.split('.'); })\n        .map(function (_a) {\n        var _b = tslib_1.__read(_a), firstPart = _b[0], rest = _b.slice(1);\n        return function (a, b) { return cmpPart(a, b, firstPart, rest); };\n    })\n        .reduce(function (cmp1, cmp2) {\n        return function (a, b) { return cmp1(a, b) || cmp2(a, b); };\n    });\n}\nexport function L(text) {\n    var args = [];\n    for (var _i = 1; _i < arguments.length; _i++) {\n        args[_i - 1] = arguments[_i];\n    }\n    var first = text[0];\n    return buildMessage(text, args);\n}\nfunction buildMessage(text, args) {\n    var rv = text[0];\n    for (var i = 1, l = text.length; i < l; ++i) {\n        rv += args[i - 1] + text[i];\n    }\n    return rv;\n}\nvar TC = /** @class */ (function () {\n    function TC(template) {\n        extend(this, template);\n    }\n    return TC;\n}());\nexport { TC };\nexport function dateTimeReviver(key, value) {\n    var a;\n    if (typeof value === 'string') {\n        a = /\\/Date\\((\\d*)\\)\\//.exec(value);\n        if (a) {\n            return new Date(+a[1]);\n        }\n    }\n    return value;\n}\n//let infoSerial = 1;\nexport function showInfo(msg) {\n    var event = new CustomEvent('info', { 'detail': msg });\n    window.dispatchEvent(event);\n}\nexport function showError(errMsg) {\n    var msg = typeof errMsg === 'string' ? errMsg : errMsg.message;\n    var event = new CustomEvent('customerror', { 'detail': msg });\n    console.error(errMsg);\n    window.dispatchEvent(event);\n}\nexport function maxLength(str, maxLen) {\n    return str.length > maxLen ?\n        str.substr(0, maxLen - 3) + \"...\" :\n        str;\n}\nexport function arrayToLookup(a, keyAccessor) {\n    var result = {};\n    for (var i = 0, l = a.length; i < l; ++i) {\n        var item = a[i];\n        var key = keyAccessor(item);\n        var array = result[key];\n        if (array)\n            array.push(item);\n        else\n            result[key] = [item];\n    }\n    return result;\n}\nexport function arrayToMap(a, keyAccessor) {\n    var result = {};\n    for (var i = 0, l = a.length; i < l; ++i) {\n        var item = a[i];\n        var key = keyAccessor(item);\n        result[key] = item;\n    }\n    return result;\n}\nexport function cherryPickProps(obj, propsToPick) {\n    var e_1, _a;\n    var result = {};\n    try {\n        for (var propsToPick_1 = tslib_1.__values(propsToPick), propsToPick_1_1 = propsToPick_1.next(); !propsToPick_1_1.done; propsToPick_1_1 = propsToPick_1.next()) {\n            var param = propsToPick_1_1.value;\n            if (param in obj)\n                result[param] = obj[param];\n        }\n    }\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\n    finally {\n        try {\n            if (propsToPick_1_1 && !propsToPick_1_1.done && (_a = propsToPick_1.return)) _a.call(propsToPick_1);\n        }\n        finally { if (e_1) throw e_1.error; }\n    }\n    return result;\n}\nexport function distinct(a, keyAccessor) {\n    var map = arrayToMap(a, keyAccessor || (function (x) { return x; }));\n    return Object.keys(map).map(function (key) { return map[key]; });\n}\nexport function shallowEquals(a, b) {\n    if (a === b)\n        return true;\n    if (!a || !b)\n        return false;\n    if (typeof a !== 'object' || typeof b !== 'object')\n        return false;\n    var keysA = Object.keys(a);\n    var keysB = Object.keys(b);\n    if (keysA.length !== keysB.length)\n        return false;\n    for (var i = 0, l = keysA.length; i < l; ++i) {\n        var key = keysA[i];\n        if (keysB[i] !== key)\n            return false;\n        if (a[key] !== b[key])\n            return false;\n    }\n    return true;\n}\n","import moment from \"moment\";\nexport function KEDWeek(year, week) {\n    var m = moment(new Date(year, 1, 1)).week(week);\n    var res = {\n        year: year,\n        week: week,\n        notBefore: m.clone().startOf('week').add(-2, 'days').toDate().getTime(),\n        notAfter: m.clone().startOf('week').add(5, 'days').toDate().getTime()\n    };\n    return res;\n}\nexport function getNextWeekDate(date) {\n    var nextDate = moment(date).add(1, 'week');\n    //Set the 01.01 of the next year in case the next week is in the same year \n    //and the previous week is the last week of the year\n    if (date.week() === date.weeksInYear() && nextDate.year() === date.year()) {\n        return { adjusted: true, nextDate: moment(date.year() + 1 + \"-01-01\").toDate() };\n    }\n    return { adjusted: false, nextDate: nextDate.toDate() };\n}\nexport function getPrevWeekDate(date) {\n    var prevDate = moment(date).add(-1, 'week');\n    //Set the 01.01 of the current year in case the prev week is in the previous year\n    if (date.week() === 2 && prevDate.year() !== date.year()) {\n        return { adjusted: true, nextDate: moment(date.year() + \"-01-01\").toDate() };\n    }\n    return { adjusted: false, nextDate: prevDate.toDate() };\n}\nexport function getAdjustedWeek(m) {\n    var clone = m.clone();\n    return m.weekday() >= 5 ? // Lördag 00:00 / Söndag 00:00?\n        m.week() + 1 : // Tillhör nästa vecka\n        m.week();\n}\n/*export function getWeekLimits (m: Moment) {\n  const clonedSwedish = m.clone().locale('sv');\n  const limits = {\n    notBefore: clonedSwedish.startOf('week').add(-2, 'days'),\n    notAfter: clonedSwedish.startOf('week').add(5, 'days')\n  };\n}\n*/\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AClBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3PA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC1FA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/JA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3NA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9NA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjCA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACPA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrVA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;ACFA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9IA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5GA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChcA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClFA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxCA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5FA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5FA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxUA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzcA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5QA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/QA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtMA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}