{"version":3,"file":"testpagespadmin.js","sources":["webpack://[name]/webpack/bootstrap","webpack://[name]/./kedbackend/client.js","webpack://[name]/./kedbackend/clientweb.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/bearer-storage-sessionstorage.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/hash-restorer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/access-control.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/http-error.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/ked-bearer-provider.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/restclient.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/cache-bust.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/apply-mutations-on-deltas.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-cache.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-merge.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-query.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-repo.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-subscription.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-writer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/mutation-queue.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/query-set.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-course.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-task.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate.js","webpack://[name]/./kedbackend/js/dist/js/observable/collection.js","webpack://[name]/./kedbackend/js/dist/js/observable/emitter.js","webpack://[name]/./kedbackend/js/dist/js/observable/fiber-context.js","webpack://[name]/./kedbackend/js/dist/js/observable/index.js","webpack://[name]/./kedbackend/js/dist/js/observable/map.js","webpack://[name]/./kedbackend/js/dist/js/observable/mixin.js","webpack://[name]/./kedbackend/js/dist/js/observable/observable.js","webpack://[name]/./kedbackend/js/dist/js/observable/value.js","webpack://[name]/./kedbackend/observable.js","webpack://[name]/./kedbackend/repo.js","webpack://[name]/./src/access-control/get-user-claims.ts","webpack://[name]/./src/access-control/index.ts","webpack://[name]/./src/apis/edsclient.ts","webpack://[name]/./src/components/charts/goal-progress.tsx","webpack://[name]/./src/components/course-builder-ks/admin/courses/create-standard-course.tsx","webpack://[name]/./src/components/course-builder-ks/admin/courses/delete-standard-course.tsx","webpack://[name]/./src/components/course-builder-ks/admin/courses/edit-course-block-requirements.tsx","webpack://[name]/./src/components/course-builder-ks/admin/courses/edit-standard-course-blocks.tsx","webpack://[name]/./src/components/course-builder-ks/admin/courses/edit-standard-course.tsx","webpack://[name]/./src/components/course-builder-ks/admin/index.tsx","webpack://[name]/./src/components/course-builder-ks/admin/routes.tsx","webpack://[name]/./src/components/course-builder-ks/common/banner.tsx","webpack://[name]/./src/components/course-builder-ks/common/side-list.tsx","webpack://[name]/./src/components/course-builder-ks/common/standard-course-instance-list.tsx","webpack://[name]/./src/components/course-builder-ks/common/two-columns-page.tsx","webpack://[name]/./src/components/course-builder-ks/logic/course-instance-tags.ts","webpack://[name]/./src/components/course-builder-ks/logic/get-course-codes-from-tags.ts","webpack://[name]/./src/components/course-builder-ks/logic/get-standard-courses-with-ordered-requirements.ts","webpack://[name]/./src/components/course-builder-ks/logic/list-course-instances.ts","webpack://[name]/./src/components/course-builder-ks/logic/ordered-requirements.ts","webpack://[name]/./src/components/course-builder-ks/logic/publish-course.ts","webpack://[name]/./src/components/course-builder/courses/business-logic.ts","webpack://[name]/./src/components/course-builder/courses/course-banner.tsx","webpack://[name]/./src/components/course-builder/knowledge-matrix-partial-utils.ts","webpack://[name]/./src/components/course-builder/schools/edit-school.tsx","webpack://[name]/./src/components/course-builder/schools/editable-school-list.tsx","webpack://[name]/./src/components/course-builder/schools/index.tsx","webpack://[name]/./src/components/course-builder/sub-components/ellipsis-loader.tsx","webpack://[name]/./src/components/course-builder/sub-components/knowledge-matrix.tsx","webpack://[name]/./src/components/course-builder/sub-components/remove-item.tsx","webpack://[name]/./src/components/course-builder/sub-components/select-related-docs.tsx","webpack://[name]/./src/components/course-builder/sub-components/spinner.tsx","webpack://[name]/./src/components/course-builder/subjects/diff/diff-xml-with-database.ts","webpack://[name]/./src/components/course-builder/subjects/diff/migrate-subject.ts","webpack://[name]/./src/components/course-builder/subjects/show-subject-inner.tsx","webpack://[name]/./src/components/course-builder/subjects/show-subject.tsx","webpack://[name]/./src/components/course-builder/subjects/skolverket-subject.ts","webpack://[name]/./src/components/course-builder/subjects/subjects-inner.tsx","webpack://[name]/./src/components/course-builder/subjects/uploaded-subject.tsx","webpack://[name]/./src/components/course-builder/utils.ts","webpack://[name]/./src/components/utility-components/LanguageContext.tsx","webpack://[name]/./src/components/utility-components/SetupLanguageIntl.tsx","webpack://[name]/./src/components/utility-components/checklist.tsx","webpack://[name]/./src/components/utility-components/form-field-text-input.tsx","webpack://[name]/./src/components/utility-components/form-field-textarea.tsx","webpack://[name]/./src/components/utility-components/form-field.tsx","webpack://[name]/./src/components/utility-components/lazy-content.tsx","webpack://[name]/./src/components/utility-components/live-query-view.tsx","webpack://[name]/./src/components/utility-components/loading-indicator.tsx","webpack://[name]/./src/components/utility-components/multiselect.tsx","webpack://[name]/./src/components/utility-components/open-close-box.tsx","webpack://[name]/./src/global-setters/configure.ts","webpack://[name]/./src/global-setters/set-all.ts","webpack://[name]/./src/global-setters/set-bearer-providers.ts","webpack://[name]/./src/global-setters/set-eds-client.ts","webpack://[name]/./src/global-setters/set-ked-backend-client.ts","webpack://[name]/./src/globals/KED.cfg.ts","webpack://[name]/./src/globals/KED.env.ts","webpack://[name]/./src/globals/KED.ts","webpack://[name]/./src/globals/db.ts","webpack://[name]/./src/globals/ked.ts","webpack://[name]/./src/test/data/users.ts","webpack://[name]/./src/test/set-current-user.ts","webpack://[name]/./src/test/testpage-spadmin.tsx","webpack://[name]/./src/test/utils/choose-user.tsx","webpack://[name]/./src/test/utils/include-css.ts","webpack://[name]/./src/utils/error-success-feedback.tsx","webpack://[name]/./src/utils/include-optional-css.ts","webpack://[name]/./src/utils/make-suspense-api.ts","webpack://[name]/./src/utils/query-string.ts","webpack://[name]/./src/utils/school-moment.ts","webpack://[name]/./src/utils/school-term.ts","webpack://[name]/./src/utils/utils.ts"],"sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"testpagespadmin\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp_name_\"] = window[\"webpackJsonp_name_\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([\"./src/test/testpage-spadmin.tsx\",\"vendors\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","export * from './js/dist/js/ked-backend-client';","export * from './js/dist/js/ked-backend-client-web';","var BearerStorageSessionStorage = /** @class */ (function () {\r\n    function BearerStorageSessionStorage() {\r\n    }\r\n    BearerStorageSessionStorage.prototype.save = function (id, tokenInfo) {\r\n        sessionStorage.setItem(\"bearer-\" + id, JSON.stringify(tokenInfo));\r\n    };\r\n    BearerStorageSessionStorage.prototype.load = function (id) {\r\n        try {\r\n            var json = sessionStorage.getItem(\"bearer-\" + id);\r\n            return Promise.resolve(json ? JSON.parse(json) : { token: null, expires: 0 });\r\n        }\r\n        catch (ex) {\r\n            return Promise.resolve({ token: null, expires: 0 });\r\n        }\r\n    };\r\n    return BearerStorageSessionStorage;\r\n}());\r\nexport { BearerStorageSessionStorage };\r\n//# sourceMappingURL=bearer-storage-sessionstorage.js.map","var redirHash = sessionStorage.getItem(\"redir-hash\");\r\nif (redirHash)\r\n    try {\r\n        var _a = JSON.parse(redirHash), time = _a.time, hash = _a.hash;\r\n        if (time && time > Date.now() - 60000) {\r\n            sessionStorage.removeItem(\"redir-hash\");\r\n            location.hash = hash;\r\n        }\r\n    }\r\n    catch (_) { }\r\nexport function rememberHashLocation() {\r\n    sessionStorage.setItem(\"redir-hash\", JSON.stringify({ time: Date.now(), hash: location.hash }));\r\n}\r\n//# sourceMappingURL=hash-restorer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendClient, HttpError } from '../ked-backend-client';\r\nimport { BearerStorageSessionStorage } from \"./bearer-storage-sessionstorage\";\r\nimport { avoidSimultanousCalls } from '../ked-backend-client/utils';\r\nimport { KedModelMigratorMixin } from '../ked-model-migrator';\r\nimport './hash-restorer';\r\nimport { rememberHashLocation } from './hash-restorer';\r\nKedModelMigratorMixin(KedBackendClient.prototype);\r\nexport var storage = new BearerStorageSessionStorage();\r\nvar timeOfPageLoad = Date.now();\r\nvar WebServerBearerProvider = /** @class */ (function () {\r\n    function WebServerBearerProvider(tokenPath, tokenResponseMapper, tokenId) {\r\n        this.tokenPath = tokenPath;\r\n        this.tokenResponseMapper = tokenResponseMapper;\r\n        this.tokenId = tokenId;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    WebServerBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!!this.tokenInfo.token) return [3 /*break*/, 2];\r\n                        if (!this.tokenId) return [3 /*break*/, 2];\r\n                        _a = this;\r\n                        return [4 /*yield*/, storage.load(this.tokenId)];\r\n                    case 1:\r\n                        _a.tokenInfo = _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        if (!(this.tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _b.sent();\r\n                        _b.label = 4;\r\n                    case 4: return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WebServerBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, _c, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0: return [4 /*yield*/, fetch(this.tokenPath, {\r\n                            headers: { Accept: \"text/plain; application/json\" },\r\n                            redirect: 'manual',\r\n                            cache: 'no-cache',\r\n                            credentials: \"same-origin\"\r\n                        })];\r\n                    case 1:\r\n                        res = _e.sent();\r\n                        if (res.status === 302 || (!res.status && res.type === \"opaqueredirect\")) {\r\n                            // User session timed out and server wants to redirect entire page to login page\r\n                            // Time to reload current page to force a redirect of the entire page instead for\r\n                            // just redirecting to /api/token or whatever.\r\n                            if (Date.now() - timeOfPageLoad > 60000) { // prohibit endless loop of reloading self.\r\n                                this.wantsRedirect = true; // So that listeners to onbeforeunload could show alternate message.\r\n                                console.log(\"Redirect wanted. Reload page.\");\r\n                                rememberHashLocation();\r\n                                window.location.reload(true);\r\n                                throw new HttpError(302, \"Redirected\");\r\n                            }\r\n                        }\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = Error.bind;\r\n                        _b = \"HTTP\" + res.status + \" \";\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(Error, [void 0, _b + (_e.sent())]))();\r\n                    case 3:\r\n                        _c = this;\r\n                        _d = this.tokenResponseMapper;\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 4:\r\n                        _c.tokenInfo = _d.apply(this, [_e.sent()]);\r\n                        storage.save(this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WebServerBearerProvider;\r\n}());\r\nexport { WebServerBearerProvider };\r\nexport var isomorphic = { fetch: fetch.bind(self), btoa: btoa.bind(self) };\r\nvar KedBackendClientWeb = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendClientWeb, _super);\r\n    function KedBackendClientWeb(apiBaseUrl, providerOrTokenPath, options) {\r\n        var _this = this;\r\n        var bearerProvider = typeof providerOrTokenPath !== 'string' ?\r\n            providerOrTokenPath :\r\n            new WebServerBearerProvider(providerOrTokenPath, (options && options.tokenResponseMapper) || (function (x) { return ({ token: x, expires: Date.now() + 59 * 60 * 60 }); }), options && options.tokenId);\r\n        _this = _super.call(this, isomorphic, bearerProvider, apiBaseUrl) || this;\r\n        return _this;\r\n    }\r\n    return KedBackendClientWeb;\r\n}(KedBackendClient));\r\nexport { KedBackendClientWeb };\r\n//# sourceMappingURL=index.js.map","var DocumentAccess = /** @class */ (function () {\r\n    function DocumentAccess(accessClaimType, accessClaimValue, right) {\r\n        this.accessClaimType = accessClaimType;\r\n        this.accessClaimValue = accessClaimValue;\r\n        this.right = right;\r\n    }\r\n    DocumentAccess.fromString = function (ac) {\r\n        if (!ac)\r\n            return null;\r\n        var split = ac.split(':');\r\n        if (split.length < 3)\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        var claimType = DocumentAccess.unescape(split[0]);\r\n        var claimValue = DocumentAccess.unescape(split[1]);\r\n        var right = split[2];\r\n        if (right !== 'R' && right !== 'W' && right !== 'S')\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        return new DocumentAccess(claimType, claimValue, right);\r\n    };\r\n    DocumentAccess.escape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%/g, \"%25\").replace(/\\:/g, \"%3A\");\r\n    };\r\n    DocumentAccess.unescape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%3A/g, \":\").replace(/\\%25/g, \"%\");\r\n    };\r\n    DocumentAccess.prototype.toString = function () {\r\n        return DocumentAccess.escape(this.accessClaimType) + \":\" +\r\n            DocumentAccess.escape(this.accessClaimValue) + \":\" +\r\n            this.right;\r\n    };\r\n    DocumentAccess.fromStringArray = function (acl) {\r\n        return acl\r\n            .map(function (ac) { return DocumentAccess.fromString(ac); })\r\n            .filter(function (ac) { return ac; });\r\n    };\r\n    DocumentAccess.toStringArray = function (acl) {\r\n        return acl.map(function (ac) { return ac.toString(); });\r\n    };\r\n    return DocumentAccess;\r\n}());\r\nexport { DocumentAccess };\r\nexport function hasAccess(acl, userClaims, requestedRight) {\r\n    if (userClaims.some(function (claim) { return claim.type === 'role' && claim.value === \"ADMIN\"; }))\r\n        return true;\r\n    return acl.some(function (a) {\r\n        return userClaims.some(function (c) {\r\n            return a.accessClaimType === c.type &&\r\n                a.accessClaimValue === c.value && ((a.right === 'R' && requestedRight === 'R') ||\r\n                (a.right === 'W' && ['R', 'W'].indexOf(requestedRight) >= 0) ||\r\n                (a.right === 'S'));\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=access-control.js.map","import * as tslib_1 from \"tslib\";\r\nvar HttpError = /** @class */ (function (_super) {\r\n    tslib_1.__extends(HttpError, _super);\r\n    function HttpError(code, message) {\r\n        var _this = _super.call(this, \"HTTP\" + code + \" \" + message) || this;\r\n        _this.code = code;\r\n        _this.message = message;\r\n        _this.name = \"http\" + code;\r\n        _this.message = \"HTTP\" + code + \" \" + message;\r\n        return _this;\r\n    }\r\n    return HttpError;\r\n}(Error));\r\nexport { HttpError };\r\n//# sourceMappingURL=http-error.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nexport * from './utils';\r\nexport { KedBearerProvider } from './ked-bearer-provider';\r\nexport * from './access-control';\r\nexport { RestClient };\r\nimport { HttpError } from './http-error';\r\nexport { HttpError };\r\nexport * from './restclient';\r\n;\r\n// | 'otherFlag' | 'thirdFlag';...\r\nvar KedBackendClient = /** @class */ (function () {\r\n    function KedBackendClient(isomorphic, bearerProvider, baseUrl) {\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n    }\r\n    KedBackendClient.prototype.getMyClaims = function (table, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"me/claims/\" + (table || \"\"), null, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.get = function (table, id, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(table + \"/\" + id, options, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.list = function (table, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = tslib_1.__assign({}, options);\r\n                        if (typeof location !== 'undefined' && location.search.includes('useSP')) {\r\n                            if (!options.from &&\r\n                                !options.to &&\r\n                                (!options.include || !options.include.includes(\"acl\")) &&\r\n                                !options.role &&\r\n                                !options.name &&\r\n                                [options.hasEdgesFrom, options.hasEdgesTo, options.ids, options.tags].filter(function (x) { return !!x; }).length === 1) {\r\n                                query.flags = (query.flags || []).concat(['useSP']);\r\n                            }\r\n                        }\r\n                        if (options && options.mutationsOnEmpty)\r\n                            query.mutationsOnEmpty = JSON.stringify(options.mutationsOnEmpty);\r\n                        return [4 /*yield*/, this.http.get(\"\" + table, query, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.batch = function (reqs, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        // Reorder operations so that 'add's come first and 'delete's come last:\r\n                        reqs = reqs.slice().sort(function (req1, req2) {\r\n                            return req1.op === 'add' ? -1 : req2.op === 'add' ? 1 :\r\n                                req1.op === 'delete' ? 1 : req2.op === 'delete' ? -1 : 0;\r\n                        });\r\n                        return [4 /*yield*/, this.http.post(\"batch\", reqs, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.do = function (scopeFn) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var runner;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        runner = new BatchRunner();\r\n                        scopeFn(runner);\r\n                        return [4 /*yield*/, this.batch(runner.mutationRequests)];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.deleteRealm = function (realm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.delete(\"realms/\" + realm)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.add = function (table, doc, branchId) {\r\n        return this.do(function (r) { return r.add(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.put = function (table, doc) {\r\n        return this.do(function (r) { return r.put(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        return this.do(function (r) { return r.update(table, id, deltaDoc, branchId); });\r\n    };\r\n    KedBackendClient.prototype.merge = function (branchId, targetBranchId) {\r\n        return this.do(function (r) { return r.merge(branchId, targetBranchId); });\r\n    };\r\n    KedBackendClient.prototype.clearBranch = function (branchId) {\r\n        return this.do(function (r) { return r.clearBranch(branchId); });\r\n    };\r\n    KedBackendClient.prototype.delete = function (table, id) {\r\n        return this.do(function (r) { return r.delete(table, id); });\r\n    };\r\n    KedBackendClient.prototype.share = function (table, id, acl) {\r\n        return this.do(function (r) { return r.share(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.unshare = function (table, id, acl) {\r\n        return this.do(function (r) { return r.unshare(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.link(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.link2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.link2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.unlink(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.unlink2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.unlink2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.undoLink = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.undoLink(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    return KedBackendClient;\r\n}());\r\nexport { KedBackendClient };\r\nvar BatchRunner = /** @class */ (function () {\r\n    function BatchRunner() {\r\n        this.mutationRequests = [];\r\n    }\r\n    BatchRunner.prototype.add = function (table, doc, branchId) {\r\n        this.mutationRequests.push({ op: 'add', table: table, doc: doc, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.put = function (table, doc) {\r\n        doc = tslib_1.__assign({}, doc);\r\n        delete doc.acl; // Forbidden to send acl with put() calls.\r\n        this.mutationRequests.push({ op: 'put', table: table, doc: doc });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        deltaDoc = tslib_1.__assign({}, deltaDoc);\r\n        this.mutationRequests.push({ op: 'update', table: table, id: id, deltaDoc: deltaDoc, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.merge = function (branchId, targetBranchId) {\r\n        this.mutationRequests.push({ op: 'merge', branchId: branchId, targetBranchId: targetBranchId });\r\n    };\r\n    BatchRunner.prototype.clearBranch = function (branchId) {\r\n        this.mutationRequests.push({ op: 'clear-branch', branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.delete = function (table, id) {\r\n        this.mutationRequests.push({ op: 'delete', table: table, id: id });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.share = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'share', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unshare = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'unshare', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unlink2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.undoLink = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'undo-link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    return BatchRunner;\r\n}());\r\nexport { BatchRunner };\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nimport { avoidSimultanousCalls } from './utils';\r\nvar KedBearerProvider = /** @class */ (function () {\r\n    function KedBearerProvider(isomorphic, storage, tokenId, clientId, clientSecret, tokenUrl, tokenQuery) {\r\n        this.isomorphic = isomorphic;\r\n        this.storage = storage;\r\n        this.tokenId = tokenId;\r\n        this.clientId = clientId;\r\n        this.clientSecret = clientSecret;\r\n        this.tokenUrl = tokenUrl;\r\n        this.tokenQuery = tokenQuery;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.client = new RestClient(isomorphic, \"\", {\r\n            username: this.clientId,\r\n            password: this.clientSecret\r\n        });\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    KedBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, token, expires, _b, e_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.tokenInfo, token = _a.token, expires = _a.expires;\r\n                        if (token && expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        _c.trys.push([1, 4, , 6]);\r\n                        _b = this;\r\n                        return [4 /*yield*/, this.storage.load(this.clientId + \"/\" + this.tokenId)];\r\n                    case 2:\r\n                        _b.tokenInfo = _c.sent();\r\n                        if (this.tokenInfo.token && this.tokenInfo.expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        e_1 = _c.sent();\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, retries, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        retries = 0;\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        if (!(retries < 6)) return [3 /*break*/, 5];\r\n                        console.log(\"Retrieving token for \" + this.tokenId);\r\n                        return [4 /*yield*/, this.client.get(this.tokenUrl, this.tokenQuery, { cache: 'reload' })];\r\n                    case 2:\r\n                        res = _c.sent();\r\n                        if (res.status !== 200) {\r\n                            console.warn(\"Got \" + res.status + \" \" + res.statusText);\r\n                            return [3 /*break*/, 4];\r\n                        }\r\n                        _a = this;\r\n                        _b = {};\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 3:\r\n                        _a.tokenInfo = (_b.token = _c.sent(), _b.expires = Date.now() + 59 * 60 * 1000, _b);\r\n                        console.log(\"Got token for \" + this.tokenId + \": \" + JSON.stringify(this.tokenInfo));\r\n                        this.storage.save(this.clientId + \"/\" + this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        ++retries;\r\n                        return [3 /*break*/, 1];\r\n                    case 5: throw new Error(\"Failed to retrieve token for \" + JSON.stringify(this.tokenId));\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBearerProvider;\r\n}());\r\nexport { KedBearerProvider };\r\n//# sourceMappingURL=ked-bearer-provider.js.map","/*\r\ndeclare var Buffer; // node built-in\r\n\r\n\r\nfunction basicAuthHeader(username, password) {\r\n    return \"Basic \" + new Buffer(username + \":\" + password).toString(\"base64\");\r\n}\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport { createUUID } from \"./utils\";\r\nimport { Emitter } from '../observable/emitter';\r\nvar RestClient = /** @class */ (function () {\r\n    function RestClient(isomorphic, baseUrl, options) {\r\n        this.isomorphic = isomorphic;\r\n        this.baseUrl = baseUrl;\r\n        this.options = options;\r\n        this.numOutstandingOperations = 0;\r\n        this.cache = {}; //, timeout: number}};\r\n        this._status = new Emitter(this);\r\n        this.fetchOptions = { mode: 'cors' };\r\n        this.authHeader = options.bearer ?\r\n            \"Bearer \" + options.bearer :\r\n            options.username ?\r\n                \"Basic \" + isomorphic.btoa(options.username + \":\" + (options.password || \"\")) :\r\n                null;\r\n        this.bearerProvider = options.bearerProvider || null;\r\n    }\r\n    Object.defineProperty(RestClient.prototype, \"status\", {\r\n        get: function () {\r\n            return this._status;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    RestClient.prototype.suspenseFetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        var key = method + \" \" + path + \" \" + JSON.stringify(headers) + \" \" + JSON.stringify(query) + \" \" + JSON.stringify(fetchOptions);\r\n        var entry = this.cache[key];\r\n        if (entry) {\r\n            // Entry found. Is it still being fetched?\r\n            if ('promise' in entry)\r\n                throw entry.promise; // Still being fetched. Multiple parallell fetches should work on same promise!\r\n            // Promise has resolved. Return result.\r\n            return entry.result;\r\n        }\r\n        else {\r\n            // We are the first to do this request. Start doing it:\r\n            var promise = this.fetch(path, method, headers, query, fetchOptions).then(function (res) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var status, text;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            status = res.status;\r\n                            return [4 /*yield*/, res.text()];\r\n                        case 1:\r\n                            text = _a.sent();\r\n                            this.cache[key] = {\r\n                                result: {\r\n                                    status: status,\r\n                                    text: function () { return text; },\r\n                                    json: function () { return JSON.parse(text); }\r\n                                }\r\n                            };\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); });\r\n            // Immediately put the promise in the cache. Multiple parallell fetches should work on the same promise!\r\n            this.cache[key] = { promise: promise };\r\n            // Suspend until promise is resolved. At that time, the cache will contain an answer!\r\n            throw promise;\r\n        }\r\n    };\r\n    RestClient.prototype.fetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        ++this.numOutstandingOperations;\r\n        this._status.dispatch(this);\r\n        return this._fetch(path, method, headers, query, fetchOptions)\r\n            .then(function (res) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return res;\r\n        }).catch(function (err) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return Promise.reject(err);\r\n        });\r\n    };\r\n    RestClient.prototype._fetch = function (path, method, headers, query, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var queryStr, _a, authHeader, tokenInfo, bearerProvider, _b, _c, url, res, wwwauth, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0:\r\n                        if (fetchOptions && fetchOptions.cache === 'no-cache') {\r\n                            // Workaround for back-button not respecting cache control in Chrome/Opera.\r\n                            // Append a query parameter to force a cache entry\r\n                            query = tslib_1.__assign({}, query, { nocache: createUUID() });\r\n                        }\r\n                        queryStr = query && Object.keys(query).filter(function (key) { return query[key] !== undefined; }).map(function (key) {\r\n                            return encodeURIComponent(key) +\r\n                                \"=\" +\r\n                                encodeURIComponent(query[key]);\r\n                        })\r\n                            .join('&');\r\n                        _a = this, authHeader = _a.authHeader, tokenInfo = _a.tokenInfo, bearerProvider = _a.bearerProvider;\r\n                        if (!(!authHeader && !tokenInfo && bearerProvider)) return [3 /*break*/, 2];\r\n                        _b = this;\r\n                        return [4 /*yield*/, bearerProvider.getBearer()];\r\n                    case 1:\r\n                        _b.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 2;\r\n                    case 2:\r\n                        if (!tokenInfo) return [3 /*break*/, 5];\r\n                        if (!(tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        console.log(\"Token expired. Refresh it:\");\r\n                        _c = this;\r\n                        return [4 /*yield*/, bearerProvider.refreshBearer()];\r\n                    case 3:\r\n                        _c.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 4;\r\n                    case 4:\r\n                        authHeader = \"Bearer \" + tokenInfo.token;\r\n                        _e.label = 5;\r\n                    case 5:\r\n                        // In one way or another, we've concluded an Authorization header to use:\r\n                        if (authHeader) {\r\n                            headers.Authorization = authHeader;\r\n                        }\r\n                        url = this.baseUrl + path + (queryStr ? \"?\" + queryStr : \"\");\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 6:\r\n                        res = _e.sent();\r\n                        if (!(res.status == 401 && this.bearerProvider)) return [3 /*break*/, 9];\r\n                        wwwauth = res.headers.get(\"www-authenticate\");\r\n                        console.log(\"Got \" + res.status + \" from \" + (this.baseUrl + path));\r\n                        if (!(wwwauth && /Bearer/i.test(wwwauth))) return [3 /*break*/, 9];\r\n                        _d = this;\r\n                        return [4 /*yield*/, this.bearerProvider.refreshBearer()];\r\n                    case 7:\r\n                        _d.tokenInfo = _e.sent();\r\n                        headers.Authorization = \"Bearer \" + this.tokenInfo.token;\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 8:\r\n                        res = _e.sent();\r\n                        _e.label = 9;\r\n                    case 9: return [2 /*return*/, res];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    RestClient.prototype.get = function (path, query, fetchOptions) {\r\n        return this.fetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.suspenseGet = function (path, query, fetchOptions) {\r\n        return this.suspenseFetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.post = function (path, data, fetchOptions) {\r\n        return this.fetch(path, \"POST\", {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Accept\": \"application/json\"\r\n        }, null, tslib_1.__assign({}, fetchOptions, { body: JSON.stringify(data) }));\r\n    };\r\n    RestClient.prototype.delete = function (path, query, body, fetchOptions) {\r\n        return this.fetch(path, \"DELETE\", { Accept: \"application/json; text/plain\" }, query, tslib_1.__assign({}, fetchOptions, { body: body }));\r\n    };\r\n    return RestClient;\r\n}());\r\nexport { RestClient };\r\n//# sourceMappingURL=restclient.js.map","import * as tslib_1 from \"tslib\";\r\nexport function createUUID() {\r\n    // Decent solution from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript\r\n    var d = Date.now();\r\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n        var r = (d + Math.random() * 16) % 16 | 0;\r\n        d = Math.floor(d / 16);\r\n        return (c === 'x' ? r : (r & 0x7 | 0x8)).toString(16);\r\n    });\r\n    return uuid;\r\n}\r\nexport function avoidSimultanousCalls(method) {\r\n    var ongoingPromise = null;\r\n    return function () {\r\n        if (!ongoingPromise) {\r\n            ongoingPromise = method.apply(this, arguments).then(function (result) {\r\n                ongoingPromise = null;\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromise;\r\n    };\r\n}\r\nexport function getGlobalId(realm) {\r\n    var prefix = 'ec96b3be-45fc-41d3-b69e-';\r\n    var pad = ['50', '08', 'e1', '40', 'e4', 'e7'];\r\n    if (realm.length > 6)\r\n        throw new Error(\"Too long realm\");\r\n    for (var i = 0; i < realm.length; ++i) {\r\n        var hex = realm.charCodeAt(i).toString(16);\r\n        pad[i] = hex.length === 2 ?\r\n            hex :\r\n            '0' + hex;\r\n    }\r\n    return prefix + pad.join('');\r\n}\r\nexport function computePredestinatedId(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, data, digest, _a, i;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    data = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', data)];\r\n                case 1:\r\n                    digest = new (_a.apply(Uint8Array, [void 0, _b.sent()]))();\r\n                    i = 0;\r\n                    return [2 /*return*/, 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n                            var nibble = digest[i++] % 16 | 0;\r\n                            var washedNibble = c === 'x' ?\r\n                                nibble :\r\n                                nibble & 0x7 | 0x8;\r\n                            return washedNibble.toString(16);\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function simpleDigest(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, inputBytes, digestBytes, _a;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    inputBytes = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', inputBytes)];\r\n                case 1:\r\n                    digestBytes = new (_a.apply(Uint8Array, [void 0, _b.sent(), 0, 16]))();\r\n                    return [2 /*return*/, buf2hex(digestBytes)];\r\n            }\r\n        });\r\n    });\r\n}\r\nvar simpleDigestCache = {};\r\nexport function simpleDigestSuspense(inputs) {\r\n    var results = inputs.map(function (input) { return simpleDigestCache[input]; });\r\n    var unresolvedInputs = [];\r\n    results.forEach(function (result, index) {\r\n        if (!result)\r\n            unresolvedInputs.push(inputs[index]);\r\n    });\r\n    if (unresolvedInputs.length === 0)\r\n        return results;\r\n    throw Promise.all(unresolvedInputs.map(function (input) { return simpleDigest(input).then(function (result) { return simpleDigestCache[input] = result; }); }));\r\n}\r\nexport function buf2hex(buffer) {\r\n    return Array.prototype.map.call(buffer, function (x) { return ('00' + x.toString(16)).slice(-2); }).join('');\r\n}\r\nexport function updateArray(a, mapper) {\r\n    var retval = a;\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var t = a[i];\r\n        var mapped = mapper(t);\r\n        if (mapped !== t) {\r\n            if (retval === a)\r\n                retval = a.slice();\r\n            retval[i] = mapped;\r\n        }\r\n    }\r\n    return retval;\r\n}\r\n/*\r\nexport function updateArray<T>(a: T[], mapper: (t: T) => T | false): T[] {\r\n  let retval = a;\r\n  let j = 0;\r\n  for (let i=0,l=a.length; i<l; ++i, ++j) {\r\n    const t = a[i];\r\n    const mapped = mapper(t);\r\n    if (mapped === false) {\r\n      // Mapper wants to delete this doc.\r\n      if (retval === a) retval = a.slice();\r\n      retval.splice(j, 1);\r\n      --j; // compensate for ++j\r\n    } else if (mapped !== t) {\r\n      if (retval === a) retval = a.slice();\r\n      retval[j] = mapped;\r\n    }\r\n  }\r\n  return retval;\r\n}\r\n*/ \r\n//# sourceMappingURL=utils.js.map","import * as JsonSchema from \"kedbackend-schema/schema.json\";\r\nimport { getTableFromLabel } from \"./utils\";\r\nvar CacheBust = /** @class */ (function () {\r\n    function CacheBust() {\r\n    }\r\n    CacheBust.getCacheBust = function (table, query, user, includes) {\r\n        var involvedItems = CacheBust.getInvolvedItems(table, query, includes);\r\n        return involvedItems\r\n            .map(function (item) { return localStorage.getItem(\"cache-bust-\" + user + \"-\" + item); })\r\n            .filter(function (value) { return !!value; })\r\n            .join('/') || 'static';\r\n    };\r\n    CacheBust.invalidateCache = function (reqs, user) {\r\n        for (var _i = 0, _a = CacheBust.getCacheInvalidations(reqs); _i < _a.length; _i++) {\r\n            var item = _a[_i];\r\n            localStorage.setItem(\"cache-bust-\" + user + \"-\" + item, '' + Date.now());\r\n        }\r\n    };\r\n    CacheBust.getInvolvedItems = function (table, query, includes) {\r\n        var hasEdgesFrom = query.hasEdgesFrom;\r\n        var relatedTables = includes\r\n            .map(function (label) { return JsonSchema.tables[table].relationships[label]; })\r\n            .filter(function (table) { return !!table; });\r\n        if (hasEdgesFrom)\r\n            relatedTables.push(\"hef\" + table);\r\n        return [table, 'master', query.branchId].filter(function (x) { return !!x; }).concat(relatedTables).sort();\r\n    };\r\n    CacheBust.getCacheInvalidations = function (reqs) {\r\n        var invalidationSet = {};\r\n        reqs.forEach(function (req) {\r\n            switch (req.op) {\r\n                case 'add':\r\n                case 'put':\r\n                case 'delete':\r\n                case 'update':\r\n                    invalidationSet[req.table] = true;\r\n                    break;\r\n                case 'link':\r\n                case 'unlink':\r\n                case 'undo-link':\r\n                    invalidationSet[req.sourceTable] = true;\r\n                    invalidationSet[\"hef-\" + getTableFromLabel(req.sourceTable, req.label)] = true;\r\n                    break;\r\n                case 'clear-branch':\r\n                    invalidationSet[req.branchId] = true;\r\n                    break;\r\n                case 'merge':\r\n                    invalidationSet[req.branchId] = true;\r\n                    invalidationSet[req.targetBranchId || \"master\"] = true;\r\n                    break;\r\n            }\r\n        });\r\n        return Object.keys(invalidationSet);\r\n    };\r\n    return CacheBust;\r\n}());\r\nexport { CacheBust };\r\n//# sourceMappingURL=cache-bust.js.map","import * as tslib_1 from \"tslib\";\r\nimport { mergeDeltas } from '../delta-merge';\r\nexport function applyMutationsOnDeltas(branchId, deltas, mutations, optimistic, userDisplayName, hasAdditionalFilter) {\r\n    var _loop_1 = function (m) {\r\n        switch (m.op) {\r\n            case 'add-related':\r\n                //\r\n                // AddRelated RepoMutation\r\n                //\r\n                if (!hasAdditionalFilter && m.branchId === branchId) {\r\n                    deltas = [{\r\n                            type: 'add',\r\n                            sourceId: m.id,\r\n                            targetId: m.relatedDoc.id,\r\n                            label: m.graphProp,\r\n                            sourceTable: m.table,\r\n                            $meta: optimistic ? 'adding' : 'persisted',\r\n                            dateTime: Date.now(),\r\n                            targetName: m.relatedDoc.name,\r\n                            contributor: userDisplayName\r\n                        }].concat(deltas);\r\n                }\r\n                break;\r\n            case 'clear-branch':\r\n                //\r\n                // ClearBranch RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                break;\r\n            case 'delete':\r\n                //\r\n                // Delete RepoMutation\r\n                //\r\n                // This type of mutation can not be performed onto branches. There's no branchId property on m.\r\n                break;\r\n            case 'merge':\r\n                //\r\n                // Merge RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                else if (m.targetBranchId === branchId) {\r\n                    // This change will append new deltas to our deltas array but we don't know what would come.\r\n                    // Need to refetch from server.\r\n                    if (!optimistic)\r\n                        return { value: null }; // Caller should check for null and re-fetch data from server.\r\n                }\r\n                break;\r\n            case 'remove-related':\r\n                //\r\n                // Remove-Related RepoMutation\r\n                //\r\n                if (hasAdditionalFilter || m.branchId !== branchId)\r\n                    return \"continue\";\r\n                deltas = [{\r\n                        type: 'remove',\r\n                        sourceId: m.id,\r\n                        targetId: m.relatedDoc.id,\r\n                        targetName: m.relatedDoc.name,\r\n                        label: m.graphProp,\r\n                        sourceTable: m.table,\r\n                        contributor: userDisplayName,\r\n                        dateTime: Date.now(),\r\n                        $meta: optimistic ? 'adding' : 'persisted'\r\n                    }].concat(deltas);\r\n                break;\r\n            case 'undo-link':\r\n                //\r\n                // Undo-Link RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (d) {\r\n                        return (d.type === 'add' || d.type === 'remove' || d.type === 'undo-link') &&\r\n                            d.sourceId === m.id &&\r\n                            d.targetId === m.relatedId;\r\n                    });\r\n                    if (idx < 0)\r\n                        return \"continue\";\r\n                    // Found an \"add\" or \"remove\" delta to change:\r\n                    if (optimistic) {\r\n                        var deltaRelation = deltas[idx];\r\n                        // Mark the existing add/remove delta as currenlty being deleted\r\n                        deltas = deltas.slice(0, idx).concat([\r\n                            tslib_1.__assign({}, deltaRelation, { $meta: optimistic ? 'removing' : 'persisted' })\r\n                        ], deltas.slice(idx + 1));\r\n                    }\r\n                    else {\r\n                        // Persisted. Just remove it:\r\n                        deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                    }\r\n                }\r\n                break;\r\n            case 'update':\r\n                //\r\n                // Update RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (delta) {\r\n                        return delta.type === 'modify' &&\r\n                            delta.targetId === m.id;\r\n                    });\r\n                    if (idx < 0 && !hasAdditionalFilter) {\r\n                        deltas = [{\r\n                                type: 'modify',\r\n                                table: m.table,\r\n                                targetId: m.id,\r\n                                targetName: m.targetName,\r\n                                data: m.deltaDoc,\r\n                                dateTime: Date.now(),\r\n                                contributors: [userDisplayName],\r\n                                $meta: optimistic ? 'adding' : 'persisted',\r\n                            }].concat(deltas);\r\n                    }\r\n                    else {\r\n                        var existingDeltaDoc = deltas[idx];\r\n                        var contributors = existingDeltaDoc.contributors.slice();\r\n                        if (!contributors.includes(userDisplayName)) {\r\n                            contributors.push(userDisplayName);\r\n                        }\r\n                        var newData = mergeDeltas(existingDeltaDoc.data, m.deltaDoc, { removeUnsetProps: true });\r\n                        if (!optimistic && Object.keys(newData).length === 0) {\r\n                            // Committed mutation that resets a deltaDoc. Remove the deltaDoc entirely:\r\n                            deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                        }\r\n                        else {\r\n                            // \r\n                            deltas = [\r\n                                {\r\n                                    type: 'modify',\r\n                                    table: m.table,\r\n                                    targetId: m.id,\r\n                                    targetName: m.targetName,\r\n                                    data: newData,\r\n                                    dateTime: Date.now(),\r\n                                    contributors: contributors,\r\n                                    $meta: optimistic ? 'updating' : 'persisted',\r\n                                }\r\n                            ].concat(deltas.slice(0, idx), deltas.slice(idx + 1));\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n        }\r\n    };\r\n    for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\r\n        var m = mutations_1[_i];\r\n        var state_1 = _loop_1(m);\r\n        if (typeof state_1 === \"object\")\r\n            return state_1.value;\r\n    }\r\n    return deltas;\r\n}\r\n//# sourceMappingURL=apply-mutations-on-deltas.js.map","import * as tslib_1 from \"tslib\";\r\nimport { HttpError } from '../../ked-backend-client';\r\nimport { applyMutationsOnDeltas } from './apply-mutations-on-deltas';\r\nvar DeltaCache = /** @class */ (function () {\r\n    function DeltaCache(getClient, getUser, getUserDisplayName) {\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.lookup = {};\r\n    }\r\n    DeltaCache.prototype.applyMutations = function (mutations, _a) {\r\n        var optimistic = (_a === void 0 ? { optimistic: false } : _a).optimistic;\r\n        // Apply mutations locally onto the DeltaCache and notify their subscribers\r\n        for (var _i = 0, _b = Object.keys(this.lookup); _i < _b.length; _i++) {\r\n            var queryKey = _b[_i];\r\n            var cacheEntry = this.lookup[queryKey];\r\n            if (cacheEntry.value) {\r\n                // Instead here: Store the mutations on cacheEntry. No matter if it yet has value or not.\r\n                // Then apply mutation whenever subscribing! (Better handling of mutations that arrives before fetch() is done)\r\n                // (See how I handle this in query-set.ts)\r\n                var newValue = applyMutationsOnDeltas(cacheEntry.query.branchId, cacheEntry.value, mutations, optimistic, this.getUserDisplayName(), !!cacheEntry.query.tags);\r\n                if (newValue === null) {\r\n                    // The mutation requires cacheEntry to be refetched from server\r\n                    if (!optimistic) {\r\n                        // Caller has successfully performed the mutations and got success back from server.\r\n                        // It's ok to refetch the deltas from server now:\r\n                        cacheEntry.fetch();\r\n                        // After fetch completes, it will notify the subscribers.\r\n                    }\r\n                }\r\n                if (newValue !== cacheEntry.value) {\r\n                    cacheEntry.optimisticValue = newValue;\r\n                    if (!optimistic)\r\n                        cacheEntry.value = newValue;\r\n                    cacheEntry.notify(newValue);\r\n                }\r\n            }\r\n        }\r\n    };\r\n    DeltaCache.prototype.subscribe = function (query, observer) {\r\n        var _this = this;\r\n        var cacheEntry = this.lookup[query.branchId + query.tags];\r\n        if (!cacheEntry) {\r\n            cacheEntry = new DeltaCacheEntry(this.getClient(), query);\r\n            this.lookup[query.branchId + query.tags] = cacheEntry;\r\n        }\r\n        if (cacheEntry.cleanupTimer) {\r\n            clearTimeout(cacheEntry.cleanupTimer);\r\n            cacheEntry.cleanupTimer = null;\r\n        }\r\n        var subscription = {\r\n            unsubscribe: function () {\r\n                cacheEntry.subscribers = cacheEntry.subscribers.filter(function (_a) {\r\n                    var o = _a.observer;\r\n                    return o !== observer;\r\n                });\r\n                if (cacheEntry.subscribers.length === 0) {\r\n                    cacheEntry.cleanupTimer = setTimeout(function () {\r\n                        if (cacheEntry.subscribers.length === 0) {\r\n                            delete _this.lookup[query.branchId + query.tags];\r\n                        }\r\n                    }, 100);\r\n                }\r\n            }\r\n        };\r\n        cacheEntry.subscribers.push({ observer: observer, subscription: subscription });\r\n        if (cacheEntry.value) {\r\n            // Value has been successfully retrieved already. Pick from cache.\r\n            observer(cacheEntry.optimisticValue || cacheEntry.value, null, subscription);\r\n        }\r\n        else if (cacheEntry.isFetching) {\r\n            // A value is on its way. Sit back and relax. All registered\r\n            // observers (including this one) will be notified when data arrives\r\n            // or fails.\r\n        }\r\n        else if (cacheEntry.error) {\r\n            observer(null, cacheEntry.error, subscription);\r\n        }\r\n        else {\r\n            cacheEntry.fetch();\r\n        }\r\n        return subscription;\r\n    };\r\n    return DeltaCache;\r\n}());\r\nexport { DeltaCache };\r\nvar DeltaCacheEntry = /** @class */ (function () {\r\n    function DeltaCacheEntry(client, query) {\r\n        this.fetchOperationId = 0; // Makes sure a re-fetch will discard the result from any ongoing fetch.\r\n        this.client = client;\r\n        this.query = query;\r\n        this.value = null;\r\n        this.error = null;\r\n        this.optimisticValue = null;\r\n        this.subscribers = [];\r\n        this.isFetching = false;\r\n        this.cleanupTimer = null;\r\n    }\r\n    DeltaCacheEntry.prototype.fetch = function () {\r\n        var _this = this;\r\n        var fetchOperationId = ++this.fetchOperationId;\r\n        this.isFetching = true;\r\n        this.fetchFromServer().then(function (value) {\r\n            // Success\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                value.sort(function (a, b) { return b.dateTime - a.dateTime; }); // Latest first\r\n                _this.value = value;\r\n                _this.optimisticValue = value;\r\n                _this.notify(value);\r\n            }\r\n        }).catch(function (error) {\r\n            // Fail\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                _this.error = error;\r\n                _this.fail(error);\r\n            }\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.fetchFromServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!this.query.branchId)\r\n                            throw new Error('Deltas only available on branches');\r\n                        return [4 /*yield*/, this.client.http.get('deltas', this.query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status >= 300 || res.status < 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.notify = function (value) {\r\n        for (var _i = 0, _a = this.subscribers; _i < _a.length; _i++) {\r\n            var _b = _a[_i], observer = _b.observer, subscription = _b.subscription;\r\n            observer(value, null, subscription);\r\n        }\r\n    };\r\n    DeltaCacheEntry.prototype.fail = function (error) {\r\n        var copy = this.subscribers.slice();\r\n        this.subscribers = [];\r\n        for (var _i = 0, copy_1 = copy; _i < copy_1.length; _i++) {\r\n            var _a = copy_1[_i], observer = _a.observer, subscription = _a.subscription;\r\n            observer(null, error, subscription);\r\n        }\r\n    };\r\n    return DeltaCacheEntry;\r\n}());\r\n//# sourceMappingURL=delta-cache.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Collection } from '../../observable';\r\nvar DeltaCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(DeltaCollection, _super);\r\n    function DeltaCollection(deltaCache, query) {\r\n        var _this = _super.call(this, function (observer) { return _this.deltaCache.subscribe(query, observer); }) || this;\r\n        _this.deltaCache = deltaCache;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    DeltaCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return new DeltaCollection(this.deltaCache, tslib_1.__assign({}, this.query, { tags: tags }));\r\n    };\r\n    return DeltaCollection;\r\n}(Collection));\r\nexport { DeltaCollection };\r\n//# sourceMappingURL=delta-collection.js.map","import * as tslib_1 from \"tslib\";\r\nexport function applyDelta(doc, delta) {\r\n    var keys = Object.keys(delta);\r\n    var targetDoc = doc;\r\n    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\r\n        var key = keys_1[_i];\r\n        if (targetDoc === doc)\r\n            targetDoc = tslib_1.__assign({}, doc);\r\n        var val = delta[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_1 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            // Do nothing on target doc!\r\n                            targetDoc.$wasUnset = true; // Just mark it for re-retrieval after successful posting changes.\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd = miValue;\r\n                            if (!Array.isArray(valuesToAdd)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            else {\r\n                                targetArray = targetArray.slice(); // On JS side, we must be immutable\r\n                            }\r\n                            targetDoc[key] = targetArray;\r\n                            for (var _i = 0, valuesToAdd_1 = valuesToAdd; _i < valuesToAdd_1.length; _i++) {\r\n                                var v = valuesToAdd_1[_i];\r\n                                if (!targetArray.includes(v)) { // avoid dups\r\n                                    targetArray.push(v);\r\n                                }\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_1 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_1)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            targetDoc[key] = targetArray.filter(function (t) { return !valuesToRemove_1.includes(t); });\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _a = 0, metaInstructions_1 = metaInstructions; _a < metaInstructions_1.length; _a++) {\r\n                    var mi = metaInstructions_1[_a];\r\n                    _loop_1(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDoc[key] = val;\r\n    }\r\n    return targetDoc;\r\n}\r\n// {name: \"Ulla\"}, {name: {$unset:0}\r\n// {tags: {$add: \"hej\"}}, {tags: {$unset:0}\"}\r\nexport function mergeDeltas(delta1, delta2, _a) {\r\n    var removeUnsetProps = (_a === void 0 ? { removeUnsetProps: false } : _a).removeUnsetProps;\r\n    //return {...delta1, ...delta2};\r\n    var keys = Object.keys(delta2);\r\n    var targetDelta = tslib_1.__assign({}, delta1);\r\n    for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {\r\n        var key = keys_2[_i];\r\n        var val = delta2[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_2 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            if (removeUnsetProps) {\r\n                                delete targetDelta[key];\r\n                            }\r\n                            else {\r\n                                // No matter if targetDelta is empty or has value. Set it to {$unset:0}\r\n                                // to make sure the very end result will have {$unset:0}\r\n                                targetDelta[key] = { $unset: 0 };\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd_2 = miValue;\r\n                            if (!Array.isArray(valuesToAdd_2)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$remove: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$add: [...]} arrays.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetRemoveArray)) {\r\n                                targetMetaProp.$remove =\r\n                                    targetRemoveArray.filter(function (t) { return !valuesToAdd_2.includes(t); });\r\n                                if (targetMetaProp.$remove.length === 0) {\r\n                                    // If $remove array became emtpy. Remove the $remove prop.\r\n                                    delete targetMetaProp.$remove;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $add array.\r\n                            var targetAddArray = targetMetaProp.$add;\r\n                            targetAddArray = targetAddArray ? targetAddArray.concat(valuesToAdd_2) : valuesToAdd_2.slice();\r\n                            targetMetaProp.$add = targetAddArray;\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_2 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_2)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$add: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$remove: [...]} arrays.\r\n                            var targetAddArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetAddArray)) {\r\n                                targetMetaProp.$add =\r\n                                    targetAddArray.filter(function (t) { return !valuesToRemove_2.includes(t); });\r\n                                if (targetMetaProp.$add.length === 0) {\r\n                                    // If $add array became emtpy. Remove the $add prop.\r\n                                    delete targetMetaProp.$add;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $remove array.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            targetRemoveArray = targetRemoveArray ? targetRemoveArray.concat(valuesToRemove_2) : valuesToRemove_2.slice();\r\n                            targetMetaProp.$remove = targetRemoveArray;\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _b = 0, metaInstructions_2 = metaInstructions; _b < metaInstructions_2.length; _b++) {\r\n                    var mi = metaInstructions_2[_b];\r\n                    _loop_2(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDelta[key] = val;\r\n    }\r\n    return targetDelta;\r\n}\r\n//# sourceMappingURL=delta-merge.js.map","export * from './kedbackend-collection';\r\nexport * from './kedbackend-query';\r\nexport * from './kedbackend-repo';\r\nexport * from './kedbackend-subscription';\r\nexport * from './kedbackend-writer';\r\nexport * from './mutation-queue';\r\nexport * from './query-set';\r\nexport * from '../observable/mixin';\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { KedBackendSubscription } from \"./kedbackend-subscription\";\r\nimport { CacheBust } from './cache-bust';\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport { Collection } from '../observable/collection';\r\n/**\r\n * Represents a \"live\" query against a table or filtered table.\r\n */\r\nvar KedBackendCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendCollection, _super);\r\n    function KedBackendCollection(repo, table, query) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = new KedBackendSubscription(observer, _this);\r\n            _this.repo.querySet.subscribe(subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.repo = repo;\r\n        _this.table = table;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    Object.defineProperty(KedBackendCollection.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendCollection.prototype, \"includes\", {\r\n        get: function () {\r\n            return this._includes || (this._includes = [].concat(this.query.include || []));\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendCollection.prototype.applyQuery = function (query) {\r\n        return new KedBackendCollection(this.repo, this.table, tslib_1.__assign({}, this.query, query));\r\n    };\r\n    KedBackendCollection.prototype.addToQueryArrayProp = function (arrayProp, entries) {\r\n        var _a;\r\n        return this.applyQuery((_a = {}, _a[arrayProp] = (this.query[arrayProp] || []).concat(entries), _a));\r\n    };\r\n    KedBackendCollection.prototype.addFlags = function () {\r\n        var flags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            flags[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"flags\", flags);\r\n    };\r\n    KedBackendCollection.prototype.debug = function () {\r\n        return this.applyQuery({ debug: true });\r\n    };\r\n    KedBackendCollection.prototype.idsOnly = function () {\r\n        return this.addFlags(\"idsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.idsAndNamesOnly = function () {\r\n        return this.addFlags(\"idsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsOnly = function () {\r\n        return this.addFlags(\"includeIdsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsAndNamesOnly = function () {\r\n        return this.addFlags(\"includeIdsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.between = function (from, to) {\r\n        return this.applyQuery({ from: from, to: to });\r\n    };\r\n    KedBackendCollection.prototype.role = function (role) {\r\n        return this.applyQuery({ role: role });\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesFrom = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesFrom(\" + JSON.stringify(ids) + \")\");\r\n        var hef = this.addToQueryArrayProp(\"hasEdgesFrom\", ids);\r\n        return hef;\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesTo = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesTo(\" + JSON.stringify(ids) + \")\");\r\n        var het = this.addToQueryArrayProp(\"hasEdgesTo\", ids);\r\n        return het;\r\n    };\r\n    KedBackendCollection.prototype.id = function (id) {\r\n        var _this = this;\r\n        return this.applyQuery({ ids: [id] }).single({\r\n            onZero: function () { throw new Error(\"Could not find entity in \" + _this.table + \" with id \" + id); },\r\n            onMany: function () { throw new Error(\"Multiple entries in \" + _this.table + \" with id \" + id); },\r\n        });\r\n    };\r\n    KedBackendCollection.prototype.ids = function (ids) {\r\n        return this.applyQuery({ ids: ids });\r\n    };\r\n    KedBackendCollection.prototype.name = function (name) {\r\n        return this.applyQuery({ name: name });\r\n    };\r\n    KedBackendCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return this.applyQuery({ tags: tags });\r\n    };\r\n    KedBackendCollection.prototype.branchId = function (branchId) {\r\n        return this.applyQuery({ branchId: branchId });\r\n    };\r\n    KedBackendCollection.prototype.include = function () {\r\n        var graphs = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            graphs[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"include\", graphs);\r\n    };\r\n    KedBackendCollection.prototype.cacheOptimized = function (onOrOff) {\r\n        return onOrOff === undefined || onOrOff === true ?\r\n            this.applyQuery({ cacheBust: CacheBust.getCacheBust(this.table, this.query, this.repo.getUser(), this.includes) }) :\r\n            this.applyQuery({ cacheBust: undefined });\r\n    };\r\n    KedBackendCollection.prototype.mutationsOnEmpty = function (mutationFactory) {\r\n        var tx = new BatchRunner();\r\n        mutationFactory(tx);\r\n        return this.applyQuery({ mutationsOnEmpty: tx.mutationRequests });\r\n    };\r\n    KedBackendCollection.prototype.single = function (throwers) {\r\n        var _this = this;\r\n        var _a = throwers || {}, onZero = _a.onZero, onMany = _a.onMany;\r\n        return this.toValue().map(function (items) {\r\n            if (items.length === 0) {\r\n                if (onZero)\r\n                    onZero();\r\n                else\r\n                    throw new Error(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but none was found.\");\r\n            }\r\n            if (items.length > 1) {\r\n                debugger;\r\n                if (onMany)\r\n                    onMany();\r\n                else\r\n                    console.log(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but \" + items.length + \" was found.\");\r\n            }\r\n            return items[0];\r\n        });\r\n    };\r\n    /*combineLatest<TOther>(other: QueryObservable<TOther>) {\r\n      return this.render(x => x).combineLatest(other);\r\n    }*/\r\n    KedBackendCollection.prototype.update = function (doc, changes, debounce) {\r\n        if (debounce === void 0) { debounce = 1000; }\r\n        this.repo.writer.mutate([{\r\n                op: 'update',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: doc.id,\r\n                deltaDoc: changes,\r\n                targetName: doc.name\r\n            }], debounce);\r\n    };\r\n    KedBackendCollection.prototype.addRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.add = function (doc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add',\r\n                id: doc.id,\r\n                table: this.table,\r\n                doc: doc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.removeRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'remove-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.undoLink = function (id, label, relatedId) {\r\n        if (!this.query.branchId)\r\n            throw new Error(\"undo links can only be performed on branches\");\r\n        this.repo.writer.mutate([{\r\n                op: 'undo-link',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedId: relatedId\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.delete = function () {\r\n        var _this = this;\r\n        var ids = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            ids[_i] = arguments[_i];\r\n        }\r\n        this.repo.writer.mutate(ids.map(function (id) { return ({\r\n            op: 'delete',\r\n            table: _this.table,\r\n            id: id\r\n        }); }), 0);\r\n    };\r\n    KedBackendCollection.prototype.unsubscribe = function (subscription) {\r\n        this.repo.querySet.unsubscribe(subscription);\r\n    };\r\n    return KedBackendCollection;\r\n}(Collection));\r\nexport { KedBackendCollection };\r\n/*mixin(\r\n  KedBackendCollection.prototype,\r\n  MappedCollection.prototype,\r\n  \"map\", \"flat\", \"concat\", \"render\", \"load\");*/\r\n//# sourceMappingURL=kedbackend-collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { updateArray } from '../ked-backend-client/utils';\r\nimport { branchSensitive, getTableFromLabel } from './utils';\r\nimport { applyDelta } from './delta-merge';\r\nvar KedBackendQuery = /** @class */ (function () {\r\n    function KedBackendQuery(table, query, user, repo, mutationQueue) {\r\n        this.table = table;\r\n        this.query = query;\r\n        this.user = user;\r\n        this.repo = repo;\r\n        this.mutationQueue = mutationQueue;\r\n        this.subscriptions = [];\r\n        this.data = [];\r\n        this.gotInitialResponse = false;\r\n        this.invalid = false;\r\n        this.loadedVersion = 0;\r\n        this._loadPromise = null;\r\n        this.includes = query.include ?\r\n            typeof query.include === 'string' ?\r\n                [query.include] :\r\n                query.include :\r\n            [];\r\n    }\r\n    KedBackendQuery.queryKey = function (table, query) {\r\n        var mutationsOnEmpty = query.mutationsOnEmpty, comparableProps = tslib_1.__rest(query, [\"mutationsOnEmpty\"]);\r\n        return table + JSON.stringify(comparableProps);\r\n    };\r\n    Object.defineProperty(KedBackendQuery.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendQuery.prototype.subscribe = function (subscription) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.subscriptions.push(subscription);\r\n                        if (!(this.gotInitialResponse && !this.invalid)) return [3 /*break*/, 1];\r\n                        data = this.getDataWithMutationsApplied(this.mutationQueue.get(), true, this.data);\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 1:\r\n                        data = this.queryLocally();\r\n                        if (!data) return [3 /*break*/, 2];\r\n                        this.data = data;\r\n                        this.error = null;\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.load()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var loadPromise;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.gotInitialResponse) {\r\n                            // mutationsOnEmpty should never be used twice.\r\n                            delete this.query.mutationsOnEmpty;\r\n                        }\r\n                        if (!(!version && this._loadPromise)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this._loadPromise];\r\n                    case 1: \r\n                    // loading is ongoing, and caller does not require a recent refresh.\r\n                    // wait for the ongoing load to complete\r\n                    return [2 /*return*/, _a.sent()];\r\n                    case 2:\r\n                        version = version || this.repo.writer.persistedVersion.value;\r\n                        loadPromise = this._loadPromise = this._load(version).then(function (data) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                _this.data = data;\r\n                                _this.loadedVersion = Math.max(_this.loadedVersion, version);\r\n                            }\r\n                        }).catch(function (error) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. The error is the final result. Set it.\r\n                                _this.error = error;\r\n                            }\r\n                        }).then(function () {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. We're finished. Data or error is already set.\r\n                                // Mark gotInitialResponse to true and notify subscribers.\r\n                                _this._loadPromise = null;\r\n                                _this.gotInitialResponse = true;\r\n                                _this.notifySubscribers(_this.mutationQueue.get());\r\n                            }\r\n                            else {\r\n                                // A more recent call to load() is ongoing, OR was ongoing but responded\r\n                                // before us.\r\n                                // In any case return this._loadPromise. If it's ongoing we'll wait for it\r\n                                // to finish. If it's null, we'll be returning finally here without\r\n                                // any action, because the action was taken by the refresher.\r\n                                return _this._loadPromise; // Wait for the refreshed load to complete\r\n                            }\r\n                        });\r\n                        return [4 /*yield*/, loadPromise];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype._load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.mutationQueue.affectsQuery(this.table, this.query, this.includes)) return [3 /*break*/, 2];\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        return [4 /*yield*/, this.repo.writer.waitForVersionToPersist(version)];\r\n                    case 1:\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [4 /*yield*/, this.queryServer()];\r\n                    case 3: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.unsubscribe = function (subscription) {\r\n        this.subscriptions = this.subscriptions.filter(function (s) { return s !== subscription; });\r\n    };\r\n    KedBackendQuery.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _i, mutations_1, m, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.data) return [3 /*break*/, 9];\r\n                        _i = 0, mutations_1 = mutations;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < mutations_1.length)) return [3 /*break*/, 8];\r\n                        m = mutations_1[_i];\r\n                        if (!(m.op === 'clear-branch' && (m.branchId === this.query.branchId))) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 3:\r\n                        if (!(m.op === 'merge' && (!m.targetBranchId ||\r\n                            m.branchId === this.query.branchId ||\r\n                            m.targetBranchId === this.query.branchId))) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 5:\r\n                        if (!(m.op === 'update' && ((m.deltaDoc.tags && this.query.tags) ||\r\n                            (m.deltaDoc.name && this.query.name)))) return [3 /*break*/, 7];\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 6:\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 7:\r\n                        _i++;\r\n                        return [3 /*break*/, 1];\r\n                    case 8:\r\n                        data = this.getDataWithMutationsApplied(mutations, false, this.data);\r\n                        this.data = data;\r\n                        _a.label = 9;\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.refreshOrInvalidate = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(this.subscriptions.length === 0)) return [3 /*break*/, 1];\r\n                        this.invalid = true;\r\n                        return [3 /*break*/, 3];\r\n                    case 1: return [4 /*yield*/, this.load(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.notifySubscribers = function (optimisticMutations) {\r\n        var _this = this;\r\n        if (this.data && this.gotInitialResponse) {\r\n            var data_1 = this.getDataWithMutationsApplied(optimisticMutations, true, this.data);\r\n            this.subscriptions.forEach(function (s) {\r\n                s.notifySubscriber(data_1, _this.error);\r\n            });\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.queryLocally = function () {\r\n        return this.repo.querySet.queryLocally(this.table, this.query, this.includes);\r\n    };\r\n    KedBackendQuery.prototype.queryServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.repo.getClient().list(this.table, tslib_1.__assign({}, this.query))];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        return [2 /*return*/, data];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.getDataWithMutationsApplied = function (mutations, optimistic, data) {\r\n        var _this = this;\r\n        mutations.forEach(function (mutation) {\r\n            data = _this.applyMutationsOnData(data, mutation, optimistic);\r\n        });\r\n        return data;\r\n    };\r\n    KedBackendQuery.prototype.applyMutationsOnData = function (data, m, optimistic) {\r\n        if (branchSensitive(m) && m.branchId != this.query.branchId)\r\n            return data;\r\n        var _a = this, table = _a.table, includes = _a.includes, listOptions = _a.query;\r\n        var sourceIds = listOptions.hasEdgesFrom ? [].concat(listOptions.hasEdgesFrom || []) : [];\r\n        var requestedTags = listOptions.tags ? [].concat(listOptions.tags || []) : [];\r\n        switch (m.op) {\r\n            case 'update': {\r\n                return updateArray(data, function (doc) {\r\n                    if (doc.id === m.id) {\r\n                        // Apply delta on updated document\r\n                        var updatedDoc = applyDelta(doc, m.deltaDoc);\r\n                        if (optimistic)\r\n                            updatedDoc.$meta = 'updating';\r\n                        return updatedDoc;\r\n                    }\r\n                    // If id does not apply to this doc, search in graphs the id is found\r\n                    // among graph included docs, and if so, update that one:\r\n                    includes.forEach(function (label) {\r\n                        var _a;\r\n                        var includedDocs = doc[label];\r\n                        if (includedDocs) {\r\n                            var updatedArray = updateArray(includedDocs, function (related) {\r\n                                if (related.id !== m.id)\r\n                                    return related;\r\n                                var updatedRelated = applyDelta(related, m.deltaDoc);\r\n                                if (optimistic)\r\n                                    updatedRelated.$meta = 'updating';\r\n                                return updatedRelated;\r\n                            });\r\n                            if (updatedArray !== includedDocs) {\r\n                                doc = tslib_1.__assign({}, doc, (_a = {}, _a[label] = updatedArray, _a));\r\n                            }\r\n                        }\r\n                    });\r\n                    return doc;\r\n                });\r\n            }\r\n            case 'add':\r\n                if (table === m.table) {\r\n                    if (listOptions.tags) {\r\n                        var queriedTags_1 = [].concat(listOptions.tags); // tag can be either string or string[]. Make is string[] always.\r\n                        if (m.doc.tags && m.doc.tags.some(function (tag) { return queriedTags_1.includes(tag); })) {\r\n                            return data.concat([m.doc]); // Make the added doc appear in the result (optimistic mutation)\r\n                        }\r\n                    }\r\n                    // Todo, apply also for other list options, like ids:\r\n                    // The above code for 'add' was only written to cover the use case of teachers-page notifications!\r\n                }\r\n                return data; // fallback case - query was not affected.\r\n            case 'add-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    // If expression is `db.courseBlocks....whatever.. .include(\"abilities\")`, detect: db.courseBlocks.addRelated(blockId, 'abilities', ...)\r\n                    // ...because table = 'courseBlocks' and includes has \"abilities\".\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        var relatedDoc = tslib_1.__assign({}, m.relatedDoc);\r\n                        if (optimistic)\r\n                            relatedDoc.$meta = 'adding';\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = doc[m.graphProp].concat([relatedDoc]), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id)) {\r\n                        // If expression is:\r\n                        //   `db.courseBlocks.hasEdgesFrom([courseId])`  (meaning table='courseBlocks' and sourceIds includes courseId)\r\n                        // , detect: db.courseInstances.addRelated(courseId, 'courseBlocks', ....) // m.graphProp === 'blocks'--> getTableFromLabel --> 'courseBlocks'\r\n                        if (table === getTableFromLabel(m.table, m.graphProp)) {\r\n                            if (!listOptions.tags)\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            if (m.relatedDoc.tags && requestedTags.some(function (tag) { return m.relatedDoc.tags.includes(tag); })) {\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (listOptions.ids && listOptions.ids.some(function (id) { return id === m.relatedDoc.id; })) {\r\n                    // A certain ID is observed. A doc with this id is being added.\r\n                    // Add the doc to the result. Exactly this WILL happen in the following typical scenario:\r\n                    // 1. User adds a related document to a list.\r\n                    // 2. Document remains within the MutationQueue while batch-request is being processed by server.\r\n                    // 3. User clicks the added item to edit or view it (or our component redirects to its editor)\r\n                    // 4. A new query of that particular ID is subscribed to {ids=[theId]}\r\n                    //    KedBackendQuery.subscribe then does this:\r\n                    //      1. Call queryLocally() before querying server\r\n                    //      2. queryLocally() inspects mutations and finds a match, returning an empty list\r\n                    //         (assumes as we are adding it, it can't exist on the server anyway)\r\n                    //      3. KedBackendQUery applies mutations onto the empty list, and ends up here to add\r\n                    //         it optimistically.\r\n                    //      4. When server responds with 200 OK, calls us here again with optimistic=false\r\n                    //         to \"persist\" it in the query's data array.\r\n                    //      4B: If not 200 OK, mutation may be gone and the subscriber will se an error page\r\n                    //         \"Could not find entity with id X.\" along with a red error message on the screen\r\n                    //         about that it failed to save on server.\r\n                    return data.concat(this.setGraphProps(m.relatedDoc));\r\n                }\r\n                return data;\r\n            case 'remove-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        var includedDocs = doc[m.graphProp];\r\n                        if (!includedDocs)\r\n                            return doc;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = optimistic ?\r\n                            // Mark related-doc-to-remove with $meta: 'deleting'\r\n                            includedDocs.map(function (d) { return d.id !== m.relatedDoc.id ?\r\n                                d : tslib_1.__assign({}, d, { $meta: 'deleting' }); }) :\r\n                            // Delete related-doc-to-remove from doc[grapProp]:\r\n                            includedDocs.filter(function (d) { return d.id !== m.relatedDoc.id; }), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id))\r\n                        return optimistic ?\r\n                            data.map(function (d) { return d.id === m.relatedDoc.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                            data.filter(function (d) { return d.id !== m.relatedDoc.id; });\r\n                }\r\n                return data;\r\n            case 'delete':\r\n                if (table === m.table) {\r\n                    return data.filter(function (d) { return d.id !== m.id; });\r\n                }\r\n                else if (listOptions.include) {\r\n                    var includedTables = includes\r\n                        .map(function (label) { return ({ label: label, table: getTableFromLabel(table, label) }); });\r\n                    var labels_1 = includedTables.filter(function (_a) {\r\n                        var table = _a.table;\r\n                        return table === m.table;\r\n                    });\r\n                    if (labels_1.length > 0) {\r\n                        return updateArray(data, function (doc) {\r\n                            labels_1.forEach(function (_a) {\r\n                                var label = _a.label;\r\n                                var _b;\r\n                                var relatedDocs = doc[label];\r\n                                if (relatedDocs) {\r\n                                    doc = tslib_1.__assign({}, doc, (_b = {}, _b[label] = optimistic ?\r\n                                        relatedDocs.map(function (d) { return d.id === m.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                                        relatedDocs.filter(function (_a) {\r\n                                            var id = _a.id;\r\n                                            return id !== m.id;\r\n                                        }), _b));\r\n                                }\r\n                            });\r\n                            return doc;\r\n                        });\r\n                    }\r\n                }\r\n                return data;\r\n            default:\r\n                return data;\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.setGraphProps = function (doc) {\r\n        var copy = tslib_1.__assign({}, doc);\r\n        this.includes.forEach(function (label) { return copy[label] = copy[label] || []; });\r\n        return copy;\r\n    };\r\n    return KedBackendQuery;\r\n}());\r\nexport { KedBackendQuery };\r\n//# sourceMappingURL=kedbackend-query.js.map","import * as tslib_1 from \"tslib\";\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { KedBackendCollection } from './kedbackend-collection';\r\nimport { QuerySet } from './query-set';\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { KedBackendWriter } from './kedbackend-writer';\r\nimport { DeltaCollection } from './delta-collection/delta-collection';\r\nvar KedBackendRepo = /** @class */ (function () {\r\n    function KedBackendRepo(getClient, getUser, getUserDisplayName, defaultQueryOptions, mutationQueue, querySet, writer, cacheOptimized) {\r\n        var _this = this;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.defaultQueryOptions = defaultQueryOptions;\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.writer = writer;\r\n        this.cacheOptimized = cacheOptimized;\r\n        if (!defaultQueryOptions)\r\n            this.defaultQueryOptions = {};\r\n        if (!mutationQueue)\r\n            this.mutationQueue = new MutationQueue();\r\n        if (!querySet)\r\n            this.querySet = new QuerySet(this.mutationQueue);\r\n        if (!writer)\r\n            this.writer = new KedBackendWriter(this.mutationQueue, this.querySet, getClient, getUser, getUserDisplayName);\r\n        Object.keys(tables).forEach(function (table) {\r\n            var collection = new KedBackendCollection(_this, table, defaultQueryOptions || {});\r\n            if (cacheOptimized) {\r\n                collection = collection.cacheOptimized();\r\n            }\r\n            _this[table] = collection;\r\n        });\r\n        this.deltas = new DeltaCollection(this.writer.deltaCache, {\r\n            branchId: this.defaultQueryOptions.branchId // If branchId is undefined. DeltaCollection will respond with Error on subscribe()\r\n        });\r\n    }\r\n    KedBackendRepo.prototype.table = function (tableName) {\r\n        var collection = new KedBackendCollection(this, tableName, this.defaultQueryOptions);\r\n        if (this.cacheOptimized)\r\n            collection = collection.cacheOptimized();\r\n        return collection;\r\n    };\r\n    KedBackendRepo.prototype._clone = function (queryOptions, cacheOptimized) {\r\n        var clone = new KedBackendRepo(this.getClient, this.getUser, this.getUserDisplayName, tslib_1.__assign({}, this.defaultQueryOptions, queryOptions), this.mutationQueue, this.querySet, this.writer, cacheOptimized === undefined ? this.cacheOptimized : cacheOptimized);\r\n        return clone;\r\n    };\r\n    KedBackendRepo.prototype.branch = function (branchId) {\r\n        return this._clone({ branchId: branchId });\r\n    };\r\n    KedBackendRepo.prototype.role = function (role) {\r\n        return this._clone({ role: role });\r\n    };\r\n    KedBackendRepo.prototype.optimizeCache = function () {\r\n        return this._clone({}, true);\r\n    };\r\n    KedBackendRepo.prototype.clearBranch = function () {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot clear master branch\");\r\n        this.writer.mutate([{ op: 'clear-branch', branchId: this.defaultQueryOptions.branchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.merge = function (targetBranchId) {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot merge from master branch\");\r\n        this.writer.mutate([{ op: 'merge', branchId: this.defaultQueryOptions.branchId, targetBranchId: targetBranchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.saveNow = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.writer.waitForVersionToPersist(this.writer.currentVersion)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBackendRepo;\r\n}());\r\nexport { KedBackendRepo };\r\n//# sourceMappingURL=kedbackend-repo.js.map","var KedBackendSubscription = /** @class */ (function () {\r\n    function KedBackendSubscription(subscriber, collection) {\r\n        this.subscriber = subscriber;\r\n        this.collection = collection;\r\n    }\r\n    KedBackendSubscription.prototype.notifySubscriber = function (data, error) {\r\n        try {\r\n            if (error)\r\n                this.subscriber([], error, this);\r\n            else if (data !== this.lastNotifiedData) { // Will in-fact be equal by reference if data is same as last notification (as we use an immutable approach on data)\r\n                this.lastNotifiedData = data;\r\n                this.subscriber(data, error, this);\r\n            }\r\n        }\r\n        catch (ex) {\r\n            try {\r\n                this.subscriber([], ex, this);\r\n            }\r\n            catch (ex2) {\r\n                console.error(\"Error while notifying KedBackendSubscriber:\", ex2, 'originally notified error:', ex);\r\n            }\r\n        }\r\n    };\r\n    KedBackendSubscription.prototype.unsubscribe = function () {\r\n        this.collection.unsubscribe(this);\r\n    };\r\n    return KedBackendSubscription;\r\n}());\r\nexport { KedBackendSubscription };\r\n//# sourceMappingURL=kedbackend-subscription.js.map","import * as tslib_1 from \"tslib\";\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { CacheBust } from './cache-bust';\r\nimport { Emitter } from '../observable';\r\nimport { DeltaCache } from './delta-collection/delta-cache';\r\nvar KedBackendWriter = /** @class */ (function () {\r\n    function KedBackendWriter(mutationQueue, querySet, getClient, getUser, getUserDisplayName) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = null;\r\n        this.currentVersion = 0;\r\n        this.persistedVersion = new Emitter(0);\r\n        this.errorSubscribers = [];\r\n        this.stateSubscribers = [];\r\n        this.deltaCache = new DeltaCache(getClient, getUser, getUserDisplayName);\r\n    }\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isSaving\", {\r\n        get: function () { return !!this._isSavingPromise; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isEdited\", {\r\n        get: function () { return this.mutationQueue.get().length > 0; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendWriter.prototype.onError = function (callback) {\r\n        this.errorSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.onStateChange = function (callback) {\r\n        this.stateSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.off = function (callback) {\r\n        this.errorSubscribers = this.errorSubscribers.filter(function (s) { return s !== callback; });\r\n        this.stateSubscribers = this.stateSubscribers.filter(function (s) { return s !== callback; });\r\n    };\r\n    KedBackendWriter.prototype.dispatchError = function (error, retryable) {\r\n        var _this = this;\r\n        this.errorSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(error, retryable, _this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.dispatchStateChange = function () {\r\n        var _this = this;\r\n        this.stateSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(_this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mutate = function (mutations, debounce) {\r\n        this.mutationQueue.add(mutations);\r\n        ++this.currentVersion;\r\n        this.dispatchStateChange();\r\n        this.querySet.notifySubscribers();\r\n        this.deltaCache.applyMutations(this.mutationQueue.get(), { optimistic: true });\r\n        if (!this._isSavingPromise) {\r\n            if (this._timeoutId)\r\n                clearTimeout(this._timeoutId);\r\n            this._timeoutId = setTimeout(this.save.bind(this), debounce);\r\n        }\r\n        // If isSaving, we don't need to do anything, becase it will re-check if additional\r\n        // mutations have come, when saving is done.\r\n    };\r\n    KedBackendWriter.prototype.retrySave = function () {\r\n        return this.save();\r\n    };\r\n    KedBackendWriter.prototype.waitForVersionToPersist = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedVersion;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.persistedVersion.load()];\r\n                    case 1:\r\n                        persistedVersion = _a.sent();\r\n                        if (!(persistedVersion < version)) return [3 /*break*/, 3];\r\n                        this.save(); // Be more eager to save\r\n                        return [4 /*yield*/, this.persistedVersion.filter(function (persistedVersion) { return persistedVersion >= version; }).load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.save = function () {\r\n        var _this = this;\r\n        if (this._timeoutId)\r\n            clearTimeout(this._timeoutId);\r\n        if (this._isSavingPromise)\r\n            return this._isSavingPromise;\r\n        if (!this.isEdited)\r\n            return Promise.resolve();\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = this._save();\r\n        this._isSavingPromise.catch(function () { }).then(function () { return _this._isSavingPromise = null; });\r\n        return this._isSavingPromise;\r\n    };\r\n    KedBackendWriter.prototype._save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var mutations, version, mutationRequests, res_1, etagMutations, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.dispatchStateChange();\r\n                        mutations = this.mutationQueue.get();\r\n                        version = this.currentVersion;\r\n                        this.mutationQueue.moveToSavingQueue();\r\n                        mutationRequests = this.mapMutations(mutations);\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 6, 11, 12]);\r\n                        return [4 /*yield*/, this.getClient().batch(mutationRequests)];\r\n                    case 2:\r\n                        res_1 = _a.sent();\r\n                        etagMutations = Object.keys(res_1.newEtags).map(function (id) { return ({\r\n                            op: 'update',\r\n                            table: null,\r\n                            id: id,\r\n                            deltaDoc: { $etag: res_1.newEtags[id] },\r\n                            targetName: null // We don't have the target name. But this mutation won't be visible in a DeltaCollection anyway, so it wont be used.\r\n                        }); });\r\n                        // Invalidate cache\r\n                        CacheBust.invalidateCache(mutationRequests, this.getUser());\r\n                        // Commmit mutations along with etagMutations into queries cached data\r\n                        this.persistedVersion.dispatch(version);\r\n                        this.deltaCache.applyMutations(mutations, { optimistic: false });\r\n                        return [4 /*yield*/, this.querySet.commitMutations(MutationQueue.merge(mutations, etagMutations), version)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        // On success, clear saving queue as the mutations will now be committed to all query's data instead.\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        // Finally, notify subscribers so that views get updated with committed results\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 5];\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 4:\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5: return [3 /*break*/, 12];\r\n                    case 6:\r\n                        error_1 = _a.sent();\r\n                        this.persistedVersion.dispatchError(error_1);\r\n                        if (!(error_1 && error_1.name && error_1.name.startsWith(\"http4\"))) return [3 /*break*/, 9];\r\n                        // Access Control denied, bad request or similar. Throw mutations away.\r\n                        this.dispatchError(error_1, false);\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 8];\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 7:\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        _a.sent();\r\n                        _a.label = 8;\r\n                    case 8: return [3 /*break*/, 10];\r\n                    case 9:\r\n                        this.dispatchError(error_1, true);\r\n                        _a.label = 10;\r\n                    case 10: return [3 /*break*/, 12];\r\n                    case 11:\r\n                        this.dispatchStateChange();\r\n                        return [7 /*endfinally*/];\r\n                    case 12: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mapMutations = function (mutations) {\r\n        var br = new BatchRunner();\r\n        mutations.forEach(function (m) {\r\n            switch (m.op) {\r\n                case 'update':\r\n                    br.update(m.table, m.id, m.deltaDoc, m.branchId);\r\n                    break;\r\n                case 'add':\r\n                    br.add(m.table, m.doc);\r\n                    break;\r\n                case 'add-related':\r\n                    if (!m.relatedDoc.$etag) {\r\n                        // No $etag means this is a new document. Add it before linking to it:\r\n                        br.add(tables[m.table].relationships[m.graphProp], m.relatedDoc, m.branchId);\r\n                    }\r\n                    br.link2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'remove-related':\r\n                    br.unlink2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'undo-link':\r\n                    br.undoLink(m.table, m.id, m.graphProp, m.relatedId, m.branchId);\r\n                    break;\r\n                case 'delete':\r\n                    br.delete(m.table, m.id);\r\n                    break;\r\n                case 'clear-branch':\r\n                    br.clearBranch(m.branchId);\r\n                    break;\r\n                case 'merge':\r\n                    br.merge(m.branchId, m.targetBranchId);\r\n                    break;\r\n            }\r\n        });\r\n        return br.mutationRequests;\r\n    };\r\n    return KedBackendWriter;\r\n}());\r\nexport { KedBackendWriter };\r\n//# sourceMappingURL=kedbackend-writer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { getTableFromLabel, branchSensitive, globalOp } from './utils';\r\nimport { mergeDeltas } from './delta-merge';\r\nvar MutationQueue = /** @class */ (function () {\r\n    function MutationQueue() {\r\n        this.queue = [];\r\n        this.savingQueue = [];\r\n    }\r\n    MutationQueue.prototype.add = function (mutations) {\r\n        this.queue = MutationQueue.merge(this.queue, mutations);\r\n    };\r\n    MutationQueue.prototype.moveToSavingQueue = function () {\r\n        this.savingQueue = MutationQueue.merge(this.savingQueue, this.queue);\r\n        this.queue = [];\r\n    };\r\n    MutationQueue.prototype.clearSavingQueue = function () {\r\n        this.savingQueue = [];\r\n    };\r\n    MutationQueue.prototype.get = function () {\r\n        return this.savingQueue.concat(this.queue);\r\n    };\r\n    MutationQueue.prototype.affectsQuery = function (table, query, includes) {\r\n        var mutations = this.get();\r\n        if (mutations.some(function (m) { return m.op === 'merge' || m.op === 'clear-branch'; }))\r\n            return true;\r\n        if (query.ids) {\r\n            // A query with \"ids\" filter will be easy to detect a no-match on:\r\n            return mutations.some(function (m) { return globalOp(m) || (!branchSensitive(m) || m.branchId === query.branchId) &&\r\n                query.ids.includes(m.id); });\r\n        }\r\n        // Otherwise, check if mutations affect same branch and table. Could be done more fine grained,\r\n        // but that would only be a suboptimization.\r\n        return mutations.some(function (m) {\r\n            return m.op === 'add' ?\r\n                m.table === table :\r\n                m.op === 'delete' ?\r\n                    m.table === table || (includes.some(function (label) { return getTableFromLabel(table, label) === m.table; })) :\r\n                    globalOp(m) ? true :\r\n                        m.branchId == query.branchId &&\r\n                            (m.table === table || (m.op !== 'update' && ([table].concat(includes.map(function (label) { return getTableFromLabel(table, label); })).some(function (table) { return getTableFromLabel(m.table, m.graphProp) === table; }))));\r\n        });\r\n    };\r\n    MutationQueue.merge = function (queue1, queue2) {\r\n        var mutableQueue1 = queue1.slice();\r\n        var mutableQueue2 = queue2.slice();\r\n        //if (mutableQueue1.length > 0) debugger;\r\n        var len = queue1.length;\r\n        var _loop_1 = function (i) {\r\n            var m = queue1[i];\r\n            if (m.op === 'update') {\r\n                var overlappingIdOpIdx = mutableQueue2.findIndex(function (newMut) {\r\n                    return newMut.op === 'update' &&\r\n                        newMut.branchId === m.branchId &&\r\n                        newMut.id === m.id;\r\n                });\r\n                if (overlappingIdOpIdx >= 0) {\r\n                    mutableQueue1[i] = tslib_1.__assign({}, m, { deltaDoc: mergeDeltas(m.deltaDoc, mutableQueue2[overlappingIdOpIdx].deltaDoc) });\r\n                    mutableQueue2.splice(overlappingIdOpIdx, 1);\r\n                }\r\n            }\r\n        };\r\n        for (var i = 0; i < len; ++i) {\r\n            _loop_1(i);\r\n        }\r\n        return mutableQueue1.concat(mutableQueue2);\r\n    };\r\n    return MutationQueue;\r\n}());\r\nexport { MutationQueue };\r\n//# sourceMappingURL=mutation-queue.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport * as JsonSchema from 'kedbackend-schema/schema.json';\r\nimport { queryArray } from './utils';\r\nvar QuerySet = /** @class */ (function () {\r\n    function QuerySet(mutationQueue) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.queries = [];\r\n    }\r\n    QuerySet.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, Promise.all(this.queries.map(function (q) { return q.commitMutations(mutations, version); }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.cleanupInvalidQueries();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QuerySet.prototype.cleanupInvalidQueries = function () {\r\n        this.queries = this.queries.filter(function (q) {\r\n            if (q.invalid) {\r\n                if (q.timeoutHandle) {\r\n                    clearTimeout(q.timeoutHandle);\r\n                    q.timeoutHandle = null;\r\n                }\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n    };\r\n    QuerySet.prototype.notifySubscribers = function () {\r\n        var optimisticMutations = this.mutationQueue.get();\r\n        this.queries.forEach(function (q) {\r\n            q.notifySubscribers(optimisticMutations);\r\n        });\r\n    };\r\n    QuerySet.prototype.findQuery = function (table, query) {\r\n        return this.queries.find(function (q) { return q.queryKey === KedBackendQuery.queryKey(table, query); });\r\n    };\r\n    QuerySet.prototype.queryLocally = function (table, query, includes) {\r\n        // For now, only handle this very common and special case (which\r\n        // will save a lot of unnescessary network traffic if I am thinking right...)\r\n        var mutations = this.mutationQueue.get();\r\n        // Check if the query wants to get a single entity by its ID:\r\n        if (query.ids && query.ids.length === 1) {\r\n            // And if so, if we have an outgoing mutation to create that entity:\r\n            if (mutations.some(function (m) { return m.op === 'add-related' && m.relatedDoc.id === query.ids[0]; })) {\r\n                // Then return an EMPTY response, signalling that we can resolve this locally,\r\n                // but let the optistic feature of KedBackendQuery apply the mutation before\r\n                // notifying subscribers (we don't want it to be persistent before the server\r\n                // has accepted the mutation)\r\n                return [];\r\n            }\r\n        }\r\n        // OK, another quite common case is when we ask for a certain ID and that ID replies\r\n        // within another query\r\n        if (query.hasEdgesFrom || query.hasEdgesTo)\r\n            return null; // Not possible to handle\r\n        if (!query.ids)\r\n            return null; // For now, just take hight for this particular and most common case!\r\n        var _loop_1 = function (q) {\r\n            if (!q.gotInitialResponse)\r\n                return \"continue\";\r\n            if (q.query.branchId !== query.branchId)\r\n                return \"continue\";\r\n            if (q.query.flags)\r\n                return \"continue\"; // It would be complex to support various flags. Query's data may include ids only. Can't rely on the query.\r\n            var qIncludes = q.includes;\r\n            if (qIncludes.length > 0 && (!query.include || query.include.length === 0)) {\r\n                // We don't include, but this query does. Check if we can find our result within it.\r\n                var label = qIncludes.find(function (l) { return JsonSchema.tables[q.table][\"relationships\"][l] === table; });\r\n                if (label) {\r\n                    var res_1 = {};\r\n                    for (var _i = 0, _a = q.data; _i < _a.length; _i++) {\r\n                        var entity = _a[_i];\r\n                        var subData = queryArray(query, entity[label]);\r\n                        subData.forEach(function (r) { return res_1[r.id] = r; });\r\n                    }\r\n                    var result_1 = Object.keys(res_1).map(function (id) { return res_1[id]; });\r\n                    // Only return result if we could look up every requested ID:\r\n                    if (!query.ids.every(function (id) { return result_1.some(function (x) { return x.id === id; }); }))\r\n                        return \"continue\";\r\n                    return { value: result_1 };\r\n                }\r\n            }\r\n            if (!includes.every(function (label) { return qIncludes.includes(label); }))\r\n                return \"continue\";\r\n            // Lastly, if the query includes all graphs that we do, pick the subset from that query.\r\n            // Concrete example: We observe a certain Task by ID and want its knowledgeRequirements along with it,\r\n            // and there's another query of all tasks that also includes knowledgeRequirements. Use it. \r\n            if (q.table === table) {\r\n                var result_2 = queryArray(query, q.data);\r\n                // Only return result if we could look up every requested ID:\r\n                if (!query.ids.every(function (id) { return result_2.some(function (x) { return x.id === id; }); }))\r\n                    return \"continue\";\r\n                return { value: result_2 };\r\n            }\r\n        };\r\n        for (var _i = 0, _a = this.queries; _i < _a.length; _i++) {\r\n            var q = _a[_i];\r\n            var state_1 = _loop_1(q);\r\n            if (typeof state_1 === \"object\")\r\n                return state_1.value;\r\n        }\r\n    };\r\n    QuerySet.prototype.subscribe = function (subscription) {\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (!kbQuery) {\r\n            kbQuery = new KedBackendQuery(table, query, repo.getUser(), repo, this.mutationQueue);\r\n            this.queries.push(kbQuery);\r\n        }\r\n        else {\r\n            if (kbQuery.timeoutHandle) {\r\n                clearTimeout(kbQuery.timeoutHandle);\r\n                kbQuery.timeoutHandle = null;\r\n            }\r\n        }\r\n        kbQuery.subscribe(subscription);\r\n    };\r\n    QuerySet.prototype.unsubscribe = function (subscription) {\r\n        var _this = this;\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (kbQuery) {\r\n            // Prohibit further notifications to this subscription:\r\n            kbQuery.unsubscribe(subscription);\r\n            // Release unnescessary memory when there are no more subscriptions of this query, by removing the query itself\r\n            // To that in a delayed manner, so that an unsubscribe() followed by an immediate subscribe() don't have to re-query the server:\r\n            if (kbQuery.subscriptions.length === 0) {\r\n                // Schedule for garbage collection in 5 minutes:\r\n                kbQuery.timeoutHandle = setTimeout(function () {\r\n                    // Check if kbQuery still has no subscriptions (not certain! A new subscriber may have come along...)\r\n                    if (kbQuery.subscriptions.length === 0) {\r\n                        // Still no subscriptions on it, time to release some memory and forget the in-memory cache of the query result\r\n                        _this.queries = _this.queries.filter(function (q) { return q !== kbQuery; });\r\n                    }\r\n                }, this.queries.length > 50 ?\r\n                    500 : // Don't host too many queries. Garbage collect this within 500 ms\r\n                    5 * 60000); // Allow query in memory for another 5 minutes\r\n            }\r\n        }\r\n    };\r\n    return QuerySet;\r\n}());\r\nexport { QuerySet };\r\n//# sourceMappingURL=query-set.js.map","import { tables } from 'kedbackend-schema/schema.json';\r\nexport function getTableFromLabel(table, label) {\r\n    return tables[table].relationships[label];\r\n}\r\nexport function queryArray(query, data) {\r\n    var filter = getFilterFromQuery(query);\r\n    return data.filter(filter);\r\n}\r\nexport function AND(filter1, filter2) {\r\n    return function (x) { return filter1(x) && filter2(x); };\r\n}\r\nexport function getFilterFromQuery(query) {\r\n    var filter = function (x) { return true; };\r\n    if (query.from)\r\n        return AND(filter, function (x) { return x.dateTime >= query.from; });\r\n    if (query.to)\r\n        return AND(filter, function (x) { return x.dateTime < query.to; });\r\n    if (query.ids)\r\n        return AND(filter, function (x) { return query.ids.includes(x.id); });\r\n    if (query.name)\r\n        return AND(filter, function (x) { return x.name === query.name; });\r\n    if (query.tags)\r\n        return AND(filter, function (x) { return x.tags && [].concat(query.tags || []).some(function (tag) { return x.tags.includes(tag); }); });\r\n    // query.hasEdgesFrom and query.hasEdgesTo cannot by filtered here\r\n    return filter;\r\n}\r\nexport function branchSensitive(m) {\r\n    return m.op !== 'delete';\r\n}\r\nexport function globalOp(m) {\r\n    return m.op === 'clear-branch' || m.op === 'merge';\r\n}\r\n//# sourceMappingURL=utils.js.map","import migrate from './migrate';\r\nexport var KedModelMigratorMixin = function (client) {\r\n    if (client.__migrator_mixed_in)\r\n        return;\r\n    client.__migrator_mixed_in = true;\r\n    var get = client.get;\r\n    var list = client.list;\r\n    client.get = function (table, id, options) {\r\n        var include = options && options.include;\r\n        return get.apply(this, arguments).then(function (result) {\r\n            migrate(result, table, include && include.toString().split(','));\r\n            return result;\r\n        });\r\n    };\r\n    client.list = function (table, options) {\r\n        var include = options && options.include;\r\n        return list.apply(this, arguments).then(function (result) {\r\n            result.forEach(function (doc) { return migrate(doc, table, include && include.toString().split(',')); });\r\n            return result;\r\n        });\r\n    };\r\n    return client;\r\n};\r\n//# sourceMappingURL=index.js.map","import migrateTask from './migrate-task';\r\nexport default function migrateCourse(course, graphs) {\r\n    if (!course.modules)\r\n        course.modules = [];\r\n    course.modules.forEach(function (module) {\r\n        if (!module.resources) {\r\n            module.resources = [];\r\n        }\r\n        if (!module.taskIds) {\r\n            module.taskIds = [];\r\n        }\r\n    });\r\n    if (!course.responsibleTeachers) {\r\n        course.responsibleTeachers = [];\r\n    }\r\n    // Earlier wrong spelling of resources\r\n    if ('resourses' in course && !('resources' in course)) {\r\n        course.resources = course.resourses;\r\n        delete course.resourses;\r\n    }\r\n    if (!course.resources) {\r\n        course.resources = [];\r\n    }\r\n    if (graphs) {\r\n        graphs.forEach(function (label) {\r\n            switch (label) {\r\n                case 'tasks':\r\n                    course.tasks.forEach(function (task) { return migrateTask(task); });\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=migrate-course.js.map","export default function migrateTask(task) {\r\n    if (!task.resources)\r\n        task.resources = [];\r\n}\r\n//# sourceMappingURL=migrate-task.js.map","import migrateCourse from './migrate-course';\r\nimport migrateTask from './migrate-task';\r\nexport default function migrate(doc, table, graphs) {\r\n    switch (table) {\r\n        case \"courses\":\r\n            migrateCourse(doc, graphs);\r\n            break;\r\n        case \"tasks\":\r\n            migrateTask(doc);\r\n            break;\r\n    }\r\n}\r\n//# sourceMappingURL=migrate.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Value } from \"./value\";\r\nimport { Emitter } from \"./emitter\";\r\nvar Collection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Collection, _super);\r\n    function Collection(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Collection.prototype._map = function (mapper) {\r\n        throw \"mixedin\";\r\n    };\r\n    Collection.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Collection(function (s) { return x.subscribe(s); });\r\n        if (Array.isArray(x)) {\r\n            var emitter_1 = new Emitter(x);\r\n            return new Collection(function (s) { return emitter_1.subscribe(s); });\r\n        }\r\n        throw new Error(\"ObservableCollection.from() can only take arrays or observables\");\r\n    };\r\n    Collection.prototype.map = function (mapper) {\r\n        return this._map(function (items) { return items.map(function (item) { return mapper(item); }); });\r\n    };\r\n    Collection.prototype.flat = function () {\r\n        return this._map(function (items) { return [].concat.apply([], items); });\r\n    };\r\n    Collection.prototype.filter = function (filter) {\r\n        return this._map(function (items) { return items.filter(filter); });\r\n    };\r\n    Collection.prototype.concat = function (other) {\r\n        return Collection.from(this.toValue().combineLatest(other).map(function (_a) {\r\n            var me = _a[0], other = _a[1];\r\n            return me.concat(other);\r\n        }));\r\n    };\r\n    Collection.prototype.orderBy = function (prop) {\r\n        return this.toValue().map(function (array) { return array.slice().sort(function (a, b) {\r\n            var aProp = a && a[prop];\r\n            var bProp = b && b[prop];\r\n            return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n        }); }).toCollection(function (x) { return x; });\r\n    };\r\n    Collection.prototype.toValue = function () {\r\n        var _this = this;\r\n        return new Value(function (s) { return _this.subscribe(s); });\r\n    };\r\n    Collection.prototype.groupBy = function (prop) {\r\n        return this.toValue().map(function (items) {\r\n            var rv = {};\r\n            items.forEach(function (item) {\r\n                var list = rv[item[prop]] || (rv[item[prop]] = []);\r\n                list.push(item);\r\n            });\r\n            return rv;\r\n        });\r\n    };\r\n    Collection.prototype.first = function () {\r\n        return this.toValue().map(function (arr) { return arr[0]; });\r\n    };\r\n    return Collection;\r\n}(Observable));\r\nexport { Collection };\r\nCollection.prototype._map = initMapMethod(Collection);\r\n//# sourceMappingURL=collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Value } from \"./value\";\r\nvar Emitter = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Emitter, _super);\r\n    function Emitter(initialValue) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = {\r\n                unsubscribe: function () { return _this.subscribers = _this.subscribers.filter(function (_a) {\r\n                    var s = _a[0];\r\n                    return s !== observer;\r\n                }); },\r\n            };\r\n            _this.subscribers.push([observer, subscription]);\r\n            if (_this.error)\r\n                observer(null, _this.error, subscription);\r\n            else\r\n                observer(_this.value, undefined, subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.subscribers = [];\r\n        _this.value = initialValue;\r\n        return _this;\r\n    }\r\n    Emitter.prototype.dispatch = function (value) {\r\n        this.value = value;\r\n        this.error = undefined;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype.dispatchError = function (error) {\r\n        this.error = error;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype._dispatch = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (_a) {\r\n            var observer = _a[0], subscription = _a[1];\r\n            try {\r\n                observer(_this.value, _this.error, subscription);\r\n            }\r\n            catch (err) {\r\n                observer(null, err, subscription);\r\n            }\r\n        });\r\n    };\r\n    return Emitter;\r\n}(Value));\r\nexport { Emitter };\r\n//# sourceMappingURL=emitter.js.map","var stack = [];\r\nvar currentFiber = null;\r\nvar providers = [function () { return currentFiber; }];\r\nfunction pushFiber(fiber) {\r\n    stack.push(currentFiber);\r\n    currentFiber = fiber;\r\n}\r\nfunction popFiber() {\r\n    currentFiber = stack.pop();\r\n}\r\nvar _FiberContext = {\r\n    get current() { return currentFiber; },\r\n    /*run: function rerun<R>(fiber: Fiber, fn: ()=>R): R | Promise<R> {\r\n      pushFiber(fiber);\r\n      try {\r\n        return Promise.resolve(fn());\r\n      } catch (p) {\r\n        if (p && typeof p.then === 'function') {\r\n          return p.then(()=>rerun(fiber, fn));\r\n        } else {\r\n          return Promise.reject(p);\r\n        }\r\n      } finally {\r\n        popFiber();\r\n      }\r\n    },*/\r\n    addProvider: function (getCurrentFiber) {\r\n        providers.push(getCurrentFiber);\r\n        setCurrentGetterFromProviders();\r\n    },\r\n    removeProvider: function (getCurrentFiber) {\r\n        providers = providers.filter(function (p) { return p !== getCurrentFiber; });\r\n        setCurrentGetterFromProviders();\r\n    }\r\n};\r\nfunction setCurrentGetterFromProviders() {\r\n    Object.defineProperty(_FiberContext, \"current\", {\r\n        get: providers.reduce(function (p, c) { return function () { return p() || c(); }; }),\r\n        set: function () { throw new Error(\"Use FiberContext.push() to change current fiber\"); }\r\n    });\r\n}\r\nvar _global = (typeof self === 'undefined' ? global : self);\r\nif (!_global[\"KEDFiberContext\"]) {\r\n    _global[\"KEDFiberContext\"] = _FiberContext;\r\n}\r\nexport var FiberContext = _global[\"KEDFiberContext\"];\r\n//# sourceMappingURL=fiber-context.js.map","export * from './observable';\r\nexport * from './value';\r\nexport * from './collection';\r\nexport * from './emitter';\r\nexport * from './fiber-context';\r\n//# sourceMappingURL=index.js.map","export function initMapMethod(ctor) {\r\n    return function (mapper) {\r\n        var _this = this;\r\n        return new ctor(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else\r\n                try {\r\n                    observer(mapper(value), error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n        }); });\r\n    };\r\n}\r\n//# sourceMappingURL=map.js.map","export function mixin(targetProto, mixinProto) {\r\n    var props = [];\r\n    for (var _i = 2; _i < arguments.length; _i++) {\r\n        props[_i - 2] = arguments[_i];\r\n    }\r\n    props.forEach(function (prop) { return targetProto[prop] = mixinProto[prop]; });\r\n}\r\n//# sourceMappingURL=mixin.js.map","var Observable = /** @class */ (function () {\r\n    //static get [Symbol.species]() { return this; }\r\n    function Observable(_subscribe) {\r\n        this._subscribe = _subscribe;\r\n    }\r\n    Observable.prototype.subscribe = function (observer) {\r\n        try {\r\n            return this._subscribe(function (items, error, subscription) {\r\n                try {\r\n                    observer(items, error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n            });\r\n        }\r\n        catch (error) {\r\n            observer(null, error, { unsubscribe: function () { } });\r\n        }\r\n    };\r\n    return Observable;\r\n}());\r\nexport { Observable };\r\n//# sourceMappingURL=observable.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Collection } from \"./collection\";\r\nimport { FiberContext } from './fiber-context';\r\nvar Value = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Value, _super);\r\n    function Value(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Value.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Value(function (s) { return x.subscribe(s); });\r\n        throw new Error(\"Value.from() can only take observables\");\r\n    };\r\n    Value.prototype.read = function () {\r\n        var resolved = false, result, err, notify;\r\n        var subscription = this.subscribe(function (value, error, subsciption) {\r\n            resolved = true;\r\n            result = value;\r\n            err = error;\r\n            if (error && notify)\r\n                notify(null, error, subsciption);\r\n            else if (notify)\r\n                notify(value, null, subsciption);\r\n        });\r\n        if (resolved) {\r\n            var currentFiber = FiberContext.current;\r\n            if (!currentFiber) {\r\n                subscription.unsubscribe();\r\n                throw new Error(\"Invalid Fiber Context\");\r\n            }\r\n            if (err) {\r\n                subscription.unsubscribe();\r\n                throw err;\r\n            }\r\n            var subscriptions = currentFiber.subscriptions, observer = currentFiber.observer;\r\n            subscriptions.push(subscription);\r\n            notify = observer;\r\n            return result;\r\n        }\r\n        throw new Promise(function (resolve, reject) {\r\n            notify = function (value, error, subscription) {\r\n                subscription.unsubscribe();\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n            };\r\n        });\r\n    };\r\n    Value.prototype.load = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.subscribe(function (value, error, subsciption) {\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n                subsciption.unsubscribe();\r\n            });\r\n        });\r\n    };\r\n    Value.prototype.filter = function (fn) {\r\n        var _this = this;\r\n        return new Value(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else if (fn(value))\r\n                observer(value, error, subscription);\r\n        }); });\r\n    };\r\n    Value.prototype.log = function (prefix) {\r\n        return this.map(function (x) {\r\n            console.log(prefix, x);\r\n            return x;\r\n        });\r\n    };\r\n    Value.prototype.toCollection = function (mapper) {\r\n        var _this = this;\r\n        return new Collection(function (s) { return _this.map(mapper).subscribe(s); });\r\n    };\r\n    Value.prototype.combineLatest = function (other) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var values = [null, null];\r\n            var mySubscription, otherSubscription;\r\n            var subscription = {\r\n                unsubscribe: function () {\r\n                    mySubscription.unsubscribe();\r\n                    otherSubscription.unsubscribe();\r\n                }\r\n            };\r\n            mySubscription = _this.subscribe(function (items, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[0] = items;\r\n                if (values[1] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            otherSubscription = other.subscribe(function (value, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[1] = value;\r\n                if (values[0] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            return subscription;\r\n        });\r\n    };\r\n    Value.prototype.switchMap = function (mapper) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var mappedSubscription = null;\r\n            var subscription = null;\r\n            var returnedSubscription = {\r\n                unsubscribe: function () {\r\n                    subscription.unsubscribe();\r\n                    if (mappedSubscription) {\r\n                        mappedSubscription.unsubscribe();\r\n                        mappedSubscription = null;\r\n                    }\r\n                }\r\n            };\r\n            subscription = _this.subscribe(function (item, error, s) {\r\n                subscription = s;\r\n                if (mappedSubscription) {\r\n                    mappedSubscription.unsubscribe();\r\n                    mappedSubscription = null;\r\n                }\r\n                if (error)\r\n                    observer(null, error, returnedSubscription);\r\n                else {\r\n                    try {\r\n                        var observableOrValue = mapper(item);\r\n                        if (observableOrValue && typeof observableOrValue.subscribe === 'function') {\r\n                            mappedSubscription = observableOrValue.subscribe(function (value, error, s) {\r\n                                mappedSubscription = s;\r\n                                observer(value, error, returnedSubscription);\r\n                            });\r\n                        }\r\n                        else {\r\n                            observer(observableOrValue, null, subscription);\r\n                        }\r\n                    }\r\n                    catch (error) {\r\n                        observer(null, error, subscription);\r\n                    }\r\n                }\r\n            });\r\n            return returnedSubscription;\r\n        });\r\n    };\r\n    return Value;\r\n}(Observable));\r\nexport { Value };\r\nValue.prototype.map = initMapMethod(Value);\r\n//# sourceMappingURL=value.js.map","export * from './js/dist/js/observable';\r\n","export * from './js/dist/js/ked-backend-repo';\r\n","export default function getUserClaims(user) {\r\n    return [{\r\n            type: \"email\",\r\n            value: user.mail\r\n        }, {\r\n            type: \"school\",\r\n            value: user.school\r\n        }].concat(user.roles.map(function (role) { return ({\r\n        type: \"role\",\r\n        value: role\r\n    }); })).concat(user.roles.map(function (role) { return ({\r\n        type: \"schoolRole\",\r\n        value: user.school + \"/\" + role\r\n    }); }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { DocumentAccess, hasAccess as _hasAccess } from 'kedbackend/client';\r\nimport getUserClaims from './get-user-claims';\r\nimport { parseQueryString, generateQueryString } from \"../utils/query-string\";\r\nexport { getUserClaims };\r\nexport var IMPERSONATION_QUERY_PARAMS = [\r\n    \"user\",\r\n    \"role\",\r\n    \"school\",\r\n    \"debug\",\r\n    \"testVersion\",\r\n    \"testversion\",\r\n    \"features\",\r\n    \"schoolGrade\",\r\n    \"schoolgrade\",\r\n    \"schoolType\",\r\n    \"schooltype\"\r\n];\r\nexport function hasAccess(user, doc, requestedRight) {\r\n    var claims = getUserClaims(user);\r\n    if (requestedRight !== 'R' && user.tutorFor) {\r\n        claims = claims.filter(function (claim) { return claim.type !== 'email'; });\r\n    }\r\n    var result = _hasAccess(DocumentAccess.fromStringArray(doc.acl || []), claims, requestedRight);\r\n    //console.log(`Has ${requestedRight} access to ${doc.name}/${doc.id}: ${result}`);\r\n    return result;\r\n}\r\nexport function hasReadAccess(user, doc) {\r\n    return hasAccess(user, doc, 'R');\r\n}\r\nexport function hasWriteAccess(user, doc) {\r\n    return hasAccess(user, doc, 'W');\r\n}\r\nexport function hasShareAccess(user, doc) {\r\n    return hasAccess(user, doc, 'S');\r\n}\r\nexport function isTeacherAtSchool(user, school) {\r\n    var isTeacher = user.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\r\n    var belongsToSchool = (school || \"\").toLowerCase() === user.school.toLowerCase();\r\n    return (isTeacher && belongsToSchool);\r\n}\r\nexport function isAdminOrTeacherAtSchool(user, school) {\r\n    return user.roles.includes(\"ADMIN\") || isTeacherAtSchool(user, school);\r\n}\r\nexport var impersonationEnv = {\r\n    actAs: function (options) {\r\n        var role = options.role, school = options.school, url = options.url;\r\n        var currentQuery = parseQueryString(location.search);\r\n        var newQuery = tslib_1.__assign({}, currentQuery, { role: role, school: school });\r\n        var newQueryString = generateQueryString(newQuery);\r\n        if (url) {\r\n            location.href = \"\" + url + newQueryString;\r\n        }\r\n        else {\r\n            location.hash = \"#\";\r\n            location.search = newQueryString;\r\n        }\r\n    }\r\n};\r\nexport function actAs(options) {\r\n    impersonationEnv.actAs(options);\r\n}\r\nexport function preserveImpersonationQuery(url, query) {\r\n    var e_1, _a;\r\n    var currentQuery = parseQueryString(location.search);\r\n    var preservedQuery = {};\r\n    try {\r\n        for (var IMPERSONATION_QUERY_PARAMS_1 = tslib_1.__values(IMPERSONATION_QUERY_PARAMS), IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next(); !IMPERSONATION_QUERY_PARAMS_1_1.done; IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next()) {\r\n            var param = IMPERSONATION_QUERY_PARAMS_1_1.value;\r\n            if (currentQuery[param])\r\n                preservedQuery[param] = currentQuery[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (IMPERSONATION_QUERY_PARAMS_1_1 && !IMPERSONATION_QUERY_PARAMS_1_1.done && (_a = IMPERSONATION_QUERY_PARAMS_1.return)) _a.call(IMPERSONATION_QUERY_PARAMS_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    var newQueryString = generateQueryString(tslib_1.__assign({}, preservedQuery, query));\r\n    var pHash = url.indexOf('#');\r\n    return pHash >= 0 ?\r\n        \"\" + url.substr(0, pHash) + newQueryString + url.substr(pHash) :\r\n        \"\" + url + newQueryString;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from 'kedbackend/client';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { getTermStarEndDate } from '../utils/school-moment';\r\nimport { SchoolTerm } from '../utils/school-term';\r\nimport { dateTimeReviver, L } from '../utils/utils';\r\nimport mockJsonFile from './mock/mock-eds-data.json';\r\nimport moment from 'moment';\r\nimport { makeSuspenseApi } from '../utils/make-suspense-api';\r\nvar EdsClient = /** @class */ (function () {\r\n    function EdsClient(isomorphic, baseUrl, bearerProvider, userEmailGetter) {\r\n        var _this = this;\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n        this.userEmailGetter = userEmailGetter;\r\n        var isApiMethod = function (m) {\r\n            return typeof _this[m] === 'function' &&\r\n                m !== 'constructor' && // Since makeSuspenseApi() walks prototype chain\r\n                m !== 'privatizingCacheBust' &&\r\n                m !== 'userEmailGetter';\r\n        } // List non-API methods here...\r\n        ;\r\n        Object.keys(EdsClient.prototype).forEach(function (method) {\r\n            if (isApiMethod(method)) {\r\n                _this[method] = avoidSimultanousCalls(_this[method]);\r\n            }\r\n        });\r\n        this.suspense = makeSuspenseApi(this, { isApiMethod: isApiMethod });\r\n    }\r\n    EdsClient.prototype.privatizingCacheBust = function () {\r\n        return { user: this.userEmailGetter() };\r\n    };\r\n    /**\r\n       * Retrieve active courses for current logged in student.\r\n       *\r\n       * @param courseCode Short-name of the course. Optional.\r\n       */\r\n    EdsClient.prototype.getActiveCourses = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json, ex_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _c.trys.push([0, 5, , 6]);\r\n                        query = this.privatizingCacheBust();\r\n                        if (q) {\r\n                            if (q.courseCode)\r\n                                query.CourseCode = q.courseCode;\r\n                            if (q.periodName)\r\n                                query.PeriodName = q.periodName;\r\n                        }\r\n                        return [4 /*yield*/, this.http.get(\"studentactivecourses\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.courses];\r\n                    case 5:\r\n                        ex_1 = _c.sent();\r\n                        console.error(\"Error from EDS: \" + ex_1);\r\n                        throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"], [\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"]))));\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve latest assessments for current logged in user.\r\n     *\r\n     * @param limit Optional limit\r\n     */\r\n    EdsClient.prototype.getLatestAssessments = function (limit) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = this.privatizingCacheBust();\r\n                        if (!isNaN(limit))\r\n                            query.Count = limit;\r\n                        return [4 /*yield*/, this.http.get(\"studentassessments\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.assessments];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve studyplans for current logged-in user\r\n     */\r\n    EdsClient.prototype.getStudentGoals = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentgoals\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentGoals];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getStudentFutureAbilities = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentFutureAbilities\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentFutureAbilities];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getTeacherTutorStudents = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"teachertutorstudents\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.students];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTuitionGroups()\r\n     *\r\n     * Return tuitiongroups for school\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param courseCode - Skolverkets code for course\r\n     */\r\n    EdsClient.prototype.getSchoolTuitionGroups = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTuitionGroups\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTuitionGroups];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getTuitionGroupStudents()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param tuitionGroupName - tuition gruop name in EDS\r\n     */\r\n    EdsClient.prototype.getTuitionGroupStudents = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"TuitionGroupStudents\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.tuitionGroupStudents];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTeachers()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     */\r\n    EdsClient.prototype.getSchoolTeachers = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTeachers\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTeachers];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // we assume that the EDS will return the current academic year dates determined by the current date\r\n    EdsClient.prototype.getAcademicYearTerms = function (schoolLocale, date) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var holidays, firstTermMoment, secondTermMoment, startFirstTermDate, startSecondTermDate, endFirstTermDate, endSecondTermDate, firstTerm, secondTerm;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                // mock data\r\n                switch (schoolLocale) {\r\n                    case 'en_sin':\r\n                        return [2 /*return*/, mockJsonFile.SouthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'en_nin':\r\n                        return [2 /*return*/, mockJsonFile.NorthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'sv':\r\n                        {\r\n                            holidays = [];\r\n                            firstTermMoment = getTermStarEndDate(date, true);\r\n                            secondTermMoment = getTermStarEndDate(date, false);\r\n                            startFirstTermDate = firstTermMoment[0];\r\n                            startSecondTermDate = secondTermMoment[0];\r\n                            endFirstTermDate = firstTermMoment[1];\r\n                            endSecondTermDate = secondTermMoment[1];\r\n                            firstTerm = { startDate: new Date(startFirstTermDate.year(), startFirstTermDate.month(), startFirstTermDate.date()).toDateString(), endDate: new Date(startFirstTermDate.year(), endFirstTermDate.month(), endFirstTermDate.date()).toDateString() };\r\n                            secondTerm = { startDate: new Date(startSecondTermDate.year(), startSecondTermDate.month(), startSecondTermDate.date()).toDateString(), endDate: new Date(startSecondTermDate.year(), endSecondTermDate.month(), endSecondTermDate.date()).toDateString() };\r\n                            return [2 /*return*/, { firstTerm: firstTerm, secondTerm: secondTerm, holidays: holidays }];\r\n                        }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return EdsClient;\r\n}());\r\nexport { EdsClient };\r\nvar EDSPeriod = /** @class */ (function () {\r\n    function EDSPeriod(periodStringOrSchoolTerm) {\r\n        if (typeof periodStringOrSchoolTerm === 'string') {\r\n            this.period = periodStringOrSchoolTerm;\r\n            this.term = this.period.startsWith('HT') ? 'AT' : 'ST';\r\n            this.year = parseInt(this.period.substr(2));\r\n            if (isNaN(this.year))\r\n                throw new Error(\"Invalid period: \" + this.period);\r\n        }\r\n        else {\r\n            var schoolTerm = new SchoolTerm(periodStringOrSchoolTerm);\r\n            this.period = (schoolTerm.term === 'AT' ? \"HT\" : \"VT\") + schoolTerm.year;\r\n            this.term = schoolTerm.term;\r\n            this.year = schoolTerm.year;\r\n        }\r\n    }\r\n    Object.defineProperty(EDSPeriod.prototype, \"schoolTerm\", {\r\n        get: function () {\r\n            return new SchoolTerm({\r\n                academicYear: this.term === 'AT' ?\r\n                    this.year + \"/\" + (this.year + 1) :\r\n                    this.year - 1 + \"/\" + this.year,\r\n                term: this.term\r\n            });\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    EDSPeriod.prototype.toString = function () {\r\n        return this.period;\r\n    };\r\n    EDSPeriod.prototype.valueOf = function () {\r\n        return this.year + \":\" + (this.term === 'ST' ? \"1\" : \"2\");\r\n    };\r\n    return EDSPeriod;\r\n}());\r\nexport { EDSPeriod };\r\nexport function parseJsonDate_old(jsonDateStr) {\r\n    var date = dateTimeReviver(\"\", jsonDateStr);\r\n    if (!(date instanceof Date))\r\n        throw new Error(\"Invalid JSON date string: \" + jsonDateStr);\r\n    return date;\r\n}\r\nfunction avoidSimultanousCalls(method) {\r\n    var ongoingPromises = {};\r\n    return function () {\r\n        var argsJson = JSON.stringify([].slice.call(arguments));\r\n        if (!ongoingPromises[argsJson]) {\r\n            ongoingPromises[argsJson] = method.apply(this, arguments).then(function (result) {\r\n                delete ongoingPromises[argsJson];\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromises[argsJson];\r\n    };\r\n}\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar GoalProgress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoalProgress, _super);\r\n    function GoalProgress() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.createProgress = function () {\r\n            var _a = _this.props, numberOfTasks = _a.numberOfTasks, completedNumberOfTasks = _a.completedNumberOfTasks, maximumTasksDisplayed = _a.maximumTasksDisplayed, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n            var progress = [];\r\n            if (numberOfTasks > maximumTasksDisplayed) {\r\n                return React.createElement(\"div\", { className: \"progress-overview\" },\r\n                    \" \",\r\n                    completedNumberOfTasks,\r\n                    \" / \",\r\n                    numberOfTasks,\r\n                    \" \");\r\n            }\r\n            for (var taskNo = 1; taskNo <= numberOfTasks; taskNo++) {\r\n                progress.push(React.createElement(\"svg\", { key: taskNo },\r\n                    React.createElement(\"circle\", { className: \"circle-chart-background\", fill: taskNo > completedNumberOfTasks ? backgroundColor : progressColor, cx: \"8\", cy: \"8\", r: \"8\" })));\r\n            }\r\n            return progress;\r\n        };\r\n        return _this;\r\n    }\r\n    GoalProgress.prototype.render = function () {\r\n        return React.createElement(\"div\", { className: \"goals-progress\" }, this.createProgress());\r\n    };\r\n    GoalProgress.defaultProps = {\r\n        numberofTasks: 0,\r\n        completedNumberOfTasks: 0,\r\n        maximumTasksDisplayed: 10,\r\n        backgroundColor: \"lightgrey\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return GoalProgress;\r\n}(React.Component));\r\nexport { GoalProgress };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { db, globalId, Schools } from '../../../../globals/db';\r\nimport { withRouter } from 'react-router';\r\nimport { L } from '../../../../utils/utils';\r\nimport { LazyContent } from '../../../utility-components/lazy-content';\r\nimport { computeTagsFromSubjectCodes } from '../../logic/course-instance-tags';\r\nvar _CreateStandardCourse = /** @class */ (function (_super) {\r\n    tslib_1.__extends(_CreateStandardCourse, _super);\r\n    function _CreateStandardCourse(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            courseName: \"\",\r\n            courseType: 'theme-course',\r\n            subject: { subjectName: '', subjectCode: '' }\r\n        };\r\n        return _this;\r\n    }\r\n    _CreateStandardCourse.prototype.createCourse = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, type, name, subject, courseId, _b, officialBranchId, schoolId, courseProperties;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.state, type = _a.courseType, name = _a.courseName, subject = _a.subject;\r\n                        courseId = createUUID();\r\n                        return [4 /*yield*/, Schools.standardSchool.load()];\r\n                    case 1:\r\n                        _b = _c.sent(), officialBranchId = _b.officialBranchId, schoolId = _b.id;\r\n                        db.branches.addRelated(officialBranchId, \"approvedChildren\", {\r\n                            id: createUUID(),\r\n                            name: 'draft',\r\n                            acl: [\r\n                                \"role:USER:R\",\r\n                                \"schoolRole:standard/EMPLOYEE:S\"\r\n                            ],\r\n                            schoolId: schoolId,\r\n                            treeParentId: officialBranchId,\r\n                            tags: [courseId] // Allow following queries:\r\n                            // List all draft for a certain school: {hasEdgesFrom=schoolBranchId&tags=courseId}\r\n                            // Get official draft for a certain school: {hasEdgesFrom=schoolBranchId&name=draft&tags=courseId}\r\n                        });\r\n                        courseProperties = {\r\n                            id: courseId,\r\n                            acl: [\r\n                                'schoolRole:standard/EMPLOYEE:S',\r\n                                'role:USER:R'\r\n                            ],\r\n                            name: name,\r\n                            //description: type === 'step-course' ? \"Stegkurs\" : \"Teamkurs\",\r\n                            tags: type === 'step-course' ?\r\n                                computeTagsFromSubjectCodes([], [subject.subjectCode]) :\r\n                                []\r\n                        };\r\n                        db.global.addRelated(globalId, \"courseInstances\", type === 'step-course' ? tslib_1.__assign({}, courseProperties, { type: type, description: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Stegkurs\"], [\"Stegkurs\"]))), subject: subject }) : tslib_1.__assign({}, courseProperties, { type: type, description: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Temakurs\"], [\"Temakurs\"]))), subjects: [] }));\r\n                        this.setState({\r\n                            courseName: ''\r\n                        });\r\n                        return [4 /*yield*/, db.saveNow()];\r\n                    case 2:\r\n                        _c.sent();\r\n                        this.props.history.push(\"/admin/courses/\" + courseId + \"/settings\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    _CreateStandardCourse.prototype.isValidState = function (giveMessage) {\r\n        var _a = this.state, courseName = _a.courseName, courseType = _a.courseType, subject = _a.subject;\r\n        var rv = courseName && courseType === 'theme-course' || subject.subjectCode;\r\n        if (!rv && giveMessage) {\r\n            if (!courseName)\r\n                return L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Kursens namn m\\u00E5ste fyllas i\"], [\"Kursens namn m\\u00E5ste fyllas i\"])));\r\n            if (!subject.subjectCode)\r\n                return L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"\\u00C4mne m\\u00E5ste v\\u00E4ljas f\\u00F6r stegkurser\"], [\"\\u00C4mne m\\u00E5ste v\\u00E4ljas f\\u00F6r stegkurser\"])));\r\n        }\r\n        return rv;\r\n    };\r\n    _CreateStandardCourse.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, courseName = _a.courseName, courseType = _a.courseType, subject = _a.subject;\r\n        return (React.createElement(\"div\", null,\r\n            React.createElement(\"h2\", null, \"Skapa ny standardkurs\"),\r\n            React.createElement(\"hr\", null),\r\n            React.createElement(\"div\", null,\r\n                \"Namn: \",\r\n                React.createElement(\"input\", { type: \"text\", value: courseName, onChange: function (ev) { return _this.setState({ courseName: ev.target.value }); } })),\r\n            React.createElement(\"br\", null),\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"radio\", name: \"course-type\", checked: courseType === 'step-course', onChange: function (ev) { return ev.target.checked && _this.setState({ courseType: 'step-course' }); } }),\r\n                \" Stegkurs\"),\r\n            React.createElement(\"br\", null),\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"radio\", name: \"course-type\", checked: courseType === 'theme-course', onChange: function (ev) { return ev.target.checked && _this.setState({ courseType: 'theme-course' }); } }),\r\n                \" Temakurs\"),\r\n            React.createElement(\"br\", null),\r\n            courseType === 'step-course' ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"form\", null,\r\n                    React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"])))),\r\n                    React.createElement(LazyContent, null, db.subjects.tags(\"schoolType:primary\").toValue().map(function (subjects) {\r\n                        return React.createElement(\"select\", { value: subject.subjectCode, onChange: function (ev) { return _this.setState({\r\n                                subject: subjects.filter(function (s) { return s.code === ev.target.value; }).map(function (s) { return ({\r\n                                    subjectCode: s.code,\r\n                                    subjectName: s.name\r\n                                }); })[0]\r\n                            }); } },\r\n                            React.createElement(\"option\", { value: \"\" }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"V\\u00E4lj \\u00E4mne\"], [\"V\\u00E4lj \\u00E4mne\"])))),\r\n                            subjects.map(function (subject) { return React.createElement(\"option\", { key: subject.code, value: subject.code }, subject.name); }));\r\n                    })))) : null,\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"button\", { disabled: !this.isValidState(), className: [\"btn\", \"btn-large\", this.isValidState() ? \"\" : \"disabled\"].join(' '), onClick: function () { return _this.isValidState() ?\r\n                        _this.createCourse() : alert(_this.isValidState(true)); } }, \"Skapa\"))));\r\n    };\r\n    return _CreateStandardCourse;\r\n}(React.Component));\r\nexport var CreateStandardCourse = withRouter(_CreateStandardCourse);\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { liveQueryView } from '../../../utility-components/live-query-view';\r\nimport { db } from '../../../../globals/db';\r\nimport { withRouter } from 'react-router';\r\nimport { Link } from 'react-router-dom';\r\nimport { Spinner } from '../../../course-builder/sub-components/spinner';\r\nexport var DeleteStandardCourse = withRouter(liveQueryView(function (_a) {\r\n    var courseId = _a.courseId, history = _a.history;\r\n    return db.courseInstances.ids([courseId]).toValue()\r\n        .combineLatest(db.branches.tags(courseId).idsOnly().map(function (_a) {\r\n        var id = _a.id;\r\n        return id;\r\n    }))\r\n        .combineLatest(db.courseBlocks.tags(courseId).idsOnly().map(function (_a) {\r\n        var id = _a.id;\r\n        return id;\r\n    }))\r\n        .combineLatest(db.courseContents.tags(courseId).idsOnly().map(function (_a) {\r\n        var id = _a.id;\r\n        return id;\r\n    }))\r\n        .combineLatest(db.courseTabs.tags(courseId).idsOnly().map(function (_a) {\r\n        var id = _a.id;\r\n        return id;\r\n    }))\r\n        .combineLatest(db.tasks.tags(courseId).idsOnly().map(function (_a) {\r\n        var id = _a.id;\r\n        return id;\r\n    }))\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), a = _b[0], b = _b[1];\r\n        return ({\r\n            courses: a[0][0][0][0],\r\n            branchIds: a[0][0][0][1],\r\n            courseBlockIds: a[0][0][1],\r\n            courseContentIds: a[0][1],\r\n            courseTabIds: a[1],\r\n            taskIds: b\r\n        });\r\n    })\r\n        .map(function (_a) {\r\n        var courses = _a.courses, branchIds = _a.branchIds, courseBlockIds = _a.courseBlockIds, courseContentIds = _a.courseContentIds, courseTabIds = _a.courseTabIds, taskIds = _a.taskIds;\r\n        if (courses.length === 0)\r\n            return React.createElement(\"div\", null,\r\n                React.createElement(\"p\", null, \"Kursen \\u00E4r nu borttagen\"),\r\n                React.createElement(Link, { className: \"btn btn-large\", to: \"/admin\" }, \"Till adminverktygets startsida\"));\r\n        var course = courses[0];\r\n        return React.createElement(\"div\", { className: [\"entitymeta-\" + course.$meta].join(' ') },\r\n            React.createElement(\"h2\", null,\r\n                \"Bekr\\u00E4fta borttagning av standardkursen \",\r\n                course.name,\r\n                \" \"),\r\n            React.createElement(\"p\", null, \"F\\u00F6ljande relaterade objekt kommer ocks\\u00E5 att tas bort\"),\r\n            React.createElement(\"p\", null,\r\n                \"Tempor\\u00E4ra utkast: \",\r\n                branchIds.length,\r\n                \" st\"),\r\n            React.createElement(\"p\", null,\r\n                \"Kursblock: \",\r\n                courseBlockIds.length,\r\n                \" st\"),\r\n            React.createElement(\"p\", null,\r\n                \"Inneh\\u00E5llsrutor (totalt inklusive skolors egna varianter): \",\r\n                courseContentIds.length,\r\n                \" st\"),\r\n            React.createElement(\"p\", null,\r\n                \"Flikar (totalt inklusive skolors egna varianter): \",\r\n                courseTabIds.length,\r\n                \" st\"),\r\n            React.createElement(\"p\", null,\r\n                \"Uppgifter (totalt inklusive skolors egna varianter): \",\r\n                taskIds.length,\r\n                \" st\"),\r\n            React.createElement(\"a\", { className: \"btn btn-large\", onClick: function () { return history.go(-1); } }, \"Avbryt\"),\r\n            React.createElement(\"div\", { className: \"btn btn-warning btn-large pull-right\", onClick: function () {\r\n                    var _a, _b, _c, _d, _e;\r\n                    // Delete all draft ids.\r\n                    (_a = db.branches).delete.apply(_a, tslib_1.__spread(branchIds));\r\n                    // Delete all descendant ids:\r\n                    (_b = db.courseBlocks).delete.apply(_b, tslib_1.__spread(courseBlockIds));\r\n                    (_c = db.courseContents).delete.apply(_c, tslib_1.__spread(courseContentIds));\r\n                    (_d = db.courseTabs).delete.apply(_d, tslib_1.__spread(courseTabIds));\r\n                    (_e = db.tasks).delete.apply(_e, tslib_1.__spread(taskIds));\r\n                    // Delete the course itself\r\n                    db.courseInstances.delete(course.id);\r\n                } }, \"Bekr\\u00E4fta borttagning av kurs\"));\r\n    });\r\n}, {\r\n    spinner: React.createElement(\"p\", null,\r\n        \"H\\u00E4mtar relaterade objekt... \",\r\n        React.createElement(Spinner, null))\r\n}));\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { KnowledgeMatrix } from '../../../course-builder/sub-components/knowledge-matrix';\r\nimport { LazyContent } from '../../../utility-components/lazy-content';\r\nimport { getCourseCodesFromTags } from '../../logic/get-course-codes-from-tags';\r\nimport { L } from '../../../../utils/utils';\r\nimport { getStandardCoursesWithOrderedRequirements } from '../../logic/get-standard-courses-with-ordered-requirements';\r\nimport { OpenCloseBox } from '../../../utility-components/open-close-box';\r\nimport { SelectRelatedDocs } from '../../../course-builder/sub-components/select-related-docs';\r\nimport { liveQueryView } from '../../../utility-components/live-query-view';\r\nimport { getIdsNotCoveredByReqReferencingDocs } from '../../../course-builder/courses/business-logic';\r\nexport var CourseBlockRequirements = liveQueryView(function (_a) {\r\n    var _b;\r\n    var repo = _a.repo, course = _a.course, block = _a.block;\r\n    var courseCodes = getCourseCodesFromTags(block.tags);\r\n    var courseCodeTags = courseCodes.map(function (code) { return \"course:\" + code; });\r\n    return getStandardCoursesWithOrderedRequirements(courseCodes)\r\n        .combineLatest((_b = repo.courseBlocks\r\n        .hasEdgesFrom([course.id])) // Same parent give me sibling blocks!\r\n    .tags.apply(_b, tslib_1.__spread(courseCodeTags)).include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")\r\n        .includeIdsOnly()) // So we can detect non-covered requirements\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), courseTemplates = _b[0], siblingBlocks = _b[1];\r\n        var uncoveredIds = getIdsNotCoveredByReqReferencingDocs(courseTemplates, siblingBlocks);\r\n        if (courseTemplates.length === 0)\r\n            return React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Blocket \\u00E4r inte kopplad till n\\u00E5gon \\u00E5rskurs\"], [\"Blocket \\u00E4r inte kopplad till n\\u00E5gon \\u00E5rskurs\"]))));\r\n        return React.createElement(\"div\", null, courseTemplates.map(function (_a) {\r\n            var id = _a.id, name = _a.name, abilities = _a.abilities, centralContent = _a.centralContent, knowledgeRequirements = _a.knowledgeRequirements;\r\n            return React.createElement(\"div\", { key: id },\r\n                courseTemplates.length === 1 ? undefined : React.createElement(\"h1\", null, name),\r\n                React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"V\\u00E4lj blockets kunskapskrav\"], [\"V\\u00E4lj blockets kunskapskrav\"])))) },\r\n                    React.createElement(\"p\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Markera de kunskapskrav som blocket ska t\\u00E4cka.\"], [\"Markera de kunskapskrav som blocket ska t\\u00E4cka.\"])))),\r\n                    React.createElement(LazyContent, null, repo[\"knowledge-requirements\"].hasEdgesFrom([block.id]).idsOnly().toValue().map(function (blockKrs) {\r\n                        return React.createElement(KnowledgeMatrix, { knowledgeRequirements: knowledgeRequirements, markedIds: blockKrs.map(function (_a) {\r\n                                var id = _a.id;\r\n                                return id;\r\n                            }), idsToMarkNotOk: uncoveredIds, markMode: true, onMarkChanged: function (markedId, isMarked) {\r\n                                // Remove invalid knowledge requirements (those that are not part of the standard course)\r\n                                // Can happen after changing school year / course or subject.\r\n                                var invalidKrs = blockKrs.filter(function (kr) { return !knowledgeRequirements.some(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return kr.id === id;\r\n                                }); });\r\n                                invalidKrs.forEach(function (invalidKr) {\r\n                                    repo.courseBlocks.removeRelated(block.id, \"knowledgeRequirements\", invalidKr);\r\n                                });\r\n                                var markedDoc = knowledgeRequirements.filter(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id === markedId;\r\n                                })[0];\r\n                                if (isMarked) {\r\n                                    repo.courseBlocks.addRelated(block.id, \"knowledgeRequirements\", markedDoc);\r\n                                }\r\n                                else {\r\n                                    repo.courseBlocks.removeRelated(block.id, \"knowledgeRequirements\", markedDoc);\r\n                                }\r\n                            } });\r\n                    }))),\r\n                React.createElement(LazyContent, null, repo.abilities.hasEdgesFrom([block.id]).idsOnly().toValue().map(function (blockAbilities) {\r\n                    return React.createElement(SelectRelatedDocs, { options: abilities, title: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"V\\u00E4lj blockets f\\u00F6rm\\u00E5gor\"], [\"V\\u00E4lj blockets f\\u00F6rm\\u00E5gor\"]))), markedIds: blockAbilities.map(function (_a) {\r\n                            var id = _a.id;\r\n                            return id;\r\n                        }), uncoveredIds: uncoveredIds, markMode: true, \r\n                        //migratedIds={task && task.migratedTexts && task.migratedTexts.abilities}\r\n                        onMarkChanged: function (markedId, isMarked) {\r\n                            // Remove invalid abilities (those that are not part of the standard course)\r\n                            // Can happen after changing school year / course or subject.\r\n                            var invalidAbilities = blockAbilities.filter(function (a) { return !abilities.some(function (_a) {\r\n                                var id = _a.id;\r\n                                return a.id === id;\r\n                            }); });\r\n                            invalidAbilities.forEach(function (invalidAbility) {\r\n                                repo.courseBlocks.removeRelated(block.id, \"abilities\", invalidAbility);\r\n                            });\r\n                            var markedDoc = abilities.filter(function (_a) {\r\n                                var id = _a.id;\r\n                                return id === markedId;\r\n                            })[0];\r\n                            if (isMarked) {\r\n                                repo.courseBlocks.addRelated(block.id, \"abilities\", markedDoc);\r\n                            }\r\n                            else {\r\n                                repo.courseBlocks.removeRelated(block.id, \"abilities\", markedDoc);\r\n                            }\r\n                        } });\r\n                })),\r\n                React.createElement(LazyContent, null, repo[\"central-content\"].hasEdgesFrom([block.id]).idsOnly().toValue().map(function (blockCCs) {\r\n                    return React.createElement(SelectRelatedDocs, { options: centralContent, title: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"V\\u00E4lj blockets centrala inneh\\u00E5ll\"], [\"V\\u00E4lj blockets centrala inneh\\u00E5ll\"]))), markedIds: blockCCs.map(function (cc) { return cc.id; }), uncoveredIds: uncoveredIds, markMode: true, \r\n                        //migratedIds={task && task.migratedTexts && task.migratedTexts.centralContent}\r\n                        onMarkChanged: function (markedId, isMarked) {\r\n                            // Remove invalid central contents (those that are not part of the standard course)\r\n                            // Can happen after changing school year / course or subject.\r\n                            var invalidCentralContents = blockCCs.filter(function (cc) { return !centralContent.some(function (_a) {\r\n                                var id = _a.id;\r\n                                return cc.id === id;\r\n                            }); });\r\n                            invalidCentralContents.forEach(function (invalidCC) {\r\n                                repo.courseBlocks.removeRelated(block.id, \"centralContent\", invalidCC);\r\n                            });\r\n                            var markedDoc = centralContent.filter(function (_a) {\r\n                                var id = _a.id;\r\n                                return id === markedId;\r\n                            })[0];\r\n                            if (isMarked) {\r\n                                repo.courseBlocks.addRelated(block.id, \"centralContent\", markedDoc);\r\n                            }\r\n                            else {\r\n                                repo.courseBlocks.removeRelated(block.id, \"centralContent\", markedDoc);\r\n                            }\r\n                        } });\r\n                })));\r\n        }));\r\n    });\r\n});\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { compareProp, L } from '../../../../utils/utils';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { RemoveItem } from '../../../course-builder/sub-components/remove-item';\r\nimport { getSchoolYears, computeTagsFromSchoolYears } from '../../logic/course-instance-tags';\r\nimport { CourseBlockRequirements } from './edit-course-block-requirements';\r\nexport var EditStandardCourseBlocks = function (_a) {\r\n    var repo = _a.repo, course = _a.course;\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kursblock\"], [\"Kursblock\"])))),\r\n        course.blocks.sort(compareProp(\"blockNo\")).map(function (block, idx) {\r\n            return React.createElement(CourseBlockSettings, { key: block.id, block: block, course: course, repo: repo, isLastBlock: idx === course.blocks.length - 1 });\r\n        }),\r\n        React.createElement(\"button\", { className: \"btn\", onClick: function () { return addCourseBlock(repo, course); } },\r\n            React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n            \" \", L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till block\"], [\"L\\u00E4gg till block\"])))),\r\n        React.createElement(\"br\", null));\r\n};\r\nexport var CourseBlockSettings = function (_a) {\r\n    var block = _a.block, course = _a.course, repo = _a.repo, isLastBlock = _a.isLastBlock;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"div\", { className: \"ked_boxed\", style: { position: \"relative\" } },\r\n            React.createElement(\"h4\", null,\r\n                \"Block \",\r\n                block.blockNo), L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Steg\"], [\"Steg\"]))),\r\n            \" \",\r\n            React.createElement(\"div\", { className: \"btn-group\" }, block.stepNumbers.map(function (stepNo) {\r\n                return React.createElement(\"a\", { key: stepNo, className: \"btn btn-small step-button\" }, stepNo);\r\n            })),\r\n            React.createElement(\"form\", null,\r\n                React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs\"], [\"\\u00C5rskurs\"])))),\r\n                React.createElement(\"select\", { value: getSchoolYears(block.tags)[0] || \"\", onChange: function (ev) { return repo.courseBlocks.update(block, {\r\n                        tags: computeTagsFromSchoolYears(block.tags, [ev.target.value].filter(function (x) { return !!x; }))\r\n                    }); } },\r\n                    React.createElement(\"option\", { value: \"\" }, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"V\\u00E4lj \\u00E5rskurser\"], [\"V\\u00E4lj \\u00E5rskurser\"])))),\r\n                    React.createElement(\"option\", { value: \"1-3\" }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 1-3\"], [\"\\u00C5rskurs 1-3\"])))),\r\n                    React.createElement(\"option\", { value: \"4-6\" }, L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 4-6\"], [\"\\u00C5rskurs 4-6\"])))),\r\n                    React.createElement(\"option\", { value: \"7-9\" }, L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 7-9\"], [\"\\u00C5rskurs 7-9\"])))))),\r\n            React.createElement(\"br\", null),\r\n            getSchoolYears(block.tags).length > 0 ?\r\n                React.createElement(CourseBlockRequirements, { block: block, course: course, repo: repo }) :\r\n                undefined,\r\n            isLastBlock ? React.createElement(RemoveItem, { title: \"Ta bort blocket\", style: { display: 'inline-block', position: \"absolute\", top: 0, right: 0 }, onClick: function () { return confirm(L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"Ta bort blocket?\"], [\"Ta bort blocket?\"])))) &&\r\n                    repo.courseInstances.removeRelated(course.id, \"blocks\", block); } })\r\n                : null),\r\n        React.createElement(\"hr\", null));\r\n};\r\nfunction addCourseBlock(repo, course) {\r\n    var lastBlock = course.blocks.sort(compareProp(\"blockNo\")).slice().pop();\r\n    var blockNo = lastBlock ? lastBlock.blockNo + 1 : 1;\r\n    var firstStepNo = lastBlock ?\r\n        lastBlock.stepNumbers[lastBlock.stepNumbers.length - 1] + 1 :\r\n        1;\r\n    var newBlock = {\r\n        id: createUUID(),\r\n        acl: [\r\n            'schoolRole:standard/EMPLOYEE:S',\r\n            'role:USER:R'\r\n        ],\r\n        blockNo: blockNo,\r\n        locked: true,\r\n        name: \"Block \" + blockNo,\r\n        tags: tslib_1.__spread([course.id], course.tags.filter(function (tag) { return tag.startsWith(\"course:\") || tag.startsWith(\"sub:\"); })),\r\n        stepNumbers: [firstStepNo, firstStepNo + 1, firstStepNo + 2, firstStepNo + 3, firstStepNo + 4]\r\n    };\r\n    repo.courseInstances.addRelated(course.id, \"blocks\", newBlock);\r\n    newBlock.stepNumbers.forEach(function (stepNo) {\r\n        var introductionTab = {\r\n            id: createUUID(),\r\n            type: 'step-course-tab',\r\n            tabClass: 'intro-tab',\r\n            tabTitle: L(templateObject_10 || (templateObject_10 = tslib_1.__makeTemplateObject([\"Introduktion\"], [\"Introduktion\"]))),\r\n            name: L(templateObject_11 || (templateObject_11 = tslib_1.__makeTemplateObject([\"Introduktion\"], [\"Introduktion\"]))),\r\n            locked: true,\r\n            acl: [\r\n                'schoolRole:standard/EMPLOYEE:S',\r\n                'role:USER:R'\r\n            ],\r\n            stepNo: stepNo,\r\n            order: 0,\r\n            tags: tslib_1.__spread([course.id], course.tags.filter(function (tag) { return tag.startsWith(\"course:\") || tag.startsWith(\"sub:\"); }))\r\n        };\r\n        repo.courseBlocks.addRelated(newBlock.id, \"tabs\", introductionTab);\r\n    });\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10, templateObject_11;\r\n","var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { db, CourseInstances, Schools } from '../../../../globals/db';\r\nimport { TextInput } from '../../../utility-components/form-field-text-input';\r\nimport { TextAreaFormField } from '../../../utility-components/form-field-textarea';\r\nimport { FormField } from '../../../utility-components/form-field';\r\nimport { L } from '../../../../utils/utils';\r\nimport { Link, withRouter } from 'react-router-dom';\r\nimport { liveQueryView } from '../../../utility-components/live-query-view';\r\nimport { publishCourse } from '../../logic/publish-course';\r\nimport { Multiselect } from '../../../utility-components/multiselect';\r\nimport { Checklist } from '../../../utility-components/checklist';\r\nimport { getSubjectCodes, computeTagsFromSubjectCodes, getSchoolYears, computeTagsFromSchoolYears, computeTagsFromActiveState } from '../../logic/course-instance-tags';\r\nimport { EditStandardCourseBlocks } from './edit-standard-course-blocks';\r\nimport cfg from '../../../../globals/KED.cfg';\r\nimport { preserveImpersonationQuery } from '../../../../access-control';\r\nexport var EditStandardCourse = withRouter(liveQueryView(function (_a) {\r\n    var courseId = _a.courseId, history = _a.history;\r\n    return CourseInstances.getOrCreateBranchId(Schools.standardSchool, courseId)\r\n        .map(function (branchId) { return db.branch(branchId); })\r\n        .switchMap(function (branch) {\r\n        return branch.courseInstances.include(\"blocks\").id(courseId).map(function (course) { return React.createElement(React.Fragment, null,\r\n            React.createElement(TextInput, { autoFocus: true, label: \"Namn\", id: \"CourseInstance:name\", placeholder: \"\", value: course.name, onChange: function (name) { return branch.courseInstances.update(course, { name: name }); } }),\r\n            React.createElement(TextAreaFormField, { label: \"Beskrivning\", id: \"CourseInstance:description\", rows: 7, placeholder: \"\", value: course.description, onChange: function (description) {\r\n                    branch.courseInstances.update(course, { description: description });\r\n                } }),\r\n            React.createElement(FormField, { label: \"Typ\", id: \"CourseInstance:type\" },\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { disabled: true, type: \"radio\", name: \"course-type\", checked: course.type === 'step-course', id: \"CourseInstance:type\", onChange: function (ev) { return ev.target.checked && branch.courseInstances.update(course, { type: 'step-course' }); } }),\r\n                        \" Stegkurs\")),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                        React.createElement(\"input\", { disabled: true, type: \"radio\", name: \"course-type\", checked: course.type === 'theme-course', id: \"CourseInstance:type\", onChange: function (ev) { return ev.target.checked && branch.courseInstances.update(course, { type: 'theme-course' }); } }),\r\n                        \" Temakurs\"))),\r\n            course.type === 'step-course' ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(FormField, { label: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"]))), id: \"CourseInstance:subject\" },\r\n                    React.createElement(\"p\", { id: \"CourseInstance:subject\" }, course.subject.subjectName))) : null,\r\n            React.createElement(\"br\", null),\r\n            React.createElement(\"form\", null,\r\n                React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4ndringspolicy\"], [\"\\u00C4ndringspolicy\"])))),\r\n                React.createElement(Checklist, { available: [\r\n                        { name: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Till\\u00E5t skolor skapa egna flikar\"], [\"Till\\u00E5t skolor skapa egna flikar\"]))), key: \"allowAddTabs\" },\r\n                        { name: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Till\\u00E5t skolor d\\u00F6lja standardflikar\"], [\"Till\\u00E5t skolor d\\u00F6lja standardflikar\"]))), key: \"allowRemoveTabs\" },\r\n                        { name: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Till\\u00E5t skolor \\u00E4ndra ordningen mellan standardflikar\"], [\"Till\\u00E5t skolor \\u00E4ndra ordningen mellan standardflikar\"]))), key: \"allowReorderTabs\" },\r\n                    ], selected: [\r\n                        course.allowAddTabs && \"allowAddTabs\",\r\n                        course.allowRemoveTabs && \"allowRemoveTabs\",\r\n                        course.allowReorderTabs && \"allowReorderTabs\"\r\n                    ].filter(function (x) { return !!x; }), onChange: function (selectedPolicy) { return branch.courseInstances.update(course, {\r\n                        allowAddTabs: selectedPolicy.includes(\"allowAddTabs\"),\r\n                        allowRemoveTabs: selectedPolicy.includes(\"allowRemoveTabs\"),\r\n                        allowReorderTabs: selectedPolicy.includes(\"allowReorderTabs\"),\r\n                    }); } })),\r\n            course.type === 'step-course' ? React.createElement(React.Fragment, null, getSubjectCodes(course.tags).length > 0 ? React.createElement(EditStandardCourseBlocks, { repo: branch, course: course }) : undefined) : undefined,\r\n            course.type === 'theme-course' ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"form\", null,\r\n                    React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Kopplade \\u00E4mnen\"], [\"Kopplade \\u00E4mnen\"])))),\r\n                    React.createElement(Multiselect, { selected: (course.subjects || []).map(function (_a) {\r\n                            var name = _a.name, code = _a.code;\r\n                            return ({ name: name, key: code });\r\n                        }), getOptions: function () { return db.subjects.tags('schoolType:primary').map(function (s) { return ({ name: s.name, key: s.code }); }).toValue().load(); }, onChange: function (selectedOptions) { return branch.courseInstances.update(course, {\r\n                            tags: computeTagsFromSubjectCodes(course.tags, selectedOptions.map(function (o) { return o.key; })),\r\n                            subjects: selectedOptions.map(function (option) { return ({ name: option.name, code: option.key }); })\r\n                        }); } })),\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"form\", null,\r\n                    React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"\\u00C5rskurser som ska ing\\u00E5\"], [\"\\u00C5rskurser som ska ing\\u00E5\"])))),\r\n                    React.createElement(Checklist, { available: [\r\n                            { name: L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 1-3\"], [\"\\u00C5rskurs 1-3\"]))), key: \"1-3\" },\r\n                            { name: L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 4-6\"], [\"\\u00C5rskurs 4-6\"]))), key: \"4-6\" },\r\n                            { name: L(templateObject_10 || (templateObject_10 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs 7-9\"], [\"\\u00C5rskurs 7-9\"]))), key: \"7-9\" }\r\n                        ], selected: getSchoolYears(course.tags), onChange: function (selectedSchoolYears) { return branch.courseInstances.update(course, {\r\n                            tags: computeTagsFromSchoolYears(course.tags, selectedSchoolYears)\r\n                        }); } }))) : undefined,\r\n            React.createElement(\"br\", null),\r\n            course.tags.includes('active') ?\r\n                React.createElement(\"div\", { className: \"btn btn-large pull-right\", onClick: function () {\r\n                        var newTags = computeTagsFromActiveState(course.tags, false);\r\n                        branch.courseInstances.update(course, { tags: newTags });\r\n                    } }, \"Inaktivera\") :\r\n                React.createElement(\"div\", { className: \"btn btn-large pull-right\", onClick: function () {\r\n                        var newTags = computeTagsFromActiveState(course.tags, true);\r\n                        branch.courseInstances.update(course, { tags: newTags });\r\n                    } }, \"Aktivera\"),\r\n            React.createElement(Link, { className: \"btn btn-warning btn-large pull-right\", to: \"/admin/courses/\" + courseId + \"/confirm-delete\" }, L(templateObject_11 || (templateObject_11 = tslib_1.__makeTemplateObject([\"Radera ...\"], [\"Radera ...\"])))),\r\n            React.createElement(\"div\", { className: \"btn btn-large btn-warning\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                    return tslib_1.__generator(this, function (_a) {\r\n                        switch (_a.label) {\r\n                            case 0:\r\n                                publishCourse({ school: \"standard\", draftRepo: branch, course: course });\r\n                                return [4 /*yield*/, db.saveNow()];\r\n                            case 1:\r\n                                _a.sent();\r\n                                location.href = preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL + \"#/standard/courses/\" + courseId, {});\r\n                                return [2 /*return*/];\r\n                        }\r\n                    });\r\n                }); } }, \"Publicera\")); });\r\n    });\r\n}));\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10, templateObject_11;\r\n/*async function deleteCourse(course: CourseInstance) {\r\n  try {\r\n    // Get course's drafts on all schools\r\n    // Get ids of all related entities (search by entities tags with course id)\r\n    const [\r\n      draftBranchIds,\r\n      courseBlockIds,\r\n      courseContentIds,\r\n      couresTabsIds,\r\n      tasksIds] = await Promise.all([\r\n        db.branches.tags(course.id).load(),\r\n        db.courseBlocks.tags(course.id).load(),\r\n        db.courseContents.tags(course.id).load(),\r\n        db.courseTabs.tags(course.id).load(),\r\n        db.tasks.tags(course.id).load()\r\n      ]);\r\n\r\n    // Delete all draft ids.\r\n    db.branches.delete(...draftBranchIds);\r\n    // Delete all descendant ids:\r\n    db.courseBlocks.delete(...courseBlockIds);\r\n    db.courseContents.delete(...courseContentIds);\r\n    db.courseTabs.delete(...couresTabsIds);\r\n    db.tasks.delete(...tasksIds);\r\n\r\n    // Delete the course itself\r\n    db.courseInstances.delete(course.id);\r\n\r\n  } catch (error) {\r\n    showError(error);\r\n  }\r\n}*/\r\n","import * as React from 'react';\r\nimport { HashRouter as Router, Route } from 'react-router-dom';\r\nimport { ErrorSuccessFeedback } from '../../../utils/error-success-feedback';\r\nimport { ROUTES, TABS_ARRAY } from './routes';\r\nimport { Banner } from '../common/banner';\r\nimport { LoadingIndicator } from '../../utility-components/loading-indicator';\r\nexport var SubjectPlannerAdminApp = function () {\r\n    return React.createElement(Router, null,\r\n        React.createElement(React.Fragment, null,\r\n            ROUTES.map(function (_a, index) {\r\n                var exact = _a.exact, path = _a.path, tabId = _a.tabId, title = _a.title, content = _a.content;\r\n                return React.createElement(Route, { key: index, path: path, exact: exact, component: function (routeProps) { return React.createElement(React.Fragment, null,\r\n                        React.createElement(Banner, { activeTab: tabId || \"$\", tabs: TABS_ARRAY, title: title || \"\", backgroundImage: \"https://ks.kunskapsporten.se/images/18.6323bc4d15f4831f9c82dedf/theme.jpg\" }),\r\n                        content(routeProps)); } });\r\n            }),\r\n            React.createElement(ErrorSuccessFeedback, null),\r\n            React.createElement(LoadingIndicator, null)));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { CreateStandardCourse } from './courses/create-standard-course';\r\nimport { TwoColumnsPage } from '../common/two-columns-page';\r\nimport { StandardCourseInstanceList } from '../common/standard-course-instance-list';\r\nimport { Redirect } from 'react-router-dom';\r\nimport env from '../../../globals/KED.env';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { EditStandardCourse } from './courses/edit-standard-course';\r\nimport { DeleteStandardCourse } from './courses/delete-standard-course';\r\nimport { SubjectsInner } from '../../course-builder/subjects/subjects-inner';\r\nimport { ShowSubjectInner } from '../../course-builder/subjects/show-subject-inner';\r\nimport { L } from '../../../utils/utils';\r\nimport { SchoolsWithoutBanner } from '../../course-builder/schools';\r\nimport { EditSchoolNoBanner } from '../../course-builder/schools/edit-school';\r\nimport { isTeacherAtSchool, preserveImpersonationQuery } from '../../../access-control';\r\nvar RedirectFromRoot = function () {\r\n    var _a = env.currentUser, roles = _a.roles, school = _a.school;\r\n    if (roles.includes(\"ADMIN\") || isTeacherAtSchool(env.currentUser, \"standard\"))\r\n        return React.createElement(Redirect, { to: \"/admin\" });\r\n    location.href = preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL, {});\r\n    return React.createElement(\"div\", null);\r\n    /*return roles.includes(\"ADMIN\") ?\r\n      <Redirect to=\"/admin\" /> :\r\n    //roles.includes(\"EMPLOYEE\") ?\r\n    //<Redirect to={`/${school}/courses/edit`} /> :\r\n      <Redirect to={`/admin/courses`} />;*/\r\n};\r\nexport var TABS = {\r\n    $: ['/admin', React.createElement(React.Fragment, null, \"Start\")],\r\n    //courses: ['/admin/courses', <>Kurser</>],\r\n    schools: [\"/schools\", React.createElement(React.Fragment, null, \"Skolor\")],\r\n    import: ['/admin/import', React.createElement(React.Fragment, null, \"Import\")],\r\n};\r\nexport var ROUTES = [\r\n    {\r\n        path: \"/\",\r\n        exact: true,\r\n        content: function () { return React.createElement(RedirectFromRoot, null); }\r\n    },\r\n    {\r\n        path: \"/admin\",\r\n        exact: true,\r\n        tabId: \"$\",\r\n        title: \"Ämnesplaneraren Admin\",\r\n        content: function () { return React.createElement(Redirect, { to: \"/admin/courses/create\" }); }\r\n    },\r\n    {\r\n        path: \"/admin/courses/create\",\r\n        exact: true,\r\n        tabId: \"$\",\r\n        title: \"Skapa standardkurs\",\r\n        content: function () {\r\n            return React.createElement(TwoColumnsPage, { left: React.createElement(CreateStandardCourse, null), right: React.createElement(StandardCourseInstanceList, null), rightWidth: 5 });\r\n        }\r\n    }, {\r\n        path: \"/admin/courses/:courseId/settings\",\r\n        exact: true,\r\n        tabId: \"$\",\r\n        title: \"Ämnesplaneraren Admin\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(TwoColumnsPage, { left: React.createElement(EditStandardCourse, { courseId: match.params.courseId }), right: React.createElement(StandardCourseInstanceList, null), rightWidth: 5 });\r\n        }\r\n    }, {\r\n        path: \"/admin/courses/:courseId/confirm-delete\",\r\n        exact: true,\r\n        tabId: \"$\",\r\n        title: \"Bekräfta radering av standardkurs\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(TwoColumnsPage, { left: React.createElement(DeleteStandardCourse, { courseId: match.params.courseId }), right: React.createElement(StandardCourseInstanceList, null), rightWidth: 5 });\r\n        }\r\n    }, {\r\n        path: \"/admin/import\",\r\n        exact: true,\r\n        tabId: 'import',\r\n        title: \"Import från Skolverket\",\r\n        content: function () { return React.createElement(SubjectsInner, { linkPrefix: \"/admin/import/\" }); }\r\n    }, {\r\n        path: \"/admin/import/:subjectId\",\r\n        exact: false,\r\n        tabId: \"import\",\r\n        title: \"Import från skolverket\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(ShowSubjectInner, { id: match.params.subjectId });\r\n        }\r\n    }, {\r\n        path: \"/schools\",\r\n        exact: true,\r\n        tabId: \"schools\",\r\n        title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolor\"], [\"Skolor\"]))),\r\n        content: function () { return React.createElement(SchoolsWithoutBanner, { viewCourseUrl: cfg.KED_SUBJECT_PLANNER_URL }); }\r\n    }, {\r\n        path: \"/schools/:schoolId/edit\",\r\n        tabId: \"schools\",\r\n        title: \"Skolor\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(EditSchoolNoBanner, { title: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Redigera skola\"], [\"Redigera skola\"]))), id: match.params.schoolId });\r\n        }\r\n    }, {\r\n        path: \"/schools/new/gymnasium\",\r\n        tabId: \"schools\",\r\n        title: \"Skolor\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(EditSchoolNoBanner, { title: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till skola\"], [\"L\\u00E4gg till skola\"]))), type: \"gymnasium\" });\r\n        }\r\n    }, {\r\n        path: \"/schools/new/primary\",\r\n        tabId: \"schools\",\r\n        title: \"Skolor\",\r\n        content: function (_a) {\r\n            var match = _a.match;\r\n            return React.createElement(EditSchoolNoBanner, { title: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till skola\"], [\"L\\u00E4gg till skola\"]))), type: \"primary\" });\r\n        }\r\n    }\r\n];\r\nexport var TABS_ARRAY = Object.keys(TABS).map(function (key) { return ({\r\n    key: key,\r\n    name: TABS[key][1],\r\n    link: TABS[key][0]\r\n}); });\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { EllipsisLoader } from '../../course-builder/sub-components/ellipsis-loader';\r\nimport { preserveImpersonationQuery } from '../../../access-control';\r\nimport { L } from '../../../utils/utils';\r\nvar LazyBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LazyBanner, _super);\r\n    function LazyBanner() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.dragState = new Emitter({ tabBeingDragged: '', tabBeingHovered: '', insertBefore: false, originClientX: -1 });\r\n        return _this;\r\n    }\r\n    LazyBanner.prototype.render = function () {\r\n        var _this = this;\r\n        var lazyProps = this.props.lazyProps;\r\n        return (React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\", style: { overflow: \"visible\" } },\r\n            React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n                React.createElement(\"div\", { className: \"sv-script-portlet sv-portlet sv-skip-spacer\" },\r\n                    React.createElement(LazyContent, { noError: true }, lazyProps.map(function (_a) {\r\n                        var backgroundImage = _a.backgroundImage;\r\n                        return backgroundImage && React.createElement(\"style\", null, \"\\n              .pageHeader {\\n                background-image: url('\" + backgroundImage + \"') !important;\\n              }\\n            \");\r\n                    })),\r\n                    React.createElement(\"div\", { className: \"pageHeader\" },\r\n                        React.createElement(\"a\", null,\r\n                            React.createElement(\"h1\", null,\r\n                                React.createElement(LazyContent, { noError: true }, lazyProps.map(function (props) { return React.createElement(React.Fragment, null, props.title); })))),\r\n                        React.createElement(LazyContent, { noError: true }, lazyProps.map(function (_a) {\r\n                            var cornerBox = _a.cornerBox;\r\n                            return cornerBox &&\r\n                                React.createElement(\"div\", { className: \"pageHeaderCornerBox\" }, cornerBox);\r\n                        })),\r\n                        React.createElement(\"div\", { className: \"buttonsField\" },\r\n                            React.createElement(\"div\", { className: \"buttonsContainer\" },\r\n                                React.createElement(LazyContent, { spinner: React.createElement(EllipsisLoader, null) }, lazyProps.map(function (_a) {\r\n                                    var tabs = _a.tabs, buttons = _a.buttons, activeTab = _a.activeTab, blocks = _a.blocks, sortableTabs = _a.sortableTabs, onTabDrop = _a.onTabDrop;\r\n                                    return React.createElement(React.Fragment, null,\r\n                                        blocks ? React.createElement(\"div\", { className: \"align-horizontal\" }, blocks.map(function (block) { return React.createElement(\"div\", { key: block.id, className: \"horizontalItem top\" },\r\n                                            React.createElement(\"div\", { className: \"align-vertical\" },\r\n                                                React.createElement(\"div\", null,\r\n                                                    React.createElement(\"a\", null, block.name)),\r\n                                                React.createElement(\"div\", null,\r\n                                                    React.createElement(\"div\", { className: \"btn-group\" }, block.steps.map(function (step) { return React.createElement(React.Fragment, { key: step.stepNo },\r\n                                                        React.createElement(Link, { to: step.link, className: \"btn btn-small step-button\" + (step.isActive ? \" activePage\" : \"\") }, step.stepNo),\r\n                                                        React.createElement(\"a\", null)); }))))); })) : null,\r\n                                        React.createElement(\"div\", { className: 'horizontalMenu' },\r\n                                            React.createElement(LazyContent, null, _this.dragState.map(function (_a) {\r\n                                                var tabBeingDragged = _a.tabBeingDragged, tabBeingHovered = _a.tabBeingHovered, insertBefore = _a.insertBefore, originClientX = _a.originClientX;\r\n                                                return React.createElement(\"ul\", { className: sortableTabs ? \"sortable\" : null, onDrop: onTabDrop ? function (ev) {\r\n                                                        if (tabBeingHovered && tabBeingDragged) {\r\n                                                            onTabDrop(tabBeingDragged, tabBeingHovered, insertBefore ?\r\n                                                                'before' : 'after');\r\n                                                        }\r\n                                                        _this.dragState.dispatch(tslib_1.__assign({}, _this.dragState.value, { tabBeingHovered: '', tabBeingDragged: '' }));\r\n                                                    } : null },\r\n                                                    tabs.map(function (_a, idx) {\r\n                                                        var name = _a.name, key = _a.key, link = _a.link, onClick = _a.onClick, draggable = _a.draggable;\r\n                                                        var isActive = activeTab === key || (activeTab === '$' && idx === 0);\r\n                                                        var dragState = _this.dragState;\r\n                                                        name = name || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"(Namnl\\u00F6s flik)\"], [\"(Namnl\\u00F6s flik)\"])));\r\n                                                        return React.createElement(React.Fragment, { key: key },\r\n                                                            insertBefore && tabBeingHovered === key ? React.createElement(\"li\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") : null,\r\n                                                            React.createElement(\"li\", { className: [\r\n                                                                    isActive ? \"activePage\" : \"\",\r\n                                                                    key === tabBeingDragged ? \"drag-source\" : \"\",\r\n                                                                    sortableTabs && draggable ? \"draggable\" : \"\"\r\n                                                                ].filter(function (x) { return x; }).join(' '), draggable: sortableTabs && draggable, onDragStart: sortableTabs && draggable ? function (ev) {\r\n                                                                    ev.dataTransfer.effectAllowed = \"move\";\r\n                                                                    dragState.dispatch(tslib_1.__assign({}, dragState.value, { originClientX: ev.clientX, tabBeingDragged: key }));\r\n                                                                } : null, onDragOver: sortableTabs ? function (ev) {\r\n                                                                    if (tabBeingDragged === key) {\r\n                                                                        dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: '' }));\r\n                                                                        return;\r\n                                                                    }\r\n                                                                    if (!tabBeingDragged)\r\n                                                                        return;\r\n                                                                    ev.preventDefault();\r\n                                                                    ev.dataTransfer.dropEffect = \"move\";\r\n                                                                    //console.log(\"onDragOver: \" + name + \". idx: \" + idx + \". otherIdx: \" + otherIdx);\r\n                                                                    dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: key, insertBefore: originClientX > ev.clientX }));\r\n                                                                } : null, onDragEnd: function (ev) {\r\n                                                                    _this.dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: '', tabBeingDragged: '' }));\r\n                                                                } }, link ? link.startsWith(\":\") ?\r\n                                                                React.createElement(\"a\", { href: preserveImpersonationQuery(link.substr(1), {}) }, name) :\r\n                                                                React.createElement(Link, { to: link }, name) :\r\n                                                                onClick ?\r\n                                                                    React.createElement(\"a\", { onClick: onClick }, name) :\r\n                                                                    name),\r\n                                                            !insertBefore && tabBeingHovered === key ? React.createElement(\"li\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") : null);\r\n                                                    }),\r\n                                                    buttons && buttons.map(function (btn, idx) { return React.createElement(\"li\", { className: \"action-tab\", key: \"btn\" + idx }, btn); }));\r\n                                            }))));\r\n                                })))))))));\r\n    };\r\n    return LazyBanner;\r\n}(React.Component));\r\nexport { LazyBanner };\r\nexport var Banner = function (props) { return React.createElement(LazyBanner, { lazyProps: new Emitter(props) }); };\r\nvar templateObject_1;\r\n","import * as React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nexport var SideList = function (_a) {\r\n    var items = _a.items, caption = _a.caption;\r\n    return (React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n        React.createElement(\"div\", { className: \"ked_boxed\" },\r\n            React.createElement(\"h3\", null, caption),\r\n            React.createElement(\"div\", { className: \"taskContainer odd-even\" }, items.map(function (item) { return React.createElement(\"div\", { className: \"schoolCourse\", key: item.id },\r\n                React.createElement(\"div\", { className: [\"align-horizontal\", item.$meta && \"entitymeta-\" + item.$meta].join(' ') },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top pull-right\" }, item.editLink.startsWith(':') ?\r\n                        React.createElement(\"a\", { href: item.editLink.substr(1), className: \"editItem\" }) :\r\n                        React.createElement(Link, { to: item.editLink, className: \"editItem\" })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, item.viewLink.startsWith(':') ?\r\n                        React.createElement(\"a\", { href: item.viewLink.substr(1) }, item.name) :\r\n                        React.createElement(Link, { to: item.viewLink }, item.name)),\r\n                    item.pills.map(function (pill, idx) {\r\n                        return React.createElement(\"div\", { key: idx, className: \"horizontalItem top\" },\r\n                            React.createElement(\"div\", { className: [\"pill\"].concat(pill.className).join(' ') }, pill.name));\r\n                    })),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"p\", null, item.description)),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"p\", { className: \"small\" }, item.smallText))); })))));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { SideList } from './side-list';\r\nimport { L } from '../../../utils/utils';\r\nimport { liveQueryView } from '../../utility-components/live-query-view';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { preserveImpersonationQuery } from '../../../access-control';\r\nimport { shortDateFormat } from '../../course-builder/utils';\r\nimport { listCourseInstances } from '../logic/list-course-instances';\r\nexport var StandardCourseInstanceList = liveQueryView(function () {\r\n    /*{\r\n      loading: ()=><Spinner />,\r\n      error: error => <p>Ojsan hoppsan fel: {error.message}</p>\r\n    },*/\r\n    return listCourseInstances()\r\n        .orderBy(\"name\")\r\n        .map(function (_a) {\r\n        var id = _a.id, $meta = _a.$meta, name = _a.name, description = _a.description, tags = _a.tags, type = _a.type, modifiedBy = _a.modifiedBy, modifiedDate = _a.modifiedDate;\r\n        return ({\r\n            id: id,\r\n            type: type,\r\n            $meta: $meta,\r\n            name: name,\r\n            description: description,\r\n            viewLink: \":\" + preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL, {}) + \"#/standard/courses/\" + id,\r\n            editLink: \"/admin/courses/\" + id + \"/settings\",\r\n            pills: tags.filter(function (tag) { return tag === \"active\"; })\r\n                .map(function (tag) { return ({\r\n                className: \"active\",\r\n                name: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Aktiv\"], [\"Aktiv\"])))\r\n            }); }),\r\n            smallText: modifiedBy && modifiedDate && L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Senast redigerad av \", \" / \", \"\"], [\"Senast redigerad av \", \" / \", \"\"])), modifiedBy.name, shortDateFormat(modifiedDate))\r\n        });\r\n    })\r\n        .toValue()\r\n        .map(function (courseItems) {\r\n        var stepCourseItems = courseItems.filter(function (course) { return course.type === 'step-course'; });\r\n        var themeCourseItems = courseItems.filter(function (course) { return course.type === 'theme-course'; });\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(SideList, { caption: \"Stegkurser\", items: stepCourseItems }),\r\n            React.createElement(SideList, { caption: \"Temakurser\", items: themeCourseItems }));\r\n    });\r\n});\r\nvar templateObject_1, templateObject_2;\r\n","import * as React from 'react';\r\nexport var TwoColumnsPage = function (_a) {\r\n    var left = _a.left, right = _a.right, rightWidth = _a.rightWidth;\r\n    return (React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n            React.createElement(\"div\", { className: \"sv-spacer-20pxvt sv-vertical sv-layout sv-skip-spacer\" },\r\n                React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" },\r\n                    React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n                        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-\" + (12 - rightWidth) }, left),\r\n                        React.createElement(\"div\", { className: \"sv-layout sv-column-\" + rightWidth }, right)))))));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport { distinct, flatten } from \"../../../utils/utils\";\r\nexport function getSubjectCodes(tags) {\r\n    return distinct((tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"sub:\"); })\r\n        .map(function (tag) { return tag.substr(\"sub:\".length); }));\r\n}\r\nexport function getSchoolYears(tags) {\r\n    return distinct((tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"course:\"); })\r\n        .map(function (tag) { return tag.substr(tag.indexOf(\"|\") + 1); }) // School year is concatenated as pipe + schoolyear. Example: \"GRGRFYS01|4-6\"\r\n    );\r\n}\r\nfunction computeGradesFromGradeSpan(gradeSpan) {\r\n    // gradeSpan is \"1-3\", \"4-6\" or \"7-9\"\r\n    var _a = tslib_1.__read(gradeSpan.split(\"-\"), 2), start = _a[0], end = _a[1];\r\n    var resultGrades = [];\r\n    if (start && end) {\r\n        var startGrade = parseInt(start);\r\n        var endGrade = parseInt(end);\r\n        while (startGrade <= endGrade) {\r\n            resultGrades.push(startGrade);\r\n            startGrade++;\r\n        }\r\n    }\r\n    return resultGrades;\r\n}\r\nexport function computeCourseInstanceTags(tags, subjectCodes, schoolYears) {\r\n    var otherTags = (tags || []).filter(function (tag) {\r\n        return !tag.startsWith(\"course:\") &&\r\n            !tag.startsWith(\"sub:\") &&\r\n            !tag.startsWith(\"grade:\");\r\n    });\r\n    var subjectTags = subjectCodes.map(function (sub) { return \"sub:\" + sub; });\r\n    var courseTags = flatten(subjectCodes.map(function (sub) {\r\n        return schoolYears.map(function (schoolYear) { return \"course:\" + sub + \"|\" + schoolYear; });\r\n    }));\r\n    var grades = flatten(schoolYears.map(function (schoolYear) { return computeGradesFromGradeSpan(schoolYear); }));\r\n    var gradeTags = tags.includes(\"active\")\r\n        ? grades.map(function (grade) { return \"grade:\" + grade; })\r\n        : [];\r\n    return otherTags\r\n        .concat(subjectTags)\r\n        .concat(courseTags)\r\n        .concat(gradeTags);\r\n}\r\nexport function computeTagsFromSchoolYears(tags, schoolYears) {\r\n    //schoolYears = schoolYears.map(afterColon);\r\n    var subjectCodes = getSubjectCodes(tags);\r\n    return computeCourseInstanceTags(tags, subjectCodes, schoolYears);\r\n}\r\nexport function computeTagsFromSubjectCodes(tags, subjectCodes) {\r\n    //subjectCodes = subjectCodes.map(afterColon);\r\n    var schoolYears = getSchoolYears(tags);\r\n    return computeCourseInstanceTags(tags, subjectCodes, schoolYears);\r\n}\r\nexport function computeTagsFromActiveState(tags, activeState) {\r\n    var subjectCodes = getSubjectCodes(tags);\r\n    var schoolYears = getSchoolYears(tags);\r\n    var tagsWithoutActiveState = tags.filter(function (tag) { return tag !== \"active\"; });\r\n    return computeCourseInstanceTags(tagsWithoutActiveState.concat(activeState ? \"active\" : []), subjectCodes, schoolYears);\r\n}\r\nfunction afterColon(str) {\r\n    var pColon = str.indexOf(\":\");\r\n    return pColon >= 0 ? str.substr(pColon + 1) : str;\r\n}\r\n","export function getCourseCodesFromTags(tags) {\r\n    return (tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"course:\"); })\r\n        .map(function (courseTag) { return courseTag.substr(\"course:\".length); });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { db } from '../../../globals/db';\r\nimport { getOrderedDocs } from './ordered-requirements';\r\nexport function getStandardCoursesWithOrderedRequirements(courseCodes) {\r\n    var _a;\r\n    var courseCodeTags = courseCodes.map(function (code) { return code.startsWith('course:') ? code : \"course:\" + code; });\r\n    if (courseCodeTags.length === 0)\r\n        return new Emitter([]);\r\n    return (_a = db.courses.include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")).tags.apply(_a, tslib_1.__spread(courseCodeTags)).filter(function (course) { return course.isTemplate; }) // BUGBUG: In KG, we would need this filter, not KS. Need another authorized way of getting the standard course only!\r\n        .map(function (course) { return (tslib_1.__assign({}, course, { abilities: getOrderedDocs(course.abilities, course.abilitiesOrder), centralContent: getOrderedDocs(course.centralContent, course.centralContentOrder), knowledgeRequirements: getOrderedDocs(course.knowledgeRequirements, course.knowledgeRequirementsOrder) })); }).toValue();\r\n}\r\n","import { db, globalId } from '../../../globals/db';\r\nexport function listCourseInstances() {\r\n    return db.courseInstances.hasEdgesFrom([globalId]);\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { db } from '../../../globals/db';\r\nimport { flatten } from '../../../utils/utils';\r\nexport function getOrderedDocs(docs, order, _a) {\r\n    var appendLeftovers = (_a === void 0 ? { appendLeftovers: false } : _a).appendLeftovers;\r\n    // Mark doc IDs that where present in given 'order' array.\r\n    // Will be used to find left-overs that were not present in the 'order' array.\r\n    var markedDocs = {};\r\n    if (!docs || !order) {\r\n        // Special case: no docs or no order. Don't fail. Just return docs as is.\r\n        return docs;\r\n    }\r\n    // Map given 'order' array to corresponding docs. Also mark in markedDocs.\r\n    var result = (docs && order ?\r\n        order.map(function (id) {\r\n            markedDocs[id] = true;\r\n            return docs.find(function (doc) { return doc.id === id; });\r\n        }).filter(function (doc) { return !!doc; }) :\r\n        docs);\r\n    if (appendLeftovers) {\r\n        // If any leftovers are there, concat them at the end:\r\n        var leftOvers = docs.filter(function (doc) { return !markedDocs[doc.id]; });\r\n        return result.concat(leftOvers);\r\n    }\r\n    else {\r\n        return result;\r\n    }\r\n}\r\nexport function resolveRequirementOrder(obj, orderDefiner) {\r\n    var _a;\r\n    var orderDefiningDocObservable;\r\n    if (orderDefiner) {\r\n        // User provided the orderDefining doc (use case is when obj is a Course or Subject, which contains its order by itself. User then provides the Course or Subject in both args)\r\n        orderDefiningDocObservable = new Emitter([orderDefiner]);\r\n    }\r\n    else {\r\n        var courseCodes = obj.tags.filter(function (tag) { return tag.startsWith(\"course:\"); });\r\n        if (courseCodes.length === 0) {\r\n            return new Emitter(obj); // No course tags. Not possible to resolve order.\r\n        }\r\n        orderDefiningDocObservable = (_a = db.courses).tags.apply(_a, tslib_1.__spread(courseCodes)).toValue();\r\n    }\r\n    return orderDefiningDocObservable.map(function (orderHolders) {\r\n        var abilitiesOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.abilitiesOrder || []; }));\r\n        var ccOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.centralContentOrder || []; }));\r\n        var krOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.knowledgeRequirementsOrder || []; }));\r\n        var objClone = Object.assign({}, obj);\r\n        if (objClone.abilities)\r\n            objClone.abilities = getOrderedDocs(obj.abilities, abilitiesOrder);\r\n        if (objClone.centralContent)\r\n            objClone.centralContent = getOrderedDocs(obj.centralContent, ccOrder);\r\n        if (objClone.knowledgeRequirements)\r\n            objClone.knowledgeRequirements = getOrderedDocs(obj.knowledgeRequirements, krOrder);\r\n        return objClone;\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { db } from '../../../globals/db';\r\nimport env from '../../../globals/KED.env';\r\nexport function publishCourse(_a) {\r\n    var school = _a.school, draftRepo = _a.draftRepo, course = _a.course;\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var destinationRepo, schoolBranchId;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    if (!(school === \"standard\")) return [3 /*break*/, 1];\r\n                    // Editing Standard School should merge to reality.\r\n                    draftRepo.merge();\r\n                    destinationRepo = db;\r\n                    return [3 /*break*/, 3];\r\n                case 1: return [4 /*yield*/, db.schools.name(school).single().map(function (school) { return school.officialBranchId; }).load()];\r\n                case 2:\r\n                    schoolBranchId = _b.sent();\r\n                    draftRepo.merge(schoolBranchId);\r\n                    destinationRepo = db.branch(schoolBranchId);\r\n                    _b.label = 3;\r\n                case 3:\r\n                    destinationRepo.courseInstances.update(course, {\r\n                        modifiedDate: Date.now(),\r\n                        modifiedBy: {\r\n                            name: env.currentUser.displayName,\r\n                            url: \"mailto:\" + env.currentUser.mail\r\n                        }\r\n                    });\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten, L } from \"../../../utils/utils\";\r\nimport { getEmailFromDocAccess } from '../utils';\r\nexport function getUncoveredKnowledgeRequirements(course) {\r\n    var uncoveredRequirements = course.knowledgeRequirements.reduce(function (result, item) {\r\n        result[item.id] = item;\r\n        return result;\r\n    }, {});\r\n    course.tasks.forEach(function (task) {\r\n        task.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredRequirements[kr.id];\r\n        });\r\n    });\r\n    return Object.keys(uncoveredRequirements).map(function (id) { return uncoveredRequirements[id]; });\r\n}\r\nexport function getIdsNotCoveredByTasks(course) {\r\n    return getIdsNotCoveredByReqReferencingDocs([course], course.tasks);\r\n}\r\nexport function getIdsNotCoveredByReqReferencingDocs(templates, docsBeingChecked) {\r\n    var uncoveredIds = {};\r\n    // 1. Mark the ids of all knowledge requirements, abilities and central content for this course:\r\n    templates.forEach(function (course) {\r\n        course.knowledgeRequirements.forEach(function (r) {\r\n            uncoveredIds[r.id] = true;\r\n        });\r\n        course.abilities.forEach(function (a) {\r\n            uncoveredIds[a.id] = true;\r\n        });\r\n        course.centralContent.forEach(function (cc) {\r\n            uncoveredIds[cc.id] = true;\r\n        });\r\n    });\r\n    // 2. List all tasks and unmark all ids that they refer to\r\n    docsBeingChecked.forEach(function (doc) {\r\n        doc.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredIds[kr.id];\r\n        });\r\n        doc.abilities.forEach(function (a) {\r\n            delete uncoveredIds[a.id];\r\n        });\r\n        doc.centralContent.forEach(function (cc) {\r\n            delete uncoveredIds[cc.id];\r\n        });\r\n    });\r\n    return uncoveredIds;\r\n}\r\nexport function sanityCheck(course) {\r\n    function hasDuplicateTasks(course) {\r\n        var taskIds = {};\r\n        return flatten(course.modules.map(function (module) { return module.taskIds.map(function (taskId) {\r\n            if (taskIds[taskId]) {\r\n                var task = course.tasks.find(function (t) { return t.id === taskId; });\r\n                return L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"], [\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"])), task.name);\r\n            }\r\n            taskIds[taskId] = true;\r\n        }).filter(function (x) { return x; }); }));\r\n    }\r\n    function tasksWithSameUrl(course) {\r\n        var taskUrls = {};\r\n        return course.tasks.map(function (task) {\r\n            if (task.url) {\r\n                if (taskUrls[task.url]) {\r\n                    return L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"], [\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"])), taskUrls[task.url].name, task.name);\r\n                }\r\n                taskUrls[task.url] = task;\r\n            }\r\n        }).filter(function (x) { return x; });\r\n    }\r\n    function hasEmptyModuleNames(course) {\r\n        return course.modules.some(function (module) { return module.name === \"\"; }) && L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Det finns minst en modul utan angivet namn\"], [\"Det finns minst en modul utan angivet namn\"])));\r\n    }\r\n    function hasDuplicateModuleNames(course) {\r\n        var moduleNames = {};\r\n        return course.modules.map(function (module) {\r\n            if (module.name && moduleNames[module.name]) {\r\n                return L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"], [\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"])), module.name);\r\n            }\r\n            if (module.name)\r\n                moduleNames[module.name] = true;\r\n        });\r\n    }\r\n    var checks = flatten([\r\n        hasDuplicateTasks(course),\r\n        tasksWithSameUrl(course),\r\n        hasEmptyModuleNames(course),\r\n        hasDuplicateModuleNames(course)\r\n    ]);\r\n    return checks.filter(function (result) { return result; });\r\n}\r\nexport function getTasksPerId(course) {\r\n    var result = {};\r\n    function add(id, task) {\r\n        var list = result[id] || (result[id] = []);\r\n        list.push(task);\r\n    }\r\n    course.tasks.forEach(function (task) {\r\n        task.abilities.forEach(function (a) { return add(a.id, task); });\r\n        task.centralContent.forEach(function (c) { return add(c.id, task); });\r\n        task.futureAbilities.forEach(function (fa) { return add(fa, task); });\r\n    });\r\n    return result;\r\n}\r\n/** Returns an access list for a course in a backward compatible way */\r\nexport function getSoftAccessList(course) {\r\n    var responsibleTeachers = course.responsibleTeachers;\r\n    var result = responsibleTeachers.map(function (da) { return ({\r\n        name: da.name,\r\n        email: getEmailFromDocAccess(da),\r\n        access: da.access || 'edit'\r\n    }); });\r\n    return result;\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nimport { allowCopy } from \"../utils\";\r\nimport { showError, L } from \"../../../utils/utils\";\r\nimport { createUUID } from \"kedbackend/client\";\r\nimport env from '../../../globals/KED.env';\r\nvar AdminMenuItems = [\r\n    { name: \"schools\", text: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolor\"], [\"Skolor\"]))), route: \"/schools\" },\r\n    { name: \"subjects\", text: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mnen\"], [\"\\u00C4mnen\"]))), route: \"/subjects\" },\r\n];\r\nvar NonAdminMenuItems = [\r\n    { name: \"courseBuilder\", text: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Kursbyggaren\"], [\"Kursbyggaren\"]))), route: \"/courses/new\" },\r\n    { name: \"studentPage\", text: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Elevsida\"], [\"Elevsida\"]))), route: \"\" },\r\n    { name: \"feedback\", text: React.createElement(\"span\", null,\r\n            React.createElement(\"i\", { className: \"fa fa-commenting-o\", \"aria-hidden\": \"true\" }),\r\n            \" Feedback\"), route: \"https://kg.kunskapsporten.se/kursbyggaren/\" }\r\n];\r\nfunction onDropImage(ev, host, course, origCourse) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var files, url, items, file, form, res, _loop_1, i;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    ev.stopPropagation();\r\n                    ev.preventDefault();\r\n                    files = ev.dataTransfer.files;\r\n                    url = null;\r\n                    items = Array.from(ev.dataTransfer.items);\r\n                    if (!(files.length > 0)) return [3 /*break*/, 3];\r\n                    file = files[0];\r\n                    if (file.size > 2 * 1024 * 1024) {\r\n                        showError(L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Kan inte ladda upp bilder st\\u00F6rre \\u00E4n 2 MB\"], [\"Kan inte ladda upp bilder st\\u00F6rre \\u00E4n 2 MB\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    form = new FormData();\r\n                    form.append(\"files\", file);\r\n                    return [4 /*yield*/, env.kedBackendClient.http.fetch('web-upload', 'put', {}, {}, {\r\n                            body: form\r\n                        })];\r\n                case 1:\r\n                    res = _a.sent();\r\n                    if (res.status !== 200) {\r\n                        showError(L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Kunde inte ladda upp filen till Google Storage\"], [\"Kunde inte ladda upp filen till Google Storage\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    return [4 /*yield*/, res.text()];\r\n                case 2:\r\n                    url = _a.sent();\r\n                    return [3 /*break*/, 7];\r\n                case 3:\r\n                    _loop_1 = function (i) {\r\n                        var item;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    item = items[i];\r\n                                    if (!item.type.match('^text/uri-list')) return [3 /*break*/, 2];\r\n                                    return [4 /*yield*/, new Promise(function (resolve) { return item.getAsString(resolve); })];\r\n                                case 1:\r\n                                    // URI\r\n                                    url = _a.sent();\r\n                                    _a.label = 2;\r\n                                case 2: return [2 /*return*/];\r\n                            }\r\n                        });\r\n                    };\r\n                    i = 0;\r\n                    _a.label = 4;\r\n                case 4:\r\n                    if (!(i < items.length)) return [3 /*break*/, 7];\r\n                    return [5 /*yield**/, _loop_1(i)];\r\n                case 5:\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6:\r\n                    ++i;\r\n                    return [3 /*break*/, 4];\r\n                case 7:\r\n                    if (url == null) {\r\n                        showError(L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Kunde inte hitta n\\u00E5gon bild i inneh\\u00E5llet\"], [\"Kunde inte hitta n\\u00E5gon bild i inneh\\u00E5llet\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    setCourseImage(course, origCourse, host, url);\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function setCourseImage(course, origCourse, host, url) {\r\n    var imageId = createUUID();\r\n    host.update({\r\n        imageId: { $set: imageId },\r\n        images: {\r\n            $set: [{\r\n                    id: imageId,\r\n                    url: url,\r\n                    acl: [\r\n                        \"role:USER:R\",\r\n                        \"schoolRole:\" + env.currentUser.school + \"/EMPLOYEE:S\"\r\n                    ],\r\n                    $meta: 'add'\r\n                }]\r\n        }\r\n    });\r\n}\r\n/* This version had the bug that old images were not replaced.\r\nOne course at Uppsala contained 12 images.\r\n\r\n\r\nexport function setCourseImageOld(\r\n  course: Course,\r\n  origCourse: Course,\r\n  host: ICourseEditorHost,\r\n  url: string)\r\n{\r\n  if (!origCourse || !origCourse.imageId) {\r\n    const imageId = createUUID();\r\n    host.update({\r\n      imageId: { $set: imageId },\r\n      images: {\r\n        $push: [{\r\n          id: imageId,\r\n          url,\r\n          acl: course.isTemplate ? [\"role:USER:R\"] : [\"role:USER:R\", `schoolRole:${env.currentUser.school}/EMPLOYEE:S`],\r\n          $meta: 'add'\r\n        }]\r\n      }\r\n    });\r\n  } else {\r\n    // Update existing image:\r\n    const imgIdx = course.images.findIndex(img => img.id === course.imageId);\r\n    if (imgIdx >= 0) {\r\n      const imageEntity = course.images[imgIdx];\r\n      if (course.isTemplate) {\r\n        // Templates: Update the template image content:\r\n        host.update({\r\n          images: {\r\n            $splice: [[imgIdx, 1, {\r\n              ...imageEntity,\r\n              url,\r\n              $meta: 'update'\r\n            }]]\r\n          }\r\n        })\r\n      } else {\r\n        // Real courses: Replace with a new image\r\n        const imageId = createUUID();\r\n        host.update({\r\n          imageId: { $set: imageId },\r\n          images: {\r\n            $splice: [[imgIdx, 1, {\r\n              id: imageId,\r\n              url,\r\n              acl: [\r\n                `role:USER:R`,\r\n                `schoolRole:${env.currentUser.school}/EMPLOYEE:S`\r\n              ],\r\n              $meta: 'add'\r\n            }]]\r\n          }\r\n        })\r\n      }\r\n    } else {\r\n      showError(L`Kunde inte uppdatera bilden.`);\r\n    }\r\n  }\r\n}\r\n*/\r\nexport var CourseBanner = function (props) {\r\n    var title = props.title, isTemplate = props.isTemplate, host = props.host, course = props.course, origCourse = props.origCourse, backgroundImage = props.backgroundImage, activePage = props.activePage;\r\n    var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n    var menuItems = NonAdminMenuItems;\r\n    if (isAdmin)\r\n        menuItems = AdminMenuItems.concat(menuItems);\r\n    return React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n            React.createElement(\"div\", { className: \"sv-script-portlet sv-portlet sv-skip-spacer\" },\r\n                backgroundImage && React.createElement(\"style\", null, \"\\n        .pageHeader {\\n          background-image: url('\" + backgroundImage + \"') !important;\\n        }\\n      \"),\r\n                React.createElement(\"div\", { className: \"pageHeader\", onDragOver: course && allowCopy, onDrop: course && (function (ev) { return onDropImage(ev, host, course, origCourse); }) },\r\n                    React.createElement(\"a\", null,\r\n                        React.createElement(\"h1\", null, title)),\r\n                    React.createElement(\"div\", { className: \"buttonsField\" },\r\n                        React.createElement(\"div\", { className: \"buttonsContainer\" },\r\n                            React.createElement(\"div\", { className: \"align-horizontal\" }),\r\n                            React.createElement(\"div\", { className: 'horizontalMenu' },\r\n                                React.createElement(\"ul\", null, menuItems.map(function (item) { return ({\r\n                                    item: item,\r\n                                    isActive: activePage === item.name,\r\n                                    callback: props.callbacks && props.callbacks[item.name],\r\n                                    givenRoute: (props.routes && props.routes[item.name]),\r\n                                    defaultRoute: item.route\r\n                                }); }).filter(function (x) { return x.callback || x.defaultRoute || x.givenRoute; }).map(function (_a) {\r\n                                    var item = _a.item, isActive = _a.isActive, callback = _a.callback, defaultRoute = _a.defaultRoute, givenRoute = _a.givenRoute;\r\n                                    return React.createElement(\"li\", { key: item.name, className: isActive ? \"activePage\" : \"\", onClick: callback }, callback ?\r\n                                        React.createElement(\"a\", null, item.text) :\r\n                                        defaultRoute || givenRoute ?\r\n                                            givenRoute || /^http[s]\\:\\/\\//i.test(defaultRoute) ?\r\n                                                React.createElement(\"a\", { href: givenRoute || defaultRoute }, item.text) :\r\n                                                React.createElement(Link, { to: defaultRoute }, item.text) :\r\n                                            React.createElement(\"a\", null, item.text));\r\n                                })))))))));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten } from '../../utils/utils';\r\n//get sentences by requirement\r\nexport function getRequirmentSentences(requirement) {\r\n    return requirement.split(\".\").filter(function (e) { return e; });\r\n}\r\n//retrieve sentences\r\nexport function getSavedSentences(partialRequirments) {\r\n    return partialRequirments.map(function (obj) {\r\n        return obj.trim();\r\n    }) || [];\r\n}\r\n//check all requirements are marked\r\nexport function allRequirementSentecesMarked(requirementName, partialRequirements) {\r\n    var textSentences = getRequirmentSentences(requirementName);\r\n    return partialRequirements && partialRequirements.length === textSentences.length;\r\n    ;\r\n}\r\n//get the partial saved sentences for the default view\r\nexport function getPartialContentDefaultView(requirement, partialRequirments, alreadyCoveredPartialRequirments, skipNotMarked) {\r\n    var resultedHtml = requirement.name;\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n    var allReqCoveredSentence = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n    var allReqSentencesMarked = allRequirementSentecesMarked(requirement.name, rowRequirments);\r\n    textSentences.forEach(function (sentence) {\r\n        //trimm current sentence\r\n        var trimmedSentence = sentence.trim();\r\n        var fullSentence = sentence + \".\";\r\n        if (rowRequirments && rowRequirments.includes(trimmedSentence) && !allReqSentencesMarked) {\r\n            resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedGreen\" + \">\" + fullSentence + \"</span>\");\r\n        }\r\n        else {\r\n            var coveredSentece = allReqCoveredSentence && allReqCoveredSentence.includes(trimmedSentence);\r\n            if (coveredSentece) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span>\" + fullSentence + \"</span>\");\r\n            }\r\n            else if (!allReqSentencesMarked && allReqCoveredSentence && allReqCoveredSentence.length > 0) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedRed\" + \">\" + fullSentence + \"</span>\");\r\n            }\r\n        }\r\n    });\r\n    return resultedHtml;\r\n}\r\n//check the current requirement is already covered\r\nexport function isPartialCoveredRequirment(requirement, alreadyCoveredPartialRequirments) {\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var result = false;\r\n    for (var i = 0; i < textSentences.length; i++) {\r\n        var trimmedSentence = textSentences[i].trim();\r\n        var allCoveredSentenceReq = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n        var coveredSentece = allCoveredSentenceReq && allCoveredSentenceReq.includes(trimmedSentence);\r\n        if (coveredSentece) {\r\n            result = true;\r\n            break;\r\n        }\r\n    }\r\n    return result;\r\n}\r\n//compute the covered senteces excluding the current requirement\r\nexport function getCoveredSenteces(allReq, requirementId) {\r\n    var resultArray = [];\r\n    allReq.forEach(function (obj) {\r\n        var assignedReq = Object.assign([], Object.keys(obj).filter(function (reqId) { return reqId == requirementId; }).map(function (k) { return obj[k].map(function (elem) { return elem.trim(); }); }));\r\n        resultArray.push.apply(resultArray, tslib_1.__spread(assignedReq));\r\n    });\r\n    return flatten(resultArray);\r\n}\r\n//sort the selected sentences by the order of the appearance in the requirement\r\nexport function getSortedRequirments(textSentences, partialRequirments) {\r\n    var output = [];\r\n    var indexedSentences = textSentences.map(function (e, i) { return { ind: i, val: e }; });\r\n    output = indexedSentences.filter(function (s) { return partialRequirments.includes(s.val); });\r\n    return output ? output.sort(function (x, y) { return x.ind > y.ind ? 1 : -1; }).map(function (s) { return s.val; }) : [];\r\n}\r\nexport function getMigrationTitle(isMigrated, markMode) {\r\n    return isMigrated ?\r\n        markMode ?\r\n            \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n            \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n        undefined;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport { showError, L } from \"../../../utils/utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { createUUID, DocumentAccess, BatchRunner } from \"kedbackend/client\";\r\nimport { Link } from 'react-router-dom';\r\nexport var EditSchool = function (props) { return React.createElement(\"div\", { style: { outline: 0 } },\r\n    React.createElement(CourseBanner, { title: \"Skolor\", activePage: \"schools\", callbacks: { schools: function () { return location.hash = \"#/schools\"; } }, routes: { feedback: props.feedbackUrl } }),\r\n    React.createElement(EditSchoolNoBanner, tslib_1.__assign({}, props))); };\r\nvar EditSchoolNoBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditSchoolNoBanner, _super);\r\n    function EditSchoolNoBanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = null;\r\n        return _this;\r\n    }\r\n    EditSchoolNoBanner.prototype.componentDidMount = function () {\r\n        this.load().catch(function (err) { return showError(err); });\r\n    };\r\n    EditSchoolNoBanner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var id, school;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.props.id) return [3 /*break*/, 2];\r\n                        id = this.props.id;\r\n                        return [4 /*yield*/, env.kedBackendClient.get(\"schools\", id)];\r\n                    case 1:\r\n                        school = _a.sent();\r\n                        this.origSchool = tslib_1.__assign({}, school);\r\n                        this.setState(tslib_1.__assign({}, school));\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        // No id, create new instead.\r\n                        this.setState({\r\n                            id: createUUID(),\r\n                            officialBranchId: createUUID(),\r\n                            isGymnasium: this.props.type === 'gymnasium',\r\n                            isPrimarySchool: this.props.type === 'primary'\r\n                        });\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var r, school;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        r = new BatchRunner();\r\n                        school = tslib_1.__assign({}, this.state, { tags: (this.state.tags || [])\r\n                                .filter(function (tag) { return [\"primary\", \"gymnasium\"].indexOf(tag) < 0; }) });\r\n                        if (school.isPrimarySchool)\r\n                            school.tags.push(\"primary\");\r\n                        if (school.isGymnasium)\r\n                            school.tags.push(\"gymnasium\");\r\n                        if (!(school.isGymnasium || school.isPrimarySchool)) {\r\n                            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolan m\\u00E5ste antingen vara gymnasium eller grundskola\"], [\"Skolan m\\u00E5ste antingen vara gymnasium eller grundskola\"]))));\r\n                        }\r\n                        if (!this.origSchool) {\r\n                            school.acl = [\"role:USER:R\"];\r\n                            school.acl.push(new DocumentAccess(\"schoolRole\", school.name + \"/EMPLOYEE\", \"W\").toString());\r\n                            r.add(\"schools\", school);\r\n                            this.addSchoolBranch(school, r);\r\n                        }\r\n                        else if (this.origSchool.name !== this.state.name) {\r\n                            throw new Error(\"Skolans namn får inte ändras. Kontakta Vemendo AB.\");\r\n                        }\r\n                        else {\r\n                            if (!school.officialBranchId) {\r\n                                school.officialBranchId = createUUID();\r\n                                this.addSchoolBranch(school, r);\r\n                            }\r\n                            r.put(\"schools\", school);\r\n                        }\r\n                        return [4 /*yield*/, env.kedBackendClient.batch(r.mutationRequests)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        location.hash = \"#/schools\";\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.addSchoolBranch = function (school, r) {\r\n        var branch = {\r\n            id: school.officialBranchId,\r\n            name: school.name,\r\n            schoolId: school.id,\r\n            acl: [\r\n                \"role:USER:R\",\r\n                new DocumentAccess(\"schoolRole\", school.name + \"/EMPLOYEE\", \"W\").toString()\r\n            ]\r\n        };\r\n        r.add(\"branches\", branch);\r\n    };\r\n    EditSchoolNoBanner.prototype.deleteSchool = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schoolBranch, br_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(prompt(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4r du s\\u00E4ker p\\u00E5 att ta bort skolan \\\"\", \"\\\"? Skriv skolans exakta namn f\\u00F6r att bekr\\u00E4fta\"], [\"\\u00C4r du s\\u00E4ker p\\u00E5 att ta bort skolan \\\"\", \"\\\"? Skriv skolans exakta namn f\\u00F6r att bekr\\u00E4fta\"])), this.state.name)) === this.state.name)) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"branches\", {\r\n                                ids: [this.state.officialBranchId],\r\n                                include: \"approvedChildren\",\r\n                                flags: [\"includeIdsOnly\"]\r\n                            })];\r\n                    case 1:\r\n                        schoolBranch = _a.sent();\r\n                        br_1 = new BatchRunner();\r\n                        br_1.delete(\"schools\", this.state.id);\r\n                        schoolBranch[0].approvedChildren.forEach(function (_a) {\r\n                            var id = _a.id;\r\n                            br_1.delete(\"branches\", id);\r\n                        });\r\n                        br_1.delete(\"branches\", this.state.officialBranchId);\r\n                        return [4 /*yield*/, env.kedBackendClient.batch(br_1.mutationRequests)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        location.hash = \"#/schools\";\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        alert(\"Skolan togs inte bort eftersom det namn du angav inte stämmer.\");\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, id = _a.id;\r\n        var editExisting = !!id;\r\n        var school = this.state;\r\n        var origSchool = this.origSchool;\r\n        var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n        return React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n            React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, title),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Namn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: !school || !school.name, disabled: !isAdmin || editExisting, tabIndex: 1, size: 50, value: school ? school.name : \"\", onChange: function (ev) { return _this.setState({ name: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Visningsnamn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: school && !school.displayName, disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.displayName : \"\", onChange: function (ev) { return _this.setState({ displayName: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                school && school.isGymnasium ? React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"EDS namn (gymnasium):\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.edsSchoolNameGymn : \"\", onChange: function (ev) { return _this.setState({ edsSchoolNameGymn: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })) : null,\r\n                school && school.isPrimarySchool ? React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"EDS namn (grundskola):\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.edsSchoolNamePrim : \"\", onChange: function (ev) { return _this.setState({ edsSchoolNamePrim: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })) : null,\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Typ:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"checkbox\", name: \"schoolTypePrimary\", disabled: !isAdmin, checked: school && school.isPrimarySchool, tabIndex: 1, value: \"primary\", onChange: function (ev) { return _this.setState({ isPrimarySchool: ev.target.checked }); } }),\r\n                        \"\\u00A0Grundskola\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"checkbox\", name: \"schoolTypeGymnasium\", disabled: !isAdmin, checked: school && school.isGymnasium, tabIndex: 1, value: \"gymnasium\", onChange: function (ev) { return _this.setState({ isGymnasium: ev.target.checked }); } }),\r\n                        \"\\u00A0Gymnasium\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null),\r\n                isAdmin && editExisting && React.createElement(\"div\", { tabIndex: 2, className: \"btn btn-warning btn-large pull-right\", onClick: function () {\r\n                        return _this.deleteSchool().catch(showError);\r\n                    } }, \"Ta bort skola\"),\r\n                React.createElement(\"div\", { className: \"pull-right\" }, \"\\u00A0\"),\r\n                React.createElement(Link, { className: \"btn btn-warning btn-large pull-right\", to: \"/schools\" }, \"Avbryt\"),\r\n                isAdmin && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-large\", onClick: function () {\r\n                        if (origSchool && origSchool.name !== school.name) {\r\n                            if (!confirm(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\\u00C4r du s\\u00E4ker p\\u00E5 att du vill d\\u00F6pa om skolan? Detta p\\u00E5verkar portalens funktion f\\u00F6r l\\u00E4rare och elever som tillh\\u00F6r skolan. Namnet m\\u00E5ste st\\u00E4mma exakt \\u00F6verens med namngivningen av skolan p\\u00E5 anv\\u00E4ndarobjekten.\\n\\nDet som h\\u00E4nder annars \\u00E4r att elever och l\\u00E4rare p\\u00E5 skolan inte l\\u00E4ngre hittar n\\u00E5gra kurser.\\n\\nBlir det fel kan du dock alltid bara d\\u00F6pa tillbaka skolans namn.\"], [\"\\u00C4r du s\\u00E4ker p\\u00E5 att du vill d\\u00F6pa om skolan? Detta p\\u00E5verkar portalens funktion f\\u00F6r l\\u00E4rare och elever som tillh\\u00F6r skolan. Namnet m\\u00E5ste st\\u00E4mma exakt \\u00F6verens med namngivningen av skolan p\\u00E5 anv\\u00E4ndarobjekten.\\n\\nDet som h\\u00E4nder annars \\u00E4r att elever och l\\u00E4rare p\\u00E5 skolan inte l\\u00E4ngre hittar n\\u00E5gra kurser.\\n\\nBlir det fel kan du dock alltid bara d\\u00F6pa tillbaka skolans namn.\"]))))) {\r\n                                return;\r\n                            }\r\n                        }\r\n                        _this.save().catch(showError);\r\n                    } }, \"Spara\")));\r\n    };\r\n    return EditSchoolNoBanner;\r\n}(React.Component));\r\nexport { EditSchoolNoBanner };\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { Link } from 'react-router-dom';\r\nimport { actAs } from \"../../../access-control\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nexport var EditableSchoolList = function (props) {\r\n    var schools = props.schools, viewCourseUrl = props.viewCourseUrl;\r\n    var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n    return React.createElement(\"div\", { className: \"editable-school-list\" },\r\n        React.createElement(\"div\", null, schools ? React.createElement(\"table\", null,\r\n            React.createElement(\"tbody\", null, schools.map(function (school) {\r\n                return React.createElement(\"tr\", { className: \"align-horizontal\", key: school.id },\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(Link, { className: \"editItem\", to: \"/schools/\" + school.id + \"/edit\" })),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null, school.name)),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(\"a\", { style: { cursor: 'pointer' }, onClick: function () { return actAs({ role: \"EMPLOYEE\", school: school.name }); } }, \"Agera som l\\u00E4rare p\\u00E5 denna skola\"))),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(\"a\", { style: { cursor: 'pointer' }, onClick: function () { return actAs({ role: \"STUDENT\", school: school.name, url: viewCourseUrl }); } }, \"Agera som elev p\\u00E5 denna skola\"))));\r\n            }))) : React.createElement(\"p\", null,\r\n            React.createElement(Spinner, null),\r\n            \"V.g. v\\u00E4nta medan skolor laddas\")),\r\n        React.createElement(\"br\", null),\r\n        schools && isAdmin && React.createElement(Link, { to: \"/schools/new/\" + props.type, className: \"btn\" }, props.type == 'gymnasium' ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till gymnasieskola\"], [\"L\\u00E4gg till gymnasieskola\"]))) :\r\n            props.type == 'primary' ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till grundskola\"], [\"L\\u00E4gg till grundskola\"]))) : L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till skola\"], [\"L\\u00E4gg till skola\"])))));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport env from '../../../globals/KED.env';\r\nimport { EditableSchoolList } from './editable-school-list';\r\nimport { showError, compareProp } from \"../../../utils/utils\";\r\nimport { Spinner } from '../sub-components/spinner';\r\nexport var Schools = function (props) { return React.createElement(\"div\", { style: { outline: 0 } },\r\n    React.createElement(CourseBanner, { title: \"Skolor\", activePage: \"schools\", routes: { feedback: props.feedbackUrl } }),\r\n    React.createElement(SchoolsWithoutBanner, { viewCourseUrl: props.viewCourseUrl })); };\r\nvar SchoolsWithoutBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SchoolsWithoutBanner, _super);\r\n    function SchoolsWithoutBanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            schools: null\r\n        };\r\n        return _this;\r\n    }\r\n    SchoolsWithoutBanner.prototype.componentDidMount = function () {\r\n        this.load().catch(function (err) { return showError(err.message || err); });\r\n    };\r\n    SchoolsWithoutBanner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schools;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.list(\"schools\")];\r\n                    case 1:\r\n                        schools = _a.sent();\r\n                        this.setState({ schools: schools });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SchoolsWithoutBanner.prototype.render = function () {\r\n        var schools = this.state.schools;\r\n        schools && schools.sort(compareProp(\"name\"));\r\n        return React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n            React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" }, schools ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, \"Gymnasieskolor\"),\r\n                    React.createElement(EditableSchoolList, { schools: schools.filter(function (school) { return school.isGymnasium; }), viewCourseUrl: this.props.viewCourseUrl, type: \"gymnasium\" })),\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, \"Grundskolor\"),\r\n                    React.createElement(EditableSchoolList, { schools: schools.filter(function (school) { return school.isPrimarySchool; }), viewCourseUrl: this.props.viewCourseUrl, type: \"primary\" }))) : React.createElement(Spinner, null)));\r\n    };\r\n    return SchoolsWithoutBanner;\r\n}(React.Component));\r\nexport { SchoolsWithoutBanner };\r\n","import * as React from 'react';\r\nexport var EllipsisLoader = function () {\r\n    return React.createElement(\"img\", { style: { border: 0, margin: 0, padding: 0 }, className: \"ellipsis-loader\" });\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { getPartialContentDefaultView, getRequirmentSentences, getCoveredSenteces, getSavedSentences, isPartialCoveredRequirment, getMigrationTitle, getSortedRequirments, allRequirementSentecesMarked } from '../knowledge-matrix-partial-utils';\r\nvar KnowledgeMatrix = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KnowledgeMatrix, _super);\r\n    function KnowledgeMatrix(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    KnowledgeMatrix.prototype.getKnowledgeSentencesContent = function (requirement, partialRequirments, index, markedOk, isMigrated) {\r\n        var _this = this;\r\n        var _a = this.props, coveredPartialRequirments = _a.coveredPartialRequirments, markMode = _a.markMode;\r\n        //split text in senteces\r\n        var textSentences = getRequirmentSentences(requirement.name);\r\n        //get saved sencenteces for the current requirement\r\n        var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n        //get all saved senteces excluding the current ones\r\n        var allCoveredSentenceReq = coveredPartialRequirments && getCoveredSenteces(coveredPartialRequirments, requirement.id);\r\n        return React.createElement(\"td\", { key: index, title: getMigrationTitle(isMigrated, markMode) }, textSentences.map(function (sentence, k) {\r\n            var trimmedSentence = sentence.trim();\r\n            var hasValue = rowRequirments && rowRequirments.includes(trimmedSentence) || markedOk && !rowRequirments;\r\n            var sentenceNotMarked = !allCoveredSentenceReq.includes(trimmedSentence);\r\n            return React.createElement(\"span\", { key: k, dangerouslySetInnerHTML: { __html: sentence ? sentence + \".\" : \"\" }, className: \"selectable\" + (hasValue ? \" markedGreen\" : (sentenceNotMarked ? \" markedRed\" : \"\")), onClick: function () {\r\n                    var updatedRequirments = partialRequirments ? Object.assign([], partialRequirments) : [];\r\n                    var shouldBeRemoved = rowRequirments && rowRequirments.includes(trimmedSentence);\r\n                    //check if no partial data saved, but the requirment is markedOk\r\n                    if (markedOk && (!rowRequirments || rowRequirments.length == 0)) {\r\n                        //save all excepting the one that should be removed\r\n                        updatedRequirments = textSentences.filter(function (x) { return x != sentence; });\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                    else {\r\n                        if (shouldBeRemoved) {\r\n                            updatedRequirments = partialRequirments.filter(function (req) { return req != sentence; });\r\n                        }\r\n                        else {\r\n                            updatedRequirments.push(sentence);\r\n                        }\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                } });\r\n        }));\r\n    };\r\n    KnowledgeMatrix.prototype.onRequirementChanged = function (requirement, value, partialValues, allPartialMarked) {\r\n        if (this.props.onUpdatePartialKnowledge) {\r\n            //remove all saved senteces if the requirement is unchecked\r\n            (value && !partialValues || allPartialMarked) ? this.props.onUpdatePartialKnowledge(requirement.id, []) : this.props.onUpdatePartialKnowledge(requirement.id, getRequirmentSentences(requirement.name));\r\n        }\r\n        else {\r\n            this.props.onMarkChanged(requirement.id, !value);\r\n        }\r\n    };\r\n    KnowledgeMatrix.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, knowledgeRequirements = _a.knowledgeRequirements, markedIds = _a.markedIds, migratedIds = _a.migratedIds, explainedRequirements = _a.explainedRequirements, markBySentenceView = _a.markBySentenceView, markPartialFeatureEnabled = _a.markPartialFeatureEnabled;\r\n        var _b = this.props, idsToMarkNotOk = _b.idsToMarkNotOk, markMode = _b.markMode, onExplainedRequirementsChanged = _b.onExplainedRequirementsChanged, partialRequirments = _b.partialRequirments, coveredPartialRequirments = _b.coveredPartialRequirments;\r\n        var columns = [\"E\", \"C\", \"A\"];\r\n        var rows = [];\r\n        var reqs = knowledgeRequirements.slice();\r\n        var row = null;\r\n        while (true) {\r\n            row = columns.map(function (grade) {\r\n                var pNext = reqs.findIndex(function (r) { return r.gradeStep && r.gradeStep.toUpperCase() === grade; });\r\n                if (pNext < 0)\r\n                    return null;\r\n                var rv = reqs[pNext];\r\n                reqs.splice(pNext, 1);\r\n                return rv;\r\n            });\r\n            if (row.every(function (r) { return r === null; }))\r\n                break;\r\n            rows.push(row);\r\n        }\r\n        return React.createElement(\"table\", { className: \"knowledge-matrix\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null, columns.map(function (c) { return React.createElement(\"th\", { key: c }, c); }))),\r\n            React.createElement(\"tbody\", null, rows.map(function (row, i) { return React.createElement(React.Fragment, { key: i },\r\n                React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0;\r\n                    var isMarkedNotOK = requirement && idsToMarkNotOk && idsToMarkNotOk[requirement.id]; //not used anymore\r\n                    var isMigrated = requirement && migratedIds && !!migratedIds[requirement.id];\r\n                    var rowPartialRequirements = requirement && partialRequirments && partialRequirments[requirement.id];\r\n                    var partialValues = rowPartialRequirements && getSavedSentences(rowPartialRequirements);\r\n                    var allReqSentencesMarked = requirement && allRequirementSentecesMarked(requirement.name, partialValues);\r\n                    var hasPartialCovered = requirement && isPartialCoveredRequirment(requirement, coveredPartialRequirments);\r\n                    var markedRed = !(partialValues && partialValues.length > 0 || hasPartialCovered);\r\n                    return requirement && markBySentenceView && markPartialFeatureEnabled ? _this.getKnowledgeSentencesContent(requirement, rowPartialRequirements, j, isMarkedOK, isMigrated) :\r\n                        React.createElement(\"td\", { key: j, dangerouslySetInnerHTML: { __html: requirement ? (rowPartialRequirements && rowPartialRequirements.length || hasPartialCovered) ?\r\n                                    getPartialContentDefaultView(requirement, rowPartialRequirements, coveredPartialRequirments, markedRed) : requirement.name : \"\" }, className: (markMode ? \"selectable\" : \"\") +\r\n                                (isMigrated ? \" migrated\" : \"\") +\r\n                                (isMarkedOK && (!rowPartialRequirements || allReqSentencesMarked) ?\r\n                                    \" markedGreen\" :\r\n                                    markedRed ?\r\n                                        \" markedRed\" :\r\n                                        \"\"), onClick: markMode && requirement ?\r\n                                function () { return _this.onRequirementChanged(requirement, isMarkedOK, partialValues, allReqSentencesMarked); } :\r\n                                undefined, title: getMigrationTitle(isMigrated, markMode) });\r\n                })),\r\n                explainedRequirements && React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var partialSentences = requirement && partialRequirments && partialRequirments[requirement.id] && getSavedSentences(partialRequirments[requirement.id]);\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0 || partialSentences && partialSentences.length > 0;\r\n                    return React.createElement(\"td\", { key: j }, isMarkedOK ? React.createElement(\"textarea\", { placeholder: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Beskrivning av kravet\"], [\"Beskrivning av kravet\"]))), className: \"inputTextBox inputTextLarge\", style: { width: \"100%\" }, readOnly: !markMode, value: (requirement && explainedRequirements[requirement.id]) || \"\", onChange: requirement && onExplainedRequirementsChanged && (function (ev) { return onExplainedRequirementsChanged(requirement.id, ev.target.value); }) }) : undefined);\r\n                }))); })));\r\n        { /*return <div>\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th>E</th>\r\n                <th>C</th>\r\n                <th>A</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {tbody.map((row, i) =>\r\n              <tr key={i}>{row.map((cell, j) => {\r\n                const isMarkedOK = props.markedIds && props.markedIds.indexOf(cell.id) >= 0;\r\n                const isMarkedNotOK = props.idsToMarkNotOk && props.idsToMarkNotOk[cell.id];\r\n                return <td\r\n                  key={j}\r\n                  rowSpan={cell.rowSpan}\r\n                  className={(props.markMode ? \"selectable\" : \"\") +\r\n                    (isMarkedOK ?\r\n                      \" markedGreen\" :\r\n                      (isMarkedNotOK ?\r\n                        \" markedRed\":\r\n                        \"\"))}\r\n                  onClick={props.markMode && (()=>props.onMarkChanged(cell.id, !isMarkedOK))}>\r\n                  {cell.html && <div style={{position: 'relative'}}>\r\n                    <p\r\n                      className={cell.type === 'ability' ? 'abilityText' : 'criteriaText'}\r\n                      dangerouslySetInnerHTML={{__html: cell.html}} />\r\n                    {props.editMode && <RemoveItem className=\"upperRight\" onClick={()=>\r\n                      this.setCellIds(\r\n                        cell.type,\r\n                        cell.rowIndex,\r\n                        this.getCellIds(\r\n                          cell.type,\r\n                          cell.rowIndex).filter(id => id != cell.id) )} /> }\r\n                  </div>}\r\n                </td>})}\r\n              </tr>)}\r\n            </tbody>\r\n          </table>\r\n        </div>*/\r\n        }\r\n    };\r\n    return KnowledgeMatrix;\r\n}(React.Component));\r\nexport { KnowledgeMatrix };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\n;\r\nexport var RemoveItem = function (_a) {\r\n    var onClick = _a.onClick, className = _a.className, style = _a.style, title = _a.title;\r\n    return React.createElement(\"div\", { title: title || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Radera\"], [\"Radera\"]))), className: \"removeItem \" + (className || \"\"), onClick: onClick, style: style });\r\n};\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from \"../../utility-components/open-close-box\";\r\nimport { arrayToLookup } from '../../../utils/utils';\r\nvar SelectRelatedDocs = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SelectRelatedDocs, _super);\r\n    function SelectRelatedDocs(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    SelectRelatedDocs.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, options = _a.options, title = _a.title, markedIds = _a.markedIds, markMode = _a.markMode, migratedIds = _a.migratedIds, uncoveredIds = _a.uncoveredIds;\r\n        var groupedOptions = arrayToLookup(options, function (d) { return d.group || \"default\"; });\r\n        var groups = Object.keys(groupedOptions);\r\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: \"larger\" }, groups.map(function (group) { return React.createElement(React.Fragment, { key: group },\r\n            groups.length === 1 ? null : React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"h5\", null, group),\r\n                React.createElement(\"hr\", null)),\r\n            groupedOptions[group].map(function (option) {\r\n                var isMarked = markedIds.some(function (x) { return x === option.id; });\r\n                var isMigrated = migratedIds && !!migratedIds[option.id];\r\n                var isUncovered = uncoveredIds && uncoveredIds[option.id];\r\n                return React.createElement(\"div\", { className: \"align-horizontal\", key: option.id, onClick: function () {\r\n                        return markMode && _this.props.onMarkChanged(option.id, !isMarked);\r\n                    } },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" +\r\n                            (markMode ? \" selectable\" : \"\") +\r\n                            (isMarked ? \" markedGreen\" : (isUncovered ?\r\n                                \" markedRed\" :\r\n                                \"\")) +\r\n                            (isMigrated ? \" migrated\" : \"\"), title: isMigrated ?\r\n                            markMode ?\r\n                                \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n                                \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n                            undefined },\r\n                        React.createElement(\"p\", { dangerouslySetInnerHTML: { __html: option.name } }),\r\n                        React.createElement(\"br\", null)));\r\n            })); }));\r\n    };\r\n    return SelectRelatedDocs;\r\n}(React.Component));\r\nexport { SelectRelatedDocs };\r\n","import * as React from 'react';\r\nexport var Spinner = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? \"\" : _b;\r\n    return React.createElement(\"span\", null,\r\n        React.createElement(\"i\", { className: \"fa fa-spinner fa-spin\", \"aria-hidden\": \"true\" }),\r\n        \"\\u00A0\",\r\n        label);\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../../../../globals/KED.env';\r\nimport { migrateSubject } from './migrate-subject';\r\nimport { loadCourse } from '../../utils';\r\nexport function diffXmlWithDatabase(existingSubject, subjectToImport, changes) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var expandedCourseTemplates, courseSets;\r\n        var _this = this;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', existingSubject.id, { include: [\"courseTemplates\", \"abilities\"] })];\r\n                case 1:\r\n                    // Expand graphs of existing Subject\r\n                    existingSubject = _a.sent();\r\n                    return [4 /*yield*/, Promise.all(existingSubject.courseTemplates.map(function (ct) { return loadCourse(ct.id, {\r\n                            include: [\r\n                                'centralContent',\r\n                                'knowledgeRequirements'\r\n                            ]\r\n                        }); }))];\r\n                case 2:\r\n                    expandedCourseTemplates = _a.sent();\r\n                    console.log(\"Subject: \" + existingSubject.name + \". Courses: \" + expandedCourseTemplates.map(function (_a) {\r\n                        var name = _a.name;\r\n                        return name;\r\n                    }));\r\n                    return [4 /*yield*/, Promise.all(expandedCourseTemplates.map(function (courseTemplate) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var _a;\r\n                            return tslib_1.__generator(this, function (_b) {\r\n                                switch (_b.label) {\r\n                                    case 0:\r\n                                        _a = {\r\n                                            template: courseTemplate\r\n                                        };\r\n                                        return [4 /*yield*/, env.kedBackendClient.list(\"courses\", { name: courseTemplate.name, include: ['abilities'], flags: ['includeIdsOnly'] })];\r\n                                    case 1: return [2 /*return*/, (_a.instances = _b.sent(),\r\n                                            _a)];\r\n                                }\r\n                            });\r\n                        }); }))];\r\n                case 3:\r\n                    courseSets = _a.sent();\r\n                    /*if (expandedCourseTemplates.some (course => !course.centralContentOrder || !course.knowledgeRequirementsOrder || !course.abilitiesOrder)) {\r\n                      migrateOrderListsOfCourseInstances(courseSets, subjectToImport, changes);\r\n                      // In future, as abilities may be added or removed, we will have to maintain the order of abilities on the course instances,\r\n                      // the same way we do it with central content and knowledge requirements. TODO respect abilities order on every place abilities are enumerated,\r\n                      // such as on course viewer, course builder, etc.\r\n                      migrateAbilitiesOrderOnSubject(existingSubject, courseSets, changes);\r\n                    } else {*/\r\n                    return [4 /*yield*/, migrateSubject(existingSubject, courseSets, subjectToImport, changes)];\r\n                case 4:\r\n                    /*if (expandedCourseTemplates.some (course => !course.centralContentOrder || !course.knowledgeRequirementsOrder || !course.abilitiesOrder)) {\r\n                      migrateOrderListsOfCourseInstances(courseSets, subjectToImport, changes);\r\n                      // In future, as abilities may be added or removed, we will have to maintain the order of abilities on the course instances,\r\n                      // the same way we do it with central content and knowledge requirements. TODO respect abilities order on every place abilities are enumerated,\r\n                      // such as on course viewer, course builder, etc.\r\n                      migrateAbilitiesOrderOnSubject(existingSubject, courseSets, changes);\r\n                    } else {*/\r\n                    _a.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { flatten } from '../../../../utils/utils';\r\nimport env from '../../../../globals/KED.env';\r\nfunction diffSubjectGlobalTexts(dbTextMap, xmlTexts) {\r\n    var e_1, _a;\r\n    var removedIds = new Set();\r\n    var newTexts = new Map();\r\n    var idsToAdd = new Set();\r\n    xmlTexts.forEach(function (newText) {\r\n        newText = newText.trim();\r\n        if (!dbTextMap.has(newText)) {\r\n            var id = createUUID();\r\n            console.log(\"New id: \" + id + \". Text: \" + newText);\r\n            newTexts.set(newText, id);\r\n            idsToAdd.add(id);\r\n        }\r\n        else {\r\n            newTexts.set(newText, dbTextMap.get(newText));\r\n        }\r\n    });\r\n    try {\r\n        for (var _b = tslib_1.__values(dbTextMap.entries()), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n            var _d = tslib_1.__read(_c.value, 2), oldText = _d[0], oldId = _d[1];\r\n            if (xmlTexts.indexOf(oldText) === -1) {\r\n                removedIds.add(oldId);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return {\r\n        removedIds: removedIds,\r\n        newTexts: newTexts,\r\n        idsToAdd: idsToAdd\r\n    };\r\n}\r\nvar _fictiveOldId = 1;\r\nfunction fictiveOldId() {\r\n    return \"fictiveOldId\" + (++_fictiveOldId);\r\n}\r\nvar stopWords = new Set(\r\n// From https://github.com/MihaiValentin/lunr-languages/blob/master/lunr.sv.js#L252\r\n('alla allt att av blev bli blir blivit de dem den denna deras dess dessa det detta dig din dina ditt du där då efter ej eller en er era ert ett från för ha hade han hans har henne hennes hon honom hur här i icke ingen inom inte jag ju kan kunde man med mellan men mig min mina mitt mot mycket ni nu när någon något några och om oss på samma sedan sig sin sina sitta själv skulle som så sådan sådana sådant till under upp ut utan vad var vara varför varit varje vars vart vem vi vid vilka vilkas vilken vilket vår våra vårt än är åt över' +\r\n    ' kring') // This line contains additional stop-words missing in lunr.sv.\r\n    .split(' '));\r\nfunction getLexemes(html) {\r\n    return new Set(removeTags(html).replace(/[^\\w\\såäö]/gi, '').toLowerCase().split(/\\s/)\r\n        .map(function (lexeme) { return lexeme.trim(); })\r\n        .filter(function (lexeme) { return !!lexeme; })\r\n        .filter(function (lexeme) { return !stopWords.has(lexeme); }));\r\n}\r\nfunction removeTags(html) {\r\n    var div = document.createElement('div');\r\n    div.innerHTML = html;\r\n    return '' + div.innerText;\r\n}\r\nfunction getIdsToMigrate(dbTexts, xmlTexts, newTexts, textType, course) {\r\n    var idsToMigrate = new Map();\r\n    dbTexts = dbTexts.map(function (entity) { return (tslib_1.__assign({}, entity, { name: entity.name.trim() })); }).filter(function (_a) {\r\n        var name = _a.name;\r\n        return !!name;\r\n    });\r\n    var xmlSet = new Map();\r\n    xmlTexts.forEach(function (item) { return xmlSet.set(item.html, item); });\r\n    var dbSet = new Map();\r\n    dbTexts.forEach(function (entity) { return dbSet.set(entity.name, entity); });\r\n    // Remove those who already exists identically\r\n    dbTexts = dbTexts.filter(function (entity) { return !xmlSet.has(entity.name); });\r\n    xmlTexts = xmlTexts.filter(function (item) { return !dbSet.has(item.html); });\r\n    // Now, for the remainder, try the best to map old texts to new texts, and when done, check if there are new texts that never got mapped.\r\n    // Start by putting all dbText into the result, without a paired xml text yet:\r\n    dbTexts.forEach(function (dbText) { return idsToMigrate.set(dbText.id, {\r\n        gradeStep: dbText.gradeStep,\r\n        oldText: dbText.name,\r\n        lexemes: getLexemes(dbText.name),\r\n        matchLevel: 0\r\n    }); });\r\n    // Then try to pair each xmlText to an item in idsToMigrate\r\n    var xmlSpinsters = [];\r\n    while (xmlTexts.length > 0) {\r\n        var xmlText = xmlTexts[0];\r\n        var bestMatch = findBestMatch(xmlText);\r\n        if (!bestMatch) {\r\n            xmlSpinsters.push(xmlText);\r\n        }\r\n        else {\r\n            if (bestMatch.newText) {\r\n                // Throw out existing match\r\n                xmlTexts.push({ html: bestMatch.newText, gradeStep: bestMatch.gradeStep });\r\n            }\r\n            var pair = idsToMigrate.get(bestMatch.id);\r\n            // Pair myself with this match:\r\n            pair.newText = xmlText.html;\r\n            pair.matchLevel = bestMatch.myMatchLevel;\r\n            pair.newId = newTexts.get(xmlText.html);\r\n        }\r\n        xmlTexts.shift();\r\n    }\r\n    // For each spinster (new texts that couldn't find any match in old texts),\r\n    // Add them with an fictive old ID but omit oldText to mark it as a newcomer\r\n    xmlSpinsters.forEach(function (spinster) {\r\n        idsToMigrate.set(fictiveOldId(), {\r\n            newId: newTexts.get(spinster.html),\r\n            newText: spinster.html,\r\n            gradeStep: spinster.gradeStep,\r\n            matchLevel: 0,\r\n            lexemes: new Set()\r\n        });\r\n    });\r\n    // Mark typo-fixes\r\n    idsToMigrate.forEach(function (match) {\r\n        var oldText = match.oldText, newText = match.newText;\r\n        if (oldText && newText) {\r\n            if (tslib_1.__spread(getLexemes(oldText)).join(' ') === tslib_1.__spread(getLexemes(newText)).join(' ')) {\r\n                match.isTypoFix = true;\r\n            }\r\n        }\r\n    });\r\n    console.log(\"IdsToMigrate\", tslib_1.__spread(idsToMigrate.values()).map(function (_a) {\r\n        var oldText = _a.oldText, lexemes = _a.lexemes;\r\n        return tslib_1.__spread(lexemes).join(' ') + \": \" + oldText;\r\n    }));\r\n    return idsToMigrate;\r\n    function findBestMatch(xmlText) {\r\n        var xmlLexemes = getLexemes(xmlText.html);\r\n        var possiblePartners = tslib_1.__spread(idsToMigrate.entries()).filter(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), id = _b[0], x = _b[1];\r\n            return x.gradeStep === xmlText.gradeStep;\r\n        })\r\n            .map(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), id = _b[0], _c = _b[1], gradeStep = _c.gradeStep, matchLevel = _c.matchLevel, newText = _c.newText, lexemes = _c.lexemes;\r\n            return ({\r\n                id: id,\r\n                gradeStep: gradeStep,\r\n                matchLevel: matchLevel,\r\n                newText: newText,\r\n                myMatchLevel: getMatchLevel(xmlLexemes, lexemes)\r\n            });\r\n        }).filter(function (pp) { return pp.myMatchLevel >= 50 && (!pp.matchLevel || pp.matchLevel < pp.myMatchLevel); });\r\n        return possiblePartners.sort(function (a, b) { return b.myMatchLevel - a.myMatchLevel; })[0]; // highest first.\r\n    }\r\n    function getMatchLevel(lexemes1, lexemes2) {\r\n        if (lexemes1.size === 0 || lexemes2.size === 0)\r\n            return 0;\r\n        var points1 = 0;\r\n        var points2 = 0;\r\n        lexemes1.forEach(function (word) {\r\n            if (lexemes2.has(word))\r\n                ++points1;\r\n        });\r\n        lexemes2.forEach(function (word) {\r\n            if (lexemes1.has(word))\r\n                ++points2;\r\n        });\r\n        return Math.round(100 * Math.max(points1 / lexemes1.size, points2 / lexemes2.size));\r\n    }\r\n    /*if (dbTexts.length !== xmlTexts.length) {\r\n      // We can no longer assume that the changed texts refer to different formulations of the same meaning.\r\n      // We not map old formulations to new ones.\r\n      // In future, we could handle this case by assuming all old texts not occurring in new data, have been removed and all new have been added.\r\n      throw new Error(\"Number of \" + textType + (course ? ` on course ${course}` : \"\") + \" differs. Cannot migrate.\");\r\n    }\r\n    dbTexts.forEach(({name: oldText, id: oldId, gradeStep}, i) => {\r\n      const xmlText = xmlTexts[i].trim();\r\n      if (oldText.trim() !== xmlText) {\r\n        idsToMigrate.set(oldId, {newText: xmlText, newId: newTexts.get(xmlText), oldText, gradeStep});\r\n      }\r\n    });\r\n    return idsToMigrate;*/\r\n}\r\nexport function migrateSubject(existingSubject, courseSets, subjectToImport, changes) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        function migrateCourseInstance(course, courseToImport, idsToMigrate) {\r\n            var showChanges = !shownChanges.has(course.name);\r\n            shownChanges.add(course.name);\r\n            abilityIdsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, oldText = _a.oldText;\r\n                // Relink the course instance with abilities. This change does not need to be visible in GUI.\r\n                changes.push({\r\n                    mutations: function (br) {\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"abilities\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"abilities\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.abilitiesOrder = subjectToImport.abilities.map(function (html) { return newAbilityTexts.get(html); });\r\n            var ccsToMigrate = idsToMigrate.ccsToMigrate, krsToMigrate = idsToMigrate.krsToMigrate;\r\n            // Central Content\r\n            ccsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, newText = _a.newText, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                changes.push({\r\n                    change: showChanges && (oldText ?\r\n                        newText ?\r\n                            isTypoFix ?\r\n                                \"Tryckfelsr\\u00E4ttning Centralt Inneh\\u00E5ll\" :\r\n                                \"Uppdaterat Centralt Inneh\\u00E5ll\" :\r\n                            \"Borttaget Centralt Inneh\\u00E5ll\" :\r\n                        \"Nytt Centralt Inneh\\u00E5ll\"),\r\n                    content: \"<h4>\" + course.name + \"</h4><strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                    mutations: function (br) {\r\n                        if (newId && ccsToAdd.has(newId) && !createdIds.has(newId)) {\r\n                            var cc = {\r\n                                id: newId,\r\n                                name: newText,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: Date.now()\r\n                            };\r\n                            br.add(\"central-content\", cc);\r\n                            createdIds.add(newId);\r\n                        }\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"centralContent\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"centralContent\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.centralContentOrder = courseToImport.centralContent.map(function (_a) {\r\n                var html = _a.html;\r\n                return newCCTexts.get(html);\r\n            });\r\n            // Knowledge Requirements\r\n            krsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, newText = _a.newText, gradeStep = _a.gradeStep, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                changes.push({\r\n                    change: showChanges && (oldText ?\r\n                        newText ?\r\n                            isTypoFix ?\r\n                                \"Tryckfelsr\\u00E4ttning Kunskapskrav\" :\r\n                                \"Uppdaterat Kunskapskrav\" :\r\n                            \"Borttaget Kunskapskrav\" :\r\n                        \"Nytt Kunskapskrav\"),\r\n                    content: \"<h4>\" + course.name + \"</h4><strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                    mutations: function (br) {\r\n                        if (newId && krsToAdd.has(newId) && !createdIds.has(newId)) {\r\n                            var kr = {\r\n                                id: newId,\r\n                                name: newText,\r\n                                gradeStep: gradeStep,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: Date.now()\r\n                            };\r\n                            console.log(\"Adding Knowledge-Requirement \" + newId + \": \" + newText);\r\n                            br.add(\"knowledge-requirements\", kr);\r\n                            createdIds.add(newId);\r\n                        }\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"knowledgeRequirements\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"knowledgeRequirements\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.knowledgeRequirementsOrder =\r\n                courseToImport.knowledgeRequirements.map(function (kr) { return newKRTexts.get(kr.html); });\r\n            // Updates the course properties centralContentOrder and knowledgeRequirementsOrder\r\n            if (abilityIdsToMigrate.size > 0 || ccsToMigrate.size > 0 || krsToMigrate.size > 0) {\r\n                changes.push({\r\n                    change: !course.isTemplate ? \"Uppdaterad Kursinstans\" : \"Uppdaterad Kursmall\",\r\n                    content: !course.isTemplate ?\r\n                        course.name + \". Skola: \" + (course.school || \"ej angiven\") + \". Beskrivning: \" + (course.description || '') :\r\n                        \"\" + course.name,\r\n                    mutations: function (br) { return br.put(\"courses\", course); }\r\n                });\r\n            }\r\n        }\r\n        // Tasks:\r\n        // 1. ASYNC OPERATION: Go through all tasks that has edges to any of the old ids.\r\n        // 2. For each found task, do:\r\n        //    A: Iterate tags starting with \"course:\". Pick the course code.\r\n        //    B: Populate the new property migrationTasks: {\r\n        //         abilities: {[newId: string]: {oldText: string, oldId: string, importDate: number}}, // Be able to create a chain in the GUI !\r\n        //         centralContent: {[newId: string]: {oldText: string, ...\"...}},\r\n        //         knowledgeRequirements: {[newId: string]: {oldText: string, ...\"...}},\r\n        //       }\r\n        //       OBS1! Mergea abilities, centralCondent och knowledgeRequirements med ev tidigare värden (så man kan importera om och om igen!)\r\n        //       OBS2! oldId kan förekomma på flera newId om task används av flera kurser. \r\n        //    C: Create sets for unlinks and link operations per type.\r\n        //    D: For all courseCodes that the task is taggen on,\r\n        //         * register ccsToMigrate.keys() in the unlink set of central contents\r\n        //         * register ccsToMigrate.values() in the link set of central contents\r\n        //         * --\"-- for knowledgeRequirements\r\n        //    E: unlink and link with regards to abilityIdsToMigrate (keys() and values() respectively).\r\n        //    F: unlink and link according to the created sets of link / unlink operations.\r\n        //    Note: Unlike course instances, there's no order property to take care of here!\r\n        //\r\n        function migrateTasks() {\r\n            return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                function fetchTasksInChunksWithEdgesTo(ids, options) {\r\n                    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                        var result;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    // This function should make work around the case when given \"ids\" contains too many items, by\r\n                                    // dividing the requests into several and merge the result using a Map.\r\n                                    if (ids.length === 0)\r\n                                        return [2 /*return*/, []]; // Otherwise we'll request every task in the system.\r\n                                    result = new Map();\r\n                                    console.log(\"Number of ids: \" + ids.length);\r\n                                    return [4 /*yield*/, env.kedBackendClient.list(\"tasks\", tslib_1.__assign({}, options, { hasEdgesTo: ids }))];\r\n                                case 1: \r\n                                //return result.values();\r\n                                return [2 /*return*/, _a.sent()];\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                var oldIds, importDate, tasks, _loop_2, tasks_1, tasks_1_1, task;\r\n                var e_7, _a;\r\n                return tslib_1.__generator(this, function (_b) {\r\n                    switch (_b.label) {\r\n                        case 0:\r\n                            oldIds = tslib_1.__spread(abilityIdsToMigrate.keys(), flatten(idsToMigratePerCourse.map(function (c) { return tslib_1.__spread(c.ccsToMigrate.keys(), c.krsToMigrate.keys()); }))).filter(function (id) { return !id.startsWith('fictiveOldId'); });\r\n                            importDate = Date.now();\r\n                            return [4 /*yield*/, fetchTasksInChunksWithEdgesTo(oldIds, {\r\n                                    include: [\"abilities\", \"knowledgeRequirements\", \"centralContent\"],\r\n                                    flags: [\"includeIdsOnly\"]\r\n                                })];\r\n                        case 1:\r\n                            tasks = _b.sent();\r\n                            _loop_2 = function (task) {\r\n                                var e_8, _a, e_9, _b, e_10, _c, e_11, _d;\r\n                                var oldMT = task.migratedTexts || {\r\n                                    abilities: {},\r\n                                    centralContent: {},\r\n                                    knowledgeRequirements: {}\r\n                                };\r\n                                task.migratedTexts = {\r\n                                    abilities: {},\r\n                                    centralContent: {},\r\n                                    knowledgeRequirements: {}\r\n                                };\r\n                                var mutations = [];\r\n                                var changeDescriptions = [];\r\n                                var _loop_3 = function (id) {\r\n                                    var migrationInfo = abilityIdsToMigrate.get(id);\r\n                                    if (migrationInfo) {\r\n                                        var newId_1 = migrationInfo.newId, newText = migrationInfo.newText, isTypoFix = migrationInfo.isTypoFix;\r\n                                        var oldText = migrationInfo.oldText;\r\n                                        var oldId = id;\r\n                                        if (oldMT.abilities[id]) {\r\n                                            // If migrating stuff that was never acknowledges by a teacher,\r\n                                            // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                            oldText = oldMT.abilities[id].oldText;\r\n                                            oldId = oldMT.abilities[id].oldId;\r\n                                        }\r\n                                        if (newId_1 && oldText !== newText) {\r\n                                            // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                            if (!isTypoFix) {\r\n                                                // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                task.migratedTexts.abilities[newId_1] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                            }\r\n                                        }\r\n                                        mutations.push(function (br) {\r\n                                            br.unlink2(\"tasks\", task.id, \"abilities\", id);\r\n                                            if (newId_1)\r\n                                                br.link2(\"tasks\", task.id, \"abilities\", newId_1);\r\n                                        });\r\n                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                        if (newId_1) {\r\n                                            changeDescriptions.push(newText);\r\n                                        }\r\n                                    }\r\n                                };\r\n                                try {\r\n                                    for (var _e = (e_8 = void 0, tslib_1.__values(task.abilities)), _f = _e.next(); !_f.done; _f = _e.next()) {\r\n                                        var id = _f.value.id;\r\n                                        _loop_3(id);\r\n                                    }\r\n                                }\r\n                                catch (e_8_1) { e_8 = { error: e_8_1 }; }\r\n                                finally {\r\n                                    try {\r\n                                        if (_f && !_f.done && (_a = _e.return)) _a.call(_e);\r\n                                    }\r\n                                    finally { if (e_8) throw e_8.error; }\r\n                                }\r\n                                var taskCourseCodes = new Set(task.tags ?\r\n                                    task.tags.filter(function (t) { return t.startsWith('course:'); }).map(function (t) { return t.substr(\"course:\".length); }) :\r\n                                    []);\r\n                                // We need to keep track of linkedIds (for this particular task) for the following reason:\r\n                                // Let's say the task was referred to by two different courses (possible in old versions),\r\n                                // and in old Central Content, the two courses did have slightly different formulations of central content,\r\n                                // so the task was mapped to both of them. Then, in new XML, the same central content was formulated\r\n                                // in a new way that is identical this time between the two courses. Then both old IDs will be replaced\r\n                                // by a single new ID. It would then be unnescessary to link to the new ID twice.\r\n                                var linkedIds = new Set();\r\n                                try {\r\n                                    for (var idsToMigratePerCourse_1 = (e_9 = void 0, tslib_1.__values(idsToMigratePerCourse)), idsToMigratePerCourse_1_1 = idsToMigratePerCourse_1.next(); !idsToMigratePerCourse_1_1.done; idsToMigratePerCourse_1_1 = idsToMigratePerCourse_1.next()) {\r\n                                        var _g = idsToMigratePerCourse_1_1.value, krsToMigrate = _g.krsToMigrate, ccsToMigrate = _g.ccsToMigrate, courseCode = _g.courseCode;\r\n                                        if (taskCourseCodes.size === 0 || taskCourseCodes.has(courseCode)) {\r\n                                            var _loop_4 = function (id) {\r\n                                                var migrationInfo = ccsToMigrate.get(id);\r\n                                                if (migrationInfo) {\r\n                                                    var newId_2 = migrationInfo.newId, newText = migrationInfo.newText, oldText = migrationInfo.oldText, isTypoFix = migrationInfo.isTypoFix;\r\n                                                    var oldId = id;\r\n                                                    if (oldMT.centralContent[id]) {\r\n                                                        // If migrating stuff that was never acknowledges by a teacher,\r\n                                                        // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                                        oldText = oldMT.centralContent[id].oldText;\r\n                                                        oldId = oldMT.centralContent[id].oldId;\r\n                                                    }\r\n                                                    if (newId_2 && oldText !== newText) {\r\n                                                        // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                                        if (!isTypoFix) {\r\n                                                            // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                            task.migratedTexts.centralContent[newId_2] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                                        }\r\n                                                    }\r\n                                                    if (!newId_2 || !linkedIds.has(newId_2)) {\r\n                                                        mutations.push(function (br) {\r\n                                                            br.unlink2(\"tasks\", task.id, \"centralContent\", id);\r\n                                                            if (newId_2)\r\n                                                                br.link2(\"tasks\", task.id, \"centralContent\", newId_2);\r\n                                                        });\r\n                                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                                        if (newId_2) {\r\n                                                            changeDescriptions.push(newText);\r\n                                                            linkedIds.add(newId_2);\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            };\r\n                                            try {\r\n                                                for (var _h = (e_10 = void 0, tslib_1.__values(task.centralContent)), _j = _h.next(); !_j.done; _j = _h.next()) {\r\n                                                    var id = _j.value.id;\r\n                                                    _loop_4(id);\r\n                                                }\r\n                                            }\r\n                                            catch (e_10_1) { e_10 = { error: e_10_1 }; }\r\n                                            finally {\r\n                                                try {\r\n                                                    if (_j && !_j.done && (_c = _h.return)) _c.call(_h);\r\n                                                }\r\n                                                finally { if (e_10) throw e_10.error; }\r\n                                            }\r\n                                            var _loop_5 = function (id) {\r\n                                                var migrationInfo = krsToMigrate.get(id);\r\n                                                if (migrationInfo) {\r\n                                                    var newId_3 = migrationInfo.newId, newText = migrationInfo.newText, oldText = migrationInfo.oldText, isTypoFix = migrationInfo.isTypoFix;\r\n                                                    var oldId = id;\r\n                                                    if (oldMT.knowledgeRequirements[id]) {\r\n                                                        // If migrating stuff that was never acknowledges by a teacher,\r\n                                                        // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                                        oldText = oldMT.knowledgeRequirements[id].oldText;\r\n                                                        oldId = oldMT.knowledgeRequirements[id].oldId;\r\n                                                    }\r\n                                                    if (newId_3 && oldText !== newText) {\r\n                                                        // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                                        if (!isTypoFix) {\r\n                                                            // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                            task.migratedTexts.knowledgeRequirements[newId_3] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                                        }\r\n                                                    }\r\n                                                    if (!newId_3 || !linkedIds.has(newId_3)) {\r\n                                                        mutations.push(function (br) {\r\n                                                            br.unlink2(\"tasks\", task.id, \"knowledgeRequirements\", id);\r\n                                                            if (newId_3)\r\n                                                                br.link2(\"tasks\", task.id, \"knowledgeRequirements\", newId_3);\r\n                                                        });\r\n                                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                                        if (newId_3) {\r\n                                                            changeDescriptions.push(newText);\r\n                                                            linkedIds.add(newId_3);\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            };\r\n                                            try {\r\n                                                for (var _k = (e_11 = void 0, tslib_1.__values(task.knowledgeRequirements)), _l = _k.next(); !_l.done; _l = _k.next()) {\r\n                                                    var id = _l.value.id;\r\n                                                    _loop_5(id);\r\n                                                }\r\n                                            }\r\n                                            catch (e_11_1) { e_11 = { error: e_11_1 }; }\r\n                                            finally {\r\n                                                try {\r\n                                                    if (_l && !_l.done && (_d = _k.return)) _d.call(_k);\r\n                                                }\r\n                                                finally { if (e_11) throw e_11.error; }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                                catch (e_9_1) { e_9 = { error: e_9_1 }; }\r\n                                finally {\r\n                                    try {\r\n                                        if (idsToMigratePerCourse_1_1 && !idsToMigratePerCourse_1_1.done && (_b = idsToMigratePerCourse_1.return)) _b.call(idsToMigratePerCourse_1);\r\n                                    }\r\n                                    finally { if (e_9) throw e_9.error; }\r\n                                }\r\n                                changes.push({\r\n                                    change: \"Migrerad Uppgift\",\r\n                                    content: \"<h4>\" + task.name + \" \" + (task.school ? \"(\" + task.school + \") \" : '(skola ej angiven)') + \"</h4>\\n          <p>Kurskod: \" + tslib_1.__spread(taskCourseCodes).join(',') + \"</p>\\n          \" + changeDescriptions.map(function (txt) { return \"<p>\" + txt + \"</p>\"; }).join(''),\r\n                                    mutations: function (br) {\r\n                                        br.put(\"tasks\", task);\r\n                                        mutations.forEach(function (m) { return m(br); });\r\n                                    }\r\n                                });\r\n                            };\r\n                            try {\r\n                                /*const tasks = await env.kedBackendClient.list<Task>(\"tasks\", {\r\n                                  hasEdgesTo: oldIds,\r\n                                  include: [\"abilities\", \"knowledgeRequirements\", \"centralContent\"],\r\n                                  flags: [\"includeIdsOnly\"]\r\n                                });*/\r\n                                for (tasks_1 = tslib_1.__values(tasks), tasks_1_1 = tasks_1.next(); !tasks_1_1.done; tasks_1_1 = tasks_1.next()) {\r\n                                    task = tasks_1_1.value;\r\n                                    _loop_2(task);\r\n                                }\r\n                            }\r\n                            catch (e_7_1) { e_7 = { error: e_7_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (tasks_1_1 && !tasks_1_1.done && (_a = tasks_1.return)) _a.call(tasks_1);\r\n                                }\r\n                                finally { if (e_7) throw e_7.error; }\r\n                            }\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        var dbTextMap, orderedAbilities, orderedAbilities_1, orderedAbilities_1_1, a, courseSets_1, courseSets_1_1, template, _a, _b, cc, _c, _d, kr, _e, newAbilityTexts, abilitiesToAdd, _f, newCCTexts, ccsToAdd, _g, newKRTexts, krsToAdd, abilityIdsToMigrate, idsToMigratePerCourse, createdIds, shownChanges, _loop_1, courseSets_2, courseSets_2_1, _h, template, instances;\r\n        var e_2, _j, e_3, _k, e_4, _l, e_5, _m, e_6, _o;\r\n        return tslib_1.__generator(this, function (_p) {\r\n            switch (_p.label) {\r\n                case 0:\r\n                    dbTextMap = new Map();\r\n                    orderedAbilities = existingSubject.abilitiesOrder ?\r\n                        existingSubject.abilitiesOrder.map(function (id) { return existingSubject.abilities.find(function (a) { return a.id === id; }); }) :\r\n                        existingSubject.abilities;\r\n                    try {\r\n                        for (orderedAbilities_1 = tslib_1.__values(orderedAbilities), orderedAbilities_1_1 = orderedAbilities_1.next(); !orderedAbilities_1_1.done; orderedAbilities_1_1 = orderedAbilities_1.next()) {\r\n                            a = orderedAbilities_1_1.value;\r\n                            dbTextMap.set(a.name.trim(), a.id);\r\n                        }\r\n                    }\r\n                    catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (orderedAbilities_1_1 && !orderedAbilities_1_1.done && (_j = orderedAbilities_1.return)) _j.call(orderedAbilities_1);\r\n                        }\r\n                        finally { if (e_2) throw e_2.error; }\r\n                    }\r\n                    try {\r\n                        for (courseSets_1 = tslib_1.__values(courseSets), courseSets_1_1 = courseSets_1.next(); !courseSets_1_1.done; courseSets_1_1 = courseSets_1.next()) {\r\n                            template = courseSets_1_1.value.template;\r\n                            try {\r\n                                for (_a = (e_4 = void 0, tslib_1.__values(template.centralContent)), _b = _a.next(); !_b.done; _b = _a.next()) {\r\n                                    cc = _b.value;\r\n                                    dbTextMap.set(cc.name.trim(), cc.id);\r\n                                }\r\n                            }\r\n                            catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_b && !_b.done && (_l = _a.return)) _l.call(_a);\r\n                                }\r\n                                finally { if (e_4) throw e_4.error; }\r\n                            }\r\n                            try {\r\n                                for (_c = (e_5 = void 0, tslib_1.__values(template.knowledgeRequirements)), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n                                    kr = _d.value;\r\n                                    dbTextMap.set(kr.name.trim(), kr.id);\r\n                                }\r\n                            }\r\n                            catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_d && !_d.done && (_m = _c.return)) _m.call(_c);\r\n                                }\r\n                                finally { if (e_5) throw e_5.error; }\r\n                            }\r\n                        }\r\n                    }\r\n                    catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (courseSets_1_1 && !courseSets_1_1.done && (_k = courseSets_1.return)) _k.call(courseSets_1);\r\n                        }\r\n                        finally { if (e_3) throw e_3.error; }\r\n                    }\r\n                    _e = diffSubjectGlobalTexts(dbTextMap, subjectToImport.abilities), newAbilityTexts = _e.newTexts, abilitiesToAdd = _e.idsToAdd;\r\n                    _f = diffSubjectGlobalTexts(dbTextMap, flatten(subjectToImport.courses.map(function (c) { return c.centralContent.map(function (cc) { return cc.html; }); }))), newCCTexts = _f.newTexts, ccsToAdd = _f.idsToAdd;\r\n                    _g = diffSubjectGlobalTexts(dbTextMap, flatten(subjectToImport.courses.map(function (c) { return c.knowledgeRequirements.map(function (kr) { return kr.html; }); }))), newKRTexts = _g.newTexts, krsToAdd = _g.idsToAdd;\r\n                    console.log(\"Abilities to add: \" + abilitiesToAdd.size);\r\n                    console.log(\"CCs to add: \" + ccsToAdd.size);\r\n                    console.log(\"KRs to add: \" + krsToAdd.size);\r\n                    abilityIdsToMigrate = getIdsToMigrate(orderedAbilities, subjectToImport.abilities.map(function (html) { return ({ html: html }); }), newAbilityTexts, \"abilities\");\r\n                    idsToMigratePerCourse = courseSets.map(function (_a, i) {\r\n                        var template = _a.template;\r\n                        console.log(\"Course: \" + template.name);\r\n                        var xmlCourse = subjectToImport.courses.find(function (c) { return c.name === template.name; }) ||\r\n                            subjectToImport.courses.find(function (c) { return c.code === template.code; });\r\n                        return {\r\n                            courseCode: template.code,\r\n                            ccsToMigrate: xmlCourse ?\r\n                                getIdsToMigrate(template.centralContent, // Has already been sorted when retrieved via loadCourse()\r\n                                xmlCourse.centralContent.map(function (_a) {\r\n                                    var html = _a.html;\r\n                                    return ({ html: html });\r\n                                }), newCCTexts, \"central content\", template.name) :\r\n                                new Map(),\r\n                            krsToMigrate: xmlCourse ?\r\n                                getIdsToMigrate(template.knowledgeRequirements, // Has already been sorted when retrieved via loadCourse()\r\n                                xmlCourse.knowledgeRequirements, newKRTexts, \"knowledge requirements\", template.name) :\r\n                                new Map()\r\n                        };\r\n                    });\r\n                    // OK so now we have all info.\r\n                    // Now, we need to:\r\n                    // Subject:\r\n                    // 1. Remove links from subjects to abilities\r\n                    // 2. Add links from subjects to abilities\r\n                    abilityIdsToMigrate.forEach(function (_a, oldId) {\r\n                        var newText = _a.newText, newId = _a.newId, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                        //const oldText = existingSubject.abilities.find(a => a.id === oldId).name;\r\n                        changes.push({\r\n                            change: (oldText ?\r\n                                newText ?\r\n                                    isTypoFix ?\r\n                                        \"Tryckfelsr\\u00E4ttning F\\u00F6rm\\u00E5ga\" :\r\n                                        \"Uppdaterad F\\u00F6rm\\u00E5ga\" :\r\n                                    \"Borttagen F\\u00F6rm\\u00E5ga\" :\r\n                                \"Ny F\\u00F6rm\\u00E5ga\"),\r\n                            content: \"<strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                            mutations: function (br) {\r\n                                if (newId && abilitiesToAdd.has(newId)) {\r\n                                    var a = {\r\n                                        id: newId,\r\n                                        name: newText,\r\n                                        acl: [\"role:USER:R\"],\r\n                                        dateTime: Date.now()\r\n                                    };\r\n                                    br.add(\"abilities\", a);\r\n                                }\r\n                                if (oldText)\r\n                                    br.unlink2(\"subjects\", existingSubject.id, \"abilities\", oldId);\r\n                                if (newId)\r\n                                    br.link2(\"subjects\", existingSubject.id, \"abilities\", newId);\r\n                            }\r\n                        });\r\n                    });\r\n                    // 3. Update abilitiesOrder on Subject based on subjectToImport.abilities (mapped to ids in newTexts)\r\n                    if (!existingSubject.abilitiesOrder || abilityIdsToMigrate.size > 0) {\r\n                        existingSubject.abilitiesOrder = subjectToImport.abilities.map(function (xml) { return newAbilityTexts.get(xml); });\r\n                        changes.push({\r\n                            mutations: function (br) { return br.put(\"subjects\", existingSubject); },\r\n                            change: existingSubject.abilitiesOrder ?\r\n                                null : // Ändringen redan visuell som \"Uppdaterad för förmåga\", etc, ovan\r\n                                \"Inf\\u00F6r en ordnad lista p\\u00E5 f\\u00F6rm\\u00E5gor i databasen\",\r\n                        });\r\n                    }\r\n                    createdIds = new Set();\r\n                    changes.push({ mutations: function () { return createdIds.clear(); } }); // In case mutations run twice (which it doesn't as of current impl.)\r\n                    shownChanges = new Set();\r\n                    changes.push({ mutations: function () { return shownChanges.clear(); } });\r\n                    _loop_1 = function (template, instances) {\r\n                        var e_12, _a;\r\n                        // Find courseToImport\r\n                        var courseToImport = (subjectToImport.courses.find(function (c) { return c.name === template.name; }) ||\r\n                            subjectToImport.courses.find(function (c) { return c.code === template.code; }));\r\n                        // Find Central Content and Knowledge Requirements to migrate\r\n                        var _b = idsToMigratePerCourse.find(function (x) { return x.courseCode === template.code; }), ccsToMigrate = _b.ccsToMigrate, krsToMigrate = _b.krsToMigrate;\r\n                        try {\r\n                            // Loop through all course instances (instances also contains templates)\r\n                            // and migrate them. This will include creating missing entities in the DB.\r\n                            for (var instances_1 = (e_12 = void 0, tslib_1.__values(instances)), instances_1_1 = instances_1.next(); !instances_1_1.done; instances_1_1 = instances_1.next()) {\r\n                                var course = instances_1_1.value;\r\n                                migrateCourseInstance(course, courseToImport, { ccsToMigrate: ccsToMigrate, krsToMigrate: krsToMigrate });\r\n                            }\r\n                        }\r\n                        catch (e_12_1) { e_12 = { error: e_12_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (instances_1_1 && !instances_1_1.done && (_a = instances_1.return)) _a.call(instances_1);\r\n                            }\r\n                            finally { if (e_12) throw e_12.error; }\r\n                        }\r\n                    };\r\n                    try {\r\n                        // Courses:\r\n                        // 1. Go through all course instances and:\r\n                        //      A: Remove links from courses to abilities listed in abilityIdsToMigrate.keys()\r\n                        //      B: Add links from courses to abilities abiltitiesToMigrate.values()\r\n                        //      C: Update abilitiesOrder on course instances based on subjectToImport (mapped to ids in newTexts)\r\n                        // 2, 3: Do the same for central-content and knowledge-requirementes:\r\n                        //    Find ccs and krs to migrate based on courseInstance.code\r\n                        //    For both ccs and krs, do:\r\n                        //      A: Unlink ccsToMigrate.keys()\r\n                        //      B: Link ccsToMigrate.values()\r\n                        //      C: Update centralContentOrder based on subjectToImport.centralContent mapped to newTexts ids\r\n                        //      (same for krsToMigrate, with knowledgeRequirementsOrder instead)\r\n                        for (courseSets_2 = tslib_1.__values(courseSets), courseSets_2_1 = courseSets_2.next(); !courseSets_2_1.done; courseSets_2_1 = courseSets_2.next()) {\r\n                            _h = courseSets_2_1.value, template = _h.template, instances = _h.instances;\r\n                            _loop_1(template, instances);\r\n                        }\r\n                    }\r\n                    catch (e_6_1) { e_6 = { error: e_6_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (courseSets_2_1 && !courseSets_2_1.done && (_o = courseSets_2.return)) _o.call(courseSets_2);\r\n                        }\r\n                        finally { if (e_6) throw e_6.error; }\r\n                    }\r\n                    return [4 /*yield*/, migrateTasks()];\r\n                case 1:\r\n                    _p.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nvar ShowSubjectInner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ShowSubjectInner, _super);\r\n    function ShowSubjectInner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { subject: null };\r\n        return _this;\r\n    }\r\n    ShowSubjectInner.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    ShowSubjectInner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subject;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', this.props.id, { include: 'courseTemplates' })];\r\n                    case 1:\r\n                        subject = _a.sent();\r\n                        this.setState({ subject: subject });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ShowSubjectInner.prototype.render = function () {\r\n        if (!this.state.subject)\r\n            return React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null));\r\n        var _a = this.state.subject, name = _a.name, code = _a.code, courseTemplates = _a.courseTemplates, schoolType = _a.schoolType;\r\n        return React.createElement(\"div\", null, schoolType === 'primary' ? React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null,\r\n                \"Grundskole\\u00E4mnet \",\r\n                name,\r\n                \" (\",\r\n                code,\r\n                \")\"),\r\n            React.createElement(\"ul\", { className: \"entity-list\" }, courseTemplates.map(function (_a) {\r\n                var id = _a.id, code = _a.code, publishable = _a.publishable, points = _a.points, schoolGrade = _a.schoolGrade;\r\n                return React.createElement(\"li\", { key: id, className: \"complete\" },\r\n                    name,\r\n                    \" f\\u00F6r \\u00E5rskurs \",\r\n                    schoolGrade);\r\n            }))) : React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null,\r\n                \"Kurser f\\u00F6r \\u00E4mnet \",\r\n                name,\r\n                \" (\",\r\n                code,\r\n                \")\"),\r\n            React.createElement(\"ul\", { className: \"entity-list\" }, courseTemplates.map(function (_a) {\r\n                var id = _a.id, name = _a.name, code = _a.code, publishable = _a.publishable, points = _a.points;\r\n                return React.createElement(\"li\", { key: id, className: \"complete\" },\r\n                    name,\r\n                    \" - \",\r\n                    points,\r\n                    \"p\");\r\n            }))));\r\n    };\r\n    return ShowSubjectInner;\r\n}(React.Component));\r\nexport { ShowSubjectInner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nimport { ShowSubjectInner } from './show-subject-inner';\r\nvar ShowSubject = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ShowSubject, _super);\r\n    function ShowSubject(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { subject: null };\r\n        return _this;\r\n    }\r\n    ShowSubject.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    ShowSubject.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subject;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', this.props.id, { include: 'courseTemplates' })];\r\n                    case 1:\r\n                        subject = _a.sent();\r\n                        this.setState({ subject: subject });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ShowSubject.prototype.render = function () {\r\n        if (!this.state.subject)\r\n            return React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null));\r\n        var _a = this.state.subject, name = _a.name, code = _a.code, courseTemplates = _a.courseTemplates, schoolType = _a.schoolType;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(CourseBanner, { title: name, activePage: \"subjects\", routes: { feedback: this.props.feedbackUrl } }),\r\n            React.createElement(ShowSubjectInner, { id: this.props.id }));\r\n    };\r\n    return ShowSubject;\r\n}(React.Component));\r\nexport { ShowSubject };\r\n","export function parseSkolverketYears(inYear) {\r\n    switch (inYear.trim()) {\r\n        case '3':\r\n        case '1-3':\r\n            return ['1-3'];\r\n        case '6':\r\n        case '4-6':\r\n            return ['4-6'];\r\n        case '7-9':\r\n        case '9':\r\n            return ['7-9'];\r\n        // Specials\r\n        case '1': return [\"1-3\"]; // Förekommer i ämnena \"Svenska\" och \"Svenska som andraspråk\"\r\n        case '1s': return [\"1-3\"]; // Förekommer i ämnena \"Svenska\" och \"Svenska som andraspråk\"\r\n        case '1-6': return [\"1-3\", \"4-6\"]; // Förekommer i ämnet \"Hem- och konsumentkunskap\"\r\n        case '4-9': return [\"4-6\", \"7-9\"]; // Förekommer i ämnet \"Moderna språk\"\r\n        default: {\r\n            throw new Error(\"Unexpected year in Skolverket XML: \" + inYear + \". Expecting 3,6,9 or 1-3, 4-6, 7-9\");\r\n        }\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L, showInfo, compareProp, arrayToLookup, flatten } from '../../../utils/utils';\r\nimport env from '../../../globals/KED.env';\r\nimport $ from 'jquery';\r\nimport { parseSkolverketYears } from './skolverket-subject';\r\nimport { UploadedSubject } from './uploaded-subject';\r\nexport { ShowSubject } from './show-subject';\r\nimport { Link } from 'react-router-dom';\r\nimport { readBlobAsText, allowCopy } from \"../utils\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nvar SubjectsInner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SubjectsInner, _super);\r\n    function SubjectsInner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isListingSubjects: true,\r\n            gymnasiumSubjects: [],\r\n            primarySchoolSubjects: [],\r\n            uploadedSubject: null\r\n        };\r\n        return _this;\r\n    }\r\n    SubjectsInner.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    SubjectsInner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subjects, gymnasiumSubjects, primarySchoolSubjects;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.list(\"subjects\")];\r\n                    case 1:\r\n                        subjects = _a.sent();\r\n                        subjects.sort(compareProp(\"name\"));\r\n                        gymnasiumSubjects = subjects.filter(function (s) { return s.schoolType !== 'primary'; });\r\n                        primarySchoolSubjects = subjects.filter(function (s) { return s.schoolType === 'primary'; });\r\n                        this.setState({ gymnasiumSubjects: gymnasiumSubjects, primarySchoolSubjects: primarySchoolSubjects, isListingSubjects: false });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SubjectsInner.prototype.handleFileSelect = function (ev) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var files, xml, doc, typeOfSchooling, schoolType, model, courses, i, course, knownledgeRequirements, centralContents, knowledgeRequirements, centralContentsByStadium_1, knowledgeRequirementsByStadium_1, subjectName_1, subjectCode_1, subjectPurpose, coursesByStadium, model;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        ev.stopPropagation();\r\n                        ev.preventDefault();\r\n                        files = ev.dataTransfer.files;\r\n                        return [4 /*yield*/, readBlobAsText(files[0])];\r\n                    case 1:\r\n                        xml = _a.sent();\r\n                        doc = $($.parseXML(xml));\r\n                        typeOfSchooling = doc.find(\"subject>originatorTypeOfSchooling\").text().trim() ||\r\n                            doc.find(\"subject>typeOfSchooling\").text().trim();\r\n                        schoolType = typeOfSchooling === \"COMPULSORY_SCHOOL\" ?\r\n                            'primary' :\r\n                            typeOfSchooling === \"UPPER_SECONDARY_EDUCATION\" ?\r\n                                'gymnasium' :\r\n                                null;\r\n                        if (schoolType === 'gymnasium') {\r\n                            model = {\r\n                                name: doc.find(\"subject>name\").text().trim(),\r\n                                code: doc.find(\"subject>code\").text().trim(),\r\n                                purpose: doc.find(\"subject>purpose\").text().trim(),\r\n                                courses: [],\r\n                                schoolType: 'gymnasium'\r\n                            };\r\n                            courses = doc.find(\"subject>courses\");\r\n                            for (i = 0; i < courses.length; ++i) {\r\n                                course = $(courses[i]);\r\n                                knownledgeRequirements = [].slice.call(course.find(\"knowledgeRequirements\"))\r\n                                    .map(function (r) { return ({\r\n                                    gradeStep: $(r).find('gradeStep').text().trim(),\r\n                                    text: $(r).find('text').text().trim()\r\n                                }); });\r\n                                model.courses.push({\r\n                                    name: course.find(\"name\").text().trim(),\r\n                                    code: course.find(\"code\").text().trim(),\r\n                                    centralContent: course.find(\"centralContent\").text().trim(),\r\n                                    points: parseInt(course.find(\"point\").text().trim()),\r\n                                    knownledgeRequirements: knownledgeRequirements,\r\n                                });\r\n                            }\r\n                            this.setState({ uploadedSubject: model });\r\n                        }\r\n                        else {\r\n                            centralContents = flatten(Array.from(doc.find(\"subject>centralContent\"))\r\n                                .map(function (cc) {\r\n                                var year = $(cc).find('year').text().trim();\r\n                                var typeOfCentralContent = $(cc).find('typeOfCentralContent').text().trim();\r\n                                if (typeOfCentralContent) {\r\n                                    // Do not yet support multiple types of central content.\r\n                                    throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av centralt inneh\\u00E5ll. Detta st\\u00F6ds \\u00E4nnu inte.\"], [\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av centralt inneh\\u00E5ll. Detta st\\u00F6ds \\u00E4nnu inte.\"]))));\r\n                                }\r\n                                var stadiums = parseSkolverketYears(year);\r\n                                var centralContentsForEachStadium = stadiums.map(function (stadium) { return ({\r\n                                    year: stadium,\r\n                                    text: $(cc).find('text').text().trim()\r\n                                }); });\r\n                                return centralContentsForEachStadium;\r\n                            }));\r\n                            knowledgeRequirements = flatten(Array.from(doc.find(\"subject>knowledgeRequirement\"))\r\n                                .map(function (kr) {\r\n                                var year = $(kr).find('year').text().trim();\r\n                                var typeOfRequirement = $(kr).find('typeOfRequirement').text().trim();\r\n                                if (typeOfRequirement) {\r\n                                    // Do not yet support multiple types of knowledge requirement.\r\n                                    throw new Error(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av kunskapskrav. Detta st\\u00F6ds \\u00E4nnu inte.\"], [\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av kunskapskrav. Detta st\\u00F6ds \\u00E4nnu inte.\"]))));\r\n                                }\r\n                                return parseSkolverketYears(year).map(function (stadium) { return ({\r\n                                    year: stadium,\r\n                                    text: $(kr).find('text').text().trim(),\r\n                                    gradeStep: $(kr).find('gradeStep').text().trim()\r\n                                }); });\r\n                            }));\r\n                            centralContentsByStadium_1 = arrayToLookup(centralContents, function (cc) { return cc.year; });\r\n                            knowledgeRequirementsByStadium_1 = arrayToLookup(knowledgeRequirements, function (kr) { return kr.year; });\r\n                            subjectName_1 = doc.find(\"subject>name\").text().trim();\r\n                            subjectCode_1 = doc.find(\"subject>code\").text().trim();\r\n                            subjectPurpose = doc.find(\"subject>purpose\").text().trim();\r\n                            coursesByStadium = ['1-3', '4-6', '7-9']\r\n                                .map(function (stadium) { return ({\r\n                                name: subjectName_1 + ' ' + stadium,\r\n                                code: subjectCode_1 + '|' + stadium,\r\n                                points: 0,\r\n                                year: stadium,\r\n                                centralContent: (centralContentsByStadium_1[stadium] || []).map(function (cc) { return cc.text; }).join('\\n'),\r\n                                knownledgeRequirements: (knowledgeRequirementsByStadium_1[stadium] || []).map(function (_a) {\r\n                                    var gradeStep = _a.gradeStep, text = _a.text;\r\n                                    return ({ gradeStep: gradeStep, text: text });\r\n                                })\r\n                            }); });\r\n                            model = {\r\n                                name: subjectName_1,\r\n                                code: subjectCode_1,\r\n                                purpose: subjectPurpose,\r\n                                schoolType: 'primary',\r\n                                courses: coursesByStadium\r\n                            };\r\n                            this.setState({ uploadedSubject: model });\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SubjectsInner.prototype.onImportSuccess = function (subject) {\r\n        showInfo(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Importen av \", \" lyckades\"], [\"Importen av \", \" lyckades\"])), subject));\r\n        this.setState({ uploadedSubject: null });\r\n        this.load();\r\n    };\r\n    SubjectsInner.prototype.render = function () {\r\n        var _this = this;\r\n        var linkPrefix = this.props.linkPrefix;\r\n        return React.createElement(\"div\", null, this.state.uploadedSubject ?\r\n            React.createElement(UploadedSubject, { onCancel: function () { return _this.setState({ uploadedSubject: null }); }, onImportSuccess: function (subject) { return _this.onImportSuccess(subject); }, subject: this.state.uploadedSubject })\r\n            : this.state.isListingSubjects ?\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"p\", null,\r\n                        React.createElement(Spinner, null),\r\n                        \"Var god v\\u00E4nta medan \\u00E4mnen h\\u00E4mtas...\")) :\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Gymnasie\\u00E4mnen\"], [\"Gymnasie\\u00E4mnen\"])))),\r\n                    React.createElement(\"ul\", null, this.state.gymnasiumSubjects.map(function (s) {\r\n                        return React.createElement(\"li\", { key: s.id, className: s.publishable ? \"complete\" : \"incomplete\" },\r\n                            React.createElement(Link, { to: linkPrefix + s.id }, s.name));\r\n                    })),\r\n                    React.createElement(\"h2\", null, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Grundskole\\u00E4mnen\"], [\"Grundskole\\u00E4mnen\"])))),\r\n                    React.createElement(\"ul\", null, this.state.primarySchoolSubjects.map(function (s) {\r\n                        return React.createElement(\"li\", { key: s.id, className: s.publishable ? \"complete\" : \"incomplete\" },\r\n                            React.createElement(Link, { to: linkPrefix + s.id }, s.name));\r\n                    })),\r\n                    React.createElement(\"div\", { className: \"drop-zone\", onDragOver: allowCopy, onDrop: function (ev) { return _this.handleFileSelect(ev); } },\r\n                        \"Droppa Subject-fil h\\u00E4r fr\\u00E5n skolverket (H\\u00E4mtas fr\\u00E5n \",\r\n                        React.createElement(\"a\", { href: \"http://opendata.skolverket.se\", target: \"skolverket\" }, \"opendata.skolverket.se\"),\r\n                        \")\")));\r\n    };\r\n    return SubjectsInner;\r\n}(React.Component));\r\nexport { SubjectsInner };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport $ from 'jquery';\r\nimport env from '../../../globals/KED.env';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { diffXmlWithDatabase } from './diff/diff-xml-with-database';\r\nvar UploadedSubject = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UploadedSubject, _super);\r\n    function UploadedSubject(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.coursesElems = {};\r\n        _this.centralContentElems = [];\r\n        _this.knowledgeRequirementElems = [];\r\n        _this.state = {\r\n            showFullText: false,\r\n            changes: [],\r\n            isWorking: true,\r\n            isImporting: false\r\n        };\r\n        return _this;\r\n    }\r\n    UploadedSubject.prototype.componentDidMount = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, changes, subjectToImport, error_1;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        this.addClassesForCherryPickedElements();\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        _b.trys.push([1, 3, 4, 5]);\r\n                        return [4 /*yield*/, this.diffWithExisting()];\r\n                    case 2:\r\n                        _a = _b.sent(), changes = _a.changes, subjectToImport = _a.subjectToImport;\r\n                        this.setState({ changes: changes, subjectToImport: subjectToImport });\r\n                        return [3 /*break*/, 5];\r\n                    case 3:\r\n                        error_1 = _b.sent();\r\n                        this.setState({ error: '' + error_1 });\r\n                        return [3 /*break*/, 5];\r\n                    case 4:\r\n                        this.setState({ isWorking: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.addClassesForCherryPickedElements = function () {\r\n        var abilities = $(this.purposeElem).find('li').first().parent().children('li');\r\n        abilities.addClass('ability');\r\n        var centralContents = $(this.centralContentElems).find('li');\r\n        centralContents.addClass('central-content');\r\n        var knowledgeRequirements = $(this.knowledgeRequirementElems).find('p');\r\n        knowledgeRequirements.addClass('knowledge-requirement');\r\n        var all = $([abilities, centralContents, knowledgeRequirements]);\r\n        all.addClass('marked-area');\r\n    };\r\n    UploadedSubject.prototype.cherryPickData = function () {\r\n        var _this = this;\r\n        //\r\n        // Reads elements (tagged by classes in addClassesForCherryPickedElements()) and converts their inner HTML to the corresponding\r\n        // model SubjectToImport. Note that if we need to adjust how to pick the right LI or P elements, we\r\n        // will only need to change the code in addClassesForCherryPickedElements(), not this code.\r\n        //\r\n        var skolSubject = this.props.subject;\r\n        var abilitiesLis = Array.from($(this.purposeElem).find('li').first().parent().children('li'));\r\n        var abilities = abilitiesLis.map(function (a, i) { return (i + 1 + \". \" + $(a).html()).trim(); }).filter(function (html) { return !!html; });\r\n        var result = {\r\n            name: skolSubject.name,\r\n            code: skolSubject.code,\r\n            schoolType: skolSubject.schoolType,\r\n            abilities: abilities,\r\n            courses: Object.keys(this.coursesElems)\r\n                .map(function (courseCode) { return _this.coursesElems[courseCode]; })\r\n                .map(function (_a) {\r\n                var course = _a.course, elem = _a.elem;\r\n                return ({\r\n                    name: course.name,\r\n                    year: course.year,\r\n                    code: course.code,\r\n                    points: course.points,\r\n                    centralContent: Array.from($(elem).find('.central-content')).map(function (c) { return ({\r\n                        html: $(c).html().trim(),\r\n                        group: $(c).parent('ul').prev('h4').text().trim()\r\n                    }); }).filter(function (_a) {\r\n                        var html = _a.html;\r\n                        return !!html;\r\n                    }),\r\n                    knowledgeRequirements: Array.from($(elem).find('.grade-step-none .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: null, html: html }); })\r\n                        .concat(Array.from($(elem).find('.grade-step-E .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"E\", html: html }); })\r\n                        .concat(Array.from($(elem).find('.grade-step-C .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"C\", html: html }); }))\r\n                        .concat(Array.from($(elem).find('.grade-step-A .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"A\", html: html }); })))\r\n                });\r\n            })\r\n        };\r\n        return result;\r\n    };\r\n    UploadedSubject.prototype.diffWithExisting = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            function ct() {\r\n                var rv = createTime;\r\n                createTime += 2;\r\n                return rv;\r\n            }\r\n            var subjectToImport, changes, existingSubjects, existingSubject, centralContent, knowledgeRequirements, createTime, newSubject_1, subjectAbilities, _loop_1, _a, _b, a, _loop_2, _c, _d, c;\r\n            var e_1, _e, e_2, _f;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_g) {\r\n                switch (_g.label) {\r\n                    case 0:\r\n                        subjectToImport = this.cherryPickData();\r\n                        changes = [];\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"subjects\")];\r\n                    case 1:\r\n                        existingSubjects = _g.sent();\r\n                        existingSubject = existingSubjects.filter(function (s) { return s.code === _this.props.subject.code; })[0];\r\n                        centralContent = [], knowledgeRequirements = [];\r\n                        createTime = Date.now();\r\n                        if (!existingSubject) return [3 /*break*/, 3];\r\n                        // Include abilities and standardCourses with the found Subject:\r\n                        return [4 /*yield*/, diffXmlWithDatabase(existingSubject, subjectToImport, changes)];\r\n                    case 2:\r\n                        // Include abilities and standardCourses with the found Subject:\r\n                        _g.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        newSubject_1 = existingSubject = {\r\n                            id: createUUID(),\r\n                            schoolType: subjectToImport.schoolType,\r\n                            tags: [\"schoolType:\" + subjectToImport.schoolType],\r\n                            acl: [\"role:USER:R\"],\r\n                            code: subjectToImport.code,\r\n                            name: subjectToImport.name,\r\n                            abilitiesOrder: [],\r\n                            publishable: false,\r\n                            dateTime: ct()\r\n                        };\r\n                        changes.push({\r\n                            change: \"Nytt ämne\",\r\n                            content: subjectToImport.name + \" (\" + subjectToImport.code + \")\",\r\n                            mutations: function (r) { return r.add(\"subjects\", newSubject_1); }\r\n                        });\r\n                        subjectAbilities = [];\r\n                        _loop_1 = function (a) {\r\n                            var newAbility = {\r\n                                id: createUUID(),\r\n                                name: a,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: ct()\r\n                            };\r\n                            subjectAbilities.push(newAbility); // To refer from in courses later on!\r\n                            changes.push({\r\n                                change: \"Ny förmåga\",\r\n                                content: a,\r\n                                mutations: function (r) {\r\n                                    r.add(\"abilities\", newAbility);\r\n                                    r.link(\"subjects\", newSubject_1.id, \"abilities\", newAbility.id, \"abilities\");\r\n                                }\r\n                            });\r\n                        };\r\n                        try {\r\n                            for (_a = tslib_1.__values(subjectToImport.abilities), _b = _a.next(); !_b.done; _b = _a.next()) {\r\n                                a = _b.value;\r\n                                _loop_1(a);\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (_b && !_b.done && (_e = _a.return)) _e.call(_a);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        // Update now when we have abilities order:\r\n                        newSubject_1.abilitiesOrder = subjectAbilities.map(function (_a) {\r\n                            var id = _a.id;\r\n                            return id;\r\n                        });\r\n                        _loop_2 = function (c) {\r\n                            var e_3, _a, e_4, _b, e_5, _c;\r\n                            var newCourse = {\r\n                                id: createUUID(),\r\n                                subjectCode: newSubject_1.code,\r\n                                schoolType: newSubject_1.schoolType,\r\n                                tags: [\r\n                                    \"sub:\" + newSubject_1.code,\r\n                                    \"course:\" + c.code,\r\n                                    \"schoolType:\" + newSubject_1.schoolType\r\n                                ],\r\n                                dateTime: ct(),\r\n                                isTemplate: true,\r\n                                acl: [\"role:EMPLOYEE:R\"],\r\n                                name: c.name,\r\n                                code: c.code,\r\n                                points: c.points,\r\n                                modules: [],\r\n                                subjectId: newSubject_1.id,\r\n                                resources: [],\r\n                                createdBy: { name: env.currentUser.displayName, url: \"mailto:\" + env.currentUser.mail },\r\n                                createdDate: Date.now(),\r\n                                knowledgeRequirementsOrder: [],\r\n                                centralContentOrder: [],\r\n                                abilitiesOrder: subjectAbilities.map(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id;\r\n                                })\r\n                            };\r\n                            if (c.year)\r\n                                newCourse.schoolGrade = c.year;\r\n                            changes.push({\r\n                                change: \"Ny kurs\",\r\n                                content: c.name,\r\n                                mutations: function (r) {\r\n                                    r.add(\"courses\", newCourse);\r\n                                    r.link(\"subjects\", newSubject_1.id, \"courses\", newCourse.id, \"courseTemplates\");\r\n                                }\r\n                            });\r\n                            var _loop_3 = function (ccGroup, html) {\r\n                                // Check if there exists an identical central content on previous course first\r\n                                var newCentralContent = centralContent.filter(function (cc) { return cc.name === html; })[0];\r\n                                if (!newCentralContent) {\r\n                                    newCentralContent = {\r\n                                        id: createUUID(),\r\n                                        dateTime: ct(),\r\n                                        name: html,\r\n                                        acl: [\"role:USER:R\"]\r\n                                    };\r\n                                    if (ccGroup)\r\n                                        newCentralContent.group = ccGroup;\r\n                                    centralContent.push(newCentralContent);\r\n                                    changes.push({\r\n                                        change: \"Nytt centralt innehåll\",\r\n                                        content: \"<h4>\" + ccGroup + \"</h4>\" + html,\r\n                                        mutations: function (r) {\r\n                                            r.add(\"central-content\", newCentralContent);\r\n                                            r.link(\"courses\", newCourse.id, \"central-content\", newCentralContent.id, \"centralContent\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    changes.push({\r\n                                        mutations: function (r) {\r\n                                            r.link(\"courses\", newCourse.id, \"central-content\", newCentralContent.id, \"centralContent\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                // Register the order in which this central content appeared in the XML:\r\n                                newCourse.centralContentOrder.push(newCentralContent.id);\r\n                            };\r\n                            try {\r\n                                for (var _d = (e_3 = void 0, tslib_1.__values(c.centralContent)), _e = _d.next(); !_e.done; _e = _d.next()) {\r\n                                    var _f = _e.value, ccGroup = _f.group, html = _f.html;\r\n                                    _loop_3(ccGroup, html);\r\n                                }\r\n                            }\r\n                            catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_e && !_e.done && (_a = _d.return)) _a.call(_d);\r\n                                }\r\n                                finally { if (e_3) throw e_3.error; }\r\n                            }\r\n                            var _loop_4 = function (cr) {\r\n                                var newKnowledgeRequirement = knowledgeRequirements.filter(function (kr) { return kr.name === cr.html && kr.gradeStep === cr.gradeStep; })[0];\r\n                                if (!newKnowledgeRequirement) {\r\n                                    newKnowledgeRequirement = {\r\n                                        id: createUUID(),\r\n                                        dateTime: ct(),\r\n                                        name: cr.html,\r\n                                        gradeStep: cr.gradeStep,\r\n                                        acl: [\"role:USER:R\"]\r\n                                    };\r\n                                    knowledgeRequirements.push(newKnowledgeRequirement);\r\n                                    changes.push({\r\n                                        change: \"Nytt kunskapskrav för betyget \" + cr.gradeStep,\r\n                                        content: cr.html,\r\n                                        mutations: function (r) {\r\n                                            r.add(\"knowledge-requirements\", newKnowledgeRequirement);\r\n                                            r.link(\"courses\", newCourse.id, \"knowledge-requirements\", newKnowledgeRequirement.id, \"knowledgeRequirements\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    changes.push({\r\n                                        mutations: function (r) {\r\n                                            r.link(\"courses\", newCourse.id, \"knowledge-requirements\", newKnowledgeRequirement.id, \"knowledgeRequirements\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                // Register the order in which this knowledge requirement appeared in the XML:\r\n                                newCourse.knowledgeRequirementsOrder.push(newKnowledgeRequirement.id);\r\n                            };\r\n                            try {\r\n                                for (var _g = (e_4 = void 0, tslib_1.__values(c.knowledgeRequirements)), _h = _g.next(); !_h.done; _h = _g.next()) {\r\n                                    var cr = _h.value;\r\n                                    _loop_4(cr);\r\n                                }\r\n                            }\r\n                            catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_h && !_h.done && (_b = _g.return)) _b.call(_g);\r\n                                }\r\n                                finally { if (e_4) throw e_4.error; }\r\n                            }\r\n                            var _loop_5 = function (a) {\r\n                                changes.push({\r\n                                    mutations: function (r) {\r\n                                        r.link(\"courses\", newCourse.id, \"abilities\", a.id, \"abilities\");\r\n                                    }\r\n                                });\r\n                            };\r\n                            try {\r\n                                // Build knowledge matrix\r\n                                // Link directly from course template to all abilities that the subject has:\r\n                                for (var subjectAbilities_1 = (e_5 = void 0, tslib_1.__values(subjectAbilities)), subjectAbilities_1_1 = subjectAbilities_1.next(); !subjectAbilities_1_1.done; subjectAbilities_1_1 = subjectAbilities_1.next()) {\r\n                                    var a = subjectAbilities_1_1.value;\r\n                                    _loop_5(a);\r\n                                }\r\n                            }\r\n                            catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (subjectAbilities_1_1 && !subjectAbilities_1_1.done && (_c = subjectAbilities_1.return)) _c.call(subjectAbilities_1);\r\n                                }\r\n                                finally { if (e_5) throw e_5.error; }\r\n                            }\r\n                        };\r\n                        try {\r\n                            for (_c = tslib_1.__values(subjectToImport.courses), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n                                c = _d.value;\r\n                                _loop_2(c);\r\n                            }\r\n                        }\r\n                        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (_d && !_d.done && (_f = _c.return)) _f.call(_c);\r\n                            }\r\n                            finally { if (e_2) throw e_2.error; }\r\n                        }\r\n                        _g.label = 4;\r\n                    case 4: return [2 /*return*/, { changes: changes, subjectToImport: subjectToImport }];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.cancel = function () {\r\n        this.props.onCancel();\r\n    };\r\n    UploadedSubject.prototype.import = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var allMutations;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ isWorking: true, isImporting: true });\r\n                        allMutations = this.state.changes.map(function (change) { return change.mutations; });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, , 3, 4]);\r\n                        return [4 /*yield*/, env.kedBackendClient.do(function (r) {\r\n                                allMutations.forEach(function (mut) { return mut(r); });\r\n                            })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        this.setState({ isWorking: false, isImporting: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 4:\r\n                        this.props.onImportSuccess(this.props.subject.name);\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.fixL = function (html) {\r\n        return html; //.replace('<l fromat=\"OL\">')\r\n    };\r\n    UploadedSubject.prototype.render = function () {\r\n        var _this = this;\r\n        var subjectToImport = this.state.subjectToImport;\r\n        var subject = this.props.subject;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"h1\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Uppladdat \\u00C4mne \", \"\"], [\"Uppladdat \\u00C4mne \", \"\"])), subjectToImport ? subjectToImport.name : '')),\r\n            this.state.error ? React.createElement(\"p\", null,\r\n                \"Fel: \",\r\n                this.state.error) :\r\n                this.state.isWorking ? React.createElement(\"p\", null, \"Arbetar...\") :\r\n                    this.state.isImporting ? React.createElement(\"p\", null, \"Importerar...\") :\r\n                        this.state.changes.every(function (c) { return !c.change; }) ? // Inga ändringar att visa (bara pseudo-ändringar)\r\n                            React.createElement(\"div\", null,\r\n                                React.createElement(\"p\", null, \"Kunde inte finna n\\u00E5gra f\\u00F6r\\u00E4ndringar fr\\u00E5n befintligt data. Klicka OK f\\u00F6r att avbryta och \\u00E5terg\\u00E5.\"),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.cancel(); } }, \" OK \")) :\r\n                            React.createElement(\"div\", null,\r\n                                React.createElement(\"table\", { style: { border: \"1px solid gray\", padding: \"2px\" } },\r\n                                    React.createElement(\"thead\", null,\r\n                                        React.createElement(\"tr\", null,\r\n                                            React.createElement(\"th\", { colSpan: 2 }, \"Granskning av \\u00E4ndringar i grund-data\")),\r\n                                        React.createElement(\"tr\", null,\r\n                                            React.createElement(\"th\", null, \"\\u00C4ndring\"),\r\n                                            React.createElement(\"th\", null, \"Inneh\\u00E5ll\"))),\r\n                                    React.createElement(\"tbody\", null, this.state.changes.filter(function (change) { return change.change; }).map(function (change, i) { return React.createElement(\"tr\", { key: i },\r\n                                        React.createElement(\"td\", { style: { padding: \"2px\" } }, change.change),\r\n                                        React.createElement(\"td\", { style: { padding: \"2px\" }, dangerouslySetInnerHTML: { __html: change.content } })); }))),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.cancel(); }, disabled: this.state.isImporting }, \"Avbryt\"),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.import(); }, disabled: this.state.isImporting }, \"Importera\"),\r\n                                React.createElement(\"br\", null)),\r\n            React.createElement(\"button\", { onClick: function () { return _this.setState({ showFullText: !_this.state.showFullText }); } }, this.state.showFullText ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"D\\u00F6lj nedan\"], [\"D\\u00F6lj nedan\"]))) : L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Visa hela texten fr\\u00E5n Skolverket\"], [\"Visa hela texten fr\\u00E5n Skolverket\"])))),\r\n            React.createElement(\"table\", { style: { display: this.state.showFullText ? '' : 'none' } },\r\n                React.createElement(\"tbody\", null,\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Namn\"),\r\n                        React.createElement(\"td\", null, subject.name)),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"\\u00C4mneskod\"),\r\n                        React.createElement(\"td\", null, subject.code)),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Syfte\"),\r\n                        React.createElement(\"td\", { ref: function (elem) { return _this.purposeElem = elem; }, dangerouslySetInnerHTML: { __html: this.fixL(subject.purpose) } })),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Kurser\"),\r\n                        React.createElement(\"td\", null, subject.courses.map(function (course) { return React.createElement(\"table\", { key: course.code, ref: function (elem) { return _this.coursesElems[course.code] = { course: course, elem: elem }; } },\r\n                            React.createElement(\"tbody\", null,\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kursens namn\"),\r\n                                    React.createElement(\"td\", null, course.name)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kurskod\"),\r\n                                    React.createElement(\"td\", null, course.code)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Po\\u00E4ng\"),\r\n                                    React.createElement(\"td\", null, course.points)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Centralt inneh\\u00E5ll\"),\r\n                                    React.createElement(\"td\", { ref: function (elem) { return _this.centralContentElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.centralContent) } })),\r\n                                course.knownledgeRequirements.some(function (kr) { return !kr.gradeStep; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav utan betygs\\u00E4ttning\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-none\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return !r.gradeStep; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'E'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg E\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-E\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'E'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'C'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg C\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-C\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'C'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'A'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg A\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-A\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'A'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined)); }))))));\r\n    };\r\n    return UploadedSubject;\r\n}(React.Component));\r\nexport { UploadedSubject };\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport update from 'react-addons-update';\r\nimport $ from 'jquery';\r\nimport env from '../../globals/KED.env';\r\nexport function updateDocumentGraphs(oldDoc, newDoc, table, graphs, batch) {\r\n    var e_1, _a;\r\n    var docUpdates = {};\r\n    var docId = newDoc.id;\r\n    var _loop_1 = function (navProp) {\r\n        var e_2, _a, e_3, _b, e_4, _c;\r\n        var foreignTable = graphs[navProp];\r\n        var oldList = oldDoc[navProp] || [];\r\n        var newList = newDoc[navProp];\r\n        if (!newList)\r\n            return \"continue\";\r\n        var tuples = newList\r\n            .map(function (doc, idx) { return ({ doc: doc, idx: idx }); }); // Create tubles of {doc, array-index} so we can update result\r\n        var added = tuples.filter(function (tuple) { return !oldList.some(function (o) { return o.id === tuple.doc.id; }); }); // Find added items\r\n        try {\r\n            for (var added_1 = (e_2 = void 0, tslib_1.__values(added)), added_1_1 = added_1.next(); !added_1_1.done; added_1_1 = added_1.next()) {\r\n                var a = added_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, a.doc);\r\n                var meta = mutatedSubDoc.$meta;\r\n                delete mutatedSubDoc.$meta; // Delete $meta so that \"add\" or \"update\" does not persiste to next state.\r\n                if (meta === 'add') {\r\n                    if (!mutatedSubDoc.id)\r\n                        mutatedSubDoc.id = createUUID(); // Generate ID if not done yet.\r\n                    // Now put an 'add' mutation in the batch queue.\r\n                    batch.add(foreignTable, mutatedSubDoc);\r\n                }\r\n                else if (meta === 'update') {\r\n                    batch.put(foreignTable, mutatedSubDoc);\r\n                }\r\n                batch.link(table, docId, foreignTable, mutatedSubDoc.id, navProp);\r\n                // Update result so that state is reflected after succesful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][a.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (added_1_1 && !added_1_1.done && (_a = added_1.return)) _a.call(added_1);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        var removed = oldList.filter(function (o) { return !newList.some(function (n) { return n.id === o.id; }); });\r\n        try {\r\n            for (var removed_1 = (e_3 = void 0, tslib_1.__values(removed)), removed_1_1 = removed_1.next(); !removed_1_1.done; removed_1_1 = removed_1.next()) {\r\n                var r = removed_1_1.value;\r\n                batch.unlink(table, docId, foreignTable, r.id, navProp);\r\n            }\r\n        }\r\n        catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n        finally {\r\n            try {\r\n                if (removed_1_1 && !removed_1_1.done && (_b = removed_1.return)) _b.call(removed_1);\r\n            }\r\n            finally { if (e_3) throw e_3.error; }\r\n        }\r\n        var updated = tuples.filter(function (tuple) { return oldList.some(function (o) { return o.id === tuple.doc.id && tuple.doc.$meta === 'update'; }); });\r\n        try {\r\n            for (var updated_1 = (e_4 = void 0, tslib_1.__values(updated)), updated_1_1 = updated_1.next(); !updated_1_1.done; updated_1_1 = updated_1.next()) {\r\n                var u = updated_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, u.doc);\r\n                delete mutatedSubDoc.$meta;\r\n                batch.put(foreignTable, mutatedSubDoc);\r\n                // Update result so that $meta is removed from navigation prop after successful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][u.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n        finally {\r\n            try {\r\n                if (updated_1_1 && !updated_1_1.done && (_c = updated_1.return)) _c.call(updated_1);\r\n            }\r\n            finally { if (e_4) throw e_4.error; }\r\n        }\r\n    };\r\n    try {\r\n        for (var _b = tslib_1.__values(Object.keys(graphs)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n            var navProp = _c.value;\r\n            _loop_1(navProp);\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return update(newDoc, docUpdates);\r\n}\r\nexport function dtFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD HH:mm');\r\n}\r\nexport function shortDateFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD');\r\n}\r\nexport function shortPersonNameFormat(name) {\r\n    if (!name)\r\n        return \"\";\r\n    var names = name.split(' ').filter(function (n) { return !!n; });\r\n    var lastName = names.pop();\r\n    return names.map(function (name) { return name[0] + \".\"; }).concat(lastName).join(' ');\r\n}\r\nexport function updateModificationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        dateTime: { $set: now },\r\n        modifiedDate: { $set: now },\r\n        modifiedBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function updateCreationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        createdDate: { $set: now },\r\n        createdBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function getEmailFromDocAccess(resource) {\r\n    if (resource.email)\r\n        return resource.email;\r\n    return resource.url ?\r\n        resource.url.startsWith('mailto:') ?\r\n            resource.url.substring('mailto:'.length) :\r\n            resource.url :\r\n        resource.url;\r\n}\r\nexport function updateModificationAndCreationStamps(obj, user) {\r\n    var now = Date.now();\r\n    obj = updateModificationStamp(now, obj, user);\r\n    if (!obj.createdBy)\r\n        obj = updateCreationStamp(now, obj, user);\r\n    return obj;\r\n}\r\nexport function applyEtags(doc, newEtags, graphs) {\r\n    var e_5, _a;\r\n    var res = tslib_1.__assign({}, doc);\r\n    var etag = newEtags[doc.id];\r\n    if (etag)\r\n        res.$etag = etag;\r\n    try {\r\n        for (var graphs_1 = tslib_1.__values(graphs), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\r\n            var label = graphs_1_1.value;\r\n            var newList = doc[label].map(function (d) { return applyEtags(d, newEtags, []); });\r\n            res[label] = newList;\r\n        }\r\n    }\r\n    catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n    finally {\r\n        try {\r\n            if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\r\n        }\r\n        finally { if (e_5) throw e_5.error; }\r\n    }\r\n    return res;\r\n}\r\nexport function readBlob(blob, m) {\r\n    return new Promise(function (resolve, reject) {\r\n        var reader = new FileReader();\r\n        reader.onload = function (ev) { return resolve(ev.target.result); };\r\n        reader.onabort = function (ev) { return reject(new Error(\"file read aborted\")); };\r\n        reader.onerror = function (ev) { return reject(ev.target.error); };\r\n        m(reader);\r\n    });\r\n}\r\nexport function readBlobAsText(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsText(blob); });\r\n}\r\nexport function readBlobAsDataUrl(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsDataURL(blob); });\r\n}\r\nexport function allowCopy(e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    e.dataTransfer.dropEffect = 'copy';\r\n}\r\nexport function updateCourseBuilderStatus(status) {\r\n    var div = $('div.course-builder')[0];\r\n    if (div)\r\n        div.className = \"course-builder\" + (status ? \" status \" + status : \"\");\r\n}\r\nexport function loadCourse(id, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var client, includeTemplateChain, includeTasks, _a, course, courseTasks, templateChain;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    client = env.kedBackendClient;\r\n                    includeTemplateChain = options && options.includeTemplateChain;\r\n                    includeTasks = !options || !options.include || options.include.indexOf(\"tasks\") !== -1;\r\n                    return [4 /*yield*/, Promise.all([\r\n                            client.get(\"courses\", id, {\r\n                                include: options && options.include ? options.include.filter(function (i) { return i !== \"tasks\"; }) : [\r\n                                    \"centralContent\",\r\n                                    \"knowledgeRequirements\",\r\n                                    \"abilities\",\r\n                                    \"images\",\r\n                                    \"acl\" // Don't include tasks here...\r\n                                ]\r\n                            }),\r\n                            // ... but include tasks here instead so that we can load the graphs for the\r\n                            // tasks as well!\r\n                            includeTasks && client.list(\"tasks\", {\r\n                                hasEdgesFrom: id,\r\n                                include: ['knowledgeRequirements', 'centralContent', 'abilities', 'acl'],\r\n                                flags: ['includeIdsOnly'] // Don't need redundant info that's already on course\r\n                            }),\r\n                            includeTemplateChain && client.list(\"courses\", {\r\n                                hasEdgesFrom: id,\r\n                                flags: ['idsOnly']\r\n                            })\r\n                        ])];\r\n                case 1:\r\n                    _a = tslib_1.__read.apply(void 0, [(_b.sent()), 3]), course = _a[0], courseTasks = _a[1], templateChain = _a[2];\r\n                    course.tasks = courseTasks;\r\n                    // Correct the order of Abilities\r\n                    if (course.abilities && course.abilitiesOrder) {\r\n                        course.abilities = course.abilitiesOrder.map(function (id) {\r\n                            return course.abilities.find(function (a) { return a.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of KnowledgeRequirements\r\n                    if (course.knowledgeRequirements && course.knowledgeRequirementsOrder) {\r\n                        course.knowledgeRequirements = course.knowledgeRequirementsOrder.map(function (id) {\r\n                            return course.knowledgeRequirements.find(function (c) { return c.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of CentralContent\r\n                    if (course.centralContent && course.centralContentOrder) {\r\n                        course.centralContent = course.centralContentOrder.map(function (id) {\r\n                            return course.centralContent.find(function (cc) { return cc.id === id; });\r\n                        }); //.filter(x => !!x);// Debugging somthin' . Normally the last .filter()... part should not be nescessary...\r\n                    }\r\n                    // Include template chain if requested.\r\n                    if (includeTemplateChain)\r\n                        course.templateChain = templateChain;\r\n                    return [2 /*return*/, course];\r\n            }\r\n        });\r\n    });\r\n}\r\n// Check differences between two array of type T\r\nexport function hasChanges(originalValues, currentValues) {\r\n    return originalValues === undefined || currentValues.filter(function (x) { return !originalValues.includes(x); }).length > 0 || originalValues.filter(function (x) { return !currentValues.includes(x); }).length > 0;\r\n}\r\n","import * as React from 'react';\r\nexport var LanguageContext = React.createContext({ intl: null });\r\n","import * as tslib_1 from \"tslib\";\r\nimport { IntlProvider, addLocaleData } from 'react-intl';\r\nimport locale_en from 'react-intl/locale-data/en';\r\nimport locale_sv from 'react-intl/locale-data/sv';\r\nimport messages_sv from \"../../translations/sv.json\";\r\nimport messages_en from \"../../translations/en.json\";\r\nimport * as React from 'react';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport moment from 'moment';\r\nexport var setupIntl = function (Component) {\r\n    return /** @class */ (function (_super) {\r\n        tslib_1.__extends(_SetupLanguageIntl, _super);\r\n        function _SetupLanguageIntl(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            addLocaleData(tslib_1.__spread(locale_en, locale_sv));\r\n            _this.messages = {\r\n                'sv': messages_sv,\r\n                'en': messages_en\r\n            };\r\n            moment().locale(cfg.KED_LOCALE);\r\n            return _this;\r\n        }\r\n        _SetupLanguageIntl.prototype.render = function () {\r\n            return React.createElement(IntlProvider, { locale: cfg.KED_LOCALE, messages: this.messages[cfg.KED_LOCALE] },\r\n                React.createElement(Component, tslib_1.__assign({}, this.props)));\r\n        };\r\n        return _SetupLanguageIntl;\r\n    }(React.Component));\r\n};\r\n","import React from 'react';\r\nexport var Checklist = function (_a) {\r\n    var available = _a.available, selected = _a.selected, onChange = _a.onChange;\r\n    return React.createElement(\"div\", { className: \"taskContainer\" }, available.map(function (_a) {\r\n        var key = _a.key, name = _a.name;\r\n        var checked = selected.includes(key);\r\n        return React.createElement(\"div\", { key: key, className: \"align-horizontal\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\", onClick: function () {\r\n                    return onChange(checked ?\r\n                        selected.filter(function (k) { return k != key; }) :\r\n                        selected.concat(key), key, checked);\r\n                } },\r\n                React.createElement(\"div\", { className: \"checkBox\" + (checked ? \" checked\" : \"\") })),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" }, name));\r\n    }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextInput = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextInput, _super);\r\n    function TextInput(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextInput.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label },\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"text\", autoFocus: this.props.autoFocus, id: this.props.id, size: this.props.size || 35, value: this.props.value, onChange: this.props.onChange && (function (ev) { return _this.props.onChange(ev.target.value); }), disabled: this.props.disabled, placeholder: this.props.placeholder }))));\r\n    };\r\n    return TextInput;\r\n}(React.Component));\r\nexport { TextInput };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextAreaFormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextAreaFormField, _super);\r\n    function TextAreaFormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextAreaFormField.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label, id: this.props.id },\r\n            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"textarea\", { autoFocus: this.props.autoFocus, id: this.props.id, cols: 35, rows: this.props.rows || 5, value: this.props.value, onChange: function (ev) { return _this.props.onChange(ev.target.value); }, placeholder: this.props.placeholder })),\r\n                !!this.props.children && React.createElement(\"div\", { className: \"horizontalItem\" }, this.props.children))));\r\n    };\r\n    return TextAreaFormField;\r\n}(React.Component));\r\nexport { TextAreaFormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nfunction findId(node) {\r\n    var recucheck = new Set();\r\n    return (function findId(node) {\r\n        if (typeof node === 'string')\r\n            return null;\r\n        if (recucheck.has(node)) {\r\n            return;\r\n        }\r\n        recucheck.add(node);\r\n        if (node.props) {\r\n            if (node.props.id)\r\n                return node.props.id;\r\n            if (node.props.children) {\r\n                return findId(node.props.children);\r\n            }\r\n            return;\r\n        }\r\n        if (node.length) {\r\n            for (var i = 0; i < node.length; ++i) {\r\n                var child = node[i];\r\n                if (child) {\r\n                    var childId = findId(child);\r\n                    if (childId)\r\n                        return childId;\r\n                    //console.log(child);\r\n                }\r\n            }\r\n        }\r\n    })(node);\r\n}\r\nvar FormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(FormField, _super);\r\n    function FormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    FormField.prototype.render = function () {\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"label\", { className: \"kclabel\", htmlFor: this.props.id || findId(this.props.children) }, this.props.label),\r\n            this.props.children);\r\n    };\r\n    return FormField;\r\n}(React.Component));\r\nexport { FormField };\r\n","import * as React from 'react';\r\nimport { LiveQueryView } from './live-query-view';\r\nexport function LazyContent(_a) {\r\n    var children = _a.children, spinner = _a.spinner, onError = _a.onError, noError = _a.noError;\r\n    return React.createElement(LiveQueryView, { props: children, spinner: spinner, noError: noError, onError: onError, fn: function (observable) { return observable; } });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { shallowEquals } from '../../utils/utils';\r\nexport function liveQueryView(fn, options) {\r\n    return function (props) {\r\n        return React.createElement(LiveQueryView, tslib_1.__assign({ props: props, fn: fn }, options));\r\n    };\r\n}\r\nvar LiveQueryView = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LiveQueryView, _super);\r\n    function LiveQueryView(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            result: null,\r\n            isLoading: true\r\n        };\r\n        return _this;\r\n    }\r\n    LiveQueryView.prototype.componentDidMount = function () {\r\n        this.subscribe();\r\n    };\r\n    LiveQueryView.prototype.componentWillUnmount = function () {\r\n        this.unsubscribe();\r\n    };\r\n    LiveQueryView.prototype.shouldComponentUpdate = function (nextProps, nextState) {\r\n        return (this.state.error !== nextState.error ||\r\n            this.state.isLoading !== nextState.isLoading ||\r\n            this.state.result !== nextState.result ||\r\n            !shallowEquals(nextProps.props, this.props.props));\r\n    };\r\n    LiveQueryView.prototype.componentDidUpdate = function (prevProps) {\r\n        if (!shallowEquals(prevProps.props, this.props.props)) {\r\n            this.unsubscribe();\r\n            this.subscribe();\r\n        }\r\n    };\r\n    LiveQueryView.prototype.subscribe = function () {\r\n        var _this = this;\r\n        this.setState({ isLoading: true });\r\n        this.subscription = this.props.fn(this.props.props).subscribe(function (result, error) { return _this.setState({\r\n            result: result,\r\n            error: error,\r\n            isLoading: false\r\n        }); });\r\n    };\r\n    LiveQueryView.prototype.unsubscribe = function () {\r\n        if (this.subscription) {\r\n            this.subscription.unsubscribe();\r\n            this.subscription = null;\r\n        }\r\n    };\r\n    LiveQueryView.prototype.render = function () {\r\n        var _a = this.state, result = _a.result, error = _a.error, isLoading = _a.isLoading;\r\n        var _b = this.props, spinner = _b.spinner, onError = _b.onError, noError = _b.noError;\r\n        //if (!isLoading && !result) debugger;\r\n        return error ?\r\n            noError ? \"\" : onError ? onError(error) : React.createElement(\"p\", null,\r\n                \"Error: \",\r\n                error.message) :\r\n            isLoading ?\r\n                spinner ? spinner : \"\" :\r\n                result === undefined ? \"\" : result;\r\n    };\r\n    return LiveQueryView;\r\n}(React.Component));\r\nexport { LiveQueryView };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { liveQueryView } from './live-query-view';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport env from '../../globals/KED.env';\r\nexport var LoadingIndicator = liveQueryView(function () {\r\n    return env.kedBackendClient.http.status.combineLatest(env.edsClient.http.status)\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), kedBackendStatus = _b[0], edsStatus = _b[1];\r\n        return React.createElement(\"div\", { className: \"loading-indicator\" },\r\n            React.createElement(\"div\", { className: \"indicator\" }, kedBackendStatus.numOutstandingOperations > 0 || edsStatus.numOutstandingOperations > 0 ?\r\n                React.createElement(Spinner, null) : undefined));\r\n    });\r\n});\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { L } from '../../utils/utils';\r\nvar Multiselect = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Multiselect, _super);\r\n    function Multiselect(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            optionsVisible: false\r\n        };\r\n        return _this;\r\n    }\r\n    Multiselect.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, selected = _a.selected, onChange = _a.onChange, getOptions = _a.getOptions;\r\n        var _b = this.state, optionsVisible = _b.optionsVisible, options = _b.options;\r\n        var filteredOptions = options && options.filter(function (o) { return !selected.some(function (s) { return s.key === o.key; }); });\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"div\", { className: \"taskContainer\" }, selected.map(function (_a) {\r\n                var key = _a.key, name = _a.name;\r\n                //const checked = selected.includes(key);\r\n                return React.createElement(\"div\", { key: key, className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"i\", { className: \"fa fa-remove hoverable\", onClick: function () { return onChange(selected.filter(function (option) { return option.key !== key; })); } }),\r\n                        name));\r\n            })),\r\n            React.createElement(\"span\", { style: { outline: 'none' }, tabIndex: 0, onBlur: function (ev) { return setTimeout(function () { return _this.setState({ optionsVisible: false }); }, 100); } },\r\n                React.createElement(\"a\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                        var options_1, err_1;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    if (optionsVisible)\r\n                                        return [2 /*return*/, this.setState({ optionsVisible: false })];\r\n                                    this.setState({ optionsVisible: true });\r\n                                    if (!!this.state.options) return [3 /*break*/, 4];\r\n                                    _a.label = 1;\r\n                                case 1:\r\n                                    _a.trys.push([1, 3, , 4]);\r\n                                    return [4 /*yield*/, getOptions()];\r\n                                case 2:\r\n                                    options_1 = _a.sent();\r\n                                    this.setState({ options: options_1 });\r\n                                    return [3 /*break*/, 4];\r\n                                case 3:\r\n                                    err_1 = _a.sent();\r\n                                    this.setState({ options: [{ key: null, name: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Ett fel har intr\\u00E4ffat\"], [\"Ett fel har intr\\u00E4ffat\"]))) }] });\r\n                                    return [3 /*break*/, 4];\r\n                                case 4: return [2 /*return*/];\r\n                            }\r\n                        });\r\n                    }); } },\r\n                    React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": true }),\r\n                    \" \", L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till\"], [\"L\\u00E4gg till\"])))),\r\n                optionsVisible ? React.createElement(React.Fragment, null,\r\n                    React.createElement(\"br\", null),\r\n                    filteredOptions ?\r\n                        React.createElement(\"select\", { size: filteredOptions.length === 1 ? 2 : filteredOptions.length, defaultValue: '', onChange: function (ev) {\r\n                                var selectedKey = ev.target.value;\r\n                                onChange(selected.concat({ key: selectedKey, name: options.filter(function (o) { return o.key === selectedKey; }).map(function (o) { return o.name; })[0] }));\r\n                                _this.setState({ optionsVisible: false });\r\n                            } },\r\n                            React.createElement(\"option\", { style: { display: 'none' }, disabled: true, key: '', value: '' }),\r\n                            filteredOptions.map(function (_a) {\r\n                                var key = _a.key, name = _a.name;\r\n                                return React.createElement(\"option\", { key: key, value: key }, name);\r\n                            })) :\r\n                        React.createElement(Spinner, null)) :\r\n                    undefined));\r\n    };\r\n    return Multiselect;\r\n}(React.Component));\r\nexport { Multiselect };\r\nvar templateObject_1, templateObject_2;\r\n","/* REFACTOR: Move this component outside coursebuilder!\r\n   This is a general-purpose component\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { GoalProgress } from '../charts/goal-progress';\r\nvar OpenCloseBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(OpenCloseBox, _super);\r\n    function OpenCloseBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    OpenCloseBox.prototype.componentWillReceiveProps = function (nextProps) {\r\n        if (nextProps.headerOpen !== this.props.headerOpen) {\r\n            this.setState({ headerOpen: nextProps.headerOpen });\r\n        }\r\n    };\r\n    OpenCloseBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, className = _a.className, children = _a.children, headerClassName = _a.headerClassName, contentClassName = _a.contentClassName, displayProgress = _a.displayProgress, progressData = _a.progressData, inactivated = _a.inactivated, inactivatedRender = _a.inactivatedRender;\r\n        var headerOpen = this.state.headerOpen;\r\n        if (inactivated)\r\n            return inactivatedRender === 'titleAndChildren' ? React.createElement(React.Fragment, null,\r\n                React.createElement(React.Fragment, null, title),\r\n                React.createElement(React.Fragment, null, children)) : React.createElement(React.Fragment, null, children);\r\n        //var currentProgressData = //progressData();\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\" + (headerClassName ? \" \" + headerClassName : \"\"), onClick: function () {\r\n                    if (_this.props.onOpenClose)\r\n                        _this.props.onOpenClose(!_this.state.headerOpen);\r\n                    _this.setState({ headerOpen: !_this.state.headerOpen });\r\n                } },\r\n                React.createElement(\"div\", { className: \"openHeaderContainer\" },\r\n                    React.createElement(\"div\", null, title),\r\n                    displayProgress && React.createElement(GoalProgress, tslib_1.__assign({}, progressData)))),\r\n            React.createElement(\"div\", { className: \"openContent\" + (contentClassName ? \" \" + contentClassName : \"\") }, children));\r\n    };\r\n    return OpenCloseBox;\r\n}(React.Component));\r\nexport { OpenCloseBox };\r\n","import cfg from '../globals/KED.cfg';\r\ncfg.ENVIRONMENT = process.env.ENVIRONMENT;\r\ncfg.KED_API_URL = process.env.KED_API_URL; // \"https://kedbackendtest.azurewebsites.net/api/\"\r\ncfg.EDS_API_URL = process.env.EDS_API_URL; // \"https://edsportalowinapi.azurewebsites.net/api/\"\r\ncfg.KED_TOKEN_URL = process.env.KED_TOKEN_URL; // \"https://kedauthtest.azurewebsites.net/token\"\r\ncfg.KED_CLIENT_ID = process.env.KED_CLIENT_ID; // \"devclient\", \"testclient\", \"...\"\r\ncfg.KED_CLIENT_SECRET = process.env.KED_CLIENT_SECRET;\r\ncfg.KED_REALM = process.env.KED_REALM; // \"SE1\"\r\ncfg.KED_LOCALE = cfg.KED_LOCALE || process.env.KED_LOCALE; // \"sv\", \"en\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_SCHOOL_LOCALE = cfg.KED_SCHOOL_LOCALE || process.env.KED_SCHOOL_LOCALE; // \"sv\", \"en_sin\", \"en_nin\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_RESOURCES_URL = cfg.KED_RESOURCES_URL || process.env.KED_RESOURCES_URL;\r\n","/* These scripts assume some of the global vars have already been set:\r\n  * KED.cfg\r\n  * KED.env.currentUser\r\n\r\n  The rest will be set here (client side)\r\n*/\r\nimport './configure';\r\nimport './set-bearer-providers';\r\nimport './set-ked-backend-client';\r\nimport './set-eds-client';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString, generateQueryString, splitUrlAndQuery } from \"../utils/query-string\";\r\nimport { WebServerBearerProvider, isomorphic, storage } from 'kedbackend/clientweb';\r\nimport { KedBearerProvider } from 'kedbackend/client';\r\nimport cfg from '../globals/KED.cfg';\r\nimport env from '../globals/KED.env';\r\nimport { IMPERSONATION_QUERY_PARAMS } from \"../access-control/index\";\r\nimport { cherryPickProps } from \"../utils/utils\";\r\nvar employeeClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.profile.emails\",\r\n    \"https://www.googleapis.com/auth/classroom.rosters\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.students\"\r\n];\r\nvar studentClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.me\"\r\n];\r\nfunction getMergedTokenPath(tokenPath, locationSearch, scopes) {\r\n    // Merge configured query params of token path with params given to current page\r\n    var currentQuery = parseQueryString(locationSearch);\r\n    var impersonationProps = cherryPickProps(currentQuery, IMPERSONATION_QUERY_PARAMS);\r\n    var _a = tslib_1.__read(splitUrlAndQuery(tokenPath), 2), tokenPathWithoutQuery = _a[0], tokenQueryString = _a[1];\r\n    var tokenPathQuery = parseQueryString(tokenQueryString);\r\n    return tokenPathWithoutQuery + generateQueryString(tslib_1.__assign({}, tokenPathQuery, impersonationProps, { scopes: scopes.join(',') }));\r\n}\r\nfunction getTokenId(mergedTokenPath, userEmail) {\r\n    return mergedTokenPath + \"/\" + userEmail;\r\n}\r\nfunction saveUserInfo(user, tokenId) {\r\n    env.currentUser = user;\r\n    var schoolgrade = parseQueryString(location.search, { toLower: true }).schoolgrade;\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n    sessionStorage.setItem(\"userInfo\" + tokenId, JSON.stringify(user));\r\n}\r\nfunction loadUserInfo(tokenId) {\r\n    var storedSessionUser = sessionStorage.getItem(\"userInfo\" + tokenId);\r\n    if (storedSessionUser) {\r\n        env.currentUser = JSON.parse(storedSessionUser);\r\n    }\r\n}\r\nfunction createBearerProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        if (res.user) {\r\n            saveUserInfo(res.user, tokenId);\r\n        }\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createGoogleTokenProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createTestTokenProvider(tokenUrl, user, scopes) {\r\n    return new KedBearerProvider(isomorphic, storage, tokenUrl + user.mail + location.search, cfg.KED_CLIENT_ID, cfg.KED_CLIENT_SECRET, tokenUrl, {\r\n        email: user.mail.toLowerCase(),\r\n        roles: user.roles,\r\n        school: user.school,\r\n        schoolType: user.schoolType,\r\n        scopes: scopes,\r\n        name: user.displayName\r\n    });\r\n}\r\n// env.currentUser.mail is set by SiteVision server initially.\r\n// A response from /api/token may change the mail attribute of the current\r\n// user, so env.currentUser.mail may be different after getting a response.\r\n// However, the initial value is valuable always in order to distinguish the case\r\n// when one normal user logs out and another user logs in.\r\nvar initialUserEmail = env.currentUser && env.currentUser.mail; // Initial value of mail. May change.\r\nif (initialUserEmail) {\r\n    // KED\r\n    if (cfg.KED_TOKEN_PATH) {\r\n        //\r\n        //\r\n        // Production / SiteVision proxied /api/token to request tokens from:\r\n        //\r\n        //\r\n        var mergedTokenPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        env.bearerProvider = createBearerProvider(mergedTokenPath, initialUserEmail);\r\n        loadUserInfo(getTokenId(mergedTokenPath, initialUserEmail));\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        // Google\r\n        var googleMergedPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, scopes);\r\n        env.googleTokenProvider = createGoogleTokenProvider(googleMergedPath, initialUserEmail);\r\n    }\r\n    else if (cfg.KED_TOKEN_URL && cfg.KED_CLIENT_ID && cfg.KED_CLIENT_SECRET) {\r\n        //\r\n        //\r\n        // Test - go directly to KEDAUTH server to retrieve tokens\r\n        //\r\n        //\r\n        env.bearerProvider = createTestTokenProvider(cfg.KED_TOKEN_URL, env.currentUser, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        env.googleTokenProvider = createTestTokenProvider(cfg.KED_TOKEN_URL + \"/google\", env.currentUser, scopes);\r\n    }\r\n    else {\r\n        throw new Error(\"Missing configuration parameter KED_TOKEN_PATH\");\r\n    }\r\n}\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { isomorphic } from 'kedbackend/clientweb';\r\nimport { EdsClient } from '../apis/edsclient';\r\nenv.edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, env.bearerProvider, function () { return env.currentUser.mail; });\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { KedBackendClientWeb } from 'kedbackend/clientweb';\r\nenv.kedBackendClient = new KedBackendClientWeb(cfg.KED_API_URL, env.bearerProvider);\r\n","import KED from './KED';\r\n;\r\nif (!KED.cfg)\r\n    KED.cfg = {};\r\nexport default KED.cfg;\r\nexport var cfg = KED.cfg;\r\n","import KED from './ked';\r\nif (!KED.env)\r\n    KED.env = {};\r\nexport default KED.env;\r\nexport var env = KED.env;\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import env from './KED.env';\r\nimport { KedBackendRepo } from 'kedbackend/repo';\r\nimport { getGlobalId, createUUID } from 'kedbackend/client';\r\nimport cfg from './KED.cfg';\r\nif (!env.db) {\r\n    // Put db on env so that it is shared between subject planner and other components!\r\n    env.db = new KedBackendRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser ?\r\n        env.currentUser.mail :\r\n        \"\"; }, function () { return env.currentUser ?\r\n        env.currentUser.displayName || env.currentUser.mail :\r\n        \"\"; });\r\n}\r\nexport var db = env.db;\r\nexport var globalId = getGlobalId(cfg.KED_REALM);\r\nexport var Schools = {\r\n    standardSchool: db.schools.name(\"standard\").cacheOptimized().single(),\r\n    get mySchool() { return db.schools.name(env.currentUser.school).cacheOptimized().single(); }\r\n};\r\nexport var CourseInstances = {\r\n    getBranchId: function (school, courseId) {\r\n        return school.switchMap(function (school) {\r\n            return db.branches\r\n                .hasEdgesFrom([school.officialBranchId])\r\n                .name(\"draft\")\r\n                .tags(courseId)\r\n                .idsOnly()\r\n                .map(function (_a) {\r\n                var id = _a.id;\r\n                return id;\r\n            })\r\n                .toValue()\r\n                .map(function (ids) { return ids.length > 0 ? ids[0] : undefined; });\r\n        });\r\n    },\r\n    /** Get a DRAFT branch for given course ID and given school.\r\n     * If there is not yet such a branch, create it using mutationsOnEmpty() which will\r\n     * lead to the C# code DocumentRepository.ReadOrMutate() via DocumentController.\r\n     */\r\n    getOrCreateBranchId: function (school, courseId) {\r\n        return db.courseInstances.idsOnly().id(courseId).switchMap(function () {\r\n            return school.switchMap(function (school) {\r\n                return db.branches\r\n                    .hasEdgesFrom([school.officialBranchId])\r\n                    .name(\"draft\")\r\n                    .tags(courseId)\r\n                    .idsOnly()\r\n                    .mutationsOnEmpty(function (tx) {\r\n                    // These 2 mutations will occur server side, atomically.\r\n                    // Will be sent on each request in the query, but will only execute if query results in zero items.\r\n                    //console.log(\"School:\", school);\r\n                    var id = createUUID();\r\n                    tx.add(\"branches\", {\r\n                        id: id,\r\n                        acl: [\r\n                            \"role:USER:R\",\r\n                            \"schoolRole:\" + school.name + \"/EMPLOYEE:S\"\r\n                        ],\r\n                        name: 'draft',\r\n                        schoolId: school.id,\r\n                        treeParentId: school.officialBranchId,\r\n                        tags: [courseId]\r\n                    });\r\n                    // Approving the branch makes sure that it was created by an EMPLOYEE on given school.\r\n                    tx.link2(\"branches\", school.officialBranchId, \"approvedChildren\", id);\r\n                })\r\n                    .single()\r\n                    .map(function (_a) {\r\n                    var id = _a.id;\r\n                    return id;\r\n                });\r\n            });\r\n        });\r\n    },\r\n    getAllDescendantIds: function (courseId) {\r\n        return db.courseBlocks.tags(courseId).idsOnly().concat(db.courseContents.tags(courseId).idsOnly()).concat(db.courseTabs.tags(courseId).idsOnly()).concat(db.tasks.tags(courseId).idsOnly())\r\n            .map(function (x) { return x.id; });\r\n    }\r\n};\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","export var users = [{\r\n        displayName: \"Administratör\",\r\n        mail: \"vemendo@kedschools.com\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"admin\"\r\n    }, {\r\n        displayName: \"David\",\r\n        mail: \"david.fahlander@vemendo.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"david\",\r\n        schoolGrade: 2\r\n    },\r\n    {\r\n        displayName: \"Andrei\",\r\n        mail: \"andrei.spatarelu@vemendo.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE', 'STUDENT'],\r\n        school: 'KED',\r\n        username: \"andrei\",\r\n        schoolGrade: 7\r\n    }, {\r\n        displayName: \"Carl Holmberg\",\r\n        mail: \"carl.holmberg@kunskapsgymnasiet.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'Norrköping',\r\n        username: \"carl.holmberg@kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Carl\",\r\n        mail: \"carl@kedschools.com\",\r\n        roles: ['ADMIN', 'EMPLOYEE', 'STUDENT'],\r\n        school: 'KED',\r\n        username: \"carl\"\r\n    }, {\r\n        displayName: \"david.fahlander@kedschools.com\",\r\n        mail: \"david.fahlander@kedschools.com\",\r\n        roles: [\"ADMIN\", \"EMPLOYEE\", \"STUDENT\"],\r\n        school: \"KED\",\r\n        username: \"david.fahlander@kedschools.com\"\r\n    }, {\r\n        displayName: \"Teacher 1\",\r\n        mail: \"teacher1.classroom@kedschools.com\",\r\n        roles: ['EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"teacher1.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 3\",\r\n        mail: \"student3.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student3.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 13\",\r\n        mail: \"student13.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student13.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 24\",\r\n        mail: \"student24.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student24.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev1\",\r\n        mail: \"ubw6757@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"ubw6757@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev2\",\r\n        mail: \"ums4302@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"ums4302@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev3\",\r\n        mail: \"uhh3460@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"uhh3460@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev4(fel goals issue)\",\r\n        mail: \"umt6826@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"umt6826@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev5(future abilities)\",\r\n        mail: \"ujg3833@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"ujg3833@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev6(future abilities)\",\r\n        mail: \"ujt1363@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"ujt1363@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Lärare1\",\r\n        mail: \"rickard.albertsson@kunskapsgymnasiet.se\",\r\n        roles: ['EMPLOYEE'],\r\n        school: 'Uppsala',\r\n        username: \"rickard.albertsson@kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"EDSTestUserGymnasium\",\r\n        mail: \"uhh3200@edu.kunskapsgymnasiet.se\",\r\n        //mail: \"UHH3200@EDU.KUNSKAPSGYMNASIET.SE\",\r\n        roles: [\"STUDENT\"],\r\n        username: \"EDSTestUser1\",\r\n        school: \"KED\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"vemendo.elev@kedschools.com\",\r\n        mail: \"vemendo.elev@kedschools.com\",\r\n        roles: [\"STUDENT\"],\r\n        username: \"vemendo.elev@kedschools.com\",\r\n        school: \"KED\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Medarbetare Nacka\",\r\n        mail: \"medarbetare.nacka@kunskapsskolan.se\",\r\n        roles: [\"EMPLOYEE\"],\r\n        username: \"medarbetare.nacka/KS\",\r\n        school: \"Nacka\",\r\n        schoolType: \"Grundskolor\"\r\n    }, {\r\n        displayName: \"Medarbetare Globen\",\r\n        mail: \"medarbetare.globen@kunskapsgymnasiet.se\",\r\n        roles: [\"EMPLOYEE\"],\r\n        username: \"medarbetare.globen/KS\",\r\n        school: \"Globen\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Elev Globen\",\r\n        mail: \"elev.globen@edu.kunskapsgymnasiet.se\",\r\n        schoolGrade: 2,\r\n        roles: ['STUDENT'],\r\n        username: \"elev.globen\",\r\n        school: \"Globen\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Elev Borås\",\r\n        mail: \"elev.boras@edu.kunskapsskolan.se\",\r\n        schoolGrade: 7,\r\n        roles: ['STUDENT'],\r\n        username: \"elev.boras\",\r\n        school: \"Borås\",\r\n        schoolType: \"Grundskolor\"\r\n    }, {\r\n        displayName: \"Elev Borlänge\",\r\n        mail: \"elev.borlange@edu.kunskapsskolan.se\",\r\n        schoolGrade: 9,\r\n        roles: ['STUDENT'],\r\n        username: 'elev.borlange/KS',\r\n        school: 'Borlänge',\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Roll-lös\",\r\n        mail: \"none@kunskapsskolan.se\",\r\n        username: \"none\",\r\n        roles: []\r\n    }];\r\n","import env from '../globals/KED.env';\r\nimport { users } from './data/users';\r\nimport { parseQueryString } from '../utils/query-string';\r\nvar username = parseQueryString(location.search).user;\r\nif (username) {\r\n    var user = users.find(function (u) { return u.username === username; });\r\n    if (user) {\r\n        env.currentUser = user;\r\n    }\r\n}\r\nvar _a = parseQueryString(location.search, { toLower: true }), role = _a.role, school = _a.school, schoolgrade = _a.schoolgrade;\r\nif (env.currentUser) {\r\n    if (role) {\r\n        env.currentUser.roles = role.split(',');\r\n    }\r\n    if (school) {\r\n        env.currentUser.school = school;\r\n    }\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\n// <Initialization>\r\nimport './set-current-user'; // Emulate server-side script to set current user\r\nimport '../global-setters/set-all'; // Client-side initialization\r\n// </Initialization>\r\nimport env from '../globals/KED.env';\r\nimport * as React from 'react';\r\nimport { ChooseUser } from './utils/choose-user';\r\nimport { includeCSS } from './utils/include-css';\r\nimport { includeOptionalCSS } from '../utils/include-optional-css';\r\nimport { SubjectPlannerAdminApp } from '../components/course-builder-ks/admin';\r\nimport { LanguageContext } from '../components/utility-components/LanguageContext';\r\nimport { injectIntl } from 'react-intl';\r\nimport { setupIntl } from '../components/utility-components/SetupLanguageIntl';\r\nincludeOptionalCSS({\r\n    v1: [\r\n        'css/courseviewer.css',\r\n        'css/dialog.css',\r\n        'css/grid-css-patch.css'\r\n    ],\r\n    includeCSS: includeCSS,\r\n    version: 7,\r\n    NOCSS: '6',\r\n    versionFolder: 'css/delta-css/courseviewer'\r\n});\r\nvar _App = /** @class */ (function (_super) {\r\n    tslib_1.__extends(_App, _super);\r\n    function _App(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        if (!location.hash)\r\n            location.hash = \"#/\";\r\n        return _this;\r\n    }\r\n    _App.prototype.render = function () {\r\n        var intl = this.props.intl;\r\n        return env.currentUser ?\r\n            React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n                React.createElement(SubjectPlannerAdminApp, null)) :\r\n            React.createElement(ChooseUser, null);\r\n    };\r\n    return _App;\r\n}(React.Component));\r\nvar App = setupIntl(injectIntl(_App));\r\nexport default App;\r\n","import * as React from 'react';\r\nimport { users } from '../data/users';\r\nexport function ChooseUser() {\r\n    var select;\r\n    return React.createElement(\"div\", { className: \"sv-layout\" },\r\n        React.createElement(\"h2\", null, \"V\\u00E4lj anv\\u00E4ndare\"),\r\n        React.createElement(\"table\", { className: \"login-table\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null,\r\n                    React.createElement(\"th\", null, \"Namn\"),\r\n                    React.createElement(\"th\", null, \"Roller\"),\r\n                    React.createElement(\"th\", null, \"E-post\"),\r\n                    React.createElement(\"th\", null, \"Skola\"))),\r\n            React.createElement(\"tbody\", null, users.map(function (_a) {\r\n                var username = _a.username, displayName = _a.displayName, mail = _a.mail, school = _a.school, roles = _a.roles;\r\n                return React.createElement(\"tr\", { key: mail, onClick: function () { return location.search = \"?user=\" + username; } },\r\n                    React.createElement(\"td\", null, displayName),\r\n                    React.createElement(\"td\", { style: roles.length === 0 ? { fontStyle: 'italic' } : {} }, roles.length === 0 ? \"saknar roller\" : roles.join(', ')),\r\n                    React.createElement(\"td\", null, mail),\r\n                    React.createElement(\"td\", { style: school ? {} : { fontStyle: 'italic' } }, school || \"saknar skola\"));\r\n            }))));\r\n}\r\n;\r\n","function resolve(uri) {\r\n    var href = location.protocol + \"//\" + location.host + location.pathname;\r\n    var pLastSlash = href.lastIndexOf('/');\r\n    return href.substr(0, pLastSlash + 1) + uri;\r\n}\r\nexport function includeCSS(cssFile) {\r\n    document.write('<link rel=\"stylesheet\" href=\"' + resolve(cssFile) + '\" />');\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { db } from '../globals/db';\r\nimport { RemoveItem } from '../components/course-builder/sub-components/remove-item';\r\nvar ErrorSuccessFeedback = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ErrorSuccessFeedback, _super);\r\n    function ErrorSuccessFeedback(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            errors: [],\r\n            infos: []\r\n        };\r\n        _this._unhandledRejection = _this._unhandledRejection.bind(_this);\r\n        _this._error = _this._error.bind(_this);\r\n        _this._customError = _this._customError.bind(_this);\r\n        _this._onInfo = _this._onInfo.bind(_this);\r\n        _this._dbWriterError = _this._dbWriterError.bind(_this);\r\n        _this._dbWriterStateChanged = _this._dbWriterStateChanged.bind(_this);\r\n        return _this;\r\n    }\r\n    ErrorSuccessFeedback.prototype._addError = function (message, details, retryable) {\r\n        var _this = this;\r\n        //console.error(message, {retryable: !!retryable, details});\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            if (errors.some(function (e) { return e.message === message; }))\r\n                return { errors: errors };\r\n            if (errors.length > 2)\r\n                errors = errors.slice(1);\r\n            return {\r\n                errors: errors.concat([{ message: message, details: details, retryable: retryable }])\r\n            };\r\n        });\r\n        // Remove non-retryable errors after 30 seconds:\r\n        if (!retryable)\r\n            setTimeout(function () {\r\n                _this.setState(function (_a) {\r\n                    var errors = _a.errors;\r\n                    return ({\r\n                        errors: errors.filter(function (e) { return e.message !== message; })\r\n                    });\r\n                });\r\n            }, 30000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._addInfo = function (message) {\r\n        var _this = this;\r\n        if (message === \"\") {\r\n            // Turn off current info messages\r\n            this.setState({ infos: [] });\r\n            return;\r\n        }\r\n        this.setState(function (_a) {\r\n            var infos = _a.infos;\r\n            if (infos.some(function (info) { return info === message; }))\r\n                return { infos: infos };\r\n            if (infos.length > 1)\r\n                infos = infos.slice(1);\r\n            return {\r\n                infos: [message] // was: infos.concat(message). But it sucks!\r\n            };\r\n        });\r\n        // Remove info message after 10 seconds:\r\n        setTimeout(function () {\r\n            _this.setState(function (_a) {\r\n                var infos = _a.infos;\r\n                return ({\r\n                    infos: infos.filter(function (msg) { return msg !== message; })\r\n                });\r\n            });\r\n        }, 10000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterError = function (error, retryable) {\r\n        this._addError(\"Det g\\u00E5r inte att spara till servern\", error, retryable);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterStateChanged = function (_a) {\r\n        var isEdited = _a.isEdited, isSaving = _a.isSaving;\r\n        if (!isEdited) {\r\n            // If isEdited is false, a successful write must have happened, and\r\n            // there cannot be any retryable error anymore\r\n            this.setState(function (_a) {\r\n                var errors = _a.errors;\r\n                errors = errors.filter(function (e) { return !e.retryable; });\r\n                return { errors: errors };\r\n            });\r\n        }\r\n        this.setState({\r\n            dbWriterIsEdited: isEdited,\r\n            dbWriterIsSaving: isSaving\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentDidMount = function () {\r\n        window.addEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.addEventListener('error', this._error);\r\n        window.addEventListener('customerror', this._customError);\r\n        window.addEventListener('info', this._onInfo);\r\n        db.writer.onError(this._dbWriterError);\r\n        db.writer.onStateChange(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentWillUnmount = function () {\r\n        window.removeEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.removeEventListener('error', this._error);\r\n        window.removeEventListener('customerror', this._customError);\r\n        window.removeEventListener('info', this._onInfo);\r\n        db.writer.off(this._dbWriterError);\r\n        db.writer.off(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype._unhandledRejection = function (ev) {\r\n        this._addError(\"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.reason);\r\n    };\r\n    ErrorSuccessFeedback.prototype._error = function (ev) {\r\n        this._addError(ev.error ? ev.error.message : \"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.error);\r\n    };\r\n    ErrorSuccessFeedback.prototype._customError = function (ev) {\r\n        this._addError(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype._onInfo = function (ev) {\r\n        this._addInfo(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, errors = _a.errors, infos = _a.infos, dbWriterIsSaving = _a.dbWriterIsSaving;\r\n        return React.createElement(\"div\", { className: \"error-success-feedback\", style: {\r\n                position: \"fixed\",\r\n                left: 0,\r\n                top: 0,\r\n                width: \"100%\",\r\n                pointerEvents: 'none'\r\n            } },\r\n            React.createElement(\"div\", { style: { display: 'table', margin: \"0 auto\" } },\r\n                errors.filter(function (e) { return !e.retryable || !dbWriterIsSaving; })\r\n                    .map(function (_a) {\r\n                    var message = _a.message, details = _a.details, retryable = _a.retryable, showDetails = _a.showDetails;\r\n                    return (React.createElement(\"div\", { key: message, className: \"error\" },\r\n                        React.createElement(\"div\", { style: { float: 'left' } }, message),\r\n                        React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            React.createElement(RemoveItem, { onClick: function () { return _this.removeError(message); } })),\r\n                        details || retryable ? React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            details ? React.createElement(React.Fragment, null,\r\n                                React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.toggleDetails(message); } }, showDetails ? \"Dölj detailer\" : \"Visa detailjer\"),\r\n                                \"\\u00A0\") : undefined,\r\n                            showDetails ? React.createElement(\"p\", null, '' + details) : React.createElement(React.Fragment, null, \"\\u00A0\"),\r\n                            retryable ? React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.retrySave(); } }, \"F\\u00F6rs\\u00F6k spara nu\") : undefined) : undefined));\r\n                }),\r\n                infos.map(function (message) {\r\n                    return React.createElement(\"p\", { key: message, className: \"info\" }, message);\r\n                })));\r\n    };\r\n    ErrorSuccessFeedback.prototype.removeError = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({\r\n                errors: errors.filter(function (e) { return e.message !== message; })\r\n            });\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.retrySave = function () {\r\n        db.writer.retrySave();\r\n    };\r\n    ErrorSuccessFeedback.prototype.toggleDetails = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({ errors: errors.map(function (error) { return error.message === message ? tslib_1.__assign({}, error, { showDetails: !error.showDetails }) :\r\n                    error; })\r\n            });\r\n        });\r\n    };\r\n    return ErrorSuccessFeedback;\r\n}(React.Component));\r\nexport { ErrorSuccessFeedback };\r\n","export function includeOptionalCSS(_a) {\r\n    var v1 = _a.v1, versionFolder = _a.versionFolder, version = _a.version, includeCSS = _a.includeCSS, NOCSS = _a.NOCSS;\r\n    if (!NOCSS) {\r\n        if (v1)\r\n            v1.forEach(function (cssFile) { return includeCSS(cssFile); });\r\n    }\r\n    var cssVer = parseInt(NOCSS);\r\n    if (isNaN(cssVer))\r\n        cssVer = 1;\r\n    for (var ver = cssVer + 1; ver <= version; ++ver) {\r\n        includeCSS(versionFolder + \"/v\" + ver + \".css\");\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar DEFAULT_CACHE_EXPIRATION = 30 * 60 * 1000; // 30 minutes.\r\nvar defaultOptions = {\r\n    isApiMethod: function (f) { return typeof f === 'function'; },\r\n    cacheExpiration: DEFAULT_CACHE_EXPIRATION\r\n};\r\nexport function makeSuspenseApi(api, options) {\r\n    if (options === void 0) { options = defaultOptions; }\r\n    options = tslib_1.__assign({}, defaultOptions, options);\r\n    var isApiMethod = options.isApiMethod, cacheExpiration = options.cacheExpiration;\r\n    var rv = Object.create(api);\r\n    var cache = {};\r\n    // Walk the instance + prototype chain to generate suspense version of each promise returning method\r\n    for (var proto = api; proto && proto !== Object.prototype; proto = Object.getPrototypeOf(proto)) {\r\n        suspendify(proto);\r\n    }\r\n    function suspendify(proto) {\r\n        Object.keys(proto).forEach(function (prop) {\r\n            if (!rv.hasOwnProperty(prop) && isApiMethod(prop)) {\r\n                rv[prop] = function () {\r\n                    var args = [];\r\n                    for (var _i = 0; _i < arguments.length; _i++) {\r\n                        args[_i] = arguments[_i];\r\n                    }\r\n                    var key = JSON.stringify(tslib_1.__spread([prop], args));\r\n                    var cachedEntry = cache[key];\r\n                    if (cachedEntry !== undefined) {\r\n                        if (cachedEntry.promise)\r\n                            throw cachedEntry.promise;\r\n                        if (cachedEntry.error)\r\n                            throw cachedEntry.error;\r\n                        if (cachedEntry.timeout > Date.now()) {\r\n                            return cachedEntry.value;\r\n                        }\r\n                    }\r\n                    try {\r\n                        var promise = proto[prop].apply(api, args).then(function (result) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, value: result };\r\n                        }).catch(function (error) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                        });\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, promise: promise };\r\n                        throw promise;\r\n                    }\r\n                    catch (error) {\r\n                        if (error.then)\r\n                            throw error;\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                    }\r\n                };\r\n            }\r\n        });\r\n    }\r\n    return rv;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nexport function parseQueryString(locationSearch, options) {\r\n    var toLower = (options || {}).toLower;\r\n    var result = {};\r\n    if (locationSearch && locationSearch.length > 1)\r\n        locationSearch.substr(1)\r\n            .split('&')\r\n            .map(function (part) { return part.split('=').map(function (s) { return decodeURIComponent(s.trim()); }); })\r\n            .forEach(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];\r\n            return result[toLower ? key.toLowerCase() : key] = value;\r\n        });\r\n    return result;\r\n}\r\nfunction encodeParams(params) {\r\n    return Object.keys(params).filter(function (key) { return params[key] !== undefined; }).map(function (key) { return encodeURIComponent(key) + \"=\" + encodeURIComponent(params[key]); }).join('&');\r\n}\r\nexport function generateQueryString(params) {\r\n    return \"?\" + encodeParams(params);\r\n}\r\nexport function parseHashQueryString(locationHash, options) {\r\n    return parseQueryString(locationHash, options);\r\n}\r\nexport function generateHashQueryString(params) {\r\n    return \"#\" + encodeParams(params);\r\n}\r\nexport function splitUrlAndQuery(urlWithPossibleQuery) {\r\n    var pQuery = urlWithPossibleQuery.indexOf('?');\r\n    return pQuery >= 0 ?\r\n        [urlWithPossibleQuery.substr(0, pQuery), urlWithPossibleQuery.substr(pQuery)] :\r\n        [urlWithPossibleQuery, \"\"];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nexport function getFirstAndLastWeekOfTerm(term) {\r\n    return term === 'AT' ?\r\n        [32, 51] :\r\n        [1, 25];\r\n}\r\n//Not used anymore\r\n// export function getTermStartAndEnd(now: moment.Moment) : moment.Moment[] {\r\n//     return now.month() >= 6 ? // 6 = July in JS Dates and in moment as well!\r\n//     [moment(new Date(now.year(), 7, 1)), moment(new Date(now.year(), 11, 31))] : // aug1 - dec31\r\n//     [moment(new Date(now.year(), 0, 1)), moment(new Date(now.year(), 6, 31))]; // jan1 - july31\r\n// }\r\nexport function getTermStarEndDate(date, isFirstTerm) {\r\n    var addYear = date.getMonth() >= 7;\r\n    var termYear = null;\r\n    if (addYear) {\r\n        termYear = isFirstTerm ? date.getFullYear() : date.getFullYear() + 1;\r\n    }\r\n    else {\r\n        termYear = isFirstTerm ? date.getFullYear() - 1 : date.getFullYear();\r\n    }\r\n    var termYearMoment = moment(termYear.toString(), \"YYYY\");\r\n    if (termYearMoment.week() != 1) {\r\n        termYearMoment = termYearMoment.clone().add(1, 'week');\r\n    }\r\n    return isFirstTerm ? [moment(termYearMoment.clone()).week(32).startOf('week'), moment(termYearMoment.clone()).week(51).endOf('week')] :\r\n        [moment(termYearMoment.clone()), moment(termYearMoment.clone()).week(25).endOf('week')];\r\n}\r\nexport function getSchoolMoment(m) {\r\n    var thisYear = m.year();\r\n    var isAutumn = m.month() >= 6; // determine \r\n    var _a = tslib_1.__read(isAutumn ?\r\n        [thisYear, thisYear + 1] :\r\n        [thisYear - 1, thisYear], 2), autumnYear = _a[0], springYear = _a[1];\r\n    var academicYear = '' + autumnYear + '/' + springYear;\r\n    var term = isAutumn ? 'AT' : 'ST';\r\n    var week = m.week();\r\n    return { academicYear: academicYear, term: term, week: week };\r\n}\r\nexport function addYear(aYear, numYearsToAdd) {\r\n    return aYear.split('/')\r\n        .map(function (yearStr) { return parseInt(yearStr) + numYearsToAdd; })\r\n        .map(function (year) { return '' + year; })\r\n        .join('/');\r\n}\r\nexport function nextAcademicYear(aYear) {\r\n    return addYear(aYear, 1);\r\n}\r\nexport function prevAcademicYear(aYear) {\r\n    return addYear(aYear, -1);\r\n}\r\n","import moment from 'moment';\r\nimport { getSchoolMoment, addYear } from './school-moment';\r\nfunction isSchoolMoment(obj) {\r\n    return 'academicYear' in obj;\r\n}\r\nvar SchoolTerm = /** @class */ (function () {\r\n    function SchoolTerm(dateOrSchoolMoment) {\r\n        var schoolMoment = isSchoolMoment(dateOrSchoolMoment) ?\r\n            dateOrSchoolMoment : getSchoolMoment(moment(dateOrSchoolMoment));\r\n        this.academicYear = schoolMoment.academicYear;\r\n        this.term = schoolMoment.term;\r\n    }\r\n    Object.defineProperty(SchoolTerm.prototype, \"year\", {\r\n        get: function () {\r\n            return parseInt(this.academicYear\r\n                .split('/')[this.term === 'AT' ? 0 : 1]);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    SchoolTerm.prototype.nextTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: this.academicYear\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: addYear(this.academicYear, 1)\r\n            });\r\n    };\r\n    SchoolTerm.prototype.prevTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: addYear(this.academicYear, -1)\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: this.academicYear\r\n            });\r\n    };\r\n    SchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\r\n        var year = this.term === 'AT' ?\r\n            this.academicYear.split('/')[0] :\r\n            this.academicYear.split('/')[1];\r\n        if (shortYear)\r\n            year = year.substr(2);\r\n        return this.term === 'AT' ? intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'HT {year}' }, { year: year }) :\r\n            intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'VT {year}' }, { year: year });\r\n    };\r\n    return SchoolTerm;\r\n}());\r\nexport { SchoolTerm };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function capitalizeFirst(str) {\r\n    for (var i = 0, l = str.length; i < l; ++i) {\r\n        if (str.charCodeAt(i) < 0x2000) {\r\n            return str.substr(0, i) + str[i].toLocaleUpperCase() + str.substr(i + 1);\r\n        }\r\n    }\r\n    return str;\r\n}\r\nexport function extend(obj, extension) {\r\n    if (typeof extension !== 'object')\r\n        return obj;\r\n    Object.keys(extension).forEach(function (key) {\r\n        obj[key] = extension[key];\r\n    });\r\n    return obj;\r\n}\r\nexport function clone(obj, extension) {\r\n    var clone = {};\r\n    Object.getOwnPropertyNames(obj).forEach(function (key) {\r\n        Object.defineProperty(clone, key, Object.getOwnPropertyDescriptor(obj, key));\r\n    });\r\n    if (extension)\r\n        extend(clone, extension);\r\n    return clone;\r\n}\r\nvar concat = [].concat;\r\nexport function flatten(a) {\r\n    return concat.apply([], a);\r\n}\r\nexport function compareProp(prop) {\r\n    return function (a, b) {\r\n        var aProp = a[prop], bProp = b[prop];\r\n        return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n    };\r\n}\r\nexport function compareProps(props, locales, options) {\r\n    props = Array.isArray(props) ? props : [props];\r\n    var localeCompare = function (a, b) {\r\n        return typeof a === 'string' ?\r\n            a.localeCompare(b, locales, options) :\r\n            a < b ? -1 : a > b ? 1 : 0;\r\n    };\r\n    function cmpPart(a, b, firstPart, rest) {\r\n        var firstA = a[firstPart];\r\n        var firstB = b[firstPart];\r\n        if (firstA === firstB)\r\n            return 0;\r\n        if (firstA == null)\r\n            return -1;\r\n        if (firstB == null)\r\n            return 1;\r\n        return rest.length === 0 ?\r\n            localeCompare(firstA, firstB) :\r\n            cmpPart(firstA, firstB, rest[0], rest.slice(1));\r\n    }\r\n    return props\r\n        .map(function (prop) { return prop.split('.'); })\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a), firstPart = _b[0], rest = _b.slice(1);\r\n        return function (a, b) { return cmpPart(a, b, firstPart, rest); };\r\n    })\r\n        .reduce(function (cmp1, cmp2) {\r\n        return function (a, b) { return cmp1(a, b) || cmp2(a, b); };\r\n    });\r\n}\r\nexport function L(text) {\r\n    var args = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        args[_i - 1] = arguments[_i];\r\n    }\r\n    var first = text[0];\r\n    return buildMessage(text, args);\r\n}\r\nfunction buildMessage(text, args) {\r\n    var rv = text[0];\r\n    for (var i = 1, l = text.length; i < l; ++i) {\r\n        rv += args[i - 1] + text[i];\r\n    }\r\n    return rv;\r\n}\r\nvar TC = /** @class */ (function () {\r\n    function TC(template) {\r\n        extend(this, template);\r\n    }\r\n    return TC;\r\n}());\r\nexport { TC };\r\nexport function dateTimeReviver(key, value) {\r\n    var a;\r\n    if (typeof value === 'string') {\r\n        a = /\\/Date\\((\\d*)\\)\\//.exec(value);\r\n        if (a) {\r\n            return new Date(+a[1]);\r\n        }\r\n    }\r\n    return value;\r\n}\r\n//let infoSerial = 1;\r\nexport function showInfo(msg) {\r\n    var event = new CustomEvent('info', { 'detail': msg });\r\n    window.dispatchEvent(event);\r\n}\r\nexport function showError(errMsg) {\r\n    var msg = typeof errMsg === 'string' ? errMsg : errMsg.message;\r\n    var event = new CustomEvent('customerror', { 'detail': msg });\r\n    console.error(errMsg);\r\n    window.dispatchEvent(event);\r\n}\r\nexport function maxLength(str, maxLen) {\r\n    return str.length > maxLen ?\r\n        str.substr(0, maxLen - 3) + \"...\" :\r\n        str;\r\n}\r\nexport function arrayToLookup(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        var array = result[key];\r\n        if (array)\r\n            array.push(item);\r\n        else\r\n            result[key] = [item];\r\n    }\r\n    return result;\r\n}\r\nexport function arrayToMap(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        result[key] = item;\r\n    }\r\n    return result;\r\n}\r\nexport function cherryPickProps(obj, propsToPick) {\r\n    var e_1, _a;\r\n    var result = {};\r\n    try {\r\n        for (var propsToPick_1 = tslib_1.__values(propsToPick), propsToPick_1_1 = propsToPick_1.next(); !propsToPick_1_1.done; propsToPick_1_1 = propsToPick_1.next()) {\r\n            var param = propsToPick_1_1.value;\r\n            if (param in obj)\r\n                result[param] = obj[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (propsToPick_1_1 && !propsToPick_1_1.done && (_a = propsToPick_1.return)) _a.call(propsToPick_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\nexport function distinct(a, keyAccessor) {\r\n    var map = arrayToMap(a, keyAccessor || (function (x) { return x; }));\r\n    return Object.keys(map).map(function (key) { return map[key]; });\r\n}\r\nexport function shallowEquals(a, b) {\r\n    if (a === b)\r\n        return true;\r\n    if (!a || !b)\r\n        return false;\r\n    if (typeof a !== 'object' || typeof b !== 'object')\r\n        return false;\r\n    var keysA = Object.keys(a);\r\n    var keysB = Object.keys(b);\r\n    if (keysA.length !== keysB.length)\r\n        return false;\r\n    for (var i = 0, l = keysA.length; i < l; ++i) {\r\n        var key = keysA[i];\r\n        if (keysB[i] !== key)\r\n            return false;\r\n        if (a[key] !== b[key])\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AClBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACnPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC1FA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/JA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3NA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9NA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjCA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACPA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACrVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5FA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpGA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3CA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjEA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3MA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpMA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACltBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzCA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/cA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrQA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACfA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnKA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxKA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}