{"version":3,"file":"TutorsSelect.js","sources":["webpack://[name]/./src/components/tutors-select/tutors-select.tsx","webpack://[name]/./src/repos/kg-termplanner-repo.ts","webpack://[name]/./src/utils/request-tutored-tokens.ts"],"sourcesContent":["import { __assign, __awaiter, __extends, __generator } from \"tslib\";\nimport env from '../../globals/KED.env';\nimport React from 'react';\nimport { compareProps } from '../../utils/utils';\nimport { Spinner } from '../course-builder/sub-components/spinner';\nimport tutorEnv from '../../globals/KED.tutorEnv';\nimport { requestTutoredTokens } from '../../utils/request-tutored-tokens';\nvar TutorsSelect = /** @class */ (function (_super) {\n    __extends(TutorsSelect, _super);\n    function TutorsSelect(props) {\n        var _this = _super.call(this, props) || this;\n        _this.state = {\n            isLoading: true,\n            students: []\n        };\n        return _this;\n    }\n    TutorsSelect.prototype.componentDidMount = function () {\n        this.load();\n    };\n    TutorsSelect.prototype.load = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var edsStudents, students, error_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 3, 5, 6]);\n                        return [4 /*yield*/, env.edsClient.getTeacherTutorStudents()];\n                    case 1:\n                        edsStudents = _a.sent();\n                        edsStudents.sort(compareProps([\"lastName\", \"firstName\"]));\n                        students = edsStudents.length > 0 ?\n                            edsStudents.map(function (_a) {\n                                var email = _a.email, firstName = _a.firstName, lastName = _a.lastName;\n                                return ({\n                                    mail: email,\n                                    displayName: firstName + \" \" + lastName\n                                });\n                            }) :\n                            [env.currentUser];\n                        return [4 /*yield*/, this.setState({ students: students })];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 3:\n                        error_1 = _a.sent();\n                        console.error(\"Could not list tutor students\", error_1);\n                        return [4 /*yield*/, this.setState({ students: [env.currentUser] })];\n                    case 4:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 5:\n                        this.setState({ isLoading: false });\n                        return [7 /*endfinally*/];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    TutorsSelect.prototype.onSelectUser = function (email) {\n        var choosenStudent = this.state.students.filter(function (s) { return s.mail === email; })[0];\n        var user = __assign(__assign({}, choosenStudent), { roles: [\"USER\"] });\n        tutorEnv.setNewEnv(user, function () { return requestTutoredTokens(email, email); });\n    };\n    TutorsSelect.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, isLoading = _a.isLoading, students = _a.students;\n        if (isLoading)\n            return React.createElement(Spinner, null);\n        return React.createElement(\"div\", { className: \"tutors-select\" },\n            React.createElement(\"select\", { onChange: function (ev) { return ev.target.value && _this.onSelectUser(ev.target.value); } },\n                React.createElement(\"option\", { value: \"\" }, \"V\\u00E4lj elev\"),\n                students.map(function (student) {\n                    return React.createElement(\"option\", { key: student.mail, value: student.mail },\n                        student.displayName,\n                        \" (\",\n                        student.mail,\n                        \")\");\n                })));\n    };\n    return TutorsSelect;\n}(React.Component));\nexport { TutorsSelect };\n","import { __awaiter, __extends, __generator, __read } from \"tslib\";\nimport { KedRepo } from './ked-repo';\nimport env from '../globals/KED.env';\nimport { getTermStarEndDate } from '../utils/school-moment';\nvar KGTermPlannerRepo = /** @class */ (function (_super) {\n    __extends(KGTermPlannerRepo, _super);\n    function KGTermPlannerRepo(getClient, getCurrentUser) {\n        var _this = this;\n        var currentUser = getCurrentUser();\n        var now = new Date();\n        var _a = __read(getTermStarEndDate(now, now.getMonth() >= 7), 2), termStart = _a[0], termEnd = _a[1];\n        _this = _super.call(this, {\n            getClient: getClient,\n            optimistic: true,\n            table: \"weekplans\",\n            user: currentUser ? currentUser.mail : \"\",\n            getQueryOptions: function () { return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                    return [2 /*return*/, {\n                            from: termStart.startOf('week').add(-2, 'days').toDate().valueOf(),\n                            to: termEnd.startOf('week').add(5, 'days').toDate().valueOf(),\n                            role: \"USER\"\n                        }];\n                });\n            }); }\n        }) || this;\n        return _this;\n    }\n    return KGTermPlannerRepo;\n}(KedRepo));\nexport { KGTermPlannerRepo };\nexport var termPlannerRepo = new KGTermPlannerRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\nenv.kgTermPlannerRepo = termPlannerRepo;\n","import { __awaiter, __generator } from \"tslib\";\nimport env from '../globals/KED.env';\nimport cfg from '../globals/KED.cfg';\nimport { KedBackendClient, HttpError } from 'kedbackend/client';\nimport { EdsClient } from '../apis/edsclient';\nimport { isomorphic } from 'kedbackend/clientweb';\nimport { KSTermPlannerRepo } from '../repos/ks-termplanner-repo';\nimport { KGTermPlannerRepo } from '../repos/kg-termplanner-repo';\nimport { UserTasksRepo } from '../repos/user-tasks-repo';\nexport function requestTutoredTokens(userEmail, displayName) {\n    return __awaiter(this, void 0, void 0, function () {\n        function createBearerProvider(client, tokenUrl, query) {\n            var bearerPromise = null;\n            return {\n                getBearer: function () {\n                    return bearerPromise || this.refreshBearer();\n                },\n                refreshBearer: function () {\n                    return (bearerPromise = retrieveToken());\n                },\n            };\n            function retrieveToken() {\n                return __awaiter(this, void 0, void 0, function () {\n                    var res, _a, _b, _c;\n                    return __generator(this, function (_d) {\n                        switch (_d.label) {\n                            case 0: return [4 /*yield*/, client.get(tokenUrl, query)];\n                            case 1:\n                                res = _d.sent();\n                                if (!(res.status === 200)) return [3 /*break*/, 3];\n                                return [4 /*yield*/, res.json()];\n                            case 2: return [2 /*return*/, (_d.sent())];\n                            case 3:\n                                _a = HttpError.bind;\n                                _b = [void 0, res.status];\n                                _c = \"Could not retrieve tutor token for \" +\n                                    userEmail +\n                                    \". Error Message: \";\n                                return [4 /*yield*/, res.text()];\n                            case 4: throw new (_a.apply(HttpError, _b.concat([_c + (_d.sent())])))();\n                        }\n                    });\n                });\n            }\n        }\n        var currentUser, bearerProvider, tutoredKedBackendClient, googleTokenProvider, edsClient, tutorEnv;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    currentUser = {\n                        mail: userEmail,\n                        displayName: displayName,\n                        roles: [\"USER\"],\n                        school: env.currentUser.school,\n                        tutorFor: userEmail\n                    };\n                    bearerProvider = createBearerProvider(env.kedBackendClient.http, \"tutor/token\", { userEmail: userEmail });\n                    tutoredKedBackendClient = new KedBackendClient(isomorphic, bearerProvider, cfg.KED_API_URL);\n                    googleTokenProvider = createBearerProvider(tutoredKedBackendClient.http, \"tutor/convert-token/google\");\n                    edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, bearerProvider, function () { return userEmail; });\n                    tutorEnv = {\n                        currentUser: currentUser,\n                        bearerProvider: bearerProvider,\n                        edsClient: edsClient,\n                        googleTokenProvider: googleTokenProvider,\n                        kedBackendClient: tutoredKedBackendClient,\n                        tutored: true\n                    };\n                    tutorEnv.ksTermPlannerRepo = new KSTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    tutorEnv.kgTermPlannerRepo = new KGTermPlannerRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    tutorEnv.userTasksRepo = new UserTasksRepo(function () { return tutoredKedBackendClient; }, function () { return currentUser; });\n                    return [4 /*yield*/, bearerProvider.getBearer().catch(function (error) {\n                            console.error(error);\n                        })];\n                case 1:\n                    _a.sent();\n                    return [2 /*return*/, tutorEnv];\n            }\n        });\n    });\n}\n"],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;A","sourceRoot":""}