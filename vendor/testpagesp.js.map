{"version":3,"file":"testpagesp.js","sources":["webpack://[name]/webpack/bootstrap","webpack://[name]/./kedbackend/client.js","webpack://[name]/./kedbackend/clientweb.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/bearer-storage-sessionstorage.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/hash-restorer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/access-control.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/http-error.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/ked-bearer-provider.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/restclient.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/cache-bust.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/apply-mutations-on-deltas.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-cache.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-merge.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-query.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-repo.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-subscription.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-writer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/mutation-queue.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/query-set.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-course.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-task.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate.js","webpack://[name]/./kedbackend/js/dist/js/observable/collection.js","webpack://[name]/./kedbackend/js/dist/js/observable/emitter.js","webpack://[name]/./kedbackend/js/dist/js/observable/fiber-context.js","webpack://[name]/./kedbackend/js/dist/js/observable/index.js","webpack://[name]/./kedbackend/js/dist/js/observable/map.js","webpack://[name]/./kedbackend/js/dist/js/observable/mixin.js","webpack://[name]/./kedbackend/js/dist/js/observable/observable.js","webpack://[name]/./kedbackend/js/dist/js/observable/value.js","webpack://[name]/./kedbackend/observable.js","webpack://[name]/./kedbackend/repo.js","webpack://[name]/./src/access-control/get-user-claims.ts","webpack://[name]/./src/access-control/index.ts","webpack://[name]/./src/apis/buttons.tsx","webpack://[name]/./src/apis/configs.ts","webpack://[name]/./src/apis/edsclient.ts","webpack://[name]/./src/apis/google-client.ts","webpack://[name]/./src/apis/google-drive.ts","webpack://[name]/./src/apis/google-picker.ts","webpack://[name]/./src/apis/google-webclient.ts","webpack://[name]/./src/apis/mock/mock-classroom-data.ts","webpack://[name]/./src/components/calendar/course-name-to-css-class.ts","webpack://[name]/./src/components/charts/charts-utils.ts","webpack://[name]/./src/components/charts/goal-progress.tsx","webpack://[name]/./src/components/charts/progress.tsx","webpack://[name]/./src/components/course-builder-ks/common/banner.tsx","webpack://[name]/./src/components/course-builder-ks/common/dialog-content.tsx","webpack://[name]/./src/components/course-builder-ks/common/dialog-context.ts","webpack://[name]/./src/components/course-builder-ks/common/field-limits.ts","webpack://[name]/./src/components/course-builder-ks/common/future-abilities-box.tsx","webpack://[name]/./src/components/course-builder-ks/common/select-word-bank.tsx","webpack://[name]/./src/components/course-builder-ks/common/two-columns-page.tsx","webpack://[name]/./src/components/course-builder-ks/logic/change-sort-order.ts","webpack://[name]/./src/components/course-builder-ks/logic/compute-task-tags-and-subject.ts","webpack://[name]/./src/components/course-builder-ks/logic/course-instance-tags.ts","webpack://[name]/./src/components/course-builder-ks/logic/get-course-codes-from-tags.ts","webpack://[name]/./src/components/course-builder-ks/logic/get-draft-id.ts","webpack://[name]/./src/components/course-builder-ks/logic/get-standard-courses-with-ordered-requirements.ts","webpack://[name]/./src/components/course-builder-ks/logic/is-employee.ts","webpack://[name]/./src/components/course-builder-ks/logic/is-ked-staff.ts","webpack://[name]/./src/components/course-builder-ks/logic/list-course-instances.ts","webpack://[name]/./src/components/course-builder-ks/logic/ordered-requirements.ts","webpack://[name]/./src/components/course-builder-ks/logic/publish-course.ts","webpack://[name]/./src/components/course-builder-ks/logic/task-order.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/add-content-button.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/add-tab-button.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/clickable-school-div.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-area.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/add-task-button.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/content-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/course-content-types.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/embedded-html.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/index.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/learning-tasks-content-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/learning-tasks-settings.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/learning-tasks-with-common-goals.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/learning-tasks-with-separate-goals.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/resource-list-view.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/rich-text.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/word-bank-content-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-contents/word-bank-content-settings.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-tab-area.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-tab-content-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-tab/tab-classes.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/course-viewer-page.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/editor-footer-buttons.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/index.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/list-courses/index.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/list-courses/student-courses-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/redirect-to-step.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/resource-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/tab-settings-admin.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/tab-settings-requirements.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/tab-settings.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/left-column/edit-requirements.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/basic-editable-task-fields.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/edit-task-form.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/introduction-text-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/task-description-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/task-embedded-html-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/task-footer-buttons.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/right-column/task-working-procedure-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/task-editor.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/texts.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/viewer/task-viewer-page.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/task/viewer/task-viewer.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/delta-view.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/deltadoc-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/deltalink-box.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/index.tsx","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/model-friendly-names.ts","webpack://[name]/./src/components/course-builder-ks/viewer-editor/version-history/version-history-box.tsx","webpack://[name]/./src/components/course-builder/courses/business-logic.ts","webpack://[name]/./src/components/course-builder/knowledge-matrix-partial-utils.ts","webpack://[name]/./src/components/course-builder/modal-pages/edit-resource.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/task-migration-box.tsx","webpack://[name]/./src/components/course-builder/sub-components/ellipsis-loader.tsx","webpack://[name]/./src/components/course-builder/sub-components/knowledge-matrix.tsx","webpack://[name]/./src/components/course-builder/sub-components/remove-item.tsx","webpack://[name]/./src/components/course-builder/sub-components/select-related-docs.tsx","webpack://[name]/./src/components/course-builder/sub-components/spinner.tsx","webpack://[name]/./src/components/course-builder/utils.ts","webpack://[name]/./src/components/course-viewer/course-page/task-assignments-table.tsx","webpack://[name]/./src/components/course-viewer/course-page/task-assignments-utils.tsx","webpack://[name]/./src/components/course-viewer/course-page/task-assignments.tsx","webpack://[name]/./src/components/course-viewer/course-page/urkund-utils.ts","webpack://[name]/./src/components/course-viewer/subcomponents/abilities-box.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/central-content-box.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/confirmation.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/knowledge-requirements-table.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/task-fileview.tsx","webpack://[name]/./src/components/course-viewer/subcomponents/task-list.tsx","webpack://[name]/./src/components/utility-components/LanguageContext.tsx","webpack://[name]/./src/components/utility-components/SetupLanguageIntl.tsx","webpack://[name]/./src/components/utility-components/align-horizontal.tsx","webpack://[name]/./src/components/utility-components/checkbox.tsx","webpack://[name]/./src/components/utility-components/checklist.tsx","webpack://[name]/./src/components/utility-components/dialogs.tsx","webpack://[name]/./src/components/utility-components/form-field-text-input.tsx","webpack://[name]/./src/components/utility-components/form-field-textarea.tsx","webpack://[name]/./src/components/utility-components/form-field.tsx","webpack://[name]/./src/components/utility-components/horizontal-item.tsx","webpack://[name]/./src/components/utility-components/lazy-content.tsx","webpack://[name]/./src/components/utility-components/live-query-view.tsx","webpack://[name]/./src/components/utility-components/loading-indicator.tsx","webpack://[name]/./src/components/utility-components/open-close-box.tsx","webpack://[name]/./src/components/utility-components/sortable-task-list.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/actions-sv.ts","webpack://[name]/./src/components/utility-components/wysiwyg/actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/exec.ts","webpack://[name]/./src/components/utility-components/wysiwyg/html-patch-policy.ts","webpack://[name]/./src/components/utility-components/wysiwyg/image-edit-actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/index.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/restore-selection.ts","webpack://[name]/./src/components/utility-components/wysiwyg/wash-html.ts","webpack://[name]/./src/components/weekplanner/add-custom-goal.tsx","webpack://[name]/./src/components/weekplanner/add-custom-task.tsx","webpack://[name]/./src/components/weekplanner/add-or-edit-sub-task.tsx","webpack://[name]/./src/components/weekplanner/edit-user-task.tsx","webpack://[name]/./src/components/weekplanner/get-task-type.ts","webpack://[name]/./src/components/weekplanner/refiner.ts","webpack://[name]/./src/components/weekplanner/user-tasks-box.tsx","webpack://[name]/./src/components/weekplanner/weekplanner-persisted-state.ts","webpack://[name]/./src/components/weekplanner/weekplanner.tsx","webpack://[name]/./src/contracts/ked-models.ts","webpack://[name]/./src/features/features.ts","webpack://[name]/./src/features/index.ts","webpack://[name]/./src/global-setters/configure.ts","webpack://[name]/./src/global-setters/set-all.ts","webpack://[name]/./src/global-setters/set-bearer-providers.ts","webpack://[name]/./src/global-setters/set-eds-client.ts","webpack://[name]/./src/global-setters/set-ked-backend-client.ts","webpack://[name]/./src/globals/KED.cfg.ts","webpack://[name]/./src/globals/KED.env.ts","webpack://[name]/./src/globals/KED.ts","webpack://[name]/./src/globals/db.ts","webpack://[name]/./src/globals/ked.ts","webpack://[name]/./src/globals/moment-sv-locale.ts","webpack://[name]/./src/repos/ked-repo.ts","webpack://[name]/./src/repos/repo.ts","webpack://[name]/./src/repos/user-tasks-repo.ts","webpack://[name]/./src/test/data/users.ts","webpack://[name]/./src/test/set-current-user.ts","webpack://[name]/./src/test/test-config.ts","webpack://[name]/./src/test/testpage-sp.tsx","webpack://[name]/./src/test/utils/choose-user.tsx","webpack://[name]/./src/test/utils/include-css.ts","webpack://[name]/./src/utils/error-success-feedback.tsx","webpack://[name]/./src/utils/include-optional-css.ts","webpack://[name]/./src/utils/keep-session-alive.ts","webpack://[name]/./src/utils/make-suspense-api.ts","webpack://[name]/./src/utils/pending-job.ts","webpack://[name]/./src/utils/query-string.ts","webpack://[name]/./src/utils/school-moment.ts","webpack://[name]/./src/utils/school-term.ts","webpack://[name]/./src/utils/utils.ts","webpack://[name]/./src/utils/weekutil.ts"],"sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"testpagesp\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp_name_\"] = window[\"webpackJsonp_name_\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([\"./src/test/testpage-sp.tsx\",\"vendors\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","export * from './js/dist/js/ked-backend-client';","export * from './js/dist/js/ked-backend-client-web';","var BearerStorageSessionStorage = /** @class */ (function () {\r\n    function BearerStorageSessionStorage() {\r\n    }\r\n    BearerStorageSessionStorage.prototype.save = function (id, tokenInfo) {\r\n        sessionStorage.setItem(\"bearer-\" + id, JSON.stringify(tokenInfo));\r\n    };\r\n    BearerStorageSessionStorage.prototype.load = function (id) {\r\n        try {\r\n            var json = sessionStorage.getItem(\"bearer-\" + id);\r\n            return Promise.resolve(json ? JSON.parse(json) : { token: null, expires: 0 });\r\n        }\r\n        catch (ex) {\r\n            return Promise.resolve({ token: null, expires: 0 });\r\n        }\r\n    };\r\n    return BearerStorageSessionStorage;\r\n}());\r\nexport { BearerStorageSessionStorage };\r\n//# sourceMappingURL=bearer-storage-sessionstorage.js.map","var redirHash = sessionStorage.getItem(\"redir-hash\");\r\nif (redirHash)\r\n    try {\r\n        var _a = JSON.parse(redirHash), time = _a.time, hash = _a.hash;\r\n        if (time && time > Date.now() - 60000) {\r\n            sessionStorage.removeItem(\"redir-hash\");\r\n            location.hash = hash;\r\n        }\r\n    }\r\n    catch (_) { }\r\nexport function rememberHashLocation() {\r\n    sessionStorage.setItem(\"redir-hash\", JSON.stringify({ time: Date.now(), hash: location.hash }));\r\n}\r\n//# sourceMappingURL=hash-restorer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendClient, HttpError } from '../ked-backend-client';\r\nimport { BearerStorageSessionStorage } from \"./bearer-storage-sessionstorage\";\r\nimport { avoidSimultanousCalls } from '../ked-backend-client/utils';\r\nimport { KedModelMigratorMixin } from '../ked-model-migrator';\r\nimport './hash-restorer';\r\nimport { rememberHashLocation } from './hash-restorer';\r\nKedModelMigratorMixin(KedBackendClient.prototype);\r\nexport var storage = new BearerStorageSessionStorage();\r\nvar timeOfPageLoad = Date.now();\r\nvar WebServerBearerProvider = /** @class */ (function () {\r\n    function WebServerBearerProvider(tokenPath, tokenResponseMapper, tokenId) {\r\n        this.tokenPath = tokenPath;\r\n        this.tokenResponseMapper = tokenResponseMapper;\r\n        this.tokenId = tokenId;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    WebServerBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!!this.tokenInfo.token) return [3 /*break*/, 2];\r\n                        if (!this.tokenId) return [3 /*break*/, 2];\r\n                        _a = this;\r\n                        return [4 /*yield*/, storage.load(this.tokenId)];\r\n                    case 1:\r\n                        _a.tokenInfo = _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        if (!(this.tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _b.sent();\r\n                        _b.label = 4;\r\n                    case 4: return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WebServerBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, _c, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0: return [4 /*yield*/, fetch(this.tokenPath, {\r\n                            headers: { Accept: \"text/plain; application/json\" },\r\n                            redirect: 'manual',\r\n                            cache: 'no-cache',\r\n                            credentials: \"same-origin\"\r\n                        })];\r\n                    case 1:\r\n                        res = _e.sent();\r\n                        if (res.status === 302 || (!res.status && res.type === \"opaqueredirect\")) {\r\n                            // User session timed out and server wants to redirect entire page to login page\r\n                            // Time to reload current page to force a redirect of the entire page instead for\r\n                            // just redirecting to /api/token or whatever.\r\n                            if (Date.now() - timeOfPageLoad > 60000) { // prohibit endless loop of reloading self.\r\n                                this.wantsRedirect = true; // So that listeners to onbeforeunload could show alternate message.\r\n                                console.log(\"Redirect wanted. Reload page.\");\r\n                                rememberHashLocation();\r\n                                window.location.reload(true);\r\n                                throw new HttpError(302, \"Redirected\");\r\n                            }\r\n                        }\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = Error.bind;\r\n                        _b = \"HTTP\" + res.status + \" \";\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(Error, [void 0, _b + (_e.sent())]))();\r\n                    case 3:\r\n                        _c = this;\r\n                        _d = this.tokenResponseMapper;\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 4:\r\n                        _c.tokenInfo = _d.apply(this, [_e.sent()]);\r\n                        storage.save(this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WebServerBearerProvider;\r\n}());\r\nexport { WebServerBearerProvider };\r\nexport var isomorphic = { fetch: fetch.bind(self), btoa: btoa.bind(self) };\r\nvar KedBackendClientWeb = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendClientWeb, _super);\r\n    function KedBackendClientWeb(apiBaseUrl, providerOrTokenPath, options) {\r\n        var _this = this;\r\n        var bearerProvider = typeof providerOrTokenPath !== 'string' ?\r\n            providerOrTokenPath :\r\n            new WebServerBearerProvider(providerOrTokenPath, (options && options.tokenResponseMapper) || (function (x) { return ({ token: x, expires: Date.now() + 59 * 60 * 60 }); }), options && options.tokenId);\r\n        _this = _super.call(this, isomorphic, bearerProvider, apiBaseUrl) || this;\r\n        return _this;\r\n    }\r\n    return KedBackendClientWeb;\r\n}(KedBackendClient));\r\nexport { KedBackendClientWeb };\r\n//# sourceMappingURL=index.js.map","var DocumentAccess = /** @class */ (function () {\r\n    function DocumentAccess(accessClaimType, accessClaimValue, right) {\r\n        this.accessClaimType = accessClaimType;\r\n        this.accessClaimValue = accessClaimValue;\r\n        this.right = right;\r\n    }\r\n    DocumentAccess.fromString = function (ac) {\r\n        if (!ac)\r\n            return null;\r\n        var split = ac.split(':');\r\n        if (split.length < 3)\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        var claimType = DocumentAccess.unescape(split[0]);\r\n        var claimValue = DocumentAccess.unescape(split[1]);\r\n        var right = split[2];\r\n        if (right !== 'R' && right !== 'W' && right !== 'S')\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        return new DocumentAccess(claimType, claimValue, right);\r\n    };\r\n    DocumentAccess.escape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%/g, \"%25\").replace(/\\:/g, \"%3A\");\r\n    };\r\n    DocumentAccess.unescape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%3A/g, \":\").replace(/\\%25/g, \"%\");\r\n    };\r\n    DocumentAccess.prototype.toString = function () {\r\n        return DocumentAccess.escape(this.accessClaimType) + \":\" +\r\n            DocumentAccess.escape(this.accessClaimValue) + \":\" +\r\n            this.right;\r\n    };\r\n    DocumentAccess.fromStringArray = function (acl) {\r\n        return acl\r\n            .map(function (ac) { return DocumentAccess.fromString(ac); })\r\n            .filter(function (ac) { return ac; });\r\n    };\r\n    DocumentAccess.toStringArray = function (acl) {\r\n        return acl.map(function (ac) { return ac.toString(); });\r\n    };\r\n    return DocumentAccess;\r\n}());\r\nexport { DocumentAccess };\r\nexport function hasAccess(acl, userClaims, requestedRight) {\r\n    if (userClaims.some(function (claim) { return claim.type === 'role' && claim.value === \"ADMIN\"; }))\r\n        return true;\r\n    return acl.some(function (a) {\r\n        return userClaims.some(function (c) {\r\n            return a.accessClaimType === c.type &&\r\n                a.accessClaimValue === c.value && ((a.right === 'R' && requestedRight === 'R') ||\r\n                (a.right === 'W' && ['R', 'W'].indexOf(requestedRight) >= 0) ||\r\n                (a.right === 'S'));\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=access-control.js.map","import * as tslib_1 from \"tslib\";\r\nvar HttpError = /** @class */ (function (_super) {\r\n    tslib_1.__extends(HttpError, _super);\r\n    function HttpError(code, message) {\r\n        var _this = _super.call(this, \"HTTP\" + code + \" \" + message) || this;\r\n        _this.code = code;\r\n        _this.message = message;\r\n        _this.name = \"http\" + code;\r\n        _this.message = \"HTTP\" + code + \" \" + message;\r\n        return _this;\r\n    }\r\n    return HttpError;\r\n}(Error));\r\nexport { HttpError };\r\n//# sourceMappingURL=http-error.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nexport * from './utils';\r\nexport { KedBearerProvider } from './ked-bearer-provider';\r\nexport * from './access-control';\r\nexport { RestClient };\r\nimport { HttpError } from './http-error';\r\nexport { HttpError };\r\nexport * from './restclient';\r\n;\r\n// | 'otherFlag' | 'thirdFlag';...\r\nvar KedBackendClient = /** @class */ (function () {\r\n    function KedBackendClient(isomorphic, bearerProvider, baseUrl) {\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n    }\r\n    KedBackendClient.prototype.getMyClaims = function (table, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"me/claims/\" + (table || \"\"), null, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.get = function (table, id, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(table + \"/\" + id, options, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.list = function (table, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = tslib_1.__assign({}, options);\r\n                        if (typeof location !== 'undefined' && location.search.includes('useSP')) {\r\n                            if (!options.from &&\r\n                                !options.to &&\r\n                                (!options.include || !options.include.includes(\"acl\")) &&\r\n                                !options.role &&\r\n                                !options.name &&\r\n                                [options.hasEdgesFrom, options.hasEdgesTo, options.ids, options.tags].filter(function (x) { return !!x; }).length === 1) {\r\n                                query.flags = (query.flags || []).concat(['useSP']);\r\n                            }\r\n                        }\r\n                        if (options && options.mutationsOnEmpty)\r\n                            query.mutationsOnEmpty = JSON.stringify(options.mutationsOnEmpty);\r\n                        return [4 /*yield*/, this.http.get(\"\" + table, query, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.batch = function (reqs, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        // Reorder operations so that 'add's come first and 'delete's come last:\r\n                        reqs = reqs.slice().sort(function (req1, req2) {\r\n                            return req1.op === 'add' ? -1 : req2.op === 'add' ? 1 :\r\n                                req1.op === 'delete' ? 1 : req2.op === 'delete' ? -1 : 0;\r\n                        });\r\n                        return [4 /*yield*/, this.http.post(\"batch\", reqs, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.do = function (scopeFn) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var runner;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        runner = new BatchRunner();\r\n                        scopeFn(runner);\r\n                        return [4 /*yield*/, this.batch(runner.mutationRequests)];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.deleteRealm = function (realm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.delete(\"realms/\" + realm)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.add = function (table, doc, branchId) {\r\n        return this.do(function (r) { return r.add(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.put = function (table, doc) {\r\n        return this.do(function (r) { return r.put(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        return this.do(function (r) { return r.update(table, id, deltaDoc, branchId); });\r\n    };\r\n    KedBackendClient.prototype.merge = function (branchId, targetBranchId) {\r\n        return this.do(function (r) { return r.merge(branchId, targetBranchId); });\r\n    };\r\n    KedBackendClient.prototype.clearBranch = function (branchId) {\r\n        return this.do(function (r) { return r.clearBranch(branchId); });\r\n    };\r\n    KedBackendClient.prototype.delete = function (table, id) {\r\n        return this.do(function (r) { return r.delete(table, id); });\r\n    };\r\n    KedBackendClient.prototype.share = function (table, id, acl) {\r\n        return this.do(function (r) { return r.share(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.unshare = function (table, id, acl) {\r\n        return this.do(function (r) { return r.unshare(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.link(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.link2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.link2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.unlink(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.unlink2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.unlink2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.undoLink = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.undoLink(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    return KedBackendClient;\r\n}());\r\nexport { KedBackendClient };\r\nvar BatchRunner = /** @class */ (function () {\r\n    function BatchRunner() {\r\n        this.mutationRequests = [];\r\n    }\r\n    BatchRunner.prototype.add = function (table, doc, branchId) {\r\n        this.mutationRequests.push({ op: 'add', table: table, doc: doc, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.put = function (table, doc) {\r\n        doc = tslib_1.__assign({}, doc);\r\n        delete doc.acl; // Forbidden to send acl with put() calls.\r\n        this.mutationRequests.push({ op: 'put', table: table, doc: doc });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        deltaDoc = tslib_1.__assign({}, deltaDoc);\r\n        this.mutationRequests.push({ op: 'update', table: table, id: id, deltaDoc: deltaDoc, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.merge = function (branchId, targetBranchId) {\r\n        this.mutationRequests.push({ op: 'merge', branchId: branchId, targetBranchId: targetBranchId });\r\n    };\r\n    BatchRunner.prototype.clearBranch = function (branchId) {\r\n        this.mutationRequests.push({ op: 'clear-branch', branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.delete = function (table, id) {\r\n        this.mutationRequests.push({ op: 'delete', table: table, id: id });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.share = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'share', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unshare = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'unshare', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unlink2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.undoLink = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'undo-link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    return BatchRunner;\r\n}());\r\nexport { BatchRunner };\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nimport { avoidSimultanousCalls } from './utils';\r\nvar KedBearerProvider = /** @class */ (function () {\r\n    function KedBearerProvider(isomorphic, storage, tokenId, clientId, clientSecret, tokenUrl, tokenQuery) {\r\n        this.isomorphic = isomorphic;\r\n        this.storage = storage;\r\n        this.tokenId = tokenId;\r\n        this.clientId = clientId;\r\n        this.clientSecret = clientSecret;\r\n        this.tokenUrl = tokenUrl;\r\n        this.tokenQuery = tokenQuery;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.client = new RestClient(isomorphic, \"\", {\r\n            username: this.clientId,\r\n            password: this.clientSecret\r\n        });\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    KedBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, token, expires, _b, e_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.tokenInfo, token = _a.token, expires = _a.expires;\r\n                        if (token && expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        _c.trys.push([1, 4, , 6]);\r\n                        _b = this;\r\n                        return [4 /*yield*/, this.storage.load(this.clientId + \"/\" + this.tokenId)];\r\n                    case 2:\r\n                        _b.tokenInfo = _c.sent();\r\n                        if (this.tokenInfo.token && this.tokenInfo.expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        e_1 = _c.sent();\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, retries, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        retries = 0;\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        if (!(retries < 6)) return [3 /*break*/, 5];\r\n                        console.log(\"Retrieving token for \" + this.tokenId);\r\n                        return [4 /*yield*/, this.client.get(this.tokenUrl, this.tokenQuery, { cache: 'reload' })];\r\n                    case 2:\r\n                        res = _c.sent();\r\n                        if (res.status !== 200) {\r\n                            console.warn(\"Got \" + res.status + \" \" + res.statusText);\r\n                            return [3 /*break*/, 4];\r\n                        }\r\n                        _a = this;\r\n                        _b = {};\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 3:\r\n                        _a.tokenInfo = (_b.token = _c.sent(), _b.expires = Date.now() + 59 * 60 * 1000, _b);\r\n                        console.log(\"Got token for \" + this.tokenId + \": \" + JSON.stringify(this.tokenInfo));\r\n                        this.storage.save(this.clientId + \"/\" + this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        ++retries;\r\n                        return [3 /*break*/, 1];\r\n                    case 5: throw new Error(\"Failed to retrieve token for \" + JSON.stringify(this.tokenId));\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBearerProvider;\r\n}());\r\nexport { KedBearerProvider };\r\n//# sourceMappingURL=ked-bearer-provider.js.map","/*\r\ndeclare var Buffer; // node built-in\r\n\r\n\r\nfunction basicAuthHeader(username, password) {\r\n    return \"Basic \" + new Buffer(username + \":\" + password).toString(\"base64\");\r\n}\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport { createUUID } from \"./utils\";\r\nimport { Emitter } from '../observable/emitter';\r\nvar RestClient = /** @class */ (function () {\r\n    function RestClient(isomorphic, baseUrl, options) {\r\n        this.isomorphic = isomorphic;\r\n        this.baseUrl = baseUrl;\r\n        this.options = options;\r\n        this.numOutstandingOperations = 0;\r\n        this.cache = {}; //, timeout: number}};\r\n        this._status = new Emitter(this);\r\n        this.fetchOptions = { mode: 'cors' };\r\n        this.authHeader = options.bearer ?\r\n            \"Bearer \" + options.bearer :\r\n            options.username ?\r\n                \"Basic \" + isomorphic.btoa(options.username + \":\" + (options.password || \"\")) :\r\n                null;\r\n        this.bearerProvider = options.bearerProvider || null;\r\n    }\r\n    Object.defineProperty(RestClient.prototype, \"status\", {\r\n        get: function () {\r\n            return this._status;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    RestClient.prototype.suspenseFetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        var key = method + \" \" + path + \" \" + JSON.stringify(headers) + \" \" + JSON.stringify(query) + \" \" + JSON.stringify(fetchOptions);\r\n        var entry = this.cache[key];\r\n        if (entry) {\r\n            // Entry found. Is it still being fetched?\r\n            if ('promise' in entry)\r\n                throw entry.promise; // Still being fetched. Multiple parallell fetches should work on same promise!\r\n            // Promise has resolved. Return result.\r\n            return entry.result;\r\n        }\r\n        else {\r\n            // We are the first to do this request. Start doing it:\r\n            var promise = this.fetch(path, method, headers, query, fetchOptions).then(function (res) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var status, text;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            status = res.status;\r\n                            return [4 /*yield*/, res.text()];\r\n                        case 1:\r\n                            text = _a.sent();\r\n                            this.cache[key] = {\r\n                                result: {\r\n                                    status: status,\r\n                                    text: function () { return text; },\r\n                                    json: function () { return JSON.parse(text); }\r\n                                }\r\n                            };\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); });\r\n            // Immediately put the promise in the cache. Multiple parallell fetches should work on the same promise!\r\n            this.cache[key] = { promise: promise };\r\n            // Suspend until promise is resolved. At that time, the cache will contain an answer!\r\n            throw promise;\r\n        }\r\n    };\r\n    RestClient.prototype.fetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        ++this.numOutstandingOperations;\r\n        this._status.dispatch(this);\r\n        return this._fetch(path, method, headers, query, fetchOptions)\r\n            .then(function (res) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return res;\r\n        }).catch(function (err) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return Promise.reject(err);\r\n        });\r\n    };\r\n    RestClient.prototype._fetch = function (path, method, headers, query, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var queryStr, _a, authHeader, tokenInfo, bearerProvider, _b, _c, url, res, wwwauth, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0:\r\n                        if (fetchOptions && fetchOptions.cache === 'no-cache') {\r\n                            // Workaround for back-button not respecting cache control in Chrome/Opera.\r\n                            // Append a query parameter to force a cache entry\r\n                            query = tslib_1.__assign({}, query, { nocache: createUUID() });\r\n                        }\r\n                        queryStr = query && Object.keys(query).filter(function (key) { return query[key] !== undefined; }).map(function (key) {\r\n                            return encodeURIComponent(key) +\r\n                                \"=\" +\r\n                                encodeURIComponent(query[key]);\r\n                        })\r\n                            .join('&');\r\n                        _a = this, authHeader = _a.authHeader, tokenInfo = _a.tokenInfo, bearerProvider = _a.bearerProvider;\r\n                        if (!(!authHeader && !tokenInfo && bearerProvider)) return [3 /*break*/, 2];\r\n                        _b = this;\r\n                        return [4 /*yield*/, bearerProvider.getBearer()];\r\n                    case 1:\r\n                        _b.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 2;\r\n                    case 2:\r\n                        if (!tokenInfo) return [3 /*break*/, 5];\r\n                        if (!(tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        console.log(\"Token expired. Refresh it:\");\r\n                        _c = this;\r\n                        return [4 /*yield*/, bearerProvider.refreshBearer()];\r\n                    case 3:\r\n                        _c.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 4;\r\n                    case 4:\r\n                        authHeader = \"Bearer \" + tokenInfo.token;\r\n                        _e.label = 5;\r\n                    case 5:\r\n                        // In one way or another, we've concluded an Authorization header to use:\r\n                        if (authHeader) {\r\n                            headers.Authorization = authHeader;\r\n                        }\r\n                        url = this.baseUrl + path + (queryStr ? \"?\" + queryStr : \"\");\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 6:\r\n                        res = _e.sent();\r\n                        if (!(res.status == 401 && this.bearerProvider)) return [3 /*break*/, 9];\r\n                        wwwauth = res.headers.get(\"www-authenticate\");\r\n                        console.log(\"Got \" + res.status + \" from \" + (this.baseUrl + path));\r\n                        if (!(wwwauth && /Bearer/i.test(wwwauth))) return [3 /*break*/, 9];\r\n                        _d = this;\r\n                        return [4 /*yield*/, this.bearerProvider.refreshBearer()];\r\n                    case 7:\r\n                        _d.tokenInfo = _e.sent();\r\n                        headers.Authorization = \"Bearer \" + this.tokenInfo.token;\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 8:\r\n                        res = _e.sent();\r\n                        _e.label = 9;\r\n                    case 9: return [2 /*return*/, res];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    RestClient.prototype.get = function (path, query, fetchOptions) {\r\n        return this.fetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.suspenseGet = function (path, query, fetchOptions) {\r\n        return this.suspenseFetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.post = function (path, data, fetchOptions) {\r\n        return this.fetch(path, \"POST\", {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Accept\": \"application/json\"\r\n        }, null, tslib_1.__assign({}, fetchOptions, { body: JSON.stringify(data) }));\r\n    };\r\n    RestClient.prototype.delete = function (path, query, body, fetchOptions) {\r\n        return this.fetch(path, \"DELETE\", { Accept: \"application/json; text/plain\" }, query, tslib_1.__assign({}, fetchOptions, { body: body }));\r\n    };\r\n    return RestClient;\r\n}());\r\nexport { RestClient };\r\n//# sourceMappingURL=restclient.js.map","import * as tslib_1 from \"tslib\";\r\nexport function createUUID() {\r\n    // Decent solution from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript\r\n    var d = Date.now();\r\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n        var r = (d + Math.random() * 16) % 16 | 0;\r\n        d = Math.floor(d / 16);\r\n        return (c === 'x' ? r : (r & 0x7 | 0x8)).toString(16);\r\n    });\r\n    return uuid;\r\n}\r\nexport function avoidSimultanousCalls(method) {\r\n    var ongoingPromise = null;\r\n    return function () {\r\n        if (!ongoingPromise) {\r\n            ongoingPromise = method.apply(this, arguments).then(function (result) {\r\n                ongoingPromise = null;\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromise;\r\n    };\r\n}\r\nexport function getGlobalId(realm) {\r\n    var prefix = 'ec96b3be-45fc-41d3-b69e-';\r\n    var pad = ['50', '08', 'e1', '40', 'e4', 'e7'];\r\n    if (realm.length > 6)\r\n        throw new Error(\"Too long realm\");\r\n    for (var i = 0; i < realm.length; ++i) {\r\n        var hex = realm.charCodeAt(i).toString(16);\r\n        pad[i] = hex.length === 2 ?\r\n            hex :\r\n            '0' + hex;\r\n    }\r\n    return prefix + pad.join('');\r\n}\r\nexport function computePredestinatedId(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, data, digest, _a, i;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    data = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', data)];\r\n                case 1:\r\n                    digest = new (_a.apply(Uint8Array, [void 0, _b.sent()]))();\r\n                    i = 0;\r\n                    return [2 /*return*/, 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n                            var nibble = digest[i++] % 16 | 0;\r\n                            var washedNibble = c === 'x' ?\r\n                                nibble :\r\n                                nibble & 0x7 | 0x8;\r\n                            return washedNibble.toString(16);\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function simpleDigest(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, inputBytes, digestBytes, _a;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    inputBytes = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', inputBytes)];\r\n                case 1:\r\n                    digestBytes = new (_a.apply(Uint8Array, [void 0, _b.sent(), 0, 16]))();\r\n                    return [2 /*return*/, buf2hex(digestBytes)];\r\n            }\r\n        });\r\n    });\r\n}\r\nvar simpleDigestCache = {};\r\nexport function simpleDigestSuspense(inputs) {\r\n    var results = inputs.map(function (input) { return simpleDigestCache[input]; });\r\n    var unresolvedInputs = [];\r\n    results.forEach(function (result, index) {\r\n        if (!result)\r\n            unresolvedInputs.push(inputs[index]);\r\n    });\r\n    if (unresolvedInputs.length === 0)\r\n        return results;\r\n    throw Promise.all(unresolvedInputs.map(function (input) { return simpleDigest(input).then(function (result) { return simpleDigestCache[input] = result; }); }));\r\n}\r\nexport function buf2hex(buffer) {\r\n    return Array.prototype.map.call(buffer, function (x) { return ('00' + x.toString(16)).slice(-2); }).join('');\r\n}\r\nexport function updateArray(a, mapper) {\r\n    var retval = a;\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var t = a[i];\r\n        var mapped = mapper(t);\r\n        if (mapped !== t) {\r\n            if (retval === a)\r\n                retval = a.slice();\r\n            retval[i] = mapped;\r\n        }\r\n    }\r\n    return retval;\r\n}\r\n/*\r\nexport function updateArray<T>(a: T[], mapper: (t: T) => T | false): T[] {\r\n  let retval = a;\r\n  let j = 0;\r\n  for (let i=0,l=a.length; i<l; ++i, ++j) {\r\n    const t = a[i];\r\n    const mapped = mapper(t);\r\n    if (mapped === false) {\r\n      // Mapper wants to delete this doc.\r\n      if (retval === a) retval = a.slice();\r\n      retval.splice(j, 1);\r\n      --j; // compensate for ++j\r\n    } else if (mapped !== t) {\r\n      if (retval === a) retval = a.slice();\r\n      retval[j] = mapped;\r\n    }\r\n  }\r\n  return retval;\r\n}\r\n*/ \r\n//# sourceMappingURL=utils.js.map","import * as JsonSchema from \"kedbackend-schema/schema.json\";\r\nimport { getTableFromLabel } from \"./utils\";\r\nvar CacheBust = /** @class */ (function () {\r\n    function CacheBust() {\r\n    }\r\n    CacheBust.getCacheBust = function (table, query, user, includes) {\r\n        var involvedItems = CacheBust.getInvolvedItems(table, query, includes);\r\n        return involvedItems\r\n            .map(function (item) { return localStorage.getItem(\"cache-bust-\" + user + \"-\" + item); })\r\n            .filter(function (value) { return !!value; })\r\n            .join('/') || 'static';\r\n    };\r\n    CacheBust.invalidateCache = function (reqs, user) {\r\n        for (var _i = 0, _a = CacheBust.getCacheInvalidations(reqs); _i < _a.length; _i++) {\r\n            var item = _a[_i];\r\n            localStorage.setItem(\"cache-bust-\" + user + \"-\" + item, '' + Date.now());\r\n        }\r\n    };\r\n    CacheBust.getInvolvedItems = function (table, query, includes) {\r\n        var hasEdgesFrom = query.hasEdgesFrom;\r\n        var relatedTables = includes\r\n            .map(function (label) { return JsonSchema.tables[table].relationships[label]; })\r\n            .filter(function (table) { return !!table; });\r\n        if (hasEdgesFrom)\r\n            relatedTables.push(\"hef\" + table);\r\n        return [table, 'master', query.branchId].filter(function (x) { return !!x; }).concat(relatedTables).sort();\r\n    };\r\n    CacheBust.getCacheInvalidations = function (reqs) {\r\n        var invalidationSet = {};\r\n        reqs.forEach(function (req) {\r\n            switch (req.op) {\r\n                case 'add':\r\n                case 'put':\r\n                case 'delete':\r\n                case 'update':\r\n                    invalidationSet[req.table] = true;\r\n                    break;\r\n                case 'link':\r\n                case 'unlink':\r\n                case 'undo-link':\r\n                    invalidationSet[req.sourceTable] = true;\r\n                    invalidationSet[\"hef-\" + getTableFromLabel(req.sourceTable, req.label)] = true;\r\n                    break;\r\n                case 'clear-branch':\r\n                    invalidationSet[req.branchId] = true;\r\n                    break;\r\n                case 'merge':\r\n                    invalidationSet[req.branchId] = true;\r\n                    invalidationSet[req.targetBranchId || \"master\"] = true;\r\n                    break;\r\n            }\r\n        });\r\n        return Object.keys(invalidationSet);\r\n    };\r\n    return CacheBust;\r\n}());\r\nexport { CacheBust };\r\n//# sourceMappingURL=cache-bust.js.map","import * as tslib_1 from \"tslib\";\r\nimport { mergeDeltas } from '../delta-merge';\r\nexport function applyMutationsOnDeltas(branchId, deltas, mutations, optimistic, userDisplayName, hasAdditionalFilter) {\r\n    var _loop_1 = function (m) {\r\n        switch (m.op) {\r\n            case 'add-related':\r\n                //\r\n                // AddRelated RepoMutation\r\n                //\r\n                if (!hasAdditionalFilter && m.branchId === branchId) {\r\n                    deltas = [{\r\n                            type: 'add',\r\n                            sourceId: m.id,\r\n                            targetId: m.relatedDoc.id,\r\n                            label: m.graphProp,\r\n                            sourceTable: m.table,\r\n                            $meta: optimistic ? 'adding' : 'persisted',\r\n                            dateTime: Date.now(),\r\n                            targetName: m.relatedDoc.name,\r\n                            contributor: userDisplayName\r\n                        }].concat(deltas);\r\n                }\r\n                break;\r\n            case 'clear-branch':\r\n                //\r\n                // ClearBranch RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                break;\r\n            case 'delete':\r\n                //\r\n                // Delete RepoMutation\r\n                //\r\n                // This type of mutation can not be performed onto branches. There's no branchId property on m.\r\n                break;\r\n            case 'merge':\r\n                //\r\n                // Merge RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                else if (m.targetBranchId === branchId) {\r\n                    // This change will append new deltas to our deltas array but we don't know what would come.\r\n                    // Need to refetch from server.\r\n                    if (!optimistic)\r\n                        return { value: null }; // Caller should check for null and re-fetch data from server.\r\n                }\r\n                break;\r\n            case 'remove-related':\r\n                //\r\n                // Remove-Related RepoMutation\r\n                //\r\n                if (hasAdditionalFilter || m.branchId !== branchId)\r\n                    return \"continue\";\r\n                deltas = [{\r\n                        type: 'remove',\r\n                        sourceId: m.id,\r\n                        targetId: m.relatedDoc.id,\r\n                        targetName: m.relatedDoc.name,\r\n                        label: m.graphProp,\r\n                        sourceTable: m.table,\r\n                        contributor: userDisplayName,\r\n                        dateTime: Date.now(),\r\n                        $meta: optimistic ? 'adding' : 'persisted'\r\n                    }].concat(deltas);\r\n                break;\r\n            case 'undo-link':\r\n                //\r\n                // Undo-Link RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (d) {\r\n                        return (d.type === 'add' || d.type === 'remove' || d.type === 'undo-link') &&\r\n                            d.sourceId === m.id &&\r\n                            d.targetId === m.relatedId;\r\n                    });\r\n                    if (idx < 0)\r\n                        return \"continue\";\r\n                    // Found an \"add\" or \"remove\" delta to change:\r\n                    if (optimistic) {\r\n                        var deltaRelation = deltas[idx];\r\n                        // Mark the existing add/remove delta as currenlty being deleted\r\n                        deltas = deltas.slice(0, idx).concat([\r\n                            tslib_1.__assign({}, deltaRelation, { $meta: optimistic ? 'removing' : 'persisted' })\r\n                        ], deltas.slice(idx + 1));\r\n                    }\r\n                    else {\r\n                        // Persisted. Just remove it:\r\n                        deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                    }\r\n                }\r\n                break;\r\n            case 'update':\r\n                //\r\n                // Update RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (delta) {\r\n                        return delta.type === 'modify' &&\r\n                            delta.targetId === m.id;\r\n                    });\r\n                    if (idx < 0 && !hasAdditionalFilter) {\r\n                        deltas = [{\r\n                                type: 'modify',\r\n                                table: m.table,\r\n                                targetId: m.id,\r\n                                targetName: m.targetName,\r\n                                data: m.deltaDoc,\r\n                                dateTime: Date.now(),\r\n                                contributors: [userDisplayName],\r\n                                $meta: optimistic ? 'adding' : 'persisted',\r\n                            }].concat(deltas);\r\n                    }\r\n                    else {\r\n                        var existingDeltaDoc = deltas[idx];\r\n                        var contributors = existingDeltaDoc.contributors.slice();\r\n                        if (!contributors.includes(userDisplayName)) {\r\n                            contributors.push(userDisplayName);\r\n                        }\r\n                        var newData = mergeDeltas(existingDeltaDoc.data, m.deltaDoc, { removeUnsetProps: true });\r\n                        if (!optimistic && Object.keys(newData).length === 0) {\r\n                            // Committed mutation that resets a deltaDoc. Remove the deltaDoc entirely:\r\n                            deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                        }\r\n                        else {\r\n                            // \r\n                            deltas = [\r\n                                {\r\n                                    type: 'modify',\r\n                                    table: m.table,\r\n                                    targetId: m.id,\r\n                                    targetName: m.targetName,\r\n                                    data: newData,\r\n                                    dateTime: Date.now(),\r\n                                    contributors: contributors,\r\n                                    $meta: optimistic ? 'updating' : 'persisted',\r\n                                }\r\n                            ].concat(deltas.slice(0, idx), deltas.slice(idx + 1));\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n        }\r\n    };\r\n    for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\r\n        var m = mutations_1[_i];\r\n        var state_1 = _loop_1(m);\r\n        if (typeof state_1 === \"object\")\r\n            return state_1.value;\r\n    }\r\n    return deltas;\r\n}\r\n//# sourceMappingURL=apply-mutations-on-deltas.js.map","import * as tslib_1 from \"tslib\";\r\nimport { HttpError } from '../../ked-backend-client';\r\nimport { applyMutationsOnDeltas } from './apply-mutations-on-deltas';\r\nvar DeltaCache = /** @class */ (function () {\r\n    function DeltaCache(getClient, getUser, getUserDisplayName) {\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.lookup = {};\r\n    }\r\n    DeltaCache.prototype.applyMutations = function (mutations, _a) {\r\n        var optimistic = (_a === void 0 ? { optimistic: false } : _a).optimistic;\r\n        // Apply mutations locally onto the DeltaCache and notify their subscribers\r\n        for (var _i = 0, _b = Object.keys(this.lookup); _i < _b.length; _i++) {\r\n            var queryKey = _b[_i];\r\n            var cacheEntry = this.lookup[queryKey];\r\n            if (cacheEntry.value) {\r\n                // Instead here: Store the mutations on cacheEntry. No matter if it yet has value or not.\r\n                // Then apply mutation whenever subscribing! (Better handling of mutations that arrives before fetch() is done)\r\n                // (See how I handle this in query-set.ts)\r\n                var newValue = applyMutationsOnDeltas(cacheEntry.query.branchId, cacheEntry.value, mutations, optimistic, this.getUserDisplayName(), !!cacheEntry.query.tags);\r\n                if (newValue === null) {\r\n                    // The mutation requires cacheEntry to be refetched from server\r\n                    if (!optimistic) {\r\n                        // Caller has successfully performed the mutations and got success back from server.\r\n                        // It's ok to refetch the deltas from server now:\r\n                        cacheEntry.fetch();\r\n                        // After fetch completes, it will notify the subscribers.\r\n                    }\r\n                }\r\n                if (newValue !== cacheEntry.value) {\r\n                    cacheEntry.optimisticValue = newValue;\r\n                    if (!optimistic)\r\n                        cacheEntry.value = newValue;\r\n                    cacheEntry.notify(newValue);\r\n                }\r\n            }\r\n        }\r\n    };\r\n    DeltaCache.prototype.subscribe = function (query, observer) {\r\n        var _this = this;\r\n        var cacheEntry = this.lookup[query.branchId + query.tags];\r\n        if (!cacheEntry) {\r\n            cacheEntry = new DeltaCacheEntry(this.getClient(), query);\r\n            this.lookup[query.branchId + query.tags] = cacheEntry;\r\n        }\r\n        if (cacheEntry.cleanupTimer) {\r\n            clearTimeout(cacheEntry.cleanupTimer);\r\n            cacheEntry.cleanupTimer = null;\r\n        }\r\n        var subscription = {\r\n            unsubscribe: function () {\r\n                cacheEntry.subscribers = cacheEntry.subscribers.filter(function (_a) {\r\n                    var o = _a.observer;\r\n                    return o !== observer;\r\n                });\r\n                if (cacheEntry.subscribers.length === 0) {\r\n                    cacheEntry.cleanupTimer = setTimeout(function () {\r\n                        if (cacheEntry.subscribers.length === 0) {\r\n                            delete _this.lookup[query.branchId + query.tags];\r\n                        }\r\n                    }, 100);\r\n                }\r\n            }\r\n        };\r\n        cacheEntry.subscribers.push({ observer: observer, subscription: subscription });\r\n        if (cacheEntry.value) {\r\n            // Value has been successfully retrieved already. Pick from cache.\r\n            observer(cacheEntry.optimisticValue || cacheEntry.value, null, subscription);\r\n        }\r\n        else if (cacheEntry.isFetching) {\r\n            // A value is on its way. Sit back and relax. All registered\r\n            // observers (including this one) will be notified when data arrives\r\n            // or fails.\r\n        }\r\n        else if (cacheEntry.error) {\r\n            observer(null, cacheEntry.error, subscription);\r\n        }\r\n        else {\r\n            cacheEntry.fetch();\r\n        }\r\n        return subscription;\r\n    };\r\n    return DeltaCache;\r\n}());\r\nexport { DeltaCache };\r\nvar DeltaCacheEntry = /** @class */ (function () {\r\n    function DeltaCacheEntry(client, query) {\r\n        this.fetchOperationId = 0; // Makes sure a re-fetch will discard the result from any ongoing fetch.\r\n        this.client = client;\r\n        this.query = query;\r\n        this.value = null;\r\n        this.error = null;\r\n        this.optimisticValue = null;\r\n        this.subscribers = [];\r\n        this.isFetching = false;\r\n        this.cleanupTimer = null;\r\n    }\r\n    DeltaCacheEntry.prototype.fetch = function () {\r\n        var _this = this;\r\n        var fetchOperationId = ++this.fetchOperationId;\r\n        this.isFetching = true;\r\n        this.fetchFromServer().then(function (value) {\r\n            // Success\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                value.sort(function (a, b) { return b.dateTime - a.dateTime; }); // Latest first\r\n                _this.value = value;\r\n                _this.optimisticValue = value;\r\n                _this.notify(value);\r\n            }\r\n        }).catch(function (error) {\r\n            // Fail\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                _this.error = error;\r\n                _this.fail(error);\r\n            }\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.fetchFromServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!this.query.branchId)\r\n                            throw new Error('Deltas only available on branches');\r\n                        return [4 /*yield*/, this.client.http.get('deltas', this.query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status >= 300 || res.status < 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.notify = function (value) {\r\n        for (var _i = 0, _a = this.subscribers; _i < _a.length; _i++) {\r\n            var _b = _a[_i], observer = _b.observer, subscription = _b.subscription;\r\n            observer(value, null, subscription);\r\n        }\r\n    };\r\n    DeltaCacheEntry.prototype.fail = function (error) {\r\n        var copy = this.subscribers.slice();\r\n        this.subscribers = [];\r\n        for (var _i = 0, copy_1 = copy; _i < copy_1.length; _i++) {\r\n            var _a = copy_1[_i], observer = _a.observer, subscription = _a.subscription;\r\n            observer(null, error, subscription);\r\n        }\r\n    };\r\n    return DeltaCacheEntry;\r\n}());\r\n//# sourceMappingURL=delta-cache.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Collection } from '../../observable';\r\nvar DeltaCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(DeltaCollection, _super);\r\n    function DeltaCollection(deltaCache, query) {\r\n        var _this = _super.call(this, function (observer) { return _this.deltaCache.subscribe(query, observer); }) || this;\r\n        _this.deltaCache = deltaCache;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    DeltaCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return new DeltaCollection(this.deltaCache, tslib_1.__assign({}, this.query, { tags: tags }));\r\n    };\r\n    return DeltaCollection;\r\n}(Collection));\r\nexport { DeltaCollection };\r\n//# sourceMappingURL=delta-collection.js.map","import * as tslib_1 from \"tslib\";\r\nexport function applyDelta(doc, delta) {\r\n    var keys = Object.keys(delta);\r\n    var targetDoc = doc;\r\n    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\r\n        var key = keys_1[_i];\r\n        if (targetDoc === doc)\r\n            targetDoc = tslib_1.__assign({}, doc);\r\n        var val = delta[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_1 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            // Do nothing on target doc!\r\n                            targetDoc.$wasUnset = true; // Just mark it for re-retrieval after successful posting changes.\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd = miValue;\r\n                            if (!Array.isArray(valuesToAdd)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            else {\r\n                                targetArray = targetArray.slice(); // On JS side, we must be immutable\r\n                            }\r\n                            targetDoc[key] = targetArray;\r\n                            for (var _i = 0, valuesToAdd_1 = valuesToAdd; _i < valuesToAdd_1.length; _i++) {\r\n                                var v = valuesToAdd_1[_i];\r\n                                if (!targetArray.includes(v)) { // avoid dups\r\n                                    targetArray.push(v);\r\n                                }\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_1 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_1)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            targetDoc[key] = targetArray.filter(function (t) { return !valuesToRemove_1.includes(t); });\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _a = 0, metaInstructions_1 = metaInstructions; _a < metaInstructions_1.length; _a++) {\r\n                    var mi = metaInstructions_1[_a];\r\n                    _loop_1(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDoc[key] = val;\r\n    }\r\n    return targetDoc;\r\n}\r\n// {name: \"Ulla\"}, {name: {$unset:0}\r\n// {tags: {$add: \"hej\"}}, {tags: {$unset:0}\"}\r\nexport function mergeDeltas(delta1, delta2, _a) {\r\n    var removeUnsetProps = (_a === void 0 ? { removeUnsetProps: false } : _a).removeUnsetProps;\r\n    //return {...delta1, ...delta2};\r\n    var keys = Object.keys(delta2);\r\n    var targetDelta = tslib_1.__assign({}, delta1);\r\n    for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {\r\n        var key = keys_2[_i];\r\n        var val = delta2[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_2 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            if (removeUnsetProps) {\r\n                                delete targetDelta[key];\r\n                            }\r\n                            else {\r\n                                // No matter if targetDelta is empty or has value. Set it to {$unset:0}\r\n                                // to make sure the very end result will have {$unset:0}\r\n                                targetDelta[key] = { $unset: 0 };\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd_2 = miValue;\r\n                            if (!Array.isArray(valuesToAdd_2)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$remove: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$add: [...]} arrays.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetRemoveArray)) {\r\n                                targetMetaProp.$remove =\r\n                                    targetRemoveArray.filter(function (t) { return !valuesToAdd_2.includes(t); });\r\n                                if (targetMetaProp.$remove.length === 0) {\r\n                                    // If $remove array became emtpy. Remove the $remove prop.\r\n                                    delete targetMetaProp.$remove;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $add array.\r\n                            var targetAddArray = targetMetaProp.$add;\r\n                            targetAddArray = targetAddArray ? targetAddArray.concat(valuesToAdd_2) : valuesToAdd_2.slice();\r\n                            targetMetaProp.$add = targetAddArray;\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_2 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_2)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$add: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$remove: [...]} arrays.\r\n                            var targetAddArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetAddArray)) {\r\n                                targetMetaProp.$add =\r\n                                    targetAddArray.filter(function (t) { return !valuesToRemove_2.includes(t); });\r\n                                if (targetMetaProp.$add.length === 0) {\r\n                                    // If $add array became emtpy. Remove the $add prop.\r\n                                    delete targetMetaProp.$add;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $remove array.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            targetRemoveArray = targetRemoveArray ? targetRemoveArray.concat(valuesToRemove_2) : valuesToRemove_2.slice();\r\n                            targetMetaProp.$remove = targetRemoveArray;\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _b = 0, metaInstructions_2 = metaInstructions; _b < metaInstructions_2.length; _b++) {\r\n                    var mi = metaInstructions_2[_b];\r\n                    _loop_2(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDelta[key] = val;\r\n    }\r\n    return targetDelta;\r\n}\r\n//# sourceMappingURL=delta-merge.js.map","export * from './kedbackend-collection';\r\nexport * from './kedbackend-query';\r\nexport * from './kedbackend-repo';\r\nexport * from './kedbackend-subscription';\r\nexport * from './kedbackend-writer';\r\nexport * from './mutation-queue';\r\nexport * from './query-set';\r\nexport * from '../observable/mixin';\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { KedBackendSubscription } from \"./kedbackend-subscription\";\r\nimport { CacheBust } from './cache-bust';\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport { Collection } from '../observable/collection';\r\n/**\r\n * Represents a \"live\" query against a table or filtered table.\r\n */\r\nvar KedBackendCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendCollection, _super);\r\n    function KedBackendCollection(repo, table, query) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = new KedBackendSubscription(observer, _this);\r\n            _this.repo.querySet.subscribe(subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.repo = repo;\r\n        _this.table = table;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    Object.defineProperty(KedBackendCollection.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendCollection.prototype, \"includes\", {\r\n        get: function () {\r\n            return this._includes || (this._includes = [].concat(this.query.include || []));\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendCollection.prototype.applyQuery = function (query) {\r\n        return new KedBackendCollection(this.repo, this.table, tslib_1.__assign({}, this.query, query));\r\n    };\r\n    KedBackendCollection.prototype.addToQueryArrayProp = function (arrayProp, entries) {\r\n        var _a;\r\n        return this.applyQuery((_a = {}, _a[arrayProp] = (this.query[arrayProp] || []).concat(entries), _a));\r\n    };\r\n    KedBackendCollection.prototype.addFlags = function () {\r\n        var flags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            flags[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"flags\", flags);\r\n    };\r\n    KedBackendCollection.prototype.debug = function () {\r\n        return this.applyQuery({ debug: true });\r\n    };\r\n    KedBackendCollection.prototype.idsOnly = function () {\r\n        return this.addFlags(\"idsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.idsAndNamesOnly = function () {\r\n        return this.addFlags(\"idsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsOnly = function () {\r\n        return this.addFlags(\"includeIdsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsAndNamesOnly = function () {\r\n        return this.addFlags(\"includeIdsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.between = function (from, to) {\r\n        return this.applyQuery({ from: from, to: to });\r\n    };\r\n    KedBackendCollection.prototype.role = function (role) {\r\n        return this.applyQuery({ role: role });\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesFrom = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesFrom(\" + JSON.stringify(ids) + \")\");\r\n        var hef = this.addToQueryArrayProp(\"hasEdgesFrom\", ids);\r\n        return hef;\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesTo = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesTo(\" + JSON.stringify(ids) + \")\");\r\n        var het = this.addToQueryArrayProp(\"hasEdgesTo\", ids);\r\n        return het;\r\n    };\r\n    KedBackendCollection.prototype.id = function (id) {\r\n        var _this = this;\r\n        return this.applyQuery({ ids: [id] }).single({\r\n            onZero: function () { throw new Error(\"Could not find entity in \" + _this.table + \" with id \" + id); },\r\n            onMany: function () { throw new Error(\"Multiple entries in \" + _this.table + \" with id \" + id); },\r\n        });\r\n    };\r\n    KedBackendCollection.prototype.ids = function (ids) {\r\n        return this.applyQuery({ ids: ids });\r\n    };\r\n    KedBackendCollection.prototype.name = function (name) {\r\n        return this.applyQuery({ name: name });\r\n    };\r\n    KedBackendCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return this.applyQuery({ tags: tags });\r\n    };\r\n    KedBackendCollection.prototype.branchId = function (branchId) {\r\n        return this.applyQuery({ branchId: branchId });\r\n    };\r\n    KedBackendCollection.prototype.include = function () {\r\n        var graphs = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            graphs[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"include\", graphs);\r\n    };\r\n    KedBackendCollection.prototype.cacheOptimized = function (onOrOff) {\r\n        return onOrOff === undefined || onOrOff === true ?\r\n            this.applyQuery({ cacheBust: CacheBust.getCacheBust(this.table, this.query, this.repo.getUser(), this.includes) }) :\r\n            this.applyQuery({ cacheBust: undefined });\r\n    };\r\n    KedBackendCollection.prototype.mutationsOnEmpty = function (mutationFactory) {\r\n        var tx = new BatchRunner();\r\n        mutationFactory(tx);\r\n        return this.applyQuery({ mutationsOnEmpty: tx.mutationRequests });\r\n    };\r\n    KedBackendCollection.prototype.single = function (throwers) {\r\n        var _this = this;\r\n        var _a = throwers || {}, onZero = _a.onZero, onMany = _a.onMany;\r\n        return this.toValue().map(function (items) {\r\n            if (items.length === 0) {\r\n                if (onZero)\r\n                    onZero();\r\n                else\r\n                    throw new Error(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but none was found.\");\r\n            }\r\n            if (items.length > 1) {\r\n                debugger;\r\n                if (onMany)\r\n                    onMany();\r\n                else\r\n                    console.log(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but \" + items.length + \" was found.\");\r\n            }\r\n            return items[0];\r\n        });\r\n    };\r\n    /*combineLatest<TOther>(other: QueryObservable<TOther>) {\r\n      return this.render(x => x).combineLatest(other);\r\n    }*/\r\n    KedBackendCollection.prototype.update = function (doc, changes, debounce) {\r\n        if (debounce === void 0) { debounce = 1000; }\r\n        this.repo.writer.mutate([{\r\n                op: 'update',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: doc.id,\r\n                deltaDoc: changes,\r\n                targetName: doc.name\r\n            }], debounce);\r\n    };\r\n    KedBackendCollection.prototype.addRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.add = function (doc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add',\r\n                id: doc.id,\r\n                table: this.table,\r\n                doc: doc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.removeRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'remove-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.undoLink = function (id, label, relatedId) {\r\n        if (!this.query.branchId)\r\n            throw new Error(\"undo links can only be performed on branches\");\r\n        this.repo.writer.mutate([{\r\n                op: 'undo-link',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedId: relatedId\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.delete = function () {\r\n        var _this = this;\r\n        var ids = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            ids[_i] = arguments[_i];\r\n        }\r\n        this.repo.writer.mutate(ids.map(function (id) { return ({\r\n            op: 'delete',\r\n            table: _this.table,\r\n            id: id\r\n        }); }), 0);\r\n    };\r\n    KedBackendCollection.prototype.unsubscribe = function (subscription) {\r\n        this.repo.querySet.unsubscribe(subscription);\r\n    };\r\n    return KedBackendCollection;\r\n}(Collection));\r\nexport { KedBackendCollection };\r\n/*mixin(\r\n  KedBackendCollection.prototype,\r\n  MappedCollection.prototype,\r\n  \"map\", \"flat\", \"concat\", \"render\", \"load\");*/\r\n//# sourceMappingURL=kedbackend-collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { updateArray } from '../ked-backend-client/utils';\r\nimport { branchSensitive, getTableFromLabel } from './utils';\r\nimport { applyDelta } from './delta-merge';\r\nvar KedBackendQuery = /** @class */ (function () {\r\n    function KedBackendQuery(table, query, user, repo, mutationQueue) {\r\n        this.table = table;\r\n        this.query = query;\r\n        this.user = user;\r\n        this.repo = repo;\r\n        this.mutationQueue = mutationQueue;\r\n        this.subscriptions = [];\r\n        this.data = [];\r\n        this.gotInitialResponse = false;\r\n        this.invalid = false;\r\n        this.loadedVersion = 0;\r\n        this._loadPromise = null;\r\n        this.includes = query.include ?\r\n            typeof query.include === 'string' ?\r\n                [query.include] :\r\n                query.include :\r\n            [];\r\n    }\r\n    KedBackendQuery.queryKey = function (table, query) {\r\n        var mutationsOnEmpty = query.mutationsOnEmpty, comparableProps = tslib_1.__rest(query, [\"mutationsOnEmpty\"]);\r\n        return table + JSON.stringify(comparableProps);\r\n    };\r\n    Object.defineProperty(KedBackendQuery.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendQuery.prototype.subscribe = function (subscription) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.subscriptions.push(subscription);\r\n                        if (!(this.gotInitialResponse && !this.invalid)) return [3 /*break*/, 1];\r\n                        data = this.getDataWithMutationsApplied(this.mutationQueue.get(), true, this.data);\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 1:\r\n                        data = this.queryLocally();\r\n                        if (!data) return [3 /*break*/, 2];\r\n                        this.data = data;\r\n                        this.error = null;\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.load()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var loadPromise;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.gotInitialResponse) {\r\n                            // mutationsOnEmpty should never be used twice.\r\n                            delete this.query.mutationsOnEmpty;\r\n                        }\r\n                        if (!(!version && this._loadPromise)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this._loadPromise];\r\n                    case 1: \r\n                    // loading is ongoing, and caller does not require a recent refresh.\r\n                    // wait for the ongoing load to complete\r\n                    return [2 /*return*/, _a.sent()];\r\n                    case 2:\r\n                        version = version || this.repo.writer.persistedVersion.value;\r\n                        loadPromise = this._loadPromise = this._load(version).then(function (data) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                _this.data = data;\r\n                                _this.loadedVersion = Math.max(_this.loadedVersion, version);\r\n                            }\r\n                        }).catch(function (error) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. The error is the final result. Set it.\r\n                                _this.error = error;\r\n                            }\r\n                        }).then(function () {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. We're finished. Data or error is already set.\r\n                                // Mark gotInitialResponse to true and notify subscribers.\r\n                                _this._loadPromise = null;\r\n                                _this.gotInitialResponse = true;\r\n                                _this.notifySubscribers(_this.mutationQueue.get());\r\n                            }\r\n                            else {\r\n                                // A more recent call to load() is ongoing, OR was ongoing but responded\r\n                                // before us.\r\n                                // In any case return this._loadPromise. If it's ongoing we'll wait for it\r\n                                // to finish. If it's null, we'll be returning finally here without\r\n                                // any action, because the action was taken by the refresher.\r\n                                return _this._loadPromise; // Wait for the refreshed load to complete\r\n                            }\r\n                        });\r\n                        return [4 /*yield*/, loadPromise];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype._load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.mutationQueue.affectsQuery(this.table, this.query, this.includes)) return [3 /*break*/, 2];\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        return [4 /*yield*/, this.repo.writer.waitForVersionToPersist(version)];\r\n                    case 1:\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [4 /*yield*/, this.queryServer()];\r\n                    case 3: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.unsubscribe = function (subscription) {\r\n        this.subscriptions = this.subscriptions.filter(function (s) { return s !== subscription; });\r\n    };\r\n    KedBackendQuery.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _i, mutations_1, m, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.data) return [3 /*break*/, 9];\r\n                        _i = 0, mutations_1 = mutations;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < mutations_1.length)) return [3 /*break*/, 8];\r\n                        m = mutations_1[_i];\r\n                        if (!(m.op === 'clear-branch' && (m.branchId === this.query.branchId))) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 3:\r\n                        if (!(m.op === 'merge' && (!m.targetBranchId ||\r\n                            m.branchId === this.query.branchId ||\r\n                            m.targetBranchId === this.query.branchId))) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 5:\r\n                        if (!(m.op === 'update' && ((m.deltaDoc.tags && this.query.tags) ||\r\n                            (m.deltaDoc.name && this.query.name)))) return [3 /*break*/, 7];\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 6:\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 7:\r\n                        _i++;\r\n                        return [3 /*break*/, 1];\r\n                    case 8:\r\n                        data = this.getDataWithMutationsApplied(mutations, false, this.data);\r\n                        this.data = data;\r\n                        _a.label = 9;\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.refreshOrInvalidate = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(this.subscriptions.length === 0)) return [3 /*break*/, 1];\r\n                        this.invalid = true;\r\n                        return [3 /*break*/, 3];\r\n                    case 1: return [4 /*yield*/, this.load(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.notifySubscribers = function (optimisticMutations) {\r\n        var _this = this;\r\n        if (this.data && this.gotInitialResponse) {\r\n            var data_1 = this.getDataWithMutationsApplied(optimisticMutations, true, this.data);\r\n            this.subscriptions.forEach(function (s) {\r\n                s.notifySubscriber(data_1, _this.error);\r\n            });\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.queryLocally = function () {\r\n        return this.repo.querySet.queryLocally(this.table, this.query, this.includes);\r\n    };\r\n    KedBackendQuery.prototype.queryServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.repo.getClient().list(this.table, tslib_1.__assign({}, this.query))];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        return [2 /*return*/, data];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.getDataWithMutationsApplied = function (mutations, optimistic, data) {\r\n        var _this = this;\r\n        mutations.forEach(function (mutation) {\r\n            data = _this.applyMutationsOnData(data, mutation, optimistic);\r\n        });\r\n        return data;\r\n    };\r\n    KedBackendQuery.prototype.applyMutationsOnData = function (data, m, optimistic) {\r\n        if (branchSensitive(m) && m.branchId != this.query.branchId)\r\n            return data;\r\n        var _a = this, table = _a.table, includes = _a.includes, listOptions = _a.query;\r\n        var sourceIds = listOptions.hasEdgesFrom ? [].concat(listOptions.hasEdgesFrom || []) : [];\r\n        var requestedTags = listOptions.tags ? [].concat(listOptions.tags || []) : [];\r\n        switch (m.op) {\r\n            case 'update': {\r\n                return updateArray(data, function (doc) {\r\n                    if (doc.id === m.id) {\r\n                        // Apply delta on updated document\r\n                        var updatedDoc = applyDelta(doc, m.deltaDoc);\r\n                        if (optimistic)\r\n                            updatedDoc.$meta = 'updating';\r\n                        return updatedDoc;\r\n                    }\r\n                    // If id does not apply to this doc, search in graphs the id is found\r\n                    // among graph included docs, and if so, update that one:\r\n                    includes.forEach(function (label) {\r\n                        var _a;\r\n                        var includedDocs = doc[label];\r\n                        if (includedDocs) {\r\n                            var updatedArray = updateArray(includedDocs, function (related) {\r\n                                if (related.id !== m.id)\r\n                                    return related;\r\n                                var updatedRelated = applyDelta(related, m.deltaDoc);\r\n                                if (optimistic)\r\n                                    updatedRelated.$meta = 'updating';\r\n                                return updatedRelated;\r\n                            });\r\n                            if (updatedArray !== includedDocs) {\r\n                                doc = tslib_1.__assign({}, doc, (_a = {}, _a[label] = updatedArray, _a));\r\n                            }\r\n                        }\r\n                    });\r\n                    return doc;\r\n                });\r\n            }\r\n            case 'add':\r\n                if (table === m.table) {\r\n                    if (listOptions.tags) {\r\n                        var queriedTags_1 = [].concat(listOptions.tags); // tag can be either string or string[]. Make is string[] always.\r\n                        if (m.doc.tags && m.doc.tags.some(function (tag) { return queriedTags_1.includes(tag); })) {\r\n                            return data.concat([m.doc]); // Make the added doc appear in the result (optimistic mutation)\r\n                        }\r\n                    }\r\n                    // Todo, apply also for other list options, like ids:\r\n                    // The above code for 'add' was only written to cover the use case of teachers-page notifications!\r\n                }\r\n                return data; // fallback case - query was not affected.\r\n            case 'add-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    // If expression is `db.courseBlocks....whatever.. .include(\"abilities\")`, detect: db.courseBlocks.addRelated(blockId, 'abilities', ...)\r\n                    // ...because table = 'courseBlocks' and includes has \"abilities\".\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        var relatedDoc = tslib_1.__assign({}, m.relatedDoc);\r\n                        if (optimistic)\r\n                            relatedDoc.$meta = 'adding';\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = doc[m.graphProp].concat([relatedDoc]), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id)) {\r\n                        // If expression is:\r\n                        //   `db.courseBlocks.hasEdgesFrom([courseId])`  (meaning table='courseBlocks' and sourceIds includes courseId)\r\n                        // , detect: db.courseInstances.addRelated(courseId, 'courseBlocks', ....) // m.graphProp === 'blocks'--> getTableFromLabel --> 'courseBlocks'\r\n                        if (table === getTableFromLabel(m.table, m.graphProp)) {\r\n                            if (!listOptions.tags)\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            if (m.relatedDoc.tags && requestedTags.some(function (tag) { return m.relatedDoc.tags.includes(tag); })) {\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (listOptions.ids && listOptions.ids.some(function (id) { return id === m.relatedDoc.id; })) {\r\n                    // A certain ID is observed. A doc with this id is being added.\r\n                    // Add the doc to the result. Exactly this WILL happen in the following typical scenario:\r\n                    // 1. User adds a related document to a list.\r\n                    // 2. Document remains within the MutationQueue while batch-request is being processed by server.\r\n                    // 3. User clicks the added item to edit or view it (or our component redirects to its editor)\r\n                    // 4. A new query of that particular ID is subscribed to {ids=[theId]}\r\n                    //    KedBackendQuery.subscribe then does this:\r\n                    //      1. Call queryLocally() before querying server\r\n                    //      2. queryLocally() inspects mutations and finds a match, returning an empty list\r\n                    //         (assumes as we are adding it, it can't exist on the server anyway)\r\n                    //      3. KedBackendQUery applies mutations onto the empty list, and ends up here to add\r\n                    //         it optimistically.\r\n                    //      4. When server responds with 200 OK, calls us here again with optimistic=false\r\n                    //         to \"persist\" it in the query's data array.\r\n                    //      4B: If not 200 OK, mutation may be gone and the subscriber will se an error page\r\n                    //         \"Could not find entity with id X.\" along with a red error message on the screen\r\n                    //         about that it failed to save on server.\r\n                    return data.concat(this.setGraphProps(m.relatedDoc));\r\n                }\r\n                return data;\r\n            case 'remove-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        var includedDocs = doc[m.graphProp];\r\n                        if (!includedDocs)\r\n                            return doc;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = optimistic ?\r\n                            // Mark related-doc-to-remove with $meta: 'deleting'\r\n                            includedDocs.map(function (d) { return d.id !== m.relatedDoc.id ?\r\n                                d : tslib_1.__assign({}, d, { $meta: 'deleting' }); }) :\r\n                            // Delete related-doc-to-remove from doc[grapProp]:\r\n                            includedDocs.filter(function (d) { return d.id !== m.relatedDoc.id; }), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id))\r\n                        return optimistic ?\r\n                            data.map(function (d) { return d.id === m.relatedDoc.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                            data.filter(function (d) { return d.id !== m.relatedDoc.id; });\r\n                }\r\n                return data;\r\n            case 'delete':\r\n                if (table === m.table) {\r\n                    return data.filter(function (d) { return d.id !== m.id; });\r\n                }\r\n                else if (listOptions.include) {\r\n                    var includedTables = includes\r\n                        .map(function (label) { return ({ label: label, table: getTableFromLabel(table, label) }); });\r\n                    var labels_1 = includedTables.filter(function (_a) {\r\n                        var table = _a.table;\r\n                        return table === m.table;\r\n                    });\r\n                    if (labels_1.length > 0) {\r\n                        return updateArray(data, function (doc) {\r\n                            labels_1.forEach(function (_a) {\r\n                                var label = _a.label;\r\n                                var _b;\r\n                                var relatedDocs = doc[label];\r\n                                if (relatedDocs) {\r\n                                    doc = tslib_1.__assign({}, doc, (_b = {}, _b[label] = optimistic ?\r\n                                        relatedDocs.map(function (d) { return d.id === m.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                                        relatedDocs.filter(function (_a) {\r\n                                            var id = _a.id;\r\n                                            return id !== m.id;\r\n                                        }), _b));\r\n                                }\r\n                            });\r\n                            return doc;\r\n                        });\r\n                    }\r\n                }\r\n                return data;\r\n            default:\r\n                return data;\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.setGraphProps = function (doc) {\r\n        var copy = tslib_1.__assign({}, doc);\r\n        this.includes.forEach(function (label) { return copy[label] = copy[label] || []; });\r\n        return copy;\r\n    };\r\n    return KedBackendQuery;\r\n}());\r\nexport { KedBackendQuery };\r\n//# sourceMappingURL=kedbackend-query.js.map","import * as tslib_1 from \"tslib\";\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { KedBackendCollection } from './kedbackend-collection';\r\nimport { QuerySet } from './query-set';\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { KedBackendWriter } from './kedbackend-writer';\r\nimport { DeltaCollection } from './delta-collection/delta-collection';\r\nvar KedBackendRepo = /** @class */ (function () {\r\n    function KedBackendRepo(getClient, getUser, getUserDisplayName, defaultQueryOptions, mutationQueue, querySet, writer, cacheOptimized) {\r\n        var _this = this;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.defaultQueryOptions = defaultQueryOptions;\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.writer = writer;\r\n        this.cacheOptimized = cacheOptimized;\r\n        if (!defaultQueryOptions)\r\n            this.defaultQueryOptions = {};\r\n        if (!mutationQueue)\r\n            this.mutationQueue = new MutationQueue();\r\n        if (!querySet)\r\n            this.querySet = new QuerySet(this.mutationQueue);\r\n        if (!writer)\r\n            this.writer = new KedBackendWriter(this.mutationQueue, this.querySet, getClient, getUser, getUserDisplayName);\r\n        Object.keys(tables).forEach(function (table) {\r\n            var collection = new KedBackendCollection(_this, table, defaultQueryOptions || {});\r\n            if (cacheOptimized) {\r\n                collection = collection.cacheOptimized();\r\n            }\r\n            _this[table] = collection;\r\n        });\r\n        this.deltas = new DeltaCollection(this.writer.deltaCache, {\r\n            branchId: this.defaultQueryOptions.branchId // If branchId is undefined. DeltaCollection will respond with Error on subscribe()\r\n        });\r\n    }\r\n    KedBackendRepo.prototype.table = function (tableName) {\r\n        var collection = new KedBackendCollection(this, tableName, this.defaultQueryOptions);\r\n        if (this.cacheOptimized)\r\n            collection = collection.cacheOptimized();\r\n        return collection;\r\n    };\r\n    KedBackendRepo.prototype._clone = function (queryOptions, cacheOptimized) {\r\n        var clone = new KedBackendRepo(this.getClient, this.getUser, this.getUserDisplayName, tslib_1.__assign({}, this.defaultQueryOptions, queryOptions), this.mutationQueue, this.querySet, this.writer, cacheOptimized === undefined ? this.cacheOptimized : cacheOptimized);\r\n        return clone;\r\n    };\r\n    KedBackendRepo.prototype.branch = function (branchId) {\r\n        return this._clone({ branchId: branchId });\r\n    };\r\n    KedBackendRepo.prototype.role = function (role) {\r\n        return this._clone({ role: role });\r\n    };\r\n    KedBackendRepo.prototype.optimizeCache = function () {\r\n        return this._clone({}, true);\r\n    };\r\n    KedBackendRepo.prototype.clearBranch = function () {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot clear master branch\");\r\n        this.writer.mutate([{ op: 'clear-branch', branchId: this.defaultQueryOptions.branchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.merge = function (targetBranchId) {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot merge from master branch\");\r\n        this.writer.mutate([{ op: 'merge', branchId: this.defaultQueryOptions.branchId, targetBranchId: targetBranchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.saveNow = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.writer.waitForVersionToPersist(this.writer.currentVersion)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBackendRepo;\r\n}());\r\nexport { KedBackendRepo };\r\n//# sourceMappingURL=kedbackend-repo.js.map","var KedBackendSubscription = /** @class */ (function () {\r\n    function KedBackendSubscription(subscriber, collection) {\r\n        this.subscriber = subscriber;\r\n        this.collection = collection;\r\n    }\r\n    KedBackendSubscription.prototype.notifySubscriber = function (data, error) {\r\n        try {\r\n            if (error)\r\n                this.subscriber([], error, this);\r\n            else if (data !== this.lastNotifiedData) { // Will in-fact be equal by reference if data is same as last notification (as we use an immutable approach on data)\r\n                this.lastNotifiedData = data;\r\n                this.subscriber(data, error, this);\r\n            }\r\n        }\r\n        catch (ex) {\r\n            try {\r\n                this.subscriber([], ex, this);\r\n            }\r\n            catch (ex2) {\r\n                console.error(\"Error while notifying KedBackendSubscriber:\", ex2, 'originally notified error:', ex);\r\n            }\r\n        }\r\n    };\r\n    KedBackendSubscription.prototype.unsubscribe = function () {\r\n        this.collection.unsubscribe(this);\r\n    };\r\n    return KedBackendSubscription;\r\n}());\r\nexport { KedBackendSubscription };\r\n//# sourceMappingURL=kedbackend-subscription.js.map","import * as tslib_1 from \"tslib\";\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { CacheBust } from './cache-bust';\r\nimport { Emitter } from '../observable';\r\nimport { DeltaCache } from './delta-collection/delta-cache';\r\nvar KedBackendWriter = /** @class */ (function () {\r\n    function KedBackendWriter(mutationQueue, querySet, getClient, getUser, getUserDisplayName) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = null;\r\n        this.currentVersion = 0;\r\n        this.persistedVersion = new Emitter(0);\r\n        this.errorSubscribers = [];\r\n        this.stateSubscribers = [];\r\n        this.deltaCache = new DeltaCache(getClient, getUser, getUserDisplayName);\r\n    }\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isSaving\", {\r\n        get: function () { return !!this._isSavingPromise; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isEdited\", {\r\n        get: function () { return this.mutationQueue.get().length > 0; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendWriter.prototype.onError = function (callback) {\r\n        this.errorSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.onStateChange = function (callback) {\r\n        this.stateSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.off = function (callback) {\r\n        this.errorSubscribers = this.errorSubscribers.filter(function (s) { return s !== callback; });\r\n        this.stateSubscribers = this.stateSubscribers.filter(function (s) { return s !== callback; });\r\n    };\r\n    KedBackendWriter.prototype.dispatchError = function (error, retryable) {\r\n        var _this = this;\r\n        this.errorSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(error, retryable, _this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.dispatchStateChange = function () {\r\n        var _this = this;\r\n        this.stateSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(_this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mutate = function (mutations, debounce) {\r\n        this.mutationQueue.add(mutations);\r\n        ++this.currentVersion;\r\n        this.dispatchStateChange();\r\n        this.querySet.notifySubscribers();\r\n        this.deltaCache.applyMutations(this.mutationQueue.get(), { optimistic: true });\r\n        if (!this._isSavingPromise) {\r\n            if (this._timeoutId)\r\n                clearTimeout(this._timeoutId);\r\n            this._timeoutId = setTimeout(this.save.bind(this), debounce);\r\n        }\r\n        // If isSaving, we don't need to do anything, becase it will re-check if additional\r\n        // mutations have come, when saving is done.\r\n    };\r\n    KedBackendWriter.prototype.retrySave = function () {\r\n        return this.save();\r\n    };\r\n    KedBackendWriter.prototype.waitForVersionToPersist = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedVersion;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.persistedVersion.load()];\r\n                    case 1:\r\n                        persistedVersion = _a.sent();\r\n                        if (!(persistedVersion < version)) return [3 /*break*/, 3];\r\n                        this.save(); // Be more eager to save\r\n                        return [4 /*yield*/, this.persistedVersion.filter(function (persistedVersion) { return persistedVersion >= version; }).load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.save = function () {\r\n        var _this = this;\r\n        if (this._timeoutId)\r\n            clearTimeout(this._timeoutId);\r\n        if (this._isSavingPromise)\r\n            return this._isSavingPromise;\r\n        if (!this.isEdited)\r\n            return Promise.resolve();\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = this._save();\r\n        this._isSavingPromise.catch(function () { }).then(function () { return _this._isSavingPromise = null; });\r\n        return this._isSavingPromise;\r\n    };\r\n    KedBackendWriter.prototype._save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var mutations, version, mutationRequests, res_1, etagMutations, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.dispatchStateChange();\r\n                        mutations = this.mutationQueue.get();\r\n                        version = this.currentVersion;\r\n                        this.mutationQueue.moveToSavingQueue();\r\n                        mutationRequests = this.mapMutations(mutations);\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 6, 11, 12]);\r\n                        return [4 /*yield*/, this.getClient().batch(mutationRequests)];\r\n                    case 2:\r\n                        res_1 = _a.sent();\r\n                        etagMutations = Object.keys(res_1.newEtags).map(function (id) { return ({\r\n                            op: 'update',\r\n                            table: null,\r\n                            id: id,\r\n                            deltaDoc: { $etag: res_1.newEtags[id] },\r\n                            targetName: null // We don't have the target name. But this mutation won't be visible in a DeltaCollection anyway, so it wont be used.\r\n                        }); });\r\n                        // Invalidate cache\r\n                        CacheBust.invalidateCache(mutationRequests, this.getUser());\r\n                        // Commmit mutations along with etagMutations into queries cached data\r\n                        this.persistedVersion.dispatch(version);\r\n                        this.deltaCache.applyMutations(mutations, { optimistic: false });\r\n                        return [4 /*yield*/, this.querySet.commitMutations(MutationQueue.merge(mutations, etagMutations), version)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        // On success, clear saving queue as the mutations will now be committed to all query's data instead.\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        // Finally, notify subscribers so that views get updated with committed results\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 5];\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 4:\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5: return [3 /*break*/, 12];\r\n                    case 6:\r\n                        error_1 = _a.sent();\r\n                        this.persistedVersion.dispatchError(error_1);\r\n                        if (!(error_1 && error_1.name && error_1.name.startsWith(\"http4\"))) return [3 /*break*/, 9];\r\n                        // Access Control denied, bad request or similar. Throw mutations away.\r\n                        this.dispatchError(error_1, false);\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 8];\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 7:\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        _a.sent();\r\n                        _a.label = 8;\r\n                    case 8: return [3 /*break*/, 10];\r\n                    case 9:\r\n                        this.dispatchError(error_1, true);\r\n                        _a.label = 10;\r\n                    case 10: return [3 /*break*/, 12];\r\n                    case 11:\r\n                        this.dispatchStateChange();\r\n                        return [7 /*endfinally*/];\r\n                    case 12: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mapMutations = function (mutations) {\r\n        var br = new BatchRunner();\r\n        mutations.forEach(function (m) {\r\n            switch (m.op) {\r\n                case 'update':\r\n                    br.update(m.table, m.id, m.deltaDoc, m.branchId);\r\n                    break;\r\n                case 'add':\r\n                    br.add(m.table, m.doc);\r\n                    break;\r\n                case 'add-related':\r\n                    if (!m.relatedDoc.$etag) {\r\n                        // No $etag means this is a new document. Add it before linking to it:\r\n                        br.add(tables[m.table].relationships[m.graphProp], m.relatedDoc, m.branchId);\r\n                    }\r\n                    br.link2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'remove-related':\r\n                    br.unlink2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'undo-link':\r\n                    br.undoLink(m.table, m.id, m.graphProp, m.relatedId, m.branchId);\r\n                    break;\r\n                case 'delete':\r\n                    br.delete(m.table, m.id);\r\n                    break;\r\n                case 'clear-branch':\r\n                    br.clearBranch(m.branchId);\r\n                    break;\r\n                case 'merge':\r\n                    br.merge(m.branchId, m.targetBranchId);\r\n                    break;\r\n            }\r\n        });\r\n        return br.mutationRequests;\r\n    };\r\n    return KedBackendWriter;\r\n}());\r\nexport { KedBackendWriter };\r\n//# sourceMappingURL=kedbackend-writer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { getTableFromLabel, branchSensitive, globalOp } from './utils';\r\nimport { mergeDeltas } from './delta-merge';\r\nvar MutationQueue = /** @class */ (function () {\r\n    function MutationQueue() {\r\n        this.queue = [];\r\n        this.savingQueue = [];\r\n    }\r\n    MutationQueue.prototype.add = function (mutations) {\r\n        this.queue = MutationQueue.merge(this.queue, mutations);\r\n    };\r\n    MutationQueue.prototype.moveToSavingQueue = function () {\r\n        this.savingQueue = MutationQueue.merge(this.savingQueue, this.queue);\r\n        this.queue = [];\r\n    };\r\n    MutationQueue.prototype.clearSavingQueue = function () {\r\n        this.savingQueue = [];\r\n    };\r\n    MutationQueue.prototype.get = function () {\r\n        return this.savingQueue.concat(this.queue);\r\n    };\r\n    MutationQueue.prototype.affectsQuery = function (table, query, includes) {\r\n        var mutations = this.get();\r\n        if (mutations.some(function (m) { return m.op === 'merge' || m.op === 'clear-branch'; }))\r\n            return true;\r\n        if (query.ids) {\r\n            // A query with \"ids\" filter will be easy to detect a no-match on:\r\n            return mutations.some(function (m) { return globalOp(m) || (!branchSensitive(m) || m.branchId === query.branchId) &&\r\n                query.ids.includes(m.id); });\r\n        }\r\n        // Otherwise, check if mutations affect same branch and table. Could be done more fine grained,\r\n        // but that would only be a suboptimization.\r\n        return mutations.some(function (m) {\r\n            return m.op === 'add' ?\r\n                m.table === table :\r\n                m.op === 'delete' ?\r\n                    m.table === table || (includes.some(function (label) { return getTableFromLabel(table, label) === m.table; })) :\r\n                    globalOp(m) ? true :\r\n                        m.branchId == query.branchId &&\r\n                            (m.table === table || (m.op !== 'update' && ([table].concat(includes.map(function (label) { return getTableFromLabel(table, label); })).some(function (table) { return getTableFromLabel(m.table, m.graphProp) === table; }))));\r\n        });\r\n    };\r\n    MutationQueue.merge = function (queue1, queue2) {\r\n        var mutableQueue1 = queue1.slice();\r\n        var mutableQueue2 = queue2.slice();\r\n        //if (mutableQueue1.length > 0) debugger;\r\n        var len = queue1.length;\r\n        var _loop_1 = function (i) {\r\n            var m = queue1[i];\r\n            if (m.op === 'update') {\r\n                var overlappingIdOpIdx = mutableQueue2.findIndex(function (newMut) {\r\n                    return newMut.op === 'update' &&\r\n                        newMut.branchId === m.branchId &&\r\n                        newMut.id === m.id;\r\n                });\r\n                if (overlappingIdOpIdx >= 0) {\r\n                    mutableQueue1[i] = tslib_1.__assign({}, m, { deltaDoc: mergeDeltas(m.deltaDoc, mutableQueue2[overlappingIdOpIdx].deltaDoc) });\r\n                    mutableQueue2.splice(overlappingIdOpIdx, 1);\r\n                }\r\n            }\r\n        };\r\n        for (var i = 0; i < len; ++i) {\r\n            _loop_1(i);\r\n        }\r\n        return mutableQueue1.concat(mutableQueue2);\r\n    };\r\n    return MutationQueue;\r\n}());\r\nexport { MutationQueue };\r\n//# sourceMappingURL=mutation-queue.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport * as JsonSchema from 'kedbackend-schema/schema.json';\r\nimport { queryArray } from './utils';\r\nvar QuerySet = /** @class */ (function () {\r\n    function QuerySet(mutationQueue) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.queries = [];\r\n    }\r\n    QuerySet.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, Promise.all(this.queries.map(function (q) { return q.commitMutations(mutations, version); }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.cleanupInvalidQueries();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QuerySet.prototype.cleanupInvalidQueries = function () {\r\n        this.queries = this.queries.filter(function (q) {\r\n            if (q.invalid) {\r\n                if (q.timeoutHandle) {\r\n                    clearTimeout(q.timeoutHandle);\r\n                    q.timeoutHandle = null;\r\n                }\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n    };\r\n    QuerySet.prototype.notifySubscribers = function () {\r\n        var optimisticMutations = this.mutationQueue.get();\r\n        this.queries.forEach(function (q) {\r\n            q.notifySubscribers(optimisticMutations);\r\n        });\r\n    };\r\n    QuerySet.prototype.findQuery = function (table, query) {\r\n        return this.queries.find(function (q) { return q.queryKey === KedBackendQuery.queryKey(table, query); });\r\n    };\r\n    QuerySet.prototype.queryLocally = function (table, query, includes) {\r\n        // For now, only handle this very common and special case (which\r\n        // will save a lot of unnescessary network traffic if I am thinking right...)\r\n        var mutations = this.mutationQueue.get();\r\n        // Check if the query wants to get a single entity by its ID:\r\n        if (query.ids && query.ids.length === 1) {\r\n            // And if so, if we have an outgoing mutation to create that entity:\r\n            if (mutations.some(function (m) { return m.op === 'add-related' && m.relatedDoc.id === query.ids[0]; })) {\r\n                // Then return an EMPTY response, signalling that we can resolve this locally,\r\n                // but let the optistic feature of KedBackendQuery apply the mutation before\r\n                // notifying subscribers (we don't want it to be persistent before the server\r\n                // has accepted the mutation)\r\n                return [];\r\n            }\r\n        }\r\n        // OK, another quite common case is when we ask for a certain ID and that ID replies\r\n        // within another query\r\n        if (query.hasEdgesFrom || query.hasEdgesTo)\r\n            return null; // Not possible to handle\r\n        if (!query.ids)\r\n            return null; // For now, just take hight for this particular and most common case!\r\n        var _loop_1 = function (q) {\r\n            if (!q.gotInitialResponse)\r\n                return \"continue\";\r\n            if (q.query.branchId !== query.branchId)\r\n                return \"continue\";\r\n            if (q.query.flags)\r\n                return \"continue\"; // It would be complex to support various flags. Query's data may include ids only. Can't rely on the query.\r\n            var qIncludes = q.includes;\r\n            if (qIncludes.length > 0 && (!query.include || query.include.length === 0)) {\r\n                // We don't include, but this query does. Check if we can find our result within it.\r\n                var label = qIncludes.find(function (l) { return JsonSchema.tables[q.table][\"relationships\"][l] === table; });\r\n                if (label) {\r\n                    var res_1 = {};\r\n                    for (var _i = 0, _a = q.data; _i < _a.length; _i++) {\r\n                        var entity = _a[_i];\r\n                        var subData = queryArray(query, entity[label]);\r\n                        subData.forEach(function (r) { return res_1[r.id] = r; });\r\n                    }\r\n                    var result_1 = Object.keys(res_1).map(function (id) { return res_1[id]; });\r\n                    // Only return result if we could look up every requested ID:\r\n                    if (!query.ids.every(function (id) { return result_1.some(function (x) { return x.id === id; }); }))\r\n                        return \"continue\";\r\n                    return { value: result_1 };\r\n                }\r\n            }\r\n            if (!includes.every(function (label) { return qIncludes.includes(label); }))\r\n                return \"continue\";\r\n            // Lastly, if the query includes all graphs that we do, pick the subset from that query.\r\n            // Concrete example: We observe a certain Task by ID and want its knowledgeRequirements along with it,\r\n            // and there's another query of all tasks that also includes knowledgeRequirements. Use it. \r\n            if (q.table === table) {\r\n                var result_2 = queryArray(query, q.data);\r\n                // Only return result if we could look up every requested ID:\r\n                if (!query.ids.every(function (id) { return result_2.some(function (x) { return x.id === id; }); }))\r\n                    return \"continue\";\r\n                return { value: result_2 };\r\n            }\r\n        };\r\n        for (var _i = 0, _a = this.queries; _i < _a.length; _i++) {\r\n            var q = _a[_i];\r\n            var state_1 = _loop_1(q);\r\n            if (typeof state_1 === \"object\")\r\n                return state_1.value;\r\n        }\r\n    };\r\n    QuerySet.prototype.subscribe = function (subscription) {\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (!kbQuery) {\r\n            kbQuery = new KedBackendQuery(table, query, repo.getUser(), repo, this.mutationQueue);\r\n            this.queries.push(kbQuery);\r\n        }\r\n        else {\r\n            if (kbQuery.timeoutHandle) {\r\n                clearTimeout(kbQuery.timeoutHandle);\r\n                kbQuery.timeoutHandle = null;\r\n            }\r\n        }\r\n        kbQuery.subscribe(subscription);\r\n    };\r\n    QuerySet.prototype.unsubscribe = function (subscription) {\r\n        var _this = this;\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (kbQuery) {\r\n            // Prohibit further notifications to this subscription:\r\n            kbQuery.unsubscribe(subscription);\r\n            // Release unnescessary memory when there are no more subscriptions of this query, by removing the query itself\r\n            // To that in a delayed manner, so that an unsubscribe() followed by an immediate subscribe() don't have to re-query the server:\r\n            if (kbQuery.subscriptions.length === 0) {\r\n                // Schedule for garbage collection in 5 minutes:\r\n                kbQuery.timeoutHandle = setTimeout(function () {\r\n                    // Check if kbQuery still has no subscriptions (not certain! A new subscriber may have come along...)\r\n                    if (kbQuery.subscriptions.length === 0) {\r\n                        // Still no subscriptions on it, time to release some memory and forget the in-memory cache of the query result\r\n                        _this.queries = _this.queries.filter(function (q) { return q !== kbQuery; });\r\n                    }\r\n                }, this.queries.length > 50 ?\r\n                    500 : // Don't host too many queries. Garbage collect this within 500 ms\r\n                    5 * 60000); // Allow query in memory for another 5 minutes\r\n            }\r\n        }\r\n    };\r\n    return QuerySet;\r\n}());\r\nexport { QuerySet };\r\n//# sourceMappingURL=query-set.js.map","import { tables } from 'kedbackend-schema/schema.json';\r\nexport function getTableFromLabel(table, label) {\r\n    return tables[table].relationships[label];\r\n}\r\nexport function queryArray(query, data) {\r\n    var filter = getFilterFromQuery(query);\r\n    return data.filter(filter);\r\n}\r\nexport function AND(filter1, filter2) {\r\n    return function (x) { return filter1(x) && filter2(x); };\r\n}\r\nexport function getFilterFromQuery(query) {\r\n    var filter = function (x) { return true; };\r\n    if (query.from)\r\n        return AND(filter, function (x) { return x.dateTime >= query.from; });\r\n    if (query.to)\r\n        return AND(filter, function (x) { return x.dateTime < query.to; });\r\n    if (query.ids)\r\n        return AND(filter, function (x) { return query.ids.includes(x.id); });\r\n    if (query.name)\r\n        return AND(filter, function (x) { return x.name === query.name; });\r\n    if (query.tags)\r\n        return AND(filter, function (x) { return x.tags && [].concat(query.tags || []).some(function (tag) { return x.tags.includes(tag); }); });\r\n    // query.hasEdgesFrom and query.hasEdgesTo cannot by filtered here\r\n    return filter;\r\n}\r\nexport function branchSensitive(m) {\r\n    return m.op !== 'delete';\r\n}\r\nexport function globalOp(m) {\r\n    return m.op === 'clear-branch' || m.op === 'merge';\r\n}\r\n//# sourceMappingURL=utils.js.map","import migrate from './migrate';\r\nexport var KedModelMigratorMixin = function (client) {\r\n    if (client.__migrator_mixed_in)\r\n        return;\r\n    client.__migrator_mixed_in = true;\r\n    var get = client.get;\r\n    var list = client.list;\r\n    client.get = function (table, id, options) {\r\n        var include = options && options.include;\r\n        return get.apply(this, arguments).then(function (result) {\r\n            migrate(result, table, include && include.toString().split(','));\r\n            return result;\r\n        });\r\n    };\r\n    client.list = function (table, options) {\r\n        var include = options && options.include;\r\n        return list.apply(this, arguments).then(function (result) {\r\n            result.forEach(function (doc) { return migrate(doc, table, include && include.toString().split(',')); });\r\n            return result;\r\n        });\r\n    };\r\n    return client;\r\n};\r\n//# sourceMappingURL=index.js.map","import migrateTask from './migrate-task';\r\nexport default function migrateCourse(course, graphs) {\r\n    if (!course.modules)\r\n        course.modules = [];\r\n    course.modules.forEach(function (module) {\r\n        if (!module.resources) {\r\n            module.resources = [];\r\n        }\r\n        if (!module.taskIds) {\r\n            module.taskIds = [];\r\n        }\r\n    });\r\n    if (!course.responsibleTeachers) {\r\n        course.responsibleTeachers = [];\r\n    }\r\n    // Earlier wrong spelling of resources\r\n    if ('resourses' in course && !('resources' in course)) {\r\n        course.resources = course.resourses;\r\n        delete course.resourses;\r\n    }\r\n    if (!course.resources) {\r\n        course.resources = [];\r\n    }\r\n    if (graphs) {\r\n        graphs.forEach(function (label) {\r\n            switch (label) {\r\n                case 'tasks':\r\n                    course.tasks.forEach(function (task) { return migrateTask(task); });\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=migrate-course.js.map","export default function migrateTask(task) {\r\n    if (!task.resources)\r\n        task.resources = [];\r\n}\r\n//# sourceMappingURL=migrate-task.js.map","import migrateCourse from './migrate-course';\r\nimport migrateTask from './migrate-task';\r\nexport default function migrate(doc, table, graphs) {\r\n    switch (table) {\r\n        case \"courses\":\r\n            migrateCourse(doc, graphs);\r\n            break;\r\n        case \"tasks\":\r\n            migrateTask(doc);\r\n            break;\r\n    }\r\n}\r\n//# sourceMappingURL=migrate.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Value } from \"./value\";\r\nimport { Emitter } from \"./emitter\";\r\nvar Collection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Collection, _super);\r\n    function Collection(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Collection.prototype._map = function (mapper) {\r\n        throw \"mixedin\";\r\n    };\r\n    Collection.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Collection(function (s) { return x.subscribe(s); });\r\n        if (Array.isArray(x)) {\r\n            var emitter_1 = new Emitter(x);\r\n            return new Collection(function (s) { return emitter_1.subscribe(s); });\r\n        }\r\n        throw new Error(\"ObservableCollection.from() can only take arrays or observables\");\r\n    };\r\n    Collection.prototype.map = function (mapper) {\r\n        return this._map(function (items) { return items.map(function (item) { return mapper(item); }); });\r\n    };\r\n    Collection.prototype.flat = function () {\r\n        return this._map(function (items) { return [].concat.apply([], items); });\r\n    };\r\n    Collection.prototype.filter = function (filter) {\r\n        return this._map(function (items) { return items.filter(filter); });\r\n    };\r\n    Collection.prototype.concat = function (other) {\r\n        return Collection.from(this.toValue().combineLatest(other).map(function (_a) {\r\n            var me = _a[0], other = _a[1];\r\n            return me.concat(other);\r\n        }));\r\n    };\r\n    Collection.prototype.orderBy = function (prop) {\r\n        return this.toValue().map(function (array) { return array.slice().sort(function (a, b) {\r\n            var aProp = a && a[prop];\r\n            var bProp = b && b[prop];\r\n            return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n        }); }).toCollection(function (x) { return x; });\r\n    };\r\n    Collection.prototype.toValue = function () {\r\n        var _this = this;\r\n        return new Value(function (s) { return _this.subscribe(s); });\r\n    };\r\n    Collection.prototype.groupBy = function (prop) {\r\n        return this.toValue().map(function (items) {\r\n            var rv = {};\r\n            items.forEach(function (item) {\r\n                var list = rv[item[prop]] || (rv[item[prop]] = []);\r\n                list.push(item);\r\n            });\r\n            return rv;\r\n        });\r\n    };\r\n    Collection.prototype.first = function () {\r\n        return this.toValue().map(function (arr) { return arr[0]; });\r\n    };\r\n    return Collection;\r\n}(Observable));\r\nexport { Collection };\r\nCollection.prototype._map = initMapMethod(Collection);\r\n//# sourceMappingURL=collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Value } from \"./value\";\r\nvar Emitter = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Emitter, _super);\r\n    function Emitter(initialValue) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = {\r\n                unsubscribe: function () { return _this.subscribers = _this.subscribers.filter(function (_a) {\r\n                    var s = _a[0];\r\n                    return s !== observer;\r\n                }); },\r\n            };\r\n            _this.subscribers.push([observer, subscription]);\r\n            if (_this.error)\r\n                observer(null, _this.error, subscription);\r\n            else\r\n                observer(_this.value, undefined, subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.subscribers = [];\r\n        _this.value = initialValue;\r\n        return _this;\r\n    }\r\n    Emitter.prototype.dispatch = function (value) {\r\n        this.value = value;\r\n        this.error = undefined;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype.dispatchError = function (error) {\r\n        this.error = error;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype._dispatch = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (_a) {\r\n            var observer = _a[0], subscription = _a[1];\r\n            try {\r\n                observer(_this.value, _this.error, subscription);\r\n            }\r\n            catch (err) {\r\n                observer(null, err, subscription);\r\n            }\r\n        });\r\n    };\r\n    return Emitter;\r\n}(Value));\r\nexport { Emitter };\r\n//# sourceMappingURL=emitter.js.map","var stack = [];\r\nvar currentFiber = null;\r\nvar providers = [function () { return currentFiber; }];\r\nfunction pushFiber(fiber) {\r\n    stack.push(currentFiber);\r\n    currentFiber = fiber;\r\n}\r\nfunction popFiber() {\r\n    currentFiber = stack.pop();\r\n}\r\nvar _FiberContext = {\r\n    get current() { return currentFiber; },\r\n    /*run: function rerun<R>(fiber: Fiber, fn: ()=>R): R | Promise<R> {\r\n      pushFiber(fiber);\r\n      try {\r\n        return Promise.resolve(fn());\r\n      } catch (p) {\r\n        if (p && typeof p.then === 'function') {\r\n          return p.then(()=>rerun(fiber, fn));\r\n        } else {\r\n          return Promise.reject(p);\r\n        }\r\n      } finally {\r\n        popFiber();\r\n      }\r\n    },*/\r\n    addProvider: function (getCurrentFiber) {\r\n        providers.push(getCurrentFiber);\r\n        setCurrentGetterFromProviders();\r\n    },\r\n    removeProvider: function (getCurrentFiber) {\r\n        providers = providers.filter(function (p) { return p !== getCurrentFiber; });\r\n        setCurrentGetterFromProviders();\r\n    }\r\n};\r\nfunction setCurrentGetterFromProviders() {\r\n    Object.defineProperty(_FiberContext, \"current\", {\r\n        get: providers.reduce(function (p, c) { return function () { return p() || c(); }; }),\r\n        set: function () { throw new Error(\"Use FiberContext.push() to change current fiber\"); }\r\n    });\r\n}\r\nvar _global = (typeof self === 'undefined' ? global : self);\r\nif (!_global[\"KEDFiberContext\"]) {\r\n    _global[\"KEDFiberContext\"] = _FiberContext;\r\n}\r\nexport var FiberContext = _global[\"KEDFiberContext\"];\r\n//# sourceMappingURL=fiber-context.js.map","export * from './observable';\r\nexport * from './value';\r\nexport * from './collection';\r\nexport * from './emitter';\r\nexport * from './fiber-context';\r\n//# sourceMappingURL=index.js.map","export function initMapMethod(ctor) {\r\n    return function (mapper) {\r\n        var _this = this;\r\n        return new ctor(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else\r\n                try {\r\n                    observer(mapper(value), error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n        }); });\r\n    };\r\n}\r\n//# sourceMappingURL=map.js.map","export function mixin(targetProto, mixinProto) {\r\n    var props = [];\r\n    for (var _i = 2; _i < arguments.length; _i++) {\r\n        props[_i - 2] = arguments[_i];\r\n    }\r\n    props.forEach(function (prop) { return targetProto[prop] = mixinProto[prop]; });\r\n}\r\n//# sourceMappingURL=mixin.js.map","var Observable = /** @class */ (function () {\r\n    //static get [Symbol.species]() { return this; }\r\n    function Observable(_subscribe) {\r\n        this._subscribe = _subscribe;\r\n    }\r\n    Observable.prototype.subscribe = function (observer) {\r\n        try {\r\n            return this._subscribe(function (items, error, subscription) {\r\n                try {\r\n                    observer(items, error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n            });\r\n        }\r\n        catch (error) {\r\n            observer(null, error, { unsubscribe: function () { } });\r\n        }\r\n    };\r\n    return Observable;\r\n}());\r\nexport { Observable };\r\n//# sourceMappingURL=observable.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Collection } from \"./collection\";\r\nimport { FiberContext } from './fiber-context';\r\nvar Value = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Value, _super);\r\n    function Value(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Value.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Value(function (s) { return x.subscribe(s); });\r\n        throw new Error(\"Value.from() can only take observables\");\r\n    };\r\n    Value.prototype.read = function () {\r\n        var resolved = false, result, err, notify;\r\n        var subscription = this.subscribe(function (value, error, subsciption) {\r\n            resolved = true;\r\n            result = value;\r\n            err = error;\r\n            if (error && notify)\r\n                notify(null, error, subsciption);\r\n            else if (notify)\r\n                notify(value, null, subsciption);\r\n        });\r\n        if (resolved) {\r\n            var currentFiber = FiberContext.current;\r\n            if (!currentFiber) {\r\n                subscription.unsubscribe();\r\n                throw new Error(\"Invalid Fiber Context\");\r\n            }\r\n            if (err) {\r\n                subscription.unsubscribe();\r\n                throw err;\r\n            }\r\n            var subscriptions = currentFiber.subscriptions, observer = currentFiber.observer;\r\n            subscriptions.push(subscription);\r\n            notify = observer;\r\n            return result;\r\n        }\r\n        throw new Promise(function (resolve, reject) {\r\n            notify = function (value, error, subscription) {\r\n                subscription.unsubscribe();\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n            };\r\n        });\r\n    };\r\n    Value.prototype.load = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.subscribe(function (value, error, subsciption) {\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n                subsciption.unsubscribe();\r\n            });\r\n        });\r\n    };\r\n    Value.prototype.filter = function (fn) {\r\n        var _this = this;\r\n        return new Value(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else if (fn(value))\r\n                observer(value, error, subscription);\r\n        }); });\r\n    };\r\n    Value.prototype.log = function (prefix) {\r\n        return this.map(function (x) {\r\n            console.log(prefix, x);\r\n            return x;\r\n        });\r\n    };\r\n    Value.prototype.toCollection = function (mapper) {\r\n        var _this = this;\r\n        return new Collection(function (s) { return _this.map(mapper).subscribe(s); });\r\n    };\r\n    Value.prototype.combineLatest = function (other) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var values = [null, null];\r\n            var mySubscription, otherSubscription;\r\n            var subscription = {\r\n                unsubscribe: function () {\r\n                    mySubscription.unsubscribe();\r\n                    otherSubscription.unsubscribe();\r\n                }\r\n            };\r\n            mySubscription = _this.subscribe(function (items, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[0] = items;\r\n                if (values[1] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            otherSubscription = other.subscribe(function (value, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[1] = value;\r\n                if (values[0] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            return subscription;\r\n        });\r\n    };\r\n    Value.prototype.switchMap = function (mapper) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var mappedSubscription = null;\r\n            var subscription = null;\r\n            var returnedSubscription = {\r\n                unsubscribe: function () {\r\n                    subscription.unsubscribe();\r\n                    if (mappedSubscription) {\r\n                        mappedSubscription.unsubscribe();\r\n                        mappedSubscription = null;\r\n                    }\r\n                }\r\n            };\r\n            subscription = _this.subscribe(function (item, error, s) {\r\n                subscription = s;\r\n                if (mappedSubscription) {\r\n                    mappedSubscription.unsubscribe();\r\n                    mappedSubscription = null;\r\n                }\r\n                if (error)\r\n                    observer(null, error, returnedSubscription);\r\n                else {\r\n                    try {\r\n                        var observableOrValue = mapper(item);\r\n                        if (observableOrValue && typeof observableOrValue.subscribe === 'function') {\r\n                            mappedSubscription = observableOrValue.subscribe(function (value, error, s) {\r\n                                mappedSubscription = s;\r\n                                observer(value, error, returnedSubscription);\r\n                            });\r\n                        }\r\n                        else {\r\n                            observer(observableOrValue, null, subscription);\r\n                        }\r\n                    }\r\n                    catch (error) {\r\n                        observer(null, error, subscription);\r\n                    }\r\n                }\r\n            });\r\n            return returnedSubscription;\r\n        });\r\n    };\r\n    return Value;\r\n}(Observable));\r\nexport { Value };\r\nValue.prototype.map = initMapMethod(Value);\r\n//# sourceMappingURL=value.js.map","export * from './js/dist/js/observable';\r\n","export * from './js/dist/js/ked-backend-repo';\r\n","export default function getUserClaims(user) {\r\n    return [{\r\n            type: \"email\",\r\n            value: user.mail\r\n        }, {\r\n            type: \"school\",\r\n            value: user.school\r\n        }].concat(user.roles.map(function (role) { return ({\r\n        type: \"role\",\r\n        value: role\r\n    }); })).concat(user.roles.map(function (role) { return ({\r\n        type: \"schoolRole\",\r\n        value: user.school + \"/\" + role\r\n    }); }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { DocumentAccess, hasAccess as _hasAccess } from 'kedbackend/client';\r\nimport getUserClaims from './get-user-claims';\r\nimport { parseQueryString, generateQueryString } from \"../utils/query-string\";\r\nexport { getUserClaims };\r\nexport var IMPERSONATION_QUERY_PARAMS = [\r\n    \"user\",\r\n    \"role\",\r\n    \"school\",\r\n    \"debug\",\r\n    \"testVersion\",\r\n    \"testversion\",\r\n    \"features\",\r\n    \"schoolGrade\",\r\n    \"schoolgrade\",\r\n    \"schoolType\",\r\n    \"schooltype\"\r\n];\r\nexport function hasAccess(user, doc, requestedRight) {\r\n    var claims = getUserClaims(user);\r\n    if (requestedRight !== 'R' && user.tutorFor) {\r\n        claims = claims.filter(function (claim) { return claim.type !== 'email'; });\r\n    }\r\n    var result = _hasAccess(DocumentAccess.fromStringArray(doc.acl || []), claims, requestedRight);\r\n    //console.log(`Has ${requestedRight} access to ${doc.name}/${doc.id}: ${result}`);\r\n    return result;\r\n}\r\nexport function hasReadAccess(user, doc) {\r\n    return hasAccess(user, doc, 'R');\r\n}\r\nexport function hasWriteAccess(user, doc) {\r\n    return hasAccess(user, doc, 'W');\r\n}\r\nexport function hasShareAccess(user, doc) {\r\n    return hasAccess(user, doc, 'S');\r\n}\r\nexport function isTeacherAtSchool(user, school) {\r\n    var isTeacher = user.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\r\n    var belongsToSchool = (school || \"\").toLowerCase() === user.school.toLowerCase();\r\n    return (isTeacher && belongsToSchool);\r\n}\r\nexport function isAdminOrTeacherAtSchool(user, school) {\r\n    return user.roles.includes(\"ADMIN\") || isTeacherAtSchool(user, school);\r\n}\r\nexport var impersonationEnv = {\r\n    actAs: function (options) {\r\n        var role = options.role, school = options.school, url = options.url;\r\n        var currentQuery = parseQueryString(location.search);\r\n        var newQuery = tslib_1.__assign({}, currentQuery, { role: role, school: school });\r\n        var newQueryString = generateQueryString(newQuery);\r\n        if (url) {\r\n            location.href = \"\" + url + newQueryString;\r\n        }\r\n        else {\r\n            location.hash = \"#\";\r\n            location.search = newQueryString;\r\n        }\r\n    }\r\n};\r\nexport function actAs(options) {\r\n    impersonationEnv.actAs(options);\r\n}\r\nexport function preserveImpersonationQuery(url, query) {\r\n    var e_1, _a;\r\n    var currentQuery = parseQueryString(location.search);\r\n    var preservedQuery = {};\r\n    try {\r\n        for (var IMPERSONATION_QUERY_PARAMS_1 = tslib_1.__values(IMPERSONATION_QUERY_PARAMS), IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next(); !IMPERSONATION_QUERY_PARAMS_1_1.done; IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next()) {\r\n            var param = IMPERSONATION_QUERY_PARAMS_1_1.value;\r\n            if (currentQuery[param])\r\n                preservedQuery[param] = currentQuery[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (IMPERSONATION_QUERY_PARAMS_1_1 && !IMPERSONATION_QUERY_PARAMS_1_1.done && (_a = IMPERSONATION_QUERY_PARAMS_1.return)) _a.call(IMPERSONATION_QUERY_PARAMS_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    var newQueryString = generateQueryString(tslib_1.__assign({}, preservedQuery, query));\r\n    var pHash = url.indexOf('#');\r\n    return pHash >= 0 ?\r\n        \"\" + url.substr(0, pHash) + newQueryString + url.substr(pHash) :\r\n        \"\" + url + newQueryString;\r\n}\r\n","import React from \"react\";\r\nexport var Button = function (_a) {\r\n    var label = _a.label, addClass = _a.addClass, faIcon = _a.faIcon, action = _a.action, url = _a.url;\r\n    var className = addClass ? \"btn \" + addClass : 'btn';\r\n    if (!!url && !action)\r\n        return React.createElement(\"a\", { className: className, href: url, target: \"_blank\" },\r\n            faIcon && React.createElement(\"i\", { className: faIcon }),\r\n            \" \",\r\n            label);\r\n    return React.createElement(\"a\", { className: className, onClick: action },\r\n        faIcon && React.createElement(\"i\", { className: faIcon }),\r\n        \" \",\r\n        label);\r\n};\r\nexport var DriveButton = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? 'Google Drive' : _b, action = _a.action;\r\n    return React.createElement(Button, { label: label, faIcon: \"fab fa-google-drive\", action: action });\r\n};\r\n","// Client id for GoogleWebClient\r\nexport var WebClientId = \"421572262269-u68v5lf5o8ss5t68l8gkq3pfarh6dbkv.apps.googleusercontent.com\";\r\n// Google Drive File Id to json file with Tamplates for Course Builder (Classroom)\r\nexport var TemplatesFileId = 'https://docs.google.com/document/d/1V7exG6vN83Sq8kb6uz1B6DaZDVO9eLcJbP7XF0vL4dY/export?format=txt';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from 'kedbackend/client';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { getTermStarEndDate } from '../utils/school-moment';\r\nimport { SchoolTerm } from '../utils/school-term';\r\nimport { dateTimeReviver, L } from '../utils/utils';\r\nimport mockJsonFile from './mock/mock-eds-data.json';\r\nimport moment from 'moment';\r\nimport { makeSuspenseApi } from '../utils/make-suspense-api';\r\nvar EdsClient = /** @class */ (function () {\r\n    function EdsClient(isomorphic, baseUrl, bearerProvider, userEmailGetter) {\r\n        var _this = this;\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n        this.userEmailGetter = userEmailGetter;\r\n        var isApiMethod = function (m) {\r\n            return typeof _this[m] === 'function' &&\r\n                m !== 'constructor' && // Since makeSuspenseApi() walks prototype chain\r\n                m !== 'privatizingCacheBust' &&\r\n                m !== 'userEmailGetter';\r\n        } // List non-API methods here...\r\n        ;\r\n        Object.keys(EdsClient.prototype).forEach(function (method) {\r\n            if (isApiMethod(method)) {\r\n                _this[method] = avoidSimultanousCalls(_this[method]);\r\n            }\r\n        });\r\n        this.suspense = makeSuspenseApi(this, { isApiMethod: isApiMethod });\r\n    }\r\n    EdsClient.prototype.privatizingCacheBust = function () {\r\n        return { user: this.userEmailGetter() };\r\n    };\r\n    /**\r\n       * Retrieve active courses for current logged in student.\r\n       *\r\n       * @param courseCode Short-name of the course. Optional.\r\n       */\r\n    EdsClient.prototype.getActiveCourses = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json, ex_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _c.trys.push([0, 5, , 6]);\r\n                        query = this.privatizingCacheBust();\r\n                        if (q) {\r\n                            if (q.courseCode)\r\n                                query.CourseCode = q.courseCode;\r\n                            if (q.periodName)\r\n                                query.PeriodName = q.periodName;\r\n                        }\r\n                        return [4 /*yield*/, this.http.get(\"studentactivecourses\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.courses];\r\n                    case 5:\r\n                        ex_1 = _c.sent();\r\n                        console.error(\"Error from EDS: \" + ex_1);\r\n                        throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"], [\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"]))));\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve latest assessments for current logged in user.\r\n     *\r\n     * @param limit Optional limit\r\n     */\r\n    EdsClient.prototype.getLatestAssessments = function (limit) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = this.privatizingCacheBust();\r\n                        if (!isNaN(limit))\r\n                            query.Count = limit;\r\n                        return [4 /*yield*/, this.http.get(\"studentassessments\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.assessments];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve studyplans for current logged-in user\r\n     */\r\n    EdsClient.prototype.getStudentGoals = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentgoals\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentGoals];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getStudentFutureAbilities = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentFutureAbilities\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentFutureAbilities];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getTeacherTutorStudents = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"teachertutorstudents\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.students];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTuitionGroups()\r\n     *\r\n     * Return tuitiongroups for school\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param courseCode - Skolverkets code for course\r\n     */\r\n    EdsClient.prototype.getSchoolTuitionGroups = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTuitionGroups\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTuitionGroups];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getTuitionGroupStudents()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param tuitionGroupName - tuition gruop name in EDS\r\n     */\r\n    EdsClient.prototype.getTuitionGroupStudents = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"TuitionGroupStudents\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.tuitionGroupStudents];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTeachers()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     */\r\n    EdsClient.prototype.getSchoolTeachers = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTeachers\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTeachers];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // we assume that the EDS will return the current academic year dates determined by the current date\r\n    EdsClient.prototype.getAcademicYearTerms = function (schoolLocale, date) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var holidays, firstTermMoment, secondTermMoment, startFirstTermDate, startSecondTermDate, endFirstTermDate, endSecondTermDate, firstTerm, secondTerm;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                // mock data\r\n                switch (schoolLocale) {\r\n                    case 'en_sin':\r\n                        return [2 /*return*/, mockJsonFile.SouthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'en_nin':\r\n                        return [2 /*return*/, mockJsonFile.NorthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'sv':\r\n                        {\r\n                            holidays = [];\r\n                            firstTermMoment = getTermStarEndDate(date, true);\r\n                            secondTermMoment = getTermStarEndDate(date, false);\r\n                            startFirstTermDate = firstTermMoment[0];\r\n                            startSecondTermDate = secondTermMoment[0];\r\n                            endFirstTermDate = firstTermMoment[1];\r\n                            endSecondTermDate = secondTermMoment[1];\r\n                            firstTerm = { startDate: new Date(startFirstTermDate.year(), startFirstTermDate.month(), startFirstTermDate.date()).toDateString(), endDate: new Date(startFirstTermDate.year(), endFirstTermDate.month(), endFirstTermDate.date()).toDateString() };\r\n                            secondTerm = { startDate: new Date(startSecondTermDate.year(), startSecondTermDate.month(), startSecondTermDate.date()).toDateString(), endDate: new Date(startSecondTermDate.year(), endSecondTermDate.month(), endSecondTermDate.date()).toDateString() };\r\n                            return [2 /*return*/, { firstTerm: firstTerm, secondTerm: secondTerm, holidays: holidays }];\r\n                        }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return EdsClient;\r\n}());\r\nexport { EdsClient };\r\nvar EDSPeriod = /** @class */ (function () {\r\n    function EDSPeriod(periodStringOrSchoolTerm) {\r\n        if (typeof periodStringOrSchoolTerm === 'string') {\r\n            this.period = periodStringOrSchoolTerm;\r\n            this.term = this.period.startsWith('HT') ? 'AT' : 'ST';\r\n            this.year = parseInt(this.period.substr(2));\r\n            if (isNaN(this.year))\r\n                throw new Error(\"Invalid period: \" + this.period);\r\n        }\r\n        else {\r\n            var schoolTerm = new SchoolTerm(periodStringOrSchoolTerm);\r\n            this.period = (schoolTerm.term === 'AT' ? \"HT\" : \"VT\") + schoolTerm.year;\r\n            this.term = schoolTerm.term;\r\n            this.year = schoolTerm.year;\r\n        }\r\n    }\r\n    Object.defineProperty(EDSPeriod.prototype, \"schoolTerm\", {\r\n        get: function () {\r\n            return new SchoolTerm({\r\n                academicYear: this.term === 'AT' ?\r\n                    this.year + \"/\" + (this.year + 1) :\r\n                    this.year - 1 + \"/\" + this.year,\r\n                term: this.term\r\n            });\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    EDSPeriod.prototype.toString = function () {\r\n        return this.period;\r\n    };\r\n    EDSPeriod.prototype.valueOf = function () {\r\n        return this.year + \":\" + (this.term === 'ST' ? \"1\" : \"2\");\r\n    };\r\n    return EDSPeriod;\r\n}());\r\nexport { EDSPeriod };\r\nexport function parseJsonDate_old(jsonDateStr) {\r\n    var date = dateTimeReviver(\"\", jsonDateStr);\r\n    if (!(date instanceof Date))\r\n        throw new Error(\"Invalid JSON date string: \" + jsonDateStr);\r\n    return date;\r\n}\r\nfunction avoidSimultanousCalls(method) {\r\n    var ongoingPromises = {};\r\n    return function () {\r\n        var argsJson = JSON.stringify([].slice.call(arguments));\r\n        if (!ongoingPromises[argsJson]) {\r\n            ongoingPromises[argsJson] = method.apply(this, arguments).then(function (result) {\r\n                delete ongoingPromises[argsJson];\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromises[argsJson];\r\n    };\r\n}\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { env } from '../globals/KED.env';\r\nvar GoogleClient = /** @class */ (function () {\r\n    function GoogleClient(_a) {\r\n        var discoveryDocs = _a.discoveryDocs;\r\n        this.googleTokenProvider = env.googleTokenProvider;\r\n        this.discoveryDocs = [];\r\n        this.discoveryDocs.push(discoveryDocs);\r\n    }\r\n    GoogleClient.prototype.setBearerProvider = function (googleTokenProvider) {\r\n        this.googleTokenProvider = googleTokenProvider;\r\n    };\r\n    GoogleClient.prototype.ensureInited = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var tokenResult;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(typeof gapi === 'undefined')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadGapi()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (!(!this.tokenExpiration || this.tokenExpiration < new Date())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.googleTokenProvider.getBearer()];\r\n                    case 3:\r\n                        tokenResult = _a.sent();\r\n                        this.tokenExpiration = new Date(tokenResult.expires);\r\n                        this.token = tokenResult.token;\r\n                        _a.label = 4;\r\n                    case 4: \r\n                    // Load all discovyerDocs\r\n                    return [4 /*yield*/, gapi.client.init({\r\n                            discoveryDocs: this.discoveryDocs\r\n                        })];\r\n                    case 5:\r\n                        // Load all discovyerDocs\r\n                        _a.sent();\r\n                        return [4 /*yield*/, gapi.client.setToken({\r\n                                access_token: this.token\r\n                            })];\r\n                    case 6:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleClient.prototype.loadGapi = function () {\r\n        return new Promise(function (resolve) {\r\n            if (typeof gapi !== 'undefined')\r\n                return resolve();\r\n            var script = document.createElement('script');\r\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\r\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n            window.gaapi_loaded = resolve;\r\n        });\r\n    };\r\n    return GoogleClient;\r\n}());\r\nexport { GoogleClient };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleClient } from './google-client';\r\nvar GoogleDrive = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoogleDrive, _super);\r\n    function GoogleDrive() {\r\n        return _super.call(this, { discoveryDocs: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest' }) || this;\r\n    }\r\n    GoogleDrive.prototype.getFile = function (fileId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.get({\r\n                                fileId: fileId,\r\n                                supportsAllDrives: true,\r\n                                fields: 'id,name,mimeType,webViewLink,iconLink,modifiedTime,thumbnailLink'\r\n                            }).then(function (resp) {\r\n                                if (resp.result.name) {\r\n                                    var file = resp.result;\r\n                                    return { fileId: file.id, url: file.webViewLink, mimeType: file.mimeType, name: file.name, modiifiedTime: file.modifiedTime, iconUrl: file.iconLink, thumbnailUrl: file.thumbnailLink };\r\n                                }\r\n                                return null;\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * updatePermissions()\r\n     *\r\n     * @param fileId\r\n     *\r\n     * Make the file accessible to all in the domain. Should be unnecessary but some\r\n     * teachers have changed their default permissions.\r\n     * We don't care right now if this fails because this is just an extra precaution.\r\n     * If we plan on using this on other domains the domain-attribute needs to be dynamic.\r\n     *\r\n     */\r\n    GoogleDrive.prototype.updatePermissions = function (fileId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 2, , 3]);\r\n                        console.log('updating permissions');\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        gapi.client.drive.permissions.create({\r\n                            fileId: fileId,\r\n                            sendNotificationEmail: false,\r\n                            role: 'reader',\r\n                            type: 'anyone',\r\n                            // type: 'domain', \r\n                            // domain: 'kunskapsskolan.se'\r\n                            supportsAllDrives: true\r\n                        }).then(function (resp) { return console.log(resp); });\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        error_1 = _a.sent();\r\n                        console.log('unable to update permissions');\r\n                        return [3 /*break*/, 3];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Creates a folder with given name in a parent folder\r\n     * @param name folder name\r\n     * @param parent parent folders id\r\n     */\r\n    GoogleDrive.prototype.createFolder = function (name, parent) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Creating folder ' + name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.create({\r\n                                name: name,\r\n                                mimeType: 'application/vnd.google-apps.folder',\r\n                                parents: [parent]\r\n                            }).then(function (resp) { return resp.result; })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Gets the id for the folder in a path. If folder/path does not exists\r\n     * a new folder at that path is created.\r\n     * @param path the path to the file from root folder as an array\r\n     */\r\n    GoogleDrive.prototype.getIdForFolderPath = function (path) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var parent, path_1, path_1_1, folder, folderId, newFolder, e_1_1;\r\n            var e_1, _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        console.log('Getting id for ' + path.join('/'));\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        parent = 'root';\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        _b.trys.push([2, 9, 10, 11]);\r\n                        path_1 = tslib_1.__values(path), path_1_1 = path_1.next();\r\n                        _b.label = 3;\r\n                    case 3:\r\n                        if (!!path_1_1.done) return [3 /*break*/, 8];\r\n                        folder = path_1_1.value;\r\n                        return [4 /*yield*/, this.getIdForFolder(folder, parent)];\r\n                    case 4:\r\n                        folderId = _b.sent();\r\n                        if (!folderId) return [3 /*break*/, 5];\r\n                        parent = folderId;\r\n                        return [3 /*break*/, 7];\r\n                    case 5: return [4 /*yield*/, this.createFolder(folder, parent)];\r\n                    case 6:\r\n                        newFolder = _b.sent();\r\n                        parent = newFolder.id;\r\n                        _b.label = 7;\r\n                    case 7:\r\n                        path_1_1 = path_1.next();\r\n                        return [3 /*break*/, 3];\r\n                    case 8: return [3 /*break*/, 11];\r\n                    case 9:\r\n                        e_1_1 = _b.sent();\r\n                        e_1 = { error: e_1_1 };\r\n                        return [3 /*break*/, 11];\r\n                    case 10:\r\n                        try {\r\n                            if (path_1_1 && !path_1_1.done && (_a = path_1.return)) _a.call(path_1);\r\n                        }\r\n                        finally { if (e_1) throw e_1.error; }\r\n                        return [7 /*endfinally*/];\r\n                    case 11: return [2 /*return*/, parent];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Gets the id for a folder in a given parent folder\r\n     * @param name name of folder\r\n     * @param parent parent folders id\r\n     */\r\n    GoogleDrive.prototype.getIdForFolder = function (name, parent) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Getting id for ' + name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.list({\r\n                                corpora: 'user',\r\n                                q: \"'\" + parent + \"' in parents and mimeType = 'application/vnd.google-apps.folder' and name = '\" + name + \"'\"\r\n                            }).then(function (resp) {\r\n                                if (resp.result.files.length) {\r\n                                    return resp.result.files[0].id;\r\n                                }\r\n                                else {\r\n                                    return false;\r\n                                }\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Copies a file to a destination\r\n     * @param file\r\n     * @param destination the destination as an array of folder names\r\n     */\r\n    GoogleDrive.prototype.copyFile = function (file, destination) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var parent_1, parent_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Copying file: ' + file.name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        if (!destination) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.getIdForFolderPath(destination)];\r\n                    case 2:\r\n                        parent_1 = _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        parent_2 = 'root';\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/, gapi.client.drive.files.copy({\r\n                            fileId: file.id,\r\n                            supportsAllDrives: true,\r\n                            parents: [parent],\r\n                            name: file.name,\r\n                            fields: 'id,name,mimeType,webViewLink,iconLink,modifiedTime,thumbnailLink'\r\n                        }).then(function (resp) { return resp.result; })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.handInFile = function (fileId, student, newOwner, teachers) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var batch;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        // This should:\r\n                        // - add teachers to editors of file\r\n                        // - makes newOwner the owner of the file\r\n                        // - makes the caller a reader of the file\r\n                        // Now it makes teachers editors\r\n                        console.log('handing in file');\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        batch = gapi.client.newBatch();\r\n                        return [4 /*yield*/, teachers.forEach(function (teacher) {\r\n                                batch.add(gapi.client.drive.permissions.create({\r\n                                    fileId: fileId,\r\n                                    sendNotificationEmail: false,\r\n                                    role: 'writer',\r\n                                    type: 'user',\r\n                                    emailAddress: teacher\r\n                                }));\r\n                            })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        batch.then(function (resp) { return console.log(resp); });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.reclaimFile = function (file, student, teachers) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.returnFile = function (file, student) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.updateUrkundProperties = function (file) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * downloadFile()\r\n     * @param file\r\n     *\r\n     * When Classroom has been integrated we will want to handle only the fileId:s\r\n     * so that editing capabilities are peserved on the file (if it is a google-apps file)\r\n     * Right now google-apps files are converted to pdf and passed into the current flow.\r\n     *\r\n     * TODO: error handling\r\n     */\r\n    GoogleDrive.prototype.downloadFile = function (_a) {\r\n        var file = _a.file, limitSize = _a.limitSize, mimeType = _a.mimeType;\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var type, xhrDownload_1;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: \r\n                    // A file that can be exported to PDF is retreived with\r\n                    // file.export() from Drive, converted to a blob and then\r\n                    // to a File.\r\n                    // A file that can not be exported to PDF is retrieved\r\n                    // through XHR and converted to a File.\r\n                    // If we don't need to handle the physical files on the client\r\n                    // we could save only the fileId:s and display filename and mimeType\r\n                    // for the file in our listings. When/if we use Google Classroom for\r\n                    // our task-handling that would be the preferred approach to keep\r\n                    // the file as an editable Google file\r\n                    // Init the drive-api (only needed for download so not loaded initially)\r\n                    return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        // A file that can be exported to PDF is retreived with\r\n                        // file.export() from Drive, converted to a blob and then\r\n                        // to a File.\r\n                        // A file that can not be exported to PDF is retrieved\r\n                        // through XHR and converted to a File.\r\n                        // If we don't need to handle the physical files on the client\r\n                        // we could save only the fileId:s and display filename and mimeType\r\n                        // for the file in our listings. When/if we use Google Classroom for\r\n                        // our task-handling that would be the preferred approach to keep\r\n                        // the file as an editable Google file\r\n                        // Init the drive-api (only needed for download so not loaded initially)\r\n                        _b.sent();\r\n                        type = mimeType ? mimeType : 'application/pdf';\r\n                        if (file.canExport) {\r\n                            return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                    gapi.client.drive.files.export({\r\n                                        fileId: file.fileId,\r\n                                        mimeType: type\r\n                                    }).then(function (resp) {\r\n                                        var len = resp.body.length;\r\n                                        var data = new Uint8Array(new ArrayBuffer(len));\r\n                                        for (var i = 0; i < len; i++) {\r\n                                            data[i] = resp.body.charCodeAt(i);\r\n                                        }\r\n                                        var blob = new Blob([data], { type: type });\r\n                                        var filename = file.name + '.pdf';\r\n                                        resolve(new File([blob], filename, { type: type, lastModified: file.modifiedTime }));\r\n                                    });\r\n                                })];\r\n                        }\r\n                        else {\r\n                            xhrDownload_1 = function (file) {\r\n                                return new Promise(function (resolve, reject) {\r\n                                    var xhr = new XMLHttpRequest();\r\n                                    xhr.open(\"GET\", \"https://www.googleapis.com/drive/v3/files/\" + file.fileId + '?alt=media', true);\r\n                                    xhr.setRequestHeader('Authorization', 'Bearer ' + _this.token);\r\n                                    xhr.responseType = 'blob';\r\n                                    xhr.onload = function () {\r\n                                        resolve(new File([xhr.response], file.name, { type: file.mimeType, lastModified: file.modifiedTime }));\r\n                                    };\r\n                                    xhr.send();\r\n                                });\r\n                            };\r\n                            return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                    if (limitSize !== undefined) {\r\n                                        gapi.client.drive.files.get({\r\n                                            fileId: file.fileId,\r\n                                            fields: 'size'\r\n                                        }).then(function (resp) {\r\n                                            var size = Number(resp.result.size);\r\n                                            if (size > limitSize * 1024 * 1024) {\r\n                                                reject('GooglePickerError: Fildsize is too laarge');\r\n                                            }\r\n                                        }).then(function () {\r\n                                            xhrDownload_1(file).then(function (resp) {\r\n                                                resolve(resp);\r\n                                            });\r\n                                        });\r\n                                    }\r\n                                    else {\r\n                                        xhrDownload_1(file).then(function (resp) {\r\n                                            resolve(resp);\r\n                                        });\r\n                                    }\r\n                                })];\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return GoogleDrive;\r\n}(GoogleClient));\r\nexport { GoogleDrive };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleWebClient } from './google-webclient';\r\nimport { GoogleDrive } from './google-drive';\r\nvar mimeTypeCollections = {\r\n    'google-apps': 'application/vnd.google-apps.document,application/vnd.google-apps.presentation,application/vnd.google-apps.spreadsheet',\r\n    'pdf': 'application/pdf'\r\n};\r\n/**\r\n * GooglePicker\r\n * Includes the initiation of the correct api:s.\r\n * Certain options can be passed to the constructor\r\n * and there could be others worth incorporating (i.e. Team Drive-support).\r\n *\r\n * Right now two options are handled:\r\n * - upload: if a user can upload to Drive in the Google Drive Picker\r\n * - multiple: if a user can select multiple files\r\n * - limitType: active limits to certain mimeTypesCollections\r\n * - mineOnly: if only show files owned by the user\r\n *\r\n * We could probably split this into google-picker and google-drive where google-drive\r\n * handles the explicit calls to the google drive api.\r\n */\r\nvar GooglePicker = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GooglePicker, _super);\r\n    function GooglePicker(options) {\r\n        var _this = _super.call(this, { scopes: ['https://www.googleapis.com/auth/drive'] }) || this;\r\n        _this.options = { upload: false, multiple: false, limitType: false, onlyMine: false };\r\n        Object.assign(_this.options, options);\r\n        _this.drive = new GoogleDrive();\r\n        return _this;\r\n    }\r\n    /**\r\n     * show()\r\n     *\r\n     * If a single file is requested from the picker a list of files with one element is returned.\r\n     * It is up to the caller to handle the list in a relevant manner.\r\n     *\r\n     * More data from the file could be extracted if it is deemed necessary.\r\n     *\r\n     */\r\n    GooglePicker.prototype.show = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                var callback = function (response) {\r\n                                    if (response['action'] == google.picker.Action.CANCEL) {\r\n                                        reject();\r\n                                    }\r\n                                    else if (response['action'] == google.picker.Action.PICKED) {\r\n                                        var selected_1 = [];\r\n                                        response.docs.map(function (doc) {\r\n                                            var fileId = doc.id, mimeType = doc.mimeType, name = doc.name, modifiedTime = doc.modifiedTime, iconUrl = doc.iconUrl, url = doc.url;\r\n                                            var canExport = mimeType.includes('google-apps');\r\n                                            selected_1.push({ fileId: fileId, mimeType: mimeType, name: name, modifiedTime: modifiedTime, canExport: canExport, iconUrl: iconUrl, url: url });\r\n                                            // update permissions to read by all in domain\r\n                                            _this.drive.updatePermissions(fileId);\r\n                                        });\r\n                                        resolve(selected_1);\r\n                                    }\r\n                                };\r\n                                var pickerbuilder = new google.picker.PickerBuilder()\r\n                                    .enableFeature(google.picker.Feature.SUPPORT_DRIVES)\r\n                                    .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)\r\n                                    .addView(new google.picker.DocsView()\r\n                                    .setOwnedByMe(true) // should this be an option?\r\n                                    .setIncludeFolders(true))\r\n                                    .addView(new google.picker.DocsView()\r\n                                    .setIncludeFolders(true)\r\n                                    .setEnableTeamDrives(true))\r\n                                    .setLocale(\"sv\") // should this be an option?\r\n                                    .setSize(1051, 650) // should this be an option?\r\n                                    .setOAuthToken(_this.authToken)\r\n                                    .setCallback(callback);\r\n                                if (_this.options.upload) {\r\n                                    pickerbuilder.addView(new google.picker.DocsUploadView().setIncludeFolders(true));\r\n                                }\r\n                                if (_this.options.multiple) {\r\n                                    pickerbuilder.enableFeature(google.picker.Feature.MULTISELECT_ENABLED);\r\n                                }\r\n                                if (_this.options.onlyMine) {\r\n                                    pickerbuilder.enableFeature(google.picker.Feature.MINE_ONLY);\r\n                                }\r\n                                if (_this.options.limitType) {\r\n                                    var mimeTypes = mimeTypeCollections[_this.options.limitType];\r\n                                    console.log(mimeTypes);\r\n                                    pickerbuilder.setSelectableMimeTypes(mimeTypes);\r\n                                }\r\n                                _this.picker = pickerbuilder.build();\r\n                                _this.picker.setVisible(true);\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GooglePicker.prototype.close = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.picker.dispose();\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return GooglePicker;\r\n}(GoogleWebClient));\r\nexport { GooglePicker };\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../globals/KED.env';\r\nimport { WebClientId } from './configs';\r\nvar GoogleWebClient = /** @class */ (function () {\r\n    function GoogleWebClient(_a) {\r\n        var _b;\r\n        var _c = _a.scopes, scopes = _c === void 0 ? [] : _c;\r\n        this.scopes = ['https://www.googleapis.com/auth/userinfo.email', 'https://www.googleapis.com/auth/userinfo.profile'];\r\n        (_b = this.scopes).push.apply(_b, tslib_1.__spread(scopes));\r\n    }\r\n    GoogleWebClient.prototype.ensureInited = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var SCOPES;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(typeof gapi === \"undefined\")) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadGapi()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        SCOPES = this.scopes.join(' ');\r\n                        return [4 /*yield*/, new Promise(function (resolve, reject) {\r\n                                gapi.load(\"client:auth2\", function () {\r\n                                    // Calls authorize without prompting the user. If authorization hasn't been given by\r\n                                    // the user an error is returned and we call authorize again with consent-screen\r\n                                    var reauthorize = false;\r\n                                    return gapi.auth2.authorize({\r\n                                        client_id: WebClientId,\r\n                                        scope: SCOPES,\r\n                                        response_type: 'permission',\r\n                                        login_hint: env.currentUser.mail,\r\n                                        prompt: 'none'\r\n                                    }, function (resp) {\r\n                                        console.table(resp);\r\n                                        if (resp.error) {\r\n                                            // no consent given so reauthorize\r\n                                            reauthorize = true;\r\n                                        }\r\n                                        else {\r\n                                            // check if we have all the scopes we want\r\n                                            var scopeset_1 = new Set(resp.scope.split(' '));\r\n                                            var missingScopes = _this.scopes.filter(function (x) { return !scopeset_1.has(x); });\r\n                                            if (missingScopes.length > 0) {\r\n                                                console.log('missing scopes');\r\n                                                // scopes are missing from our consent so reauthorize\r\n                                                reauthorize = true;\r\n                                            }\r\n                                            else {\r\n                                                // everything seems to be ok so store our token\r\n                                                _this.authToken = resp.access_token;\r\n                                                resolve();\r\n                                            }\r\n                                        }\r\n                                        if (reauthorize) {\r\n                                            console.log('reauthorize');\r\n                                            return gapi.auth2.authorize({\r\n                                                client_id: WebClientId,\r\n                                                scope: SCOPES,\r\n                                                response_type: 'permission',\r\n                                                login_hint: env.currentUser.mail,\r\n                                                prompt: 'consent'\r\n                                            }, function (resp) {\r\n                                                console.table(resp);\r\n                                                if (resp.error) {\r\n                                                    // something is still wrong so throw an error\r\n                                                    reject('Google Web Client: No access token');\r\n                                                }\r\n                                                else {\r\n                                                    // we now have a token (hopefully with the right scopes)\r\n                                                    // should we check again?\r\n                                                    _this.authToken = resp.access_token;\r\n                                                    resolve();\r\n                                                }\r\n                                            });\r\n                                        }\r\n                                        if (resp.expires_in < 500) {\r\n                                            return gapi.auth2.authorize({\r\n                                                client_id: WebClientId,\r\n                                                scope: SCOPES,\r\n                                                response_type: 'permission',\r\n                                                login_hint: env.currentUser.mail,\r\n                                                prompt: 'none'\r\n                                            }, function (resp) {\r\n                                                _this.authToken = resp.access_token;\r\n                                                resolve();\r\n                                            });\r\n                                        }\r\n                                    });\r\n                                });\r\n                            })];\r\n                    case 3:\r\n                        _a.sent();\r\n                        if (!(typeof google === \"undefined\" || typeof google.picker === \"undefined\")) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, new Promise(function (resolve) {\r\n                                gapi.load(\"picker\", function () { resolve(); });\r\n                            })];\r\n                    case 4:\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5:\r\n                        if (!(typeof gapi.client === \"undefined\" || typeof gapi.client.classroom === \"undefined\")) return [3 /*break*/, 7];\r\n                        return [4 /*yield*/, new Promise(function (resolve) {\r\n                                gapi.client.load(\"classroom\", 'v1', function () { resolve(); });\r\n                            })];\r\n                    case 6:\r\n                        _a.sent();\r\n                        _a.label = 7;\r\n                    case 7: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleWebClient.prototype.loadGapi = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            if (typeof gapi !== \"undefined\")\r\n                return resolve();\r\n            var script = document.createElement(\"script\");\r\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\r\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n            window.gaapi_loaded = resolve;\r\n        });\r\n    };\r\n    return GoogleWebClient;\r\n}());\r\nexport { GoogleWebClient };\r\n","import * as tslib_1 from \"tslib\";\r\nvar createStudents = function (group, n, m) {\r\n    var students = [];\r\n    for (var i = n; i <= m; i++) {\r\n        students.push({\r\n            schoolName: 'KED',\r\n            tuitionGroupName: group,\r\n            studentFirstName: 'Student ' + i,\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student' + i + '.classroom@kedschools.com'\r\n        });\r\n    }\r\n    return students;\r\n};\r\nexport var mockTeachers = [\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 1',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher1.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 2',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher2.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 3',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher3.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Carl',\r\n        teacherLastName: 'Holmberg',\r\n        teacherEmailAddress: 'carl@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'David',\r\n        teacherLastName: 'Fahlander',\r\n        teacherEmailAddress: 'david.fahlander@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Andrei',\r\n        teacherLastName: 'Spatarelu',\r\n        teacherEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Andrei',\r\n        teacherLastName: 'Spatarelu',\r\n        teacherEmailAddress: 'andrei@kedschools.com'\r\n    }\r\n];\r\nexport var mockTuitionGroups = {\r\n    'DJUSL01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR1 (180816-190614)',\r\n            courseCode: 'DJUSL01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR2 (180816-190614)',\r\n            courseCode: 'DJUSL01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            courseCode: 'DJUSL01'\r\n        }\r\n    ],\r\n    'DJUDJI0': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            courseCode: 'DJUDJI0'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            courseCode: 'DJUDJI0'\r\n        },\r\n    ],\r\n    'KEMKEM01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            courseCode: 'KEMKEM01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            courseCode: 'KEMKEM01'\r\n        }\r\n    ],\r\n    \"MATMAT03b\": [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr1 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr2 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr3 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        }\r\n    ],\r\n    'BIOBIO01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            courseCode: 'BIOBIO01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            courseCode: 'BIOBIO01'\r\n        }\r\n    ],\r\n    'SVESVE03': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr1 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr2 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr3 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr4 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr5 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr6 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr7 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        }\r\n    ]\r\n};\r\nexport var mockTuitionStudents = {\r\n    'DJUR1_GR1 (180816-190614)': createStudents('DJUR1_GR1 (180816-190614)', 1, 12),\r\n    'DJUR1_GR2 (180816-190614)': createStudents('DJUR1_GR2 (180816-190614)', 13, 24),\r\n    'DJUR1_GR3 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Student2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Student3',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student3.classroom@kedschools.com'\r\n        }\r\n    ], createStudents('DJUR1_GR3 (180816-190614)', 23, 34)),\r\n    'DJUDJ_Gr1 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'David',\r\n            studentLastName: 'Fahlander',\r\n            studentEmailAddress: 'david.fahlander@kedschools.com'\r\n        }\r\n    ], createStudents('DJUDJ_Gr1 (180816-190614)', 151, 160)),\r\n    'DJUDJ_Gr2 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'David',\r\n            studentLastName: 'Fahlander',\r\n            studentEmailAddress: 'david.fahlander@kedschools.com'\r\n        }\r\n    ], createStudents('DJUDJ_Gr2 (180816-190614)', 161, 165)),\r\n    'MAT3b_Gr1 (180816-190614)': createStudents('MAT3b_Gr1 (180816-190614)', 3, 23),\r\n    'MAT3b_Gr3 (180816-190614)': createStudents('MAT3b_Gr3 (180816-190614)', 24, 49),\r\n    'MAT3b_Gr2 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr2 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei@kedschools.com'\r\n        }\r\n    ], createStudents('MAT3b_Gr2 (180816-190614)', 50, 72)),\r\n    'IDR1_Gr1 (180816-190614)': createStudents('IDR1_Gr1 (180816-190614)', 1, 12),\r\n    'IDR1_Gr2 (180816-190614)': createStudents('IDR1_Gr2 (180816-190614)', 13, 22),\r\n    'IDR1_Gr3 (180816-190614)': createStudents('IDR1_Gr3 (180816-190614)', 23, 34),\r\n    'KEM1_Gr1 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 3',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student3.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 8',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student8.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 9',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student9.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'KEM1_Gr2 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 1',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student1.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 5',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student5.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 6',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student6.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'BIO1_Gr1 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 1',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student1.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 4',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student4.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 6',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student6.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 10',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student10.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'BIO1_Gr2 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 7',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student7.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 8',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student8.classroom@kedschools.com'\r\n        },\r\n    ],\r\n    'SVE3_Gr1 (180816-190614)': createStudents('SVE3_Gr1 (180816-190614)', 1, 21),\r\n    'SVE3_Gr2 (180816-190614)': createStudents('SVE3_Gr2 (180816-190614)', 22, 44),\r\n    'SVE3_Gr3 (180816-190614)': createStudents('SVE3_Gr3 (180816-190614)', 45, 61),\r\n    'SVE3_Gr4 (180816-190614)': createStudents('SVE3_Gr4 (180816-190614)', 62, 78),\r\n    'SVE3_Gr5 (180816-190614)': createStudents('SVE3_Gr5 (180816-190614)', 83, 107),\r\n    'SVE3_Gr6 (180816-190614)': createStudents('SVE3_Gr6 (180816-190614)', 108, 124),\r\n    'SVE3_Gr7 (180816-190614)': createStudents('SVE3_Gr7 (180816-190614)', 125, 150)\r\n};\r\n","export function courseNameToCssClass(cssPrefix, courseName) {\r\n    return \"\" + cssPrefix + courseName.substr(0, 3).toLowerCase();\r\n}\r\n","export function getWeekplannerProgressData(taskSets) {\r\n    var chartTasks = { completedTasks: 0, totalNumberOfTasks: 0, subjectData: {} };\r\n    taskSets.forEach(function (elem) { return elem.learningGoals.forEach(function (x) {\r\n        var subjectCompletedTasks = x.tasks.filter(function (t) { return t.done; }).length;\r\n        var courseSubjectData = chartTasks.subjectData[elem.courseName];\r\n        if (!courseSubjectData) {\r\n            courseSubjectData = chartTasks.subjectData[elem.courseName] = {\r\n                completedNumberOfTasks: 0,\r\n                numberOfTasks: 0\r\n            };\r\n        }\r\n        courseSubjectData.completedNumberOfTasks += subjectCompletedTasks;\r\n        courseSubjectData.numberOfTasks += x.tasks.length;\r\n        chartTasks.completedTasks += subjectCompletedTasks;\r\n        chartTasks.totalNumberOfTasks += x.tasks.length;\r\n    }); });\r\n    return chartTasks;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar GoalProgress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoalProgress, _super);\r\n    function GoalProgress() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.createProgress = function () {\r\n            var _a = _this.props, numberOfTasks = _a.numberOfTasks, completedNumberOfTasks = _a.completedNumberOfTasks, maximumTasksDisplayed = _a.maximumTasksDisplayed, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n            var progress = [];\r\n            if (numberOfTasks > maximumTasksDisplayed) {\r\n                return React.createElement(\"div\", { className: \"progress-overview\" },\r\n                    \" \",\r\n                    completedNumberOfTasks,\r\n                    \" / \",\r\n                    numberOfTasks,\r\n                    \" \");\r\n            }\r\n            for (var taskNo = 1; taskNo <= numberOfTasks; taskNo++) {\r\n                progress.push(React.createElement(\"svg\", { key: taskNo },\r\n                    React.createElement(\"circle\", { className: \"circle-chart-background\", fill: taskNo > completedNumberOfTasks ? backgroundColor : progressColor, cx: \"8\", cy: \"8\", r: \"8\" })));\r\n            }\r\n            return progress;\r\n        };\r\n        return _this;\r\n    }\r\n    GoalProgress.prototype.render = function () {\r\n        return React.createElement(\"div\", { className: \"goals-progress\" }, this.createProgress());\r\n    };\r\n    GoalProgress.defaultProps = {\r\n        numberofTasks: 0,\r\n        completedNumberOfTasks: 0,\r\n        maximumTasksDisplayed: 10,\r\n        backgroundColor: \"lightgrey\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return GoalProgress;\r\n}(React.Component));\r\nexport { GoalProgress };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar Progress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Progress, _super);\r\n    function Progress() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    Progress.prototype.render = function () {\r\n        var _a = this.props, percentage = _a.percentage, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n        var roundedPercentage = Math.round(percentage);\r\n        return (React.createElement(\"svg\", { className: \"progress-chart\", width: \"100%\", height: \"25\" },\r\n            React.createElement(\"rect\", { fill: backgroundColor, width: \"100%\", height: \"100%\", rx: \"4\" }),\r\n            React.createElement(\"rect\", { className: \"fill\", fill: progressColor, width: roundedPercentage + \"%\", height: \"100%\", rx: \"4\" }),\r\n            React.createElement(\"text\", { className: \"filled-text\", textAnchor: \"middle\", x: \"50%\", y: \"50%\", dy: \".3em\" }, roundedPercentage + \"%\")));\r\n    };\r\n    Progress.defaultProps = {\r\n        percentage: 0,\r\n        backgroundColor: \"#F1F5F4\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return Progress;\r\n}(React.Component));\r\nexport { Progress };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { EllipsisLoader } from '../../course-builder/sub-components/ellipsis-loader';\r\nimport { preserveImpersonationQuery } from '../../../access-control';\r\nimport { L } from '../../../utils/utils';\r\nvar LazyBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LazyBanner, _super);\r\n    function LazyBanner() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.dragState = new Emitter({ tabBeingDragged: '', tabBeingHovered: '', insertBefore: false, originClientX: -1 });\r\n        return _this;\r\n    }\r\n    LazyBanner.prototype.render = function () {\r\n        var _this = this;\r\n        var lazyProps = this.props.lazyProps;\r\n        return (React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\", style: { overflow: \"visible\" } },\r\n            React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n                React.createElement(\"div\", { className: \"sv-script-portlet sv-portlet sv-skip-spacer\" },\r\n                    React.createElement(LazyContent, { noError: true }, lazyProps.map(function (_a) {\r\n                        var backgroundImage = _a.backgroundImage;\r\n                        return backgroundImage && React.createElement(\"style\", null, \"\\n              .pageHeader {\\n                background-image: url('\" + backgroundImage + \"') !important;\\n              }\\n            \");\r\n                    })),\r\n                    React.createElement(\"div\", { className: \"pageHeader\" },\r\n                        React.createElement(\"a\", null,\r\n                            React.createElement(\"h1\", null,\r\n                                React.createElement(LazyContent, { noError: true }, lazyProps.map(function (props) { return React.createElement(React.Fragment, null, props.title); })))),\r\n                        React.createElement(LazyContent, { noError: true }, lazyProps.map(function (_a) {\r\n                            var cornerBox = _a.cornerBox;\r\n                            return cornerBox &&\r\n                                React.createElement(\"div\", { className: \"pageHeaderCornerBox\" }, cornerBox);\r\n                        })),\r\n                        React.createElement(\"div\", { className: \"buttonsField\" },\r\n                            React.createElement(\"div\", { className: \"buttonsContainer\" },\r\n                                React.createElement(LazyContent, { spinner: React.createElement(EllipsisLoader, null) }, lazyProps.map(function (_a) {\r\n                                    var tabs = _a.tabs, buttons = _a.buttons, activeTab = _a.activeTab, blocks = _a.blocks, sortableTabs = _a.sortableTabs, onTabDrop = _a.onTabDrop;\r\n                                    return React.createElement(React.Fragment, null,\r\n                                        blocks ? React.createElement(\"div\", { className: \"align-horizontal\" }, blocks.map(function (block) { return React.createElement(\"div\", { key: block.id, className: \"horizontalItem top\" },\r\n                                            React.createElement(\"div\", { className: \"align-vertical\" },\r\n                                                React.createElement(\"div\", null,\r\n                                                    React.createElement(\"a\", null, block.name)),\r\n                                                React.createElement(\"div\", null,\r\n                                                    React.createElement(\"div\", { className: \"btn-group\" }, block.steps.map(function (step) { return React.createElement(React.Fragment, { key: step.stepNo },\r\n                                                        React.createElement(Link, { to: step.link, className: \"btn btn-small step-button\" + (step.isActive ? \" activePage\" : \"\") }, step.stepNo),\r\n                                                        React.createElement(\"a\", null)); }))))); })) : null,\r\n                                        React.createElement(\"div\", { className: 'horizontalMenu' },\r\n                                            React.createElement(LazyContent, null, _this.dragState.map(function (_a) {\r\n                                                var tabBeingDragged = _a.tabBeingDragged, tabBeingHovered = _a.tabBeingHovered, insertBefore = _a.insertBefore, originClientX = _a.originClientX;\r\n                                                return React.createElement(\"ul\", { className: sortableTabs ? \"sortable\" : null, onDrop: onTabDrop ? function (ev) {\r\n                                                        if (tabBeingHovered && tabBeingDragged) {\r\n                                                            onTabDrop(tabBeingDragged, tabBeingHovered, insertBefore ?\r\n                                                                'before' : 'after');\r\n                                                        }\r\n                                                        _this.dragState.dispatch(tslib_1.__assign({}, _this.dragState.value, { tabBeingHovered: '', tabBeingDragged: '' }));\r\n                                                    } : null },\r\n                                                    tabs.map(function (_a, idx) {\r\n                                                        var name = _a.name, key = _a.key, link = _a.link, onClick = _a.onClick, draggable = _a.draggable;\r\n                                                        var isActive = activeTab === key || (activeTab === '$' && idx === 0);\r\n                                                        var dragState = _this.dragState;\r\n                                                        name = name || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"(Namnl\\u00F6s flik)\"], [\"(Namnl\\u00F6s flik)\"])));\r\n                                                        return React.createElement(React.Fragment, { key: key },\r\n                                                            insertBefore && tabBeingHovered === key ? React.createElement(\"li\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") : null,\r\n                                                            React.createElement(\"li\", { className: [\r\n                                                                    isActive ? \"activePage\" : \"\",\r\n                                                                    key === tabBeingDragged ? \"drag-source\" : \"\",\r\n                                                                    sortableTabs && draggable ? \"draggable\" : \"\"\r\n                                                                ].filter(function (x) { return x; }).join(' '), draggable: sortableTabs && draggable, onDragStart: sortableTabs && draggable ? function (ev) {\r\n                                                                    ev.dataTransfer.effectAllowed = \"move\";\r\n                                                                    dragState.dispatch(tslib_1.__assign({}, dragState.value, { originClientX: ev.clientX, tabBeingDragged: key }));\r\n                                                                } : null, onDragOver: sortableTabs ? function (ev) {\r\n                                                                    if (tabBeingDragged === key) {\r\n                                                                        dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: '' }));\r\n                                                                        return;\r\n                                                                    }\r\n                                                                    if (!tabBeingDragged)\r\n                                                                        return;\r\n                                                                    ev.preventDefault();\r\n                                                                    ev.dataTransfer.dropEffect = \"move\";\r\n                                                                    //console.log(\"onDragOver: \" + name + \". idx: \" + idx + \". otherIdx: \" + otherIdx);\r\n                                                                    dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: key, insertBefore: originClientX > ev.clientX }));\r\n                                                                } : null, onDragEnd: function (ev) {\r\n                                                                    _this.dragState.dispatch(tslib_1.__assign({}, dragState.value, { tabBeingHovered: '', tabBeingDragged: '' }));\r\n                                                                } }, link ? link.startsWith(\":\") ?\r\n                                                                React.createElement(\"a\", { href: preserveImpersonationQuery(link.substr(1), {}) }, name) :\r\n                                                                React.createElement(Link, { to: link }, name) :\r\n                                                                onClick ?\r\n                                                                    React.createElement(\"a\", { onClick: onClick }, name) :\r\n                                                                    name),\r\n                                                            !insertBefore && tabBeingHovered === key ? React.createElement(\"li\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") : null);\r\n                                                    }),\r\n                                                    buttons && buttons.map(function (btn, idx) { return React.createElement(\"li\", { className: \"action-tab\", key: \"btn\" + idx }, btn); }));\r\n                                            }))));\r\n                                })))))))));\r\n    };\r\n    return LazyBanner;\r\n}(React.Component));\r\nexport { LazyBanner };\r\nexport var Banner = function (props) { return React.createElement(LazyBanner, { lazyProps: new Emitter(props) }); };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { Dialogs } from '../../utility-components/dialogs';\r\nimport { DialogsContext } from './dialog-context';\r\nexport var setupDialogs = function (Component) {\r\n    return /** @class */ (function (_super) {\r\n        tslib_1.__extends(DialogContent, _super);\r\n        function DialogContent(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            _this.state = {\r\n                dialogs: []\r\n            };\r\n            _this.openDialog = _this.openDialog.bind(_this);\r\n            _this.closeDialog = _this.closeDialog.bind(_this);\r\n            return _this;\r\n        }\r\n        DialogContent.prototype.openDialog = function (dialog) {\r\n            this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\r\n        };\r\n        DialogContent.prototype.closeDialog = function () {\r\n            this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\r\n        };\r\n        DialogContent.prototype.render = function () {\r\n            var dialogs = this.state.dialogs;\r\n            return React.createElement(DialogsContext.Provider, { value: { openDialog: this.openDialog, closeDialog: this.closeDialog } },\r\n                React.createElement(Component, tslib_1.__assign({}, this.props)),\r\n                React.createElement(Dialogs, { dialogs: dialogs, popDialog: this.closeDialog }));\r\n        };\r\n        return DialogContent;\r\n    }(React.Component));\r\n};\r\n","import React from 'react';\r\nexport var DialogsContext = React.createContext({ openDialog: null, closeDialog: null });\r\n","export var FieldLimits = {\r\n    MAX_CHARS_IN_CONTENTS: 4000,\r\n    MAX_CHARS_TASK_NAMES: 64,\r\n    MAX_CHARS_TASK_INTRO_TEXT: 200\r\n};\r\n","import React from 'react';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nexport var FutureAbilitiesBox = function (_a) {\r\n    var title = _a.title, selectedFAs = _a.selectedFAs;\r\n    return React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: \"larger\" },\r\n        React.createElement(\"div\", { className: \"abilityList\" }, selectedFAs.map(function (fa) {\r\n            return React.createElement(\"div\", { key: fa, className: \"contentPart\" },\r\n                React.createElement(\"div\", { className: \"contentText\" },\r\n                    React.createElement(\"p\", null, fa)));\r\n        })));\r\n};\r\n","import React, { Suspense } from 'react';\r\nimport { WordBankContentSettings } from '../viewer-editor/course-contents/word-bank-content-settings';\r\nimport { EllipsisLoader } from '../../course-builder/sub-components/ellipsis-loader';\r\nimport { cfg } from '../../../globals/KED.cfg';\r\nexport var SelectWordBank = function (_a) {\r\n    var subject = _a.subject, step = _a.step, onSelect = _a.onSelect;\r\n    return React.createElement(\"div\", { style: { minHeight: 400 } },\r\n        React.createElement(Suspense, { fallback: React.createElement(EllipsisLoader, null) },\r\n            React.createElement(WordBankContentSettings, { subjectName: subject, stepNo: step, onChange: function (_a) {\r\n                    var name = _a.name, key = _a.key;\r\n                    var url = cfg.KED_WORDBANKS_URL + \"?subject=\" + subject + \"&step=\" + step + \"&list=\" + key;\r\n                    onSelect({ name: name, url: url });\r\n                } })));\r\n};\r\n","import * as React from 'react';\r\nexport var TwoColumnsPage = function (_a) {\r\n    var left = _a.left, right = _a.right, rightWidth = _a.rightWidth;\r\n    return (React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n            React.createElement(\"div\", { className: \"sv-spacer-20pxvt sv-vertical sv-layout sv-skip-spacer\" },\r\n                React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" },\r\n                    React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n                        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-\" + (12 - rightWidth) }, left),\r\n                        React.createElement(\"div\", { className: \"sv-layout sv-column-\" + rightWidth }, right)))))));\r\n};\r\n","export function reorder(docs, sourceId, targetId, placement) {\r\n    var docsWithIdx = docs.map(function (doc, idx) { return ({ doc: doc, idx: idx }); });\r\n    var sourceWithIdx = docsWithIdx.filter(function (_a) {\r\n        var doc = _a.doc;\r\n        return doc.id === sourceId;\r\n    })[0];\r\n    var targetWithIdx = docsWithIdx.filter(function (_a) {\r\n        var doc = _a.doc;\r\n        return doc.id === targetId;\r\n    })[0];\r\n    if (sourceWithIdx && targetWithIdx) {\r\n        var targetIdx = targetWithIdx.idx;\r\n        var newOrder = sourceWithIdx.doc.order;\r\n        if (placement === 'after') {\r\n            // Place source after target\r\n            if (targetIdx === docs.length - 1) {\r\n                // Target is last\r\n                newOrder = Date.now(); // Date.now() is always last (unless a tab is meaningfully given a future order - then let it stay last!)\r\n            }\r\n            else {\r\n                // Give an order between target and its current neighbour to the right\r\n                newOrder = docs[targetIdx].order + Math.random() * (docs[targetIdx + 1].order - docs[targetIdx].order);\r\n            }\r\n        }\r\n        else {\r\n            // Place source before target\r\n            if (targetIdx === 0) {\r\n                // Target is first\r\n                newOrder = Math.round(docs[0].order - 100 - 10000 * Math.random());\r\n            }\r\n            else {\r\n                // Give an order between target and its current neighbor to the left\r\n                newOrder = docs[targetIdx - 1].order + Math.random() * (docs[targetIdx].order - docs[targetIdx - 1].order);\r\n            }\r\n        }\r\n        return newOrder;\r\n    }\r\n    return 0;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten, distinct } from '../../../utils/utils';\r\nexport function computeTaskTagsAndSubject(course, tab, block) {\r\n    var tags = [course.id];\r\n    if (tab.tabClass === 'mission-tab') {\r\n        // If task belongs to a mission tab,\r\n        // it should be tagged with all the subjects of the course\r\n        var otherSubjectTabs = course.tabs\r\n            .filter(function (tab) { return tab.tabClass === 'subject-tab'; });\r\n        var subjects = distinct(otherSubjectTabs.map(function (tab) { return tab.subject; }), function (s) { return s.subjectCode; });\r\n        var courseCodeTags = distinct(flatten(otherSubjectTabs.map(function (tab) { return tab.tags.filter(function (tag) { return tag.startsWith(\"course:\"); }); })));\r\n        tags.push.apply(tags, tslib_1.__spread(subjects.map(function (s) { return \"sub:\" + s.subjectCode; })));\r\n        tags.push.apply(tags, tslib_1.__spread(courseCodeTags));\r\n        var subject = subjects.map(function (s) { return s.subjectName; }).join(', ');\r\n        return { tags: tags, subject: subject };\r\n    }\r\n    else {\r\n        tags.push.apply(tags, tslib_1.__spread((tab || block).tags.filter(function (tag) { return tag.startsWith(\"course:\"); })));\r\n        if (course.type === 'theme-course')\r\n            tags.push.apply(tags, tslib_1.__spread(tab.tags.filter(function (tag) { return tag.startsWith(\"sub:\"); })));\r\n        else\r\n            tags.push.apply(tags, tslib_1.__spread(block.tags.filter(function (tag) { return tag.startsWith(\"sub:\"); })));\r\n        var subject = course.type === 'theme-course' ?\r\n            tab.subject.subjectName :\r\n            course.subject.subjectName;\r\n        return { tags: tags, subject: subject };\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { distinct, flatten } from \"../../../utils/utils\";\r\nexport function getSubjectCodes(tags) {\r\n    return distinct((tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"sub:\"); })\r\n        .map(function (tag) { return tag.substr(\"sub:\".length); }));\r\n}\r\nexport function getSchoolYears(tags) {\r\n    return distinct((tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"course:\"); })\r\n        .map(function (tag) { return tag.substr(tag.indexOf(\"|\") + 1); }) // School year is concatenated as pipe + schoolyear. Example: \"GRGRFYS01|4-6\"\r\n    );\r\n}\r\nfunction computeGradesFromGradeSpan(gradeSpan) {\r\n    // gradeSpan is \"1-3\", \"4-6\" or \"7-9\"\r\n    var _a = tslib_1.__read(gradeSpan.split(\"-\"), 2), start = _a[0], end = _a[1];\r\n    var resultGrades = [];\r\n    if (start && end) {\r\n        var startGrade = parseInt(start);\r\n        var endGrade = parseInt(end);\r\n        while (startGrade <= endGrade) {\r\n            resultGrades.push(startGrade);\r\n            startGrade++;\r\n        }\r\n    }\r\n    return resultGrades;\r\n}\r\nexport function computeCourseInstanceTags(tags, subjectCodes, schoolYears) {\r\n    var otherTags = (tags || []).filter(function (tag) {\r\n        return !tag.startsWith(\"course:\") &&\r\n            !tag.startsWith(\"sub:\") &&\r\n            !tag.startsWith(\"grade:\");\r\n    });\r\n    var subjectTags = subjectCodes.map(function (sub) { return \"sub:\" + sub; });\r\n    var courseTags = flatten(subjectCodes.map(function (sub) {\r\n        return schoolYears.map(function (schoolYear) { return \"course:\" + sub + \"|\" + schoolYear; });\r\n    }));\r\n    var grades = flatten(schoolYears.map(function (schoolYear) { return computeGradesFromGradeSpan(schoolYear); }));\r\n    var gradeTags = tags.includes(\"active\")\r\n        ? grades.map(function (grade) { return \"grade:\" + grade; })\r\n        : [];\r\n    return otherTags\r\n        .concat(subjectTags)\r\n        .concat(courseTags)\r\n        .concat(gradeTags);\r\n}\r\nexport function computeTagsFromSchoolYears(tags, schoolYears) {\r\n    //schoolYears = schoolYears.map(afterColon);\r\n    var subjectCodes = getSubjectCodes(tags);\r\n    return computeCourseInstanceTags(tags, subjectCodes, schoolYears);\r\n}\r\nexport function computeTagsFromSubjectCodes(tags, subjectCodes) {\r\n    //subjectCodes = subjectCodes.map(afterColon);\r\n    var schoolYears = getSchoolYears(tags);\r\n    return computeCourseInstanceTags(tags, subjectCodes, schoolYears);\r\n}\r\nexport function computeTagsFromActiveState(tags, activeState) {\r\n    var subjectCodes = getSubjectCodes(tags);\r\n    var schoolYears = getSchoolYears(tags);\r\n    var tagsWithoutActiveState = tags.filter(function (tag) { return tag !== \"active\"; });\r\n    return computeCourseInstanceTags(tagsWithoutActiveState.concat(activeState ? \"active\" : []), subjectCodes, schoolYears);\r\n}\r\nfunction afterColon(str) {\r\n    var pColon = str.indexOf(\":\");\r\n    return pColon >= 0 ? str.substr(pColon + 1) : str;\r\n}\r\n","export function getCourseCodesFromTags(tags) {\r\n    return (tags || [])\r\n        .filter(function (tag) { return tag.startsWith(\"course:\"); })\r\n        .map(function (courseTag) { return courseTag.substr(\"course:\".length); });\r\n}\r\n","import { db } from '../../../globals/db';\r\nexport function getDraftId(school, courseId) {\r\n    return db.schools.name(school).single() // Get the school Observable\r\n        .switchMap(function (school) {\r\n        return db.branches\r\n            .hasEdgesFrom([school.officialBranchId]) // The official draft has edges from the official school branch\r\n            .name(\"draft\") // There might be other personal drafts in future. Requirement of the common draft is that it is named \"draft\"\r\n            .tags(courseId) // Find the one tagged with the courseId. There are several drafts - one for each course.\r\n            .idsOnly()\r\n            .map(function (_a) {\r\n            var id = _a.id;\r\n            return id;\r\n        })\r\n            .first();\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { db } from '../../../globals/db';\r\nimport { getOrderedDocs } from './ordered-requirements';\r\nexport function getStandardCoursesWithOrderedRequirements(courseCodes) {\r\n    var _a;\r\n    var courseCodeTags = courseCodes.map(function (code) { return code.startsWith('course:') ? code : \"course:\" + code; });\r\n    if (courseCodeTags.length === 0)\r\n        return new Emitter([]);\r\n    return (_a = db.courses.include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")).tags.apply(_a, tslib_1.__spread(courseCodeTags)).filter(function (course) { return course.isTemplate; }) // BUGBUG: In KG, we would need this filter, not KS. Need another authorized way of getting the standard course only!\r\n        .map(function (course) { return (tslib_1.__assign({}, course, { abilities: getOrderedDocs(course.abilities, course.abilitiesOrder), centralContent: getOrderedDocs(course.centralContent, course.centralContentOrder), knowledgeRequirements: getOrderedDocs(course.knowledgeRequirements, course.knowledgeRequirementsOrder) })); }).toValue();\r\n}\r\n","import env from '../../../globals/KED.env';\r\nimport { isTeacherAtSchool } from '../../../access-control';\r\nexport function isEmployee(atSchool) {\r\n    return atSchool ?\r\n        isTeacherAtSchool(env.currentUser, atSchool) || env.currentUser.roles.includes(\"ADMIN\") :\r\n        env.currentUser.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\r\n}\r\n","import env from '../../../globals/KED.env';\r\nimport { isAdminOrTeacherAtSchool } from '../../../access-control';\r\nexport function isKedStaff() {\r\n    return isAdminOrTeacherAtSchool(env.currentUser, \"standard\");\r\n}\r\n","import { db, globalId } from '../../../globals/db';\r\nexport function listCourseInstances() {\r\n    return db.courseInstances.hasEdgesFrom([globalId]);\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { db } from '../../../globals/db';\r\nimport { flatten } from '../../../utils/utils';\r\nexport function getOrderedDocs(docs, order, _a) {\r\n    var appendLeftovers = (_a === void 0 ? { appendLeftovers: false } : _a).appendLeftovers;\r\n    // Mark doc IDs that where present in given 'order' array.\r\n    // Will be used to find left-overs that were not present in the 'order' array.\r\n    var markedDocs = {};\r\n    if (!docs || !order) {\r\n        // Special case: no docs or no order. Don't fail. Just return docs as is.\r\n        return docs;\r\n    }\r\n    // Map given 'order' array to corresponding docs. Also mark in markedDocs.\r\n    var result = (docs && order ?\r\n        order.map(function (id) {\r\n            markedDocs[id] = true;\r\n            return docs.find(function (doc) { return doc.id === id; });\r\n        }).filter(function (doc) { return !!doc; }) :\r\n        docs);\r\n    if (appendLeftovers) {\r\n        // If any leftovers are there, concat them at the end:\r\n        var leftOvers = docs.filter(function (doc) { return !markedDocs[doc.id]; });\r\n        return result.concat(leftOvers);\r\n    }\r\n    else {\r\n        return result;\r\n    }\r\n}\r\nexport function resolveRequirementOrder(obj, orderDefiner) {\r\n    var _a;\r\n    var orderDefiningDocObservable;\r\n    if (orderDefiner) {\r\n        // User provided the orderDefining doc (use case is when obj is a Course or Subject, which contains its order by itself. User then provides the Course or Subject in both args)\r\n        orderDefiningDocObservable = new Emitter([orderDefiner]);\r\n    }\r\n    else {\r\n        var courseCodes = obj.tags.filter(function (tag) { return tag.startsWith(\"course:\"); });\r\n        if (courseCodes.length === 0) {\r\n            return new Emitter(obj); // No course tags. Not possible to resolve order.\r\n        }\r\n        orderDefiningDocObservable = (_a = db.courses).tags.apply(_a, tslib_1.__spread(courseCodes)).toValue();\r\n    }\r\n    return orderDefiningDocObservable.map(function (orderHolders) {\r\n        var abilitiesOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.abilitiesOrder || []; }));\r\n        var ccOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.centralContentOrder || []; }));\r\n        var krOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.knowledgeRequirementsOrder || []; }));\r\n        var objClone = Object.assign({}, obj);\r\n        if (objClone.abilities)\r\n            objClone.abilities = getOrderedDocs(obj.abilities, abilitiesOrder);\r\n        if (objClone.centralContent)\r\n            objClone.centralContent = getOrderedDocs(obj.centralContent, ccOrder);\r\n        if (objClone.knowledgeRequirements)\r\n            objClone.knowledgeRequirements = getOrderedDocs(obj.knowledgeRequirements, krOrder);\r\n        return objClone;\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { db } from '../../../globals/db';\r\nimport env from '../../../globals/KED.env';\r\nexport function publishCourse(_a) {\r\n    var school = _a.school, draftRepo = _a.draftRepo, course = _a.course;\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var destinationRepo, schoolBranchId;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    if (!(school === \"standard\")) return [3 /*break*/, 1];\r\n                    // Editing Standard School should merge to reality.\r\n                    draftRepo.merge();\r\n                    destinationRepo = db;\r\n                    return [3 /*break*/, 3];\r\n                case 1: return [4 /*yield*/, db.schools.name(school).single().map(function (school) { return school.officialBranchId; }).load()];\r\n                case 2:\r\n                    schoolBranchId = _b.sent();\r\n                    draftRepo.merge(schoolBranchId);\r\n                    destinationRepo = db.branch(schoolBranchId);\r\n                    _b.label = 3;\r\n                case 3:\r\n                    destinationRepo.courseInstances.update(course, {\r\n                        modifiedDate: Date.now(),\r\n                        modifiedBy: {\r\n                            name: env.currentUser.displayName,\r\n                            url: \"mailto:\" + env.currentUser.mail\r\n                        }\r\n                    });\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import { flatten } from '../../../utils/utils';\r\nimport { getOrderedDocs } from './ordered-requirements';\r\nexport function getSortedTasks(content) {\r\n    return getOrderedDocs(content.tasks, content.taskOrder, { appendLeftovers: true });\r\n}\r\nexport function computeUpdatedOrder(docs, currentOrder, source, target, placement, _a) {\r\n    var appendLeftovers = (_a === void 0 ? { appendLeftovers: false } : _a).appendLeftovers;\r\n    var orderedIds = getOrderedDocs(docs, currentOrder, { appendLeftovers: true }).map(function (t) { return t.id; });\r\n    var placeBefore = placement === 'before';\r\n    var result = flatten(orderedIds\r\n        .filter(function (id) { return id !== source.id; }) // Remove source id\r\n        .map(function (id) { return id !== target.id ?\r\n        // We're not on target\r\n        id :\r\n        // We're on target. Place before or after?\r\n        placeBefore ?\r\n            [source.id, id] :\r\n            [id, source.id]; }));\r\n    return result;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nvar CONTENT_TYPES = {\r\n    \"rich-text\": L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Textruta\"], [\"Textruta\"]))),\r\n    \"youtube-movie\": L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Youtube film\"], [\"Youtube film\"]))),\r\n    \"learning-goals\": L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l och uppgifter\"], [\"L\\u00E4randem\\u00E5l och uppgifter\"]))),\r\n    \"resource-list\": L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Resurslista\"], [\"Resurslista\"]))),\r\n    \"embedded-html\": L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Inb\\u00E4ddad HTML\"], [\"Inb\\u00E4ddad HTML\"]))),\r\n    \"word-bank\": L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Ordbank\"], [\"Ordbank\"])))\r\n};\r\nvar ADD_TITLES = {\r\n    \"rich-text\": L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till text\"], [\"L\\u00E4gg till text\"]))),\r\n    \"youtube-movie\": L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till youtube film\"], [\"L\\u00E4gg till youtube film\"]))),\r\n    \"learning-goals\": L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till l\\u00E4randem\\u00E5l och uppgifter\"], [\"L\\u00E4gg till l\\u00E4randem\\u00E5l och uppgifter\"]))),\r\n    \"resource-list\": L(templateObject_10 || (templateObject_10 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till resurslista\"], [\"L\\u00E4gg till resurslista\"]))),\r\n    \"embedded-html\": L(templateObject_11 || (templateObject_11 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till inb\\u00E4ddad HTML\"], [\"L\\u00E4gg till inb\\u00E4ddad HTML\"]))),\r\n    \"word-bank\": L(templateObject_12 || (templateObject_12 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till ordbank\"], [\"L\\u00E4gg till ordbank\"])))\r\n};\r\nvar AddContentButton = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddContentButton, _super);\r\n    function AddContentButton(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            open: false,\r\n            contentType: 'rich-text'\r\n        };\r\n        return _this;\r\n    }\r\n    AddContentButton.prototype.createContent = function () {\r\n        var _a = this.props, tab = _a.tab, branch = _a.branch, type = _a.type, schoolName = _a.schoolName;\r\n        var newContent = this.newContent(type || this.state.contentType);\r\n        newContent.acl = [\"role:USER:R\", \"schoolRole:\" + schoolName + \"/EMPLOYEE:S\"];\r\n        branch.courseTabs.addRelated(tab.id, \"contents\", newContent);\r\n        this.setState({ open: false });\r\n    };\r\n    AddContentButton.prototype.newContent = function (contentType) {\r\n        switch (contentType) {\r\n            case \"rich-text\": return this.newRichText();\r\n            case \"learning-goals\": return this.newLearningGoal();\r\n            case \"embedded-html\": return this.newEmbeddedHTML();\r\n            case \"word-bank\": return this.newWordBank();\r\n            case \"resource-list\": return this.newResourceList();\r\n            default: throw new Error(\"Not implemented\");\r\n        }\r\n    };\r\n    AddContentButton.prototype.newWordBank = function () {\r\n        return {\r\n            type: 'word-bank',\r\n            tags: [this.props.course.id],\r\n            id: createUUID(),\r\n            order: Date.now(),\r\n            locked: this.props.tab.locked,\r\n            lockDelete: isKedStaff(),\r\n            hidden: false,\r\n            selectedWordBank: null\r\n        };\r\n    };\r\n    AddContentButton.prototype.newRichText = function () {\r\n        return {\r\n            type: \"rich-text\",\r\n            tags: [this.props.course.id],\r\n            id: createUUID(),\r\n            order: Date.now(),\r\n            locked: this.props.tab.locked,\r\n            lockDelete: isKedStaff(),\r\n            hidden: false,\r\n            html: '',\r\n        };\r\n    };\r\n    AddContentButton.prototype.newEmbeddedHTML = function () {\r\n        return {\r\n            type: \"embedded-html\",\r\n            tags: [this.props.course.id],\r\n            id: createUUID(),\r\n            order: Date.now(),\r\n            locked: this.props.tab.locked,\r\n            lockDelete: isKedStaff(),\r\n            hidden: false,\r\n            html: ''\r\n        };\r\n    };\r\n    AddContentButton.prototype.newLearningGoal = function () {\r\n        return {\r\n            type: \"learning-goals\",\r\n            tags: [this.props.course.id],\r\n            id: createUUID(),\r\n            locked: this.props.tab.locked,\r\n            lockDelete: isKedStaff(),\r\n            hidden: false,\r\n            hasCommonLearningGoals: this.props.course.type === 'theme-course',\r\n            commonLearningGoals: [],\r\n            order: Date.now(),\r\n            hiddenTasks: [],\r\n        };\r\n    };\r\n    AddContentButton.prototype.newResourceList = function () {\r\n        return {\r\n            type: \"resource-list\",\r\n            tags: [this.props.course.id],\r\n            id: createUUID(),\r\n            locked: false,\r\n            lockDelete: isKedStaff(),\r\n            order: Date.now(),\r\n            hidden: false,\r\n            resources: []\r\n        };\r\n    };\r\n    AddContentButton.prototype.render = function () {\r\n        var _this = this;\r\n        if (this.state.open) {\r\n            return React.createElement(\"div\", null,\r\n                React.createElement(\"select\", { onChange: function (ev) { return _this.setState({ contentType: ev.target.value }); } }, Object.keys(CONTENT_TYPES).map(function (contentType) {\r\n                    return React.createElement(\"option\", { key: contentType, value: contentType }, CONTENT_TYPES[contentType]);\r\n                })),\r\n                React.createElement(\"a\", { className: \"btn pull-right\", onClick: function () { return _this.setState({ open: false }); } }, L(templateObject_13 || (templateObject_13 = tslib_1.__makeTemplateObject([\"Avbryt\"], [\"Avbryt\"])))),\r\n                React.createElement(\"a\", { className: \"btn btn-default\", onClick: function () { return _this.createContent(); } }, L(templateObject_14 || (templateObject_14 = tslib_1.__makeTemplateObject([\"Skapa\"], [\"Skapa\"])))));\r\n        }\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"a\", { className: \"btn\", onClick: function () {\r\n                    if (_this.props.type) {\r\n                        _this.createContent();\r\n                    }\r\n                    else {\r\n                        _this.setState({ open: true });\r\n                    }\r\n                } },\r\n                React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                this.props.type ? ADD_TITLES[this.props.type] : L(templateObject_15 || (templateObject_15 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till inneh\\u00E5ll\"], [\"L\\u00E4gg till inneh\\u00E5ll\"])))),\r\n            \"\\u00A0\");\r\n    };\r\n    return AddContentButton;\r\n}(React.Component));\r\nexport { AddContentButton };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10, templateObject_11, templateObject_12, templateObject_13, templateObject_14, templateObject_15;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { withRouter } from 'react-router';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nvar AddTabButton = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddTabButton, _super);\r\n    function AddTabButton(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            editingName: false,\r\n            name: \"\"\r\n        };\r\n        return _this;\r\n    }\r\n    AddTabButton.prototype.createTab = function (tabName) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, type, branch, draftId, course, school, history, block, stepNo, tabTemplate, newTab;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        this.setState({ editingName: false, name: \"\" });\r\n                        _a = this.props, type = _a.type, branch = _a.branch, draftId = _a.draftId, course = _a.course, school = _a.school, history = _a.history, block = _a.block, stepNo = _a.stepNo;\r\n                        tabTemplate = {\r\n                            id: createUUID(),\r\n                            tabTitle: tabName,\r\n                            name: tabName,\r\n                            order: Date.now(),\r\n                            locked: isKedStaff() ? true : false,\r\n                            acl: [\"role:USER:R\", \"schoolRole:\" + school + \"/EMPLOYEE:S\"],\r\n                        };\r\n                        newTab = (type === 'theme-course-tab' ?\r\n                            tslib_1.__assign({ type: 'theme-course-tab', tabClass: 'content-tab', tags: [this.props.course.id] }, tabTemplate) :\r\n                            tslib_1.__assign({ type: 'step-course-tab', tabClass: 'content-tab', tags: tslib_1.__spread(block.tags) }, tabTemplate, { stepNo: stepNo }));\r\n                        /*const topContent: RichTextContent = {\r\n                          type: 'rich-text',\r\n                          id: createUUID(),\r\n                          tags: [this.props.course.id],\r\n                          html: `<h2>${tabName}</h2`,\r\n                          order: Date.now(),\r\n                          locked: true,\r\n                          hidden: false\r\n                        };*/\r\n                        if (newTab.type === 'step-course-tab') {\r\n                            branch.courseBlocks.addRelated(block.id, \"tabs\", newTab);\r\n                        }\r\n                        else {\r\n                            branch.courseInstances.addRelated(course.id, \"tabs\", newTab);\r\n                        }\r\n                        //branch.courseTabs.addRelated(newTab.id, \"contents\", topContent);\r\n                        return [4 /*yield*/, branch.saveNow()];\r\n                    case 1:\r\n                        //branch.courseTabs.addRelated(newTab.id, \"contents\", topContent);\r\n                        _b.sent();\r\n                        history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + newTab.id + \"/drafts/\" + draftId + \"/edit\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    AddTabButton.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, school = _a.school, course = _a.course, branch = _a.branch;\r\n        var _b = this.state, editingName = _b.editingName, name = _b.name;\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"a\", { onClick: editingName ? null : function (ev) { return _this.setState({ editingName: true, name: '' }); } },\r\n                React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                !editingName ?\r\n                    ' ' + L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Ny flik\"], [\"Ny flik\"]))) :\r\n                    React.createElement(\"input\", { type: \"text\", style: { color: \"black\" }, autoFocus: true, placeholder: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Fliknamn\"], [\"Fliknamn\"]))), value: name, size: 30, onChange: function (ev) { return _this.setState({ name: ev.target.value }); }, onKeyPress: function (ev) {\r\n                            if (ev.key === 'Enter') {\r\n                                _this.createTab(name);\r\n                            }\r\n                        }, onBlur: function () { return _this.setState({ editingName: false }); } })));\r\n    };\r\n    return AddTabButton;\r\n}(React.Component));\r\nvar AddTabButtonWithRouter = withRouter(AddTabButton);\r\nexport { AddTabButtonWithRouter as AddTabButton };\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { db } from '../../../globals/db';\r\nimport { Spinner } from '../../course-builder/sub-components/spinner';\r\nimport { withRouter } from 'react-router';\r\nimport { L } from '../../../utils/utils';\r\nimport { isAdminOrTeacherAtSchool, preserveImpersonationQuery } from '../../../access-control';\r\nimport env from '../../../globals/KED.env';\r\nimport { getDraftId } from '../logic/get-draft-id';\r\nvar ClickableSchoolDivWithRouter = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ClickableSchoolDivWithRouter, _super);\r\n    function ClickableSchoolDivWithRouter(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            open: false\r\n        };\r\n        return _this;\r\n    }\r\n    ClickableSchoolDivWithRouter.prototype.open = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schools;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ open: true });\r\n                        if (!!this.state.schools) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, db.schools\r\n                                .tags(\"primary\")\r\n                                .map(function (_a) {\r\n                                var id = _a.id, name = _a.name, displayName = _a.displayName;\r\n                                return ({ id: id, name: name, displayName: displayName || name || \"<namnls>\" });\r\n                            })\r\n                                .toValue().load()];\r\n                    case 1:\r\n                        schools = _a.sent();\r\n                        this.setState({ schools: schools });\r\n                        _a.label = 2;\r\n                    case 2: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ClickableSchoolDivWithRouter.prototype.close = function () {\r\n        this.setState({ open: false });\r\n    };\r\n    ClickableSchoolDivWithRouter.prototype.selectSchool = function (school) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            function getRoute() {\r\n                return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                    var otherDraftId, _a;\r\n                    return tslib_1.__generator(this, function (_b) {\r\n                        switch (_b.label) {\r\n                            case 0:\r\n                                _a = draftId;\r\n                                if (!_a) return [3 /*break*/, 2];\r\n                                return [4 /*yield*/, getDraftId(school, courseId).load()];\r\n                            case 1:\r\n                                _a = (_b.sent());\r\n                                _b.label = 2;\r\n                            case 2:\r\n                                otherDraftId = _a;\r\n                                if (taskId && contentId && otherDraftId && (isAdminOrTeacherAtSchool(env.currentUser, school) || canImpersonate)) {\r\n                                    return [2 /*return*/, \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || \"$\") + \"/contents/\" + contentId + \"/tasks/\" + taskId + \"/drafts/\" + otherDraftId + \"/edit\"];\r\n                                }\r\n                                else if (taskId) {\r\n                                    return [2 /*return*/, \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || \"$\") + \"/tasks/\" + taskId];\r\n                                }\r\n                                else if (otherDraftId && (isAdminOrTeacherAtSchool(env.currentUser, school) || canImpersonate)) {\r\n                                    return [2 /*return*/, \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || \"$\") + \"/drafts/\" + otherDraftId + \"/edit\"];\r\n                                }\r\n                                else {\r\n                                    return [2 /*return*/, \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || \"$\")];\r\n                                }\r\n                                return [2 /*return*/];\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n            var _a, match, history, _b, courseId, tabId, draftId, contentId, taskId, canImpersonate, route, baseUrl;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.props, match = _a.match, history = _a.history;\r\n                        _b = match.params, courseId = _b.courseId, tabId = _b.tabId, draftId = _b.draftId, contentId = _b.contentId, taskId = _b.taskId;\r\n                        canImpersonate = env.currentUser.roles.includes(\"ADMIN\") || // Is admin\r\n                            location.search.includes('role=');\r\n                        if (!(school !== this.props.school)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, getRoute()];\r\n                    case 1:\r\n                        route = _c.sent();\r\n                        if (canImpersonate) {\r\n                            baseUrl = preserveImpersonationQuery(location.pathname, school === 'standard' ?\r\n                                { role: undefined, school: school } :\r\n                                { role: \"EMPLOYEE\", school: school });\r\n                            location.href = baseUrl + \"#\" + route;\r\n                        }\r\n                        else {\r\n                            // Not an admin, just redirect to the route and normal access control will apply\r\n                            history.push(route);\r\n                        }\r\n                        _c.label = 2;\r\n                    case 2:\r\n                        this.close();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ClickableSchoolDivWithRouter.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, school = _a.school, draftId = _a.draftId, displayName = _a.displayName;\r\n        var _b = this.state, open = _b.open, schools = _b.schools;\r\n        return React.createElement(\"div\", { tabIndex: 1, style: { outline: 0 }, onBlur: function () { return _this.close(); } }, !open ? React.createElement(React.Fragment, null,\r\n            React.createElement(\"h5\", { onClick: function () { return _this.open(); } }, school !== \"standard\" ? (displayName || school) : L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Standard\"], [\"Standard\"])))),\r\n            draftId && React.createElement(\"p\", { className: \"pageSideText\" }, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Arbetsversion\"], [\"Arbetsversion\"]))))) : !schools ?\r\n            React.createElement(Spinner, null) : React.createElement(React.Fragment, null,\r\n            React.createElement(\"h5\", { onClick: function () { return _this.close(); } }, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"V\\u00E4xla skola\"], [\"V\\u00E4xla skola\"])))),\r\n            React.createElement(\"ul\", null,\r\n                React.createElement(\"li\", { onClick: function () { return _this.selectSchool(\"standard\"); } }, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Standard\"], [\"Standard\"])))),\r\n                schools.filter(function (_a) {\r\n                    var name = _a.name;\r\n                    return name !== 'standard';\r\n                })\r\n                    .sort(function (a, b) { return a.displayName.localeCompare(b.displayName, [\"sv\", \"en\"]); })\r\n                    .map(function (_a) {\r\n                    var id = _a.id, school = _a.name, displayName = _a.displayName;\r\n                    return React.createElement(\"li\", { key: id, onClick: function () { return _this.selectSchool(school); } }, displayName);\r\n                }))));\r\n    };\r\n    return ClickableSchoolDivWithRouter;\r\n}(React.Component));\r\nexport var ClickableSchoolDiv = withRouter(ClickableSchoolDivWithRouter);\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { CourseTabArea } from './course-tab-area';\r\nimport { L, showError } from '../../../utils/utils';\r\nimport { EditorFooterButtons } from './editor-footer-buttons';\r\nimport { TwoColumnsPage } from '../common/two-columns-page';\r\nimport { WeekPlanner } from '../../weekplanner/weekplanner';\r\nimport { isTeacherAtSchool } from '../../../access-control';\r\nimport env from '../../../globals/KED.env';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { withRouter } from 'react-router-dom';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { publishCourse } from '../logic/publish-course';\r\nimport { db, CourseInstances } from '../../../globals/db';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { computePredestinatedId } from 'kedbackend/client';\r\nimport { VersionHistoryBox } from './version-history/version-history-box';\r\nimport { ResourceListView } from './course-contents/resource-list-view';\r\nexport var CourseArea = withRouter(function (_a) {\r\n    var school = _a.school, courseId = _a.courseId, draftId = _a.draftId, course = _a.course, branch = _a.branch, tabs = _a.tabs, activeTab = _a.activeTab, editMode = _a.editMode, history = _a.history, block = _a.block;\r\n    var tab = tabs.filter(function (tab) { return tab.id === activeTab; })[0] || tabs[0];\r\n    var currentTabResources = tab &&\r\n        branch.courseContents.hasEdgesFrom([tab.id]).filter(function (x) { return x.type === \"resource-list\"; });\r\n    return React.createElement(TwoColumnsPage, { right: editMode && draftId ?\r\n            // In edit mode, show the draft edits to the right\r\n            React.createElement(\"div\", null,\r\n                React.createElement(VersionHistoryBox, { isAdmin: school === 'standard', branchId: draftId, branchType: \"draft-branch\" })) :\r\n            // In view mode, show WeekPlanner to the right\r\n            // In view mode, show Resources to the right\r\n            React.createElement(React.Fragment, null,\r\n                React.createElement(WeekPlanner, { env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL }),\r\n                currentTabResources && React.createElement(ResourceListView, { resourceListContents: currentTabResources })), rightWidth: 5, left: React.createElement(React.Fragment, null,\r\n            React.createElement(CourseTabArea, { school: school, course: course, branch: branch, tab: tab, editMode: editMode, draftId: draftId, block: block, lazyContents: tab ?\r\n                    branch.courseContents.include(\"tasks\").hasEdgesFrom([tab.id]).toValue() :\r\n                    new Emitter([]) }),\r\n            !editMode ? env.currentUser.roles.includes(\"ADMIN\") || isTeacherAtSchool(env.currentUser, school) ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(AlignHorizontal, null,\r\n                    draftId && React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"button\", { className: \"btn btn-large btn-warning\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                                return tslib_1.__generator(this, function (_a) {\r\n                                    switch (_a.label) {\r\n                                        case 0: return [4 /*yield*/, publishCourse({\r\n                                                school: school,\r\n                                                course: course,\r\n                                                draftRepo: db.branch(draftId)\r\n                                            })];\r\n                                        case 1:\r\n                                            _a.sent();\r\n                                            return [4 /*yield*/, db.saveNow()];\r\n                                        case 2:\r\n                                            _a.sent();\r\n                                            history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tab ? tab.id : '$'));\r\n                                            return [2 /*return*/];\r\n                                    }\r\n                                });\r\n                            }); } },\r\n                            React.createElement(\"i\", { className: \"fa fa-lg fa-play\", \"aria-hidden\": true }),\r\n                            \"\\u00A0\", L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Publicera\"], [\"Publicera\"]))))),\r\n                    React.createElement(LazyContent, null, CourseInstances.getBranchId(db.schools.name(school).single(), courseId).map(function (existingDraftId) { return React.createElement(React.Fragment, null,\r\n                        React.createElement(HorizontalItem, null,\r\n                            React.createElement(\"button\", { className: \"btn btn-large\", onClick: existingDraftId ?\r\n                                    // Navigate to edit existing draft\r\n                                    function () { return history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tab ? tab.id : '$') + \"/drafts/\" + existingDraftId + \"/edit\"); } :\r\n                                    // Create a draft for the branch and then navigate to it\r\n                                    function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                                        var schoolEntity, newDraftId, newDraftBranchDoc, error_1;\r\n                                        return tslib_1.__generator(this, function (_a) {\r\n                                            switch (_a.label) {\r\n                                                case 0:\r\n                                                    _a.trys.push([0, 4, , 5]);\r\n                                                    return [4 /*yield*/, db.schools.name(school).single().load()];\r\n                                                case 1:\r\n                                                    schoolEntity = _a.sent();\r\n                                                    return [4 /*yield*/, computePredestinatedId(schoolEntity.officialBranchId + courseId + \"draft\")];\r\n                                                case 2:\r\n                                                    newDraftId = _a.sent();\r\n                                                    newDraftBranchDoc = {\r\n                                                        id: newDraftId,\r\n                                                        acl: [\r\n                                                            \"role:USER:R\",\r\n                                                            \"schoolRole:\" + schoolEntity.name + \"/EMPLOYEE:S\"\r\n                                                        ],\r\n                                                        name: 'draft',\r\n                                                        schoolId: schoolEntity.id,\r\n                                                        treeParentId: schoolEntity.officialBranchId,\r\n                                                        tags: [courseId]\r\n                                                    };\r\n                                                    db.branches.addRelated(schoolEntity.officialBranchId, \"approvedChildren\", newDraftBranchDoc);\r\n                                                    return [4 /*yield*/, db.saveNow()];\r\n                                                case 3:\r\n                                                    _a.sent();\r\n                                                    history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tab ? tab.id : '$') + \"/drafts/\" + newDraftId + \"/edit\");\r\n                                                    return [3 /*break*/, 5];\r\n                                                case 4:\r\n                                                    error_1 = _a.sent();\r\n                                                    showError(error_1);\r\n                                                    return [3 /*break*/, 5];\r\n                                                case 5: return [2 /*return*/];\r\n                                            }\r\n                                        });\r\n                                    }); } }, existingDraftId ? React.createElement(React.Fragment, null,\r\n                                React.createElement(\"i\", { className: \"fa fa-lg fa-pencil\" }),\r\n                                \" \",\r\n                                draftId ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Forts\\u00E4tt redigera\"], [\"Forts\\u00E4tt redigera\"]))) : L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Redigera\"], [\"Redigera\"])))) : React.createElement(React.Fragment, null,\r\n                                React.createElement(\"i\", { className: \"fa fa-lg fa-plus\" }),\r\n                                \" \", L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Skapa skolans version av kursen\"], [\"Skapa skolans version av kursen\"])))))),\r\n                        draftId || !existingDraftId ? undefined : React.createElement(HorizontalItem, null,\r\n                            React.createElement(\"button\", { className: \"btn btn-large\", onClick: function () { return history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tab ? tab.id : '$') + \"/drafts/\" + existingDraftId); } },\r\n                                React.createElement(\"i\", { className: \"fa fa-eye\" }),\r\n                                \" \", L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Visa redigerad version\"], [\"Visa redigerad version\"])))))); })),\r\n                    draftId && React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"button\", { className: \"btn btn-large\", onClick: function () {\r\n                                history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tab ? tab.id : '$'));\r\n                            } },\r\n                            React.createElement(\"i\", { className: \"fa fa-lg fa-arrow-left\" }),\r\n                            \" \", L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Avsluta redigering\"], [\"Avsluta redigering\"]))))))) : undefined :\r\n                React.createElement(React.Fragment, null,\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(\"hr\", null),\r\n                    React.createElement(EditorFooterButtons, { school: school, course: course, tab: tab, activeTab: activeTab, draftId: draftId, courseType: course.type, blockId: block && block.id }))) });\r\n});\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../../utils/utils';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { withRouter } from 'react-router';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nimport { computeTaskTagsAndSubject } from '../../logic/compute-task-tags-and-subject';\r\nvar AddTaskButton = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddTaskButton, _super);\r\n    function AddTaskButton(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            editingName: false,\r\n            name: \"\"\r\n        };\r\n        return _this;\r\n    }\r\n    AddTaskButton.prototype.createTask = function (taskName) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, branch, draftId, course, tab, school, content, history, block, learningGoal, _b, tags, subject, newTask;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        this.setState({ editingName: false, name: \"\" });\r\n                        _a = this.props, branch = _a.branch, draftId = _a.draftId, course = _a.course, tab = _a.tab, school = _a.school, content = _a.content, history = _a.history, block = _a.block, learningGoal = _a.learningGoal;\r\n                        _b = computeTaskTagsAndSubject(course, tab, block), tags = _b.tags, subject = _b.subject;\r\n                        newTask = {\r\n                            id: createUUID(),\r\n                            tags: tags,\r\n                            name: taskName,\r\n                            acl: [\"role:USER:R\", \"schoolRole:\" + school + \"/EMPLOYEE:S\"],\r\n                            url: \"\",\r\n                            taskType: 'task',\r\n                            learningGoal: learningGoal,\r\n                            futureAbilities: [],\r\n                            resources: [],\r\n                            subject: subject\r\n                        };\r\n                        branch.courseContents.addRelated(content.id, \"tasks\", newTask);\r\n                        return [4 /*yield*/, branch.saveNow()];\r\n                    case 1:\r\n                        _c.sent();\r\n                        history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + tab.id + \"/contents/\" + content.id + \"/tasks/\" + newTask.id + \"/drafts/\" + draftId + \"/edit\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    AddTaskButton.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, editingName = _a.editingName, name = _a.name;\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"a\", { className: \"btn\", onClick: editingName ? null : function (ev) { return _this.setState({ editingName: true, name: '' }); } },\r\n                React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                !editingName ?\r\n                    ' ' + (isKedStaff() ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till uppgift\"], [\"L\\u00E4gg till uppgift\"]))) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till egen uppgift\"], [\"L\\u00E4gg till egen uppgift\"])))) :\r\n                    React.createElement(\"input\", { type: \"text\", autoFocus: true, placeholder: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Uppgiftens namn\"], [\"Uppgiftens namn\"]))), value: name, size: 50, onChange: function (ev) { return _this.setState({ name: ev.target.value }); }, onKeyPress: function (ev) {\r\n                            if (ev.key === 'Enter') {\r\n                                _this.createTask(name);\r\n                            }\r\n                        }, onBlur: function () { return _this.setState({ editingName: false }); } })));\r\n    };\r\n    return AddTaskButton;\r\n}(React.Component));\r\nvar AddTaskButtonWithRouter = withRouter(AddTaskButton);\r\nexport { AddTaskButtonWithRouter as AddTaskButton };\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { RichTextContentBox } from './rich-text';\r\nimport { LearningTasksContentBox } from './learning-tasks-content-box';\r\nimport { EmbeddedHTMLContentBox } from './embedded-html';\r\nimport { WordBankContentBox } from './word-bank-content-box';\r\n/*export const ContentBox = ({repo, content}: CourseContentProps)=> (\r\n  <div className={[\"course-content-box\", \"ked_boxed\"].join(' ')} style={{position: 'relative'}}>\r\n    <ConcreteComponent {...{repo, content}} />\r\n    <div style={{position: 'absolute', top: 0, right: 0}}>\r\n        {moduleOrderedIndex > 0 && <span>\r\n          <i className=\"fa fa-arrow-circle-up selectable\"\r\n            aria-hidden=\"true\"\r\n            onClick={()=>this.props.onReorder(-1)} /> </span>}\r\n        {moduleOrderedIndex < course.modules.length - 1 && <span>\r\n          <i className=\"fa fa-arrow-circle-down selectable\"\r\n            aria-hidden=\"true\"\r\n            onClick={()=>this.props.onReorder(1)} /> </span>}\r\n        <RemoveItem\r\n          title=\"Ta bort modulen\"\r\n          style={{display: 'inline-block'}}\r\n          onClick={()=>confirm(L`Ta bort modul ${module.name}?`) && host.update({modules: {$splice: [[moduleIndex, 1]]}})} />\r\n      </div>\r\n  </div>\r\n)*/\r\nexport function CourseContentBox(_a) {\r\n    var repo = _a.repo, content = _a.content, siblingContents = _a.siblingContents, editMode = _a.editMode, course = _a.course, draftId = _a.draftId, school = _a.school, courseTab = _a.courseTab, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars, block = _a.block;\r\n    switch (content.type) {\r\n        case \"rich-text\": return React.createElement(RichTextContentBox, tslib_1.__assign({}, { repo: repo, content: content, editMode: editMode, reportNumChars: reportNumChars, maxChars: maxChars }));\r\n        case \"learning-goals\": return React.createElement(LearningTasksContentBox, tslib_1.__assign({}, {\r\n            repo: repo,\r\n            content: content,\r\n            editMode: editMode,\r\n            course: course,\r\n            draftId: draftId,\r\n            courseTab: courseTab,\r\n            school: school,\r\n            block: block\r\n        }));\r\n        case \"embedded-html\": return React.createElement(EmbeddedHTMLContentBox, tslib_1.__assign({}, { repo: repo, content: content, editMode: editMode, reportNumChars: reportNumChars, maxChars: maxChars }));\r\n        case \"word-bank\": return React.createElement(WordBankContentBox, tslib_1.__assign({}, {\r\n            repo: repo,\r\n            editMode: editMode,\r\n            content: content,\r\n            siblingWordBanks: siblingContents.filter(function (c) { return c.type === 'word-bank' && c.id !== content.id; }),\r\n            course: course,\r\n            courseTab: courseTab\r\n        }));\r\n        default: return React.createElement(\"p\", null,\r\n            \"Ok\\u00E4nd inneh\\u00E5llstyp: \",\r\n            content.type);\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { L } from '../../../../utils/utils';\r\nexport var COURSE_CONTENT_TYPES = {\r\n    \"rich-text\": L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Textruta\"], [\"Textruta\"]))),\r\n    \"youtube-movie\": L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Youtube film\"], [\"Youtube film\"]))),\r\n    \"learning-goals\": L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l och uppgifter\"], [\"L\\u00E4randem\\u00E5l och uppgifter\"]))),\r\n    \"resource-list\": L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Resurslista\"], [\"Resurslista\"]))),\r\n    \"embedded-html\": L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Inb\\u00E4ddad HTML\"], [\"Inb\\u00E4ddad HTML\"]))),\r\n    \"word-bank\": L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Ordbank\"], [\"Ordbank\"])))\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nimport { L } from '../../../../utils/utils';\r\nexport var EmbeddedHTMLContentBox = function (_a) {\r\n    var content = _a.content, repo = _a.repo, editMode = _a.editMode, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\r\n    return editMode && (!content.locked || isKedStaff()) ?\r\n        React.createElement(\"div\", null,\r\n            React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Inb\\u00E4ddat material\"], [\"Inb\\u00E4ddat material\"])))),\r\n            React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Klipp in HTML kod nedan\"], [\"Klipp in HTML kod nedan\"])))),\r\n            React.createElement(\"textarea\", { style: { width: \"100%\", height: \"100px\" }, value: content.html, onChange: function (_a) {\r\n                    var html = _a.target.value;\r\n                    if (html.length > maxChars)\r\n                        return;\r\n                    repo.courseContents.update(content, { html: html });\r\n                    reportNumChars(html.length);\r\n                } })) :\r\n        React.createElement(\"div\", { dangerouslySetInnerHTML: { __html: content.html } });\r\n};\r\nvar templateObject_1, templateObject_2;\r\n","export * from './course-content-types';\r\nexport * from './content-box';\r\nexport * from './rich-text';\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../utils/utils';\r\nimport { LearningTasksSettings } from './learning-tasks-settings';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nimport { LearningTasksWithCommonGoals } from './learning-tasks-with-common-goals';\r\nimport { LearningTasksWithSeparateGoals } from './learning-tasks-with-separate-goals';\r\nexport var LearningTasksContentBox = function (_a) {\r\n    var content = _a.content, editMode = _a.editMode, repo = _a.repo, course = _a.course, school = _a.school, draftId = _a.draftId, courseTab = _a.courseTab, block = _a.block;\r\n    var hasCommonLearningGoals = content.hasCommonLearningGoals, commonLearningGoals = content.commonLearningGoals, tasks = content.tasks;\r\n    var refinedLearningGoals = commonLearningGoals\r\n        .map(function (goal) { return goal.trim(); }).filter(function (goal) { return !!goal; });\r\n    return (React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        editMode && (!content.locked || isKedStaff()) ?\r\n            React.createElement(LearningTasksSettings, { course: course, content: content, repo: repo, tab: courseTab }) :\r\n            courseTab.tabClass !== 'mission-tab' ?\r\n                React.createElement(\"h2\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l och uppgifter\"], [\"L\\u00E4randem\\u00E5l och uppgifter\"])))) :\r\n                React.createElement(\"h2\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Uppdrag\"], [\"Uppdrag\"])))),\r\n        React.createElement(\"hr\", null),\r\n        hasCommonLearningGoals && courseTab.tabClass !== 'mission-tab' ?\r\n            React.createElement(LearningTasksWithCommonGoals, tslib_1.__assign({}, { content: content, editMode: editMode, repo: repo, course: course, school: school, draftId: draftId, courseTab: courseTab, block: block, learningGoals: refinedLearningGoals })) :\r\n            React.createElement(LearningTasksWithSeparateGoals, tslib_1.__assign({}, { content: content, editMode: editMode, repo: repo, course: course, school: school, draftId: draftId, courseTab: courseTab, block: block, learningGoals: refinedLearningGoals }))));\r\n};\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../utils/utils';\r\nimport { AlignHorizontal } from '../../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../../utility-components/horizontal-item';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nexport var LearningTasksSettings = function (_a) {\r\n    var tab = _a.tab, content = _a.content, repo = _a.repo;\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"h2\", null, tab.tabClass !== 'mission-tab' ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l och uppgifter\"], [\"L\\u00E4randem\\u00E5l och uppgifter\"]))) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Uppdrag\"], [\"Uppdrag\"])))),\r\n        isKedStaff() && tab.tabClass !== 'mission-tab' ? React.createElement(React.Fragment, null,\r\n            React.createElement(\"div\", null,\r\n                React.createElement(AlignHorizontal, null,\r\n                    React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"input\", { type: \"checkbox\", checked: content.hasCommonLearningGoals, onChange: function (ev) { return repo.courseContents.update(content, { hasCommonLearningGoals: !!ev.target.checked }); } })),\r\n                    React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"p\", null,\r\n                            \"\\u00A0\", L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Specificera gemensamma l\\u00E4randem\\u00E5l f\\u00F6r samtliga uppgifter\"], [\"Specificera gemensamma l\\u00E4randem\\u00E5l f\\u00F6r samtliga uppgifter\"]))))))),\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"p\", null, content.hasCommonLearningGoals ? L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Ange de gemensamma l\\u00E4randem\\u00E5len. Ange ett l\\u00E4randem\\u00E5l per rad.\"], [\"Ange de gemensamma l\\u00E4randem\\u00E5len. Ange ett l\\u00E4randem\\u00E5l per rad.\"]))) : L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Ange ett l\\u00E4randem\\u00E5l per rad.\"], [\"Ange ett l\\u00E4randem\\u00E5l per rad.\"])))),\r\n                React.createElement(\"textarea\", { className: \"learning-goal-box\", value: content.commonLearningGoals.join('\\n'), onChange: function (ev) { return repo.courseContents.update(content, {\r\n                        commonLearningGoals: ev.target.value.split('\\n')\r\n                    }); } }))) : null);\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import React from 'react';\r\nimport { arrayToLookup } from '../../../../utils/utils';\r\nimport { TaskList } from '../../../course-viewer/subcomponents/task-list';\r\nimport { AddTaskButton } from './add-task-button';\r\nimport { SortableTaskList } from '../../../utility-components/sortable-task-list';\r\nimport { Link } from 'react-router-dom';\r\nimport { computeUpdatedOrder, getSortedTasks } from '../../logic/task-order';\r\nexport var LearningTasksWithCommonGoals = function (_a) {\r\n    var school = _a.school, repo = _a.repo, content = _a.content, draftId = _a.draftId, editMode = _a.editMode, course = _a.course, courseTab = _a.courseTab, learningGoals = _a.learningGoals, block = _a.block;\r\n    var tasks = getSortedTasks(content);\r\n    var subjectToTasksLookup = arrayToLookup(tasks, function (t) { return t.subject || \"\"; });\r\n    var subject = course.type === 'step-course' ?\r\n        course.subject :\r\n        courseTab.subject;\r\n    if (subject && !subjectToTasksLookup[subject.subjectName]) {\r\n        // Make sure we have at least one subject heading if task list is empty:\r\n        subjectToTasksLookup[subject.subjectName] = [];\r\n    }\r\n    // TODO: Kolla hr och i learning-tasks-with-separate-goals.\r\n    //  * Behvs subject-lookup?\r\n    //  * Kan vi bryta vy-varianten frn edit varianten? (i bda fallen?)\r\n    // Sedan:\r\n    //  * Implementera edit varianterna. Lgg till.\r\n    //  * Implementera sortering funktionalitet i SortableTaskList.\r\n    //  * I all vyer av tasks (subject planner + courseviewer): \r\n    //    * G igenom alla task i den ordningen dom redan r i\r\n    //    * \r\n    return React.createElement(React.Fragment, null, Object.keys(subjectToTasksLookup).map(function (subject) {\r\n        var taskList = subjectToTasksLookup[subject];\r\n        var learningModuleTasks = taskList.map(function (task) { return ({\r\n            id: task.id,\r\n            name: task.name,\r\n            url: editMode ?\r\n                \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId + \"/edit\" :\r\n                draftId ?\r\n                    \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId :\r\n                    \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/tasks/\" + task.id,\r\n            courseName: course.name,\r\n            learningGoal: subject,\r\n            step: courseTab.type === 'step-course-tab' ? courseTab.stepNo : undefined,\r\n            task: task,\r\n            courseInfo: {\r\n                school: school,\r\n                course: course.id,\r\n                tab: courseTab.id\r\n            }\r\n        }); });\r\n        function linkToTask(task) {\r\n            return \"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId + \"/edit\";\r\n        }\r\n        return (React.createElement(\"div\", { key: subject },\r\n            React.createElement(\"h5\", null, subject),\r\n            React.createElement(\"ul\", null, learningGoals.map(function (lg) { return React.createElement(\"li\", { key: lg }, lg); })),\r\n            !editMode ?\r\n                React.createElement(TaskList, { learningTasks: learningModuleTasks }) : React.createElement(React.Fragment, null,\r\n                React.createElement(SortableTaskList, { taskMetas: learningModuleTasks.map(function (_a) {\r\n                        var task = _a.task;\r\n                        return ({ task: task, isTaskOwner: true });\r\n                    }), renderEditLink: function (_a) {\r\n                        var task = _a.task;\r\n                        return React.createElement(React.Fragment, null,\r\n                            React.createElement(Link, { to: linkToTask(task), className: \"editItem\" }),\r\n                            \"\\u00A0\");\r\n                    }, renderLink: function (_a) {\r\n                        var task = _a.task;\r\n                        return React.createElement(Link, { to: linkToTask(task) }, task.name);\r\n                    }, onSort: function (source, target, placement) {\r\n                        var updatedOrder = computeUpdatedOrder(content.tasks, content.taskOrder, source, target, placement, { appendLeftovers: true });\r\n                        repo.courseContents.update(content, { taskOrder: updatedOrder });\r\n                    } }),\r\n                React.createElement(AddTaskButton, { branch: repo, content: content, course: course, school: school, draftId: draftId, tab: courseTab, block: block, learningGoal: subject }))));\r\n    }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../utils/utils';\r\nimport { TaskList } from '../../../course-viewer/subcomponents/task-list';\r\nimport { AddTaskButton } from './add-task-button';\r\nimport { SortableTaskList } from '../../../utility-components/sortable-task-list';\r\nimport { Link } from 'react-router-dom';\r\nimport { computeUpdatedOrder, getSortedTasks } from '../../logic/task-order';\r\nexport var LearningTasksWithSeparateGoals = function (_a) {\r\n    var school = _a.school, repo = _a.repo, content = _a.content, draftId = _a.draftId, editMode = _a.editMode, course = _a.course, courseTab = _a.courseTab, learningGoals = _a.learningGoals, block = _a.block;\r\n    var tasks = getSortedTasks(content);\r\n    var cathegorizedTasks = {};\r\n    var goalToTasksLookup = learningGoals.reduce(function (res, goal) {\r\n        res[goal] = tasks.filter(function (task) {\r\n            if (task.learningGoal && task.learningGoal.split('\\n')\r\n                .map(function (line) { return line.trim().toLowerCase(); })\r\n                .includes(goal.toLowerCase())) {\r\n                cathegorizedTasks[task.id] = true;\r\n                return true;\r\n            }\r\n        });\r\n        return res;\r\n    }, {});\r\n    var uncathegorizedTasks = tasks.filter(function (t) { return !cathegorizedTasks[t.id]; });\r\n    if (courseTab.tabClass === 'mission-tab' || tasks.length === 0) {\r\n        goalToTasksLookup[''] = uncathegorizedTasks;\r\n    }\r\n    else if (uncathegorizedTasks.length > 0) {\r\n        goalToTasksLookup[L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00D6vergripande\"], [\"\\u00D6vergripande\"])))] = uncathegorizedTasks;\r\n    }\r\n    function linkToTask(task) {\r\n        return \"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId + \"/edit\";\r\n    }\r\n    return React.createElement(React.Fragment, null, Object.keys(goalToTasksLookup).map(function (goal) {\r\n        var taskList = goalToTasksLookup[goal];\r\n        var learningModuleTasks = taskList.map(function (task) { return ({\r\n            id: task.id,\r\n            name: task.name,\r\n            url: editMode ?\r\n                \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId + \"/edit\" :\r\n                draftId ?\r\n                    \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/contents/\" + content.id + \"/tasks/\" + task.id + \"/drafts/\" + draftId :\r\n                    \"#/\" + school + \"/courses/\" + course.id + \"/tabs/\" + courseTab.id + \"/tasks/\" + task.id,\r\n            courseName: course.name,\r\n            learningGoal: courseTab.tabClass === 'mission-tab' ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Uppdrag\"], [\"Uppdrag\"]))) : goal,\r\n            step: courseTab.type === 'step-course-tab' ? courseTab.stepNo : undefined,\r\n            task: task,\r\n            courseInfo: {\r\n                school: school,\r\n                course: course.id,\r\n                tab: courseTab.id\r\n            }\r\n        }); });\r\n        return (React.createElement(\"div\", { key: goal },\r\n            goal && React.createElement(\"h4\", null, goal),\r\n            !editMode ?\r\n                React.createElement(TaskList, { learningTasks: learningModuleTasks }) :\r\n                React.createElement(React.Fragment, null,\r\n                    React.createElement(SortableTaskList, { taskMetas: learningModuleTasks.map(function (_a) {\r\n                            var task = _a.task;\r\n                            return ({ task: task, isTaskOwner: true });\r\n                        }), renderEditLink: function (_a) {\r\n                            var task = _a.task;\r\n                            return React.createElement(React.Fragment, null,\r\n                                React.createElement(Link, { to: linkToTask(task), className: \"editItem\" }),\r\n                                \"\\u00A0\");\r\n                        }, renderLink: function (_a) {\r\n                            var task = _a.task;\r\n                            return React.createElement(Link, { to: linkToTask(task) }, task.name);\r\n                        }, onSort: function (source, target, placement) {\r\n                            var updatedOrder = computeUpdatedOrder(content.tasks, content.taskOrder, source, target, placement, { appendLeftovers: true });\r\n                            repo.courseContents.update(content, { taskOrder: updatedOrder });\r\n                        } }),\r\n                    React.createElement(AddTaskButton, { branch: repo, content: content, course: course, school: school, draftId: draftId, tab: courseTab, block: block, learningGoal: goal }))));\r\n    }));\r\n};\r\nvar templateObject_1, templateObject_2;\r\n","import React from \"react\";\r\nimport { liveQueryView } from \"../../../utility-components/live-query-view\";\r\nimport { flatten } from \"../../../../utils/utils\";\r\nexport var ResourceListView = liveQueryView(function (_a) {\r\n    var resourceListContents = _a.resourceListContents;\r\n    return resourceListContents\r\n        .orderBy(\"order\")\r\n        .toValue()\r\n        .map(function (contents) {\r\n        var resources = flatten(contents.map(function (content) { return content.resources || []; }));\r\n        if (resources.length === 0)\r\n            return React.createElement(\"div\", null);\r\n        return (React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                React.createElement(\"h2\", null, \"Resurser\"),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"taskContainer\" }, resources.map(function (res) { return (React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { href: res.url, target: \"_blank\" }, res.name)))); })))));\r\n    });\r\n});\r\n","import React from 'react';\r\nimport { Wysiwyg } from '../../../utility-components/wysiwyg';\r\nimport actions from '../../../utility-components/wysiwyg/actions-sv';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nimport { washHtml } from '../../../utility-components/wysiwyg/wash-html';\r\nexport var RichTextContentBox = function (_a) {\r\n    var content = _a.content, repo = _a.repo, editMode = _a.editMode, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\r\n    return editMode ? React.createElement(\"div\", null,\r\n        React.createElement(Wysiwyg, { html: content.html, defaultActions: actions, readOnly: !editMode || (content.locked && !isKedStaff()), reportNumChars: reportNumChars, maxChars: maxChars, actions: [\r\n                \"bold\",\r\n                \"italic\",\r\n                \"underline\",\r\n                \"strikethrough\",\r\n                \"heading2\",\r\n                \"heading3\",\r\n                \"olist\",\r\n                \"ulist\",\r\n                \"outdent\",\r\n                \"indent\",\r\n                \"line\",\r\n                \"link\",\r\n                \"image\"\r\n            ], onChange: editMode && (function (html) { return repo.courseContents.update(content, { html: html }); }) })) : React.createElement(\"div\", null,\r\n        React.createElement(\"div\", { className: \"rich-text-readonly\", dangerouslySetInnerHTML: { __html: washHtml(content.html) } }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useState, useRef, useEffect } from 'react';\r\nimport { cfg } from '../../../../globals/KED.cfg';\r\nimport { WordBankContentSettings } from './word-bank-content-settings';\r\nimport { EllipsisLoader } from '../../../course-builder/sub-components/ellipsis-loader';\r\nimport { isKedStaff } from '../../logic/is-ked-staff';\r\nexport function WordBankContentBox(_a) {\r\n    var repo = _a.repo, content = _a.content, siblingWordBanks = _a.siblingWordBanks, editMode = _a.editMode, course = _a.course, courseTab = _a.courseTab;\r\n    var selectedWordBank = content.selectedWordBank;\r\n    var subjectName = course.subject.subjectName;\r\n    var stepNo = courseTab.stepNo;\r\n    var iframeSrc = selectedWordBank && cfg.KED_WORDBANKS_URL + \"?preview=true&subject=\" + subjectName + \"&step=\" + stepNo + \"&list=\" + selectedWordBank.key;\r\n    var _b = tslib_1.__read(useState(200), 2), iframeHeight = _b[0], setIframeHeight = _b[1];\r\n    var iframeRef = useRef();\r\n    var wordBanksAlreadyAdded = siblingWordBanks.map(function (c) { return c.selectedWordBank && c.selectedWordBank.key; })\r\n        .filter(function (key) { return !!key; });\r\n    useEffect(function () { return setIframeHeight(200); }, [selectedWordBank && selectedWordBank.key]); // Reset iframe height whenever selected word bank changes and let onload fix it.\r\n    return React.createElement(React.Fragment, null,\r\n        editMode && (!content.locked || isKedStaff()) && React.createElement(React.Suspense, { fallback: React.createElement(EllipsisLoader, null) },\r\n            React.createElement(WordBankContentSettings, tslib_1.__assign({}, { subjectName: subjectName, stepNo: stepNo, wordBanksAlreadyAdded: wordBanksAlreadyAdded }, { selectedWordBank: selectedWordBank, onChange: function (_a) {\r\n                    var name = _a.name, key = _a.key;\r\n                    repo.courseContents.update(content, { selectedWordBank: { name: name, key: key } });\r\n                } }))),\r\n        selectedWordBank &&\r\n            React.createElement(\"iframe\", { ref: iframeRef, scrolling: \"no\", frameBorder: \"0\", style: {\r\n                    width: \"100%\",\r\n                    height: iframeHeight,\r\n                    padding: 0,\r\n                    margin: 0\r\n                }, src: iframeSrc, onLoad: function () {\r\n                    setIframeHeight(iframeRef.current.contentWindow.document.body.scrollHeight);\r\n                } }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { cfg } from '../../../../globals/KED.cfg';\r\nimport useFetch from 'fetch-suspense';\r\nimport { L } from '../../../../utils/utils';\r\nimport Select from 'react-select';\r\nexport function WordBankContentSettings(_a) {\r\n    var subjectName = _a.subjectName, stepNo = _a.stepNo, selectedWordBank = _a.selectedWordBank, wordBanksAlreadyAdded = _a.wordBanksAlreadyAdded, onChange = _a.onChange;\r\n    var apiUrl = cfg.KED_ENUM_WORDBANKS_URL + \"?sv.contenttype=application/json&subject=\" + subjectName + \"&step=\" + stepNo;\r\n    var availableWordBanks = useFetch(apiUrl);\r\n    // Filter out word banks that was already added to the same tab\r\n    availableWordBanks = availableWordBanks.filter(function (_a) {\r\n        var order = _a.order;\r\n        return (selectedWordBank && order === selectedWordBank.key) ||\r\n            !wordBanksAlreadyAdded ||\r\n            !wordBanksAlreadyAdded.includes(order);\r\n    });\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"h3\", null, selectedWordBank ? selectedWordBank.name : L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"V\\u00E4lj ordbank\"], [\"V\\u00E4lj ordbank\"])))),\r\n        React.createElement(Select, { isMulti: false, placeholder: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"V\\u00E4lj bland ordbanker f\\u00F6r \", \", steg \", \"\"], [\"V\\u00E4lj bland ordbanker f\\u00F6r \", \", steg \", \"\"])), subjectName, stepNo), noOptionsMessage: function () { return L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Kunde inte hitta tillg\\u00E4ngliga ordbanker f\\u00F6r \", \", steg \", \"\"], [\"Kunde inte hitta tillg\\u00E4ngliga ordbanker f\\u00F6r \", \", steg \", \"\"])), subjectName, stepNo); }, options: availableWordBanks.map(function (_a) {\r\n                var name = _a.name, id = _a.id, order = _a.order, url = _a.url;\r\n                return ({ label: name, value: order });\r\n            }), value: selectedWordBank && { label: selectedWordBank.name, value: selectedWordBank.key }, onChange: function (option) { return onChange({ name: option.label, key: option.value }); } }));\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { liveQueryView } from '../../utility-components/live-query-view';\r\nimport { compareProp, L } from '../../../utils/utils';\r\nimport { AddContentButton } from './add-content-button';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nimport { TabSettings } from './tab-settings';\r\nimport { CourseTabContentBox } from './course-tab-content-box';\r\nimport { TabSettingsAdmin } from './tab-settings-admin';\r\nimport { ResourceEditor } from './resource-editor';\r\nexport var CourseTabArea = liveQueryView(function (_a) {\r\n    var course = _a.course, branch = _a.branch, block = _a.block, tab = _a.tab, editMode = _a.editMode, lazyContents = _a.lazyContents, school = _a.school, draftId = _a.draftId;\r\n    return lazyContents.map(function (contents) {\r\n        if (!tab) {\r\n            if (editMode)\r\n                return React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Denna kurs saknar inneh\\u00E5ll. Skapa ny flik genom knappen ovan\"], [\"Denna kurs saknar inneh\\u00E5ll. Skapa ny flik genom knappen ovan\"]))));\r\n            else\r\n                return isKedStaff() ?\r\n                    React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Denna kurs saknar inneh\\u00E5ll. V\\u00E4lj Redigera knappen f\\u00F6r att l\\u00E4gga till flikar.\"], [\"Denna kurs saknar inneh\\u00E5ll. V\\u00E4lj Redigera knappen f\\u00F6r att l\\u00E4gga till flikar.\"])))) :\r\n                    React.createElement(\"p\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Denna kurs saknar inneh\\u00E5ll.\"], [\"Denna kurs saknar inneh\\u00E5ll.\"]))));\r\n        }\r\n        contents = contents.slice().sort(compareProp(\"order\"));\r\n        return React.createElement(\"div\", null,\r\n            editMode ? React.createElement(React.Fragment, null,\r\n                isKedStaff() || !tab.locked ?\r\n                    React.createElement(TabSettings, { course: course, tab: tab, repo: branch }) :\r\n                    null,\r\n                isKedStaff() ?\r\n                    React.createElement(TabSettingsAdmin, { course: course, tab: tab, repo: branch, block: block }) :\r\n                    null) : null,\r\n            contents.filter(function (c) { return c.type !== \"resource-list\"; }).map(function (content, contentOrderIndex) { return React.createElement(CourseTabContentBox, { key: content.id, content: content, branch: branch, contentOrderIndex: contentOrderIndex, contents: contents, course: course, draftId: draftId, editMode: editMode, school: school, block: block, tab: tab }); }),\r\n            !!editMode && React.createElement(ResourceEditor, { schoolName: school, courseId: course.id, tabId: tab.id, repo: branch, contents: contents }),\r\n            !!editMode && (isKedStaff() || !tab.locked) && React.createElement(React.Fragment, null,\r\n                tab.tabClass === 'word-bank-tab' &&\r\n                    // [ Add Word Bank ] button\r\n                    React.createElement(AddContentButton, { type: \"word-bank\", tab: tab, branch: branch, course: course, schoolName: school }),\r\n                tab.tabClass !== 'word-bank-tab' &&\r\n                    (tab.tabClass === 'mission-tab' || tab.tabClass === 'subject-tab' || course.type === 'step-course') &&\r\n                    !contents.some(function (c) { return c.type === 'learning-goals'; }) &&\r\n                    // [ Add Learning Goals ] button\r\n                    React.createElement(AddContentButton, { type: \"learning-goals\", tab: tab, branch: branch, course: course, schoolName: school }),\r\n                React.createElement(AddContentButton, { type: \"rich-text\", tab: tab, branch: branch, course: course, schoolName: school }),\r\n                tab.tabClass === 'intro-tab' || tab.tabClass === 'run-up-tab' &&\r\n                    // [ Add Embedded HTML ] button\r\n                    React.createElement(AddContentButton, { type: \"embedded-html\", tab: tab, branch: branch, course: course, schoolName: school })));\r\n    });\r\n});\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nimport { CourseContentBox, COURSE_CONTENT_TYPES } from './course-contents';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nimport { L } from '../../../utils/utils';\r\nimport { RemoveItem } from '../../course-builder/sub-components/remove-item';\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { reorder } from '../logic/change-sort-order';\r\nimport { FieldLimits } from '../common/field-limits';\r\nvar MAX_CHARS_IN_CONTENTS = FieldLimits.MAX_CHARS_IN_CONTENTS;\r\nvar CourseTabContentBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CourseTabContentBox, _super);\r\n    function CourseTabContentBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.numCharsObservable = new Emitter(0); // Dedicated state for a sub-part of the generated DOM (avoid infinite loop)\r\n        _this.state = {\r\n        //numChars: 0\r\n        };\r\n        return _this;\r\n    }\r\n    CourseTabContentBox.prototype.render = function () {\r\n        var _a = this.props, editMode = _a.editMode, content = _a.content, branch = _a.branch, course = _a.course, tab = _a.tab, school = _a.school, draftId = _a.draftId, contentOrderIndex = _a.contentOrderIndex, contents = _a.contents, block = _a.block;\r\n        var kedStaff = isKedStaff();\r\n        //const { numChars } = this.state;\r\n        var numCharsObservable = this.numCharsObservable;\r\n        return !editMode || (content.locked && !kedStaff) ?\r\n            //\r\n            // Not edit mode:\r\n            //\r\n            React.createElement(CourseContentBox, { key: content.id, repo: branch, content: content, siblingContents: contents, course: course, editMode: editMode, courseTab: tab, school: school, draftId: draftId, block: block }) :\r\n            //\r\n            // Edit mode:\r\n            //\r\n            React.createElement(\"div\", { key: content.id, className: [\"course-content-box\", content.type !== 'learning-goals' && \"ked_boxed\"].filter(function (x) { return !!x; }).join(' '), style: { position: 'relative' } },\r\n                React.createElement(AlignHorizontal, null,\r\n                    React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"p\", { className: \"box-mini-label\" }, COURSE_CONTENT_TYPES[content.type])),\r\n                    React.createElement(HorizontalItem, null, kedStaff ?\r\n                        React.createElement(React.Fragment, null,\r\n                            \"\\u00A0\",\r\n                            React.createElement(\"input\", { type: \"checkbox\", checked: !content.locked, onChange: function (ev) { return branch.courseContents.update(content, { locked: !ev.target.checked }); } }), L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Till\\u00E5t redigering\"], [\"Till\\u00E5t redigering\"]))),\r\n                            !content.locked ? React.createElement(React.Fragment, null,\r\n                                \"\\u00A0\",\r\n                                React.createElement(\"input\", { type: \"checkbox\", checked: !content.lockDelete, onChange: function (ev) { return branch.courseContents.update(content, { lockDelete: !ev.target.checked }); } }), L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Till\\u00E5t d\\u00F6lja rutan\"], [\"Till\\u00E5t d\\u00F6lja rutan\"])))) : null) : null)),\r\n                React.createElement(CourseContentBox, { repo: branch, content: content, siblingContents: contents, course: course, editMode: true, school: school, draftId: draftId, courseTab: tab, maxChars: MAX_CHARS_IN_CONTENTS, reportNumChars: function (numChars) {\r\n                        // Avoid setting state because it turns out to be infinite loop.\r\n                        // (setState() leads to re-render of this whole component, leading to\r\n                        // re-render of CourseContentBox, that calls reportNumChars etc...)\r\n                        // Instead we communicate this particular state to a dedicated Observable\r\n                        // that will only update the particular component that is affected by it.\r\n                        numCharsObservable.dispatch(numChars);\r\n                        //this.setState({ numChars });\r\n                    }, block: block }),\r\n                React.createElement(\"div\", { style: { position: 'absolute', top: 0, right: 0 } },\r\n                    (kedStaff || !content.locked) && contentOrderIndex > 0 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-up selectable\", \"aria-hidden\": \"true\", onClick: function () {\r\n                                var newOrder = reorder(contents, content.id, contents[contentOrderIndex - 1].id, \"before\");\r\n                                if (newOrder) {\r\n                                    branch.courseContents.update(content, { order: newOrder });\r\n                                }\r\n                            } }),\r\n                        \" \"),\r\n                    (kedStaff || !content.locked) && contentOrderIndex < contents.length - 1 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-down selectable\", \"aria-hidden\": \"true\", onClick: function () {\r\n                                var newOrder = reorder(contents, content.id, contents[contentOrderIndex + 1].id, \"after\");\r\n                                if (newOrder) {\r\n                                    branch.courseContents.update(content, { order: newOrder });\r\n                                }\r\n                            } }),\r\n                        \" \"),\r\n                    kedStaff || !content.lockDelete ? React.createElement(RemoveItem, { title: school === 'standard' ? L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Ta bort inneh\\u00E5llsrutan\"], [\"Ta bort inneh\\u00E5llsrutan\"]))) : L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"D\\u00F6lj inneh\\u00E5llsrutan\"], [\"D\\u00F6lj inneh\\u00E5llsrutan\"]))), style: { display: 'inline-block' }, onClick: function () { return confirm(L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Ta bort inneh\\u00E5ll?\"], [\"Ta bort inneh\\u00E5ll?\"])))) && branch.courseTabs.removeRelated(tab.id, \"contents\", content); } })\r\n                        : null),\r\n                content.type === 'rich-text' ? React.createElement(LazyContent, null, numCharsObservable.map(function (numChars) {\r\n                    return React.createElement(\"div\", { className: [\"char-counter-bottom\"].concat(numChars >= MAX_CHARS_IN_CONTENTS ? \"overflowed\" : []).join(' ') }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Texten inneh\\u00E5ller \", \" av max \", \" till\\u00E5tna tecken\"], [\"Texten inneh\\u00E5ller \", \" av max \", \" till\\u00E5tna tecken\"])), numChars, MAX_CHARS_IN_CONTENTS));\r\n                })) :\r\n                    undefined);\r\n    };\r\n    return CourseTabContentBox;\r\n}(React.Component));\r\nexport { CourseTabContentBox };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { L } from '../../../../utils/utils';\r\nexport var CourseTabClasses = {\r\n    \"intro-tab\": L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Introduktionsflik\"], [\"Introduktionsflik\"]))),\r\n    \"run-up-tab\": L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Upptaktsflik\"], [\"Upptaktsflik\"]))),\r\n    \"subject-tab\": L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\\u00C4mnesflik\"], [\"\\u00C4mnesflik\"]))),\r\n    \"mission-tab\": L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Uppdragsflik\"], [\"Uppdragsflik\"]))),\r\n    \"content-tab\": L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Generell flik\"], [\"Generell flik\"]))),\r\n    \"teacher-tab\": L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"L\\u00E4rarsida\"], [\"L\\u00E4rarsida\"]))),\r\n    \"word-bank-tab\": L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Ordbank\"], [\"Ordbank\"])))\r\n};\r\nexport var TabTypesPerCourseType = {\r\n    \"step-course\": [\r\n        \"content-tab\",\r\n        \"intro-tab\",\r\n        \"teacher-tab\",\r\n        \"word-bank-tab\"\r\n    ],\r\n    \"theme-course\": [\r\n        \"content-tab\",\r\n        \"run-up-tab\",\r\n        \"subject-tab\",\r\n        \"mission-tab\",\r\n        \"teacher-tab\"\r\n    ]\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { db } from '../../../globals/db';\r\nimport { LazyBanner } from '../common/banner';\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { L, compareProp, compareProps } from '../../../utils/utils';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { preserveImpersonationQuery } from '../../../access-control';\r\nimport { AddTabButton } from './add-tab-button';\r\nimport { withRouter } from 'react-router';\r\nimport { CourseArea } from './course-area';\r\nimport { TaskEditor } from './task/task-editor';\r\nimport { ClickableSchoolDiv } from './clickable-school-div';\r\nimport { isEmployee } from '../logic/is-employee';\r\nimport { TaskViewerPage } from './task/viewer/task-viewer-page';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { reorder } from '../logic/change-sort-order';\r\nexport var CourseViewerPage = withRouter((function (_a) {\r\n    var school = _a.school, courseId = _a.courseId, activeTab = _a.activeTab, draftId = _a.draftId, editMode = _a.editMode, history = _a.history, contentId = _a.contentId, taskId = _a.taskId;\r\n    var repo = editMode ?\r\n        db : // In edit mode, do not optimize cache, as it prohibits collaboration\r\n        db.optimizeCache();\r\n    var schoolObservable = repo.schools.name(school).single();\r\n    var branchObservable = draftId ? // In edit mode, draftId is defined.\r\n        new Emitter(repo.branch(draftId)) :\r\n        schoolObservable.map(function (school) { return repo.branch(school.officialBranchId); });\r\n    var courseObservable = branchObservable.switchMap(function (branch) {\r\n        return branch.courseInstances.include(\"blocks\", \"tabs\").id(courseId);\r\n    });\r\n    var intermediateObservableUnsorted = courseObservable.combineLatest(schoolObservable)\r\n        .switchMap(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), course = _b[0], schoolEntity = _b[1];\r\n        var branch = draftId ?\r\n            repo.branch(draftId) :\r\n            repo.branch(schoolEntity.officialBranchId);\r\n        if (course.type === 'theme-course') {\r\n            return new Emitter({ course: course, tabs: course.tabs, branch: branch, block: null, schoolEntity: schoolEntity });\r\n        }\r\n        if (activeTab && activeTab !== '$')\r\n            return branch.courseBlocks.hasEdgesTo([activeTab]).include(\"tabs\").toValue()\r\n                .map(function (_a) {\r\n                var _b = tslib_1.__read(_a, 1), block = _b[0];\r\n                return ({\r\n                    course: course,\r\n                    tabs: block.tabs,\r\n                    branch: branch,\r\n                    block: block || course.blocks[0],\r\n                    schoolEntity: schoolEntity\r\n                });\r\n            });\r\n        if (course.blocks.length > 0)\r\n            return branch.courseBlocks.include(\"tabs\").id(course.blocks[0].id)\r\n                .map(function (block) { return ({\r\n                course: course,\r\n                tabs: block.tabs,\r\n                branch: branch,\r\n                block: block,\r\n                schoolEntity: schoolEntity\r\n            }); });\r\n        return new Emitter({ course: course, tabs: [], branch: branch, block: null, schoolEntity: schoolEntity });\r\n    });\r\n    var intermediateObservable = intermediateObservableUnsorted.map(function (vals) { return (tslib_1.__assign({}, vals, { tabs: vals.tabs && vals.tabs.sort(compareProps([\"stepNo\", \"order\"])) })); });\r\n    var bannerPropsObservable = intermediateObservable\r\n        .map(function (_a) {\r\n        var course = _a.course, tabs = _a.tabs, branch = _a.branch, block = _a.block, schoolEntity = _a.schoolEntity;\r\n        return getCourseBannerProps(tabs, editMode, school, schoolEntity, draftId, course, branch, activeTab, block);\r\n    });\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(LazyBanner, { lazyProps: bannerPropsObservable }),\r\n        taskId ? editMode ?\r\n            React.createElement(LazyContent, null, intermediateObservable.map(function (_a) {\r\n                var branch = _a.branch, block = _a.block, course = _a.course, tabs = _a.tabs;\r\n                return React.createElement(TaskEditor, { school: school, course: course, draftId: draftId, branch: branch, activeTab: activeTab, contentId: contentId, taskId: taskId, blockId: block && block.id });\r\n            })) :\r\n            React.createElement(TaskViewerPage, { school: school, courseId: courseId, lazyRepo: branchObservable, activeTab: activeTab, taskId: taskId, contentId: contentId, draftId: draftId }) :\r\n            React.createElement(LazyContent, null, intermediateObservable.map(function (_a) {\r\n                var branch = _a.branch, block = _a.block, course = _a.course, tabs = _a.tabs;\r\n                return React.createElement(CourseArea, { school: school, courseId: courseId, draftId: draftId, course: course, branch: branch, tabs: tabs, activeTab: activeTab, editMode: editMode, block: block });\r\n            })));\r\n}));\r\nfunction getCourseBannerProps(tabs, editMode, school, schoolEntity, draftId, course, branch, activeTab, block) {\r\n    var _this = this;\r\n    var kedStaff = isKedStaff();\r\n    var courseId = course.id;\r\n    var activeTabObj = tabs.filter(function (tab) { return tab.id === activeTab; })[0] || tabs[0];\r\n    if (course.type === 'step-course' && activeTabObj && activeTabObj.type === 'step-course-tab') {\r\n        tabs = tabs.filter(function (tab) { return tab.type === 'step-course-tab' && tab.stepNo === activeTabObj.stepNo; });\r\n    }\r\n    var bannerTabs = (isEmployee() ? tabs : tabs.filter(function (tab) { return tab.tabClass !== 'teacher-tab'; }))\r\n        .map(function (tab) { return ({\r\n        key: tab.id,\r\n        name: tab.tabTitle,\r\n        draggable: true,\r\n        link: editMode ?\r\n            \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + tab.id + (draftId ? \"/drafts/\" + draftId : '') + \"/edit\" :\r\n            \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + tab.id + (draftId ? \"/drafts/\" + draftId : '')\r\n    }); });\r\n    var buttons = [];\r\n    if (editMode && (kedStaff || course.allowAddTabs)) {\r\n        if (course.type === 'theme-course') {\r\n            buttons.push(React.createElement(AddTabButton, { type: \"theme-course-tab\", key: \"$addTab\", school: school, course: course, branch: branch, draftId: draftId }));\r\n        }\r\n        else {\r\n            var stepNo = activeTabObj ?\r\n                activeTabObj.stepNo :\r\n                block.stepNumbers[0] || 1;\r\n            buttons.push(React.createElement(AddTabButton, { type: \"step-course-tab\", key: \"$addTab\", school: school, course: course, branch: branch, draftId: draftId, block: block, stepNo: stepNo }));\r\n        }\r\n    }\r\n    if (kedStaff) {\r\n        // Remove the \"role\" attribute from query, as we want to stop impersonating an Employee when using the admin interface\r\n        buttons.push(React.createElement(\"a\", { href: preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_ADMIN_URL, { role: undefined }) +\r\n                (\"#/admin/courses/\" + courseId + \"/settings\"), key: \"$settings\", title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Inst\\u00E4llningar\"], [\"Inst\\u00E4llningar\"]))) },\r\n            React.createElement(\"i\", { className: \"fa fa-cog\", \"aria-hidden\": true }),\r\n            \"\\u00A0\"));\r\n    }\r\n    var bannerProps = {\r\n        title: course.name,\r\n        backgroundImage: null,\r\n        tabs: bannerTabs,\r\n        cornerBox: React.createElement(ClickableSchoolDiv, { school: school, draftId: draftId, displayName: schoolEntity.displayName || school }),\r\n        buttons: buttons,\r\n        activeTab: activeTab || (bannerTabs[0] && bannerTabs[0].key),\r\n        blocks: course.blocks && course.blocks.sort(compareProp(\"blockNo\")).map(function (_a) {\r\n            var blockId = _a.id, name = _a.name, stepNumbers = _a.stepNumbers;\r\n            return ({\r\n                id: blockId,\r\n                name: name,\r\n                steps: stepNumbers.map(function (stepNo) { return ({\r\n                    isActive: activeTabObj && stepNo === activeTabObj.stepNo,\r\n                    stepNo: stepNo,\r\n                    link: \"/\" + school + \"/courses/\" + courseId + \"/blocks/\" + blockId + \"/steps/\" + stepNo\r\n                }); })\r\n            });\r\n        }),\r\n        sortableTabs: editMode && (kedStaff || course.allowReorderTabs),\r\n        onTabDrop: function (source, target, placement) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n            var newOrder, sourceTab;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                newOrder = reorder(tabs, source, target, placement);\r\n                if (newOrder) {\r\n                    sourceTab = tabs.find(function (t) { return t.id === source; });\r\n                    if (sourceTab) {\r\n                        branch.courseTabs.update(sourceTab, { order: newOrder });\r\n                    }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        }); }\r\n    };\r\n    return bannerProps;\r\n}\r\nvar templateObject_1;\r\n","var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { withRouter } from 'react-router';\r\nimport { db } from '../../../globals/db';\r\nimport { publishCourse } from '../logic/publish-course';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { isKedStaff } from '../logic/is-ked-staff';\r\nexport var EditorFooterButtons = withRouter(function (_a) {\r\n    var school = _a.school, course = _a.course, tab = _a.tab, activeTab = _a.activeTab, draftId = _a.draftId, history = _a.history, courseType = _a.courseType, blockId = _a.blockId;\r\n    return React.createElement(React.Fragment, null,\r\n        tab && (isKedStaff() || !tab.locked || course.allowRemoveTabs) ? React.createElement(\"div\", { className: \"btn btn-warning pull-right\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var draftRepo, courseTab, contents;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            draftRepo = db.branch(draftId);\r\n                            return [4 /*yield*/, draftRepo.courseTabs\r\n                                    .include(\"contents\")\r\n                                    .includeIdsOnly()\r\n                                    .id(activeTab)\r\n                                    .load()];\r\n                        case 1:\r\n                            courseTab = _a.sent();\r\n                            return [4 /*yield*/, draftRepo.courseContents\r\n                                    .include(\"tasks\")\r\n                                    .includeIdsOnly()\r\n                                    .ids(courseTab.contents.map(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id;\r\n                                }))\r\n                                    .toValue().load()];\r\n                        case 2:\r\n                            contents = _a.sent();\r\n                            if (isKedStaff() && school === 'standard') {\r\n                                //\r\n                                // Only remove related contents and tasks if we are deleting a physical tab here\r\n                                //\r\n                                contents.forEach(function (content) {\r\n                                    content.tasks.forEach(function (task) {\r\n                                        draftRepo.courseContents.removeRelated(content.id, \"tasks\", task);\r\n                                    });\r\n                                });\r\n                                courseTab.contents.forEach(function (content) {\r\n                                    draftRepo.courseTabs.removeRelated(courseTab.id, \"contents\", content);\r\n                                });\r\n                            }\r\n                            if (courseType === 'theme-course') {\r\n                                draftRepo.courseInstances.removeRelated(course.id, \"tabs\", courseTab);\r\n                            }\r\n                            else if (blockId) {\r\n                                draftRepo.courseBlocks.removeRelated(blockId, \"tabs\", courseTab);\r\n                            }\r\n                            return [4 /*yield*/, db.saveNow()];\r\n                        case 3:\r\n                            _a.sent();\r\n                            history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/$/drafts/\" + draftId + \"/edit\");\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); } },\r\n            React.createElement(\"i\", { className: \"fa fa-trash\", \"aria-hidden\": true }),\r\n            \"\\u00A0\", L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Ta bort fliken\"], [\"Ta bort fliken\"])))) : null,\r\n        React.createElement(\"div\", null,\r\n            React.createElement(AlignHorizontal, null,\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + (activeTab || '$') + \"/drafts/\" + draftId);\r\n                                return [2 /*return*/];\r\n                            });\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-eye\", \"aria-hidden\": true }),\r\n                        \"\\u00A0\", L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"F\\u00F6rhandsgranska\"], [\"F\\u00F6rhandsgranska\"]))))),\r\n                React.createElement(HorizontalItem, null,\r\n                    \"\\u00A0\",\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                history.push(\"/\" + school + \"/courses/\" + course.id + \"/history\");\r\n                                return [2 /*return*/];\r\n                            });\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-history\", \"aria-hidden\": true }),\r\n                        \"\\u00A0\", L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Versionshistorik\"], [\"Versionshistorik\"]))))),\r\n                React.createElement(HorizontalItem, null,\r\n                    \"\\u00A0\",\r\n                    React.createElement(\"button\", { className: \"btn btn-warning\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0: return [4 /*yield*/, publishCourse({\r\n                                            school: school,\r\n                                            course: course,\r\n                                            draftRepo: db.branch(draftId)\r\n                                        })];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        return [4 /*yield*/, db.saveNow()];\r\n                                    case 2:\r\n                                        _a.sent();\r\n                                        history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + (activeTab || '$'));\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-play\", \"aria-hidden\": true }),\r\n                        \"\\u00A0\", L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Publicera\"], [\"Publicera\"]))))))),\r\n        React.createElement(\"br\", null),\r\n        React.createElement(\"button\", { className: \"btn\", onClick: function () {\r\n                return history.push(\"/\" + school + \"/courses/\" + course.id + \"/tabs/\" + (activeTab || '$'));\r\n            } },\r\n            React.createElement(\"i\", { className: \"fa fa-arrow-left\", \"aria-hidden\": true }),\r\n            \"\\u00A0\", L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Avsluta redigering\"], [\"Avsluta redigering\"])))));\r\n});\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { HashRouter as Router, Route, Redirect } from 'react-router-dom';\r\nimport { ErrorSuccessFeedback } from '../../../utils/error-success-feedback';\r\nimport { Banner } from '../common/banner';\r\nimport { LoadingIndicator } from '../../utility-components/loading-indicator';\r\nimport { liveQueryView } from '../../utility-components/live-query-view';\r\nimport { Schools, db } from '../../../globals/db';\r\nimport { CourseViewerPage } from './course-viewer-page';\r\nimport { TwoColumnsPage } from '../common/two-columns-page';\r\nimport { WeekPlanner } from '../../weekplanner/weekplanner';\r\nimport { ListCourses } from './list-courses';\r\nimport { L } from '../../../utils/utils';\r\nimport env from '../../../globals/KED.env';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { RedirectToStep } from './redirect-to-step';\r\nimport { VersionHistoryPage } from './version-history';\r\nimport { keepSessionAlive } from '../../../utils/keep-session-alive';\r\nimport { setupDialogs } from '../common/dialog-content';\r\n// Keep Session Alive\r\nkeepSessionAlive();\r\nvar GetMySchoolAndResolveCourseId = liveQueryView(function (_a) {\r\n    var render = _a.render, courseIdOrName = _a.courseIdOrName;\r\n    if (courseIdOrName.length === 36 && courseIdOrName[8] === '-' && courseIdOrName[13] === '-' && courseIdOrName[18] === '-' && courseIdOrName[23] === '-') {\r\n        return Schools.mySchool.map(function (school) { return render(school, courseIdOrName); });\r\n    }\r\n    else {\r\n        return db.courseInstances\r\n            .name(courseIdOrName.replace('+', ' '))\r\n            .idsOnly()\r\n            .single()\r\n            .combineLatest(Schools.mySchool)\r\n            .map(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), course = _b[0], school = _b[1];\r\n            return render(school, course.id);\r\n        });\r\n    }\r\n});\r\nexport var SubjectPlannerViewerApp = setupDialogs(function () { return React.createElement(\"div\", { onKeyDown: function (ev) {\r\n        if (ev.which === 83 && (ev.ctrlKey || ev.metaKey)) { // CTRL-S\r\n            ev.preventDefault();\r\n            db.saveNow().then(function () {\r\n                /*// When saved, exit edit mode so that one can view the result as users see it.\r\n                if (location.hash.endsWith('/edit')) {\r\n                  location.hash = location.hash.substr(0, location.hash.length - '/edit'.length);\r\n                }*/\r\n            });\r\n        }\r\n    } },\r\n    React.createElement(Router, null,\r\n        React.createElement(React.Fragment, null,\r\n            React.createElement(Route, { path: \"/\", exact: true, render: function () { return React.createElement(Redirect, { to: \"/courses\" }); } }),\r\n            React.createElement(Route, { path: \"/courses\", exact: true, render: function () { return React.createElement(React.Fragment, null,\r\n                    React.createElement(Banner, { title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kurser\"], [\"Kurser\"]))), tabs: [], activeTab: \"$\" }),\r\n                    React.createElement(TwoColumnsPage, { left: React.createElement(ListCourses, { showInactive: true }), right: React.createElement(WeekPlanner, { env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL }), rightWidth: 5 })); } }),\r\n            React.createElement(Route, { path: \"/courses/:courseIdOrName\", exact: false, render: function (_a) {\r\n                    var match = _a.match;\r\n                    return React.createElement(GetMySchoolAndResolveCourseId, { courseIdOrName: match.params.courseIdOrName, render: function (school, courseId) {\r\n                            return React.createElement(Redirect, { to: \"/\" + school.name + \"/courses/\" + courseId });\r\n                        } });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId?\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/settings/:draftId\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, draftId = _b.draftId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: \"$settings\", draftId: draftId });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId/drafts/:draftId\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId, draftId = _b.draftId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId, draftId: draftId });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId/drafts/:draftId/edit\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId, draftId = _b.draftId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId, draftId: draftId, editMode: true });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId/tasks/:taskId\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId, taskId = _b.taskId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId, taskId: taskId, editMode: false });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId/contents/:contentId/tasks/:taskId/drafts/:draftId\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId, taskId = _b.taskId, draftId = _b.draftId, contentId = _b.contentId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId, taskId: taskId, contentId: contentId, draftId: draftId, editMode: false });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/tabs/:tabId/contents/:contentId/tasks/:taskId/drafts/:draftId/edit\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, tabId = _b.tabId, contentId = _b.contentId, taskId = _b.taskId, draftId = _b.draftId;\r\n                    return React.createElement(CourseViewerPage, { school: school, courseId: courseId, activeTab: tabId, contentId: contentId, taskId: taskId, draftId: draftId, editMode: true });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/blocks/:blockId/steps/:stepNo\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, blockId = _b.blockId, stepNo = _b.stepNo;\r\n                    return React.createElement(RedirectToStep, { school: school, courseId: courseId, blockId: blockId, stepNo: stepNo });\r\n                } }),\r\n            React.createElement(Route, { exact: true, path: \"/:school/courses/:courseId/history\", render: function (_a) {\r\n                    var match = _a.match;\r\n                    var _b = match.params, school = _b.school, courseId = _b.courseId, blockId = _b.blockId, stepNo = _b.stepNo;\r\n                    return React.createElement(VersionHistoryPage, { school: school, courseId: courseId });\r\n                } }),\r\n            React.createElement(ErrorSuccessFeedback, null),\r\n            React.createElement(LoadingIndicator, null)))); });\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { liveQueryView } from '../../../utility-components/live-query-view';\r\nimport { listCourseInstances } from '../../logic/list-course-instances';\r\nimport { L } from '../../../../utils/utils';\r\nimport { StudentCoursesBox } from './student-courses-box';\r\nexport var ListCourses = liveQueryView(function (_a) {\r\n    var showInactive = _a.showInactive;\r\n    return (showInactive ?\r\n        listCourseInstances() :\r\n        listCourseInstances().tags(\"active\")).orderBy(\"name\")\r\n        .map(function (_a) {\r\n        var id = _a.id, name = _a.name, type = _a.type, description = _a.description, tags = _a.tags;\r\n        return ({\r\n            id: id,\r\n            name: name,\r\n            type: type,\r\n            tags: tags,\r\n            description: description,\r\n            url: \"/courses/\" + id\r\n        });\r\n    })\r\n        .groupBy(\"type\")\r\n        .map(function (arraysByType) { return ({\r\n        themeCourses: arraysByType[\"theme-course\"],\r\n        stepCourses: arraysByType[\"step-course\"]\r\n    }); })\r\n        .map(function (_a) {\r\n        var themeCourses = _a.themeCourses, stepCourses = _a.stepCourses;\r\n        return React.createElement(React.Fragment, null,\r\n            themeCourses && React.createElement(StudentCoursesBox, { title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Temakurser\"], [\"Temakurser\"]))), courses: themeCourses }),\r\n            stepCourses && React.createElement(StudentCoursesBox, { title: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Stegkurser\"], [\"Stegkurser\"]))), courses: stepCourses }));\r\n    });\r\n});\r\nvar templateObject_1, templateObject_2;\r\n","import React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nimport { AlignHorizontal } from '../../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../../utility-components/horizontal-item';\r\nexport var StudentCoursesBox = function (_a) {\r\n    var title = _a.title, courses = _a.courses;\r\n    return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        React.createElement(\"h3\", null, title),\r\n        React.createElement(\"div\", { className: \"taskContainer odd-even\" }, courses.map(function (_a) {\r\n            var id = _a.id, name = _a.name, description = _a.description, tags = _a.tags;\r\n            return React.createElement(AlignHorizontal, null,\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"div\", { className: \"studentCourse\" },\r\n                        React.createElement(Link, { to: \"/courses/\" + id }, name),\r\n                        React.createElement(\"p\", { className: \"small\" }, description))),\r\n                tags.includes(\"active\") ? undefined : React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"div\", { className: \"pill incomplete\" }, \"Inaktiv\")));\r\n        })));\r\n};\r\n","import React from 'react';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { db } from '../../../globals/db';\r\nimport { compareProp } from '../../../utils/utils';\r\nimport { Redirect } from 'react-router-dom';\r\nexport var RedirectToStep = function (_a) {\r\n    var school = _a.school, courseId = _a.courseId, blockId = _a.blockId, stepNo = _a.stepNo;\r\n    return React.createElement(LazyContent, null, db.optimizeCache().schools.name(school).single()\r\n        .map(function (school) { return db.branch(school.officialBranchId); })\r\n        .switchMap(function (branchRepo) {\r\n        return branchRepo.courseBlocks.include(\"tabs\").id(blockId)\r\n            .map(function (block) {\r\n            var firstTab = block.tabs.filter(function (tab) { return '' + tab.stepNo === '' + stepNo; }).sort(compareProp(\"order\"))[0];\r\n            if (firstTab)\r\n                return React.createElement(Redirect, { to: \"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + firstTab.id });\r\n            return React.createElement(Redirect, { to: \"/\" + school + \"/courses/\" + courseId });\r\n        });\r\n    }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useContext } from \"react\";\r\nimport { L, flatten, compareProps } from \"../../../utils/utils\";\r\nimport { DialogsContext } from \"../common/dialog-context\";\r\nimport { EditResource } from \"../../course-builder/modal-pages/edit-resource\";\r\nimport { createUUID } from 'kedbackend/client';\r\nexport var ResourceEditor = function (_a) {\r\n    var contents = _a.contents, schoolName = _a.schoolName, courseId = _a.courseId, tabId = _a.tabId, repo = _a.repo;\r\n    var resources = flatten(contents\r\n        .filter(function (content) { return content.type === \"resource-list\"; })\r\n        .map(function (resourceListContent) { return resourceListContent; })\r\n        .map(function (resourceListContent) {\r\n        var resources = resourceListContent.resources;\r\n        return resources.map(function (resource, idx) { return ({\r\n            resource: resource,\r\n            idx: idx,\r\n            resourceListContent: resourceListContent,\r\n            name: resource.name // The name (put here to be able to sort on it more easily)\r\n        }); });\r\n    })).sort(compareProps(\"name\"));\r\n    var context = useContext(DialogsContext);\r\n    return (React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Resurser\"], [\"Resurser\"])))),\r\n        React.createElement(\"div\", { className: \"taskContainer\" }, resources.map(function (_a) {\r\n            var resource = _a.resource, idx = _a.idx, resourceListContent = _a.resourceListContent;\r\n            return (React.createElement(\"div\", { className: \"align-horizontal\", key: resourceListContent.id + idx },\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"a\", { className: \"editItem\", onClick: function () {\r\n                            return context.openDialog(React.createElement(EditResource, { title: \"Edit resource\", resource: resource, onSave: function (editedResource) {\r\n                                    //resources[idx] = res;\r\n                                    var newResourcesProp = tslib_1.__spread(resourceListContent.resources);\r\n                                    // idx is normally 0, but can be >0 due to how this used to work before this change.\r\n                                    newResourcesProp[idx] = editedResource;\r\n                                    repo.courseContents.update(resourceListContent, {\r\n                                        resources: newResourcesProp\r\n                                    });\r\n                                    context.closeDialog();\r\n                                }, onDelete: function () {\r\n                                    if (resourceListContent.resources.length === 1) {\r\n                                        // Normal scenario\r\n                                        repo.courseTabs.removeRelated(tabId, \"contents\", resourceListContent);\r\n                                    }\r\n                                    else {\r\n                                        // Backward compat scenario\r\n                                        repo.courseContents.update(resourceListContent, {\r\n                                            resources: resourceListContent.resources.filter(function (r, _idx) { return _idx === idx; })\r\n                                        });\r\n                                    }\r\n                                    context.closeDialog();\r\n                                } }));\r\n                        } }),\r\n                    \"\\u00A0\"),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                            React.createElement(\"a\", { target: \"_blank\", href: resource.url }, resource.name))))));\r\n        })),\r\n        React.createElement(\"a\", { className: \"btn\", onClick: function () {\r\n                return context.openDialog(React.createElement(EditResource, { title: \"Resurs\", onSave: function (resourceToAdd) {\r\n                        repo.courseTabs.addRelated(tabId, \"contents\", {\r\n                            type: \"resource-list\",\r\n                            id: createUUID(),\r\n                            resources: [resourceToAdd],\r\n                            order: Date.now(),\r\n                            locked: false,\r\n                            lockDelete: false,\r\n                            hidden: false,\r\n                            tags: [courseId],\r\n                            acl: [\"role:USER:R\", \"schoolRole:\" + schoolName + \"/EMPLOYEE:S\"],\r\n                        });\r\n                        context.closeDialog();\r\n                    } }));\r\n            } },\r\n            React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }), L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till resurs\"], [\"L\\u00E4gg till resurs\"]))))));\r\n};\r\nvar templateObject_1, templateObject_2;\r\n","var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nimport { L } from '../../../utils/utils';\r\nimport { flatten } from '../../../utils/utils';\r\nimport { getSchoolYears, computeCourseInstanceTags } from '../logic/course-instance-tags';\r\nimport { TabRequirements } from './tab-settings-requirements';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nexport var TabSettingsAdmin = function (_a) {\r\n    var tab = _a.tab, repo = _a.repo, course = _a.course, block = _a.block;\r\n    var _b = tab.subject ?\r\n        tab.subject :\r\n        course.type === 'theme-course' && course.subjects && course.subjects.length > 0 ?\r\n            { subjectCode: course.subjects[0].code, subjectName: course.subjects[0].name } :\r\n            course.type === 'step-course' ?\r\n                { subjectCode: course.subject.subjectCode, subjectName: course.subject.subjectName } :\r\n                { subjectCode: '', subjectName: '' }, subjectCode = _b.subjectCode, subjectName = _b.subjectName;\r\n    var courseSchoolYears = getSchoolYears(course.tags);\r\n    var schoolYear = getSchoolYears(tab.tags)[0] || courseSchoolYears[0] || null;\r\n    return (\r\n    //\r\n    // Edit \"standard\" school: Choose tab type\r\n    //\r\n    React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        React.createElement(\"p\", { className: \"box-mini-label\" }, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Administrativa Inst\\u00E4llningar f\\u00F6r fliken \", \"\"], [\"Administrativa Inst\\u00E4llningar f\\u00F6r fliken \", \"\"])), tab.name || tab.tabTitle)),\r\n        React.createElement(AlignHorizontal, null,\r\n            React.createElement(HorizontalItem, null,\r\n                React.createElement(\"input\", { type: \"checkbox\", checked: tab.locked, onChange: function (ev) { return repo.courseTabs.update(tab, { locked: !!ev.target.checked }); } })),\r\n            React.createElement(HorizontalItem, null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E5s fliken fr\\u00E5n redigering f\\u00F6rutom d\\u00E4r det explicit till\\u00E5ts\"], [\"L\\u00E5s fliken fr\\u00E5n redigering f\\u00F6rutom d\\u00E4r det explicit till\\u00E5ts\"]))))),\r\n        course.type === 'step-course' && React.createElement(React.Fragment, null,\r\n            React.createElement(\"br\", null),\r\n            React.createElement(OpenCloseBox, { title: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Avancerat...\"], [\"Avancerat...\"]))) },\r\n                React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                        var schoolYear;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    schoolYear = getSchoolYears(block.tags)[0];\r\n                                    return [4 /*yield*/, updateSubjectAndSchoolYears(course, course.subject.subjectName, course.subject.subjectCode, schoolYear)];\r\n                                case 1:\r\n                                    _a.sent();\r\n                                    return [2 /*return*/];\r\n                            }\r\n                        });\r\n                    }); } }, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"G\\u00F6r om kopplingen till \\u00E4mne och \\u00E5rskursspann\"], [\"G\\u00F6r om kopplingen till \\u00E4mne och \\u00E5rskursspann\"])))))),\r\n        course.type === 'theme-course' && tab.tabClass === 'subject-tab' && !!subjectCode && React.createElement(React.Fragment, null,\r\n            React.createElement(\"br\", null),\r\n            course.subjects.length > 1 && React.createElement(AlignHorizontal, null,\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"]))))),\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"select\", { value: subjectCode, onChange: function (ev) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var subjectCode, subjectName;\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0:\r\n                                        subjectCode = ev.target.value;\r\n                                        subjectName = course.subjects\r\n                                            .filter(function (s) { return s.code === subjectCode; })\r\n                                            .map(function (s) { return s.name; })[0] || subjectCode;\r\n                                        return [4 /*yield*/, updateSubjectAndSchoolYears(course, subjectName, subjectCode, schoolYear)];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); } }, course.subjects.map(function (_a) {\r\n                        var name = _a.name, code = _a.code;\r\n                        return React.createElement(\"option\", { key: code, value: code }, name);\r\n                    })))),\r\n            courseSchoolYears.length > 1 && React.createElement(React.Fragment, null,\r\n                React.createElement(AlignHorizontal, null,\r\n                    React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"V\\u00E4lj \\u00E5rskurs\"], [\"V\\u00E4lj \\u00E5rskurs\"]))))),\r\n                    React.createElement(HorizontalItem, null,\r\n                        React.createElement(\"select\", { value: schoolYear, onChange: function (ev) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                                var schoolYear, subjectName;\r\n                                return tslib_1.__generator(this, function (_a) {\r\n                                    switch (_a.label) {\r\n                                        case 0:\r\n                                            schoolYear = ev.target.value;\r\n                                            subjectName = course.subjects\r\n                                                .filter(function (s) { return s.code === subjectCode; })\r\n                                                .map(function (s) { return s.name; })[0] || subjectCode;\r\n                                            return [4 /*yield*/, updateSubjectAndSchoolYears(course, subjectName, subjectCode, schoolYear)];\r\n                                        case 1:\r\n                                            _a.sent();\r\n                                            return [2 /*return*/];\r\n                                    }\r\n                                });\r\n                            }); } }, courseSchoolYears.map(function (year) { return React.createElement(\"option\", { key: year, value: year }, L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"\\u00C5rskurs \", \"\"], [\"\\u00C5rskurs \", \"\"])), year)); })))),\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(TabRequirements, { repo: repo, tab: tab })),\r\n                React.createElement(\"br\", null),\r\n                React.createElement(OpenCloseBox, { title: L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"Avancerat...\"], [\"Avancerat...\"]))) },\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0: return [4 /*yield*/, updateSubjectAndSchoolYears(course, subjectName, subjectCode, schoolYear)];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); } }, L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"G\\u00F6r om kopplingen till \\u00E4mne och \\u00E5rskursspann\"], [\"G\\u00F6r om kopplingen till \\u00E4mne och \\u00E5rskursspann\"])))))))));\r\n    function updateSubjectAndSchoolYears(course, subjectName, subjectCode, schoolYear) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var tabTags, lgContents, tasks, tasks_1, tasks_1_1, task, tags;\r\n            var e_1, _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        tabTags = computeCourseInstanceTags(tab.tags, [subjectCode], [schoolYear]);\r\n                        repo.courseTabs.update(tab, {\r\n                            subject: {\r\n                                subjectCode: subjectCode,\r\n                                subjectName: subjectName\r\n                            },\r\n                            tags: tabTags\r\n                        });\r\n                        return [4 /*yield*/, repo.courseContents\r\n                                .hasEdgesFrom([tab.id])\r\n                                .include(\"tasks\")\r\n                                .includeIdsAndNamesOnly()\r\n                                .toValue().load()];\r\n                    case 1:\r\n                        lgContents = _b.sent();\r\n                        tasks = flatten(lgContents.map(function (c) { return c.tasks; }));\r\n                        try {\r\n                            for (tasks_1 = tslib_1.__values(tasks), tasks_1_1 = tasks_1.next(); !tasks_1_1.done; tasks_1_1 = tasks_1.next()) {\r\n                                task = tasks_1_1.value;\r\n                                tags = computeCourseInstanceTags([course.id], [subjectCode], [schoolYear]);\r\n                                repo.tasks.update(task, { tags: tags, subject: subjectName });\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (tasks_1_1 && !tasks_1_1.done && (_a = tasks_1.return)) _a.call(tasks_1);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    }\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { KnowledgeMatrix } from '../../course-builder/sub-components/knowledge-matrix';\r\nimport { LazyContent } from '../../utility-components/lazy-content';\r\nimport { getCourseCodesFromTags } from '../logic/get-course-codes-from-tags';\r\nimport { L } from '../../../utils/utils';\r\nimport { getStandardCoursesWithOrderedRequirements } from '../logic/get-standard-courses-with-ordered-requirements';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nimport { SelectRelatedDocs } from '../../course-builder/sub-components/select-related-docs';\r\nexport var TabRequirements = function (_a) {\r\n    var repo = _a.repo, tab = _a.tab;\r\n    return React.createElement(LazyContent, null, getStandardCoursesWithOrderedRequirements(getCourseCodesFromTags(tab.tags))\r\n        .map(function (courseTemplates) { return courseTemplates.length === 0 ?\r\n        React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Fliken \\u00E4r inte kopplad till n\\u00E5got \\u00E4mne / \\u00E5rskurs\"], [\"Fliken \\u00E4r inte kopplad till n\\u00E5got \\u00E4mne / \\u00E5rskurs\"]))))\r\n        :\r\n            React.createElement(\"div\", null, courseTemplates.map(function (_a) {\r\n                var id = _a.id, name = _a.name, abilities = _a.abilities, centralContent = _a.centralContent, knowledgeRequirements = _a.knowledgeRequirements;\r\n                return React.createElement(\"div\", { key: id },\r\n                    courseTemplates.length === 1 ? undefined : React.createElement(\"h1\", null, name),\r\n                    React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E5s flikens kunskapskrav\"], [\"L\\u00E5s flikens kunskapskrav\"])))) },\r\n                        React.createElement(\"p\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Markera de kunskapskrav som \\u00E4mnesfliken ska t\\u00E4cka.\"], [\"Markera de kunskapskrav som \\u00E4mnesfliken ska t\\u00E4cka.\"])))),\r\n                        React.createElement(LazyContent, null, repo[\"knowledge-requirements\"].hasEdgesFrom([tab.id]).idsOnly().toValue().map(function (tabsKrs) {\r\n                            return React.createElement(KnowledgeMatrix, { knowledgeRequirements: knowledgeRequirements, markedIds: tabsKrs.map(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id;\r\n                                }), idsToMarkNotOk: {}, markMode: true, onMarkChanged: function (markedId, isMarked) {\r\n                                    // Remove invalid knowledge requirements (those that are not part of the standard course)\r\n                                    // Can happen after changing school year / course or subject.\r\n                                    var invalidKrs = tabsKrs.filter(function (kr) { return !knowledgeRequirements.some(function (_a) {\r\n                                        var id = _a.id;\r\n                                        return kr.id === id;\r\n                                    }); });\r\n                                    invalidKrs.forEach(function (invalidKr) {\r\n                                        repo.courseTabs.removeRelated(tab.id, \"knowledgeRequirements\", invalidKr);\r\n                                    });\r\n                                    var markedDoc = knowledgeRequirements.filter(function (_a) {\r\n                                        var id = _a.id;\r\n                                        return id === markedId;\r\n                                    })[0];\r\n                                    if (isMarked) {\r\n                                        repo.courseTabs.addRelated(tab.id, \"knowledgeRequirements\", markedDoc);\r\n                                    }\r\n                                    else {\r\n                                        repo.courseTabs.removeRelated(tab.id, \"knowledgeRequirements\", markedDoc);\r\n                                    }\r\n                                } });\r\n                        }))),\r\n                    React.createElement(LazyContent, null, repo.abilities.hasEdgesFrom([tab.id]).idsOnly().toValue().map(function (tabAbilities) {\r\n                        return React.createElement(SelectRelatedDocs, { options: abilities, title: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"L\\u00E5s flikens f\\u00F6rm\\u00E5gor\"], [\"L\\u00E5s flikens f\\u00F6rm\\u00E5gor\"]))), markedIds: tabAbilities.map(function (_a) {\r\n                                var id = _a.id;\r\n                                return id;\r\n                            }), markMode: true, \r\n                            //migratedIds={task && task.migratedTexts && task.migratedTexts.abilities}\r\n                            onMarkChanged: function (markedId, isMarked) {\r\n                                // Remove invalid abilities (those that are not part of the standard course)\r\n                                // Can happen after changing school year / course or subject.\r\n                                var invalidAbilities = tabAbilities.filter(function (a) { return !abilities.some(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return a.id === id;\r\n                                }); });\r\n                                invalidAbilities.forEach(function (invalidAbility) {\r\n                                    repo.courseTabs.removeRelated(tab.id, \"abilities\", invalidAbility);\r\n                                });\r\n                                var markedDoc = abilities.filter(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id === markedId;\r\n                                })[0];\r\n                                if (isMarked) {\r\n                                    repo.courseTabs.addRelated(tab.id, \"abilities\", markedDoc);\r\n                                }\r\n                                else {\r\n                                    repo.courseTabs.removeRelated(tab.id, \"abilities\", markedDoc);\r\n                                }\r\n                            } });\r\n                    })),\r\n                    React.createElement(LazyContent, null, repo[\"central-content\"].hasEdgesFrom([tab.id]).idsOnly().toValue().map(function (tabsCCs) {\r\n                        return React.createElement(SelectRelatedDocs, { options: centralContent, title: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"L\\u00E5s flikens centrala inneh\\u00E5ll\"], [\"L\\u00E5s flikens centrala inneh\\u00E5ll\"]))), markedIds: tabsCCs.map(function (cc) { return cc.id; }), markMode: true, \r\n                            //migratedIds={task && task.migratedTexts && task.migratedTexts.centralContent}\r\n                            onMarkChanged: function (markedId, isMarked) {\r\n                                // Remove invalid central contents (those that are not part of the standard course)\r\n                                // Can happen after changing school year / course or subject.\r\n                                var invalidCentralContents = tabsCCs.filter(function (cc) { return !centralContent.some(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return cc.id === id;\r\n                                }); });\r\n                                invalidCentralContents.forEach(function (invalidCC) {\r\n                                    repo.courseTabs.removeRelated(tab.id, \"centralContent\", invalidCC);\r\n                                });\r\n                                var markedDoc = centralContent.filter(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id === markedId;\r\n                                })[0];\r\n                                if (isMarked) {\r\n                                    repo.courseTabs.addRelated(tab.id, \"centralContent\", markedDoc);\r\n                                }\r\n                                else {\r\n                                    repo.courseTabs.removeRelated(tab.id, \"centralContent\", markedDoc);\r\n                                }\r\n                            } });\r\n                    })));\r\n            })); }));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nimport { CourseTabClasses, TabTypesPerCourseType } from './course-tab/tab-classes';\r\nimport { L } from '../../../utils/utils';\r\nimport { getSchoolYears, computeCourseInstanceTags } from '../logic/course-instance-tags';\r\nimport { TextInput } from '../../utility-components/form-field-text-input';\r\nexport var TabSettings = function (_a) {\r\n    var tab = _a.tab, repo = _a.repo, course = _a.course;\r\n    var _b = tab.subject ?\r\n        tab.subject :\r\n        course.type === 'theme-course' && course.subjects && course.subjects.length > 0 ?\r\n            { subjectCode: course.subjects[0].code, subjectName: course.subjects[0].name } :\r\n            { subjectCode: '', subjectName: '' }, subjectCode = _b.subjectCode, subjectName = _b.subjectName;\r\n    var courseSchoolYears = getSchoolYears(course.tags);\r\n    var schoolYear = getSchoolYears(tab.tags)[0] || courseSchoolYears[0] || null;\r\n    return (\r\n    //\r\n    // Edit \"standard\" school: Choose tab type\r\n    //\r\n    React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        React.createElement(\"p\", { className: \"box-mini-label\" }, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Inst\\u00E4llningar f\\u00F6r fliken \", \"\"], [\"Inst\\u00E4llningar f\\u00F6r fliken \", \"\"])), tab.name || tab.tabTitle)),\r\n        React.createElement(AlignHorizontal, null,\r\n            React.createElement(HorizontalItem, null,\r\n                React.createElement(\"label\", { className: \"kclabel\" }, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Flikens typ\"], [\"Flikens typ\"]))))),\r\n            React.createElement(HorizontalItem, null,\r\n                React.createElement(\"select\", { value: tab.tabClass, onChange: function (ev) {\r\n                        return repo.courseTabs.update(tab, ev.target.value === 'subject-tab' ? {\r\n                            tabClass: ev.target.value,\r\n                            subject: { subjectCode: subjectCode, subjectName: subjectName },\r\n                            tags: computeCourseInstanceTags(tab.tags, [subjectCode], [schoolYear])\r\n                        } : {\r\n                            tabClass: ev.target.value,\r\n                        });\r\n                    } }, TabTypesPerCourseType[course.type].map(function (tabClass) {\r\n                    return React.createElement(\"option\", { key: tabClass, value: tabClass }, CourseTabClasses[tabClass]);\r\n                })))),\r\n        React.createElement(TextInput, { label: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Flikens namn\"], [\"Flikens namn\"]))), id: \"TabSettings:name\", value: tab.name || tab.tabTitle, onChange: function (name) {\r\n                return repo.courseTabs.update(tab, {\r\n                    name: name,\r\n                    tabTitle: name // Deprecated. Todo: remove.\r\n                });\r\n            } })));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useState } from 'react';\r\nimport { KnowledgeMatrix } from '../../../../course-builder/sub-components/knowledge-matrix';\r\nimport { LazyContent } from '../../../../utility-components/lazy-content';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { resolveRequirementOrder } from '../../../logic/ordered-requirements';\r\nimport { SelectRelatedDocs } from '../../../../course-builder/sub-components/select-related-docs';\r\nimport { Checklist } from '../../../../utility-components/checklist';\r\nimport { OpenCloseBox } from '../../../../utility-components/open-close-box';\r\nimport { futureAbilities } from '../../../../../contracts/ked-models';\r\nimport { features } from '../../../../../features';\r\nexport var EditRequirements = function (_a) {\r\n    var repo = _a.repo, task = _a.task, tabIds = _a.tabIds, uncoveredIds = _a.uncoveredIds, blockId = _a.blockId, allCoveredSentences = _a.allCoveredSentences;\r\n    return React.createElement(LazyContent, null, blockId ?\r\n        repo.courseBlocks\r\n            .include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")\r\n            .id(blockId)\r\n            .map(function (block) { return React.createElement(\"div\", null,\r\n            React.createElement(EditRequirementsInner, tslib_1.__assign({}, { repo: repo, task: task, uncoveredIds: uncoveredIds, tabOrBlock: block, allCoveredSentences: allCoveredSentences }))); }) :\r\n        repo.courseTabs\r\n            .include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")\r\n            .ids(tabIds)\r\n            .toValue().map(function (tabs) { return React.createElement(\"div\", null, tabs.length === 1 ?\r\n            React.createElement(EditRequirementsInner, tslib_1.__assign({}, { repo: repo, task: task, uncoveredIds: uncoveredIds, tabOrBlock: tabs[0], allCoveredSentences: allCoveredSentences })) :\r\n            tabs.map(function (tab) { return React.createElement(OpenCloseBox, { key: tab.id, title: React.createElement(\"h4\", null,\r\n                    tab.name || tab.tabTitle,\r\n                    tab.subject && tab.subject.subjectName && tab.subject.subjectName !== (tab.name || tab.tabTitle) ?\r\n                        \" (\" + tab.subject.subjectName + \")\" : '') },\r\n                React.createElement(EditRequirementsInner, tslib_1.__assign({}, { repo: repo, task: task, uncoveredIds: uncoveredIds, tabOrBlock: tab, hasMultipleSubjects: true, allCoveredSentences: allCoveredSentences }))); })); }));\r\n};\r\nexport var EditRequirementsInner = function (_a) {\r\n    var tabOrBlock = _a.tabOrBlock, repo = _a.repo, task = _a.task, uncoveredIds = _a.uncoveredIds, hasMultipleSubjects = _a.hasMultipleSubjects, allCoveredSentences = _a.allCoveredSentences;\r\n    var _b = tslib_1.__read(useState(false), 2), markBySentenceViewActive = _b[0], setActive = _b[1];\r\n    var markPartialKRs = features.markPartialKRs;\r\n    return React.createElement(LazyContent, null, resolveRequirementOrder(tabOrBlock).map(function (tab) {\r\n        var subjectName = 'type' in tab && tab.subject && tab.subject.subjectName;\r\n        return React.createElement(React.Fragment, null,\r\n            task.taskType !== 'exercise' && React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                React.createElement(\"h3\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"V\\u00E4lj kunskapskrav\"], [\"V\\u00E4lj kunskapskrav\"])))),\r\n                React.createElement(\"div\", { className: \"matrix-knowledge-title\" },\r\n                    React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Markera de kunskapskrav som din uppgift t\\u00E4cker.\"], [\"Markera de kunskapskrav som din uppgift t\\u00E4cker.\"])))),\r\n                    markPartialKRs && React.createElement(\"p\", null,\r\n                        React.createElement(\"i\", { className: \"fab fa-creative-commons-nd \" + (markBySentenceViewActive ? \"activePartialView\" : \"\"), onClick: function () { return setActive(!markBySentenceViewActive); } }))),\r\n                React.createElement(KnowledgeMatrix, { knowledgeRequirements: tab.knowledgeRequirements, markedIds: task.knowledgeRequirements.map(function (_a) {\r\n                        var id = _a.id;\r\n                        return id;\r\n                    }), explainedRequirements: task.explainedRequirements || {}, idsToMarkNotOk: uncoveredIds, markMode: true, markBySentenceView: markBySentenceViewActive, migratedIds: task && task.migratedTexts && task.migratedTexts.knowledgeRequirements, partialRequirments: task.partialRequirments || {}, coveredPartialRequirments: allCoveredSentences, markPartialFeatureEnabled: markPartialKRs, onExplainedRequirementsChanged: function (requirementId, text) {\r\n                        var _a;\r\n                        return repo.tasks.update(task, {\r\n                            explainedRequirements: tslib_1.__assign({}, task.explainedRequirements, (_a = {}, _a[requirementId] = text, _a))\r\n                        });\r\n                    }, onUpdatePartialKnowledge: function (requirementId, partialContents) {\r\n                        //it might be the case that the feature flag is active, the requirment is set as marked and no partial data is saved\r\n                        //when unselecting the requirment, we should do nothing as no partial data is saved\r\n                        var _a;\r\n                        // var result = shouldRemove && task.partialRequirments.filter(pr => partialContents.filter(pc => !pr[requirementId].includes(pc)));\r\n                        //var existingRequirements = task.partialRequirments[requirementId] || [];\r\n                        repo.tasks.update(task, {\r\n                            partialRequirments: tslib_1.__assign({}, task.partialRequirments, (_a = {}, _a[requirementId] = tslib_1.__spread(partialContents), _a))\r\n                        });\r\n                        var markedDoc = tab.knowledgeRequirements.filter(function (_a) {\r\n                            var id = _a.id;\r\n                            return id === requirementId;\r\n                        })[0];\r\n                        if (partialContents.length === 0) {\r\n                            repo.tasks.removeRelated(task.id, \"knowledgeRequirements\", markedDoc);\r\n                        }\r\n                        else if (!task.partialRequirments || !task.partialRequirments[requirementId] || task.partialRequirments[requirementId].length === 0) {\r\n                            repo.tasks.addRelated(task.id, \"knowledgeRequirements\", markedDoc);\r\n                        }\r\n                    }, onMarkChanged: function (markedId, isMarked) {\r\n                        var _a, _b;\r\n                        var markedDoc = tab.knowledgeRequirements.filter(function (_a) {\r\n                            var id = _a.id;\r\n                            return id === markedId;\r\n                        })[0];\r\n                        if (isMarked) {\r\n                            if (hasMultipleSubjects) {\r\n                                // Mission tabs needs to store the subject name connected to each knowledge requirement:\r\n                                repo.tasks.update(task, { idsToSubjectMap: tslib_1.__assign({}, task.idsToSubjectMap, (_a = {}, _a[markedId] = subjectName, _a)) });\r\n                            }\r\n                            else {\r\n                                repo.tasks.update(task, { idsToSubjectMap: undefined });\r\n                            }\r\n                            repo.tasks.addRelated(task.id, \"knowledgeRequirements\", markedDoc);\r\n                        }\r\n                        else {\r\n                            if (hasMultipleSubjects) {\r\n                                // Mission tabs needs to delete the subject name connected to each knowledge requirement:\r\n                                repo.tasks.update(task, { idsToSubjectMap: tslib_1.__assign({}, task.idsToSubjectMap, (_b = {}, _b[markedId] = undefined, _b)) });\r\n                            }\r\n                            else {\r\n                                repo.tasks.update(task, { idsToSubjectMap: undefined });\r\n                            }\r\n                            repo.tasks.removeRelated(task.id, \"knowledgeRequirements\", markedDoc);\r\n                        }\r\n                    } })),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(SelectRelatedDocs, { title: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"V\\u00E4lj f\\u00F6rm\\u00E5gor\"], [\"V\\u00E4lj f\\u00F6rm\\u00E5gor\"]))), options: tab.abilities, markedIds: task.abilities.map(function (a) { return a.id; }), markMode: true, migratedIds: task && task.migratedTexts && task.migratedTexts.abilities, onMarkChanged: function (markedId, isMarked) {\r\n                        var markedDoc = tab.abilities.filter(function (a) { return a.id === markedId; })[0];\r\n                        if (isMarked) {\r\n                            repo.tasks.addRelated(task.id, \"abilities\", markedDoc);\r\n                        }\r\n                        else {\r\n                            repo.tasks.removeRelated(task.id, \"abilities\", markedDoc);\r\n                        }\r\n                    } })),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(SelectRelatedDocs, { title: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"V\\u00E4lj centralt inneh\\u00E5ll\"], [\"V\\u00E4lj centralt inneh\\u00E5ll\"]))), options: tab.centralContent, markedIds: task.centralContent.map(function (cc) { return cc.id; }), markMode: true, migratedIds: task && task.migratedTexts && task.migratedTexts.centralContent, onMarkChanged: function (markedId, isMarked) {\r\n                        var markedDoc = tab.centralContent.filter(function (a) { return a.id === markedId; })[0];\r\n                        if (isMarked) {\r\n                            repo.tasks.addRelated(task.id, \"centralContent\", markedDoc);\r\n                        }\r\n                        else {\r\n                            repo.tasks.removeRelated(task.id, \"centralContent\", markedDoc);\r\n                        }\r\n                    } })),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"p\", null, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"V\\u00E4lj framtidsf\\u00F6rm\\u00E5gor\"], [\"V\\u00E4lj framtidsf\\u00F6rm\\u00E5gor\"])))) },\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(Checklist, { available: futureAbilities.map(function (fa) { return ({ name: fa, key: fa }); }), selected: task.futureAbilities, onChange: function (selectedFas) { return repo.tasks.update(task, { futureAbilities: selectedFas }); } }))));\r\n    }));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { TaskMigrationBox } from '../../../../course-builder/modal-pages/edit-task/task-migration-box';\r\nimport ReactDatePicker from 'react-datepicker';\r\nimport moment from 'moment';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { Checklist } from '../../../../utility-components/checklist';\r\nimport { LazyContent } from '../../../../utility-components/lazy-content';\r\nimport { FieldLimits } from '../../../common/field-limits';\r\nexport var BasicEditableTaskFields = function (_a) {\r\n    var task = _a.task, writeAccess = _a.writeAccess, repo = _a.repo, contentId = _a.contentId, tab = _a.tab;\r\n    var tabClass = tab ? tab.tabClass : null; // tab is undefined on step courses. But there are no mission tabs on step courses.\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"p\", null, tabClass === 'mission-tab' ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Uppdragets namn:\"], [\"Uppdragets namn:\"]))) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Uppgiftens namn:\"], [\"Uppgiftens namn:\"]))))),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"input\", { autoFocus: true, type: \"text\", size: 35, value: task.name, disabled: !writeAccess, readOnly: !writeAccess, onChange: function (ev) {\r\n                        repo.tasks.update(task, { name: ev.target.value.substr(0, FieldLimits.MAX_CHARS_TASK_NAMES) });\r\n                    } }))),\r\n        task.migratedTexts && writeAccess && React.createElement(TaskMigrationBox, { task: task, course: null, updateLink: function (id, linkOrUnlink) { throw new Error(\"Not implemented yet\"); } }),\r\n        tabClass !== 'mission-tab' && React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"p\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l:\"], [\"L\\u00E4randem\\u00E5l:\"]))))),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(LazyContent, null, repo.courseContents.id(contentId).map(function (content) {\r\n                    if (content.type !== 'learning-goals')\r\n                        return React.createElement(\"p\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Ej valbart\"], [\"Ej valbart\"]))));\r\n                    var hasCommonLearningGoals = content.hasCommonLearningGoals;\r\n                    var learningGoals = content.commonLearningGoals;\r\n                    var availableGoals = learningGoals.map(function (lg) { return lg.trim(); }).filter(function (lg) { return lg; })\r\n                        .map(function (lg) { return ({\r\n                        name: lg,\r\n                        key: lg\r\n                    }); });\r\n                    return React.createElement(Checklist, { available: availableGoals, selected: task.learningGoal.split('\\n'), onChange: function (goals, goal) {\r\n                            if (hasCommonLearningGoals) {\r\n                                repo.tasks.update(task, { learningGoal: goals.join('\\n') });\r\n                            }\r\n                            else {\r\n                                repo.tasks.update(task, { learningGoal: goal });\r\n                            }\r\n                        } });\r\n                })))),\r\n        React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null, tabClass === 'mission-tab' ? L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Uppdragstyp\"], [\"Uppdragstyp\"]))) : L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Uppgiftstyp\"], [\"Uppgiftstyp\"])))),\r\n            React.createElement(Checklist, { available: [\r\n                    tabClass !== 'mission-tab' && { name: L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"\\u00D6vningsuppgift\"], [\"\\u00D6vningsuppgift\"]))), key: 'exercise' },\r\n                    { name: L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"Uppgift\"], [\"Uppgift\"]))), key: \"task\" },\r\n                    { name: L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"Inl\\u00E4mningsuppgift\"], [\"Inl\\u00E4mningsuppgift\"]))), key: 'assignment' },\r\n                ].filter(function (x) { return x; }), selected: [task.taskType], onChange: function (_, clickedKey) { return repo.tasks.update(task, { taskType: clickedKey }); } }),\r\n            task.taskType === 'assignment' && React.createElement(React.Fragment, null,\r\n                React.createElement(\"p\", null, \"Inl\\u00E4mningsdatum\"),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(ReactDatePicker, { nextMonthButtonLabel: \"\", showWeekNumbers: true, previousMonthButtonLabel: \"\", selected: task.deadline && moment(task.deadline).toDate(), dateFormat: \"yyyy-MM-dd\", locale: \"sv\", popperPlacement: \"bottom-start\", onChange: function (value) {\r\n                                repo.tasks.update(task, { deadline: moment(value).format(\"YYYY-MM-DD\") });\r\n                            } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, task.deadline && React.createElement(\"a\", { className: \"deleteDate\", href: \"#\", title: \"Ta bort inl\\u00E4mningsdatum\", onClick: function (ev) {\r\n                            ev.preventDefault();\r\n                            repo.tasks.update(task, { deadline: null });\r\n                        } }))),\r\n                React.createElement(\"div\", { className: \"taskContainer\" },\r\n                    React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\", onClick: function () {\r\n                                return repo.tasks.update(task, { sendToUrkund: task.sendToUrkund == null ? false : !task.sendToUrkund });\r\n                            } },\r\n                            React.createElement(\"div\", { className: \"checkBox\" + ((task.sendToUrkund == null ? true : task.sendToUrkund) ? \" checked\" : \"\") })),\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Verify assignments with Urkund\"))))));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9;\r\n","import React from 'react';\r\nimport { BasicEditableTaskFields } from './basic-editable-task-fields';\r\nimport { TaskFooterButtons } from './task-footer-buttons';\r\nimport { IntroductionTextEditor } from './introduction-text-editor';\r\nimport { TaskDescriptionEditor } from './task-description-editor';\r\nimport { TaskWorkingProcedureEditor } from './task-working-procedure-editor';\r\nimport { TaskEmbeddedHTMLEditor } from './task-embedded-html-editor';\r\nexport var EditTaskForm = function (_a) {\r\n    var repo = _a.repo, course = _a.course, draftId = _a.draftId, tabId = _a.tabId, tab = _a.tab, contentId = _a.contentId, writeAccess = _a.writeAccess, task = _a.task, school = _a.school;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(BasicEditableTaskFields, { repo: repo, task: task, writeAccess: writeAccess, contentId: contentId, tab: tab }),\r\n        React.createElement(IntroductionTextEditor, { repo: repo, task: task, writeAccess: writeAccess }),\r\n        React.createElement(TaskDescriptionEditor, { writeAccess: writeAccess, task: task, repo: repo }),\r\n        React.createElement(TaskWorkingProcedureEditor, { writeAccess: writeAccess, task: task, repo: repo, step: tab && tab.type === 'step-course-tab' && tab.stepNo }),\r\n        React.createElement(TaskEmbeddedHTMLEditor, { writeAccess: writeAccess, task: task, repo: repo }),\r\n        React.createElement(TaskFooterButtons, { repo: repo, task: task, courseId: course.id, draftId: draftId, tabId: tabId, contentId: contentId, school: school }));\r\n};\r\n/*\r\n\r\n  * Inte kunna ndra ordning p lsta rutor om inte isKedStaff().\r\n  * Ingen lgg till uppgifts-knapp om inte editMode.\r\n  *\r\n  * Redigera uppgiftsinnehll\r\n  * Ls lrandemlen till admin alltid\r\n  * Kunna klicka in sig p uppgiften\r\n  * Kunna ta bort uppgift\r\n  * Kunna nollstlla ndringar fr skolan\r\n\r\n*/ \r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { Wysiwyg } from '../../../../utility-components/wysiwyg';\r\nimport actions_swedish from '../../../../utility-components/wysiwyg/actions-sv';\r\nexport var IntroductionTextEditor = function (_a) {\r\n    var repo = _a.repo, task = _a.task, writeAccess = _a.writeAccess;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Introtext\"], [\"Introtext\"])))),\r\n        React.createElement(\"p\", { className: \"subHeader\" }, \"(Skriv en introduktion till uppgiften)\"),\r\n        React.createElement(Wysiwyg, { actions: [\r\n                \"bold\",\r\n                \"italic\",\r\n                \"underline\",\r\n                \"link\",\r\n                \"image\"\r\n            ], defaultActions: actions_swedish, readOnly: !writeAccess, html: task.content || \"\", onChange: function (html) { return repo.tasks.update(task, { content: html }); } }));\r\n};\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Wysiwyg } from '../../../../utility-components/wysiwyg';\r\nimport actions_swedish from '../../../../utility-components/wysiwyg/actions-sv';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { taskTypeHeadings } from '../texts';\r\nimport { FieldLimits } from '../../../common/field-limits';\r\nimport { useState } from 'react';\r\nexport function TaskDescriptionEditor(_a) {\r\n    var writeAccess = _a.writeAccess, task = _a.task, repo = _a.repo;\r\n    var _b = tslib_1.__read(useState(0), 2), numChars = _b[0], setNumChars = _b[1];\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"h4\", null, taskTypeHeadings[task.taskType] || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Uppgift\"], [\"Uppgift\"])))),\r\n        React.createElement(\"p\", { className: \"subHeader\" }, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"(Skriv in en kort f\\u00F6rklaring, max \", \" tecken, vad uppgiften g\\u00E5r ut p\\u00E5.)\"], [\"(Skriv in en kort f\\u00F6rklaring, max \", \" tecken, vad uppgiften g\\u00E5r ut p\\u00E5.)\"])), FieldLimits.MAX_CHARS_TASK_INTRO_TEXT)),\r\n        React.createElement(Wysiwyg, { actions: [\r\n                \"bold\",\r\n            ], defaultActions: actions_swedish, readOnly: !writeAccess, html: task.description || \"\", maxChars: FieldLimits.MAX_CHARS_TASK_INTRO_TEXT, reportNumChars: function (numChars) { return setNumChars(numChars); }, onChange: function (html) {\r\n                repo.tasks.update(task, { description: html });\r\n            } }),\r\n        React.createElement(\"div\", { style: { textAlign: 'right', opacity: 0.7, fontSize: '8pt' } }, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\", \" av \", \"\"], [\"\", \" av \", \"\"])), numChars, FieldLimits.MAX_CHARS_TASK_INTRO_TEXT)));\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { isKedStaff } from '../../../logic/is-ked-staff';\r\nimport { L } from '../../../../../utils/utils';\r\nexport var TaskEmbeddedHTMLEditor = function (_a) {\r\n    var task = _a.task, repo = _a.repo;\r\n    return isKedStaff() ? task.embeddedHtml ? React.createElement(\"div\", null,\r\n        React.createElement(\"h4\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Inb\\u00E4ddat material\"], [\"Inb\\u00E4ddat material\"])))),\r\n        React.createElement(\"p\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Klipp in HTML kod nedan\"], [\"Klipp in HTML kod nedan\"])))),\r\n        React.createElement(\"textarea\", { style: { width: \"100%\", height: \"100px\" }, value: task.embeddedHtml, onChange: function (ev) { return repo.tasks.update(task, { embeddedHtml: ev.target.value }); } })) :\r\n        React.createElement(\"div\", null,\r\n            React.createElement(\"button\", { className: \"btn\", onClick: function () { return repo.tasks.update(task, { embeddedHtml: \" \" }); } },\r\n                React.createElement(\"i\", { className: \"fa fa-code\", \"aria-hidden\": true }),\r\n                \"\\u00A0\", L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till inb\\u00E4ddat material\"], [\"L\\u00E4gg till inb\\u00E4ddat material\"])))),\r\n            React.createElement(\"br\", null),\r\n            React.createElement(\"br\", null)) :\r\n        React.createElement(\"div\", null);\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { withRouter } from 'react-router';\r\nimport { db } from '../../../../../globals/db';\r\nimport { HorizontalItem } from '../../../../utility-components/horizontal-item';\r\nimport { AlignHorizontal } from '../../../../utility-components/align-horizontal';\r\nexport var TaskFooterButtons = withRouter(function (_a) {\r\n    var school = _a.school, courseId = _a.courseId, tabId = _a.tabId, contentId = _a.contentId, draftId = _a.draftId, task = _a.task, repo = _a.repo, history = _a.history;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"btn btn-warning pull-right\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                    return tslib_1.__generator(this, function (_a) {\r\n                        switch (_a.label) {\r\n                            case 0:\r\n                                repo.courseContents.removeRelated(contentId, \"tasks\", task);\r\n                                return [4 /*yield*/, db.saveNow()];\r\n                            case 1:\r\n                                _a.sent();\r\n                                history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + tabId + \"/drafts/\" + draftId + \"/edit\");\r\n                                return [2 /*return*/];\r\n                        }\r\n                    });\r\n                }); } },\r\n                React.createElement(\"i\", { className: \"fa fa-trash\", \"aria-hidden\": true }),\r\n                \"\\u00A0\", L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Ta bort uppgiften\"], [\"Ta bort uppgiften\"])))),\r\n            React.createElement(AlignHorizontal, null,\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0: return [4 /*yield*/, repo.saveNow()];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || '$') + \"/contents/\" + contentId + \"/tasks/\" + task.id + \"/drafts/\" + draftId);\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-eye\", \"aria-hidden\": true }),\r\n                        \"\\u00A0\", L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"F\\u00F6rhandsgranska\"], [\"F\\u00F6rhandsgranska\"]))))),\r\n                React.createElement(HorizontalItem, null,\r\n                    React.createElement(\"button\", { className: \"btn\", onClick: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + (tabId || '$') + \"/drafts/\" + draftId + \"/edit\");\r\n                                return [2 /*return*/];\r\n                            });\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-left\", \"aria-hidden\": true }),\r\n                        \"\\u00A0\", L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\\u00C5terg\\u00E5 till fliken\"], [\"\\u00C5terg\\u00E5 till fliken\"]))))))),\r\n        React.createElement(\"br\", null));\r\n});\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { useContext } from 'react';\r\nimport { Wysiwyg } from '../../../../utility-components/wysiwyg';\r\nimport actions_swedish from '../../../../utility-components/wysiwyg/actions-sv';\r\nimport { L, showError } from '../../../../../utils/utils';\r\nimport { DialogsContext } from '../../../common/dialog-context';\r\nimport { isKedStaff } from '../../../logic/is-ked-staff';\r\nimport { SelectWordBank } from '../../../common/select-word-bank';\r\nimport { saveSelection, restoreSelection } from '../../../../utility-components/wysiwyg/restore-selection';\r\nimport { cfg } from '../../../../../globals/KED.cfg';\r\nexport function TaskWorkingProcedureEditor(_a) {\r\n    var writeAccess = _a.writeAccess, task = _a.task, repo = _a.repo, step = _a.step;\r\n    var dialogCtx = useContext(DialogsContext);\r\n    var actions = [\r\n        \"bold\",\r\n        \"italic\",\r\n        \"underline\",\r\n        \"olist\",\r\n        \"outdent\",\r\n        \"indent\",\r\n        \"link\",\r\n        \"image\"\r\n    ];\r\n    if (writeAccess) {\r\n        if (step) {\r\n            // This task is put on a step. We could link to a word bank:\r\n            actions.push({\r\n                name: \"listWordBank\",\r\n                icon: '<i class=\"fa fa-book\" aria-hidden=\"true\"></i>',\r\n                title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4nka till ordbank\"], [\"L\\u00E4nka till ordbank\"]))),\r\n                result: function (ev, wysiwyg) {\r\n                    var selection = saveSelection();\r\n                    dialogCtx.openDialog(React.createElement(SelectWordBank, { subject: task.subject, step: step, onSelect: function (_a) {\r\n                            var name = _a.name, url = _a.url;\r\n                            dialogCtx.closeDialog();\r\n                            restoreSelection(selection);\r\n                            var elem = document.createElement('a');\r\n                            elem.href = url;\r\n                            elem.target = \"_blank\";\r\n                            elem.appendChild(document.createTextNode(name));\r\n                            document.execCommand('insertHTML', false, elem.outerHTML);\r\n                        } }));\r\n                }\r\n            });\r\n        }\r\n        if (isKedStaff()) {\r\n            actions.push({\r\n                icon: '<i class=\"fa fa-link\" style=\"color:var(--col-accent)\" aria-hidden=\"true\"></i>',\r\n                title: 'Resurs lnk',\r\n                result: function () {\r\n                    var url = window.prompt('Ange lnkens URL fr resursen');\r\n                    if (url) {\r\n                        //check that the entered URL is the same with the current one\r\n                        var urlObj = new URL('', url);\r\n                        if (urlObj.host !== window.location.host) {\r\n                            showError(\"Ogiltig resursadress\");\r\n                            return;\r\n                        }\r\n                        //match the resourceId\r\n                        var regex = new RegExp(\"([^\\.|/]+).([^\\.]+)(?=\\.html)\");\r\n                        var urlResults = regex.exec(urlObj.pathname);\r\n                        if (!cfg.KED_RESOURCES_URL) {\r\n                            showError(\"Resurser URL r inte konfigurerad\");\r\n                            return;\r\n                        }\r\n                        //replace cfg value with the one from the provided url\r\n                        var valueFromConfig = cfg.KED_RESOURCES_URL.replace(\"{value}\", urlResults[0]);\r\n                        var elem = document.createElement('a');\r\n                        var seletectedText = window.getSelection().toString();\r\n                        elem.href = urlObj.host + valueFromConfig;\r\n                        elem.target = \"_blank\";\r\n                        elem.appendChild(document.createTextNode(seletectedText));\r\n                        valueFromConfig && seletectedText && document.execCommand('insertHTML', false, elem.outerHTML);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"h4\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Arbetsprocess\"], [\"Arbetsprocess\"])))),\r\n        React.createElement(Wysiwyg, { actions: actions, defaultActions: actions_swedish, readOnly: !writeAccess, html: task.workingProcedure || \"\", onChange: function (html) {\r\n                repo.tasks.update(task, { workingProcedure: html });\r\n            } }));\r\n}\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { liveQueryView } from '../../../utility-components/live-query-view';\r\nimport { TwoColumnsPage } from '../../common/two-columns-page';\r\nimport { EditTaskForm } from './right-column/edit-task-form';\r\nimport { resolveRequirementOrder } from '../../logic/ordered-requirements';\r\nimport { EditRequirements } from './left-column/edit-requirements';\r\nimport { isEmployee } from '../../logic/is-employee';\r\nimport { getIdsNotCoveredByReqReferencingDocs } from '../../../course-builder/courses/business-logic';\r\nimport { flatten } from '../../../../utils/utils';\r\nexport var TaskEditor = liveQueryView(function (_a) {\r\n    var school = _a.school, course = _a.course, activeTab = _a.activeTab, draftId = _a.draftId, branch = _a.branch, contentId = _a.contentId, taskId = _a.taskId, blockId = _a.blockId;\r\n    var themeCourseTab = course.tabs.find(function (t) { return t.id === activeTab; });\r\n    var involvedTabIds = (themeCourseTab && themeCourseTab.tabClass === 'mission-tab') ?\r\n        course.tabs.filter(function (tab) { return tab.tabClass === 'subject-tab'; }).map(function (tab) { return tab.id; }) :\r\n        [activeTab];\r\n    return branch.tasks\r\n        .include(\"abilities\", \"centralContent\", \"knowledgeRequirements\").includeIdsOnly()\r\n        //.debug()\r\n        .hasEdgesFrom([contentId])\r\n        .toValue()\r\n        .combineLatest(branch.courseTabs\r\n        .include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")\r\n        .includeIdsOnly()\r\n        .ids(involvedTabIds))\r\n        .switchMap(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), tasks = _b[0], involvedTabs = _b[1];\r\n        var task = tasks.filter(function (t) { return t.id === taskId; })[0];\r\n        var uncoveredIds = getIdsNotCoveredByReqReferencingDocs(involvedTabs, tasks);\r\n        //compute uncovered sentences\r\n        var allCoveredSentences = tasks && flatten(tasks.filter(function (req) { return req.partialRequirments != null; }).map(function (_a) {\r\n            var partialRequirments = _a.partialRequirments;\r\n            return partialRequirments;\r\n        }));\r\n        return resolveRequirementOrder(task).map(function (task) {\r\n            return React.createElement(TwoColumnsPage, { left: React.createElement(EditRequirements, { repo: branch, task: task, uncoveredIds: uncoveredIds, tabIds: involvedTabIds, blockId: blockId, allCoveredSentences: allCoveredSentences }), right: React.createElement(EditTaskForm, { repo: branch, school: school, course: course, draftId: draftId, tabId: activeTab, tab: involvedTabs.find(function (t) { return t.id === activeTab; }), contentId: contentId, writeAccess: isEmployee(school), task: task }), rightWidth: 6 });\r\n        });\r\n    });\r\n});\r\n","import * as tslib_1 from \"tslib\";\r\nimport { L } from '../../../../utils/utils';\r\nexport var taskTypeHeadings = {\r\n    exercise: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00D6vningsuppgift\"], [\"\\u00D6vningsuppgift\"]))),\r\n    task: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Uppgift\"], [\"Uppgift\"]))),\r\n    assignment: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Inl\\u00E4mningsuppgift\"], [\"Inl\\u00E4mningsuppgift\"])))\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { liveQueryView } from '../../../../utility-components/live-query-view';\r\nimport { TwoColumnsPage } from '../../../common/two-columns-page';\r\nimport { WeekPlanner } from '../../../../weekplanner/weekplanner';\r\nimport { TaskViewer } from './task-viewer';\r\nimport { LazyContent } from '../../../../utility-components/lazy-content';\r\nimport { resolveRequirementOrder } from '../../../logic/ordered-requirements';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { withRouter } from 'react-router';\r\nimport env from '../../../../../globals/KED.env';\r\nimport cfg from '../../../../../globals/KED.cfg';\r\nexport var TaskViewerPage = liveQueryView(function (props) {\r\n    return props.lazyRepo.map(function (repo) { return React.createElement(TaskViewerPageInner, tslib_1.__assign({}, tslib_1.__assign({}, props, { repo: repo }))); });\r\n});\r\nexport var TaskViewerPageInner = withRouter(liveQueryView(function (_a) {\r\n    var school = _a.school, courseId = _a.courseId, activeTab = _a.activeTab, repo = _a.repo, taskId = _a.taskId, draftId = _a.draftId, contentId = _a.contentId, history = _a.history;\r\n    return (repo.tasks\r\n        .include(\"abilities\", \"centralContent\", \"knowledgeRequirements\")\r\n        .id(taskId)\r\n        .map(function (task) { return React.createElement(TwoColumnsPage, { left: React.createElement(LazyContent, null, resolveRequirementOrder(task).map(function (task) { return React.createElement(React.Fragment, null,\r\n            React.createElement(TaskViewer, { school: school, task: task, courseId: courseId, abilities: task.abilities, centralContent: task.centralContent, requirements: task.knowledgeRequirements, futureAbilities: task.futureAbilities }),\r\n            draftId && contentId && React.createElement(React.Fragment, null,\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"button\", { className: \"btn\", onClick: function () { return history.push(\"/\" + school + \"/courses/\" + courseId + \"/tabs/\" + activeTab + \"/contents/\" + contentId + \"/tasks/\" + taskId + \"/drafts/\" + draftId + \"/edit\"); } },\r\n                    React.createElement(\"i\", { className: \"fa fa-lg fa-pencil\" }),\r\n                    \" \", L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Forts\\u00E4tt redigera\"], [\"Forts\\u00E4tt redigera\"])))))); })), right: React.createElement(WeekPlanner, { env: env, viewCourseUrl: cfg.KED_COURSE_VIEWER_URL }), rightWidth: 5 }); }));\r\n}));\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { isEmployee } from '../../../logic/is-employee';\r\nimport moment from 'moment';\r\nimport { TaskAssignments } from '../../../../course-viewer/course-page/task-assignments';\r\nimport { AbilitiesBox } from '../../../../course-viewer/subcomponents/abilities-box';\r\nimport { CentralContentBox } from '../../../../course-viewer/subcomponents/central-content-box';\r\nimport { KnowledgeRequirementsBox } from '../../../../course-viewer/subcomponents/knowledge-requirements-table';\r\nimport { L } from '../../../../../utils/utils';\r\nimport { taskTypeHeadings } from '../texts';\r\nimport { FutureAbilitiesBox } from '../../../common/future-abilities-box';\r\nimport { washHtml } from '../../../../utility-components/wysiwyg/wash-html';\r\nexport var TaskViewer = function (_a) {\r\n    var school = _a.school, task = _a.task, courseId = _a.courseId, abilities = _a.abilities, centralContent = _a.centralContent, requirements = _a.requirements, futureAbilities = _a.futureAbilities;\r\n    var deadlineTooLate = task.deadline && moment(task.deadline).endOf('day') < moment();\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"div\", { className: \"sv-text-portlet sv-use-margins sv-skip-spacer\" },\r\n            React.createElement(\"div\", { className: \"sv-text-portlet-content\" },\r\n                React.createElement(\"h1\", { className: \"h1\" }, task.name))),\r\n        React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" }, task.content && React.createElement(React.Fragment, null,\r\n            React.createElement(\"div\", { dangerouslySetInnerHTML: { __html: washHtml(task.content) } }))),\r\n        task.description && React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n            React.createElement(\"div\", { className: [\"ked_boxed\", \"taskBox\", task.taskType].join(' '), style: { clear: \"both\" } },\r\n                React.createElement(\"h2\", null, taskTypeHeadings[task.taskType] || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Uppgift\"], [\"Uppgift\"])))),\r\n                React.createElement(\"div\", { dangerouslySetInnerHTML: { __html: washHtml(task.description) } }))),\r\n        task.workingProcedure && React.createElement(\"div\", null,\r\n            React.createElement(\"h3\", { className: \"h3\" }, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Arbetsprocess\"], [\"Arbetsprocess\"])))),\r\n            React.createElement(\"div\", { className: \"rich-text-readonly\", dangerouslySetInnerHTML: { __html: washHtml(task.workingProcedure) } })),\r\n        task.embeddedHtml && React.createElement(\"div\", { dangerouslySetInnerHTML: { __html: task.embeddedHtml } }),\r\n        React.createElement(\"br\", null),\r\n        task.taskType === 'assignment' ? React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null, \"Inl\\u00E4mningsuppgift\"),\r\n            isEmployee(school) ?\r\n                React.createElement(\"p\", null, \"H\\u00E4r kan du som l\\u00E4rare se elevernas inl\\u00E4mnade arbeten.\") : isEmployee() ? React.createElement(\"p\", null, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Detta \\u00E4r en inl\\u00E4mningsuppgift med inl\\u00E4mningsdatum \", \"\"], [\"Detta \\u00E4r en inl\\u00E4mningsuppgift med inl\\u00E4mningsdatum \", \"\"])), moment(task.deadline).format('YYYY-MM-DD'))) : React.createElement(React.Fragment, null,\r\n                React.createElement(\"p\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"L\\u00E4mna in ditt arbete som en pdf, doc eller odt fil genom att dra det till f\\u00E4ltet under.\"], [\"L\\u00E4mna in ditt arbete som en pdf, doc eller odt fil genom att dra det till f\\u00E4ltet under.\"])))),\r\n                task.deadline ? React.createElement(\"p\", null,\r\n                    React.createElement(\"b\", null,\r\n                        \"Den h\\u00E4r uppgiften \",\r\n                        deadlineTooLate ? 'skulle varit inlmnad ' : 'skall vara inlmnad ',\r\n                        moment(task.deadline).format('YYYY-MM-DD'))) : undefined),\r\n            React.createElement(TaskAssignments, { courseId: courseId, taskId: task.id, school: school, sendToUrkund: task.sendToUrkund }),\r\n            React.createElement(\"br\", null)) : undefined,\r\n        futureAbilities.length > 0 ? React.createElement(FutureAbilitiesBox, { title: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"I den h\\u00E4r uppgiften behandlas f\\u00F6ljande framtidsf\\u00F6rm\\u00E5gor\"], [\"I den h\\u00E4r uppgiften behandlas f\\u00F6ljande framtidsf\\u00F6rm\\u00E5gor\"]))), selectedFAs: futureAbilities }) : null,\r\n        requirements.length > 0 && task.taskType !== 'exercise' ? React.createElement(KnowledgeRequirementsBox, { title: \"I den h\\u00E4r uppgiften bed\\u00F6ms f\\u00F6ljande kunskapskrav\", className: \"larger\", headerOpen: false, requirements: requirements, idsToSubjectMap: task.idsToSubjectMap, explainedRequirements: task.explainedRequirements, partialRequirments: task.partialRequirments }) : null,\r\n        React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n            abilities.length > 0 ? React.createElement(AbilitiesBox, { title: \"Den h\\u00E4r uppgiften behandlar f\\u00F6ljande f\\u00F6rm\\u00E5gor\", className: \"larger\", headerOpen: false, abilities: abilities }) : null,\r\n            centralContent.length > 0 ? React.createElement(CentralContentBox, { title: \"Den h\\u00E4r uppgiften behandlar f\\u00F6ljande centrala inneh\\u00E5ll\", className: \"larger\", headerOpen: false, centralContent: centralContent }) : null),\r\n        React.createElement(\"hr\", null),\r\n        React.createElement(\"hr\", null),\r\n        task.resources && task.resources.length > 0 && React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n            React.createElement(\"h2\", null, \"Resurser kopplade till uppgiften\"),\r\n            React.createElement(\"div\", { className: \"taskContainer\" }, task.resources.map(function (r, idx) {\r\n                return React.createElement(\"div\", { key: idx, className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { href: r.url }, r.name)));\r\n            })),\r\n            React.createElement(\"br\", null)),\r\n        React.createElement(\"br\", null));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { db } from '../../../../globals/db';\r\nimport { LazyContent } from '../../../utility-components/lazy-content';\r\nimport { DeltaDocBox } from './deltadoc-box';\r\nimport { DeltaLinkBox } from './deltalink-box';\r\nimport { L } from '../../../../utils/utils';\r\nfunction deltaKey(delta) {\r\n    if (delta.type === 'modify')\r\n        return delta.targetId;\r\n    return delta.sourceId + delta.label + delta.targetId;\r\n}\r\nexport function DeltaView(_a) {\r\n    var branchId = _a.branchId, tag = _a.tag, editable = _a.editable;\r\n    var deltas = db.branch(branchId).deltas;\r\n    if (tag) {\r\n        deltas = deltas.tags(tag);\r\n    }\r\n    return React.createElement(LazyContent, null, deltas.toValue().map(function (deltas) {\r\n        return deltas.length === 0 ? React.createElement(\"div\", null,\r\n            React.createElement(\"p\", { style: { opacity: 0.5, fontStyle: 'italic' } }, tag ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolans version \\u00E4r identisk med orginalet\"], [\"Skolans version \\u00E4r identisk med orginalet\"]))) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Det finns inga \\u00E4ndringar att publicera.\"], [\"Det finns inga \\u00E4ndringar att publicera.\"]))))) :\r\n            //\r\n            // Normal view (list all changes + option to clear all)\r\n            //\r\n            React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", { className: \"taskContainer odd-even\" }, deltas.map(function (delta) {\r\n                    var key = deltaKey(delta);\r\n                    return delta.type === 'modify' ?\r\n                        React.createElement(DeltaDocBox, { delta: delta, editable: editable, key: key, onDelete: function () {\r\n                                // Undo DeltaDoc\r\n                                undoDeltaDoc(delta);\r\n                            } }) :\r\n                        React.createElement(DeltaLinkBox, { delta: delta, editable: editable, key: key, onDelete: function () {\r\n                                // Undo Link\r\n                                undoDeltaRelation(delta);\r\n                            } });\r\n                })),\r\n                React.createElement(\"button\", { className: \"btn btn-large btn-warning\", onClick: function () {\r\n                        var e_1, _a;\r\n                        if (confirm(tag ? L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\\u00C5tg\\u00E4rden \\u00E5terst\\u00E4llet kursen till standard.\\n\\nVill du forts\\u00E4tta?\"], [\"\\u00C5tg\\u00E4rden \\u00E5terst\\u00E4llet kursen till standard.\\\\n\\\\nVill du forts\\u00E4tta?\"]))) : L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"\\u00C5tg\\u00E4rden raderar samtliga \\u00E4ndringar som \\u00E4nnu inte \\u00E4r publicerade.\\n\\nVill du forts\\u00E4tta?\"], [\"\\u00C5tg\\u00E4rden raderar samtliga \\u00E4ndringar som \\u00E4nnu inte \\u00E4r publicerade.\\\\n\\\\nVill du forts\\u00E4tta?\"]))))) {\r\n                            try {\r\n                                for (var deltas_1 = tslib_1.__values(deltas), deltas_1_1 = deltas_1.next(); !deltas_1_1.done; deltas_1_1 = deltas_1.next()) {\r\n                                    var delta = deltas_1_1.value;\r\n                                    if (delta.type === 'modify') {\r\n                                        undoDeltaDoc(delta);\r\n                                    }\r\n                                    else {\r\n                                        undoDeltaRelation(delta);\r\n                                    }\r\n                                }\r\n                            }\r\n                            catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (deltas_1_1 && !deltas_1_1.done && (_a = deltas_1.return)) _a.call(deltas_1);\r\n                                }\r\n                                finally { if (e_1) throw e_1.error; }\r\n                            }\r\n                        }\r\n                    } }, tag ? L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"\\u00C5terst\\u00E4ll till orginalet\"], [\"\\u00C5terst\\u00E4ll till orginalet\"]))) : L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Radera alla opublicerade \\u00E4ndringar\"], [\"Radera alla opublicerade \\u00E4ndringar\"])))));\r\n    }));\r\n    function undoDeltaRelation(delta) {\r\n        db.branch(branchId).table(delta.sourceTable)\r\n            .undoLink(delta.sourceId, delta.label, delta.targetId);\r\n    }\r\n    function undoDeltaDoc(delta) {\r\n        var undoings = {};\r\n        Object.keys(delta.data).forEach(function (key) {\r\n            undoings[key] = { $unset: 0 };\r\n        });\r\n        db.branch(branchId).table(delta.table).update({\r\n            id: delta.targetId,\r\n            name: delta.targetName\r\n        }, undoings);\r\n    }\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { maxLength, capitalizeFirst, L } from '../../../../utils/utils';\r\nimport { modelNames, deltaTypes } from './model-friendly-names';\r\nimport { shortDateFormat } from '../../../course-builder/utils';\r\nexport function DeltaDocBox(_a) {\r\n    var delta = _a.delta, editable = _a.editable, onDelete = _a.onDelete;\r\n    var entityName = delta.targetName && maxLength(delta.targetName, 80);\r\n    var classNames = [\"schoolCourse\"];\r\n    if (delta.$meta)\r\n        classNames.push(\"entitymeta-\" + delta.$meta);\r\n    var friendlyEntityType = capitalizeFirst(modelNames.entityTypes[delta.table] || delta.table);\r\n    var friendlyProps = Object.keys(delta.data).map(function (prop) {\r\n        return ({\r\n            propSpec: modelNames.propertyNames[prop],\r\n            prop: prop\r\n        });\r\n    });\r\n    var hasUnknownProps = friendlyProps.some(function (fp) { return !fp.propSpec; });\r\n    return React.createElement(\"div\", { className: classNames.join(' ') },\r\n        React.createElement(\"div\", { className: \"align-horizontal\" },\r\n            editable ? React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\r\n                React.createElement(\"a\", { className: \"removeItem\", onClick: onDelete })) : null,\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" }, entityName ?\r\n                React.createElement(\"a\", null,\r\n                    friendlyEntityType,\r\n                    \" \\\"\",\r\n                    entityName,\r\n                    \"\\\"\") :\r\n                React.createElement(\"a\", null, friendlyEntityType))),\r\n        friendlyProps.filter(function (_a) {\r\n            var propSpec = _a.propSpec;\r\n            return propSpec;\r\n        }).map(function (_a) {\r\n            var _b = tslib_1.__read(_a.propSpec, 2), type = _b[0], propName = _b[1], prop = _a.prop;\r\n            return React.createElement(\"div\", { key: prop }, type === deltaTypes.Obscure ?\r\n                React.createElement(\"p\", null, propName) :\r\n                type === deltaTypes.HiddenChange ? null :\r\n                    React.createElement(\"p\", null,\r\n                        propName,\r\n                        \": \",\r\n                        modelNames.getPropVal(delta.data[prop], type, prop)));\r\n        }),\r\n        hasUnknownProps ? React.createElement(\"div\", null,\r\n            React.createElement(\"p\", { title: JSON.stringify(delta.data, null, 4) }, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00C4ndringar i interna egenskaper\"], [\"\\u00C4ndringar i interna egenskaper\"]))))) : null,\r\n        React.createElement(\"div\", null,\r\n            React.createElement(\"p\", { className: \"small\" },\r\n                shortDateFormat(delta.dateTime),\r\n                \" \",\r\n                delta.contributors.join(', '))));\r\n}\r\nvar templateObject_1;\r\n","import React from 'react';\r\nimport { maxLength } from '../../../../utils/utils';\r\nimport { modelNames, removeHtmlTags } from './model-friendly-names';\r\nimport { shortDateFormat } from '../../../course-builder/utils';\r\nexport function DeltaLinkBox(_a) {\r\n    var delta = _a.delta, editable = _a.editable, onDelete = _a.onDelete;\r\n    var entityName = delta.targetName && maxLength(removeHtmlTags(delta.targetName), 80);\r\n    var classNames = [\"schoolCourse\"];\r\n    if (delta.$meta)\r\n        classNames.push(\"entitymeta-\" + delta.$meta);\r\n    var friendlyOperation = modelNames.getModifiedLinkHeading(delta);\r\n    return React.createElement(\"div\", { className: classNames.join(' ') },\r\n        React.createElement(\"div\", { className: \"align-horizontal\" },\r\n            editable ? React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\r\n                React.createElement(\"a\", { className: \"removeItem\", onClick: onDelete })) : null,\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" }, entityName ?\r\n                React.createElement(\"a\", null,\r\n                    friendlyOperation,\r\n                    \" \\\"\",\r\n                    entityName,\r\n                    \"\\\"\") :\r\n                React.createElement(\"a\", null, friendlyOperation))),\r\n        React.createElement(\"div\", null,\r\n            React.createElement(\"p\", { className: \"small\" },\r\n                shortDateFormat(delta.dateTime),\r\n                \" \",\r\n                delta.contributor)));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { LazyContent } from '../../../utility-components/lazy-content';\r\nimport { db, CourseInstances } from '../../../../globals/db';\r\nimport { LazyBanner } from '../../common/banner';\r\nimport { L } from '../../../../utils/utils';\r\nimport { Link } from 'react-router-dom';\r\nimport { VersionHistoryBox } from './version-history-box';\r\nexport var VersionHistoryPage = function (_a) {\r\n    var school = _a.school, courseId = _a.courseId;\r\n    var schoolObservable = db.schools.name(school).single();\r\n    var draftObservable = CourseInstances.getBranchId(schoolObservable, courseId)\r\n        .map(function (draftId) { return db.branch(draftId); });\r\n    var branchObservable = schoolObservable.map(function (school) { return db.branch(school.officialBranchId); });\r\n    var bannerPropsObservable = draftObservable.switchMap(function (repo) { return repo.courseInstances.id(courseId).map(function (course) { return ({\r\n        title: course.name,\r\n        tabs: [{ name: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Versionshistorik\"], [\"Versionshistorik\"]))), key: \"versionhistory\" }],\r\n        buttons: [React.createElement(Link, { to: \"/\" + school + \"/courses/\" + courseId, key: \"$settings\", title: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Visa kursen\"], [\"Visa kursen\"]))) },\r\n                React.createElement(\"i\", { className: \"fa fa-eye\", \"aria-hidden\": true }),\r\n                \"\\u00A0\")]\r\n    }); }); });\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(LazyBanner, { lazyProps: bannerPropsObservable }),\r\n        React.createElement(LazyContent, null, schoolObservable.map(function (_a) {\r\n            var schoolDisplayName = _a.displayName, officialBranchId = _a.officialBranchId;\r\n            return React.createElement(VersionHistoryBox, { branchType: \"school-branch\", branchId: officialBranchId, courseId: courseId, isAdmin: false });\r\n        })));\r\n    /*<button\r\n      className=\"btn btn-large btn-warning\"\r\n      onClick={async ()=>{\r\n        if (confirm(L`Alla modifieringar som gjorts fr skolan ${schoolDisplayName} kommer att frsvinna.\r\n        \r\n        Fortstt?`)) {\r\n          const branch = await branchObservable.load();\r\n          branch.clearBranch();\r\n          db.branches.delete()\r\n        }\r\n      }}\r\n    >{L`terstll kursen till standard`}</button> */\r\n};\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { L, maxLength } from '../../../../utils/utils';\r\nvar Text = Symbol(\"TypeText\");\r\nvar Checkbox = Symbol(\"TypeCheckbox\");\r\nvar Obscure = Symbol(\"TypeObsure\");\r\nvar HiddenChange = Symbol(\"TypeHiddenChange\");\r\nvar Html = Symbol(\"TypeHtml\");\r\nexport var deltaTypes = {\r\n    Text: Text,\r\n    Html: Html,\r\n    Checkbox: Checkbox,\r\n    Obscure: Obscure,\r\n    HiddenChange: HiddenChange\r\n};\r\nexport var modelNames = {\r\n    entityTypes: {\r\n        courseBlocks: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"kursblock\"], [\"kursblock\"]))),\r\n        courseContents: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"inneh\\u00E5llsruta\"], [\"inneh\\u00E5llsruta\"]))),\r\n        courseInstances: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"kurs\"], [\"kurs\"]))),\r\n        courseTabs: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"flik\"], [\"flik\"]))),\r\n        schools: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"skola\"], [\"skola\"]))),\r\n        tasks: L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"uppgift\"], [\"uppgift\"]))),\r\n    },\r\n    modifiedLinks: {\r\n        tabs: [L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Tillagd flik\"], [\"Tillagd flik\"]))), L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"Borttagen flik\"], [\"Borttagen flik\"])))],\r\n        blocks: [L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"Tillagt block\"], [\"Tillagt block\"]))), L(templateObject_10 || (templateObject_10 = tslib_1.__makeTemplateObject([\"Borttaget block\"], [\"Borttaget block\"])))],\r\n        abilities: [L(templateObject_11 || (templateObject_11 = tslib_1.__makeTemplateObject([\"Tillagd f\\u00F6rm\\u00E5ga\"], [\"Tillagd f\\u00F6rm\\u00E5ga\"]))), L(templateObject_12 || (templateObject_12 = tslib_1.__makeTemplateObject([\"Borttagen f\\u00F6rm\\u00E5ga\"], [\"Borttagen f\\u00F6rm\\u00E5ga\"])))],\r\n        centralContent: [L(templateObject_13 || (templateObject_13 = tslib_1.__makeTemplateObject([\"Tillagt centralt inneh\\u00E5ll\"], [\"Tillagt centralt inneh\\u00E5ll\"]))), L(templateObject_14 || (templateObject_14 = tslib_1.__makeTemplateObject([\"Borttaget centralt inneh\\u00E5ll\"], [\"Borttaget centralt inneh\\u00E5ll\"])))],\r\n        knowledgeRequirements: [L(templateObject_15 || (templateObject_15 = tslib_1.__makeTemplateObject([\"Tillagt kunskapskrav\"], [\"Tillagt kunskapskrav\"]))), L(templateObject_16 || (templateObject_16 = tslib_1.__makeTemplateObject([\"Borttaget kunskapskrav\"], [\"Borttaget kunskapskrav\"])))],\r\n        tasks: [L(templateObject_17 || (templateObject_17 = tslib_1.__makeTemplateObject([\"Tillagd uppgift\"], [\"Tillagd uppgift\"]))), L(templateObject_18 || (templateObject_18 = tslib_1.__makeTemplateObject([\"Borttagen uppgift\"], [\"Borttagen uppgift\"])))],\r\n        contents: [L(templateObject_19 || (templateObject_19 = tslib_1.__makeTemplateObject([\"Tillagd inneh\\u00E5llsruta\"], [\"Tillagd inneh\\u00E5llsruta\"]))), L(templateObject_20 || (templateObject_20 = tslib_1.__makeTemplateObject([\"Borttagen inneh\\u00E5llsruta\"], [\"Borttagen inneh\\u00E5llsruta\"])))]\r\n    },\r\n    propertyNames: {\r\n        allowAddTabs: [Checkbox, L(templateObject_21 || (templateObject_21 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat om till\\u00E4gg av flik ska vara till\\u00E5tet\"], [\"\\u00C4ndrat om till\\u00E4gg av flik ska vara till\\u00E5tet\"])))],\r\n        allowRemoveTabs: [Checkbox, L(templateObject_22 || (templateObject_22 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat om borttagning av flik ska vara till\\u00E5tet\"], [\"\\u00C4ndrat om borttagning av flik ska vara till\\u00E5tet\"])))],\r\n        allowReorderTabs: [Checkbox, L(templateObject_23 || (templateObject_23 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat om det ska va till\\u00E5tet att \\u00E4ndra ordning p\\u00E5 flik\"], [\"\\u00C4ndrat om det ska va till\\u00E5tet att \\u00E4ndra ordning p\\u00E5 flik\"])))],\r\n        assignment: [Checkbox, L(templateObject_24 || (templateObject_24 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad flagga f\\u00F6r inl\\u00E4mningsuppgift\"], [\"\\u00C4ndrad flagga f\\u00F6r inl\\u00E4mningsuppgift\"])))],\r\n        commonLearningGoals: [Text, L(templateObject_25 || (templateObject_25 = tslib_1.__makeTemplateObject([\"\\u00C4ndrade gemensamma l\\u00E4randem\\u00E5l\"], [\"\\u00C4ndrade gemensamma l\\u00E4randem\\u00E5l\"])))],\r\n        content: [Html, L(templateObject_26 || (templateObject_26 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad inneh\\u00E5llstext\"], [\"\\u00C4ndrad inneh\\u00E5llstext\"])))],\r\n        createdBy: [HiddenChange, L(templateObject_27 || (templateObject_27 = tslib_1.__makeTemplateObject([\"Skapad av\"], [\"Skapad av\"])))],\r\n        createdDate: [HiddenChange, L(templateObject_28 || (templateObject_28 = tslib_1.__makeTemplateObject([\"Skapad datum\"], [\"Skapad datum\"])))],\r\n        dateTime: [Obscure, L(templateObject_29 || (templateObject_29 = tslib_1.__makeTemplateObject([\"\\u00C4ndat datum / tid\"], [\"\\u00C4ndat datum / tid\"])))],\r\n        deadline: [Text, L(templateObject_30 || (templateObject_30 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat inl\\u00E4mningsdatum\"], [\"\\u00C4ndrat inl\\u00E4mningsdatum\"])))],\r\n        description: [Html, L(templateObject_31 || (templateObject_31 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad beskrivning\"], [\"\\u00C4ndrad beskrivning\"])))],\r\n        embeddedHtml: [Obscure, L(templateObject_32 || (templateObject_32 = tslib_1.__makeTemplateObject([\"Lagt till inb\\u00E4ddad HTML\"], [\"Lagt till inb\\u00E4ddad HTML\"])))],\r\n        explainedRequirements: [Obscure, L(templateObject_33 || (templateObject_33 = tslib_1.__makeTemplateObject([\"Lagt till egna f\\u00F6rklaringar av kunskapskrav\"], [\"Lagt till egna f\\u00F6rklaringar av kunskapskrav\"])))],\r\n        futureAbilities: [Text, L(templateObject_34 || (templateObject_34 = tslib_1.__makeTemplateObject([\"\\u00C4ndrade framtidsf\\u00F6rm\\u00E5gor\"], [\"\\u00C4ndrade framtidsf\\u00F6rm\\u00E5gor\"])))],\r\n        hasCommonLearningGoals: [Checkbox, L(templateObject_35 || (templateObject_35 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad inst\\u00E4llning f\\u00F6r gemensamma l\\u00E4randem\\u00E5l\"], [\"\\u00C4ndrad inst\\u00E4llning f\\u00F6r gemensamma l\\u00E4randem\\u00E5l\"])))],\r\n        hidden: [Checkbox, L(templateObject_36 || (templateObject_36 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad flagga \\\"g\\u00F6md\\\"\"], [\"\\u00C4ndrad flagga \\\"g\\u00F6md\\\"\"])))],\r\n        hiddenTasks: [Obscure, L(templateObject_37 || (templateObject_37 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat listan p\\u00E5 g\\u00F6mda uppgifter\"], [\"\\u00C4ndrat listan p\\u00E5 g\\u00F6mda uppgifter\"])))],\r\n        html: [Obscure, L(templateObject_38 || (templateObject_38 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat inneh\\u00E5ll\"], [\"\\u00C4ndrat inneh\\u00E5ll\"])))],\r\n        learningGoal: [Text, L(templateObject_39 || (templateObject_39 = tslib_1.__makeTemplateObject([\"L\\u00E4randem\\u00E5l\"], [\"L\\u00E4randem\\u00E5l\"])))],\r\n        lockDelete: [Checkbox, L(templateObject_40 || (templateObject_40 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat flagga: \\\"l\\u00E5s fr\\u00E5n borttagning\\\"\"], [\"\\u00C4ndrat flagga: \\\"l\\u00E5s fr\\u00E5n borttagning\\\"\"])))],\r\n        locked: [Checkbox, L(templateObject_41 || (templateObject_41 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad flagga: \\\"f\\u00F6rbjud \\u00E4ndring av flikar\\\"\"], [\"\\u00C4ndrad flagga: \\\"f\\u00F6rbjud \\u00E4ndring av flikar\\\"\"])))],\r\n        migratedTexts: [Obscure, L(templateObject_42 || (templateObject_42 = tslib_1.__makeTemplateObject([\"\\u00C4ndringar i migrerade texter fr\\u00E5n skolverket\"], [\"\\u00C4ndringar i migrerade texter fr\\u00E5n skolverket\"])))],\r\n        modifiedBy: [HiddenChange, L(templateObject_43 || (templateObject_43 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad av\"], [\"\\u00C4ndrad av\"])))],\r\n        modifiedDate: [HiddenChange, L(templateObject_44 || (templateObject_44 = tslib_1.__makeTemplateObject([\"\\u00C4ndringsdatum\"], [\"\\u00C4ndringsdatum\"])))],\r\n        taskOrder: [Obscure, L(templateObject_45 || (templateObject_45 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad ordning p\\u00E5 uppgifter\"], [\"\\u00C4ndrad ordning p\\u00E5 uppgifter\"])))],\r\n        name: [Text, L(templateObject_46 || (templateObject_46 = tslib_1.__makeTemplateObject([\"\\u00C4ndrat namn\"], [\"\\u00C4ndrat namn\"])))],\r\n        order: [Obscure, L(templateObject_47 || (templateObject_47 = tslib_1.__makeTemplateObject([\"\\u00C4ndrad ordning\"], [\"\\u00C4ndrad ordning\"])))],\r\n        resources: [Obscure, L(templateObject_48 || (templateObject_48 = tslib_1.__makeTemplateObject([\"\\u00C4ndrade i resurser\"], [\"\\u00C4ndrade i resurser\"])))],\r\n        school: [Text, L(templateObject_49 || (templateObject_49 = tslib_1.__makeTemplateObject([\"Skola\"], [\"Skola\"])))],\r\n        stepNo: [Text, L(templateObject_50 || (templateObject_50 = tslib_1.__makeTemplateObject([\"Stegnummer\"], [\"Stegnummer\"])))],\r\n        stepNumbers: [Text, L(templateObject_51 || (templateObject_51 = tslib_1.__makeTemplateObject([\"Stegnummer\"], [\"Stegnummer\"])))],\r\n        subject: [Text, L(templateObject_52 || (templateObject_52 = tslib_1.__makeTemplateObject([\"\\u00C4mne\"], [\"\\u00C4mne\"])))],\r\n        subjects: [Obscure, L(templateObject_53 || (templateObject_53 = tslib_1.__makeTemplateObject([\"\\u00C4mnen\"], [\"\\u00C4mnen\"])))],\r\n        tabClass: [Text, L(templateObject_54 || (templateObject_54 = tslib_1.__makeTemplateObject([\"Typ av flik\"], [\"Typ av flik\"])))],\r\n        tabTitle: [HiddenChange, L(templateObject_55 || (templateObject_55 = tslib_1.__makeTemplateObject([\"Fliknamn\"], [\"Fliknamn\"])))],\r\n        taskType: [Text, L(templateObject_56 || (templateObject_56 = tslib_1.__makeTemplateObject([\"Uppgiftstyp\"], [\"Uppgiftstyp\"])))],\r\n        url: [Text, L(templateObject_57 || (templateObject_57 = tslib_1.__makeTemplateObject([\"Url\"], [\"Url\"])))],\r\n        workingProcedure: [Html, L(templateObject_58 || (templateObject_58 = tslib_1.__makeTemplateObject([\"Arbetsprocess\"], [\"Arbetsprocess\"])))],\r\n        youtubeId: [Obscure, L(templateObject_59 || (templateObject_59 = tslib_1.__makeTemplateObject([\"Youtube ID\"], [\"Youtube ID\"])))]\r\n    },\r\n    getModifiedLinkHeading: function (delta) {\r\n        var headingSpec = modelNames.modifiedLinks[delta.label];\r\n        if (!headingSpec) {\r\n            return delta.type === 'add' ? L(templateObject_60 || (templateObject_60 = tslib_1.__makeTemplateObject([\"Tillagt objekt\"], [\"Tillagt objekt\"]))) :\r\n                delta.type === 'remove' ? L(templateObject_61 || (templateObject_61 = tslib_1.__makeTemplateObject([\"Borttaget objekt\"], [\"Borttaget objekt\"]))) : L(templateObject_62 || (templateObject_62 = tslib_1.__makeTemplateObject([\"\\u00C5ngrad l\\u00E4nkning\"], [\"\\u00C5ngrad l\\u00E4nkning\"]))); // Should never be\r\n        }\r\n        return delta.type === 'add' ?\r\n            headingSpec[0] : delta.type === 'remove' ?\r\n            headingSpec[1] : L(templateObject_63 || (templateObject_63 = tslib_1.__makeTemplateObject([\"\\u00C5ngrad l\\u00E4nkning\"], [\"\\u00C5ngrad l\\u00E4nkning\"]))); // Should never be\r\n    },\r\n    getPropVal: function (p, type, prop) {\r\n        switch (p) {\r\n            case true: return L(templateObject_64 || (templateObject_64 = tslib_1.__makeTemplateObject([\"P\\u00E5slaget\"], [\"P\\u00E5slaget\"])));\r\n            case false: return L(templateObject_65 || (templateObject_65 = tslib_1.__makeTemplateObject([\"Avslaget\"], [\"Avslaget\"])));\r\n            case 'primary': return L(templateObject_66 || (templateObject_66 = tslib_1.__makeTemplateObject([\"Grundskola\"], [\"Grundskola\"])));\r\n            case 'gymnasium': return L(templateObject_67 || (templateObject_67 = tslib_1.__makeTemplateObject([\"Gymnasieskola\"], [\"Gymnasieskola\"])));\r\n            case 'exercise': return L(templateObject_68 || (templateObject_68 = tslib_1.__makeTemplateObject([\"\\u00D6vningsuppgift\"], [\"\\u00D6vningsuppgift\"])));\r\n            case 'task': return L(templateObject_69 || (templateObject_69 = tslib_1.__makeTemplateObject([\"Uppgift\"], [\"Uppgift\"])));\r\n            case 'assignment': return L(templateObject_70 || (templateObject_70 = tslib_1.__makeTemplateObject([\"Inl\\u00E4mningsuppgift\"], [\"Inl\\u00E4mningsuppgift\"])));\r\n            case 'theme-course': return L(templateObject_71 || (templateObject_71 = tslib_1.__makeTemplateObject([\"Temakurs\"], [\"Temakurs\"])));\r\n            case 'step-course': return L(templateObject_72 || (templateObject_72 = tslib_1.__makeTemplateObject([\"Stegkurs\"], [\"Stegkurs\"])));\r\n            case 'intro-tab': return L(templateObject_73 || (templateObject_73 = tslib_1.__makeTemplateObject([\"Introduktionsflik\"], [\"Introduktionsflik\"])));\r\n            case 'run-up-tab': return L(templateObject_74 || (templateObject_74 = tslib_1.__makeTemplateObject([\"Upptakt\"], [\"Upptakt\"])));\r\n            case 'subject-tab': return L(templateObject_75 || (templateObject_75 = tslib_1.__makeTemplateObject([\"\\u00C4mnesflik\"], [\"\\u00C4mnesflik\"])));\r\n            case 'mission-tab': return L(templateObject_76 || (templateObject_76 = tslib_1.__makeTemplateObject([\"Uppdragsflik\"], [\"Uppdragsflik\"])));\r\n            case 'content-tab': return L(templateObject_77 || (templateObject_77 = tslib_1.__makeTemplateObject([\"Inneh\\u00E5llsflik\"], [\"Inneh\\u00E5llsflik\"])));\r\n            case 'teacher-tab': return L(templateObject_78 || (templateObject_78 = tslib_1.__makeTemplateObject([\"L\\u00E4rarsida\"], [\"L\\u00E4rarsida\"])));\r\n            case 'word-bank-tab': return L(templateObject_79 || (templateObject_79 = tslib_1.__makeTemplateObject([\"Ordbank\"], [\"Ordbank\"])));\r\n            default: {\r\n                if (p == null)\r\n                    return L(templateObject_80 || (templateObject_80 = tslib_1.__makeTemplateObject([\"Nollst\\u00E4llt\"], [\"Nollst\\u00E4llt\"])));\r\n                if (p === \"\")\r\n                    return L(templateObject_81 || (templateObject_81 = tslib_1.__makeTemplateObject([\"(tomt)\"], [\"(tomt)\"])));\r\n                if (type === Html)\r\n                    return maxLength(removeHtmlTags(p), 300);\r\n                if (typeof p === 'string')\r\n                    return p;\r\n                if (p.subjectName)\r\n                    return p.subjectName;\r\n                return JSON.stringify(p, null, 2);\r\n            }\r\n        }\r\n    }\r\n};\r\nexport function removeHtmlTags(html) {\r\n    var div = document.createElement('div');\r\n    div.innerHTML = html;\r\n    return div.innerText;\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10, templateObject_11, templateObject_12, templateObject_13, templateObject_14, templateObject_15, templateObject_16, templateObject_17, templateObject_18, templateObject_19, templateObject_20, templateObject_21, templateObject_22, templateObject_23, templateObject_24, templateObject_25, templateObject_26, templateObject_27, templateObject_28, templateObject_29, templateObject_30, templateObject_31, templateObject_32, templateObject_33, templateObject_34, templateObject_35, templateObject_36, templateObject_37, templateObject_38, templateObject_39, templateObject_40, templateObject_41, templateObject_42, templateObject_43, templateObject_44, templateObject_45, templateObject_46, templateObject_47, templateObject_48, templateObject_49, templateObject_50, templateObject_51, templateObject_52, templateObject_53, templateObject_54, templateObject_55, templateObject_56, templateObject_57, templateObject_58, templateObject_59, templateObject_60, templateObject_61, templateObject_62, templateObject_63, templateObject_64, templateObject_65, templateObject_66, templateObject_67, templateObject_68, templateObject_69, templateObject_70, templateObject_71, templateObject_72, templateObject_73, templateObject_74, templateObject_75, templateObject_76, templateObject_77, templateObject_78, templateObject_79, templateObject_80, templateObject_81;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../../utils/utils';\r\nimport { DeltaView } from './delta-view';\r\nexport function VersionHistoryBox(props) {\r\n    var title = props.branchType === 'school-branch' ?\r\n        React.createElement(\"h2\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolans \\u00E4ndringar\"], [\"Skolans \\u00E4ndringar\"])))) :\r\n        React.createElement(\"h3\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Opublicerade \\u00E4ndringar\"], [\"Opublicerade \\u00E4ndringar\"]))));\r\n    return React.createElement(\"div\", { className: \"ked_boxed\" },\r\n        title,\r\n        React.createElement(DeltaView, { branchId: props.branchId, editable: !props.isAdmin, tag: props.branchType === 'school-branch' ? props.courseId : null }));\r\n}\r\nvar templateObject_1, templateObject_2;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten, L } from \"../../../utils/utils\";\r\nimport { getEmailFromDocAccess } from '../utils';\r\nexport function getUncoveredKnowledgeRequirements(course) {\r\n    var uncoveredRequirements = course.knowledgeRequirements.reduce(function (result, item) {\r\n        result[item.id] = item;\r\n        return result;\r\n    }, {});\r\n    course.tasks.forEach(function (task) {\r\n        task.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredRequirements[kr.id];\r\n        });\r\n    });\r\n    return Object.keys(uncoveredRequirements).map(function (id) { return uncoveredRequirements[id]; });\r\n}\r\nexport function getIdsNotCoveredByTasks(course) {\r\n    return getIdsNotCoveredByReqReferencingDocs([course], course.tasks);\r\n}\r\nexport function getIdsNotCoveredByReqReferencingDocs(templates, docsBeingChecked) {\r\n    var uncoveredIds = {};\r\n    // 1. Mark the ids of all knowledge requirements, abilities and central content for this course:\r\n    templates.forEach(function (course) {\r\n        course.knowledgeRequirements.forEach(function (r) {\r\n            uncoveredIds[r.id] = true;\r\n        });\r\n        course.abilities.forEach(function (a) {\r\n            uncoveredIds[a.id] = true;\r\n        });\r\n        course.centralContent.forEach(function (cc) {\r\n            uncoveredIds[cc.id] = true;\r\n        });\r\n    });\r\n    // 2. List all tasks and unmark all ids that they refer to\r\n    docsBeingChecked.forEach(function (doc) {\r\n        doc.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredIds[kr.id];\r\n        });\r\n        doc.abilities.forEach(function (a) {\r\n            delete uncoveredIds[a.id];\r\n        });\r\n        doc.centralContent.forEach(function (cc) {\r\n            delete uncoveredIds[cc.id];\r\n        });\r\n    });\r\n    return uncoveredIds;\r\n}\r\nexport function sanityCheck(course) {\r\n    function hasDuplicateTasks(course) {\r\n        var taskIds = {};\r\n        return flatten(course.modules.map(function (module) { return module.taskIds.map(function (taskId) {\r\n            if (taskIds[taskId]) {\r\n                var task = course.tasks.find(function (t) { return t.id === taskId; });\r\n                return L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"], [\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"])), task.name);\r\n            }\r\n            taskIds[taskId] = true;\r\n        }).filter(function (x) { return x; }); }));\r\n    }\r\n    function tasksWithSameUrl(course) {\r\n        var taskUrls = {};\r\n        return course.tasks.map(function (task) {\r\n            if (task.url) {\r\n                if (taskUrls[task.url]) {\r\n                    return L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"], [\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"])), taskUrls[task.url].name, task.name);\r\n                }\r\n                taskUrls[task.url] = task;\r\n            }\r\n        }).filter(function (x) { return x; });\r\n    }\r\n    function hasEmptyModuleNames(course) {\r\n        return course.modules.some(function (module) { return module.name === \"\"; }) && L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Det finns minst en modul utan angivet namn\"], [\"Det finns minst en modul utan angivet namn\"])));\r\n    }\r\n    function hasDuplicateModuleNames(course) {\r\n        var moduleNames = {};\r\n        return course.modules.map(function (module) {\r\n            if (module.name && moduleNames[module.name]) {\r\n                return L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"], [\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"])), module.name);\r\n            }\r\n            if (module.name)\r\n                moduleNames[module.name] = true;\r\n        });\r\n    }\r\n    var checks = flatten([\r\n        hasDuplicateTasks(course),\r\n        tasksWithSameUrl(course),\r\n        hasEmptyModuleNames(course),\r\n        hasDuplicateModuleNames(course)\r\n    ]);\r\n    return checks.filter(function (result) { return result; });\r\n}\r\nexport function getTasksPerId(course) {\r\n    var result = {};\r\n    function add(id, task) {\r\n        var list = result[id] || (result[id] = []);\r\n        list.push(task);\r\n    }\r\n    course.tasks.forEach(function (task) {\r\n        task.abilities.forEach(function (a) { return add(a.id, task); });\r\n        task.centralContent.forEach(function (c) { return add(c.id, task); });\r\n        task.futureAbilities.forEach(function (fa) { return add(fa, task); });\r\n    });\r\n    return result;\r\n}\r\n/** Returns an access list for a course in a backward compatible way */\r\nexport function getSoftAccessList(course) {\r\n    var responsibleTeachers = course.responsibleTeachers;\r\n    var result = responsibleTeachers.map(function (da) { return ({\r\n        name: da.name,\r\n        email: getEmailFromDocAccess(da),\r\n        access: da.access || 'edit'\r\n    }); });\r\n    return result;\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten } from '../../utils/utils';\r\n//get sentences by requirement\r\nexport function getRequirmentSentences(requirement) {\r\n    return requirement.split(\".\").filter(function (e) { return e; });\r\n}\r\n//retrieve sentences\r\nexport function getSavedSentences(partialRequirments) {\r\n    return partialRequirments.map(function (obj) {\r\n        return obj.trim();\r\n    }) || [];\r\n}\r\n//check all requirements are marked\r\nexport function allRequirementSentecesMarked(requirementName, partialRequirements) {\r\n    var textSentences = getRequirmentSentences(requirementName);\r\n    return partialRequirements && partialRequirements.length === textSentences.length;\r\n    ;\r\n}\r\n//get the partial saved sentences for the default view\r\nexport function getPartialContentDefaultView(requirement, partialRequirments, alreadyCoveredPartialRequirments, skipNotMarked) {\r\n    var resultedHtml = requirement.name;\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n    var allReqCoveredSentence = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n    var allReqSentencesMarked = allRequirementSentecesMarked(requirement.name, rowRequirments);\r\n    textSentences.forEach(function (sentence) {\r\n        //trimm current sentence\r\n        var trimmedSentence = sentence.trim();\r\n        var fullSentence = sentence + \".\";\r\n        if (rowRequirments && rowRequirments.includes(trimmedSentence) && !allReqSentencesMarked) {\r\n            resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedGreen\" + \">\" + fullSentence + \"</span>\");\r\n        }\r\n        else {\r\n            var coveredSentece = allReqCoveredSentence && allReqCoveredSentence.includes(trimmedSentence);\r\n            if (coveredSentece) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span>\" + fullSentence + \"</span>\");\r\n            }\r\n            else if (!allReqSentencesMarked && allReqCoveredSentence && allReqCoveredSentence.length > 0) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedRed\" + \">\" + fullSentence + \"</span>\");\r\n            }\r\n        }\r\n    });\r\n    return resultedHtml;\r\n}\r\n//check the current requirement is already covered\r\nexport function isPartialCoveredRequirment(requirement, alreadyCoveredPartialRequirments) {\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var result = false;\r\n    for (var i = 0; i < textSentences.length; i++) {\r\n        var trimmedSentence = textSentences[i].trim();\r\n        var allCoveredSentenceReq = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n        var coveredSentece = allCoveredSentenceReq && allCoveredSentenceReq.includes(trimmedSentence);\r\n        if (coveredSentece) {\r\n            result = true;\r\n            break;\r\n        }\r\n    }\r\n    return result;\r\n}\r\n//compute the covered senteces excluding the current requirement\r\nexport function getCoveredSenteces(allReq, requirementId) {\r\n    var resultArray = [];\r\n    allReq.forEach(function (obj) {\r\n        var assignedReq = Object.assign([], Object.keys(obj).filter(function (reqId) { return reqId == requirementId; }).map(function (k) { return obj[k].map(function (elem) { return elem.trim(); }); }));\r\n        resultArray.push.apply(resultArray, tslib_1.__spread(assignedReq));\r\n    });\r\n    return flatten(resultArray);\r\n}\r\n//sort the selected sentences by the order of the appearance in the requirement\r\nexport function getSortedRequirments(textSentences, partialRequirments) {\r\n    var output = [];\r\n    var indexedSentences = textSentences.map(function (e, i) { return { ind: i, val: e }; });\r\n    output = indexedSentences.filter(function (s) { return partialRequirments.includes(s.val); });\r\n    return output ? output.sort(function (x, y) { return x.ind > y.ind ? 1 : -1; }).map(function (s) { return s.val; }) : [];\r\n}\r\nexport function getMigrationTitle(isMigrated, markMode) {\r\n    return isMigrated ?\r\n        markMode ?\r\n            \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n            \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n        undefined;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { dtFormat } from '../utils';\r\nimport validUrl from 'valid-url';\r\nvar EditResource = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditResource, _super);\r\n    function EditResource(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = _this.props.resource || { name: '', url: '' };\r\n        return _this;\r\n    }\r\n    EditResource.prototype.save = function () {\r\n        var resource = this.state;\r\n        if (!validUrl.isUri(resource.url))\r\n            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med exempelvis http:, https: eller mailto:\"], [\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med exempelvis http:, https: eller mailto:\"])), resource.url));\r\n        this.props.onSave(resource);\r\n    };\r\n    EditResource.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, onSave = _a.onSave, onDelete = _a.onDelete;\r\n        var resource = this.state;\r\n        var isValidUrl = validUrl.isUri(this.state.url);\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, title),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Namn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: true, tabIndex: 1, size: 50, value: resource.name, onChange: function (ev) { return _this.setState({ name: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"L\\u00E4nk:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top \" },\r\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, value: resource.url, onChange: function (ev) { return _this.setState({ url: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                (resource.createdDate || resource.modifiedDate) && React.createElement(\"div\", null,\r\n                    resource.createdDate && React.createElement(\"p\", null,\r\n                        \"Resursen/L\\u00E4nken skapades \",\r\n                        dtFormat(resource.createdDate),\r\n                        \" av \",\r\n                        React.createElement(\"strong\", null, resource.createdBy.name),\r\n                        \".\"),\r\n                    resource.modifiedDate && React.createElement(\"p\", null,\r\n                        \"Resursen/L\\u00E4nken redigerades senast \",\r\n                        dtFormat(resource.modifiedDate),\r\n                        \" av \",\r\n                        React.createElement(\"strong\", null, resource.modifiedBy.name),\r\n                        \".\"),\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(\"br\", null)),\r\n                onDelete && React.createElement(\"div\", { tabIndex: 2, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return onDelete(); } }, \"Ta bort resurs/l\\u00E4nk\"),\r\n                React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-large\" + (isValidUrl ? \"\" : \" btn-inactive\"), onClick: isValidUrl && (function () { return onSave(resource); }) }, \"Spara\")));\r\n    };\r\n    return EditResource;\r\n}(React.Component));\r\nexport { EditResource };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from '../../../utility-components/open-close-box';\r\nvar TaskMigrationBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskMigrationBox, _super);\r\n    function TaskMigrationBox(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TaskMigrationBox.prototype.render = function () {\r\n        var _a = this.props, task = _a.task, course = _a.course, updateLink = _a.updateLink;\r\n        if (!task.migratedTexts)\r\n            return React.createElement(React.Fragment, null, \"\\u00A0\");\r\n        var _b = task.migratedTexts, abilities = _b.abilities, centralContent = _b.centralContent, knowledgeRequirements = _b.knowledgeRequirements;\r\n        var krs = Object.keys(knowledgeRequirements || {}).map(function (id) { return (tslib_1.__assign({}, course.knowledgeRequirements.find(function (t) { return t.id === id; }), knowledgeRequirements[id])); }); //.filter(({name}) => !!name);\r\n        var krA = { title: \"Uppdaterat kunskapskrav fr betyget A\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'A'; }) };\r\n        var krC = { title: \"Uppdaterat Kunskapskrav fr betyget C\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'C'; }) };\r\n        var krE = { title: \"Uppdaterat kunskapskrav fr betyget E\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'E'; }) };\r\n        var abs = { title: \"Uppdaterade frmgor\", type: \"abilities\", items: Object.keys(abilities || {}).map(function (id) { return (tslib_1.__assign({}, course.abilities.find(function (t) { return t.id === id; }), abilities[id])); }) }; //.filter(({name}) => !!name)};\r\n        var ccs = { title: \"Uppdaterat centralt innehll\", type: \"centralContent\", items: Object.keys(centralContent || {}).map(function (id) { return (tslib_1.__assign({}, course.centralContent.find(function (cc) { return cc.id == id; }), centralContent[id])); }) }; //.filter(({name}) => !!name)};\r\n        var tablesToShow = [krA, krC, krE, ccs, abs].filter(function (boxInfo) { return boxInfo.items.length > 0; });\r\n        if (tablesToShow.length === 0)\r\n            return React.createElement(React.Fragment, null, \"\\u00A0\");\r\n        return (React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"div\", null,\r\n                React.createElement(\"div\", { className: \"warningFlag\" },\r\n                    React.createElement(\"i\", { className: \"fa fa-exclamation-triangle\", \"aria-hidden\": \"true\" })),\r\n                React.createElement(\"p\", null, \"Uppdaterade formuleringar fr\\u00E5n Skolverket\")) }, tablesToShow.map(function (_a) {\r\n            var title = _a.title, type = _a.type, items = _a.items;\r\n            return React.createElement(\"div\", { key: title },\r\n                React.createElement(\"h5\", null, title),\r\n                React.createElement(\"table\", null,\r\n                    React.createElement(\"thead\", null,\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"th\", { style: { width: \"40%\" } }, \"Ursprunglig formulering\"),\r\n                            React.createElement(\"th\", { style: { width: \"40%\" } }, \"Skolverkets nya formulering\"),\r\n                            React.createElement(\"th\", null, \"T\\u00E4cker uppgiften den nya formuleringen?\"))),\r\n                    React.createElement(\"tbody\", null, items.map(function (item) { return React.createElement(\"tr\", { key: item.id },\r\n                        React.createElement(\"td\", { dangerouslySetInnerHTML: { __html: item.oldText } }),\r\n                        React.createElement(\"td\", { dangerouslySetInnerHTML: { __html: item.name } }),\r\n                        React.createElement(\"td\", null,\r\n                            React.createElement(\"button\", { onClick: function () { return updateLink(item.id, true); } }, \"Ja - beh\\u00E5ll kopplingen\"),\r\n                            React.createElement(\"button\", { onClick: function () { return updateLink(item.id, false); } }, \"Nej - ta bort kopplingen\"))); }))));\r\n        })));\r\n    };\r\n    return TaskMigrationBox;\r\n}(React.Component));\r\nexport { TaskMigrationBox };\r\n","import * as React from 'react';\r\nexport var EllipsisLoader = function () {\r\n    return React.createElement(\"img\", { style: { border: 0, margin: 0, padding: 0 }, className: \"ellipsis-loader\" });\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { getPartialContentDefaultView, getRequirmentSentences, getCoveredSenteces, getSavedSentences, isPartialCoveredRequirment, getMigrationTitle, getSortedRequirments, allRequirementSentecesMarked } from '../knowledge-matrix-partial-utils';\r\nvar KnowledgeMatrix = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KnowledgeMatrix, _super);\r\n    function KnowledgeMatrix(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    KnowledgeMatrix.prototype.getKnowledgeSentencesContent = function (requirement, partialRequirments, index, markedOk, isMigrated) {\r\n        var _this = this;\r\n        var _a = this.props, coveredPartialRequirments = _a.coveredPartialRequirments, markMode = _a.markMode;\r\n        //split text in senteces\r\n        var textSentences = getRequirmentSentences(requirement.name);\r\n        //get saved sencenteces for the current requirement\r\n        var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n        //get all saved senteces excluding the current ones\r\n        var allCoveredSentenceReq = coveredPartialRequirments && getCoveredSenteces(coveredPartialRequirments, requirement.id);\r\n        return React.createElement(\"td\", { key: index, title: getMigrationTitle(isMigrated, markMode) }, textSentences.map(function (sentence, k) {\r\n            var trimmedSentence = sentence.trim();\r\n            var hasValue = rowRequirments && rowRequirments.includes(trimmedSentence) || markedOk && !rowRequirments;\r\n            var sentenceNotMarked = !allCoveredSentenceReq.includes(trimmedSentence);\r\n            return React.createElement(\"span\", { key: k, dangerouslySetInnerHTML: { __html: sentence ? sentence + \".\" : \"\" }, className: \"selectable\" + (hasValue ? \" markedGreen\" : (sentenceNotMarked ? \" markedRed\" : \"\")), onClick: function () {\r\n                    var updatedRequirments = partialRequirments ? Object.assign([], partialRequirments) : [];\r\n                    var shouldBeRemoved = rowRequirments && rowRequirments.includes(trimmedSentence);\r\n                    //check if no partial data saved, but the requirment is markedOk\r\n                    if (markedOk && (!rowRequirments || rowRequirments.length == 0)) {\r\n                        //save all excepting the one that should be removed\r\n                        updatedRequirments = textSentences.filter(function (x) { return x != sentence; });\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                    else {\r\n                        if (shouldBeRemoved) {\r\n                            updatedRequirments = partialRequirments.filter(function (req) { return req != sentence; });\r\n                        }\r\n                        else {\r\n                            updatedRequirments.push(sentence);\r\n                        }\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                } });\r\n        }));\r\n    };\r\n    KnowledgeMatrix.prototype.onRequirementChanged = function (requirement, value, partialValues, allPartialMarked) {\r\n        if (this.props.onUpdatePartialKnowledge) {\r\n            //remove all saved senteces if the requirement is unchecked\r\n            (value && !partialValues || allPartialMarked) ? this.props.onUpdatePartialKnowledge(requirement.id, []) : this.props.onUpdatePartialKnowledge(requirement.id, getRequirmentSentences(requirement.name));\r\n        }\r\n        else {\r\n            this.props.onMarkChanged(requirement.id, !value);\r\n        }\r\n    };\r\n    KnowledgeMatrix.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, knowledgeRequirements = _a.knowledgeRequirements, markedIds = _a.markedIds, migratedIds = _a.migratedIds, explainedRequirements = _a.explainedRequirements, markBySentenceView = _a.markBySentenceView, markPartialFeatureEnabled = _a.markPartialFeatureEnabled;\r\n        var _b = this.props, idsToMarkNotOk = _b.idsToMarkNotOk, markMode = _b.markMode, onExplainedRequirementsChanged = _b.onExplainedRequirementsChanged, partialRequirments = _b.partialRequirments, coveredPartialRequirments = _b.coveredPartialRequirments;\r\n        var columns = [\"E\", \"C\", \"A\"];\r\n        var rows = [];\r\n        var reqs = knowledgeRequirements.slice();\r\n        var row = null;\r\n        while (true) {\r\n            row = columns.map(function (grade) {\r\n                var pNext = reqs.findIndex(function (r) { return r.gradeStep && r.gradeStep.toUpperCase() === grade; });\r\n                if (pNext < 0)\r\n                    return null;\r\n                var rv = reqs[pNext];\r\n                reqs.splice(pNext, 1);\r\n                return rv;\r\n            });\r\n            if (row.every(function (r) { return r === null; }))\r\n                break;\r\n            rows.push(row);\r\n        }\r\n        return React.createElement(\"table\", { className: \"knowledge-matrix\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null, columns.map(function (c) { return React.createElement(\"th\", { key: c }, c); }))),\r\n            React.createElement(\"tbody\", null, rows.map(function (row, i) { return React.createElement(React.Fragment, { key: i },\r\n                React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0;\r\n                    var isMarkedNotOK = requirement && idsToMarkNotOk && idsToMarkNotOk[requirement.id]; //not used anymore\r\n                    var isMigrated = requirement && migratedIds && !!migratedIds[requirement.id];\r\n                    var rowPartialRequirements = requirement && partialRequirments && partialRequirments[requirement.id];\r\n                    var partialValues = rowPartialRequirements && getSavedSentences(rowPartialRequirements);\r\n                    var allReqSentencesMarked = requirement && allRequirementSentecesMarked(requirement.name, partialValues);\r\n                    var hasPartialCovered = requirement && isPartialCoveredRequirment(requirement, coveredPartialRequirments);\r\n                    var markedRed = !(partialValues && partialValues.length > 0 || hasPartialCovered);\r\n                    return requirement && markBySentenceView && markPartialFeatureEnabled ? _this.getKnowledgeSentencesContent(requirement, rowPartialRequirements, j, isMarkedOK, isMigrated) :\r\n                        React.createElement(\"td\", { key: j, dangerouslySetInnerHTML: { __html: requirement ? (rowPartialRequirements && rowPartialRequirements.length || hasPartialCovered) ?\r\n                                    getPartialContentDefaultView(requirement, rowPartialRequirements, coveredPartialRequirments, markedRed) : requirement.name : \"\" }, className: (markMode ? \"selectable\" : \"\") +\r\n                                (isMigrated ? \" migrated\" : \"\") +\r\n                                (isMarkedOK && (!rowPartialRequirements || allReqSentencesMarked) ?\r\n                                    \" markedGreen\" :\r\n                                    markedRed ?\r\n                                        \" markedRed\" :\r\n                                        \"\"), onClick: markMode && requirement ?\r\n                                function () { return _this.onRequirementChanged(requirement, isMarkedOK, partialValues, allReqSentencesMarked); } :\r\n                                undefined, title: getMigrationTitle(isMigrated, markMode) });\r\n                })),\r\n                explainedRequirements && React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var partialSentences = requirement && partialRequirments && partialRequirments[requirement.id] && getSavedSentences(partialRequirments[requirement.id]);\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0 || partialSentences && partialSentences.length > 0;\r\n                    return React.createElement(\"td\", { key: j }, isMarkedOK ? React.createElement(\"textarea\", { placeholder: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Beskrivning av kravet\"], [\"Beskrivning av kravet\"]))), className: \"inputTextBox inputTextLarge\", style: { width: \"100%\" }, readOnly: !markMode, value: (requirement && explainedRequirements[requirement.id]) || \"\", onChange: requirement && onExplainedRequirementsChanged && (function (ev) { return onExplainedRequirementsChanged(requirement.id, ev.target.value); }) }) : undefined);\r\n                }))); })));\r\n        { /*return <div>\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th>E</th>\r\n                <th>C</th>\r\n                <th>A</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {tbody.map((row, i) =>\r\n              <tr key={i}>{row.map((cell, j) => {\r\n                const isMarkedOK = props.markedIds && props.markedIds.indexOf(cell.id) >= 0;\r\n                const isMarkedNotOK = props.idsToMarkNotOk && props.idsToMarkNotOk[cell.id];\r\n                return <td\r\n                  key={j}\r\n                  rowSpan={cell.rowSpan}\r\n                  className={(props.markMode ? \"selectable\" : \"\") +\r\n                    (isMarkedOK ?\r\n                      \" markedGreen\" :\r\n                      (isMarkedNotOK ?\r\n                        \" markedRed\":\r\n                        \"\"))}\r\n                  onClick={props.markMode && (()=>props.onMarkChanged(cell.id, !isMarkedOK))}>\r\n                  {cell.html && <div style={{position: 'relative'}}>\r\n                    <p\r\n                      className={cell.type === 'ability' ? 'abilityText' : 'criteriaText'}\r\n                      dangerouslySetInnerHTML={{__html: cell.html}} />\r\n                    {props.editMode && <RemoveItem className=\"upperRight\" onClick={()=>\r\n                      this.setCellIds(\r\n                        cell.type,\r\n                        cell.rowIndex,\r\n                        this.getCellIds(\r\n                          cell.type,\r\n                          cell.rowIndex).filter(id => id != cell.id) )} /> }\r\n                  </div>}\r\n                </td>})}\r\n              </tr>)}\r\n            </tbody>\r\n          </table>\r\n        </div>*/\r\n        }\r\n    };\r\n    return KnowledgeMatrix;\r\n}(React.Component));\r\nexport { KnowledgeMatrix };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\n;\r\nexport var RemoveItem = function (_a) {\r\n    var onClick = _a.onClick, className = _a.className, style = _a.style, title = _a.title;\r\n    return React.createElement(\"div\", { title: title || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Radera\"], [\"Radera\"]))), className: \"removeItem \" + (className || \"\"), onClick: onClick, style: style });\r\n};\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from \"../../utility-components/open-close-box\";\r\nimport { arrayToLookup } from '../../../utils/utils';\r\nvar SelectRelatedDocs = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SelectRelatedDocs, _super);\r\n    function SelectRelatedDocs(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    SelectRelatedDocs.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, options = _a.options, title = _a.title, markedIds = _a.markedIds, markMode = _a.markMode, migratedIds = _a.migratedIds, uncoveredIds = _a.uncoveredIds;\r\n        var groupedOptions = arrayToLookup(options, function (d) { return d.group || \"default\"; });\r\n        var groups = Object.keys(groupedOptions);\r\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: \"larger\" }, groups.map(function (group) { return React.createElement(React.Fragment, { key: group },\r\n            groups.length === 1 ? null : React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"h5\", null, group),\r\n                React.createElement(\"hr\", null)),\r\n            groupedOptions[group].map(function (option) {\r\n                var isMarked = markedIds.some(function (x) { return x === option.id; });\r\n                var isMigrated = migratedIds && !!migratedIds[option.id];\r\n                var isUncovered = uncoveredIds && uncoveredIds[option.id];\r\n                return React.createElement(\"div\", { className: \"align-horizontal\", key: option.id, onClick: function () {\r\n                        return markMode && _this.props.onMarkChanged(option.id, !isMarked);\r\n                    } },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" +\r\n                            (markMode ? \" selectable\" : \"\") +\r\n                            (isMarked ? \" markedGreen\" : (isUncovered ?\r\n                                \" markedRed\" :\r\n                                \"\")) +\r\n                            (isMigrated ? \" migrated\" : \"\"), title: isMigrated ?\r\n                            markMode ?\r\n                                \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n                                \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n                            undefined },\r\n                        React.createElement(\"p\", { dangerouslySetInnerHTML: { __html: option.name } }),\r\n                        React.createElement(\"br\", null)));\r\n            })); }));\r\n    };\r\n    return SelectRelatedDocs;\r\n}(React.Component));\r\nexport { SelectRelatedDocs };\r\n","import * as React from 'react';\r\nexport var Spinner = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? \"\" : _b;\r\n    return React.createElement(\"span\", null,\r\n        React.createElement(\"i\", { className: \"fa fa-spinner fa-spin\", \"aria-hidden\": \"true\" }),\r\n        \"\\u00A0\",\r\n        label);\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport update from 'react-addons-update';\r\nimport $ from 'jquery';\r\nimport env from '../../globals/KED.env';\r\nexport function updateDocumentGraphs(oldDoc, newDoc, table, graphs, batch) {\r\n    var e_1, _a;\r\n    var docUpdates = {};\r\n    var docId = newDoc.id;\r\n    var _loop_1 = function (navProp) {\r\n        var e_2, _a, e_3, _b, e_4, _c;\r\n        var foreignTable = graphs[navProp];\r\n        var oldList = oldDoc[navProp] || [];\r\n        var newList = newDoc[navProp];\r\n        if (!newList)\r\n            return \"continue\";\r\n        var tuples = newList\r\n            .map(function (doc, idx) { return ({ doc: doc, idx: idx }); }); // Create tubles of {doc, array-index} so we can update result\r\n        var added = tuples.filter(function (tuple) { return !oldList.some(function (o) { return o.id === tuple.doc.id; }); }); // Find added items\r\n        try {\r\n            for (var added_1 = (e_2 = void 0, tslib_1.__values(added)), added_1_1 = added_1.next(); !added_1_1.done; added_1_1 = added_1.next()) {\r\n                var a = added_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, a.doc);\r\n                var meta = mutatedSubDoc.$meta;\r\n                delete mutatedSubDoc.$meta; // Delete $meta so that \"add\" or \"update\" does not persiste to next state.\r\n                if (meta === 'add') {\r\n                    if (!mutatedSubDoc.id)\r\n                        mutatedSubDoc.id = createUUID(); // Generate ID if not done yet.\r\n                    // Now put an 'add' mutation in the batch queue.\r\n                    batch.add(foreignTable, mutatedSubDoc);\r\n                }\r\n                else if (meta === 'update') {\r\n                    batch.put(foreignTable, mutatedSubDoc);\r\n                }\r\n                batch.link(table, docId, foreignTable, mutatedSubDoc.id, navProp);\r\n                // Update result so that state is reflected after succesful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][a.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (added_1_1 && !added_1_1.done && (_a = added_1.return)) _a.call(added_1);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        var removed = oldList.filter(function (o) { return !newList.some(function (n) { return n.id === o.id; }); });\r\n        try {\r\n            for (var removed_1 = (e_3 = void 0, tslib_1.__values(removed)), removed_1_1 = removed_1.next(); !removed_1_1.done; removed_1_1 = removed_1.next()) {\r\n                var r = removed_1_1.value;\r\n                batch.unlink(table, docId, foreignTable, r.id, navProp);\r\n            }\r\n        }\r\n        catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n        finally {\r\n            try {\r\n                if (removed_1_1 && !removed_1_1.done && (_b = removed_1.return)) _b.call(removed_1);\r\n            }\r\n            finally { if (e_3) throw e_3.error; }\r\n        }\r\n        var updated = tuples.filter(function (tuple) { return oldList.some(function (o) { return o.id === tuple.doc.id && tuple.doc.$meta === 'update'; }); });\r\n        try {\r\n            for (var updated_1 = (e_4 = void 0, tslib_1.__values(updated)), updated_1_1 = updated_1.next(); !updated_1_1.done; updated_1_1 = updated_1.next()) {\r\n                var u = updated_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, u.doc);\r\n                delete mutatedSubDoc.$meta;\r\n                batch.put(foreignTable, mutatedSubDoc);\r\n                // Update result so that $meta is removed from navigation prop after successful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][u.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n        finally {\r\n            try {\r\n                if (updated_1_1 && !updated_1_1.done && (_c = updated_1.return)) _c.call(updated_1);\r\n            }\r\n            finally { if (e_4) throw e_4.error; }\r\n        }\r\n    };\r\n    try {\r\n        for (var _b = tslib_1.__values(Object.keys(graphs)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n            var navProp = _c.value;\r\n            _loop_1(navProp);\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return update(newDoc, docUpdates);\r\n}\r\nexport function dtFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD HH:mm');\r\n}\r\nexport function shortDateFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD');\r\n}\r\nexport function shortPersonNameFormat(name) {\r\n    if (!name)\r\n        return \"\";\r\n    var names = name.split(' ').filter(function (n) { return !!n; });\r\n    var lastName = names.pop();\r\n    return names.map(function (name) { return name[0] + \".\"; }).concat(lastName).join(' ');\r\n}\r\nexport function updateModificationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        dateTime: { $set: now },\r\n        modifiedDate: { $set: now },\r\n        modifiedBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function updateCreationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        createdDate: { $set: now },\r\n        createdBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function getEmailFromDocAccess(resource) {\r\n    if (resource.email)\r\n        return resource.email;\r\n    return resource.url ?\r\n        resource.url.startsWith('mailto:') ?\r\n            resource.url.substring('mailto:'.length) :\r\n            resource.url :\r\n        resource.url;\r\n}\r\nexport function updateModificationAndCreationStamps(obj, user) {\r\n    var now = Date.now();\r\n    obj = updateModificationStamp(now, obj, user);\r\n    if (!obj.createdBy)\r\n        obj = updateCreationStamp(now, obj, user);\r\n    return obj;\r\n}\r\nexport function applyEtags(doc, newEtags, graphs) {\r\n    var e_5, _a;\r\n    var res = tslib_1.__assign({}, doc);\r\n    var etag = newEtags[doc.id];\r\n    if (etag)\r\n        res.$etag = etag;\r\n    try {\r\n        for (var graphs_1 = tslib_1.__values(graphs), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\r\n            var label = graphs_1_1.value;\r\n            var newList = doc[label].map(function (d) { return applyEtags(d, newEtags, []); });\r\n            res[label] = newList;\r\n        }\r\n    }\r\n    catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n    finally {\r\n        try {\r\n            if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\r\n        }\r\n        finally { if (e_5) throw e_5.error; }\r\n    }\r\n    return res;\r\n}\r\nexport function readBlob(blob, m) {\r\n    return new Promise(function (resolve, reject) {\r\n        var reader = new FileReader();\r\n        reader.onload = function (ev) { return resolve(ev.target.result); };\r\n        reader.onabort = function (ev) { return reject(new Error(\"file read aborted\")); };\r\n        reader.onerror = function (ev) { return reject(ev.target.error); };\r\n        m(reader);\r\n    });\r\n}\r\nexport function readBlobAsText(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsText(blob); });\r\n}\r\nexport function readBlobAsDataUrl(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsDataURL(blob); });\r\n}\r\nexport function allowCopy(e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    e.dataTransfer.dropEffect = 'copy';\r\n}\r\nexport function updateCourseBuilderStatus(status) {\r\n    var div = $('div.course-builder')[0];\r\n    if (div)\r\n        div.className = \"course-builder\" + (status ? \" status \" + status : \"\");\r\n}\r\nexport function loadCourse(id, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var client, includeTemplateChain, includeTasks, _a, course, courseTasks, templateChain;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    client = env.kedBackendClient;\r\n                    includeTemplateChain = options && options.includeTemplateChain;\r\n                    includeTasks = !options || !options.include || options.include.indexOf(\"tasks\") !== -1;\r\n                    return [4 /*yield*/, Promise.all([\r\n                            client.get(\"courses\", id, {\r\n                                include: options && options.include ? options.include.filter(function (i) { return i !== \"tasks\"; }) : [\r\n                                    \"centralContent\",\r\n                                    \"knowledgeRequirements\",\r\n                                    \"abilities\",\r\n                                    \"images\",\r\n                                    \"acl\" // Don't include tasks here...\r\n                                ]\r\n                            }),\r\n                            // ... but include tasks here instead so that we can load the graphs for the\r\n                            // tasks as well!\r\n                            includeTasks && client.list(\"tasks\", {\r\n                                hasEdgesFrom: id,\r\n                                include: ['knowledgeRequirements', 'centralContent', 'abilities', 'acl'],\r\n                                flags: ['includeIdsOnly'] // Don't need redundant info that's already on course\r\n                            }),\r\n                            includeTemplateChain && client.list(\"courses\", {\r\n                                hasEdgesFrom: id,\r\n                                flags: ['idsOnly']\r\n                            })\r\n                        ])];\r\n                case 1:\r\n                    _a = tslib_1.__read.apply(void 0, [(_b.sent()), 3]), course = _a[0], courseTasks = _a[1], templateChain = _a[2];\r\n                    course.tasks = courseTasks;\r\n                    // Correct the order of Abilities\r\n                    if (course.abilities && course.abilitiesOrder) {\r\n                        course.abilities = course.abilitiesOrder.map(function (id) {\r\n                            return course.abilities.find(function (a) { return a.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of KnowledgeRequirements\r\n                    if (course.knowledgeRequirements && course.knowledgeRequirementsOrder) {\r\n                        course.knowledgeRequirements = course.knowledgeRequirementsOrder.map(function (id) {\r\n                            return course.knowledgeRequirements.find(function (c) { return c.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of CentralContent\r\n                    if (course.centralContent && course.centralContentOrder) {\r\n                        course.centralContent = course.centralContentOrder.map(function (id) {\r\n                            return course.centralContent.find(function (cc) { return cc.id === id; });\r\n                        }); //.filter(x => !!x);// Debugging somthin' . Normally the last .filter()... part should not be nescessary...\r\n                    }\r\n                    // Include template chain if requested.\r\n                    if (includeTemplateChain)\r\n                        course.templateChain = templateChain;\r\n                    return [2 /*return*/, course];\r\n            }\r\n        });\r\n    });\r\n}\r\n// Check differences between two array of type T\r\nexport function hasChanges(originalValues, currentValues) {\r\n    return originalValues === undefined || currentValues.filter(function (x) { return !originalValues.includes(x); }).length > 0 || originalValues.filter(function (x) { return !currentValues.includes(x); }).length > 0;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport moment from 'moment';\r\nimport { Spinner } from '../../course-builder/sub-components/spinner';\r\nimport env from '../../../globals/KED.env';\r\nimport { features } from '../../../features';\r\nimport { FileView } from '../subcomponents/task-fileview';\r\nimport { downloadFile, getUrkundStatus } from './task-assignments-utils';\r\nvar TaskAssignmentsTable = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskAssignmentsTable, _super);\r\n    function TaskAssignmentsTable(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TaskAssignmentsTable.prototype.render = function () {\r\n        var _a = this.props, loading = _a.loading, files = _a.files, usersNotHandedInDocs = _a.usersNotHandedInDocs, taskDeadline = _a.taskDeadline, teacherAtThisSchool = _a.teacherAtThisSchool, refreshAssignment = _a.refreshAssignment, sendToUrkund = _a.sendToUrkund, deleteAssignment = _a.deleteAssignment;\r\n        var hasOwnDocs = files.some(function (file) { return file.user === env.currentUser.mail; });\r\n        return loading ? React.createElement(Spinner, { label: \"Laddar inl\\u00E4mnade filer...\" }) : files.length === 0 && !usersNotHandedInDocs ?\r\n            (teacherAtThisSchool ? React.createElement(\"p\", null, \"Ingen elev har l\\u00E4mnat in n\\u00E5got arbete \\u00E4nnu.\") : null)\r\n            : (teacherAtThisSchool ? getTeacherView(files, hasOwnDocs, usersNotHandedInDocs, taskDeadline, refreshAssignment, sendToUrkund, deleteAssignment) : getStudentView(files, hasOwnDocs, deleteAssignment));\r\n    };\r\n    return TaskAssignmentsTable;\r\n}(React.Component));\r\nexport { TaskAssignmentsTable };\r\nfunction getTeacherView(files, hasOwnDocs, usersNotHandedInDocs, taskDeadline, refreshAssignment, sendToUrkund, deleteAssignment) {\r\n    return React.createElement(React.Fragment, null,\r\n        files.length > 0 && React.createElement(React.Fragment, null,\r\n            features.studyGroups && React.createElement(\"p\", null, \"Uploaded assignments\"),\r\n            React.createElement(\"table\", { className: \"task-assignments-table\" },\r\n                React.createElement(\"thead\", null,\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Elev\"),\r\n                        React.createElement(\"th\", null, \"Filnamn\"),\r\n                        React.createElement(\"th\", null, \"Inl\\u00E4mnat den\"),\r\n                        React.createElement(\"th\", null, \"Rapport\"),\r\n                        React.createElement(\"th\", null, \"Niv\\u00E5\"),\r\n                        hasOwnDocs && React.createElement(\"th\", null))),\r\n                React.createElement(\"tbody\", null, files.map(function (file) { return React.createElement(\"tr\", { key: file.mediaLink, style: file.metadata.$meta ? { opacity: 0.5 } : {} },\r\n                    React.createElement(React.Fragment, null,\r\n                        React.createElement(\"td\", null,\r\n                            React.createElement(\"a\", { href: \"mailto:\" + file.user }, file.metadata.userDisplayName || file.user)),\r\n                        React.createElement(\"td\", null, file.metadata.driveFileId ?\r\n                            // The file can be edited on drive. Link to editing it.\r\n                            React.createElement(FileView, { thumbnail: file.metadata.driveFileIconUrl, title: file.filename.substr(0, file.filename.lastIndexOf('.')), url: file.metadata.driveFileUrl }) :\r\n                            // The file cannot be edited on drive. Link to downloading it.\r\n                            React.createElement(FileView, { customAction: function (ev) {\r\n                                    ev.preventDefault();\r\n                                    ev.stopPropagation();\r\n                                    downloadFile(file);\r\n                                }, title: file.filename })),\r\n                        React.createElement(\"td\", { className: \"assignment-date-col\" }, moment(file.uploadDate).format('YYYY-MM-DD HH:mm')),\r\n                        file.metadata.$meta === 'add' ?\r\n                            React.createElement(\"td\", { colSpan: 2 },\r\n                                React.createElement(Spinner, { label: \"Laddar upp...\" })) :\r\n                            file.metadata.$meta === 'delete' ?\r\n                                React.createElement(\"td\", { colSpan: 2 },\r\n                                    React.createElement(Spinner, null),\r\n                                    \" Tar bort...\") :\r\n                                getUrkundStatus(file, refreshAssignment, sendToUrkund)),\r\n                    hasOwnDocs && getDeleteOwnDocsColumn(file, deleteAssignment)); })))),\r\n        React.createElement(\"br\", null),\r\n        usersNotHandedInDocs && usersNotHandedInDocs.length > 0 && getStudentNotHandedInAssignment(usersNotHandedInDocs, taskDeadline));\r\n}\r\nfunction getStudentView(files, hasOwnDocs, deleteAssignments) {\r\n    return React.createElement(\"table\", { className: \"task-assignments-table\" },\r\n        React.createElement(\"thead\", null,\r\n            React.createElement(\"tr\", null,\r\n                React.createElement(\"th\", null, \"Filnamn\"),\r\n                React.createElement(\"th\", null, \"Inl\\u00E4mnat den\"),\r\n                hasOwnDocs && React.createElement(\"th\", null))),\r\n        React.createElement(\"tbody\", null, files.map(function (file) {\r\n            return React.createElement(\"tr\", { key: file.mediaLink, style: file.metadata.$meta ? { opacity: 0.5 } : {} },\r\n                React.createElement(\"td\", null, file.metadata.driveFileId ?\r\n                    // The file can be edited on drive. Link to editing it.\r\n                    React.createElement(FileView, { thumbnail: file.metadata.driveFileIconUrl, title: file.filename.substr(0, file.filename.lastIndexOf('.')), url: file.metadata.driveFileUrl }) :\r\n                    // The file cannot be edited on drive. Link to downloading it.\r\n                    React.createElement(FileView, { customAction: function (ev) {\r\n                            ev.preventDefault();\r\n                            ev.stopPropagation();\r\n                            downloadFile(file);\r\n                        }, title: file.filename })),\r\n                React.createElement(\"td\", { className: \"assignment-date-col\" }, file.metadata.$meta === 'add' ?\r\n                    React.createElement(Spinner, { label: \"Laddar upp...\" }) :\r\n                    file.metadata.$meta === 'delete' ?\r\n                        React.createElement(Spinner, { label: \"Tar bort...\" }) :\r\n                        moment(file.uploadDate).format('YYYY-MM-DD HH:mm')),\r\n                hasOwnDocs && getDeleteOwnDocsColumn(file, deleteAssignments));\r\n        })));\r\n}\r\nfunction getDeleteOwnDocsColumn(file, deleteAssignment) {\r\n    return React.createElement(\"td\", null, !file.metadata.$meta && file.user === env.currentUser.mail &&\r\n        React.createElement(\"a\", { href: \"#\", onClick: function (ev) {\r\n                ev.stopPropagation();\r\n                ev.preventDefault();\r\n                if (confirm(\"Radera inl\\u00E4mnad fil \" + file.filename + \"?\"))\r\n                    deleteAssignment(file.mediaLink);\r\n            } },\r\n            React.createElement(\"i\", { className: \"fa fa-trash\" })));\r\n}\r\nfunction getStudentNotHandedInAssignment(usersNotHandedInDocs, taskDeadline) {\r\n    return React.createElement(React.Fragment, null,\r\n        features.studyGroups && React.createElement(\"p\", null, \"Not handed in assignments\"),\r\n        React.createElement(\"table\", { className: \"task-assignments-table\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null,\r\n                    React.createElement(\"th\", null, \"Elev\"),\r\n                    React.createElement(\"th\", null, \"Task deadline\"))),\r\n            React.createElement(\"tbody\", null, usersNotHandedInDocs.map(function (user) {\r\n                return React.createElement(\"tr\", { key: user.displayName, style: { opacity: 0.5 } },\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"a\", { href: \"mailto:\" + user.email }, user.displayName)),\r\n                    React.createElement(\"td\", null,\r\n                        \" \",\r\n                        taskDeadline,\r\n                        \" \"));\r\n            }))),\r\n        React.createElement(\"br\", null));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { env } from '../../../globals/KED.env';\r\nimport download from 'downloadjs';\r\nimport { Spinner } from '../../course-builder/sub-components/spinner';\r\nimport { getUrkundHoverText, getUrkundStatusClass, getUrkundSignificanceClass } from './urkund-utils';\r\nexport function getUrkundStatus(file, refreshAssignment, checkWithUrkund) {\r\n    var metadata = file.metadata;\r\n    var urkundResponses;\r\n    try {\r\n        urkundResponses = metadata.urkundResponse && JSON.parse(metadata.urkundResponse);\r\n    }\r\n    catch (err) {\r\n        urkundResponses = null;\r\n    }\r\n    var urkundResponse = urkundResponses && urkundResponses[0];\r\n    if (!urkundResponse && file.metadata.urkundUploadError) {\r\n        urkundResponse = {\r\n            Status: {\r\n                ErrorCode: -1,\r\n                Message: file.metadata.urkundUploadError,\r\n                State: 'Error'\r\n            },\r\n            ExternalId: file.metadata.urkundExternalId\r\n        };\r\n    }\r\n    if (file.isRefreshing)\r\n        return React.createElement(\"td\", { colSpan: 2 },\r\n            React.createElement(Spinner, null),\r\n            \" Uppdaterar...\");\r\n    return urkundResponse ? React.createElement(React.Fragment, null,\r\n        React.createElement(\"td\", { className: \"urkund-status-col\" },\r\n            React.createElement(\"a\", { href: urkundResponse.Report && urkundResponse.Report.ReportUrl, onClick: function (ev) {\r\n                    if (['Accepted', 'Submitted'].indexOf(urkundResponse.Status.State) === -1)\r\n                        return; // Follow HREF instead.\r\n                    ev.preventDefault();\r\n                    ev.stopPropagation();\r\n                    checkWithUrkund && refreshAssignment(file);\r\n                }, target: \"_blank\", title: getUrkundHoverText(urkundResponse) },\r\n                React.createElement(\"div\", { className: getUrkundStatusClass(urkundResponse) }))),\r\n        React.createElement(\"td\", { className: \"urkund-status-col\" },\r\n            React.createElement(\"div\", { className: getUrkundSignificanceClass(urkundResponse) }, urkundResponse.Report && typeof urkundResponse.Report.Significance === 'number' ?\r\n                urkundResponse.Report.Significance.toFixed() + \"%\" : ' '))) : React.createElement(\"td\", { colSpan: 2 });\r\n}\r\nexport function update(assignments, assignment) {\r\n    var retval = tslib_1.__spread([\r\n        assignment\r\n    ], assignments.filter(function (_a) {\r\n        var user = _a.user, filename = _a.filename;\r\n        return user !== assignment.user ||\r\n            filename !== assignment.filename;\r\n    }));\r\n    return retval;\r\n}\r\nexport function downloadFile(file) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var res, _a, _b, blob, err_1;\r\n        return tslib_1.__generator(this, function (_c) {\r\n            switch (_c.label) {\r\n                case 0:\r\n                    _c.trys.push([0, 5, , 6]);\r\n                    return [4 /*yield*/, env.kedBackendClient.http.fetch(file.mediaLink, 'get', {})];\r\n                case 1:\r\n                    res = _c.sent();\r\n                    if (!(res.status >= 400)) return [3 /*break*/, 3];\r\n                    _a = HttpError.bind;\r\n                    _b = [void 0, res.status];\r\n                    return [4 /*yield*/, res.text()];\r\n                case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                case 3: return [4 /*yield*/, res.blob()];\r\n                case 4:\r\n                    blob = _c.sent();\r\n                    download(blob, file.filename, file.contentType);\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_1 = _c.sent();\r\n                    this.setState({ error: \"Kunde inte ladda ned filen. \" + (err_1.message || err_1) });\r\n                    console.error(err_1);\r\n                    return [3 /*break*/, 6];\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function DriveFileListing(_a) {\r\n    var file = _a.file;\r\n    var _b = file.metadata, driveFileIconUrl = _b.driveFileIconUrl, driveFileUrl = _b.driveFileUrl;\r\n    var filename = file.filename.substr(0, file.filename.lastIndexOf('.'));\r\n    return (React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n            React.createElement(\"img\", { className: \"file-icon\", src: driveFileIconUrl })),\r\n        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n            React.createElement(\"span\", null,\r\n                React.createElement(\"a\", { target: \"_blank\", href: driveFileUrl }, filename)))));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport { showError, compareProps, flatten } from '../../../utils/utils';\r\nimport moment from 'moment';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { isTeacherAtSchool } from '../../../access-control';\r\nimport { isEmployee } from '../../course-builder-ks/logic/is-employee';\r\nimport { GooglePicker } from '../../../apis/google-picker';\r\nimport { DriveButton } from \"../../../apis/buttons\";\r\nimport { features } from '../../../features';\r\nimport { GoogleDrive } from '../../../apis/google-drive';\r\nimport { mockTuitionStudents } from '../../../apis/mock/mock-classroom-data';\r\nimport { TaskAssignmentsTable } from './task-assignments-table';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nimport { update } from './task-assignments-utils';\r\nimport { db } from '../../../globals/db';\r\nvar MAX_URKUND_FILE_SIZE_MB = 50;\r\nvar MAX_NONURKUND_FILE_SIZE_MB = 100;\r\nvar ALLOWED_EXTENSIONS = [\r\n    \".pdf\",\r\n    \".odt\",\r\n    \".docx\",\r\n    \".doc\",\r\n    \".cad\",\r\n    \".wav\",\r\n    \".mp3\",\r\n    \".mpeg4\",\r\n    \".mp4\",\r\n    \".zip\",\r\n    \".png\",\r\n    \".jpg\",\r\n    \".jpeg\",\r\n    \".gif\",\r\n    \".txt\",\r\n    \".html\"\r\n];\r\nvar URKUND_EXTENSIONS = [\r\n    \".pdf\",\r\n    \".odt\",\r\n    \".docx\",\r\n    \".doc\",\r\n    \".txt\",\r\n    \".html\"\r\n];\r\nvar TaskAssignments = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskAssignments, _super);\r\n    function TaskAssignments(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            assignments: [],\r\n            loading: true,\r\n            studyGroupStudents: []\r\n        };\r\n        return _this;\r\n    }\r\n    TaskAssignments.prototype.setStatePromised = function (cb) {\r\n        var _this = this;\r\n        return new Promise(function (resolve) { return _super.prototype.setState.call(_this, cb, resolve); });\r\n    };\r\n    TaskAssignments.prototype.componentDidMount = function () {\r\n        this.load();\r\n    };\r\n    TaskAssignments.prototype.componentWillReceiveProps = function (nextProps) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var err_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 4, , 5]);\r\n                        if (!(nextProps.taskId !== this.props.taskId ||\r\n                            nextProps.courseId !== this.props.courseId)) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.setStatePromised(function () { return ({\r\n                                assignments: [],\r\n                                loading: true,\r\n                                studyGroupStudents: []\r\n                            }); })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [3 /*break*/, 5];\r\n                    case 4:\r\n                        err_1 = _a.sent();\r\n                        showError(err_1);\r\n                        return [3 /*break*/, 5];\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.refreshAssignment = function (assignment) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var client, _a, courseId, taskId, school, user, filename, req, _b, _c, resJson_1, e_1;\r\n            return tslib_1.__generator(this, function (_d) {\r\n                switch (_d.label) {\r\n                    case 0:\r\n                        client = env.kedBackendClient.http;\r\n                        _a = this.props, courseId = _a.courseId, taskId = _a.taskId, school = _a.school;\r\n                        user = assignment.user, filename = assignment.filename;\r\n                        return [4 /*yield*/, this.setState(function (_a) {\r\n                                var assignments = _a.assignments;\r\n                                return ({\r\n                                    assignments: update(assignments, tslib_1.__assign({}, assignment, { isRefreshing: true }))\r\n                                });\r\n                            })];\r\n                    case 1:\r\n                        _d.sent();\r\n                        _d.label = 2;\r\n                    case 2:\r\n                        _d.trys.push([2, 8, , 10]);\r\n                        return [4 /*yield*/, client.get(\"assignments/urkund/\" + school + \"/\" + courseId + \"/\" + taskId + \"/\" + user + \"/\" + filename)];\r\n                    case 3:\r\n                        req = _d.sent();\r\n                        if (!(req.status >= 400)) return [3 /*break*/, 5];\r\n                        _b = HttpError.bind;\r\n                        _c = [void 0, req.status];\r\n                        return [4 /*yield*/, req.text()];\r\n                    case 4: throw new (_b.apply(HttpError, _c.concat([_d.sent()])))();\r\n                    case 5: return [4 /*yield*/, req.text()];\r\n                    case 6:\r\n                        resJson_1 = _d.sent();\r\n                        return [4 /*yield*/, this.setState(function (_a) {\r\n                                var assignments = _a.assignments;\r\n                                return ({\r\n                                    assignments: update(assignments, tslib_1.__assign({}, assignment, { isRefreshing: false, metadata: tslib_1.__assign({}, assignment.metadata, { urkundResponse: resJson_1 }) }))\r\n                                });\r\n                            })];\r\n                    case 7:\r\n                        _d.sent();\r\n                        return [3 /*break*/, 10];\r\n                    case 8:\r\n                        e_1 = _d.sent();\r\n                        return [4 /*yield*/, this.setState(function (_a) {\r\n                                var assignments = _a.assignments;\r\n                                return ({\r\n                                    assignments: update(assignments, tslib_1.__assign({}, assignment, { isRefreshing: false, refreshError: e_1 }))\r\n                                });\r\n                            })];\r\n                    case 9:\r\n                        _d.sent();\r\n                        return [3 /*break*/, 10];\r\n                    case 10: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var client, _a, courseId, taskId, school, courseStudyGroups_1, sendToUrkund, teacherAtSchool, res, _b, _c, assignments, tuitionStudents, schoolObj_1, mockDatasource, emptyOrMock, result, _d, refreshableAssigments, refreshableAssigments_1, refreshableAssigments_1_1, a, e_2_1, error_1;\r\n            var e_2, _e;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_f) {\r\n                switch (_f.label) {\r\n                    case 0:\r\n                        _f.trys.push([0, 18, , 19]);\r\n                        client = env.kedBackendClient.http;\r\n                        _a = this.props, courseId = _a.courseId, taskId = _a.taskId, school = _a.school, courseStudyGroups_1 = _a.courseStudyGroups, sendToUrkund = _a.sendToUrkund;\r\n                        teacherAtSchool = isTeacherAtSchool(env.currentUser, school);\r\n                        return [4 /*yield*/, (teacherAtSchool ?\r\n                                client.get(\"assignments/\" + school + \"/\" + courseId + \"/\" + taskId) :\r\n                                client.get(\"assignments/\" + school + \"/\" + courseId + \"/\" + taskId + \"/\" + env.currentUser.mail))];\r\n                    case 1:\r\n                        res = _f.sent();\r\n                        if (!(res.status !== 200)) return [3 /*break*/, 3];\r\n                        _b = HttpError.bind;\r\n                        _c = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_b.apply(HttpError, _c.concat([_f.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        assignments = _f.sent();\r\n                        tuitionStudents = [];\r\n                        if (!(courseStudyGroups_1 && courseStudyGroups_1.length > 0)) return [3 /*break*/, 9];\r\n                        return [4 /*yield*/, db.schools.name(school).single().load()];\r\n                    case 5:\r\n                        schoolObj_1 = _f.sent();\r\n                        mockDatasource = Object.keys(mockTuitionStudents).filter(function (m) { return courseStudyGroups_1.includes(m); }).map(function (sp) { return mockTuitionStudents[sp]; });\r\n                        emptyOrMock = school === 'KED' && mockDatasource ? mockDatasource : [];\r\n                        if (!schoolObj_1.edsSchoolNameGymn) return [3 /*break*/, 7];\r\n                        return [4 /*yield*/, Promise.all(courseStudyGroups_1.map(function (stGroup) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                                return tslib_1.__generator(this, function (_a) {\r\n                                    switch (_a.label) {\r\n                                        case 0: return [4 /*yield*/, env.edsClient.getTuitionGroupStudents({\r\n                                                schoolName: schoolObj_1.edsSchoolNameGymn,\r\n                                                tuitionGroupName: stGroup\r\n                                            })];\r\n                                        case 1: return [2 /*return*/, _a.sent()];\r\n                                    }\r\n                                });\r\n                            }); }))];\r\n                    case 6:\r\n                        _d = _f.sent();\r\n                        return [3 /*break*/, 8];\r\n                    case 7:\r\n                        _d = emptyOrMock;\r\n                        _f.label = 8;\r\n                    case 8:\r\n                        result = _d;\r\n                        tuitionStudents = flatten(result);\r\n                        _f.label = 9;\r\n                    case 9:\r\n                        this.setState({\r\n                            error: null,\r\n                            loading: false,\r\n                            assignments: assignments,\r\n                            studyGroupStudents: tuitionStudents\r\n                        });\r\n                        if (!(teacherAtSchool && sendToUrkund)) return [3 /*break*/, 17];\r\n                        refreshableAssigments = assignments.filter(function (a) {\r\n                            return a.metadata &&\r\n                                a.metadata.urkundExternalId &&\r\n                                a.metadata.urkundExternalId.length > 0 && // Must have metadata.urkundExternalId Otherwise not possible to refresh\r\n                                !a.metadata.urkundUploadError && ( // Not possible to refresh if upload has failed\r\n                            !a.metadata.urkundLastPoll || // Never checked status yet\r\n                                (['Accepted', 'Submitted'].indexOf(JSON.parse(a.metadata.urkundResponse)[0].Status.State) >= 0 &&\r\n                                    parseInt(a.metadata.urkundLastPoll) < moment().add(-15, \"seconds\").toDate().getTime()));\r\n                        }\r\n                        // Checked status for a long time ago\r\n                        );\r\n                        _f.label = 10;\r\n                    case 10:\r\n                        _f.trys.push([10, 15, 16, 17]);\r\n                        refreshableAssigments_1 = tslib_1.__values(refreshableAssigments), refreshableAssigments_1_1 = refreshableAssigments_1.next();\r\n                        _f.label = 11;\r\n                    case 11:\r\n                        if (!!refreshableAssigments_1_1.done) return [3 /*break*/, 14];\r\n                        a = refreshableAssigments_1_1.value;\r\n                        return [4 /*yield*/, this.refreshAssignment(a)];\r\n                    case 12:\r\n                        _f.sent();\r\n                        _f.label = 13;\r\n                    case 13:\r\n                        refreshableAssigments_1_1 = refreshableAssigments_1.next();\r\n                        return [3 /*break*/, 11];\r\n                    case 14: return [3 /*break*/, 17];\r\n                    case 15:\r\n                        e_2_1 = _f.sent();\r\n                        e_2 = { error: e_2_1 };\r\n                        return [3 /*break*/, 17];\r\n                    case 16:\r\n                        try {\r\n                            if (refreshableAssigments_1_1 && !refreshableAssigments_1_1.done && (_e = refreshableAssigments_1.return)) _e.call(refreshableAssigments_1);\r\n                        }\r\n                        finally { if (e_2) throw e_2.error; }\r\n                        return [7 /*endfinally*/];\r\n                    case 17: return [3 /*break*/, 19];\r\n                    case 18:\r\n                        error_1 = _f.sent();\r\n                        this.setState({\r\n                            loading: false,\r\n                            error: \"Kunde inte ladda inl\\u00E4mningsuppgifter\",\r\n                            assignments: []\r\n                        });\r\n                        console.error(error_1);\r\n                        return [3 /*break*/, 19];\r\n                    case 19: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.onDrag = function (ev) {\r\n        ev.stopPropagation();\r\n        ev.preventDefault();\r\n        ev.dataTransfer.dropEffect = 'copy';\r\n    };\r\n    TaskAssignments.prototype.verifyAndUpload = function (file, driveFile) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var error_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 3, , 4]);\r\n                        if (!file)\r\n                            return [2 /*return*/];\r\n                        if (this.state.assignments.some(function (a) {\r\n                            return a.user === env.currentUser.mail &&\r\n                                a.filename === file.name;\r\n                        })) {\r\n                            if (!confirm(\"Ers\\u00E4tta befintlig fil (\" + file.name + \")?\")) {\r\n                                return [2 /*return*/];\r\n                            }\r\n                        }\r\n                        if (this.props.school.toLowerCase() !== env.currentUser.school.toLowerCase()) {\r\n                            if (!confirm(\"Uppgiften tillh\\u00F6r en annan skola (\" + this.props.school + \").\\n\" +\r\n                                \"Vill du \\u00E4nd\\u00E5 l\\u00E4mna in ditt arbete h\\u00E4r?\")) {\r\n                                return [2 /*return*/];\r\n                            }\r\n                        }\r\n                        this.setState({ uploadingFile: file });\r\n                        return [4 /*yield*/, this.upload(file, driveFile)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        this.setState({\r\n                            uploadingFile: null\r\n                        });\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        error_2 = _a.sent();\r\n                        this.setState({\r\n                            error: \"Kunde inte ladda upp filen. \" + (error_2.message || error_2),\r\n                            uploadingFile: null\r\n                        });\r\n                        console.error(error_2);\r\n                        return [3 /*break*/, 4];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.upload = function (file, driveFile) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var client, _a, courseId, taskId, school, sendToUrkund, mail, isUrkundExtension, lowerFilename, body, queryParams, res, _b, _c;\r\n            return tslib_1.__generator(this, function (_d) {\r\n                switch (_d.label) {\r\n                    case 0:\r\n                        client = env.kedBackendClient.http;\r\n                        _a = this.props, courseId = _a.courseId, taskId = _a.taskId, school = _a.school, sendToUrkund = _a.sendToUrkund;\r\n                        mail = env.currentUser.mail;\r\n                        isUrkundExtension = URKUND_EXTENSIONS\r\n                            .indexOf(\".\" + file.name.split('.').reverse()[0].toLowerCase()) >= 0;\r\n                        if (isUrkundExtension) {\r\n                            if (file.size > MAX_URKUND_FILE_SIZE_MB * 1024 * 1024) {\r\n                                throw new Error(\"Filer av denna typ f\\u00E5r inte vara st\\u00F6rre \\u00E4n \" + MAX_URKUND_FILE_SIZE_MB + \" MB\");\r\n                            }\r\n                        }\r\n                        else {\r\n                            if (file.size > MAX_NONURKUND_FILE_SIZE_MB * 1024 * 1024) {\r\n                                throw new Error(\"Filen f\\u00E5r inte vara st\\u00F6rre \\u00E4n \" + MAX_NONURKUND_FILE_SIZE_MB + \" MB\");\r\n                            }\r\n                        }\r\n                        lowerFilename = file.name.toLowerCase();\r\n                        if (!ALLOWED_EXTENSIONS.some(function (ext) { return lowerFilename.endsWith(ext); })) {\r\n                            throw new Error(\"Filens \\u00E4ndelse m\\u00E5ste vara \" + ALLOWED_EXTENSIONS.join(' / '));\r\n                        }\r\n                        body = new FormData();\r\n                        body.append('files', file);\r\n                        queryParams = {\r\n                            userDisplayName: env.currentUser.displayName,\r\n                            verifyWithUrkund: sendToUrkund\r\n                        };\r\n                        if (driveFile) {\r\n                            queryParams = tslib_1.__assign({}, queryParams, { driveFileId: driveFile.fileId, driveFileUrl: driveFile.url, driveFileIconUrl: driveFile.iconUrl });\r\n                        }\r\n                        return [4 /*yield*/, env.kedBackendClient.http.fetch(\"assignments/\" + school + \"/\" + courseId + \"/\" + taskId + \"/\" + mail, 'put', {}, queryParams, {\r\n                                body: body\r\n                            })];\r\n                    case 1:\r\n                        res = _d.sent();\r\n                        if (!(res.status !== 200)) return [3 /*break*/, 3];\r\n                        _b = HttpError.bind;\r\n                        _c = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_b.apply(HttpError, _c.concat([_d.sent()])))();\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.delete = function (url) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, err_2;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _c.trys.push([0, 6, , 7]);\r\n                        return [4 /*yield*/, this.setStatePromised(function (_a) {\r\n                                var assignments = _a.assignments;\r\n                                return ({ assignments: assignments.map(function (a) { return a.mediaLink === url ? tslib_1.__assign({}, a, { metadata: tslib_1.__assign({}, a.metadata, { $meta: 'delete' }) }) : tslib_1.__assign({}, a); }) });\r\n                            })];\r\n                    case 1:\r\n                        _c.sent();\r\n                        return [4 /*yield*/, env.kedBackendClient.http.fetch(url, 'delete', {})];\r\n                    case 2:\r\n                        res = _c.sent();\r\n                        if (!(res.status >= 400)) return [3 /*break*/, 4];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 3: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 4: return [4 /*yield*/, this.load()];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [3 /*break*/, 7];\r\n                    case 6:\r\n                        err_2 = _c.sent();\r\n                        this.setState({ error: \"Kunde inte ta bort filen. \" + (err_2.message || err_2) });\r\n                        console.error(err_2);\r\n                        return [3 /*break*/, 7];\r\n                    case 7: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskAssignments.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, courseId = _a.courseId, taskId = _a.taskId, school = _a.school, courseStudyGroups = _a.courseStudyGroups, taskDeadline = _a.taskDeadline, sendToUrkund = _a.sendToUrkund;\r\n        var _b = this.state, loading = _b.loading, assignments = _b.assignments, error = _b.error, uploadingFile = _b.uploadingFile, studyGroupStudents = _b.studyGroupStudents;\r\n        var teacherAtThisSchool = isTeacherAtSchool(env.currentUser, school);\r\n        var files = tslib_1.__spread(assignments);\r\n        var showGooglePicker = features.picker;\r\n        if (uploadingFile) {\r\n            var virtualFile_1 = {\r\n                school: school,\r\n                courseId: courseId,\r\n                taskId: taskId,\r\n                filename: uploadingFile.name,\r\n                size: uploadingFile.size,\r\n                user: env.currentUser.mail,\r\n                contentType: uploadingFile.type,\r\n                uploadDate: Date.now(),\r\n                mediaLink: \"assignments/\" + school + \"/\" + courseId + \"/\" + taskId + \"/\" + env.currentUser.mail + \"/\" + uploadingFile.name,\r\n                metadata: {\r\n                    $meta: 'add',\r\n                    userDisplayName: env.currentUser.displayName\r\n                }\r\n            };\r\n            files = files.filter(function (file) { return file.mediaLink !== virtualFile_1.mediaLink; });\r\n            files = tslib_1.__spread(files, [virtualFile_1]);\r\n        }\r\n        files = files.map(function (s) {\r\n            var _a = tslib_1.__read((s.metadata.userDisplayName || s.user).split(' ')), firstName = _a[0], rest = _a.slice(1);\r\n            return tslib_1.__assign({}, s, { firstName: firstName, lastName: rest.join(' ') });\r\n        }).sort(compareProps([\r\n            \"lastName\",\r\n            \"firstName\",\r\n            \"filename\",\r\n            \"uploadDate\"\r\n        ], [\"sv\", \"en\"], { sensitivity: 'base' }));\r\n        //groupping files by study group\r\n        var filesStudyGroups = {};\r\n        var groupByStudyGroup = courseStudyGroups && courseStudyGroups.length > 0 && features.studyGroups && teacherAtThisSchool;\r\n        courseStudyGroups && courseStudyGroups.forEach(function (courseSg) {\r\n            //compute study groups files\r\n            var sgFiles = files.filter(function (file) { return studyGroupStudents.find(function (c) { return c.studentEmailAddress == file.user && courseSg === c.tuitionGroupName; }); });\r\n            // compute users that have not submitted their assignments\r\n            var notSubmittedUsers = studyGroupStudents.filter(function (cs) { return !sgFiles.find(function (f) { return f.user === cs.studentEmailAddress; }) && courseSg === cs.tuitionGroupName; })\r\n                .map(function (ns) { return { displayName: ns.studentFirstName + \" \" + ns.studentLastName, email: ns.studentEmailAddress }; });\r\n            //sort users\r\n            notSubmittedUsers = notSubmittedUsers.map(function (s) {\r\n                var _a = tslib_1.__read(s.displayName.split(' ')), firstName = _a[0], rest = _a.slice(1);\r\n                return tslib_1.__assign({}, s, { firstName: firstName, lastName: rest.join(' ') });\r\n            }).sort(compareProps([\"lastName\", \"firstName\"]));\r\n            filesStudyGroups[courseSg] = { assignments: sgFiles, notSubmittedUsers: notSubmittedUsers };\r\n        });\r\n        return (React.createElement(\"div\", { className: \"stopFloats\", onDragOver: function (ev) { return _this.onDrag(ev); }, onDrop: function (ev) {\r\n                ev.stopPropagation();\r\n                ev.preventDefault();\r\n                _this.verifyAndUpload(ev.dataTransfer.files[0]);\r\n            } },\r\n            error ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"p\", { className: \"error\" }, error)) : undefined,\r\n            groupByStudyGroup ? Object.keys(filesStudyGroups).map(function (key) {\r\n                return React.createElement(OpenCloseBox, { headerOpen: false, title: key, key: key },\r\n                    React.createElement(TaskAssignmentsTable, { loading: loading, files: filesStudyGroups[key].assignments, usersNotHandedInDocs: filesStudyGroups[key].notSubmittedUsers, school: school, refreshAssignment: _this.refreshAssignment.bind(_this), deleteAssignment: _this.delete.bind(_this), taskDeadline: taskDeadline, teacherAtThisSchool: teacherAtThisSchool, sendToUrkund: sendToUrkund }));\r\n            }) :\r\n                React.createElement(TaskAssignmentsTable, { loading: loading, files: files, school: school, refreshAssignment: this.refreshAssignment.bind(this), deleteAssignment: this.delete.bind(this), teacherAtThisSchool: teacherAtThisSchool, sendToUrkund: sendToUrkund }),\r\n            isEmployee() ? undefined : React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", { className: \"drop-zone task-assignment-drop-zone\" },\r\n                    \"Droppa ditt f\\u00E4rdiga arbete h\\u00E4r.\",\r\n                    React.createElement(\"br\", null),\r\n                    \"Det g\\u00E5r ocks\\u00E5 bra att anv\\u00E4nda bl\\u00E4ddra-knappen nedan.\"),\r\n                React.createElement(\"input\", { type: \"file\", onChange: function (ev) { return _this.verifyAndUpload(ev.target.files[0]); } }),\r\n                showGooglePicker && React.createElement(DriveButton, { label: \"H\\u00E4mta fr\\u00E5n Google Drive\", action: function () {\r\n                        var picker = new GooglePicker({ upload: true });\r\n                        var drive = new GoogleDrive();\r\n                        picker.show().then(function (files) {\r\n                            var pickedFile = files[0];\r\n                            if (!pickedFile)\r\n                                return;\r\n                            drive.downloadFile({\r\n                                file: pickedFile,\r\n                                mimeType: \"text/plain\",\r\n                                limitSize: MAX_NONURKUND_FILE_SIZE_MB\r\n                            }).then(function (file) { return _this.verifyAndUpload(file, pickedFile); });\r\n                        });\r\n                    } }))));\r\n    };\r\n    return TaskAssignments;\r\n}(React.Component));\r\nexport { TaskAssignments };\r\n","export function getUrkundStatusClass(res) {\r\n    if (!res || !res.Status) {\r\n        return null;\r\n    }\r\n    else\r\n        switch (res.Status.State) {\r\n            case 'Error':\r\n                return \"urkund-status urkund-status-error\";\r\n            case 'Submitted':\r\n                return \"urkund-status urkund-status-submitted\";\r\n            case 'Accepted':\r\n                return \"urkund-status urkund-status-accepted\";\r\n            case 'Analyzed':\r\n                return \"urkund-status urkund-status-analyzed\";\r\n        }\r\n}\r\nexport function getUrkundHoverText(res) {\r\n    if (!res || !res.Status)\r\n        return null;\r\n    switch (res.Status.State) {\r\n        case 'Error':\r\n            return res.ExternalId ?\r\n                \"Kunde inte tas emot av urkund. Felkod: \" + res.Status.ErrorCode + \"\\n\" +\r\n                    (\"External ID: \" + res.ExternalId + \"\\nFelmeddelande: \" + res.Status.Message)\r\n                :\r\n                    res.Status.Message;\r\n        case 'Submitted':\r\n            return \"Filen \\u00E4r uppladdad till Urkund. Klicka f\\u00F6r att uppdatera status.\";\r\n        case 'Accepted':\r\n            return \"Filen analyseras fortfarande av Urkund. Klicka f\\u00F6r att uppdatera status.\";\r\n        case 'Analyzed':\r\n            return \"Rapport skapad. Klicka f\\u00F6r att \\u00F6ppna rapporten i nytt f\\u00F6nster\";\r\n    }\r\n}\r\nexport function getUrkundSignificanceClass(res) {\r\n    if (!res || !res.Status)\r\n        return '';\r\n    switch (res.Status.State) {\r\n        case 'Error': return 'urkund-significance-error';\r\n        case 'Submitted': return 'urkund-significance-submitted';\r\n        case 'Accepted': return 'urkund-significance-accepted';\r\n    }\r\n    var report = res.Report;\r\n    if (!report) {\r\n        return \"\";\r\n    }\r\n    if (report.Significance < 1)\r\n        //return `${cdn}/images/urkund/0.gif`;\r\n        return \"urkund-significance urkund-significance-0\";\r\n    if (report.Significance < 10)\r\n        //return `${cdn}/images/urkund/1.gif`;\r\n        return \"urkund-significance urkund-significance-1\";\r\n    if (report.Significance < 25)\r\n        return \"urkund-significance urkund-significance-2\";\r\n    //return `${cdn}/images/urkund/2.gif`;\r\n    if (report.Significance < 40)\r\n        return \"urkund-significance urkund-significance-3\";\r\n    //return `${cdn}/images/urkund/3.gif`;\r\n    if (report.Significance < 55)\r\n        return \"urkund-significance urkund-significance-4\";\r\n    //return `${cdn}/images/urkund/4.gif`;\r\n    if (report.Significance < 70)\r\n        return \"urkund-significance urkund-significance-5\";\r\n    //return `${cdn}/images/urkund/5.gif`;\r\n    if (report.Significance < 85)\r\n        return \"urkund-significance urkund-significance-6\";\r\n    //return `${cdn}/images/urkund/6.gif`;\r\n    if (report.Significance < 99.9)\r\n        return \"urkund-significance urkund-significance-7\";\r\n    //return `${cdn}/images/urkund/7.gif`;\r\n    if (report.Significance >= 99.9)\r\n        return \"urkund-significance urkund-significance-8\";\r\n    //return `${cdn}/images/urkund/8.gif`;\r\n    return \"\";\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar AbilitiesBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AbilitiesBox, _super);\r\n    function AbilitiesBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    AbilitiesBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, subTitle = _a.subTitle, abilities = _a.abilities, className = _a.className;\r\n        var headerOpen = this.state.headerOpen;\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\", onClick: function () { return _this.setState({ headerOpen: !_this.state.headerOpen }); } },\r\n                React.createElement(\"p\", null, title)),\r\n            React.createElement(\"div\", { className: \"openContent\" },\r\n                React.createElement(\"div\", { className: \"abilityList\" },\r\n                    subTitle && React.createElement(\"div\", { className: \"contentHeader\" },\r\n                        React.createElement(\"h5\", null, subTitle)),\r\n                    abilities.map(function (a) {\r\n                        return React.createElement(\"div\", { key: a.id, className: \"contentPart\" },\r\n                            React.createElement(\"div\", { className: \"contentText\" },\r\n                                React.createElement(\"p\", { dangerouslySetInnerHTML: { __html: a.name } })));\r\n                    }))));\r\n    };\r\n    return AbilitiesBox;\r\n}(React.Component));\r\nexport { AbilitiesBox };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar CentralContentBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CentralContentBox, _super);\r\n    function CentralContentBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    CentralContentBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, subTitle = _a.subTitle, centralContent = _a.centralContent, className = _a.className;\r\n        var headerOpen = this.state.headerOpen;\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\", onClick: function () { return _this.setState({ headerOpen: !_this.state.headerOpen }); } },\r\n                React.createElement(\"p\", null, title)),\r\n            React.createElement(\"div\", { className: \"openContent\" },\r\n                React.createElement(\"div\", { className: \"abilityList\" },\r\n                    subTitle && React.createElement(\"div\", { className: \"contentHeader\" },\r\n                        React.createElement(\"h5\", null, subTitle)),\r\n                    centralContent.map(function (cc) {\r\n                        return React.createElement(\"div\", { key: cc.id, className: \"contentPart\" },\r\n                            React.createElement(\"div\", { className: \"contentText\" },\r\n                                React.createElement(\"p\", { dangerouslySetInnerHTML: { __html: cc.name } })));\r\n                    }))));\r\n    };\r\n    return CentralContentBox;\r\n}(React.Component));\r\nexport { CentralContentBox };\r\n","import * as React from 'react';\r\nexport function Confirmation(props) {\r\n    return React.createElement(\"div\", { className: \"confirmation-box \" + props.className + (props.visible ? \" visible\" : \"\") },\r\n        React.createElement(\"p\", null, props.text),\r\n        React.createElement(\"button\", { onClick: function () { return props.onConfirm(); } }, \"OK\"),\r\n        React.createElement(\"button\", { onClick: function () { return props.onCancel(); } }, \"Avbryt\"));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from \"../../utility-components/open-close-box\";\r\nimport { arrayToLookup } from '../../../utils/utils';\r\nexport var KnowledgeRequirementsBox = function (props) {\r\n    var title = props.title, className = props.className, headerOpen = props.headerOpen, idsToSubjectMap = props.idsToSubjectMap, requirements = props.requirements;\r\n    if (!idsToSubjectMap) {\r\n        // Normal case\r\n        return (React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: className, headerOpen: headerOpen },\r\n            React.createElement(KnowledgeRequirementsTable, tslib_1.__assign({}, tslib_1.__assign({}, props)))));\r\n    }\r\n    // Special case: Requirements that spans multiple subjects:\r\n    var requirementsPerSubjectLookup = idsToSubjectMap ?\r\n        arrayToLookup(requirements, function (r) { return idsToSubjectMap[r.id] || \"\"; }) : { \"\": requirements };\r\n    var reqsPerSubject = Object.keys(requirementsPerSubjectLookup)\r\n        .map(function (subject) { return ({ subject: subject, requirements: requirementsPerSubjectLookup[subject] }); });\r\n    return React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: className, headerOpen: headerOpen }, reqsPerSubject.map(function (_a) {\r\n        var subject = _a.subject, requirements = _a.requirements;\r\n        return React.createElement(KnowledgeRequirementsTable, tslib_1.__assign({}, tslib_1.__assign({}, props, { key: subject, heading: subject, requirements: requirements })));\r\n    }));\r\n};\r\nvar KnowledgeRequirementsTable = function (_a) {\r\n    var requirements = _a.requirements, includedIds = _a.includedIds, explainedRequirements = _a.explainedRequirements, partialRequirments = _a.partialRequirments, heading = _a.heading;\r\n    var columns = [\"E\", \"C\", \"A\"];\r\n    var rows = [];\r\n    var reqs = requirements.slice();\r\n    var row = null;\r\n    while (true) {\r\n        row = columns.map(function (grade) {\r\n            var pNext = reqs.findIndex(function (r) { return r.gradeStep.toUpperCase() === grade; });\r\n            if (pNext < 0)\r\n                return null;\r\n            var rv = reqs[pNext];\r\n            reqs.splice(pNext, 1);\r\n            return includedIds ?\r\n                (includedIds[rv.id] ? rv : undefined) :\r\n                rv;\r\n        });\r\n        if (row.every(function (r) { return r === null; }))\r\n            break;\r\n        if (!row.every(function (r) { return !r; })) {\r\n            rows.push(row);\r\n        }\r\n    }\r\n    return React.createElement(React.Fragment, null,\r\n        heading && React.createElement(\"h4\", null, heading),\r\n        React.createElement(\"table\", null,\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null, columns.map(function (c) { return React.createElement(\"th\", { key: c }, c); }))),\r\n            React.createElement(\"tbody\", null, rows.map(function (row, i) { return React.createElement(React.Fragment, { key: i },\r\n                React.createElement(\"tr\", { key: i }, row.map(function (column, j) {\r\n                    var columnPartialReq = column && partialRequirments && partialRequirments[column.id];\r\n                    return React.createElement(\"td\", { key: j, dangerouslySetInnerHTML: { __html: columnPartialReq ? columnPartialReq.join(\".\") : column ? column.name : \"\" } });\r\n                }\r\n                // <td key={j}>\r\n                // {partialRequirments.map((pr, k) => pr[column.id] ?\r\n                //   <span key={k} dangerouslySetInnerHTML={{}}/>\r\n                // )}\r\n                // </td>\r\n                )),\r\n                explainedRequirements && React.createElement(\"tr\", null, row.map(function (column, j) {\r\n                    return React.createElement(\"td\", { key: j, className: \"explained-requirement\" },\r\n                        React.createElement(\"div\", null, (column && explainedRequirements[column.id]) || \"\"));\r\n                }))); }))));\r\n};\r\n","import * as React from \"react\";\r\nexport var FileView = function (_a) {\r\n    var thumbnail = _a.thumbnail, url = _a.url, title = _a.title, label = _a.label, icon = _a.icon, _b = _a.size, size = _b === void 0 ? \"small\" : _b, customAction = _a.customAction;\r\n    var myLabel = !!label ? label : title;\r\n    var myIcon = !!thumbnail ? thumbnail : icon;\r\n    var hasIcon = !!myIcon;\r\n    return (React.createElement(\"div\", { className: \"file-view \" + size },\r\n        React.createElement(\"a\", { href: customAction ? \"#\" : url, target: customAction ? undefined : \"_blank\", title: title }, hasIcon ? (React.createElement(\"img\", { className: \"file-\" + (thumbnail ? \"thumbnail\" : \"icon\"), src: myIcon, alt: title })) : (React.createElement(\"i\", { className: \"fas fa-file\" }))),\r\n        React.createElement(\"a\", { href: customAction ? \"#\" : url, target: customAction ? undefined : \"_blank\", title: title, onClick: customAction }, myLabel)));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport moment from 'moment';\r\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\r\nimport { userTasksRepo } from '../../../repos/user-tasks-repo';\r\nimport { arrayToMap } from '../../../utils/utils';\r\nimport { Confirmation } from './confirmation';\r\nimport { LanguageContext } from '../../utility-components/LanguageContext';\r\nimport { UIAddbox } from '../../utility-components/checkbox';\r\nvar TaskList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskList, _super);\r\n    function TaskList(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTasks: [],\r\n            weekDate: Date.now(),\r\n            confirmations: []\r\n        };\r\n        _this.onChange = _this.onChange.bind(_this);\r\n        return _this;\r\n    }\r\n    TaskList.prototype.onChange = function (userTasks, persisted) {\r\n        if (persisted.weekDate !== this.state.weekDate) {\r\n            this.setState({\r\n                confirmations: []\r\n            });\r\n        }\r\n        this.setState({\r\n            userTasks: userTasks,\r\n            weekDate: persisted.weekDate\r\n        });\r\n    };\r\n    TaskList.prototype.componentDidMount = function () {\r\n        userTasksRepo.subscribe(this.onChange);\r\n    };\r\n    TaskList.prototype.componentWillUnmount = function () {\r\n        userTasksRepo.unsubscribe(this.onChange);\r\n    };\r\n    TaskList.prototype.toggleTask = function (learningTask) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var userTasks, weekDate, latestTimeStamp, userTask;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        userTasks = this.state.userTasks.filter(function (ut) {\r\n                            return learningTask.task ?\r\n                                ut.task && ut.task.some(function (t) { return t.id === learningTask.id; }) :\r\n                                ut.siteVisionPageId === learningTask.id;\r\n                        });\r\n                        weekDate = this.state.weekDate;\r\n                        if (!(userTasks.length === 0)) return [3 /*break*/, 2];\r\n                        latestTimeStamp = Math.max.apply(Math.max, [weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        userTask = {\r\n                            id: createUUID(),\r\n                            courseName: learningTask.courseName,\r\n                            dateTime: latestTimeStamp + 2000,\r\n                            learningGoal: learningTask.learningGoal,\r\n                            name: learningTask.name,\r\n                            url: learningTask.url,\r\n                            acl: [\r\n                                // Default ACL: Let user self have full control over this item:\r\n                                new DocumentAccess(\"email\", env.currentUser.mail, \"S\"),\r\n                                // Additional ACL: Let employees on same school have read access to it.\r\n                                // This currently only applies to tasks that refer to course tasks (not custom tasks!)\r\n                                new DocumentAccess(\"schoolRole\", env.currentUser.school + \"/EMPLOYEE\", \"R\")\r\n                            ].map(function (ac) { return ac.toString(); })\r\n                        };\r\n                        if (learningTask.task && learningTask.task.deadline) {\r\n                            userTask.deadline = learningTask.task.deadline;\r\n                        }\r\n                        if (learningTask.task) {\r\n                            userTask.task = [learningTask.task];\r\n                            if (learningTask.course) {\r\n                                userTask.course = [learningTask.course];\r\n                            }\r\n                            else if (learningTask.courseInfo) {\r\n                                userTask.courseInfo = learningTask.courseInfo;\r\n                            }\r\n                        }\r\n                        else {\r\n                            userTask.siteVisionPageId = learningTask.id;\r\n                        }\r\n                        if (learningTask.step) {\r\n                            userTask.step = learningTask.step;\r\n                        }\r\n                        return [4 /*yield*/, Promise.all([\r\n                                userTasksRepo.setWeekPlannerBoxOpen(learningTask.courseName, true),\r\n                                userTasksRepo.insert([userTask])\r\n                            ])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: \r\n                    // Already present in weekplanner. It's time to delete those that matched us.\r\n                    return [4 /*yield*/, userTasksRepo.delete(userTasks.map(function (t) { return t.id; }))];\r\n                    case 3:\r\n                        // Already present in weekplanner. It's time to delete those that matched us.\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    TaskList.prototype.render = function () {\r\n        var _this = this;\r\n        var intl = this.context.intl;\r\n        var learningTasks = this.props.learningTasks;\r\n        var userTasks = arrayToMap(this.state.userTasks, function (ut) { return ut.task && ut.task.length > 0 ?\r\n            ut.task.map(function (t) { return t.id; })[0] : // course-builder tasks looked up by id\r\n            ut.siteVisionPageId ? ut.siteVisionPageId : // non-course-builder tasks\r\n                ut.url; });\r\n        var confirmations = this.state.confirmations;\r\n        var weekPlannerWeek = moment(this.state.weekDate).week();\r\n        var currentWeek = moment().week();\r\n        var forWeekString = weekPlannerWeek === currentWeek ? \"\" :\r\n            weekPlannerWeek === currentWeek + 1 ? intl.formatMessage({ id: \"taskList.nextWeekTask\", defaultMessage: \"fr nsta vecka (v{week})\" }, { week: weekPlannerWeek }) :\r\n                weekPlannerWeek === currentWeek - 1 ? intl.formatMessage({ id: \"taskList.lastWeekTask\", defaultMessage: \"fr frra veckan (v{week})\" }, { week: weekPlannerWeek }) :\r\n                    intl.formatMessage({ id: \"taskList.currentWeekTask\", defaultMessage: \"fr vecka {week}\" }, { week: weekPlannerWeek });\r\n        return React.createElement(\"div\", { className: \"taskContainer\" }, learningTasks.map(function (learningTask, idx) {\r\n            var taskLookupId = learningTask.id;\r\n            var userTask = userTasks[taskLookupId] || { $meta: 'deleted' }; // No exist = $meta: 'deleted'\r\n            var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting';\r\n            var selected = userTask.$meta !== 'deleted' && userTask.$meta !== 'deleting';\r\n            var describedAction = selected ?\r\n                intl.formatMessage({ id: \"taskList.removeTaskFromWeeklyPlanning\", defaultMessage: \"Ta bort uppgiften frn egen veckoplanering {week}\" }, { week: forWeekString }) :\r\n                intl.formatMessage({ id: \"taskList.addTaskToWeeklyPlanning\", defaultMessage: \"Lgg till uppgiften i egen veckoplanering {week}\" }, { week: forWeekString });\r\n            var confirmationVisible = confirmations.some(function (tid) { return taskLookupId === tid; });\r\n            return React.createElement(\"div\", { key: idx },\r\n                React.createElement(UIAddbox, { state: selected ? 'checked' : '', onChange: function () { return !isWorking && weekPlannerWeek === currentWeek ?\r\n                        _this.toggleTask(learningTask) :\r\n                        confirmationVisible ?\r\n                            _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) }) :\r\n                            _this.setState({ confirmations: tslib_1.__spread(confirmations).concat(taskLookupId) }); }, label: React.createElement(\"a\", { title: describedAction, href: learningTask.url }, learningTask.name) }),\r\n                React.createElement(Confirmation, { visible: confirmationVisible, text: describedAction, onConfirm: function () {\r\n                        _this.toggleTask(learningTask);\r\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\r\n                    }, onCancel: function () {\r\n                        _this.setState({ confirmations: confirmations.filter(function (tid) { return tid !== taskLookupId; }) });\r\n                    } }));\r\n        }));\r\n    };\r\n    TaskList.contextType = LanguageContext;\r\n    return TaskList;\r\n}(React.Component));\r\nexport { TaskList };\r\n","import * as React from 'react';\r\nexport var LanguageContext = React.createContext({ intl: null });\r\n","import * as tslib_1 from \"tslib\";\r\nimport { IntlProvider, addLocaleData } from 'react-intl';\r\nimport locale_en from 'react-intl/locale-data/en';\r\nimport locale_sv from 'react-intl/locale-data/sv';\r\nimport messages_sv from \"../../translations/sv.json\";\r\nimport messages_en from \"../../translations/en.json\";\r\nimport * as React from 'react';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport moment from 'moment';\r\nexport var setupIntl = function (Component) {\r\n    return /** @class */ (function (_super) {\r\n        tslib_1.__extends(_SetupLanguageIntl, _super);\r\n        function _SetupLanguageIntl(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            addLocaleData(tslib_1.__spread(locale_en, locale_sv));\r\n            _this.messages = {\r\n                'sv': messages_sv,\r\n                'en': messages_en\r\n            };\r\n            moment().locale(cfg.KED_LOCALE);\r\n            return _this;\r\n        }\r\n        _SetupLanguageIntl.prototype.render = function () {\r\n            return React.createElement(IntlProvider, { locale: cfg.KED_LOCALE, messages: this.messages[cfg.KED_LOCALE] },\r\n                React.createElement(Component, tslib_1.__assign({}, this.props)));\r\n        };\r\n        return _SetupLanguageIntl;\r\n    }(React.Component));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nexport var AlignHorizontal = function (_a) {\r\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\r\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"align-horizontal\"]).join(' ') }, children));\r\n};\r\n","import React from 'react';\r\nexport var UICheckbox = function (_a) {\r\n    var state = _a.state, label = _a.label, onChange = _a.onChange;\r\n    return React.createElement(\"label\", { className: 'ui-checkbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\nexport var UIAddbox = function (_a) {\r\n    var state = _a.state, label = _a.label, _b = _a.onChange, onChange = _b === void 0 ? function () { return null; } : _b;\r\n    return React.createElement(\"label\", { className: 'ui-addbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\n","import React from 'react';\r\nexport var Checklist = function (_a) {\r\n    var available = _a.available, selected = _a.selected, onChange = _a.onChange;\r\n    return React.createElement(\"div\", { className: \"taskContainer\" }, available.map(function (_a) {\r\n        var key = _a.key, name = _a.name;\r\n        var checked = selected.includes(key);\r\n        return React.createElement(\"div\", { key: key, className: \"align-horizontal\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\", onClick: function () {\r\n                    return onChange(checked ?\r\n                        selected.filter(function (k) { return k != key; }) :\r\n                        selected.concat(key), key, checked);\r\n                } },\r\n                React.createElement(\"div\", { className: \"checkBox\" + (checked ? \" checked\" : \"\") })),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" }, name));\r\n    }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { RemoveItem } from '../course-builder/sub-components/remove-item';\r\nimport { findDOMNode } from 'react-dom';\r\nimport $ from 'jquery';\r\nvar Dialogs = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Dialogs, _super);\r\n    function Dialogs(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    Dialogs.prototype.componentDidUpdate = function (prevProps) {\r\n        if (this.lastDiv !== null && prevProps.dialogs.length > this.props.dialogs.length) {\r\n            // A dialog was closed. Now focus the last dialog:\r\n            $(findDOMNode(this.lastDiv)).find(':input').first().focus();\r\n        }\r\n    };\r\n    Dialogs.prototype.render = function () {\r\n        var _this = this;\r\n        this.lastDiv = null;\r\n        var _a = this.props, dialogs = _a.dialogs, popDialog = _a.popDialog;\r\n        $('body').attr('aria-disabled', dialogs.length > 0);\r\n        $('body').css('overflow', dialogs.length > 0 ? 'hidden' : 'auto');\r\n        return dialogs.length > 0 && React.createElement(\"div\", null, dialogs.map(function (dialog, idx) {\r\n            var div;\r\n            function onKeyPress(ev) {\r\n                if (ev.which === 13 && (!ev.target || ev.target.tagName !== 'TEXTAREA')) {\r\n                    $(findDOMNode(div)).find('.btn-default').click();\r\n                }\r\n                ev.stopPropagation();\r\n            }\r\n            function onKeyDown(ev) {\r\n                if (ev.which === 27) { // Escape\r\n                    popDialog();\r\n                    ev.stopPropagation();\r\n                    return;\r\n                }\r\n                if (ev.which === 83 && (ev.ctrlKey || ev.metaKey)) { // CTRL-S\r\n                    var domNode = findDOMNode(div);\r\n                    ev.preventDefault();\r\n                    var defaultButton = $(domNode).find('.btn-default');\r\n                    defaultButton.click();\r\n                    ev.stopPropagation();\r\n                }\r\n            }\r\n            return React.createElement(\"div\", { key: idx },\r\n                React.createElement(\"div\", { className: \"darken\" }),\r\n                React.createElement(\"div\", { className: \"modal-page-wrap\" },\r\n                    React.createElement(\"div\", { className: \"modal-page\", ref: function (elem) {\r\n                            div = elem;\r\n                            if (idx === dialogs.length - 1)\r\n                                _this.lastDiv = elem;\r\n                        }, tabIndex: 0, \"aria-disabled\": idx < dialogs.length - 1, onKeyPress: onKeyPress, onKeyDown: onKeyDown },\r\n                        dialog,\r\n                        React.createElement(RemoveItem, { onClick: popDialog }),\r\n                        React.createElement(\"div\", { className: \"stopFloats\" }))));\r\n        }));\r\n    };\r\n    return Dialogs;\r\n}(React.Component));\r\nexport { Dialogs };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextInput = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextInput, _super);\r\n    function TextInput(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextInput.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label },\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"text\", autoFocus: this.props.autoFocus, id: this.props.id, size: this.props.size || 35, value: this.props.value, onChange: this.props.onChange && (function (ev) { return _this.props.onChange(ev.target.value); }), disabled: this.props.disabled, placeholder: this.props.placeholder }))));\r\n    };\r\n    return TextInput;\r\n}(React.Component));\r\nexport { TextInput };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextAreaFormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextAreaFormField, _super);\r\n    function TextAreaFormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextAreaFormField.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label, id: this.props.id },\r\n            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"textarea\", { autoFocus: this.props.autoFocus, id: this.props.id, cols: 35, rows: this.props.rows || 5, value: this.props.value, onChange: function (ev) { return _this.props.onChange(ev.target.value); }, placeholder: this.props.placeholder })),\r\n                !!this.props.children && React.createElement(\"div\", { className: \"horizontalItem\" }, this.props.children))));\r\n    };\r\n    return TextAreaFormField;\r\n}(React.Component));\r\nexport { TextAreaFormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nfunction findId(node) {\r\n    var recucheck = new Set();\r\n    return (function findId(node) {\r\n        if (typeof node === 'string')\r\n            return null;\r\n        if (recucheck.has(node)) {\r\n            return;\r\n        }\r\n        recucheck.add(node);\r\n        if (node.props) {\r\n            if (node.props.id)\r\n                return node.props.id;\r\n            if (node.props.children) {\r\n                return findId(node.props.children);\r\n            }\r\n            return;\r\n        }\r\n        if (node.length) {\r\n            for (var i = 0; i < node.length; ++i) {\r\n                var child = node[i];\r\n                if (child) {\r\n                    var childId = findId(child);\r\n                    if (childId)\r\n                        return childId;\r\n                    //console.log(child);\r\n                }\r\n            }\r\n        }\r\n    })(node);\r\n}\r\nvar FormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(FormField, _super);\r\n    function FormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    FormField.prototype.render = function () {\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"label\", { className: \"kclabel\", htmlFor: this.props.id || findId(this.props.children) }, this.props.label),\r\n            this.props.children);\r\n    };\r\n    return FormField;\r\n}(React.Component));\r\nexport { FormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nexport var HorizontalItem = function (_a) {\r\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\r\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"horizontalItem\"]).join(' ') }, children));\r\n};\r\n","import * as React from 'react';\r\nimport { LiveQueryView } from './live-query-view';\r\nexport function LazyContent(_a) {\r\n    var children = _a.children, spinner = _a.spinner, onError = _a.onError, noError = _a.noError;\r\n    return React.createElement(LiveQueryView, { props: children, spinner: spinner, noError: noError, onError: onError, fn: function (observable) { return observable; } });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { shallowEquals } from '../../utils/utils';\r\nexport function liveQueryView(fn, options) {\r\n    return function (props) {\r\n        return React.createElement(LiveQueryView, tslib_1.__assign({ props: props, fn: fn }, options));\r\n    };\r\n}\r\nvar LiveQueryView = /** @class */ (function (_super) {\r\n    tslib_1.__extends(LiveQueryView, _super);\r\n    function LiveQueryView(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            result: null,\r\n            isLoading: true\r\n        };\r\n        return _this;\r\n    }\r\n    LiveQueryView.prototype.componentDidMount = function () {\r\n        this.subscribe();\r\n    };\r\n    LiveQueryView.prototype.componentWillUnmount = function () {\r\n        this.unsubscribe();\r\n    };\r\n    LiveQueryView.prototype.shouldComponentUpdate = function (nextProps, nextState) {\r\n        return (this.state.error !== nextState.error ||\r\n            this.state.isLoading !== nextState.isLoading ||\r\n            this.state.result !== nextState.result ||\r\n            !shallowEquals(nextProps.props, this.props.props));\r\n    };\r\n    LiveQueryView.prototype.componentDidUpdate = function (prevProps) {\r\n        if (!shallowEquals(prevProps.props, this.props.props)) {\r\n            this.unsubscribe();\r\n            this.subscribe();\r\n        }\r\n    };\r\n    LiveQueryView.prototype.subscribe = function () {\r\n        var _this = this;\r\n        this.setState({ isLoading: true });\r\n        this.subscription = this.props.fn(this.props.props).subscribe(function (result, error) { return _this.setState({\r\n            result: result,\r\n            error: error,\r\n            isLoading: false\r\n        }); });\r\n    };\r\n    LiveQueryView.prototype.unsubscribe = function () {\r\n        if (this.subscription) {\r\n            this.subscription.unsubscribe();\r\n            this.subscription = null;\r\n        }\r\n    };\r\n    LiveQueryView.prototype.render = function () {\r\n        var _a = this.state, result = _a.result, error = _a.error, isLoading = _a.isLoading;\r\n        var _b = this.props, spinner = _b.spinner, onError = _b.onError, noError = _b.noError;\r\n        //if (!isLoading && !result) debugger;\r\n        return error ?\r\n            noError ? \"\" : onError ? onError(error) : React.createElement(\"p\", null,\r\n                \"Error: \",\r\n                error.message) :\r\n            isLoading ?\r\n                spinner ? spinner : \"\" :\r\n                result === undefined ? \"\" : result;\r\n    };\r\n    return LiveQueryView;\r\n}(React.Component));\r\nexport { LiveQueryView };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { liveQueryView } from './live-query-view';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport env from '../../globals/KED.env';\r\nexport var LoadingIndicator = liveQueryView(function () {\r\n    return env.kedBackendClient.http.status.combineLatest(env.edsClient.http.status)\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a, 2), kedBackendStatus = _b[0], edsStatus = _b[1];\r\n        return React.createElement(\"div\", { className: \"loading-indicator\" },\r\n            React.createElement(\"div\", { className: \"indicator\" }, kedBackendStatus.numOutstandingOperations > 0 || edsStatus.numOutstandingOperations > 0 ?\r\n                React.createElement(Spinner, null) : undefined));\r\n    });\r\n});\r\n","/* REFACTOR: Move this component outside coursebuilder!\r\n   This is a general-purpose component\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { GoalProgress } from '../charts/goal-progress';\r\nvar OpenCloseBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(OpenCloseBox, _super);\r\n    function OpenCloseBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    OpenCloseBox.prototype.componentWillReceiveProps = function (nextProps) {\r\n        if (nextProps.headerOpen !== this.props.headerOpen) {\r\n            this.setState({ headerOpen: nextProps.headerOpen });\r\n        }\r\n    };\r\n    OpenCloseBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, className = _a.className, children = _a.children, headerClassName = _a.headerClassName, contentClassName = _a.contentClassName, displayProgress = _a.displayProgress, progressData = _a.progressData, inactivated = _a.inactivated, inactivatedRender = _a.inactivatedRender;\r\n        var headerOpen = this.state.headerOpen;\r\n        if (inactivated)\r\n            return inactivatedRender === 'titleAndChildren' ? React.createElement(React.Fragment, null,\r\n                React.createElement(React.Fragment, null, title),\r\n                React.createElement(React.Fragment, null, children)) : React.createElement(React.Fragment, null, children);\r\n        //var currentProgressData = //progressData();\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\" + (headerClassName ? \" \" + headerClassName : \"\"), onClick: function () {\r\n                    if (_this.props.onOpenClose)\r\n                        _this.props.onOpenClose(!_this.state.headerOpen);\r\n                    _this.setState({ headerOpen: !_this.state.headerOpen });\r\n                } },\r\n                React.createElement(\"div\", { className: \"openHeaderContainer\" },\r\n                    React.createElement(\"div\", null, title),\r\n                    displayProgress && React.createElement(GoalProgress, tslib_1.__assign({}, progressData)))),\r\n            React.createElement(\"div\", { className: \"openContent\" + (contentClassName ? \" \" + contentClassName : \"\") }, children));\r\n    };\r\n    return OpenCloseBox;\r\n}(React.Component));\r\nexport { OpenCloseBox };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useState } from 'react';\r\nexport function taskHasMigratedTexts(task) {\r\n    return task.migratedTexts && Object.keys(task.migratedTexts).some(function (type) {\r\n        return Object.keys(task.migratedTexts[type]).length > 0;\r\n    });\r\n}\r\nexport function SortableTaskList(_a) {\r\n    var taskMetas = _a.taskMetas, renderEditLink = _a.renderEditLink, renderLink = _a.renderLink, onSort = _a.onSort;\r\n    var _b = tslib_1.__read(useState({\r\n        taskBeingDragged: null,\r\n        taskBeingHovered: null,\r\n        insertBefore: false,\r\n        originClientY: -1\r\n    }), 2), dragState = _b[0], setDragState = _b[1];\r\n    var taskBeingDragged = dragState.taskBeingDragged, taskBeingHovered = dragState.taskBeingHovered, insertBefore = dragState.insertBefore, originClientY = dragState.originClientY;\r\n    return React.createElement(\"div\", { className: \"taskContainer sortable\", onDrop: function (ev) {\r\n            if (taskBeingHovered && taskBeingDragged) {\r\n                onSort(taskBeingDragged, taskBeingHovered, insertBefore ? 'before' : 'after');\r\n            }\r\n            setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null, taskBeingDragged: null }));\r\n        } }, taskMetas.map(function (taskMeta) {\r\n        var task = taskMeta.task, isTaskOwner = taskMeta.isTaskOwner;\r\n        var hasMigratedTexts = taskHasMigratedTexts(task);\r\n        var taskId = task.id;\r\n        return React.createElement(React.Fragment, { key: taskId },\r\n            insertBefore && taskBeingHovered === task ?\r\n                React.createElement(\"div\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") :\r\n                null,\r\n            React.createElement(\"div\", { className: [\"align-horizontal\", \"draggable\", task === taskBeingDragged && \"drag-source\"].filter(function (x) { return x; }).join(' '), draggable: true, onDragStart: function (ev) {\r\n                    ev.dataTransfer.effectAllowed = \"move\";\r\n                    setDragState(tslib_1.__assign({}, dragState, { originClientY: ev.clientY, taskBeingDragged: task }));\r\n                }, onDragOver: function (ev) {\r\n                    if (!taskBeingDragged)\r\n                        return;\r\n                    if (taskBeingDragged === task) {\r\n                        setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null }));\r\n                        return;\r\n                    }\r\n                    ev.preventDefault();\r\n                    ev.dataTransfer.dropEffect = \"move\";\r\n                    setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: task, insertBefore: originClientY > ev.clientY }));\r\n                }, onDragEnd: function (ev) {\r\n                    setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null, taskBeingDragged: null }));\r\n                } },\r\n                isTaskOwner && hasMigratedTexts && React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"div\", { style: { position: 'relative', top: '0.2em', left: '-0.7em' } },\r\n                        React.createElement(\"i\", { className: \"fa fa-pagelines\", style: { position: 'absolute', top: 0, left: 0, color: '#49c35a' } }))),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, renderEditLink(taskMeta)),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, renderLink(taskMeta))),\r\n            !insertBefore && taskBeingHovered === task ?\r\n                React.createElement(\"div\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") :\r\n                null);\r\n    }));\r\n}\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>F</b>',\r\n        title: 'Fetstil',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>K</i>',\r\n        title: 'Kursiv',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Understruken',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Struken',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Rubrik 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Rubrik 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Rubrik 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraf',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Citat',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '<i class=\"fa fa-list-ol\" aria-hidden=\"true\"></i>',\r\n        title: 'Ordnad lista',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '<i class=\"fa fa-list\" aria-hidden=\"true\"></i>',\r\n        title: 'Punktlista',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Minska indrag',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'ka indrag',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Programkod',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Vgrt linje',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '<i class=\"fa fa-link\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga lnk',\r\n        result: function () {\r\n            var url = window.prompt('Ange lnkens URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '<i class=\"fa fa-picture-o\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga bild',\r\n        promptMsg: 'Ange bildens URL',\r\n        result: function (ev, component) {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url) {\r\n                //exec('insertImage', url);\r\n                var img = document.createElement(\"img\");\r\n                img.src = url;\r\n                img.tabIndex = 1;\r\n                insertElement(img);\r\n                img.onfocus = component.onFocus;\r\n                img.onblur = component.onBlur;\r\n                component.props.onChange(component.contentDiv.innerHTML);\r\n            }\r\n        }\r\n    }\r\n};\r\nfunction insertElement(element) {\r\n    var sel, range;\r\n    if (window.getSelection && (sel = window.getSelection()).rangeCount) {\r\n        range = sel.getRangeAt(0);\r\n        range.collapse(true);\r\n        range.insertNode(element);\r\n        // Move the caret immediately after the inserted span\r\n        range.setStartAfter(element);\r\n        range.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(range);\r\n    }\r\n}\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>B</b>',\r\n        title: 'Bold',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>I</i>',\r\n        title: 'Italic',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Underline',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Strike-through',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Heading 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Heading 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Heading 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraph',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Quote',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '&#35;',\r\n        title: 'Ordered List',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '&#8226;',\r\n        title: 'Unordered List',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Outdent',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'Indent',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Code',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Horizontal Line',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '&#128279;',\r\n        title: 'Link',\r\n        result: function () {\r\n            var url = window.prompt('Enter the link URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '&#128247;',\r\n        title: 'Image',\r\n        promptMsg: 'Enter the URL of the image',\r\n        result: function () {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url)\r\n                exec('insertImage', url);\r\n        }\r\n    }\r\n};\r\n","export default (function (command, value) {\r\n    if (value === void 0) { value = null; }\r\n    document.execCommand(command, false, value);\r\n});\r\n","export function patchElement(element) {\r\n    var modified = false;\r\n    if (element.tagName === \"A\") {\r\n        var href = element.getAttribute(\"href\");\r\n        var target = element.getAttribute(\"target\");\r\n        if (href) {\r\n            if (href.startsWith(\"javascript:\")) {\r\n                // Fix \"javascript:window.open('...')\" URLS\r\n                var url = href;\r\n                var windowOpen = \"window.open('\";\r\n                var pWindowOpen = url.indexOf(windowOpen);\r\n                if (pWindowOpen >= 0) {\r\n                    var urlEnd = url.substr(pWindowOpen + windowOpen.length);\r\n                    var pUrlEnd = urlEnd.indexOf(\"'\");\r\n                    if (pUrlEnd >= 0) {\r\n                        var newUrl = urlEnd.substr(0, pUrlEnd);\r\n                        element.setAttribute(\"href\", newUrl);\r\n                        element.setAttribute(\"target\", \"_blank\"); // The reason they use JS links is for opening in new tab\r\n                        modified = true;\r\n                    }\r\n                }\r\n            }\r\n            else if (href.startsWith(\"https://\") || href.startsWith(\"http://\")) {\r\n                try {\r\n                    var url = new URL(href);\r\n                    // Fix digilr URLs:\r\n                    if (url.host === \"xn--digilr-fua.se\") {\r\n                        if (url.search[0] === '?') {\r\n                            var pSecondQ = url.search.indexOf('?', 1);\r\n                            if (pSecondQ > 0) {\r\n                                url.search = url.search.substr(0, pSecondQ) + \"&\" + url.search.substr(pSecondQ + 1);\r\n                                element.setAttribute(\"href\", url.href);\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                    // Fix so that external URLS are opened in separate tabs\r\n                    if (location.hostname !== 'localhost') {\r\n                        if (url.host !== location.host) {\r\n                            if (!element.getAttribute(\"target\")) {\r\n                                element.setAttribute(\"target\", \"_blank\");\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                catch (error) {\r\n                    element.removeAttribute(\"a\");\r\n                    modified = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n","export default function imageEditActions(cb) {\r\n    return [{\r\n            name: 'float-left',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-right\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; left:-4px;top:0; transform: scale(0.5); transform-origin: left top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Lt bilden flyta vnster om text',\r\n            result: function () { return cb('float-left'); }\r\n        }, {\r\n            name: 'float-right',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-left\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; right:-4px;top:0; transform: scale(0.5); transform-origin: right top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Lt bilden flyta hger om text',\r\n            result: function () { return cb('float-right'); }\r\n        }, {\r\n            name: 'unfloat',\r\n            icon: \"<div style=\\\"position:relative;\\\" aria-hidden=\\\"true\\\">\\n      <div style=\\\"position:absolute;top:0;left:0\\\">&#8254;</div>\\n      <div style=\\\"position:absolute;top:0:left:0;transform: scale(0.5); transform-origin: left bottom\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n      <div style=\\\"position:absolute;top:0;left:0\\\">_</div>\\n    </div>\",\r\n            title: 'Placera bilden p egen rad',\r\n            result: function () { return cb('unfloat'); }\r\n        }];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport exec from './exec';\r\nimport { washHtml } from './wash-html';\r\nimport imageEditActions from './image-edit-actions';\r\nimport actions from './actions';\r\nvar classes = {\r\n    actionbar: 'wysiwyg-actionbar',\r\n    button: 'wysiwyg-button',\r\n    content: 'wysiwyg-content',\r\n    focusrect: 'wysiwyg-focusrect',\r\n    focuspoint: 'wysiwyg-focuspoint',\r\n    readonlyContent: 'wysiwyg-content readonly'\r\n};\r\nvar Wysiwyg = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Wysiwyg, _super);\r\n    function Wysiwyg(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { focusRect: null };\r\n        _this.onFocus = _this.onFocus.bind(_this);\r\n        _this.onBlur = _this.onBlur.bind(_this);\r\n        _this.onMouseDown = _this.onMouseDown.bind(_this);\r\n        _this.onMouseMove = _this.onMouseMove.bind(_this);\r\n        _this.onMouseUp = _this.onMouseUp.bind(_this);\r\n        return _this;\r\n    }\r\n    Wysiwyg.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        if (!this.props.readOnly) {\r\n            Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n                .forEach(function (elem) {\r\n                elem.tabIndex = 1;\r\n                elem.onfocus = _this.onFocus;\r\n                elem.onblur = _this.onBlur;\r\n            });\r\n        }\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.componentDidUpdate = function () {\r\n        var _this = this;\r\n        Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n            .forEach(function (elem) {\r\n            elem.tabIndex = 1;\r\n            elem.onfocus = _this.onFocus;\r\n            elem.onblur = _this.onBlur;\r\n        });\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.shouldComponentUpdate = function (nextProps, nextState) {\r\n        //this.contentDiv.onfocus = this.onFocus;\r\n        //this.contentDiv.onblur = this.onBlur;\r\n        return !this.contentDiv ||\r\n            nextState != this.state ||\r\n            nextProps.readOnly !== this.props.readOnly ||\r\n            washHtml(nextProps.html) !== washHtml(this.contentDiv.innerHTML);\r\n    };\r\n    Wysiwyg.prototype.triggerOnChange = function (html) {\r\n        this.props.onChange && this.props.onChange(washHtml(html));\r\n    };\r\n    Wysiwyg.prototype.onFocus = function (ev) {\r\n        var elem = ev.target;\r\n        if (!elem || !elem.tagName)\r\n            return;\r\n        if (elem.tagName !== 'IMG' && elem.tagName !== 'A')\r\n            return;\r\n        var contentParent = this.contentDiv.parentElement;\r\n        var newState = {\r\n            focusRect: getRelatativeClientRect(contentParent, elem),\r\n        };\r\n        switch (elem.tagName) {\r\n            case 'A':\r\n            case 'IMG':\r\n            default: break;\r\n        }\r\n        this.setState(newState);\r\n        this.focusElem = elem;\r\n    };\r\n    Wysiwyg.prototype.onBlur = function (ev) {\r\n        /*if (ev.relatedTarget) {\r\n          const relatedTarget = ev.relatedTarget as HTMLElement;\r\n          if (relatedTarget.className && relatedTarget.className.split(' ').indexOf(classes.button) >= 0) {\r\n            // A image action button was pressed\r\n            set\r\n            return;\r\n          }\r\n        }*/\r\n        if ((ev.target === this.focusElem && ev.relatedTarget !== this.focusRectDiv) ||\r\n            ev.target === this.focusRectDiv) {\r\n            this.setState({ focusRect: null });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.makeClickable = function (elem) {\r\n        elem.tabIndex = 1;\r\n    };\r\n    Wysiwyg.prototype.onMouseDown = function (ev) {\r\n        if ((ev.target.className || \"\").split(' ').indexOf(classes.focuspoint) >= 0) {\r\n            var corner = this.getRectCorner(ev);\r\n            this.corner = corner;\r\n            this.resizeStartX = ev.clientX;\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseMove = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            ev.preventDefault();\r\n            // TODO: Rkna ut baserat p this.corner hur bildens storlek borde ndras.\r\n            // Leta upp bilden per ID frn this.contentDiv\r\n            // Stt DIV:ens style attribut width till ny width.\r\n            // Om DIV:en redan hade height, stt ny height med samma aspect ratio som innan,\r\n            // annars, stt inte height alls (eller mjligtvis till auto))\r\n            var focusRect = this.focusRectDiv.getBoundingClientRect();\r\n            if (focusRect.width < 32)\r\n                return;\r\n            //const currentWidth = focusRect.width;\r\n            //const currentHeight = focusRect.height;\r\n            //const hasHeightStyle = !this.focusElem.style.height || this.focusElem.style.height === \"auto\";\r\n            var newWidth = Math.max(32, this.corner.endsWith('l') ?\r\n                focusRect.width + (this.resizeStartX - ev.clientX) :\r\n                //focusRect.right - ev.clientX :\r\n                focusRect.width - (this.resizeStartX - ev.clientX));\r\n            this.resizeStartX = ev.clientX;\r\n            //ev.clientX - focusRect.left;\r\n            var factor = newWidth / focusRect.width;\r\n            var newHeight = focusRect.height * factor;\r\n            this.focusElem.style.width = newWidth + \"px\";\r\n            this.focusElem.style.height = newHeight + \"px\";\r\n            this.setState({\r\n                focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem),\r\n            });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseUp = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            this.corner = null;\r\n            this.triggerOnChange(this.contentDiv.innerHTML);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.getRectCorner = function (ev) {\r\n        var e_1, _a;\r\n        try {\r\n            for (var _b = tslib_1.__values((ev.target.className || '').split(' ')), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var className = _c.value;\r\n                switch (className) {\r\n                    case 'fpul':\r\n                        return 'ul';\r\n                    case 'fpur':\r\n                        return 'fpur';\r\n                    case 'fplr':\r\n                        return 'lr';\r\n                    case 'fpll':\r\n                        return 'll';\r\n                }\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n        return null;\r\n    };\r\n    Wysiwyg.prototype.execImageEditAction = function (cmd) {\r\n        //console.log(cmd);\r\n        if (!this.focusElem)\r\n            return;\r\n        //console.log(\"doing it\");\r\n        switch (cmd) {\r\n            case 'float-left':\r\n                this.focusElem.style.cssFloat = 'left';\r\n                break;\r\n            case 'float-right':\r\n                this.focusElem.style.cssFloat = 'right';\r\n                break;\r\n            case 'unfloat':\r\n                this.focusElem.style.cssFloat = '';\r\n                break;\r\n        }\r\n        this.triggerOnChange(this.contentDiv.innerHTML);\r\n        this.setState({ focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem) });\r\n    };\r\n    Wysiwyg.prototype.render = function () {\r\n        var _this = this;\r\n        var defaultActions = this.props.defaultActions || actions;\r\n        var actionsToUse = this.props.actions ? this.props.actions.map(function (action) {\r\n            return typeof action === 'string' ?\r\n                defaultActions[action] :\r\n                defaultActions[action.name] ? tslib_1.__assign({}, defaultActions[action.name], action) :\r\n                    action;\r\n        })\r\n            : Object.keys(defaultActions).map(function (action) { return defaultActions[action]; });\r\n        if (this.state.focusRect) {\r\n            actionsToUse = actionsToUse.concat(imageEditActions(function (cmd) { return _this.execImageEditAction(cmd); }));\r\n        }\r\n        var focusRect = this.state.focusRect;\r\n        var _a = this.props, readOnly = _a.readOnly, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\r\n        return React.createElement(\"div\", { className: this.props.className },\r\n            !readOnly && React.createElement(\"div\", { className: classes.actionbar }, actionsToUse.map(function (action, idx) {\r\n                return React.createElement(\"button\", { key: idx, className: classes.button, dangerouslySetInnerHTML: { __html: action.icon }, title: action.title, onMouseDown: function (ev) { action.result(ev, _this); }, onMouseUp: function (ev) { return setTimeout(function () { return _this.contentDiv.focus(); }, 10); } });\r\n            })),\r\n            React.createElement(\"div\", { className: readOnly ? classes.readonlyContent : classes.content, style: { position: 'relative', top: 0, left: 0 }, onMouseMove: this.onMouseMove, onMouseDown: this.onMouseDown, onMouseUp: this.onMouseUp },\r\n                React.createElement(\"div\", { className: \"editor\", ref: function (div) { return _this.contentDiv = div; }, dangerouslySetInnerHTML: { __html: washHtml(this.props.html) }, contentEditable: !readOnly, onPaste: function (ev) {\r\n                        if (!isNaN(maxChars)) {\r\n                            var target = ev.target, currentTarget = ev.currentTarget;\r\n                            //const textBeingOverwritten = (target as any).innerText || \"\";\r\n                            var editorText = (currentTarget && currentTarget.innerText) || \"\";\r\n                            var textBeingPasted = ev.clipboardData.getData(\"text/plain\") || \"\";\r\n                            if (editorText.length + textBeingPasted.length > maxChars) {\r\n                                ev.preventDefault();\r\n                            }\r\n                        }\r\n                    }, onKeyUp: reportNumChars ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        reportNumChars(innerText ? innerText.length : 0);\r\n                    } : null, onKeyPress: !isNaN(maxChars) ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        if (innerText && innerText.length >= maxChars) {\r\n                            ev.preventDefault();\r\n                        }\r\n                    } : null, onInput: function (ev) { return _this.triggerOnChange(ev.target.innerHTML); }, onKeyDown: function (ev) {\r\n                        if (readOnly)\r\n                            return;\r\n                        if (reportNumChars && ev.currentTarget) {\r\n                            reportNumChars((ev.currentTarget.innerText || \"\").length);\r\n                        }\r\n                        //console.log(\"Key: \" + ev.which);\r\n                        if (ev.which >= 35 && ev.which <= 40) { // home/end/up/down/left/right\r\n                            ev.stopPropagation(); // Prevent entire page from scrolling??\r\n                        }\r\n                        if (ev.which === 9) {\r\n                            ev.preventDefault(); // TAB\r\n                            if (ev.shiftKey) {\r\n                                exec(\"outdent\");\r\n                            }\r\n                            else {\r\n                                exec(\"indent\");\r\n                            }\r\n                        }\r\n                        if ((ev.keyCode === 8 || ev.keyCode === 46) && // Delete or Back buttons\r\n                            _this.focusElem && _this.state.focusRect) {\r\n                            if (_this.focusElem && _this.focusElem.parentElement) {\r\n                                _this.focusElem.parentElement.removeChild(_this.focusElem); // Remove marked image\r\n                            }\r\n                            _this.focusElem = null;\r\n                            _this.setState({ focusRect: null });\r\n                            _this.triggerOnChange(_this.contentDiv.innerHTML);\r\n                        }\r\n                    } }),\r\n                focusRect && React.createElement(\"div\", { ref: function (div) { return _this.focusRectDiv = div; }, className: classes.focusrect, onBlur: this.onBlur, tabIndex: 1, style: {\r\n                        outline: 0,\r\n                        position: 'absolute',\r\n                        top: this.state.focusRect.top,\r\n                        left: this.state.focusRect.left,\r\n                        width: this.state.focusRect.width,\r\n                        height: this.state.focusRect.height\r\n                    } },\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpul\", style: { position: 'absolute', top: 0, left: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpur\", style: { position: 'absolute', top: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fplr\", style: { position: 'absolute', bottom: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpll\", style: { position: 'absolute', bottom: 0, left: 0 } }))));\r\n    };\r\n    return Wysiwyg;\r\n}(React.Component));\r\nexport { Wysiwyg };\r\nfunction getRelatativeClientRect(parent, child) {\r\n    var parentRect = parent.getBoundingClientRect();\r\n    var childRect = child.getBoundingClientRect();\r\n    return {\r\n        top: childRect.top - parentRect.top + parent.scrollTop,\r\n        left: childRect.left - parentRect.left + parent.scrollLeft,\r\n        bottom: childRect.bottom - parentRect.top + parent.scrollTop,\r\n        right: childRect.right - parentRect.left + parent.scrollLeft,\r\n        width: childRect.width,\r\n        height: childRect.height\r\n    };\r\n}\r\n","export function saveSelection() {\r\n    if (window.getSelection) {\r\n        var sel = window.getSelection();\r\n        if (sel.getRangeAt && sel.rangeCount) {\r\n            return sel.getRangeAt(0);\r\n        }\r\n    }\r\n    else if (document[\"selection\"] && document[\"selection\"].createRange) {\r\n        return document[\"selection\"].createRange();\r\n    }\r\n    return null;\r\n}\r\nexport function restoreSelection(range) {\r\n    if (range) {\r\n        if (window.getSelection) {\r\n            var sel = window.getSelection();\r\n            sel.removeAllRanges();\r\n            sel.addRange(range);\r\n        }\r\n        else if (document[\"selection\"] && range.select) {\r\n            range.select();\r\n        }\r\n    }\r\n}\r\n","import { patchElement } from './html-patch-policy';\r\nvar parser = new DOMParser();\r\n/** Tags / Attributes Whitelist\r\n *\r\n */\r\nvar HTML_WASH_POLICY = {\r\n    b: {},\r\n    i: {},\r\n    p: {},\r\n    u: {},\r\n    strike: {},\r\n    pre: {},\r\n    h1: {},\r\n    h2: {},\r\n    h3: {},\r\n    h4: {},\r\n    h5: {},\r\n    img: { src: true, class: true, style: true, tabindex: true },\r\n    a: { href: true, target: true, tabindex: true },\r\n    ul: {},\r\n    ol: {},\r\n    li: {},\r\n    hr: {},\r\n    br: {},\r\n    div: {},\r\n    span: {},\r\n    // table tags:\r\n    table: { border: true },\r\n    tbody: {},\r\n    thead: {},\r\n    tfoot: {},\r\n    tr: {},\r\n    td: { headers: true, colspan: true, rowspan: true },\r\n    th: { abbr: true, headers: true, scope: true, sorted: true, colspan: true, rowspan: true }\r\n};\r\nexport function washHtml(html) {\r\n    var doc = parser.parseFromString(html, \"text/html\");\r\n    var childNodes = doc.body.childNodes;\r\n    var modified = false;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified ?\r\n        doc.body.innerHTML :\r\n        html; // By returning the original HTML string, we spare the user from refreshing the edit area,\r\n    // which would otherwise put the cursor at the top, losing the position where user where.\r\n}\r\nfunction washNode(node) {\r\n    var modified = false;\r\n    if (isElement(node)) {\r\n        if (washElement(node)) {\r\n            modified = true;\r\n        }\r\n    }\r\n    if (washChildNodes(node)) {\r\n        modified = true;\r\n    }\r\n    return modified;\r\n}\r\nfunction washChildNodes(node) {\r\n    var modified = false;\r\n    var childNodes = node.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n/** Replace an element with its child nodes.\r\n *\r\n */\r\nfunction removeMiddleElement(element) {\r\n    var childNodes = element.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        element.parentNode.insertBefore(childNodes.item(i), element);\r\n    }\r\n    element.remove();\r\n}\r\nfunction washElement(element) {\r\n    var modified = patchElement(element);\r\n    var policy = element.tagName && HTML_WASH_POLICY[element.tagName.toLowerCase()];\r\n    if (!policy) {\r\n        console.warn(\"Wysiwyg: not allowed tag\", element.tagName);\r\n        washChildNodes(element);\r\n        removeMiddleElement(element);\r\n        return true;\r\n    }\r\n    for (var i = 0; i < element.attributes.length; ++i) {\r\n        var attr = element.attributes.item(i);\r\n        var allowed = attr.name && !!policy[attr.name.toLowerCase()];\r\n        if (!allowed) {\r\n            modified = true;\r\n            console.warn(\"Wysiwyg: not allowed attribute\", attr.name, \"Tag: \", element.tagName);\r\n            element.removeAttribute(attr.name);\r\n        }\r\n    }\r\n    return modified;\r\n}\r\nfunction isElement(node) {\r\n    return !!node.tagName;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { env } from '../../globals/KED.env';\r\nvar AddCustomGoal = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddCustomGoal, _super);\r\n    function AddCustomGoal(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            learningGoal: props.learningGoal || ''\r\n        };\r\n        return _this;\r\n    }\r\n    AddCustomGoal.prototype.render = function () {\r\n        var _this = this;\r\n        var learningGoal = this.state.learningGoal;\r\n        var onSave = this.props.onSave;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till rubrik\" }) :\r\n                    React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget l\\u00E4randem\\u00E5l\" })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalGymnasiumSchool\", defaultMessage: \"Rubrik\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.addLearningGoalPrimarySchool\", defaultMessage: \"M\\u00E5l\" })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, autoFocus: true, value: learningGoal, onChange: function (e) { return _this.setState({ learningGoal: e.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(learningGoal); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"save\" }))));\r\n    };\r\n    return AddCustomGoal;\r\n}(React.Component));\r\nexport { AddCustomGoal };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { env } from '../../globals/KED.env';\r\nvar AddCustomTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddCustomTask, _super);\r\n    function AddCustomTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            name: '',\r\n            description: '',\r\n            url: ''\r\n        };\r\n        return _this;\r\n    }\r\n    AddCustomTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        var _b = this.props, isTask = _b.isTask, onSave = _b.onSave;\r\n        var intl = this.context.intl;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalGymnasiumSchoolTitle\", defaultMessage: \"L\\u00E4gg till uppgift\" }) :\r\n                    React.createElement(FormattedMessage, { id: \"customTask.addWorkGoalPrimarySchoolTitle\", defaultMessage: \"L\\u00E4gg till eget arbetsm\\u00E5l\" })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.nameLabel', defaultMessage: 'Namn' }), id: \"AddCustomTask:name\", placeholder: intl.formatMessage({ id: 'customTask.enterNamePlhd', defaultMessage: 'Ange namn...' }), value: name, autoFocus: true, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n                React.createElement(TextAreaFormField, { rows: 7, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddCustomTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: \"Lgg till en beskrivning...\" }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Lnk' }), id: \"AddCustomTask:url\", placeholder: \"http://www...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return onSave(name, description, url); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\r\n    };\r\n    AddCustomTask.contextType = LanguageContext;\r\n    return AddCustomTask;\r\n}(React.Component));\r\nexport { AddCustomTask };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nvar AddOrEditSubTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(AddOrEditSubTask, _super);\r\n    function AddOrEditSubTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        if (props.mode === 'edit') {\r\n            var subTask = props.subTask;\r\n            _this.state = {\r\n                name: subTask.name || '',\r\n                description: subTask.description || '',\r\n                url: subTask.url || ''\r\n            };\r\n        }\r\n        else {\r\n            _this.state = {\r\n                name: '',\r\n                description: '',\r\n                url: ''\r\n            };\r\n        }\r\n        return _this;\r\n    }\r\n    AddOrEditSubTask.prototype.save = function () {\r\n        // Update repo:\r\n        var props = this.props;\r\n        var userTask = props.userTask, closeDialog = props.closeDialog, userTasksRepo = props.userTasksRepo;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        if (props.mode === 'edit') {\r\n            // Edit existing:\r\n            userTasksRepo.update([userTask], function (ut) {\r\n                var subTasks = ut.subTasks;\r\n                if (subTasks) {\r\n                    ut.subTasks = subTasks.map(function (st) {\r\n                        return st.id === props.subTask.id ? tslib_1.__assign({}, st, { name: name, description: description, url: url }) : tslib_1.__assign({}, st);\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            // Create new task\r\n            var newSubTask_1 = {\r\n                id: createUUID(),\r\n                name: name,\r\n                description: description,\r\n                url: url\r\n            };\r\n            // Update repo:\r\n            userTasksRepo.update([userTask], function (ut) {\r\n                if (!ut.subTasks) {\r\n                    ut.subTasks = [];\r\n                }\r\n                ut.subTasks = ut.subTasks.concat(newSubTask_1);\r\n            });\r\n        }\r\n        // Close dialog\r\n        closeDialog();\r\n    };\r\n    AddOrEditSubTask.prototype.delete = function () {\r\n        // Update repo:\r\n        var props = this.props;\r\n        if (props.mode !== 'edit') {\r\n            throw new Error(\"Can only delete in edit mode\");\r\n        }\r\n        props.userTasksRepo.update([props.userTask], function (ut) {\r\n            if (ut.subTasks) {\r\n                ut.subTasks = ut.subTasks.filter(function (t) { return t.id !== props.subTask.id; });\r\n            }\r\n        });\r\n        // Close dialog:\r\n        props.closeDialog();\r\n    };\r\n    AddOrEditSubTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url;\r\n        var props = this.props;\r\n        var isEditMode = props.mode === 'edit';\r\n        var intl = this.context.intl;\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, isEditMode ? React.createElement(FormattedMessage, { id: \"addeditsubtask.editSubtask\", defaultMessage: 'Redigera underuppgift' }) : React.createElement(FormattedMessage, { id: \"addeditsubtask.addSubtask\", defaultMessage: 'L\\u00E4gg till underuppgift' })),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(TextInput, { autoFocus: true, label: intl.formatMessage({ id: 'addeditsubtask.nameLabel', defaultMessage: 'Underuppgiftens namn' }), id: \"AddUserSubTask:name\", placeholder: \"\", value: this.state.name, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n                React.createElement(TextAreaFormField, { label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"AddUserSubTask:description\", rows: 7, placeholder: \"\", value: this.state.description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: 'Lnk' }), id: \"AddUserSubTask:url\", placeholder: \"\", value: this.state.url, onChange: function (url) { return _this.setState({ url: url }); } }),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                props.mode === 'edit' && React.createElement(\"button\", { className: \"btn btn-warning btn-large pull-right\", onClick: function (ev) { return _this.delete(); } },\r\n                    React.createElement(FormattedMessage, { id: \"addeditsubtask.deleteSubtask\", defaultMessage: \"Ta bort underuppgift\" })),\r\n                React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-large btn-default\", onClick: function () { return _this.save(); } },\r\n                    React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))));\r\n    };\r\n    AddOrEditSubTask.contextType = LanguageContext;\r\n    return AddOrEditSubTask;\r\n}(React.Component));\r\nexport { AddOrEditSubTask };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { getTaskType } from './get-task-type';\r\nimport ReactDatePicker from 'react-datepicker';\r\nimport '../../globals/moment-sv-locale';\r\nimport { TextInput } from '../utility-components/form-field-text-input';\r\nimport moment from 'moment';\r\nimport { FormField } from '../utility-components/form-field';\r\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\r\nimport { TextAreaFormField } from '../utility-components/form-field-textarea';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from \"../utility-components/LanguageContext\";\r\nvar EditUserTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditUserTask, _super);\r\n    function EditUserTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTask: props.userTask,\r\n            name: props.userTask.name,\r\n            description: props.userTask.description,\r\n            url: props.userTask.url,\r\n            deadline: props.userTask.deadline,\r\n            subTasks: props.userTask.subTasks\r\n        };\r\n        _this.onUserTasksChanged = _this.onUserTasksChanged.bind(_this);\r\n        return _this;\r\n    }\r\n    EditUserTask.prototype.componentDidMount = function () {\r\n        this.props.userTasksRepo.subscribe(this.onUserTasksChanged);\r\n    };\r\n    EditUserTask.prototype.onUserTasksChanged = function (userTasks) {\r\n        var _this = this;\r\n        var myUserTask = userTasks.find(function (ut) { return ut.id === _this.props.userTask.id; });\r\n        if (!myUserTask) {\r\n            this.props.closeDialog();\r\n            return;\r\n        }\r\n        this.setState({\r\n            userTask: myUserTask,\r\n            subTasks: myUserTask.subTasks\r\n        });\r\n    };\r\n    EditUserTask.prototype.componentWillUnmount = function () {\r\n        this.props.userTasksRepo.unsubscribe(this.onUserTasksChanged);\r\n    };\r\n    EditUserTask.prototype.isModified = function () {\r\n        // Don't count subtask changes! They live their own life and is maintained\r\n        // in add-or-edit-sub-task.tsx. Reason: User would expect added /edited subtasks\r\n        // to be persisted right away. May click away this dialog.\r\n        // Also reason: Can invoke that dialog by itself from other components. From WeekPlanner\r\n        // when clicking the subtask for example!\r\n        var _a = this.state, deadline = _a.deadline, description = _a.description, name = _a.name, url = _a.url, userTask = _a.userTask;\r\n        return (deadline !== userTask.deadline ||\r\n            description !== userTask.description ||\r\n            name !== userTask.name ||\r\n            url !== userTask.url);\r\n    };\r\n    EditUserTask.prototype.addSubTask = function () {\r\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"add\", userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\r\n    };\r\n    EditUserTask.prototype.editSubTask = function (subTask) {\r\n        this.props.openDialog(React.createElement(AddOrEditSubTask, { mode: \"edit\", subTask: subTask, userTask: this.state.userTask, closeDialog: this.props.closeDialog, userTasksRepo: this.props.userTasksRepo }));\r\n    };\r\n    EditUserTask.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, name = _a.name, description = _a.description, url = _a.url, deadline = _a.deadline, subTasks = _a.subTasks, showCalendar = _a.showCalendar, userTask = _a.userTask;\r\n        var id = userTask.id, courseName = userTask.courseName;\r\n        var _b = this.props, onUpdate = _b.onUpdate, onDelete = _b.onDelete;\r\n        var isModified = this.isModified();\r\n        var taskType = getTaskType(userTask);\r\n        var isCustomTask = taskType === 'customTask';\r\n        var expired = moment(userTask.deadline) < moment();\r\n        var intl = this.context.intl;\r\n        return React.createElement(\"div\", { className: \"editTaskDialog sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n            React.createElement(\"h2\", null, isCustomTask ?\r\n                React.createElement(FormattedMessage, { id: \"task.editWorkGoals\", defaultMessage: 'Redigera arbetsm\\u00E5l' }) :\r\n                React.createElement(FormattedMessage, { id: \"task.editTask\", defaultMessage: 'Redigera uppgift' })),\r\n            React.createElement(\"hr\", null),\r\n            React.createElement(TextInput, { autoFocus: true, label: isCustomTask ? intl.formatMessage({ id: 'task.targetNameLabel', defaultMessage: 'Arbetsmlets namn' }) : intl.formatMessage({ id: 'task.taskNameLabel', defaultMessage: 'Uppgiftens namn' }), id: \"EditUserTask:name\", placeholder: isCustomTask ? intl.formatMessage({ id: 'task.whatShouldYouDoPlhd', defaultMessage: 'Vad ska du gra?' }) : intl.formatMessage({ id: 'task.enterTaskNamePlhd', defaultMessage: 'Ange uppgiftens namn...' }), value: name, onChange: function (name) { return _this.setState({ name: name }); } }),\r\n            isCustomTask && React.createElement(React.Fragment, null,\r\n                React.createElement(TextAreaFormField, { rows: 5, label: intl.formatMessage({ id: 'common.descriptionLabel', defaultMessage: 'Beskrivning' }), id: \"EditUserTask:description\", placeholder: intl.formatMessage({ id: 'common.addDescriptionPlhd', defaultMessage: 'Lgg till en beskrivning...' }), value: description, onChange: function (description) { return _this.setState({ description: description }); } }),\r\n                React.createElement(TextInput, { label: intl.formatMessage({ id: 'common.linkLabel', defaultMessage: \"Lnk\" }), id: \"EdutUserTask:url\", placeholder: \"http(s)://...\", value: url, onChange: function (url) { return _this.setState({ url: url }); } })),\r\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.setDeadline', defaultMessage: 'Ange deadline' }) }, (deadline || showCalendar) ?\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(ReactDatePicker, { ref: function (elem) { return _this.datePicker = elem; }, id: \"EditUserTask:deadline\", nextMonthButtonLabel: \"\", previousMonthButtonLabel: \"\", showWeekNumbers: true, selected: deadline && moment(deadline).toDate(), autoFocus: showCalendar, dateFormat: \"yyyy-MM-dd\", className: expired ? \"expired\" : undefined, locale: intl.locale, popperPlacement: isCustomTask ? \"top-start\" : \"bottom-start\", onBlur: function () { return _this.setState({ showCalendar: false }); }, onChange: function (value) {\r\n                                _this.setState({\r\n                                    deadline: value && moment(value).format(\"YYYY-MM-DD\"),\r\n                                    showCalendar: false\r\n                                });\r\n                            } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { className: \"deleteDate\", href: \"#\", title: intl.formatMessage({ id: 'task.removeDeadline', defaultMessage: 'Ta bort deadline' }), onClick: function (ev) {\r\n                                ev.preventDefault();\r\n                                _this.setState({ deadline: null, showCalendar: false });\r\n                            } }))) :\r\n                React.createElement(\"div\", { className: \"top\", ref: function () { _this.datePicker = null; } },\r\n                    React.createElement(\"a\", { className: \"btn\", onClick: function (ev) {\r\n                            if (_this.datePicker) {\r\n                                _this.datePicker.setOpen(true);\r\n                            }\r\n                            _this.setState({\r\n                                showCalendar: true\r\n                            });\r\n                        } },\r\n                        React.createElement(\"i\", { className: \"fa fa-calendar\", \"aria-hidden\": \"true\" }),\r\n                        React.createElement(FormattedMessage, { id: \"task.setDeadlineLabel\", defaultMessage: \"Ange deadline...\" })))),\r\n            React.createElement(FormField, { label: intl.formatMessage({ id: 'task.subTasks', defaultMessage: 'Underuppgifter' }) },\r\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\r\n                    React.createElement(\"div\", { className: \"taskContainer\" }, subTasks && subTasks.map(function (subTask) { return React.createElement(\"div\", { key: subTask.id, className: \"align-horizontal\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                            React.createElement(\"a\", { onClick: function () { return _this.editSubTask(subTask); }, href: \"#\" }, subTask.name))); }))),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"top\" },\r\n                        React.createElement(\"button\", { id: \"EditUserTask:addSubTask\", className: \"btn\", onClick: function () { return _this.addSubTask(); } },\r\n                            React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                            \" \",\r\n                            React.createElement(FormattedMessage, { id: \"task.addSubtask\", defaultMessage: \"L\\u00E4gg till underuppgift\" }))))),\r\n            React.createElement(\"div\", { className: \"divider large\" }),\r\n            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-default\", onClick: function () {\r\n                            isModified ? onUpdate(function (userTask) {\r\n                                userTask.name = name;\r\n                                userTask.description = description;\r\n                                userTask.url = url;\r\n                                userTask.deadline = deadline;\r\n                            }) : _this.props.closeDialog();\r\n                        } },\r\n                        React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \"Spara\" }))),\r\n                React.createElement(\"div\", { className: \"horizontalButton top\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn\", onClick: function () {\r\n                            _this.props.closeDialog();\r\n                        } },\r\n                        React.createElement(FormattedMessage, { id: \"common.cancel\", defaultMessage: \"Avbryt\" }))),\r\n                React.createElement(\"div\", { className: \"confirm top pull-right\" },\r\n                    React.createElement(\"button\", { tabIndex: 1, className: \"btn btn-warning\", onClick: function () {\r\n                            onDelete(id);\r\n                        } }, isCustomTask ?\r\n                        React.createElement(FormattedMessage, { id: \"task.removeWorkGoals\", defaultMessage: \"Ta bort arbetsm\\u00E5l\" }) :\r\n                        React.createElement(FormattedMessage, { id: \"task.removeThisTask\", defaultMessage: \"Ta bort den h\\u00E4r uppgiften\" })))));\r\n    };\r\n    EditUserTask.contextType = LanguageContext;\r\n    return EditUserTask;\r\n}(React.Component));\r\nexport { EditUserTask };\r\n","export function getTaskType(userTask) {\r\n    return userTask.course && userTask.task && userTask.course.length > 0 && userTask.task.length > 0 ?\r\n        'courseBuilderTask' :\r\n        userTask.siteVisionPageId ?\r\n            'siteVisionTask' :\r\n            userTask.courseInfo ?\r\n                'subjectPlannerTask' :\r\n                'customTask';\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { arrayToLookup, compareProp } from \"../../utils/utils\";\r\nexport function refine(tasks) {\r\n    var e_1, _a, e_2, _b;\r\n    var result = [];\r\n    var mapper = {};\r\n    var tasksPerCourse = arrayToLookup(tasks, function (t) { return t.courseName || ''; });\r\n    try {\r\n        for (var _c = tslib_1.__values(Object.keys(tasksPerCourse).sort().filter(function (x) { return x; }).concat(tasksPerCourse[''] ?\r\n            [''] : [])), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n            var courseName = _d.value;\r\n            var courseTasks = tasksPerCourse[courseName] || tasksPerCourse[''];\r\n            var tasksPerLearningGoal = arrayToLookup(courseTasks, function (t) { return t.learningGoal; });\r\n            var resultLearningGoals = [];\r\n            try {\r\n                for (var _e = (e_2 = void 0, tslib_1.__values(Object.keys(tasksPerLearningGoal))), _f = _e.next(); !_f.done; _f = _e.next()) {\r\n                    var learningGoal = _f.value;\r\n                    var lgTasks = tasksPerLearningGoal[learningGoal].sort(compareProp(\"dateTime\"));\r\n                    var learningGoalTask = lgTasks\r\n                        .filter(function (t) { return t.name == null; }) // If name is undefined or null, this represents a learning goal\r\n                    [0];\r\n                    var url = learningGoalTask && learningGoalTask.url;\r\n                    resultLearningGoals.push({\r\n                        name: learningGoal,\r\n                        allTasks: lgTasks,\r\n                        url: url,\r\n                        step: lgTasks.map(function (t) { return t.step; }).filter(function (step) { return step; })[0],\r\n                        tasks: lgTasks.filter(function (t) { return t.name; })\r\n                    });\r\n                }\r\n            }\r\n            catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n            finally {\r\n                try {\r\n                    if (_f && !_f.done && (_b = _e.return)) _b.call(_e);\r\n                }\r\n                finally { if (e_2) throw e_2.error; }\r\n            }\r\n            result.push({\r\n                courseName: courseName,\r\n                learningGoals: resultLearningGoals\r\n            });\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from '../utility-components/open-close-box';\r\nimport { preserveImpersonationQuery } from '../../access-control';\r\nimport { courseNameToCssClass } from '../calendar/course-name-to-css-class';\r\nimport { getTaskType } from './get-task-type';\r\nimport moment from 'moment';\r\nimport { Features } from '../../features';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { env } from '../../globals/KED.env';\r\n;\r\nvar UserTasksBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UserTasksBox, _super);\r\n    function UserTasksBox(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    UserTasksBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, courseName = _a.courseName, learningGoals = _a.learningGoals, progressData = _a.progressData, displayProgress = _a.displayProgress;\r\n        var isOpen = !!this.props.openCourses[courseName];\r\n        var features = new Features();\r\n        var intl = this.context.intl;\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null, courseName || (isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"userTasks.gymnasiumSchoolGoals\", defaultMessage: \"\\u00D6vriga uppgifter\" }) : React.createElement(FormattedMessage, { id: \"userTasks.primarySchoolGoals\", defaultMessage: \"Egna l\\u00E4randem\\u00E5l\" }))), headerOpen: isOpen, className: courseName && courseNameToCssClass('wp-course-', courseName), onOpenClose: function (becameOpen) { return _this.props.setIsOpen(courseName, becameOpen); }, displayProgress: displayProgress, progressData: progressData }, learningGoals.map(function (lg) {\r\n            return React.createElement(\"div\", { key: lg.name, className: \"learningGoalContainer\" },\r\n                lg.step && React.createElement(\"div\", { className: \"stepIndicator\" }, lg.step),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"learningGoalText horizontalItem top\" }, lg.name),\r\n                    React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                        \"\\u00A0\",\r\n                        React.createElement(\"a\", { className: \"trash\", href: \"#\", title: intl.formatMessage({ id: 'userTasks.deleteLearningGoal', defaultMessage: 'Ta bort lrandemlet och dess uppgifter' }), onClick: function (ev) {\r\n                                ev.preventDefault();\r\n                                _this.props.removeLearningGoal(lg);\r\n                            } },\r\n                            React.createElement(\"i\", { className: \"fa fa-trash\" })))),\r\n                React.createElement(\"div\", { className: \"learningGoalTasks\" },\r\n                    React.createElement(\"div\", { className: \"taskContainer\" }, lg.tasks.map(function (userTask) {\r\n                        var isWorking = userTask.$meta === 'adding' || userTask.$meta === 'deleting' || userTask.$meta === 'updating';\r\n                        var taskType = getTaskType(userTask);\r\n                        var expired = moment(userTask.deadline).startOf('day') < moment().startOf('day');\r\n                        return React.createElement(\"div\", { key: userTask.id, style: isWorking ? { opacity: 0.5 } : {} },\r\n                            React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                    React.createElement(\"div\", { className: \"checkBox\" + (userTask.done ? \" checked\" : \"\"), onClick: function (ev) { return !isWorking && _this.props.setTaskDone(userTask, !userTask.done); } })),\r\n                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                    taskType === 'courseBuilderTask' ?\r\n                                        React.createElement(\"a\", { href: getTaskUrl(userTask, _this.props.viewCourseUrl) }, userTask.name) :\r\n                                        taskType === 'subjectPlannerTask' ?\r\n                                            React.createElement(\"a\", { href: getSubjectPlannerTaskUrl(userTask) }, userTask.name) :\r\n                                            taskType === 'siteVisionTask' ?\r\n                                                React.createElement(\"a\", { href: userTask.url }, userTask.name) :\r\n                                                React.createElement(\"a\", { className: !userTask.url ? \"link-less\" : \"\", href: userTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\r\n                                                        \"_self\" :\r\n                                                        \"_blank\" }, userTask.name),\r\n                                    userTask.deadline && React.createElement(\"div\", { className: \"dateSet\" + (expired ? ' expired' : '') },\r\n                                        React.createElement(\"i\", { title: moment(userTask.deadline).format(\"YYYY-MM-DD\"), className: \"fa fa-calendar\", \"aria-hidden\": \"true\", onClick: function () { } }))),\r\n                                React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\r\n                                    React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editTask(userTask); } }))),\r\n                            userTask.subTasks && React.createElement(\"div\", { className: \"subtasks\" }, userTask.subTasks.map(function (subTask) {\r\n                                return React.createElement(\"div\", { key: subTask.id },\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                        React.createElement(\"div\", { className: \"checkBox\" + (subTask.done ? \" checked\" : \"\"), onClick: function (ev) {\r\n                                                return !isWorking &&\r\n                                                    _this.props.setSubTaskDone(userTask, subTask, !subTask.done);\r\n                                            } })),\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                        React.createElement(\"a\", { href: subTask.url || undefined, target: (userTask.url + '').toLowerCase().startsWith(location.host.toLowerCase()) ?\r\n                                                \"_self\" :\r\n                                                \"_blank\", className: subTask.url ?\r\n                                                undefined :\r\n                                                'link-less' }, subTask.name)),\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top taskEdit\" },\r\n                                        React.createElement(\"a\", { className: \"editItem\", onClick: function () { return _this.props.editSubTask(userTask, subTask); } })));\r\n                            })));\r\n                    }))),\r\n                React.createElement(\"div\", { className: \"learningGoalTools\" },\r\n                    React.createElement(\"div\", { className: \"btn addOwnGoal\", onClick: function () { return _this.props.addOwnTask(_this.props.courseName, lg.name); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": \"true\" }),\r\n                        \" \",\r\n                        isGymnasiumStudent ?\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) :\r\n                            React.createElement(FormattedMessage, { id: 'userTasks.addLearningGoal', defaultMessage: 'Eget arbetsm\\u00E5l' }))),\r\n                React.createElement(\"br\", null));\r\n        }));\r\n    };\r\n    UserTasksBox.contextType = LanguageContext;\r\n    return UserTasksBox;\r\n}(React.Component));\r\nexport { UserTasksBox };\r\nfunction getTaskUrl(userTask, viewCourseUrl) {\r\n    if (userTask.course && userTask.course.length > 0 && userTask.task && userTask.task.length > 0) {\r\n        var courseUrl = preserveImpersonationQuery(viewCourseUrl, { courseId: userTask.course[0].id });\r\n        return courseUrl + \"#/task/\" + userTask.task[0].id;\r\n    }\r\n    return userTask.url;\r\n}\r\nfunction getSubjectPlannerTaskUrl(userTask) {\r\n    if (userTask.courseInfo && userTask.task && userTask.task.length > 0) {\r\n        var _a = userTask.courseInfo, school = _a.school, course = _a.course, tab = _a.tab;\r\n        var courseUrl = preserveImpersonationQuery(cfg.KED_SUBJECT_PLANNER_URL, {});\r\n        return courseUrl + \"#/\" + school + \"/courses/\" + course + \"/tabs/\" + tab + \"/tasks/\" + userTask.task[0].id;\r\n    }\r\n    return userTask.url;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nimport { localMoment } from '../../globals/moment-sv-locale';\r\nvar WeekPlannerPersistedState = /** @class */ (function () {\r\n    function WeekPlannerPersistedState(userOrCopy) {\r\n        if (typeof userOrCopy === 'string') {\r\n            this.user = userOrCopy;\r\n            this.lastWrite = Date.now();\r\n            this.weekDate = localMoment().startOf('week').valueOf();\r\n            this.openCourses = {};\r\n        }\r\n        else {\r\n            Object.assign(this, userOrCopy);\r\n        }\r\n    }\r\n    WeekPlannerPersistedState.load = function (user) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var cookie, storedData, state;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                cookie = localStorage.getItem('WeekPlannerPersistedState2');\r\n                storedData = cookie && JSON.parse(cookie);\r\n                state = new WeekPlannerPersistedState(user);\r\n                if (storedData)\r\n                    Object.assign(state, storedData);\r\n                return [2 /*return*/, state.user === user && !state.isExpired(moment()) ?\r\n                        state : new WeekPlannerPersistedState(user)];\r\n            });\r\n        });\r\n    };\r\n    WeekPlannerPersistedState.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var json;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.lastWrite = Date.now();\r\n                json = JSON.stringify(this);\r\n                localStorage.setItem('WeekPlannerPersistedState2', json);\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    WeekPlannerPersistedState.prototype.isExpired = function (asOf) {\r\n        return moment(this.lastWrite)\r\n            .isBefore(asOf.add(0 - WeekPlannerPersistedState.EXPIRATION_HOURS, 'hours'));\r\n    };\r\n    WeekPlannerPersistedState.EXPIRATION_HOURS = 12;\r\n    WeekPlannerPersistedState.VERSION = 2;\r\n    return WeekPlannerPersistedState;\r\n}());\r\nexport { WeekPlannerPersistedState };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { UserTasksBox } from './user-tasks-box';\r\nimport { createUUID } from \"kedbackend/client\";\r\nimport { refine } from './refiner';\r\nimport { env } from '../../globals/KED.env';\r\nimport { compareProp } from '../../utils/utils';\r\nimport moment from 'moment';\r\nimport { Dialogs } from '../utility-components/dialogs';\r\nimport { AddCustomGoal } from './add-custom-goal';\r\nimport { AddCustomTask } from './add-custom-task';\r\nimport { EditUserTask } from './edit-user-task';\r\nimport { Spinner } from '../course-builder/sub-components/spinner';\r\nimport { OpenCloseBox } from '../utility-components/open-close-box';\r\nimport { PendingJob } from '../../utils/pending-job';\r\nimport { AddOrEditSubTask } from './add-or-edit-sub-task';\r\nimport { getAdjustedWeek, KEDWeek, getNextWeekDate, getPrevWeekDate } from '../../utils/weekutil';\r\nimport { FormattedMessage } from 'react-intl';\r\nimport { LanguageContext } from '../utility-components/LanguageContext';\r\nimport { Progress } from '../charts/progress';\r\nimport { getWeekplannerProgressData } from '../charts/charts-utils';\r\nimport { features } from '../../features';\r\nvar MAX_STRATEGY_LENGTH = 16384;\r\nvar MAX_ASSESSMENT_LENGTH = 16384;\r\nvar WeekPlanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeekPlanner, _super);\r\n    function WeekPlanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            userTasks: [],\r\n            weekDate: Date.now(),\r\n            openCourses: {},\r\n            dialogs: [],\r\n            saving: false,\r\n            weekTextsUT: null,\r\n            isLoading: true,\r\n            isCopyingTasks: false\r\n        };\r\n        _this.onChange = _this.onChange.bind(_this);\r\n        _this.weekTextsSavingJob = new PendingJob(function () { return _this.saveWeekTexts(); });\r\n        return _this;\r\n    }\r\n    WeekPlanner.prototype.componentDidMount = function () {\r\n        this.props.env.userTasksRepo.subscribe(this.onChange);\r\n    };\r\n    WeekPlanner.prototype.componentWillUnmount = function () {\r\n        this.props.env.userTasksRepo.unsubscribe(this.onChange);\r\n        this.weekTextsSavingJob.stop();\r\n    };\r\n    WeekPlanner.prototype.onChange = function (userTasks, persisted, weekTextsUT) {\r\n        var newState = {\r\n            userTasks: userTasks,\r\n            weekDate: persisted.weekDate,\r\n            openCourses: persisted.openCourses,\r\n            weekTextsUT: weekTextsUT,\r\n            isLoading: false\r\n        };\r\n        if (!this.state.weekTextsUT || (weekTextsUT.dateTime !== this.state.weekTextsUT.dateTime)) {\r\n            // Changing week. Reset to new week's values\r\n            newState.strategy = weekTextsUT.weekTexts.strategy;\r\n            newState.assessment = weekTextsUT.weekTexts.assessment;\r\n        }\r\n        this.setState(newState); // React's use of Pick instead of Partial makes things complex here.\r\n    };\r\n    WeekPlanner.prototype.isWeekTextsEdited = function () {\r\n        var _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\r\n        return !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy || assessment !== weekTextsUT.weekTexts.assessment);\r\n    };\r\n    WeekPlanner.prototype.saveWeekTexts = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, strategy, assessment, weekTextsUT;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        console.log(\"Saving texts...\");\r\n                        _a = this.state, strategy = _a.strategy, assessment = _a.assessment, weekTextsUT = _a.weekTextsUT;\r\n                        if (!this.isWeekTextsEdited()) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.upsert(weekTextsUT, function (ut) {\r\n                                ut.weekTexts = { strategy: strategy, assessment: assessment };\r\n                            })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.prevWeek = function () {\r\n        //this.saveWeekTexts(); \r\n        var prevWeekObj = getPrevWeekDate(moment(this.state.weekDate));\r\n        this.props.env.userTasksRepo.changeWeek(prevWeekObj.nextDate, prevWeekObj.adjusted);\r\n    };\r\n    WeekPlanner.prototype.nextWeek = function () {\r\n        //this.saveWeekTexts();\r\n        var nextWeekObj = getNextWeekDate(moment(this.state.weekDate));\r\n        this.props.env.userTasksRepo.changeWeek(nextWeekObj.nextDate, nextWeekObj.adjusted);\r\n    };\r\n    WeekPlanner.prototype.openDialog = function (dialog) {\r\n        this.setState({ dialogs: tslib_1.__spread(this.state.dialogs, [dialog]) });\r\n    };\r\n    WeekPlanner.prototype.openAddGoalDialog = function () {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddCustomGoal, { onSave: function (learningGoal) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            if (!learningGoal)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.emptyLearningGoalErr', defaultMessage: 'Lrandemlet kan inte vara tomt' }));\r\n                            if (!!this.state.saving) return [3 /*break*/, 5];\r\n                            this.setState({ saving: true });\r\n                            _a.label = 1;\r\n                        case 1:\r\n                            _a.trys.push([1, , 3, 4]);\r\n                            return [4 /*yield*/, this.addCustomGoal(learningGoal)];\r\n                        case 2:\r\n                            _a.sent();\r\n                            return [3 /*break*/, 4];\r\n                        case 3:\r\n                            this.setState({ saving: false });\r\n                            return [7 /*endfinally*/];\r\n                        case 4:\r\n                            this.closeDialog();\r\n                            _a.label = 5;\r\n                        case 5: return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); } }));\r\n    };\r\n    WeekPlanner.prototype.openAddOwnTaskDialog = function (courseName, learningGoalName) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddCustomTask, { isTask: !courseName, onSave: function (name, description, url) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            if (!name)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameCannotBeEmpty', defaultMessage: 'Namnet kan inte vara tomt' }));\r\n                            if (!!this.state.saving) return [3 /*break*/, 5];\r\n                            this.setState({ saving: true });\r\n                            _a.label = 1;\r\n                        case 1:\r\n                            _a.trys.push([1, , 3, 4]);\r\n                            return [4 /*yield*/, this.addCustomTask(courseName, learningGoalName, name, description, url)];\r\n                        case 2:\r\n                            _a.sent();\r\n                            return [3 /*break*/, 4];\r\n                        case 3:\r\n                            this.setState({ saving: false });\r\n                            return [7 /*endfinally*/];\r\n                        case 4:\r\n                            this.closeDialog();\r\n                            _a.label = 5;\r\n                        case 5: return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); } }));\r\n    };\r\n    WeekPlanner.prototype.editTask = function (userTask) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(EditUserTask, { userTasksRepo: this.props.env.userTasksRepo, userTask: userTask, onUpdate: function (updater) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var test;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            test = tslib_1.__assign({}, userTask);\r\n                            updater(test);\r\n                            if (!test.name)\r\n                                throw new Error(this.context.intl.formatMessage({ id: 'weekplanner.nameMustNotBeEmpty', defaultMessage: 'Namnet fr inte vara tomt' }));\r\n                            this.closeDialog();\r\n                            return [4 /*yield*/, this.props.env.userTasksRepo.update([userTask], updater)];\r\n                        case 1:\r\n                            _a.sent();\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); }, onDelete: function (id) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            this.closeDialog();\r\n                            return [4 /*yield*/, this.props.env.userTasksRepo.delete([id])];\r\n                        case 1:\r\n                            _a.sent();\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); }, openDialog: function (dialog) { return _this.openDialog(dialog); }, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    WeekPlanner.prototype.editSubTask = function (userTask, subTask) {\r\n        var _this = this;\r\n        this.openDialog(React.createElement(AddOrEditSubTask, { userTasksRepo: this.props.env.userTasksRepo, mode: \"edit\", userTask: userTask, subTask: subTask, closeDialog: function () { return _this.closeDialog(); } }));\r\n    };\r\n    WeekPlanner.prototype.closeDialog = function () {\r\n        this.setState({ dialogs: this.state.dialogs.slice(0, this.state.dialogs.length - 1) });\r\n    };\r\n    WeekPlanner.prototype.addCustomGoal = function (learningGoal) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var latestTimeStamp;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    learningGoal: learningGoal,\r\n                                    dateTime: latestTimeStamp + 2000\r\n                                }])];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.setWeekPlannerBoxOpen(\"\", true)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.removeLearningGoal = function (learningGoal) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (learningGoal.tasks.length > 0) {\r\n                            if (!confirm(this.context.intl.formatMessage({ id: 'weekplanner.confirmRemoveLearningObjectives', defaultMessage: 'Ta bort lrandeml samt {learningGoalsNumber} uppgifter?' }, { learningGoalsNumber: learningGoal.tasks.length }))) {\r\n                                return [2 /*return*/];\r\n                            }\r\n                        }\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.delete(learningGoal.allTasks.map(function (t) { return t.id; }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.addCustomTask = function (courseName, learningGoal, name, description, url) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var latestTimeStamp;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        latestTimeStamp = Math.max.apply(Math.max, [this.state.weekDate].concat(this.state.userTasks.map(function (t) { return t.dateTime; })));\r\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\r\n                          ut.name == null &&\r\n                          !ut.courseName &&\r\n                          ut.learningGoal === learningGoal);\r\n                    \r\n                        if (emptyLearningGoalPlaceholder) {\r\n                          // Hijack learning-goal placeholder and make it the real task.\r\n                          // This will make the learning goal disappear once this task\r\n                          // is deleted.\r\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\r\n                            Object.assign(ut, { name, description, url });\r\n                          });\r\n                        } else {*/\r\n                        // Add another task to same learning-goal\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert([{\r\n                                    id: createUUID(),\r\n                                    dateTime: latestTimeStamp + 2000,\r\n                                    courseName: courseName,\r\n                                    learningGoal: learningGoal,\r\n                                    name: name,\r\n                                    description: description,\r\n                                    url: url\r\n                                }])];\r\n                    case 1:\r\n                        /*const emptyLearningGoalPlaceholder = this.state.userTasks.find(ut =>\r\n                          ut.name == null &&\r\n                          !ut.courseName &&\r\n                          ut.learningGoal === learningGoal);\r\n                    \r\n                        if (emptyLearningGoalPlaceholder) {\r\n                          // Hijack learning-goal placeholder and make it the real task.\r\n                          // This will make the learning goal disappear once this task\r\n                          // is deleted.\r\n                          await userTasksRepo.update([emptyLearningGoalPlaceholder], ut => {\r\n                            Object.assign(ut, { name, description, url });\r\n                          });\r\n                        } else {*/\r\n                        // Add another task to same learning-goal\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.setIsOpen = function (courseName, isOpen) {\r\n        this.props.env.userTasksRepo.setWeekPlannerBoxOpen(courseName, isOpen);\r\n    };\r\n    WeekPlanner.prototype.setTaskDone = function (task, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setTaskDoneState(task, done)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.setSubTaskDone = function (task, subTask, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.props.env.userTasksRepo.setSubTaskDoneState(task, subTask.id, done)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.copyFromPreviousWeek = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, userTasks_1, openCourses, weekDate, prevWeek, prevWeekNo, prevKEDWeek, prevTasks, test, latestTimeStamp_1, copies;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, this.setState({ isCopyingTasks: true })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        _b.trys.push([2, , 5, 6]);\r\n                        _a = this.state, userTasks_1 = _a.userTasks, openCourses = _a.openCourses, weekDate = _a.weekDate;\r\n                        prevWeek = moment(weekDate).add(-1, 'week');\r\n                        prevWeekNo = getAdjustedWeek(prevWeek);\r\n                        prevKEDWeek = KEDWeek(prevWeek.year(), prevWeekNo);\r\n                        return [4 /*yield*/, this.props.env.kedBackendClient.list(\"usertasks\", {\r\n                                from: prevKEDWeek.notBefore,\r\n                                to: prevKEDWeek.notAfter,\r\n                                role: \"USER\",\r\n                                include: [\"task\", \"course\", \"acl\"],\r\n                                flags: [\"includeIdsOnly\"]\r\n                            })];\r\n                    case 3:\r\n                        prevTasks = _b.sent();\r\n                        prevTasks = prevTasks\r\n                            .filter(function (prevTask) { return !prevTask.done; }) // Don't copy done tasks\r\n                            .filter(function (prevTask) { return !!prevTask.name; }) // Don't copy empty learning goals\r\n                            .filter(function (prevTask) { return !userTasks_1.some(function (taskOfCurrentWeek) {\r\n                            return taskOfCurrentWeek.name === prevTask.name &&\r\n                                taskOfCurrentWeek.learningGoal === prevTask.learningGoal &&\r\n                                taskOfCurrentWeek.courseName === prevTask.courseName;\r\n                        }); }); // Ignore identical tasks (already copied)\r\n                        test = [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; }));\r\n                        latestTimeStamp_1 = Math.max.apply(Math.max, [weekDate].concat(userTasks_1.map(function (t) { return t.dateTime; })));\r\n                        copies = prevTasks.sort(compareProp(\"dateTime\")).map(function (task) {\r\n                            var copy = tslib_1.__assign({}, task, { dateTime: latestTimeStamp_1 += 1000 });\r\n                            copy.id = createUUID();\r\n                            if (copy.subTasks) {\r\n                                copy.subTasks = copy.subTasks.filter(function (st) { return !st.done; });\r\n                            }\r\n                            delete copy.$etag;\r\n                            return copy;\r\n                        });\r\n                        // Store it\r\n                        return [4 /*yield*/, this.props.env.userTasksRepo.insert(copies)];\r\n                    case 4:\r\n                        // Store it\r\n                        _b.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 5:\r\n                        this.setState({ isCopyingTasks: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WeekPlanner.prototype.getHeaderTitle = function () {\r\n        return React.createElement(\"h4\", null,\r\n            React.createElement(FormattedMessage, { id: \"weekplanner.logBook\", defaultMessage: \"Loggbok\" }));\r\n    };\r\n    WeekPlanner.prototype.render = function () {\r\n        var _this = this;\r\n        var weekNumber = moment(this.state.weekDate).week();\r\n        var showProgressCharts = features.weekplannerCharts;\r\n        //console.log(\"Weekydate: \"  + new Date(this.state.weekDate) + \" which is week no \" + weekNumber);\r\n        var currentWeek = moment().week();\r\n        var taskSets = refine(this.state.userTasks);\r\n        var _a = this.state, dialogs = _a.dialogs, weekTextsUT = _a.weekTextsUT, strategy = _a.strategy, assessment = _a.assessment, isLoading = _a.isLoading, isCopyingTasks = _a.isCopyingTasks;\r\n        var isSaving = weekTextsUT && (weekTextsUT.$meta === 'adding' || weekTextsUT.$meta === 'updating');\r\n        var isStrategyEdited = !!weekTextsUT && (strategy !== weekTextsUT.weekTexts.strategy);\r\n        var isAssessmentEdited = !!weekTextsUT && (assessment !== weekTextsUT.weekTexts.assessment);\r\n        var enableSaveButton = !isSaving && (isStrategyEdited || isAssessmentEdited);\r\n        var isGymnasiumStudent = ('' + env.currentUser.schoolType).toLowerCase() === \"gymnasium\";\r\n        var chartTasks = getWeekplannerProgressData(taskSets);\r\n        var percentage = chartTasks.totalNumberOfTasks > 0 ? chartTasks.completedTasks / chartTasks.totalNumberOfTasks * 100 : 0;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"ked_boxed weekPlanner\" + (weekNumber === currentWeek ? \" currentWeek\" : \"\"), onKeyDown: function (ev) {\r\n                    if (ev.which === 83 && ev.ctrlKey) {\r\n                        ev.preventDefault();\r\n                        if (!isSaving && _this.isWeekTextsEdited()) {\r\n                            _this.weekTextsSavingJob.triggerChange(0);\r\n                        }\r\n                    }\r\n                } },\r\n                showProgressCharts && chartTasks.totalNumberOfTasks > 0 && this.getHeaderTitle(),\r\n                React.createElement(\"div\", { className: \"widgets\" },\r\n                    showProgressCharts && chartTasks.totalNumberOfTasks > 0 ? React.createElement(\"div\", { className: \"progressBar\" },\r\n                        React.createElement(Progress, { percentage: percentage })) : this.getHeaderTitle(),\r\n                    React.createElement(\"div\", { className: \"weekSelect\" },\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"p\", null,\r\n                                React.createElement(FormattedMessage, { id: \"weekplanner.weekNumber\", values: { weekNumber: weekNumber }, defaultMessage: \"Vecka {weekNumber}\" }))),\r\n                        React.createElement(\"div\", { className: \"horizontalItem\" },\r\n                            React.createElement(\"div\", { className: \"btn-group\" },\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.prevWeek(); } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-left\", \"aria-hidden\": \"true\" })),\r\n                                React.createElement(\"button\", { className: \"btn\", onClick: function () { return _this.nextWeek(); } },\r\n                                    React.createElement(\"i\", { className: \"fa fa-angle-right\", \"aria-hidden\": \"true\" })))))),\r\n                taskSets.length > 0 && React.createElement(\"hr\", null),\r\n                taskSets.map(function (props) {\r\n                    return React.createElement(UserTasksBox, tslib_1.__assign({ key: props.courseName }, props, { courseName: props.courseName, learningGoals: props.learningGoals, viewCourseUrl: _this.props.viewCourseUrl, openCourses: _this.state.openCourses, addOwnTask: function (courseName, learningGoalName) { return _this.openAddOwnTaskDialog(courseName, learningGoalName); }, setIsOpen: _this.setIsOpen.bind(_this), setTaskDone: _this.setTaskDone.bind(_this), setSubTaskDone: _this.setSubTaskDone.bind(_this), editTask: function (task) { return _this.editTask(task); }, editSubTask: function (task, subTask) { return _this.editSubTask(task, subTask); }, removeLearningGoal: function (lg) { return _this.removeLearningGoal(lg); }, displayProgress: showProgressCharts, progressData: chartTasks.subjectData[props.courseName] }));\r\n                }),\r\n                React.createElement(\"hr\", null),\r\n                isLoading ? React.createElement(Spinner, null) : React.createElement(\"div\", null,\r\n                    React.createElement(\"div\", { className: \"btn\", onClick: function (ev) { return _this.openAddGoalDialog(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-list-alt\", \"aria-hidden\": \"true\" }),\r\n                        isGymnasiumStudent ? React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalGymnasium\", defaultMessage: \"Uppgift\" }) : React.createElement(FormattedMessage, { id: \"weekplanner.learningGoalPrimary\", defaultMessage: \"Eget l\\u00E4randem\\u00E5l\" })),\r\n                    React.createElement(\"div\", { className: \"btn\", style: isCopyingTasks ? { opacity: 0.5 } : undefined, onClick: function (ev) { return (!isCopyingTasks) && _this.copyFromPreviousWeek(); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-clone\", \"aria-hidden\": \"true\" }),\r\n                        React.createElement(FormattedMessage, { id: \"weekplanner.copyPreviousWeekTaks\", defaultMessage: \"Kopiera ej klara fr\\u00E5n f\\u00F6reg\\u00E5ende vecka\" })),\r\n                    React.createElement(OpenCloseBox, { title: React.createElement(\"h5\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyAndEvaluation\", defaultMessage: \"Strategi & Utv\\u00E4rdering\" })), headerOpen: this.state.openCourses[\"StratUtv\"], onOpenClose: function (becameOpen) { return _this.setIsOpen(\"StratUtv\", becameOpen); } },\r\n                        React.createElement(\"h3\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategy\", defaultMessage: \"Strategi\" })),\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.strategyDescription\", defaultMessage: \"Hur jag ska g\\u00F6ra f\\u00F6r att l\\u00E4ra mig.\" })),\r\n                        React.createElement(\"hr\", null),\r\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", disabled: this.props.env.tutored, value: strategy && strategy.substr(0, MAX_STRATEGY_LENGTH), onChange: function (ev) {\r\n                                _this.setState({ strategy: (ev.target.value || '').substr(0, MAX_STRATEGY_LENGTH) });\r\n                                _this.weekTextsSavingJob.triggerChange(500);\r\n                            } }),\r\n                        React.createElement(\"h3\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluation\", defaultMessage: \"Utv\\u00E4rdering\" })),\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(FormattedMessage, { id: \"weekplanner.evaluationDescription\", defaultMessage: \"Reflektion kring din arbetsinsats och dina valda strategier under veckan.Utv\\u00E4rdera i f\\u00F6rh\\u00E5llande till dina m\\u00E5l.\" })),\r\n                        React.createElement(\"hr\", null),\r\n                        React.createElement(\"textarea\", { className: \"weekplanner-textarea\", value: assessment && assessment.substr(0, MAX_ASSESSMENT_LENGTH), disabled: this.props.env.tutored, onChange: function (ev) {\r\n                                _this.setState({ assessment: (ev.target.value || '').substr(0, MAX_ASSESSMENT_LENGTH) });\r\n                                _this.weekTextsSavingJob.triggerChange(500);\r\n                            } }),\r\n                        React.createElement(\"div\", { className: \"btn\", tabIndex: 0, style: enableSaveButton ? {} : { opacity: 0.5 }, onClick: function () { return !isSaving && _this.weekTextsSavingJob.triggerChange(0); } },\r\n                            React.createElement(\"i\", { className: \"fa fa-floppy-o\", \"aria-hidden\": \"true\" }),\r\n                            enableSaveButton ? React.createElement(FormattedMessage, { id: \"common.save\", defaultMessage: \" Spara\" }) : React.createElement(FormattedMessage, { id: \"common.saved\", defaultMessage: \" Sparad\" }))))),\r\n            React.createElement(Dialogs, { dialogs: dialogs, popDialog: function () {\r\n                    _this.setState(function (_a) {\r\n                        var dialogs = _a.dialogs;\r\n                        return ({ dialogs: dialogs.slice(0, dialogs.length - 1) });\r\n                    });\r\n                } }));\r\n    };\r\n    WeekPlanner.contextType = LanguageContext;\r\n    return WeekPlanner;\r\n}(React.Component));\r\nexport { WeekPlanner };\r\n","var Course = /** @class */ (function () {\r\n    function Course() {\r\n    }\r\n    return Course;\r\n}());\r\nexport { Course };\r\nexport var futureAbilities = [\r\n    \"Lra att lra\",\r\n    \"Samarbeta\",\r\n    \"Agera globalt\",\r\n    \"Visa handlingskraft\",\r\n    \"Vara innovativ\",\r\n    \"Leva digitalt\"\r\n];\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString } from '../utils/query-string';\r\nimport FeatureDescriptions from './feature-flags.json';\r\nimport { cfg } from '../globals/KED.cfg';\r\nvar Features = /** @class */ (function () {\r\n    function Features() {\r\n        var e_1, _a;\r\n        this._initialized = false;\r\n        var _loop_1 = function (featureName) {\r\n            Object.defineProperty(this_1, featureName, {\r\n                get: function () {\r\n                    if (!this._initialized)\r\n                        this.init();\r\n                    return this._features[featureName];\r\n                },\r\n                set: function (value) {\r\n                    throw new Error('Feature flags cannot be set here');\r\n                }\r\n            });\r\n        };\r\n        var this_1 = this;\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                _loop_1(featureName);\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n    }\r\n    Features.prototype.init = function () {\r\n        var e_2, _a;\r\n        if (this._initialized)\r\n            return;\r\n        var turnedOnFeatures = (cfg.KED_FEATURES || \"\").split(',').map(function (name) { return name.trim().toLowerCase(); });\r\n        var query = parseQueryString(location.search, { toLower: true });\r\n        if (query.testversion) {\r\n            turnedOnFeatures = [\"*\"];\r\n        }\r\n        if (query.features) {\r\n            turnedOnFeatures = query.features\r\n                .split(',')\r\n                .map(function (feature) { return feature.trim().toLowerCase(); });\r\n        }\r\n        var turnOnAll = turnedOnFeatures.includes('*');\r\n        this._features = {};\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                this._features[featureName] = turnOnAll ||\r\n                    turnedOnFeatures.includes(featureName.toLowerCase());\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        this._initialized = true;\r\n    };\r\n    return Features;\r\n}());\r\nexport { Features };\r\nexport var features = new Features();\r\n","export * from './features';\r\n","import cfg from '../globals/KED.cfg';\r\ncfg.ENVIRONMENT = process.env.ENVIRONMENT;\r\ncfg.KED_API_URL = process.env.KED_API_URL; // \"https://kedbackendtest.azurewebsites.net/api/\"\r\ncfg.EDS_API_URL = process.env.EDS_API_URL; // \"https://edsportalowinapi.azurewebsites.net/api/\"\r\ncfg.KED_TOKEN_URL = process.env.KED_TOKEN_URL; // \"https://kedauthtest.azurewebsites.net/token\"\r\ncfg.KED_CLIENT_ID = process.env.KED_CLIENT_ID; // \"devclient\", \"testclient\", \"...\"\r\ncfg.KED_CLIENT_SECRET = process.env.KED_CLIENT_SECRET;\r\ncfg.KED_REALM = process.env.KED_REALM; // \"SE1\"\r\ncfg.KED_LOCALE = cfg.KED_LOCALE || process.env.KED_LOCALE; // \"sv\", \"en\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_SCHOOL_LOCALE = cfg.KED_SCHOOL_LOCALE || process.env.KED_SCHOOL_LOCALE; // \"sv\", \"en_sin\", \"en_nin\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_RESOURCES_URL = cfg.KED_RESOURCES_URL || process.env.KED_RESOURCES_URL;\r\n","/* These scripts assume some of the global vars have already been set:\r\n  * KED.cfg\r\n  * KED.env.currentUser\r\n\r\n  The rest will be set here (client side)\r\n*/\r\nimport './configure';\r\nimport './set-bearer-providers';\r\nimport './set-ked-backend-client';\r\nimport './set-eds-client';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString, generateQueryString, splitUrlAndQuery } from \"../utils/query-string\";\r\nimport { WebServerBearerProvider, isomorphic, storage } from 'kedbackend/clientweb';\r\nimport { KedBearerProvider } from 'kedbackend/client';\r\nimport cfg from '../globals/KED.cfg';\r\nimport env from '../globals/KED.env';\r\nimport { IMPERSONATION_QUERY_PARAMS } from \"../access-control/index\";\r\nimport { cherryPickProps } from \"../utils/utils\";\r\nvar employeeClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.profile.emails\",\r\n    \"https://www.googleapis.com/auth/classroom.rosters\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.students\"\r\n];\r\nvar studentClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.me\"\r\n];\r\nfunction getMergedTokenPath(tokenPath, locationSearch, scopes) {\r\n    // Merge configured query params of token path with params given to current page\r\n    var currentQuery = parseQueryString(locationSearch);\r\n    var impersonationProps = cherryPickProps(currentQuery, IMPERSONATION_QUERY_PARAMS);\r\n    var _a = tslib_1.__read(splitUrlAndQuery(tokenPath), 2), tokenPathWithoutQuery = _a[0], tokenQueryString = _a[1];\r\n    var tokenPathQuery = parseQueryString(tokenQueryString);\r\n    return tokenPathWithoutQuery + generateQueryString(tslib_1.__assign({}, tokenPathQuery, impersonationProps, { scopes: scopes.join(',') }));\r\n}\r\nfunction getTokenId(mergedTokenPath, userEmail) {\r\n    return mergedTokenPath + \"/\" + userEmail;\r\n}\r\nfunction saveUserInfo(user, tokenId) {\r\n    env.currentUser = user;\r\n    var schoolgrade = parseQueryString(location.search, { toLower: true }).schoolgrade;\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n    sessionStorage.setItem(\"userInfo\" + tokenId, JSON.stringify(user));\r\n}\r\nfunction loadUserInfo(tokenId) {\r\n    var storedSessionUser = sessionStorage.getItem(\"userInfo\" + tokenId);\r\n    if (storedSessionUser) {\r\n        env.currentUser = JSON.parse(storedSessionUser);\r\n    }\r\n}\r\nfunction createBearerProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        if (res.user) {\r\n            saveUserInfo(res.user, tokenId);\r\n        }\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createGoogleTokenProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createTestTokenProvider(tokenUrl, user, scopes) {\r\n    return new KedBearerProvider(isomorphic, storage, tokenUrl + user.mail + location.search, cfg.KED_CLIENT_ID, cfg.KED_CLIENT_SECRET, tokenUrl, {\r\n        email: user.mail.toLowerCase(),\r\n        roles: user.roles,\r\n        school: user.school,\r\n        schoolType: user.schoolType,\r\n        scopes: scopes,\r\n        name: user.displayName\r\n    });\r\n}\r\n// env.currentUser.mail is set by SiteVision server initially.\r\n// A response from /api/token may change the mail attribute of the current\r\n// user, so env.currentUser.mail may be different after getting a response.\r\n// However, the initial value is valuable always in order to distinguish the case\r\n// when one normal user logs out and another user logs in.\r\nvar initialUserEmail = env.currentUser && env.currentUser.mail; // Initial value of mail. May change.\r\nif (initialUserEmail) {\r\n    // KED\r\n    if (cfg.KED_TOKEN_PATH) {\r\n        //\r\n        //\r\n        // Production / SiteVision proxied /api/token to request tokens from:\r\n        //\r\n        //\r\n        var mergedTokenPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        env.bearerProvider = createBearerProvider(mergedTokenPath, initialUserEmail);\r\n        loadUserInfo(getTokenId(mergedTokenPath, initialUserEmail));\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        // Google\r\n        var googleMergedPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, scopes);\r\n        env.googleTokenProvider = createGoogleTokenProvider(googleMergedPath, initialUserEmail);\r\n    }\r\n    else if (cfg.KED_TOKEN_URL && cfg.KED_CLIENT_ID && cfg.KED_CLIENT_SECRET) {\r\n        //\r\n        //\r\n        // Test - go directly to KEDAUTH server to retrieve tokens\r\n        //\r\n        //\r\n        env.bearerProvider = createTestTokenProvider(cfg.KED_TOKEN_URL, env.currentUser, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        env.googleTokenProvider = createTestTokenProvider(cfg.KED_TOKEN_URL + \"/google\", env.currentUser, scopes);\r\n    }\r\n    else {\r\n        throw new Error(\"Missing configuration parameter KED_TOKEN_PATH\");\r\n    }\r\n}\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { isomorphic } from 'kedbackend/clientweb';\r\nimport { EdsClient } from '../apis/edsclient';\r\nenv.edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, env.bearerProvider, function () { return env.currentUser.mail; });\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { KedBackendClientWeb } from 'kedbackend/clientweb';\r\nenv.kedBackendClient = new KedBackendClientWeb(cfg.KED_API_URL, env.bearerProvider);\r\n","import KED from './KED';\r\n;\r\nif (!KED.cfg)\r\n    KED.cfg = {};\r\nexport default KED.cfg;\r\nexport var cfg = KED.cfg;\r\n","import KED from './ked';\r\nif (!KED.env)\r\n    KED.env = {};\r\nexport default KED.env;\r\nexport var env = KED.env;\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import env from './KED.env';\r\nimport { KedBackendRepo } from 'kedbackend/repo';\r\nimport { getGlobalId, createUUID } from 'kedbackend/client';\r\nimport cfg from './KED.cfg';\r\nif (!env.db) {\r\n    // Put db on env so that it is shared between subject planner and other components!\r\n    env.db = new KedBackendRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser ?\r\n        env.currentUser.mail :\r\n        \"\"; }, function () { return env.currentUser ?\r\n        env.currentUser.displayName || env.currentUser.mail :\r\n        \"\"; });\r\n}\r\nexport var db = env.db;\r\nexport var globalId = getGlobalId(cfg.KED_REALM);\r\nexport var Schools = {\r\n    standardSchool: db.schools.name(\"standard\").cacheOptimized().single(),\r\n    get mySchool() { return db.schools.name(env.currentUser.school).cacheOptimized().single(); }\r\n};\r\nexport var CourseInstances = {\r\n    getBranchId: function (school, courseId) {\r\n        return school.switchMap(function (school) {\r\n            return db.branches\r\n                .hasEdgesFrom([school.officialBranchId])\r\n                .name(\"draft\")\r\n                .tags(courseId)\r\n                .idsOnly()\r\n                .map(function (_a) {\r\n                var id = _a.id;\r\n                return id;\r\n            })\r\n                .toValue()\r\n                .map(function (ids) { return ids.length > 0 ? ids[0] : undefined; });\r\n        });\r\n    },\r\n    /** Get a DRAFT branch for given course ID and given school.\r\n     * If there is not yet such a branch, create it using mutationsOnEmpty() which will\r\n     * lead to the C# code DocumentRepository.ReadOrMutate() via DocumentController.\r\n     */\r\n    getOrCreateBranchId: function (school, courseId) {\r\n        return db.courseInstances.idsOnly().id(courseId).switchMap(function () {\r\n            return school.switchMap(function (school) {\r\n                return db.branches\r\n                    .hasEdgesFrom([school.officialBranchId])\r\n                    .name(\"draft\")\r\n                    .tags(courseId)\r\n                    .idsOnly()\r\n                    .mutationsOnEmpty(function (tx) {\r\n                    // These 2 mutations will occur server side, atomically.\r\n                    // Will be sent on each request in the query, but will only execute if query results in zero items.\r\n                    //console.log(\"School:\", school);\r\n                    var id = createUUID();\r\n                    tx.add(\"branches\", {\r\n                        id: id,\r\n                        acl: [\r\n                            \"role:USER:R\",\r\n                            \"schoolRole:\" + school.name + \"/EMPLOYEE:S\"\r\n                        ],\r\n                        name: 'draft',\r\n                        schoolId: school.id,\r\n                        treeParentId: school.officialBranchId,\r\n                        tags: [courseId]\r\n                    });\r\n                    // Approving the branch makes sure that it was created by an EMPLOYEE on given school.\r\n                    tx.link2(\"branches\", school.officialBranchId, \"approvedChildren\", id);\r\n                })\r\n                    .single()\r\n                    .map(function (_a) {\r\n                    var id = _a.id;\r\n                    return id;\r\n                });\r\n            });\r\n        });\r\n    },\r\n    getAllDescendantIds: function (courseId) {\r\n        return db.courseBlocks.tags(courseId).idsOnly().concat(db.courseContents.tags(courseId).idsOnly()).concat(db.courseTabs.tags(courseId).idsOnly()).concat(db.tasks.tags(courseId).idsOnly())\r\n            .map(function (x) { return x.id; });\r\n    }\r\n};\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import moment from 'moment';\r\nimport cfg from '../globals/KED.cfg';\r\nif (cfg.KED_LOCALE === \"sv\") {\r\n    moment.updateLocale('sv', {\r\n        months: 'januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december'.split('_'),\r\n        monthsShort: 'jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec'.split('_'),\r\n        weekdays: 'sndag_mndag_tisdag_onsdag_torsdag_fredag_lrdag'.split('_'),\r\n        weekdaysShort: 'sn_mn_tis_ons_tor_fre_lr'.split('_'),\r\n        weekdaysMin: 's_m_ti_on_to_fr_l'.split('_'),\r\n        longDateFormat: {\r\n            LT: 'HH:mm',\r\n            LTS: 'HH:mm:ss',\r\n            L: 'YYYY-MM-DD',\r\n            LL: 'D MMMM YYYY',\r\n            LLL: 'D MMMM YYYY [kl.] HH:mm',\r\n            LLLL: 'dddd D MMMM YYYY [kl.] HH:mm',\r\n            lll: 'D MMM YYYY HH:mm',\r\n            llll: 'ddd D MMM YYYY HH:mm'\r\n        },\r\n        calendar: {\r\n            sameDay: '[Idag] LT',\r\n            nextDay: '[Imorgon] LT',\r\n            lastDay: '[Igr] LT',\r\n            nextWeek: '[P] dddd LT',\r\n            lastWeek: '[I] dddd[s] LT',\r\n            sameElse: 'L'\r\n        },\r\n        relativeTime: {\r\n            future: 'om %s',\r\n            past: 'fr %s sedan',\r\n            s: 'ngra sekunder',\r\n            ss: '%d sekunder',\r\n            m: 'en minut',\r\n            mm: '%d minuter',\r\n            h: 'en timme',\r\n            hh: '%d timmar',\r\n            d: 'en dag',\r\n            dd: '%d dagar',\r\n            M: 'en mnad',\r\n            MM: '%d mnader',\r\n            y: 'ett r',\r\n            yy: '%d r'\r\n        },\r\n        dayOfMonthOrdinalParse: /\\d{1,2}(e|a)/,\r\n        ordinal: function (number) {\r\n            var b = number % 10, output = (~~(number % 100 / 10) === 1) ? 'e' :\r\n                (b === 1) ? 'a' :\r\n                    (b === 2) ? 'a' :\r\n                        (b === 3) ? 'e' : 'e';\r\n            return number + output;\r\n        },\r\n        week: {\r\n            dow: 1,\r\n            doy: 4 // The week that contains Jan 4th is the first week of the year.\r\n        }\r\n    });\r\n}\r\nexport var localMoment = function () {\r\n    return moment.apply(this, arguments).locale(cfg.KED_LOCALE);\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Repo } from './repo';\r\nimport { BatchRunner, createUUID } from 'kedbackend/client';\r\nvar KedRepo = /** @class */ (function () {\r\n    function KedRepo(options) {\r\n        var _this = this;\r\n        var table = options.table, getClient = options.getClient, getQueryOptions = options.getQueryOptions;\r\n        this.mem = new Repo({ query: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var queryOptions;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0: return [4 /*yield*/, getQueryOptions()];\r\n                        case 1:\r\n                            queryOptions = _a.sent();\r\n                            return [4 /*yield*/, getClient().list(table, tslib_1.__assign({}, queryOptions, { cacheBust: this.getCacheBust() }))];\r\n                        case 2: return [2 /*return*/, _a.sent()];\r\n                    }\r\n                });\r\n            }); } });\r\n        this.options = options;\r\n    }\r\n    KedRepo.prototype.getCacheBust = function () {\r\n        var _a = this.options, table = _a.table, user = _a.user;\r\n        var cacheBust = localStorage.getItem('cache-bust-' + table + '-' + user);\r\n        return cacheBust || this.regenerateCacheBust();\r\n    };\r\n    KedRepo.prototype.regenerateCacheBust = function () {\r\n        var _a = this.options, table = _a.table, user = _a.user;\r\n        var cacheBust = createUUID();\r\n        localStorage.setItem('cache-bust-' + table + '-' + user, cacheBust);\r\n        return cacheBust;\r\n    };\r\n    KedRepo.prototype.upsert = function (item, updater) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var updatedItem;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!!item.$etag) return [3 /*break*/, 2];\r\n                        updatedItem = Object.assign({}, item);\r\n                        updater(updatedItem);\r\n                        return [4 /*yield*/, this.insert([updatedItem])];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                    case 2: \r\n                    // We have an $etag, so we can expect it to live on the server.\r\n                    // However, take care of the unlikely situation that it was deleted from server,\r\n                    // and if so, insert it again.\r\n                    return [4 /*yield*/, this.update([item], updater).catch(function (e) {\r\n                            if (e.name === \"http404\") {\r\n                                var updatedItem = Object.assign({}, item);\r\n                                updater(updatedItem);\r\n                                return _this.insert([updatedItem]);\r\n                            }\r\n                            return Promise.reject(e);\r\n                        })];\r\n                    case 3:\r\n                        // We have an $etag, so we can expect it to live on the server.\r\n                        // However, take care of the unlikely situation that it was deleted from server,\r\n                        // and if so, insert it again.\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.update = function (items, updater) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, modifiedItems, res;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        modifiedItems = items.map(function (item) {\r\n                            var memRepoItem = _this.mem.items.find(function (it) { return it.id === item.id; });\r\n                            item = Object.assign({}, memRepoItem || item);\r\n                            updater(item);\r\n                            return item;\r\n                        });\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(modifiedItems.map(function (x) { return Object.assign({}, x, { $meta: 'updating' }); }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); })\r\n                            .catch(function (e) { return e.name === \"http409\" ? // conflict\r\n                            // Get a fresh version from server:\r\n                            client.list(table, { ids: items.map(function (item) { return item.id; }) }, { cache: 'no-cache' }).then(function (freshItems) {\r\n                                // Update local version:\r\n                                var modifiedItems = freshItems.map(function (freshItem) {\r\n                                    // Clone the fresh item\r\n                                    var modified = Object.assign({}, freshItem);\r\n                                    // Re-run the updater on the clone:\r\n                                    updater(modified);\r\n                                    return modified;\r\n                                });\r\n                                // Re-do the the put operation towards the server.\r\n                                return client.do(function (br) { return modifiedItems.forEach(function (item) { return br.put(table, item); }); });\r\n                            }) :\r\n                            // Other unexpected error:\r\n                            Promise.resolve(optimistic &&\r\n                                _this.mem.update(items)) // Undo optimistic update\r\n                                .then(function () {\r\n                                return Promise.reject(e); // Reject with the error no matter.\r\n                            }); })];\r\n                    case 3:\r\n                        res = _b.sent();\r\n                        this.regenerateCacheBust();\r\n                        modifiedItems.forEach(function (item) {\r\n                            item.$etag = res.newEtags[item.id];\r\n                            item.$meta = undefined;\r\n                        });\r\n                        return [4 /*yield*/, this.mem.update(modifiedItems)];\r\n                    case 4:\r\n                        _b.sent(); // Ensures new etag is is applied on next action.\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.stripGraphs = function (items, graphs) {\r\n        return items.map(function (item) {\r\n            var clone = Object.assign({}, item);\r\n            graphs.forEach(function (graph) {\r\n                if (item[graph]) {\r\n                    clone[graph] = item[graph].map(function (doc) { return ({ id: doc.id }); });\r\n                }\r\n            });\r\n            return clone;\r\n        });\r\n    };\r\n    KedRepo.prototype.insert = function (items) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, getQueryOptions, client, queryOptions, graphs, stripped, br, _loop_1, stripped_1, stripped_1_1, item, res;\r\n            var e_1, _b;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table, getQueryOptions = _a.getQueryOptions;\r\n                        client = getClient();\r\n                        return [4 /*yield*/, getQueryOptions()];\r\n                    case 1:\r\n                        queryOptions = _c.sent();\r\n                        graphs = [].concat(queryOptions.include);\r\n                        // Give IDs to each item:\r\n                        items = items.map(function (item) { return item.id ? item : Object.assign({}, item, { id: createUUID() }); });\r\n                        stripped = this.stripGraphs(items, graphs);\r\n                        if (!optimistic) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.mem.insert(stripped.map(function (x) { return Object.assign({}, x, { $meta: 'adding' }); }))];\r\n                    case 2:\r\n                        _c.sent();\r\n                        _c.label = 3;\r\n                    case 3:\r\n                        br = new BatchRunner();\r\n                        _loop_1 = function (item) {\r\n                            var e_2, _a;\r\n                            var _loop_2 = function (graph) {\r\n                                var foreignItems = item[graph];\r\n                                if (foreignItems) {\r\n                                    foreignItems.forEach(function (doc) {\r\n                                        br.link2(table, item.id, graph, doc.id);\r\n                                    });\r\n                                }\r\n                            };\r\n                            try {\r\n                                // Also add links to all foreign related items:\r\n                                for (var graphs_1 = (e_2 = void 0, tslib_1.__values(graphs)), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\r\n                                    var graph = graphs_1_1.value;\r\n                                    _loop_2(graph);\r\n                                }\r\n                            }\r\n                            catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\r\n                                }\r\n                                finally { if (e_2) throw e_2.error; }\r\n                            }\r\n                            br.add(table, item);\r\n                        };\r\n                        try {\r\n                            for (stripped_1 = tslib_1.__values(stripped), stripped_1_1 = stripped_1.next(); !stripped_1_1.done; stripped_1_1 = stripped_1.next()) {\r\n                                item = stripped_1_1.value;\r\n                                _loop_1(item);\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (stripped_1_1 && !stripped_1_1.done && (_b = stripped_1.return)) _b.call(stripped_1);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        return [4 /*yield*/, client.batch(br.mutationRequests).catch(function (e) {\r\n                                if (optimistic)\r\n                                    _this.mem.delete(items.map(function (item) { return item.id; }));\r\n                                return Promise.reject(e);\r\n                            })];\r\n                    case 4:\r\n                        res = _c.sent();\r\n                        this.regenerateCacheBust();\r\n                        items.forEach(function (item) { return item.$etag = res.newEtags[item.id]; });\r\n                        if (!optimistic) return [3 /*break*/, 6];\r\n                        return [4 /*yield*/, this.mem.update(items)];\r\n                    case 5:\r\n                        _c.sent(); // Update with new $etag.\r\n                        return [3 /*break*/, 8];\r\n                    case 6: return [4 /*yield*/, this.mem.insert(items)];\r\n                    case 7:\r\n                        _c.sent();\r\n                        _c.label = 8;\r\n                    case 8: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedRepo.prototype.delete = function (ids) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, res;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(ids\r\n                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\r\n                                .filter(function (x) { return x; })\r\n                                .map(function (x) { return Object.assign({}, x, { $meta: 'deleting' }); }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.do(function (br) { return ids.forEach(function (id) { return br.delete(table, id); }); }).catch(function (e) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var _this = this;\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0:\r\n                                        if (!optimistic) return [3 /*break*/, 2];\r\n                                        return [4 /*yield*/, this.mem.update(ids\r\n                                                .map(function (id) { return _this.mem.items.find(function (x) { return x.id === id; }); })\r\n                                                .filter(function (x) { return x; })\r\n                                                .map(function (x) {\r\n                                                x = Object.assign({}, x);\r\n                                                delete x.$meta;\r\n                                                return x;\r\n                                            }))];\r\n                                    case 1:\r\n                                        _a.sent();\r\n                                        _a.label = 2;\r\n                                    case 2: throw e;\r\n                                }\r\n                            });\r\n                        }); })];\r\n                    case 3:\r\n                        res = _b.sent();\r\n                        this.regenerateCacheBust();\r\n                        return [4 /*yield*/, this.mem.delete(ids)];\r\n                    case 4:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedRepo;\r\n}());\r\nexport { KedRepo };\r\n","import * as tslib_1 from \"tslib\";\r\nvar Repo = /** @class */ (function () {\r\n    function Repo(comm) {\r\n        this.comm = comm;\r\n        this.listPromise = null;\r\n        this.items = null;\r\n        this.subscribers = [];\r\n    }\r\n    Repo.prototype.subscribe = function (subscriber) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            subscriber(_this.items, _this.error);\r\n            _this.subscribers.push(subscriber);\r\n        });\r\n    };\r\n    Repo.prototype.unsubscribe = function (subscriber) {\r\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\r\n    };\r\n    Repo.prototype.notifySubscribers = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (s) { return s(_this.items, _this.error); });\r\n    };\r\n    Repo.prototype.ensureHasData = function () {\r\n        if (!this.listPromise)\r\n            this.refreshFromServer();\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.refreshFromServer = function () {\r\n        var _this = this;\r\n        this.listPromise = this.comm.query().then(function (items) {\r\n            _this.items = items;\r\n            _this.error = null;\r\n            _this.notifySubscribers();\r\n        }).catch(function (error) {\r\n            _this.error = error;\r\n            _this.items = _this.items || [];\r\n            _this.notifySubscribers();\r\n        });\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.update = function (item) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var updatedItems;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureHasData()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        updatedItems = Array.isArray(item) ? item : [item];\r\n                        this.items = this.items.map(function (it) {\r\n                            var updatedItem = updatedItems.find(function (_a) {\r\n                                var id = _a.id;\r\n                                return it.id === id;\r\n                            });\r\n                            return updatedItem ?\r\n                                Object.assign({}, updatedItem) :\r\n                                it;\r\n                        });\r\n                        this.notifySubscribers();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    Repo.prototype.insert = function (item) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.concat(item);\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    Repo.prototype.delete = function (id) {\r\n        var _this = this;\r\n        var ids = Array.isArray(id) ? id : [id];\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.filter(function (it) { return !ids.some(function (id) { return it.id === id; }); });\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    return Repo;\r\n}());\r\nexport { Repo };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { KedRepo } from './ked-repo';\r\nimport env from '../globals/KED.env';\r\nimport { WeekPlannerPersistedState } from \"../components/weekplanner/weekplanner-persisted-state\";\r\nimport moment from 'moment';\r\nimport { createUUID, DocumentAccess } from 'kedbackend/client';\r\nimport { KEDWeek } from '../utils/weekutil';\r\nexport var userTasksRepo = env.userTasksRepo;\r\nvar UserTasksRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UserTasksRepo, _super);\r\n    function UserTasksRepo(getClient, getCurrentUser) {\r\n        var _this = _super.call(this, {\r\n            getClient: getClient,\r\n            optimistic: true,\r\n            table: \"usertasks\",\r\n            user: getCurrentUser() ? getCurrentUser().mail : \"\",\r\n            getQueryOptions: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var currentUser, userEmail, _a, weekDate, weekNumber, kedWeek;\r\n                return tslib_1.__generator(this, function (_b) {\r\n                    switch (_b.label) {\r\n                        case 0:\r\n                            currentUser = getCurrentUser();\r\n                            userEmail = currentUser ? currentUser.mail : \"\";\r\n                            if (!!this.persistedState) return [3 /*break*/, 2];\r\n                            _a = this;\r\n                            return [4 /*yield*/, WeekPlannerPersistedState.load(userEmail)];\r\n                        case 1:\r\n                            _a.persistedState = _b.sent();\r\n                            _b.label = 2;\r\n                        case 2:\r\n                            weekDate = this.persistedState.weekDate;\r\n                            weekNumber = moment(weekDate).week();\r\n                            kedWeek = KEDWeek(moment(weekDate).year(), weekNumber);\r\n                            /*const [from, to] = [moment(weekDate).startOf('week'), moment(weekDate).endOf('week')]\r\n                              .map(m => m.toDate().getTime());*/\r\n                            return [2 /*return*/, {\r\n                                    from: kedWeek.notBefore,\r\n                                    to: kedWeek.notAfter,\r\n                                    role: \"USER\",\r\n                                    include: [\"task\", \"course\"],\r\n                                    flags: [\"includeIdsOnly\"],\r\n                                }];\r\n                    }\r\n                });\r\n            }); }\r\n        }) || this;\r\n        _this.persistedState = null;\r\n        _this.getCurrentUser = getCurrentUser;\r\n        return _this;\r\n    }\r\n    UserTasksRepo.prototype.updatePersistedState = function (stateChanges) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        Object.assign(this.persistedState, stateChanges);\r\n                        return [4 /*yield*/, this.persistedState.save()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.mem.notifySubscribers();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setTaskDoneState = function (userTask, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client, modifiedItem, similarTasks, identicalTasks;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        modifiedItem = Object.assign({}, userTask, { done: done });\r\n                        if (!optimistic) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.mem.update(Object.assign({}, modifiedItem, { $meta: 'updating' }))];\r\n                    case 1:\r\n                        _b.sent();\r\n                        _b.label = 2;\r\n                    case 2: return [4 /*yield*/, client.list('usertasks', {\r\n                            name: userTask.name,\r\n                            role: \"USER\",\r\n                            include: [\"task\", \"course\"],\r\n                            flags: [\"includeIdsOnly\"],\r\n                            from: moment(this.persistedState.weekDate).add(-3, 'weeks').valueOf(),\r\n                            to: moment(this.persistedState.weekDate).add(3, 'weeks').valueOf()\r\n                        }, {\r\n                            cache: 'no-cache'\r\n                        })];\r\n                    case 3:\r\n                        similarTasks = _b.sent();\r\n                        identicalTasks = similarTasks.filter(function (t) {\r\n                            return t.courseName === userTask.courseName &&\r\n                                t.learningGoal === userTask.learningGoal &&\r\n                                (!userTask.task || t.task.map(function (t) { return t.id; }).join('') === userTask.task.map(function (t) { return t.id; }).join('')) &&\r\n                                (!userTask.course || t.course.map(function (c) { return c.id; }).join('') === userTask.course.map(function (c) { return c.id; }).join(''));\r\n                        });\r\n                        if (identicalTasks.length === 0) {\r\n                            // Workaround for issue in SubjectPlanner migration (usertasks with long names is not found)\r\n                            identicalTasks.push(userTask);\r\n                        }\r\n                        return [4 /*yield*/, this.update(identicalTasks, function (t) { return t.done = done; })];\r\n                    case 4:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setSubTaskDoneState = function (userTask, subTaskId, done) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, getClient, optimistic, table, client;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.options, getClient = _a.getClient, optimistic = _a.optimistic, table = _a.table;\r\n                        client = getClient();\r\n                        return [4 /*yield*/, this.update([userTask], function (t) { return t.subTasks && t.subTasks.filter(function (st) { return st.id === subTaskId; })\r\n                                .forEach(function (st) { return st.done = done; }); })];\r\n                    case 1:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.setWeekPlannerBoxOpen = function (courseName, isOpen) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var openCourses;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        openCourses = tslib_1.__assign({}, this.persistedState.openCourses);\r\n                        if (isOpen)\r\n                            openCourses[courseName] = true;\r\n                        else\r\n                            delete openCourses[courseName];\r\n                        return [4 /*yield*/, this.updatePersistedState({ openCourses: openCourses })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.changeWeek = function (weekDate, keepCurrentDate) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedState, newPersisted;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        persistedState = this.persistedState;\r\n                        if (!!persistedState) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, WeekPlannerPersistedState.load(this.options.user)];\r\n                    case 1:\r\n                        persistedState = _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        newPersisted = new WeekPlannerPersistedState(persistedState);\r\n                        newPersisted.weekDate = keepCurrentDate ? moment(weekDate).valueOf() : moment(weekDate).startOf('week').valueOf();\r\n                        newPersisted.save();\r\n                        this.persistedState = newPersisted;\r\n                        return [4 /*yield*/, this.mem.refreshFromServer()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UserTasksRepo.prototype.subscribe = function (subscriber) {\r\n        var _this = this;\r\n        var proxySubscriber = function (userTasks) {\r\n            subscriber(userTasks.filter(function (ut) { return !ut.weekTexts; }), _this.persistedState, userTasks.filter(function (ut) { return !!ut.weekTexts; })[0] || {\r\n                id: createUUID(),\r\n                dateTime: _this.persistedState.weekDate,\r\n                weekTexts: { assessment: '', strategy: '' },\r\n                acl: [\r\n                    // Default ACL: Let user self have full control over this item:\r\n                    new DocumentAccess(\"email\", _this.getCurrentUser().mail, \"S\"),\r\n                    // Additional ACL: Let employees on same school have read access to it.\r\n                    // This currently only applies to tasks that refer to course tasks (not own tasks!)\r\n                    new DocumentAccess(\"schoolRole\", _this.getCurrentUser().school + \"/EMPLOYEE\", \"R\")\r\n                ].map(function (ac) { return ac.toString(); })\r\n            });\r\n        };\r\n        proxySubscriber[\"subscriber\"] = subscriber;\r\n        this.mem.subscribe(proxySubscriber);\r\n    };\r\n    UserTasksRepo.prototype.unsubscribe = function (subscriber) {\r\n        this.mem.subscribers = this.mem.subscribers.filter(function (s) { return s[\"subscriber\"] !== subscriber; });\r\n    };\r\n    return UserTasksRepo;\r\n}(KedRepo));\r\nexport { UserTasksRepo };\r\nif (!userTasksRepo) {\r\n    userTasksRepo = env.userTasksRepo = new UserTasksRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser; });\r\n    userTasksRepo.mem.ensureHasData();\r\n}\r\n","export var users = [{\r\n        displayName: \"Administratr\",\r\n        mail: \"vemendo@kedschools.com\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"admin\"\r\n    }, {\r\n        displayName: \"David\",\r\n        mail: \"david.fahlander@vemendo.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"david\",\r\n        schoolGrade: 2\r\n    },\r\n    {\r\n        displayName: \"Andrei\",\r\n        mail: \"andrei.spatarelu@vemendo.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE', 'STUDENT'],\r\n        school: 'KED',\r\n        username: \"andrei\",\r\n        schoolGrade: 7\r\n    }, {\r\n        displayName: \"Carl Holmberg\",\r\n        mail: \"carl.holmberg@kunskapsgymnasiet.se\",\r\n        roles: ['ADMIN', 'EMPLOYEE'],\r\n        school: 'Norrkping',\r\n        username: \"carl.holmberg@kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Carl\",\r\n        mail: \"carl@kedschools.com\",\r\n        roles: ['ADMIN', 'EMPLOYEE', 'STUDENT'],\r\n        school: 'KED',\r\n        username: \"carl\"\r\n    }, {\r\n        displayName: \"david.fahlander@kedschools.com\",\r\n        mail: \"david.fahlander@kedschools.com\",\r\n        roles: [\"ADMIN\", \"EMPLOYEE\", \"STUDENT\"],\r\n        school: \"KED\",\r\n        username: \"david.fahlander@kedschools.com\"\r\n    }, {\r\n        displayName: \"Teacher 1\",\r\n        mail: \"teacher1.classroom@kedschools.com\",\r\n        roles: ['EMPLOYEE'],\r\n        school: 'KED',\r\n        username: \"teacher1.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 3\",\r\n        mail: \"student3.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student3.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 13\",\r\n        mail: \"student13.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student13.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Student 24\",\r\n        mail: \"student24.classroom@kedschools.com\",\r\n        roles: ['STUDENT'],\r\n        school: 'KED',\r\n        username: \"student24.classroom@kedschools.com\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev1\",\r\n        mail: \"ubw6757@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"ubw6757@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev2\",\r\n        mail: \"ums4302@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"ums4302@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev3\",\r\n        mail: \"uhh3460@edu.kunskapsgymnasiet.se\",\r\n        roles: ['STUDENT'],\r\n        school: 'Uppsala',\r\n        username: \"uhh3460@edu.kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev4(fel goals issue)\",\r\n        mail: \"umt6826@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"umt6826@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev5(future abilities)\",\r\n        mail: \"ujg3833@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"ujg3833@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Elev6(future abilities)\",\r\n        mail: \"ujt1363@edu.kunskapsskolan.se\",\r\n        roles: [\"STUDENT\"],\r\n        school: \"Uppsala\",\r\n        username: \"ujt1363@edu.kunskapsskolan.se\"\r\n    }, {\r\n        displayName: \"Test-Live-Lrare1\",\r\n        mail: \"rickard.albertsson@kunskapsgymnasiet.se\",\r\n        roles: ['EMPLOYEE'],\r\n        school: 'Uppsala',\r\n        username: \"rickard.albertsson@kunskapsgymnasiet.se\"\r\n    }, {\r\n        displayName: \"EDSTestUserGymnasium\",\r\n        mail: \"uhh3200@edu.kunskapsgymnasiet.se\",\r\n        //mail: \"UHH3200@EDU.KUNSKAPSGYMNASIET.SE\",\r\n        roles: [\"STUDENT\"],\r\n        username: \"EDSTestUser1\",\r\n        school: \"KED\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"vemendo.elev@kedschools.com\",\r\n        mail: \"vemendo.elev@kedschools.com\",\r\n        roles: [\"STUDENT\"],\r\n        username: \"vemendo.elev@kedschools.com\",\r\n        school: \"KED\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Medarbetare Nacka\",\r\n        mail: \"medarbetare.nacka@kunskapsskolan.se\",\r\n        roles: [\"EMPLOYEE\"],\r\n        username: \"medarbetare.nacka/KS\",\r\n        school: \"Nacka\",\r\n        schoolType: \"Grundskolor\"\r\n    }, {\r\n        displayName: \"Medarbetare Globen\",\r\n        mail: \"medarbetare.globen@kunskapsgymnasiet.se\",\r\n        roles: [\"EMPLOYEE\"],\r\n        username: \"medarbetare.globen/KS\",\r\n        school: \"Globen\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Elev Globen\",\r\n        mail: \"elev.globen@edu.kunskapsgymnasiet.se\",\r\n        schoolGrade: 2,\r\n        roles: ['STUDENT'],\r\n        username: \"elev.globen\",\r\n        school: \"Globen\",\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Elev Bors\",\r\n        mail: \"elev.boras@edu.kunskapsskolan.se\",\r\n        schoolGrade: 7,\r\n        roles: ['STUDENT'],\r\n        username: \"elev.boras\",\r\n        school: \"Bors\",\r\n        schoolType: \"Grundskolor\"\r\n    }, {\r\n        displayName: \"Elev Borlnge\",\r\n        mail: \"elev.borlange@edu.kunskapsskolan.se\",\r\n        schoolGrade: 9,\r\n        roles: ['STUDENT'],\r\n        username: 'elev.borlange/KS',\r\n        school: 'Borlnge',\r\n        schoolType: \"Gymnasium\"\r\n    }, {\r\n        displayName: \"Roll-ls\",\r\n        mail: \"none@kunskapsskolan.se\",\r\n        username: \"none\",\r\n        roles: []\r\n    }];\r\n","import env from '../globals/KED.env';\r\nimport { users } from './data/users';\r\nimport { parseQueryString } from '../utils/query-string';\r\nvar username = parseQueryString(location.search).user;\r\nif (username) {\r\n    var user = users.find(function (u) { return u.username === username; });\r\n    if (user) {\r\n        env.currentUser = user;\r\n    }\r\n}\r\nvar _a = parseQueryString(location.search, { toLower: true }), role = _a.role, school = _a.school, schoolgrade = _a.schoolgrade;\r\nif (env.currentUser) {\r\n    if (role) {\r\n        env.currentUser.roles = role.split(',');\r\n    }\r\n    if (school) {\r\n        env.currentUser.school = school;\r\n    }\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n}\r\n","import cfg from '../globals/KED.cfg';\r\ncfg.KED_LOCALE = 'sv';\r\ncfg.KED_SCHOOL_LOCALE = 'sv';\r\n","import * as tslib_1 from \"tslib\";\r\n// <Initialization>\r\nimport './set-current-user'; // Emulate server-side script to set current user\r\nimport '../global-setters/set-all'; // Client-side initialization\r\nimport './test-config';\r\n// </Initialization>\r\nimport env from '../globals/KED.env';\r\nimport * as React from 'react';\r\nimport { ChooseUser } from './utils/choose-user';\r\nimport { includeCSS } from './utils/include-css';\r\nimport { includeOptionalCSS } from '../utils/include-optional-css';\r\nimport { SubjectPlannerViewerApp } from '../components/course-builder-ks/viewer-editor';\r\nimport { setupIntl } from '../components/utility-components/SetupLanguageIntl';\r\nimport { injectIntl } from 'react-intl';\r\nimport { LanguageContext } from '../components/utility-components/LanguageContext';\r\nincludeOptionalCSS({\r\n    v1: [\r\n        'css/courseviewer.css',\r\n        'css/dialog.css',\r\n        'css/grid-css-patch.css'\r\n    ],\r\n    includeCSS: includeCSS,\r\n    version: 7,\r\n    NOCSS: '6',\r\n    versionFolder: 'css/delta-css/courseviewer'\r\n});\r\nvar _App = /** @class */ (function (_super) {\r\n    tslib_1.__extends(_App, _super);\r\n    function _App(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        if (!location.hash)\r\n            location.hash = \"#/\";\r\n        return _this;\r\n    }\r\n    _App.prototype.render = function () {\r\n        var intl = this.props.intl;\r\n        return env.currentUser ?\r\n            React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n                React.createElement(SubjectPlannerViewerApp, null)) :\r\n            React.createElement(ChooseUser, null);\r\n    };\r\n    return _App;\r\n}(React.Component));\r\nvar App = setupIntl(injectIntl(_App));\r\nexport default App;\r\n","import * as React from 'react';\r\nimport { users } from '../data/users';\r\nexport function ChooseUser() {\r\n    var select;\r\n    return React.createElement(\"div\", { className: \"sv-layout\" },\r\n        React.createElement(\"h2\", null, \"V\\u00E4lj anv\\u00E4ndare\"),\r\n        React.createElement(\"table\", { className: \"login-table\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null,\r\n                    React.createElement(\"th\", null, \"Namn\"),\r\n                    React.createElement(\"th\", null, \"Roller\"),\r\n                    React.createElement(\"th\", null, \"E-post\"),\r\n                    React.createElement(\"th\", null, \"Skola\"))),\r\n            React.createElement(\"tbody\", null, users.map(function (_a) {\r\n                var username = _a.username, displayName = _a.displayName, mail = _a.mail, school = _a.school, roles = _a.roles;\r\n                return React.createElement(\"tr\", { key: mail, onClick: function () { return location.search = \"?user=\" + username; } },\r\n                    React.createElement(\"td\", null, displayName),\r\n                    React.createElement(\"td\", { style: roles.length === 0 ? { fontStyle: 'italic' } : {} }, roles.length === 0 ? \"saknar roller\" : roles.join(', ')),\r\n                    React.createElement(\"td\", null, mail),\r\n                    React.createElement(\"td\", { style: school ? {} : { fontStyle: 'italic' } }, school || \"saknar skola\"));\r\n            }))));\r\n}\r\n;\r\n","function resolve(uri) {\r\n    var href = location.protocol + \"//\" + location.host + location.pathname;\r\n    var pLastSlash = href.lastIndexOf('/');\r\n    return href.substr(0, pLastSlash + 1) + uri;\r\n}\r\nexport function includeCSS(cssFile) {\r\n    document.write('<link rel=\"stylesheet\" href=\"' + resolve(cssFile) + '\" />');\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { db } from '../globals/db';\r\nimport { RemoveItem } from '../components/course-builder/sub-components/remove-item';\r\nvar ErrorSuccessFeedback = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ErrorSuccessFeedback, _super);\r\n    function ErrorSuccessFeedback(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            errors: [],\r\n            infos: []\r\n        };\r\n        _this._unhandledRejection = _this._unhandledRejection.bind(_this);\r\n        _this._error = _this._error.bind(_this);\r\n        _this._customError = _this._customError.bind(_this);\r\n        _this._onInfo = _this._onInfo.bind(_this);\r\n        _this._dbWriterError = _this._dbWriterError.bind(_this);\r\n        _this._dbWriterStateChanged = _this._dbWriterStateChanged.bind(_this);\r\n        return _this;\r\n    }\r\n    ErrorSuccessFeedback.prototype._addError = function (message, details, retryable) {\r\n        var _this = this;\r\n        //console.error(message, {retryable: !!retryable, details});\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            if (errors.some(function (e) { return e.message === message; }))\r\n                return { errors: errors };\r\n            if (errors.length > 2)\r\n                errors = errors.slice(1);\r\n            return {\r\n                errors: errors.concat([{ message: message, details: details, retryable: retryable }])\r\n            };\r\n        });\r\n        // Remove non-retryable errors after 30 seconds:\r\n        if (!retryable)\r\n            setTimeout(function () {\r\n                _this.setState(function (_a) {\r\n                    var errors = _a.errors;\r\n                    return ({\r\n                        errors: errors.filter(function (e) { return e.message !== message; })\r\n                    });\r\n                });\r\n            }, 30000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._addInfo = function (message) {\r\n        var _this = this;\r\n        if (message === \"\") {\r\n            // Turn off current info messages\r\n            this.setState({ infos: [] });\r\n            return;\r\n        }\r\n        this.setState(function (_a) {\r\n            var infos = _a.infos;\r\n            if (infos.some(function (info) { return info === message; }))\r\n                return { infos: infos };\r\n            if (infos.length > 1)\r\n                infos = infos.slice(1);\r\n            return {\r\n                infos: [message] // was: infos.concat(message). But it sucks!\r\n            };\r\n        });\r\n        // Remove info message after 10 seconds:\r\n        setTimeout(function () {\r\n            _this.setState(function (_a) {\r\n                var infos = _a.infos;\r\n                return ({\r\n                    infos: infos.filter(function (msg) { return msg !== message; })\r\n                });\r\n            });\r\n        }, 10000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterError = function (error, retryable) {\r\n        this._addError(\"Det g\\u00E5r inte att spara till servern\", error, retryable);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterStateChanged = function (_a) {\r\n        var isEdited = _a.isEdited, isSaving = _a.isSaving;\r\n        if (!isEdited) {\r\n            // If isEdited is false, a successful write must have happened, and\r\n            // there cannot be any retryable error anymore\r\n            this.setState(function (_a) {\r\n                var errors = _a.errors;\r\n                errors = errors.filter(function (e) { return !e.retryable; });\r\n                return { errors: errors };\r\n            });\r\n        }\r\n        this.setState({\r\n            dbWriterIsEdited: isEdited,\r\n            dbWriterIsSaving: isSaving\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentDidMount = function () {\r\n        window.addEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.addEventListener('error', this._error);\r\n        window.addEventListener('customerror', this._customError);\r\n        window.addEventListener('info', this._onInfo);\r\n        db.writer.onError(this._dbWriterError);\r\n        db.writer.onStateChange(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentWillUnmount = function () {\r\n        window.removeEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.removeEventListener('error', this._error);\r\n        window.removeEventListener('customerror', this._customError);\r\n        window.removeEventListener('info', this._onInfo);\r\n        db.writer.off(this._dbWriterError);\r\n        db.writer.off(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype._unhandledRejection = function (ev) {\r\n        this._addError(\"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.reason);\r\n    };\r\n    ErrorSuccessFeedback.prototype._error = function (ev) {\r\n        this._addError(ev.error ? ev.error.message : \"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.error);\r\n    };\r\n    ErrorSuccessFeedback.prototype._customError = function (ev) {\r\n        this._addError(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype._onInfo = function (ev) {\r\n        this._addInfo(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, errors = _a.errors, infos = _a.infos, dbWriterIsSaving = _a.dbWriterIsSaving;\r\n        return React.createElement(\"div\", { className: \"error-success-feedback\", style: {\r\n                position: \"fixed\",\r\n                left: 0,\r\n                top: 0,\r\n                width: \"100%\",\r\n                pointerEvents: 'none'\r\n            } },\r\n            React.createElement(\"div\", { style: { display: 'table', margin: \"0 auto\" } },\r\n                errors.filter(function (e) { return !e.retryable || !dbWriterIsSaving; })\r\n                    .map(function (_a) {\r\n                    var message = _a.message, details = _a.details, retryable = _a.retryable, showDetails = _a.showDetails;\r\n                    return (React.createElement(\"div\", { key: message, className: \"error\" },\r\n                        React.createElement(\"div\", { style: { float: 'left' } }, message),\r\n                        React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            React.createElement(RemoveItem, { onClick: function () { return _this.removeError(message); } })),\r\n                        details || retryable ? React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            details ? React.createElement(React.Fragment, null,\r\n                                React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.toggleDetails(message); } }, showDetails ? \"Dlj detailer\" : \"Visa detailjer\"),\r\n                                \"\\u00A0\") : undefined,\r\n                            showDetails ? React.createElement(\"p\", null, '' + details) : React.createElement(React.Fragment, null, \"\\u00A0\"),\r\n                            retryable ? React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.retrySave(); } }, \"F\\u00F6rs\\u00F6k spara nu\") : undefined) : undefined));\r\n                }),\r\n                infos.map(function (message) {\r\n                    return React.createElement(\"p\", { key: message, className: \"info\" }, message);\r\n                })));\r\n    };\r\n    ErrorSuccessFeedback.prototype.removeError = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({\r\n                errors: errors.filter(function (e) { return e.message !== message; })\r\n            });\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.retrySave = function () {\r\n        db.writer.retrySave();\r\n    };\r\n    ErrorSuccessFeedback.prototype.toggleDetails = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({ errors: errors.map(function (error) { return error.message === message ? tslib_1.__assign({}, error, { showDetails: !error.showDetails }) :\r\n                    error; })\r\n            });\r\n        });\r\n    };\r\n    return ErrorSuccessFeedback;\r\n}(React.Component));\r\nexport { ErrorSuccessFeedback };\r\n","export function includeOptionalCSS(_a) {\r\n    var v1 = _a.v1, versionFolder = _a.versionFolder, version = _a.version, includeCSS = _a.includeCSS, NOCSS = _a.NOCSS;\r\n    if (!NOCSS) {\r\n        if (v1)\r\n            v1.forEach(function (cssFile) { return includeCSS(cssFile); });\r\n    }\r\n    var cssVer = parseInt(NOCSS);\r\n    if (isNaN(cssVer))\r\n        cssVer = 1;\r\n    for (var ver = cssVer + 1; ver <= version; ++ver) {\r\n        includeCSS(versionFolder + \"/v\" + ver + \".css\");\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport $ from 'jquery';\r\nimport { cfg } from '../globals/KED.cfg';\r\nvar HEARTBEAT_INTERVAL = 5 * 60 * 1000; // 5 minutes.\r\nvar HEARTBEAT_URL = cfg.KED_KEEP_ALIVE_URL;\r\nvar lastActivity = Date.now();\r\nexport function keepSessionAlive() {\r\n    setInterval(onTimeout, HEARTBEAT_INTERVAL);\r\n    setTimeout(function () { return $('body')\r\n        .mousemove(onUserActive)\r\n        .keypress(onUserActive)\r\n        .scroll(onUserActive); }, 100);\r\n}\r\nfunction onUserActive() {\r\n    lastActivity = Date.now();\r\n}\r\nfunction onTimeout() {\r\n    var inactivityTime = Date.now() - lastActivity;\r\n    if (inactivityTime < HEARTBEAT_INTERVAL) {\r\n        heartbeat();\r\n    }\r\n}\r\nfunction heartbeat() {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var res, err_1;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    console.log(\"Sending heartbeat request to \" + HEARTBEAT_URL);\r\n                    _a.label = 1;\r\n                case 1:\r\n                    _a.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, fetch(HEARTBEAT_URL, {\r\n                            cache: 'no-cache',\r\n                            credentials: 'same-origin'\r\n                        })];\r\n                case 2:\r\n                    res = _a.sent();\r\n                    console.log(\"Response from \" + HEARTBEAT_URL + \": \" + res.status + \" \" + res.statusText);\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    err_1 = _a.sent();\r\n                    console.warn(\"Request to \" + HEARTBEAT_URL + \" failed: \" + err_1);\r\n                    return [3 /*break*/, 4];\r\n                case 4: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar DEFAULT_CACHE_EXPIRATION = 30 * 60 * 1000; // 30 minutes.\r\nvar defaultOptions = {\r\n    isApiMethod: function (f) { return typeof f === 'function'; },\r\n    cacheExpiration: DEFAULT_CACHE_EXPIRATION\r\n};\r\nexport function makeSuspenseApi(api, options) {\r\n    if (options === void 0) { options = defaultOptions; }\r\n    options = tslib_1.__assign({}, defaultOptions, options);\r\n    var isApiMethod = options.isApiMethod, cacheExpiration = options.cacheExpiration;\r\n    var rv = Object.create(api);\r\n    var cache = {};\r\n    // Walk the instance + prototype chain to generate suspense version of each promise returning method\r\n    for (var proto = api; proto && proto !== Object.prototype; proto = Object.getPrototypeOf(proto)) {\r\n        suspendify(proto);\r\n    }\r\n    function suspendify(proto) {\r\n        Object.keys(proto).forEach(function (prop) {\r\n            if (!rv.hasOwnProperty(prop) && isApiMethod(prop)) {\r\n                rv[prop] = function () {\r\n                    var args = [];\r\n                    for (var _i = 0; _i < arguments.length; _i++) {\r\n                        args[_i] = arguments[_i];\r\n                    }\r\n                    var key = JSON.stringify(tslib_1.__spread([prop], args));\r\n                    var cachedEntry = cache[key];\r\n                    if (cachedEntry !== undefined) {\r\n                        if (cachedEntry.promise)\r\n                            throw cachedEntry.promise;\r\n                        if (cachedEntry.error)\r\n                            throw cachedEntry.error;\r\n                        if (cachedEntry.timeout > Date.now()) {\r\n                            return cachedEntry.value;\r\n                        }\r\n                    }\r\n                    try {\r\n                        var promise = proto[prop].apply(api, args).then(function (result) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, value: result };\r\n                        }).catch(function (error) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                        });\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, promise: promise };\r\n                        throw promise;\r\n                    }\r\n                    catch (error) {\r\n                        if (error.then)\r\n                            throw error;\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                    }\r\n                };\r\n            }\r\n        });\r\n    }\r\n    return rv;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar PendingJob = /** @class */ (function () {\r\n    function PendingJob(callback) {\r\n        this.timeoutId = null;\r\n        this.cancelled = false;\r\n        this.pending = false;\r\n        this.isJobExecuting = false;\r\n        this.jobCallback = callback;\r\n    }\r\n    PendingJob.prototype.triggerChange = function (throttle) {\r\n        var _this = this;\r\n        if (this.cancelled)\r\n            return;\r\n        this.pending = true;\r\n        if (this.timeoutId !== null)\r\n            clearTimeout(this.timeoutId);\r\n        this.timeoutId = setTimeout(function () { return _this.launchJob(); }, throttle);\r\n    };\r\n    PendingJob.prototype.stop = function () {\r\n        if (this.timeoutId !== null)\r\n            clearTimeout(this.timeoutId);\r\n        this.timeoutId = null;\r\n        this.cancelled = true;\r\n    };\r\n    PendingJob.prototype.launchJob = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.cancelled)\r\n                            return [2 /*return*/];\r\n                        if (!this.pending)\r\n                            return [2 /*return*/];\r\n                        if (this.isJobExecuting)\r\n                            return [2 /*return*/];\r\n                        this.timeoutId = null;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, , 3, 4]);\r\n                        this.isJobExecuting = true;\r\n                        this.pending = false;\r\n                        return [4 /*yield*/, this.jobCallback()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        this.isJobExecuting = false;\r\n                        return [7 /*endfinally*/];\r\n                    case 4:\r\n                        if (!this.pending) return [3 /*break*/, 6];\r\n                        return [4 /*yield*/, this.launchJob()];\r\n                    case 5:\r\n                        _a.sent();\r\n                        _a.label = 6;\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return PendingJob;\r\n}());\r\nexport { PendingJob };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function parseQueryString(locationSearch, options) {\r\n    var toLower = (options || {}).toLower;\r\n    var result = {};\r\n    if (locationSearch && locationSearch.length > 1)\r\n        locationSearch.substr(1)\r\n            .split('&')\r\n            .map(function (part) { return part.split('=').map(function (s) { return decodeURIComponent(s.trim()); }); })\r\n            .forEach(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];\r\n            return result[toLower ? key.toLowerCase() : key] = value;\r\n        });\r\n    return result;\r\n}\r\nfunction encodeParams(params) {\r\n    return Object.keys(params).filter(function (key) { return params[key] !== undefined; }).map(function (key) { return encodeURIComponent(key) + \"=\" + encodeURIComponent(params[key]); }).join('&');\r\n}\r\nexport function generateQueryString(params) {\r\n    return \"?\" + encodeParams(params);\r\n}\r\nexport function parseHashQueryString(locationHash, options) {\r\n    return parseQueryString(locationHash, options);\r\n}\r\nexport function generateHashQueryString(params) {\r\n    return \"#\" + encodeParams(params);\r\n}\r\nexport function splitUrlAndQuery(urlWithPossibleQuery) {\r\n    var pQuery = urlWithPossibleQuery.indexOf('?');\r\n    return pQuery >= 0 ?\r\n        [urlWithPossibleQuery.substr(0, pQuery), urlWithPossibleQuery.substr(pQuery)] :\r\n        [urlWithPossibleQuery, \"\"];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nexport function getFirstAndLastWeekOfTerm(term) {\r\n    return term === 'AT' ?\r\n        [32, 51] :\r\n        [1, 25];\r\n}\r\n//Not used anymore\r\n// export function getTermStartAndEnd(now: moment.Moment) : moment.Moment[] {\r\n//     return now.month() >= 6 ? // 6 = July in JS Dates and in moment as well!\r\n//     [moment(new Date(now.year(), 7, 1)), moment(new Date(now.year(), 11, 31))] : // aug1 - dec31\r\n//     [moment(new Date(now.year(), 0, 1)), moment(new Date(now.year(), 6, 31))]; // jan1 - july31\r\n// }\r\nexport function getTermStarEndDate(date, isFirstTerm) {\r\n    var addYear = date.getMonth() >= 7;\r\n    var termYear = null;\r\n    if (addYear) {\r\n        termYear = isFirstTerm ? date.getFullYear() : date.getFullYear() + 1;\r\n    }\r\n    else {\r\n        termYear = isFirstTerm ? date.getFullYear() - 1 : date.getFullYear();\r\n    }\r\n    var termYearMoment = moment(termYear.toString(), \"YYYY\");\r\n    if (termYearMoment.week() != 1) {\r\n        termYearMoment = termYearMoment.clone().add(1, 'week');\r\n    }\r\n    return isFirstTerm ? [moment(termYearMoment.clone()).week(32).startOf('week'), moment(termYearMoment.clone()).week(51).endOf('week')] :\r\n        [moment(termYearMoment.clone()), moment(termYearMoment.clone()).week(25).endOf('week')];\r\n}\r\nexport function getSchoolMoment(m) {\r\n    var thisYear = m.year();\r\n    var isAutumn = m.month() >= 6; // determine \r\n    var _a = tslib_1.__read(isAutumn ?\r\n        [thisYear, thisYear + 1] :\r\n        [thisYear - 1, thisYear], 2), autumnYear = _a[0], springYear = _a[1];\r\n    var academicYear = '' + autumnYear + '/' + springYear;\r\n    var term = isAutumn ? 'AT' : 'ST';\r\n    var week = m.week();\r\n    return { academicYear: academicYear, term: term, week: week };\r\n}\r\nexport function addYear(aYear, numYearsToAdd) {\r\n    return aYear.split('/')\r\n        .map(function (yearStr) { return parseInt(yearStr) + numYearsToAdd; })\r\n        .map(function (year) { return '' + year; })\r\n        .join('/');\r\n}\r\nexport function nextAcademicYear(aYear) {\r\n    return addYear(aYear, 1);\r\n}\r\nexport function prevAcademicYear(aYear) {\r\n    return addYear(aYear, -1);\r\n}\r\n","import moment from 'moment';\r\nimport { getSchoolMoment, addYear } from './school-moment';\r\nfunction isSchoolMoment(obj) {\r\n    return 'academicYear' in obj;\r\n}\r\nvar SchoolTerm = /** @class */ (function () {\r\n    function SchoolTerm(dateOrSchoolMoment) {\r\n        var schoolMoment = isSchoolMoment(dateOrSchoolMoment) ?\r\n            dateOrSchoolMoment : getSchoolMoment(moment(dateOrSchoolMoment));\r\n        this.academicYear = schoolMoment.academicYear;\r\n        this.term = schoolMoment.term;\r\n    }\r\n    Object.defineProperty(SchoolTerm.prototype, \"year\", {\r\n        get: function () {\r\n            return parseInt(this.academicYear\r\n                .split('/')[this.term === 'AT' ? 0 : 1]);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    SchoolTerm.prototype.nextTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: this.academicYear\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: addYear(this.academicYear, 1)\r\n            });\r\n    };\r\n    SchoolTerm.prototype.prevTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: addYear(this.academicYear, -1)\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: this.academicYear\r\n            });\r\n    };\r\n    SchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\r\n        var year = this.term === 'AT' ?\r\n            this.academicYear.split('/')[0] :\r\n            this.academicYear.split('/')[1];\r\n        if (shortYear)\r\n            year = year.substr(2);\r\n        return this.term === 'AT' ? intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'HT {year}' }, { year: year }) :\r\n            intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'VT {year}' }, { year: year });\r\n    };\r\n    return SchoolTerm;\r\n}());\r\nexport { SchoolTerm };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function capitalizeFirst(str) {\r\n    for (var i = 0, l = str.length; i < l; ++i) {\r\n        if (str.charCodeAt(i) < 0x2000) {\r\n            return str.substr(0, i) + str[i].toLocaleUpperCase() + str.substr(i + 1);\r\n        }\r\n    }\r\n    return str;\r\n}\r\nexport function extend(obj, extension) {\r\n    if (typeof extension !== 'object')\r\n        return obj;\r\n    Object.keys(extension).forEach(function (key) {\r\n        obj[key] = extension[key];\r\n    });\r\n    return obj;\r\n}\r\nexport function clone(obj, extension) {\r\n    var clone = {};\r\n    Object.getOwnPropertyNames(obj).forEach(function (key) {\r\n        Object.defineProperty(clone, key, Object.getOwnPropertyDescriptor(obj, key));\r\n    });\r\n    if (extension)\r\n        extend(clone, extension);\r\n    return clone;\r\n}\r\nvar concat = [].concat;\r\nexport function flatten(a) {\r\n    return concat.apply([], a);\r\n}\r\nexport function compareProp(prop) {\r\n    return function (a, b) {\r\n        var aProp = a[prop], bProp = b[prop];\r\n        return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n    };\r\n}\r\nexport function compareProps(props, locales, options) {\r\n    props = Array.isArray(props) ? props : [props];\r\n    var localeCompare = function (a, b) {\r\n        return typeof a === 'string' ?\r\n            a.localeCompare(b, locales, options) :\r\n            a < b ? -1 : a > b ? 1 : 0;\r\n    };\r\n    function cmpPart(a, b, firstPart, rest) {\r\n        var firstA = a[firstPart];\r\n        var firstB = b[firstPart];\r\n        if (firstA === firstB)\r\n            return 0;\r\n        if (firstA == null)\r\n            return -1;\r\n        if (firstB == null)\r\n            return 1;\r\n        return rest.length === 0 ?\r\n            localeCompare(firstA, firstB) :\r\n            cmpPart(firstA, firstB, rest[0], rest.slice(1));\r\n    }\r\n    return props\r\n        .map(function (prop) { return prop.split('.'); })\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a), firstPart = _b[0], rest = _b.slice(1);\r\n        return function (a, b) { return cmpPart(a, b, firstPart, rest); };\r\n    })\r\n        .reduce(function (cmp1, cmp2) {\r\n        return function (a, b) { return cmp1(a, b) || cmp2(a, b); };\r\n    });\r\n}\r\nexport function L(text) {\r\n    var args = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        args[_i - 1] = arguments[_i];\r\n    }\r\n    var first = text[0];\r\n    return buildMessage(text, args);\r\n}\r\nfunction buildMessage(text, args) {\r\n    var rv = text[0];\r\n    for (var i = 1, l = text.length; i < l; ++i) {\r\n        rv += args[i - 1] + text[i];\r\n    }\r\n    return rv;\r\n}\r\nvar TC = /** @class */ (function () {\r\n    function TC(template) {\r\n        extend(this, template);\r\n    }\r\n    return TC;\r\n}());\r\nexport { TC };\r\nexport function dateTimeReviver(key, value) {\r\n    var a;\r\n    if (typeof value === 'string') {\r\n        a = /\\/Date\\((\\d*)\\)\\//.exec(value);\r\n        if (a) {\r\n            return new Date(+a[1]);\r\n        }\r\n    }\r\n    return value;\r\n}\r\n//let infoSerial = 1;\r\nexport function showInfo(msg) {\r\n    var event = new CustomEvent('info', { 'detail': msg });\r\n    window.dispatchEvent(event);\r\n}\r\nexport function showError(errMsg) {\r\n    var msg = typeof errMsg === 'string' ? errMsg : errMsg.message;\r\n    var event = new CustomEvent('customerror', { 'detail': msg });\r\n    console.error(errMsg);\r\n    window.dispatchEvent(event);\r\n}\r\nexport function maxLength(str, maxLen) {\r\n    return str.length > maxLen ?\r\n        str.substr(0, maxLen - 3) + \"...\" :\r\n        str;\r\n}\r\nexport function arrayToLookup(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        var array = result[key];\r\n        if (array)\r\n            array.push(item);\r\n        else\r\n            result[key] = [item];\r\n    }\r\n    return result;\r\n}\r\nexport function arrayToMap(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        result[key] = item;\r\n    }\r\n    return result;\r\n}\r\nexport function cherryPickProps(obj, propsToPick) {\r\n    var e_1, _a;\r\n    var result = {};\r\n    try {\r\n        for (var propsToPick_1 = tslib_1.__values(propsToPick), propsToPick_1_1 = propsToPick_1.next(); !propsToPick_1_1.done; propsToPick_1_1 = propsToPick_1.next()) {\r\n            var param = propsToPick_1_1.value;\r\n            if (param in obj)\r\n                result[param] = obj[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (propsToPick_1_1 && !propsToPick_1_1.done && (_a = propsToPick_1.return)) _a.call(propsToPick_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\nexport function distinct(a, keyAccessor) {\r\n    var map = arrayToMap(a, keyAccessor || (function (x) { return x; }));\r\n    return Object.keys(map).map(function (key) { return map[key]; });\r\n}\r\nexport function shallowEquals(a, b) {\r\n    if (a === b)\r\n        return true;\r\n    if (!a || !b)\r\n        return false;\r\n    if (typeof a !== 'object' || typeof b !== 'object')\r\n        return false;\r\n    var keysA = Object.keys(a);\r\n    var keysB = Object.keys(b);\r\n    if (keysA.length !== keysB.length)\r\n        return false;\r\n    for (var i = 0, l = keysA.length; i < l; ++i) {\r\n        var key = keysA[i];\r\n        if (keysB[i] !== key)\r\n            return false;\r\n        if (a[key] !== b[key])\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\n","import moment from \"moment\";\r\nexport function KEDWeek(year, week) {\r\n    var m = moment(new Date(year, 1, 1)).week(week);\r\n    var res = {\r\n        year: year,\r\n        week: week,\r\n        notBefore: m.clone().startOf('week').add(-2, 'days').toDate().getTime(),\r\n        notAfter: m.clone().startOf('week').add(5, 'days').toDate().getTime()\r\n    };\r\n    return res;\r\n}\r\nexport function getNextWeekDate(date) {\r\n    var nextDate = moment(date).add(1, 'week');\r\n    //Set the 01.01 of the next year in case the next week is in the same year \r\n    //and the previous week is the last week of the year\r\n    if (date.week() === date.weeksInYear() && nextDate.year() === date.year()) {\r\n        return { adjusted: true, nextDate: moment(date.year() + 1 + \"-01-01\").toDate() };\r\n    }\r\n    return { adjusted: false, nextDate: nextDate.toDate() };\r\n}\r\nexport function getPrevWeekDate(date) {\r\n    var prevDate = moment(date).add(-1, 'week');\r\n    //Set the 01.01 of the current year in case the prev week is in the previous year\r\n    if (date.week() === 2 && prevDate.year() !== date.year()) {\r\n        return { adjusted: true, nextDate: moment(date.year() + \"-01-01\").toDate() };\r\n    }\r\n    return { adjusted: false, nextDate: prevDate.toDate() };\r\n}\r\nexport function getAdjustedWeek(m) {\r\n    var clone = m.clone();\r\n    return m.weekday() >= 5 ? // Lrdag 00:00 / Sndag 00:00?\r\n        m.week() + 1 : // Tillhr nsta vecka\r\n        m.week();\r\n}\r\n/*export function getWeekLimits (m: Moment) {\r\n  const clonedSwedish = m.clone().locale('sv');\r\n  const limits = {\r\n    notBefore: clonedSwedish.startOf('week').add(-2, 'days'),\r\n    notAfter: clonedSwedish.startOf('week').add(5, 'days')\r\n  };\r\n}\r\n*/\r\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AClBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACnPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC1FA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/JA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3NA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9NA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjCA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACPA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrVA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjXA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7GA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACrXA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;ACFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9BA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjEA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACfA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACXA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACNA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjCA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9HA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;ACFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnFA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3HA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1HA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrQA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/FA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACreA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1EA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9BA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9BA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClJA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACfA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3HA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtGA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvRA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzcA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3DA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/QA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtMA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnKA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvBA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;ACFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxKA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}