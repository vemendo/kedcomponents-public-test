{"version":3,"file":"kedappcoursebuilder.js","sources":["webpack://[name]/webpack/bootstrap","webpack://[name]/./kedbackend/client.js","webpack://[name]/./kedbackend/clientweb.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/bearer-storage-sessionstorage.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/hash-restorer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client-web/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/access-control.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/http-error.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/ked-bearer-provider.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/restclient.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-client/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/cache-bust.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/apply-mutations-on-deltas.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-cache.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-collection/delta-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/delta-merge.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-collection.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-query.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-repo.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-subscription.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/kedbackend-writer.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/mutation-queue.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/query-set.js","webpack://[name]/./kedbackend/js/dist/js/ked-backend-repo/utils.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/index.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-course.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate-task.js","webpack://[name]/./kedbackend/js/dist/js/ked-model-migrator/migrate.js","webpack://[name]/./kedbackend/js/dist/js/observable/collection.js","webpack://[name]/./kedbackend/js/dist/js/observable/emitter.js","webpack://[name]/./kedbackend/js/dist/js/observable/fiber-context.js","webpack://[name]/./kedbackend/js/dist/js/observable/index.js","webpack://[name]/./kedbackend/js/dist/js/observable/map.js","webpack://[name]/./kedbackend/js/dist/js/observable/mixin.js","webpack://[name]/./kedbackend/js/dist/js/observable/observable.js","webpack://[name]/./kedbackend/js/dist/js/observable/value.js","webpack://[name]/./kedbackend/observable.js","webpack://[name]/./kedbackend/repo.js","webpack://[name]/./src/access-control/get-user-claims.ts","webpack://[name]/./src/access-control/index.ts","webpack://[name]/./src/apis/buttons.tsx","webpack://[name]/./src/apis/configs.ts","webpack://[name]/./src/apis/edsclient.ts","webpack://[name]/./src/apis/google-classroom-sync.ts","webpack://[name]/./src/apis/google-client.ts","webpack://[name]/./src/apis/google-drive.ts","webpack://[name]/./src/apis/google-picker.ts","webpack://[name]/./src/apis/google-webclient.ts","webpack://[name]/./src/apis/mock/mock-classroom-data.ts","webpack://[name]/./src/components/charts/goal-progress.tsx","webpack://[name]/./src/components/course-builder-ks/logic/ordered-requirements.ts","webpack://[name]/./src/components/course-builder-ks/logic/task-order.ts","webpack://[name]/./src/components/course-builder/courses/business-logic.ts","webpack://[name]/./src/components/course-builder/courses/course-banner.tsx","webpack://[name]/./src/components/course-builder/courses/course-module-list.tsx","webpack://[name]/./src/components/course-builder/courses/course-module.tsx","webpack://[name]/./src/components/course-builder/courses/create-new.tsx","webpack://[name]/./src/components/course-builder/courses/edit-course.tsx","webpack://[name]/./src/components/course-builder/courses/index.tsx","webpack://[name]/./src/components/course-builder/courses/inner-edit-course.tsx","webpack://[name]/./src/components/course-builder/index.tsx","webpack://[name]/./src/components/course-builder/knowledge-matrix-partial-utils.ts","webpack://[name]/./src/components/course-builder/modal-pages/edit-resource.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/basic-editable-task-fields.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/edit-task.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/index.ts","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/previewable-task-fields.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/save-or-cancel-buttons.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/search-results.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/task-content-fragment.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/task-migration-box.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-task/task-status-fragment.tsx","webpack://[name]/./src/components/course-builder/modal-pages/edit-workflow-link.tsx","webpack://[name]/./src/components/course-builder/schools/edit-school.tsx","webpack://[name]/./src/components/course-builder/schools/editable-school-list.tsx","webpack://[name]/./src/components/course-builder/schools/index.tsx","webpack://[name]/./src/components/course-builder/schools/new-school.tsx","webpack://[name]/./src/components/course-builder/sub-components/editable-resource-list.tsx","webpack://[name]/./src/components/course-builder/sub-components/editable-task-list.tsx","webpack://[name]/./src/components/course-builder/sub-components/editable-teacher-list.tsx","webpack://[name]/./src/components/course-builder/sub-components/editable-workflow-link.tsx","webpack://[name]/./src/components/course-builder/sub-components/knowledge-matrix.tsx","webpack://[name]/./src/components/course-builder/sub-components/remove-item.tsx","webpack://[name]/./src/components/course-builder/sub-components/school-courses.tsx","webpack://[name]/./src/components/course-builder/sub-components/select-related-docs.tsx","webpack://[name]/./src/components/course-builder/sub-components/select-study-groups.tsx","webpack://[name]/./src/components/course-builder/sub-components/select-teacher.tsx","webpack://[name]/./src/components/course-builder/sub-components/spinner.tsx","webpack://[name]/./src/components/course-builder/sub-components/weighted-items-table.tsx","webpack://[name]/./src/components/course-builder/subjects/diff/diff-xml-with-database.ts","webpack://[name]/./src/components/course-builder/subjects/diff/migrate-subject.ts","webpack://[name]/./src/components/course-builder/subjects/index.tsx","webpack://[name]/./src/components/course-builder/subjects/show-subject-inner.tsx","webpack://[name]/./src/components/course-builder/subjects/show-subject.tsx","webpack://[name]/./src/components/course-builder/subjects/skolverket-subject.ts","webpack://[name]/./src/components/course-builder/subjects/subjects-inner.tsx","webpack://[name]/./src/components/course-builder/subjects/uploaded-subject.tsx","webpack://[name]/./src/components/course-builder/utils.ts","webpack://[name]/./src/components/course-viewer/subcomponents/task-fileview.tsx","webpack://[name]/./src/components/utility-components/LanguageContext.tsx","webpack://[name]/./src/components/utility-components/SetupLanguageIntl.tsx","webpack://[name]/./src/components/utility-components/align-horizontal.tsx","webpack://[name]/./src/components/utility-components/checkbox.tsx","webpack://[name]/./src/components/utility-components/content-editable-field.tsx","webpack://[name]/./src/components/utility-components/form-field-text-input.tsx","webpack://[name]/./src/components/utility-components/form-field.tsx","webpack://[name]/./src/components/utility-components/horizontal-item.tsx","webpack://[name]/./src/components/utility-components/observe.tsx","webpack://[name]/./src/components/utility-components/open-close-box.tsx","webpack://[name]/./src/components/utility-components/sortable-task-list.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/actions-sv.ts","webpack://[name]/./src/components/utility-components/wysiwyg/actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/exec.ts","webpack://[name]/./src/components/utility-components/wysiwyg/html-patch-policy.ts","webpack://[name]/./src/components/utility-components/wysiwyg/image-edit-actions.ts","webpack://[name]/./src/components/utility-components/wysiwyg/index.tsx","webpack://[name]/./src/components/utility-components/wysiwyg/wash-html.ts","webpack://[name]/./src/contracts/ked-models.ts","webpack://[name]/./src/elements/KEDAppCourseBuilder/app.coursebuilder.client.tsx","webpack://[name]/./src/elements/KEDAppCourseBuilder/webpack-entry.ts","webpack://[name]/./src/features/features.ts","webpack://[name]/./src/features/index.ts","webpack://[name]/./src/global-setters/configure.ts","webpack://[name]/./src/global-setters/set-all.ts","webpack://[name]/./src/global-setters/set-bearer-providers.ts","webpack://[name]/./src/global-setters/set-eds-client.ts","webpack://[name]/./src/global-setters/set-ked-backend-client.ts","webpack://[name]/./src/globals/KED.cfg.ts","webpack://[name]/./src/globals/KED.env.ts","webpack://[name]/./src/globals/KED.ts","webpack://[name]/./src/globals/current-user.ts","webpack://[name]/./src/globals/db.ts","webpack://[name]/./src/globals/ked.ts","webpack://[name]/./src/repos/repo.ts","webpack://[name]/./src/repos/school-courses.ts","webpack://[name]/./src/utils/cached-response.ts","webpack://[name]/./src/utils/error-success-feedback.tsx","webpack://[name]/./src/utils/keep-session-alive.ts","webpack://[name]/./src/utils/make-suspense-api.ts","webpack://[name]/./src/utils/query-string.ts","webpack://[name]/./src/utils/school-moment.ts","webpack://[name]/./src/utils/school-term.ts","webpack://[name]/./src/utils/utils.ts"],"sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(Object.prototype.hasOwnProperty.call(installedChunks, chunkId) && installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"kedappcoursebuilder\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp_name_\"] = window[\"webpackJsonp_name_\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([\"./src/elements/KEDAppCourseBuilder/webpack-entry.ts\",\"vendors\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","export * from './js/dist/js/ked-backend-client';","export * from './js/dist/js/ked-backend-client-web';","var BearerStorageSessionStorage = /** @class */ (function () {\r\n    function BearerStorageSessionStorage() {\r\n    }\r\n    BearerStorageSessionStorage.prototype.save = function (id, tokenInfo) {\r\n        sessionStorage.setItem(\"bearer-\" + id, JSON.stringify(tokenInfo));\r\n    };\r\n    BearerStorageSessionStorage.prototype.load = function (id) {\r\n        try {\r\n            var json = sessionStorage.getItem(\"bearer-\" + id);\r\n            return Promise.resolve(json ? JSON.parse(json) : { token: null, expires: 0 });\r\n        }\r\n        catch (ex) {\r\n            return Promise.resolve({ token: null, expires: 0 });\r\n        }\r\n    };\r\n    return BearerStorageSessionStorage;\r\n}());\r\nexport { BearerStorageSessionStorage };\r\n//# sourceMappingURL=bearer-storage-sessionstorage.js.map","var redirHash = sessionStorage.getItem(\"redir-hash\");\r\nif (redirHash)\r\n    try {\r\n        var _a = JSON.parse(redirHash), time = _a.time, hash = _a.hash;\r\n        if (time && time > Date.now() - 60000) {\r\n            sessionStorage.removeItem(\"redir-hash\");\r\n            location.hash = hash;\r\n        }\r\n    }\r\n    catch (_) { }\r\nexport function rememberHashLocation() {\r\n    sessionStorage.setItem(\"redir-hash\", JSON.stringify({ time: Date.now(), hash: location.hash }));\r\n}\r\n//# sourceMappingURL=hash-restorer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendClient, HttpError } from '../ked-backend-client';\r\nimport { BearerStorageSessionStorage } from \"./bearer-storage-sessionstorage\";\r\nimport { avoidSimultanousCalls } from '../ked-backend-client/utils';\r\nimport { KedModelMigratorMixin } from '../ked-model-migrator';\r\nimport './hash-restorer';\r\nimport { rememberHashLocation } from './hash-restorer';\r\nKedModelMigratorMixin(KedBackendClient.prototype);\r\nexport var storage = new BearerStorageSessionStorage();\r\nvar timeOfPageLoad = Date.now();\r\nvar WebServerBearerProvider = /** @class */ (function () {\r\n    function WebServerBearerProvider(tokenPath, tokenResponseMapper, tokenId) {\r\n        this.tokenPath = tokenPath;\r\n        this.tokenResponseMapper = tokenResponseMapper;\r\n        this.tokenId = tokenId;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    WebServerBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!!this.tokenInfo.token) return [3 /*break*/, 2];\r\n                        if (!this.tokenId) return [3 /*break*/, 2];\r\n                        _a = this;\r\n                        return [4 /*yield*/, storage.load(this.tokenId)];\r\n                    case 1:\r\n                        _a.tokenInfo = _b.sent();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        if (!(this.tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _b.sent();\r\n                        _b.label = 4;\r\n                    case 4: return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WebServerBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, _c, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0: return [4 /*yield*/, fetch(this.tokenPath, {\r\n                            headers: { Accept: \"text/plain; application/json\" },\r\n                            redirect: 'manual',\r\n                            cache: 'no-cache',\r\n                            credentials: \"same-origin\"\r\n                        })];\r\n                    case 1:\r\n                        res = _e.sent();\r\n                        if (res.status === 302 || (!res.status && res.type === \"opaqueredirect\")) {\r\n                            // User session timed out and server wants to redirect entire page to login page\r\n                            // Time to reload current page to force a redirect of the entire page instead for\r\n                            // just redirecting to /api/token or whatever.\r\n                            if (Date.now() - timeOfPageLoad > 60000) { // prohibit endless loop of reloading self.\r\n                                this.wantsRedirect = true; // So that listeners to onbeforeunload could show alternate message.\r\n                                console.log(\"Redirect wanted. Reload page.\");\r\n                                rememberHashLocation();\r\n                                window.location.reload(true);\r\n                                throw new HttpError(302, \"Redirected\");\r\n                            }\r\n                        }\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = Error.bind;\r\n                        _b = \"HTTP\" + res.status + \" \";\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(Error, [void 0, _b + (_e.sent())]))();\r\n                    case 3:\r\n                        _c = this;\r\n                        _d = this.tokenResponseMapper;\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 4:\r\n                        _c.tokenInfo = _d.apply(this, [_e.sent()]);\r\n                        storage.save(this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WebServerBearerProvider;\r\n}());\r\nexport { WebServerBearerProvider };\r\nexport var isomorphic = { fetch: fetch.bind(self), btoa: btoa.bind(self) };\r\nvar KedBackendClientWeb = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendClientWeb, _super);\r\n    function KedBackendClientWeb(apiBaseUrl, providerOrTokenPath, options) {\r\n        var _this = this;\r\n        var bearerProvider = typeof providerOrTokenPath !== 'string' ?\r\n            providerOrTokenPath :\r\n            new WebServerBearerProvider(providerOrTokenPath, (options && options.tokenResponseMapper) || (function (x) { return ({ token: x, expires: Date.now() + 59 * 60 * 60 }); }), options && options.tokenId);\r\n        _this = _super.call(this, isomorphic, bearerProvider, apiBaseUrl) || this;\r\n        return _this;\r\n    }\r\n    return KedBackendClientWeb;\r\n}(KedBackendClient));\r\nexport { KedBackendClientWeb };\r\n//# sourceMappingURL=index.js.map","var DocumentAccess = /** @class */ (function () {\r\n    function DocumentAccess(accessClaimType, accessClaimValue, right) {\r\n        this.accessClaimType = accessClaimType;\r\n        this.accessClaimValue = accessClaimValue;\r\n        this.right = right;\r\n    }\r\n    DocumentAccess.fromString = function (ac) {\r\n        if (!ac)\r\n            return null;\r\n        var split = ac.split(':');\r\n        if (split.length < 3)\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        var claimType = DocumentAccess.unescape(split[0]);\r\n        var claimValue = DocumentAccess.unescape(split[1]);\r\n        var right = split[2];\r\n        if (right !== 'R' && right !== 'W' && right !== 'S')\r\n            throw new Error(\"Invalid access string: \" + ac);\r\n        return new DocumentAccess(claimType, claimValue, right);\r\n    };\r\n    DocumentAccess.escape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%/g, \"%25\").replace(/\\:/g, \"%3A\");\r\n    };\r\n    DocumentAccess.unescape = function (accessComponent) {\r\n        return accessComponent.replace(/\\%3A/g, \":\").replace(/\\%25/g, \"%\");\r\n    };\r\n    DocumentAccess.prototype.toString = function () {\r\n        return DocumentAccess.escape(this.accessClaimType) + \":\" +\r\n            DocumentAccess.escape(this.accessClaimValue) + \":\" +\r\n            this.right;\r\n    };\r\n    DocumentAccess.fromStringArray = function (acl) {\r\n        return acl\r\n            .map(function (ac) { return DocumentAccess.fromString(ac); })\r\n            .filter(function (ac) { return ac; });\r\n    };\r\n    DocumentAccess.toStringArray = function (acl) {\r\n        return acl.map(function (ac) { return ac.toString(); });\r\n    };\r\n    return DocumentAccess;\r\n}());\r\nexport { DocumentAccess };\r\nexport function hasAccess(acl, userClaims, requestedRight) {\r\n    if (userClaims.some(function (claim) { return claim.type === 'role' && claim.value === \"ADMIN\"; }))\r\n        return true;\r\n    return acl.some(function (a) {\r\n        return userClaims.some(function (c) {\r\n            return a.accessClaimType === c.type &&\r\n                a.accessClaimValue === c.value && ((a.right === 'R' && requestedRight === 'R') ||\r\n                (a.right === 'W' && ['R', 'W'].indexOf(requestedRight) >= 0) ||\r\n                (a.right === 'S'));\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=access-control.js.map","import * as tslib_1 from \"tslib\";\r\nvar HttpError = /** @class */ (function (_super) {\r\n    tslib_1.__extends(HttpError, _super);\r\n    function HttpError(code, message) {\r\n        var _this = _super.call(this, \"HTTP\" + code + \" \" + message) || this;\r\n        _this.code = code;\r\n        _this.message = message;\r\n        _this.name = \"http\" + code;\r\n        _this.message = \"HTTP\" + code + \" \" + message;\r\n        return _this;\r\n    }\r\n    return HttpError;\r\n}(Error));\r\nexport { HttpError };\r\n//# sourceMappingURL=http-error.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nexport * from './utils';\r\nexport { KedBearerProvider } from './ked-bearer-provider';\r\nexport * from './access-control';\r\nexport { RestClient };\r\nimport { HttpError } from './http-error';\r\nexport { HttpError };\r\nexport * from './restclient';\r\n;\r\n// | 'otherFlag' | 'thirdFlag';...\r\nvar KedBackendClient = /** @class */ (function () {\r\n    function KedBackendClient(isomorphic, bearerProvider, baseUrl) {\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n    }\r\n    KedBackendClient.prototype.getMyClaims = function (table, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"me/claims/\" + (table || \"\"), null, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.get = function (table, id, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(table + \"/\" + id, options, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.list = function (table, options, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = tslib_1.__assign({}, options);\r\n                        if (typeof location !== 'undefined' && location.search.includes('useSP')) {\r\n                            if (!options.from &&\r\n                                !options.to &&\r\n                                (!options.include || !options.include.includes(\"acl\")) &&\r\n                                !options.role &&\r\n                                !options.name &&\r\n                                [options.hasEdgesFrom, options.hasEdgesTo, options.ids, options.tags].filter(function (x) { return !!x; }).length === 1) {\r\n                                query.flags = (query.flags || []).concat(['useSP']);\r\n                            }\r\n                        }\r\n                        if (options && options.mutationsOnEmpty)\r\n                            query.mutationsOnEmpty = JSON.stringify(options.mutationsOnEmpty);\r\n                        return [4 /*yield*/, this.http.get(\"\" + table, query, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.batch = function (reqs, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        // Reorder operations so that 'add's come first and 'delete's come last:\r\n                        reqs = reqs.slice().sort(function (req1, req2) {\r\n                            return req1.op === 'add' ? -1 : req2.op === 'add' ? 1 :\r\n                                req1.op === 'delete' ? 1 : req2.op === 'delete' ? -1 : 0;\r\n                        });\r\n                        return [4 /*yield*/, this.http.post(\"batch\", reqs, fetchOptions)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.do = function (scopeFn) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var runner;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        runner = new BatchRunner();\r\n                        scopeFn(runner);\r\n                        return [4 /*yield*/, this.batch(runner.mutationRequests)];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.deleteRealm = function (realm) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.delete(\"realms/\" + realm)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendClient.prototype.add = function (table, doc, branchId) {\r\n        return this.do(function (r) { return r.add(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.put = function (table, doc) {\r\n        return this.do(function (r) { return r.put(table, doc); });\r\n    };\r\n    KedBackendClient.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        return this.do(function (r) { return r.update(table, id, deltaDoc, branchId); });\r\n    };\r\n    KedBackendClient.prototype.merge = function (branchId, targetBranchId) {\r\n        return this.do(function (r) { return r.merge(branchId, targetBranchId); });\r\n    };\r\n    KedBackendClient.prototype.clearBranch = function (branchId) {\r\n        return this.do(function (r) { return r.clearBranch(branchId); });\r\n    };\r\n    KedBackendClient.prototype.delete = function (table, id) {\r\n        return this.do(function (r) { return r.delete(table, id); });\r\n    };\r\n    KedBackendClient.prototype.share = function (table, id, acl) {\r\n        return this.do(function (r) { return r.share(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.unshare = function (table, id, acl) {\r\n        return this.do(function (r) { return r.unshare(table, id, acl); });\r\n    };\r\n    KedBackendClient.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.link(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.link2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.link2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        return this.do(function (r) { return r.unlink(sourceTable, sourceId, targetTable, targetId, label); });\r\n    };\r\n    KedBackendClient.prototype.unlink2 = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.unlink2(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    KedBackendClient.prototype.undoLink = function (sourceTable, sourceId, targetId, label, branchId) {\r\n        return this.do(function (r) { return r.undoLink(sourceTable, sourceId, label, targetId, branchId); });\r\n    };\r\n    return KedBackendClient;\r\n}());\r\nexport { KedBackendClient };\r\nvar BatchRunner = /** @class */ (function () {\r\n    function BatchRunner() {\r\n        this.mutationRequests = [];\r\n    }\r\n    BatchRunner.prototype.add = function (table, doc, branchId) {\r\n        this.mutationRequests.push({ op: 'add', table: table, doc: doc, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.put = function (table, doc) {\r\n        doc = tslib_1.__assign({}, doc);\r\n        delete doc.acl; // Forbidden to send acl with put() calls.\r\n        this.mutationRequests.push({ op: 'put', table: table, doc: doc });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.update = function (table, id, deltaDoc, branchId) {\r\n        deltaDoc = tslib_1.__assign({}, deltaDoc);\r\n        this.mutationRequests.push({ op: 'update', table: table, id: id, deltaDoc: deltaDoc, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.merge = function (branchId, targetBranchId) {\r\n        this.mutationRequests.push({ op: 'merge', branchId: branchId, targetBranchId: targetBranchId });\r\n    };\r\n    BatchRunner.prototype.clearBranch = function (branchId) {\r\n        this.mutationRequests.push({ op: 'clear-branch', branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.delete = function (table, id) {\r\n        this.mutationRequests.push({ op: 'delete', table: table, id: id });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.share = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'share', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unshare = function (table, id, acl) {\r\n        this.mutationRequests.push({ op: 'unshare', table: table, id: id, acl: acl });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.link2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    BatchRunner.prototype.unlink = function (sourceTable, sourceId, targetTable, targetId, label) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetTable: targetTable, targetId: targetId, label: label });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.unlink2 = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'unlink', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n        return this;\r\n    };\r\n    BatchRunner.prototype.undoLink = function (sourceTable, sourceId, label, targetId, branchId) {\r\n        this.mutationRequests.push({ op: 'undo-link', sourceTable: sourceTable, sourceId: sourceId, targetId: targetId, label: label, branchId: branchId });\r\n    };\r\n    return BatchRunner;\r\n}());\r\nexport { BatchRunner };\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from './restclient';\r\nimport { avoidSimultanousCalls } from './utils';\r\nvar KedBearerProvider = /** @class */ (function () {\r\n    function KedBearerProvider(isomorphic, storage, tokenId, clientId, clientSecret, tokenUrl, tokenQuery) {\r\n        this.isomorphic = isomorphic;\r\n        this.storage = storage;\r\n        this.tokenId = tokenId;\r\n        this.clientId = clientId;\r\n        this.clientSecret = clientSecret;\r\n        this.tokenUrl = tokenUrl;\r\n        this.tokenQuery = tokenQuery;\r\n        this.tokenInfo = { token: null, expires: 0 };\r\n        this.client = new RestClient(isomorphic, \"\", {\r\n            username: this.clientId,\r\n            password: this.clientSecret\r\n        });\r\n        this.getBearer = avoidSimultanousCalls(this.getBearer.bind(this));\r\n        this.refreshBearer = avoidSimultanousCalls(this.refreshBearer.bind(this));\r\n    }\r\n    KedBearerProvider.prototype.getBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, token, expires, _b, e_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _a = this.tokenInfo, token = _a.token, expires = _a.expires;\r\n                        if (token && expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        _c.trys.push([1, 4, , 6]);\r\n                        _b = this;\r\n                        return [4 /*yield*/, this.storage.load(this.clientId + \"/\" + this.tokenId)];\r\n                    case 2:\r\n                        _b.tokenInfo = _c.sent();\r\n                        if (this.tokenInfo.token && this.tokenInfo.expires >= Date.now())\r\n                            return [2 /*return*/, this.tokenInfo];\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 3:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        e_1 = _c.sent();\r\n                        return [4 /*yield*/, this.refreshBearer()];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBearerProvider.prototype.refreshBearer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, retries, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        retries = 0;\r\n                        _c.label = 1;\r\n                    case 1:\r\n                        if (!(retries < 6)) return [3 /*break*/, 5];\r\n                        console.log(\"Retrieving token for \" + this.tokenId);\r\n                        return [4 /*yield*/, this.client.get(this.tokenUrl, this.tokenQuery, { cache: 'reload' })];\r\n                    case 2:\r\n                        res = _c.sent();\r\n                        if (res.status !== 200) {\r\n                            console.warn(\"Got \" + res.status + \" \" + res.statusText);\r\n                            return [3 /*break*/, 4];\r\n                        }\r\n                        _a = this;\r\n                        _b = {};\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 3:\r\n                        _a.tokenInfo = (_b.token = _c.sent(), _b.expires = Date.now() + 59 * 60 * 1000, _b);\r\n                        console.log(\"Got token for \" + this.tokenId + \": \" + JSON.stringify(this.tokenInfo));\r\n                        this.storage.save(this.clientId + \"/\" + this.tokenId, this.tokenInfo);\r\n                        return [2 /*return*/, this.tokenInfo];\r\n                    case 4:\r\n                        ++retries;\r\n                        return [3 /*break*/, 1];\r\n                    case 5: throw new Error(\"Failed to retrieve token for \" + JSON.stringify(this.tokenId));\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBearerProvider;\r\n}());\r\nexport { KedBearerProvider };\r\n//# sourceMappingURL=ked-bearer-provider.js.map","/*\r\ndeclare var Buffer; // node built-in\r\n\r\n\r\nfunction basicAuthHeader(username, password) {\r\n    return \"Basic \" + new Buffer(username + \":\" + password).toString(\"base64\");\r\n}\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport { createUUID } from \"./utils\";\r\nimport { Emitter } from '../observable/emitter';\r\nvar RestClient = /** @class */ (function () {\r\n    function RestClient(isomorphic, baseUrl, options) {\r\n        this.isomorphic = isomorphic;\r\n        this.baseUrl = baseUrl;\r\n        this.options = options;\r\n        this.numOutstandingOperations = 0;\r\n        this.cache = {}; //, timeout: number}};\r\n        this._status = new Emitter(this);\r\n        this.fetchOptions = { mode: 'cors' };\r\n        this.authHeader = options.bearer ?\r\n            \"Bearer \" + options.bearer :\r\n            options.username ?\r\n                \"Basic \" + isomorphic.btoa(options.username + \":\" + (options.password || \"\")) :\r\n                null;\r\n        this.bearerProvider = options.bearerProvider || null;\r\n    }\r\n    Object.defineProperty(RestClient.prototype, \"status\", {\r\n        get: function () {\r\n            return this._status;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    RestClient.prototype.suspenseFetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        var key = method + \" \" + path + \" \" + JSON.stringify(headers) + \" \" + JSON.stringify(query) + \" \" + JSON.stringify(fetchOptions);\r\n        var entry = this.cache[key];\r\n        if (entry) {\r\n            // Entry found. Is it still being fetched?\r\n            if ('promise' in entry)\r\n                throw entry.promise; // Still being fetched. Multiple parallell fetches should work on same promise!\r\n            // Promise has resolved. Return result.\r\n            return entry.result;\r\n        }\r\n        else {\r\n            // We are the first to do this request. Start doing it:\r\n            var promise = this.fetch(path, method, headers, query, fetchOptions).then(function (res) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var status, text;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            status = res.status;\r\n                            return [4 /*yield*/, res.text()];\r\n                        case 1:\r\n                            text = _a.sent();\r\n                            this.cache[key] = {\r\n                                result: {\r\n                                    status: status,\r\n                                    text: function () { return text; },\r\n                                    json: function () { return JSON.parse(text); }\r\n                                }\r\n                            };\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); });\r\n            // Immediately put the promise in the cache. Multiple parallell fetches should work on the same promise!\r\n            this.cache[key] = { promise: promise };\r\n            // Suspend until promise is resolved. At that time, the cache will contain an answer!\r\n            throw promise;\r\n        }\r\n    };\r\n    RestClient.prototype.fetch = function (path, method, headers, query, fetchOptions) {\r\n        var _this = this;\r\n        ++this.numOutstandingOperations;\r\n        this._status.dispatch(this);\r\n        return this._fetch(path, method, headers, query, fetchOptions)\r\n            .then(function (res) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return res;\r\n        }).catch(function (err) {\r\n            --_this.numOutstandingOperations;\r\n            _this._status.dispatch(_this);\r\n            return Promise.reject(err);\r\n        });\r\n    };\r\n    RestClient.prototype._fetch = function (path, method, headers, query, fetchOptions) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var queryStr, _a, authHeader, tokenInfo, bearerProvider, _b, _c, url, res, wwwauth, _d;\r\n            return tslib_1.__generator(this, function (_e) {\r\n                switch (_e.label) {\r\n                    case 0:\r\n                        if (fetchOptions && fetchOptions.cache === 'no-cache') {\r\n                            // Workaround for back-button not respecting cache control in Chrome/Opera.\r\n                            // Append a query parameter to force a cache entry\r\n                            query = tslib_1.__assign({}, query, { nocache: createUUID() });\r\n                        }\r\n                        queryStr = query && Object.keys(query).filter(function (key) { return query[key] !== undefined; }).map(function (key) {\r\n                            return encodeURIComponent(key) +\r\n                                \"=\" +\r\n                                encodeURIComponent(query[key]);\r\n                        })\r\n                            .join('&');\r\n                        _a = this, authHeader = _a.authHeader, tokenInfo = _a.tokenInfo, bearerProvider = _a.bearerProvider;\r\n                        if (!(!authHeader && !tokenInfo && bearerProvider)) return [3 /*break*/, 2];\r\n                        _b = this;\r\n                        return [4 /*yield*/, bearerProvider.getBearer()];\r\n                    case 1:\r\n                        _b.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 2;\r\n                    case 2:\r\n                        if (!tokenInfo) return [3 /*break*/, 5];\r\n                        if (!(tokenInfo.expires < Date.now())) return [3 /*break*/, 4];\r\n                        console.log(\"Token expired. Refresh it:\");\r\n                        _c = this;\r\n                        return [4 /*yield*/, bearerProvider.refreshBearer()];\r\n                    case 3:\r\n                        _c.tokenInfo = tokenInfo = _e.sent();\r\n                        _e.label = 4;\r\n                    case 4:\r\n                        authHeader = \"Bearer \" + tokenInfo.token;\r\n                        _e.label = 5;\r\n                    case 5:\r\n                        // In one way or another, we've concluded an Authorization header to use:\r\n                        if (authHeader) {\r\n                            headers.Authorization = authHeader;\r\n                        }\r\n                        url = this.baseUrl + path + (queryStr ? \"?\" + queryStr : \"\");\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 6:\r\n                        res = _e.sent();\r\n                        if (!(res.status == 401 && this.bearerProvider)) return [3 /*break*/, 9];\r\n                        wwwauth = res.headers.get(\"www-authenticate\");\r\n                        console.log(\"Got \" + res.status + \" from \" + (this.baseUrl + path));\r\n                        if (!(wwwauth && /Bearer/i.test(wwwauth))) return [3 /*break*/, 9];\r\n                        _d = this;\r\n                        return [4 /*yield*/, this.bearerProvider.refreshBearer()];\r\n                    case 7:\r\n                        _d.tokenInfo = _e.sent();\r\n                        headers.Authorization = \"Bearer \" + this.tokenInfo.token;\r\n                        return [4 /*yield*/, this.isomorphic.fetch(url, tslib_1.__assign({}, this.fetchOptions, { headers: headers, method: method }, fetchOptions))];\r\n                    case 8:\r\n                        res = _e.sent();\r\n                        _e.label = 9;\r\n                    case 9: return [2 /*return*/, res];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    RestClient.prototype.get = function (path, query, fetchOptions) {\r\n        return this.fetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.suspenseGet = function (path, query, fetchOptions) {\r\n        return this.suspenseFetch(path, \"GET\", { Accept: \"application/json; text/plain\" }, query, fetchOptions);\r\n    };\r\n    RestClient.prototype.post = function (path, data, fetchOptions) {\r\n        return this.fetch(path, \"POST\", {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Accept\": \"application/json\"\r\n        }, null, tslib_1.__assign({}, fetchOptions, { body: JSON.stringify(data) }));\r\n    };\r\n    RestClient.prototype.delete = function (path, query, body, fetchOptions) {\r\n        return this.fetch(path, \"DELETE\", { Accept: \"application/json; text/plain\" }, query, tslib_1.__assign({}, fetchOptions, { body: body }));\r\n    };\r\n    return RestClient;\r\n}());\r\nexport { RestClient };\r\n//# sourceMappingURL=restclient.js.map","import * as tslib_1 from \"tslib\";\r\nexport function createUUID() {\r\n    // Decent solution from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript\r\n    var d = Date.now();\r\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n        var r = (d + Math.random() * 16) % 16 | 0;\r\n        d = Math.floor(d / 16);\r\n        return (c === 'x' ? r : (r & 0x7 | 0x8)).toString(16);\r\n    });\r\n    return uuid;\r\n}\r\nexport function avoidSimultanousCalls(method) {\r\n    var ongoingPromise = null;\r\n    return function () {\r\n        if (!ongoingPromise) {\r\n            ongoingPromise = method.apply(this, arguments).then(function (result) {\r\n                ongoingPromise = null;\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromise;\r\n    };\r\n}\r\nexport function getGlobalId(realm) {\r\n    var prefix = 'ec96b3be-45fc-41d3-b69e-';\r\n    var pad = ['50', '08', 'e1', '40', 'e4', 'e7'];\r\n    if (realm.length > 6)\r\n        throw new Error(\"Too long realm\");\r\n    for (var i = 0; i < realm.length; ++i) {\r\n        var hex = realm.charCodeAt(i).toString(16);\r\n        pad[i] = hex.length === 2 ?\r\n            hex :\r\n            '0' + hex;\r\n    }\r\n    return prefix + pad.join('');\r\n}\r\nexport function computePredestinatedId(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, data, digest, _a, i;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    data = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', data)];\r\n                case 1:\r\n                    digest = new (_a.apply(Uint8Array, [void 0, _b.sent()]))();\r\n                    i = 0;\r\n                    return [2 /*return*/, 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n                            var nibble = digest[i++] % 16 | 0;\r\n                            var washedNibble = c === 'x' ?\r\n                                nibble :\r\n                                nibble & 0x7 | 0x8;\r\n                            return washedNibble.toString(16);\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function simpleDigest(input) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var encoder, inputBytes, digestBytes, _a;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    encoder = new TextEncoder();\r\n                    inputBytes = encoder.encode(input);\r\n                    _a = Uint8Array.bind;\r\n                    return [4 /*yield*/, crypto.subtle.digest('SHA-256', inputBytes)];\r\n                case 1:\r\n                    digestBytes = new (_a.apply(Uint8Array, [void 0, _b.sent(), 0, 16]))();\r\n                    return [2 /*return*/, buf2hex(digestBytes)];\r\n            }\r\n        });\r\n    });\r\n}\r\nvar simpleDigestCache = {};\r\nexport function simpleDigestSuspense(inputs) {\r\n    var results = inputs.map(function (input) { return simpleDigestCache[input]; });\r\n    var unresolvedInputs = [];\r\n    results.forEach(function (result, index) {\r\n        if (!result)\r\n            unresolvedInputs.push(inputs[index]);\r\n    });\r\n    if (unresolvedInputs.length === 0)\r\n        return results;\r\n    throw Promise.all(unresolvedInputs.map(function (input) { return simpleDigest(input).then(function (result) { return simpleDigestCache[input] = result; }); }));\r\n}\r\nexport function buf2hex(buffer) {\r\n    return Array.prototype.map.call(buffer, function (x) { return ('00' + x.toString(16)).slice(-2); }).join('');\r\n}\r\nexport function updateArray(a, mapper) {\r\n    var retval = a;\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var t = a[i];\r\n        var mapped = mapper(t);\r\n        if (mapped !== t) {\r\n            if (retval === a)\r\n                retval = a.slice();\r\n            retval[i] = mapped;\r\n        }\r\n    }\r\n    return retval;\r\n}\r\n/*\r\nexport function updateArray<T>(a: T[], mapper: (t: T) => T | false): T[] {\r\n  let retval = a;\r\n  let j = 0;\r\n  for (let i=0,l=a.length; i<l; ++i, ++j) {\r\n    const t = a[i];\r\n    const mapped = mapper(t);\r\n    if (mapped === false) {\r\n      // Mapper wants to delete this doc.\r\n      if (retval === a) retval = a.slice();\r\n      retval.splice(j, 1);\r\n      --j; // compensate for ++j\r\n    } else if (mapped !== t) {\r\n      if (retval === a) retval = a.slice();\r\n      retval[j] = mapped;\r\n    }\r\n  }\r\n  return retval;\r\n}\r\n*/ \r\n//# sourceMappingURL=utils.js.map","import * as JsonSchema from \"kedbackend-schema/schema.json\";\r\nimport { getTableFromLabel } from \"./utils\";\r\nvar CacheBust = /** @class */ (function () {\r\n    function CacheBust() {\r\n    }\r\n    CacheBust.getCacheBust = function (table, query, user, includes) {\r\n        var involvedItems = CacheBust.getInvolvedItems(table, query, includes);\r\n        return involvedItems\r\n            .map(function (item) { return localStorage.getItem(\"cache-bust-\" + user + \"-\" + item); })\r\n            .filter(function (value) { return !!value; })\r\n            .join('/') || 'static';\r\n    };\r\n    CacheBust.invalidateCache = function (reqs, user) {\r\n        for (var _i = 0, _a = CacheBust.getCacheInvalidations(reqs); _i < _a.length; _i++) {\r\n            var item = _a[_i];\r\n            localStorage.setItem(\"cache-bust-\" + user + \"-\" + item, '' + Date.now());\r\n        }\r\n    };\r\n    CacheBust.getInvolvedItems = function (table, query, includes) {\r\n        var hasEdgesFrom = query.hasEdgesFrom;\r\n        var relatedTables = includes\r\n            .map(function (label) { return JsonSchema.tables[table].relationships[label]; })\r\n            .filter(function (table) { return !!table; });\r\n        if (hasEdgesFrom)\r\n            relatedTables.push(\"hef\" + table);\r\n        return [table, 'master', query.branchId].filter(function (x) { return !!x; }).concat(relatedTables).sort();\r\n    };\r\n    CacheBust.getCacheInvalidations = function (reqs) {\r\n        var invalidationSet = {};\r\n        reqs.forEach(function (req) {\r\n            switch (req.op) {\r\n                case 'add':\r\n                case 'put':\r\n                case 'delete':\r\n                case 'update':\r\n                    invalidationSet[req.table] = true;\r\n                    break;\r\n                case 'link':\r\n                case 'unlink':\r\n                case 'undo-link':\r\n                    invalidationSet[req.sourceTable] = true;\r\n                    invalidationSet[\"hef-\" + getTableFromLabel(req.sourceTable, req.label)] = true;\r\n                    break;\r\n                case 'clear-branch':\r\n                    invalidationSet[req.branchId] = true;\r\n                    break;\r\n                case 'merge':\r\n                    invalidationSet[req.branchId] = true;\r\n                    invalidationSet[req.targetBranchId || \"master\"] = true;\r\n                    break;\r\n            }\r\n        });\r\n        return Object.keys(invalidationSet);\r\n    };\r\n    return CacheBust;\r\n}());\r\nexport { CacheBust };\r\n//# sourceMappingURL=cache-bust.js.map","import * as tslib_1 from \"tslib\";\r\nimport { mergeDeltas } from '../delta-merge';\r\nexport function applyMutationsOnDeltas(branchId, deltas, mutations, optimistic, userDisplayName, hasAdditionalFilter) {\r\n    var _loop_1 = function (m) {\r\n        switch (m.op) {\r\n            case 'add-related':\r\n                //\r\n                // AddRelated RepoMutation\r\n                //\r\n                if (!hasAdditionalFilter && m.branchId === branchId) {\r\n                    deltas = [{\r\n                            type: 'add',\r\n                            sourceId: m.id,\r\n                            targetId: m.relatedDoc.id,\r\n                            label: m.graphProp,\r\n                            sourceTable: m.table,\r\n                            $meta: optimistic ? 'adding' : 'persisted',\r\n                            dateTime: Date.now(),\r\n                            targetName: m.relatedDoc.name,\r\n                            contributor: userDisplayName\r\n                        }].concat(deltas);\r\n                }\r\n                break;\r\n            case 'clear-branch':\r\n                //\r\n                // ClearBranch RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                break;\r\n            case 'delete':\r\n                //\r\n                // Delete RepoMutation\r\n                //\r\n                // This type of mutation can not be performed onto branches. There's no branchId property on m.\r\n                break;\r\n            case 'merge':\r\n                //\r\n                // Merge RepoMutation\r\n                //\r\n                if (m.branchId === branchId) {\r\n                    deltas = [];\r\n                }\r\n                else if (m.targetBranchId === branchId) {\r\n                    // This change will append new deltas to our deltas array but we don't know what would come.\r\n                    // Need to refetch from server.\r\n                    if (!optimistic)\r\n                        return { value: null }; // Caller should check for null and re-fetch data from server.\r\n                }\r\n                break;\r\n            case 'remove-related':\r\n                //\r\n                // Remove-Related RepoMutation\r\n                //\r\n                if (hasAdditionalFilter || m.branchId !== branchId)\r\n                    return \"continue\";\r\n                deltas = [{\r\n                        type: 'remove',\r\n                        sourceId: m.id,\r\n                        targetId: m.relatedDoc.id,\r\n                        targetName: m.relatedDoc.name,\r\n                        label: m.graphProp,\r\n                        sourceTable: m.table,\r\n                        contributor: userDisplayName,\r\n                        dateTime: Date.now(),\r\n                        $meta: optimistic ? 'adding' : 'persisted'\r\n                    }].concat(deltas);\r\n                break;\r\n            case 'undo-link':\r\n                //\r\n                // Undo-Link RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (d) {\r\n                        return (d.type === 'add' || d.type === 'remove' || d.type === 'undo-link') &&\r\n                            d.sourceId === m.id &&\r\n                            d.targetId === m.relatedId;\r\n                    });\r\n                    if (idx < 0)\r\n                        return \"continue\";\r\n                    // Found an \"add\" or \"remove\" delta to change:\r\n                    if (optimistic) {\r\n                        var deltaRelation = deltas[idx];\r\n                        // Mark the existing add/remove delta as currenlty being deleted\r\n                        deltas = deltas.slice(0, idx).concat([\r\n                            tslib_1.__assign({}, deltaRelation, { $meta: optimistic ? 'removing' : 'persisted' })\r\n                        ], deltas.slice(idx + 1));\r\n                    }\r\n                    else {\r\n                        // Persisted. Just remove it:\r\n                        deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                    }\r\n                }\r\n                break;\r\n            case 'update':\r\n                //\r\n                // Update RepoMutation\r\n                //\r\n                if (m.branchId !== branchId)\r\n                    return \"continue\";\r\n                {\r\n                    var idx = deltas.findIndex(function (delta) {\r\n                        return delta.type === 'modify' &&\r\n                            delta.targetId === m.id;\r\n                    });\r\n                    if (idx < 0 && !hasAdditionalFilter) {\r\n                        deltas = [{\r\n                                type: 'modify',\r\n                                table: m.table,\r\n                                targetId: m.id,\r\n                                targetName: m.targetName,\r\n                                data: m.deltaDoc,\r\n                                dateTime: Date.now(),\r\n                                contributors: [userDisplayName],\r\n                                $meta: optimistic ? 'adding' : 'persisted',\r\n                            }].concat(deltas);\r\n                    }\r\n                    else {\r\n                        var existingDeltaDoc = deltas[idx];\r\n                        var contributors = existingDeltaDoc.contributors.slice();\r\n                        if (!contributors.includes(userDisplayName)) {\r\n                            contributors.push(userDisplayName);\r\n                        }\r\n                        var newData = mergeDeltas(existingDeltaDoc.data, m.deltaDoc, { removeUnsetProps: true });\r\n                        if (!optimistic && Object.keys(newData).length === 0) {\r\n                            // Committed mutation that resets a deltaDoc. Remove the deltaDoc entirely:\r\n                            deltas = deltas.slice(0, idx).concat(deltas.slice(idx + 1));\r\n                        }\r\n                        else {\r\n                            // \r\n                            deltas = [\r\n                                {\r\n                                    type: 'modify',\r\n                                    table: m.table,\r\n                                    targetId: m.id,\r\n                                    targetName: m.targetName,\r\n                                    data: newData,\r\n                                    dateTime: Date.now(),\r\n                                    contributors: contributors,\r\n                                    $meta: optimistic ? 'updating' : 'persisted',\r\n                                }\r\n                            ].concat(deltas.slice(0, idx), deltas.slice(idx + 1));\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n        }\r\n    };\r\n    for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\r\n        var m = mutations_1[_i];\r\n        var state_1 = _loop_1(m);\r\n        if (typeof state_1 === \"object\")\r\n            return state_1.value;\r\n    }\r\n    return deltas;\r\n}\r\n//# sourceMappingURL=apply-mutations-on-deltas.js.map","import * as tslib_1 from \"tslib\";\r\nimport { HttpError } from '../../ked-backend-client';\r\nimport { applyMutationsOnDeltas } from './apply-mutations-on-deltas';\r\nvar DeltaCache = /** @class */ (function () {\r\n    function DeltaCache(getClient, getUser, getUserDisplayName) {\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.lookup = {};\r\n    }\r\n    DeltaCache.prototype.applyMutations = function (mutations, _a) {\r\n        var optimistic = (_a === void 0 ? { optimistic: false } : _a).optimistic;\r\n        // Apply mutations locally onto the DeltaCache and notify their subscribers\r\n        for (var _i = 0, _b = Object.keys(this.lookup); _i < _b.length; _i++) {\r\n            var queryKey = _b[_i];\r\n            var cacheEntry = this.lookup[queryKey];\r\n            if (cacheEntry.value) {\r\n                // Instead here: Store the mutations on cacheEntry. No matter if it yet has value or not.\r\n                // Then apply mutation whenever subscribing! (Better handling of mutations that arrives before fetch() is done)\r\n                // (See how I handle this in query-set.ts)\r\n                var newValue = applyMutationsOnDeltas(cacheEntry.query.branchId, cacheEntry.value, mutations, optimistic, this.getUserDisplayName(), !!cacheEntry.query.tags);\r\n                if (newValue === null) {\r\n                    // The mutation requires cacheEntry to be refetched from server\r\n                    if (!optimistic) {\r\n                        // Caller has successfully performed the mutations and got success back from server.\r\n                        // It's ok to refetch the deltas from server now:\r\n                        cacheEntry.fetch();\r\n                        // After fetch completes, it will notify the subscribers.\r\n                    }\r\n                }\r\n                if (newValue !== cacheEntry.value) {\r\n                    cacheEntry.optimisticValue = newValue;\r\n                    if (!optimistic)\r\n                        cacheEntry.value = newValue;\r\n                    cacheEntry.notify(newValue);\r\n                }\r\n            }\r\n        }\r\n    };\r\n    DeltaCache.prototype.subscribe = function (query, observer) {\r\n        var _this = this;\r\n        var cacheEntry = this.lookup[query.branchId + query.tags];\r\n        if (!cacheEntry) {\r\n            cacheEntry = new DeltaCacheEntry(this.getClient(), query);\r\n            this.lookup[query.branchId + query.tags] = cacheEntry;\r\n        }\r\n        if (cacheEntry.cleanupTimer) {\r\n            clearTimeout(cacheEntry.cleanupTimer);\r\n            cacheEntry.cleanupTimer = null;\r\n        }\r\n        var subscription = {\r\n            unsubscribe: function () {\r\n                cacheEntry.subscribers = cacheEntry.subscribers.filter(function (_a) {\r\n                    var o = _a.observer;\r\n                    return o !== observer;\r\n                });\r\n                if (cacheEntry.subscribers.length === 0) {\r\n                    cacheEntry.cleanupTimer = setTimeout(function () {\r\n                        if (cacheEntry.subscribers.length === 0) {\r\n                            delete _this.lookup[query.branchId + query.tags];\r\n                        }\r\n                    }, 100);\r\n                }\r\n            }\r\n        };\r\n        cacheEntry.subscribers.push({ observer: observer, subscription: subscription });\r\n        if (cacheEntry.value) {\r\n            // Value has been successfully retrieved already. Pick from cache.\r\n            observer(cacheEntry.optimisticValue || cacheEntry.value, null, subscription);\r\n        }\r\n        else if (cacheEntry.isFetching) {\r\n            // A value is on its way. Sit back and relax. All registered\r\n            // observers (including this one) will be notified when data arrives\r\n            // or fails.\r\n        }\r\n        else if (cacheEntry.error) {\r\n            observer(null, cacheEntry.error, subscription);\r\n        }\r\n        else {\r\n            cacheEntry.fetch();\r\n        }\r\n        return subscription;\r\n    };\r\n    return DeltaCache;\r\n}());\r\nexport { DeltaCache };\r\nvar DeltaCacheEntry = /** @class */ (function () {\r\n    function DeltaCacheEntry(client, query) {\r\n        this.fetchOperationId = 0; // Makes sure a re-fetch will discard the result from any ongoing fetch.\r\n        this.client = client;\r\n        this.query = query;\r\n        this.value = null;\r\n        this.error = null;\r\n        this.optimisticValue = null;\r\n        this.subscribers = [];\r\n        this.isFetching = false;\r\n        this.cleanupTimer = null;\r\n    }\r\n    DeltaCacheEntry.prototype.fetch = function () {\r\n        var _this = this;\r\n        var fetchOperationId = ++this.fetchOperationId;\r\n        this.isFetching = true;\r\n        this.fetchFromServer().then(function (value) {\r\n            // Success\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                value.sort(function (a, b) { return b.dateTime - a.dateTime; }); // Latest first\r\n                _this.value = value;\r\n                _this.optimisticValue = value;\r\n                _this.notify(value);\r\n            }\r\n        }).catch(function (error) {\r\n            // Fail\r\n            if (fetchOperationId === _this.fetchOperationId) {\r\n                _this.isFetching = false;\r\n                _this.error = error;\r\n                _this.fail(error);\r\n            }\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.fetchFromServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!this.query.branchId)\r\n                            throw new Error('Deltas only available on branches');\r\n                        return [4 /*yield*/, this.client.http.get('deltas', this.query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status >= 300 || res.status < 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4: return [2 /*return*/, _c.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    DeltaCacheEntry.prototype.notify = function (value) {\r\n        for (var _i = 0, _a = this.subscribers; _i < _a.length; _i++) {\r\n            var _b = _a[_i], observer = _b.observer, subscription = _b.subscription;\r\n            observer(value, null, subscription);\r\n        }\r\n    };\r\n    DeltaCacheEntry.prototype.fail = function (error) {\r\n        var copy = this.subscribers.slice();\r\n        this.subscribers = [];\r\n        for (var _i = 0, copy_1 = copy; _i < copy_1.length; _i++) {\r\n            var _a = copy_1[_i], observer = _a.observer, subscription = _a.subscription;\r\n            observer(null, error, subscription);\r\n        }\r\n    };\r\n    return DeltaCacheEntry;\r\n}());\r\n//# sourceMappingURL=delta-cache.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Collection } from '../../observable';\r\nvar DeltaCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(DeltaCollection, _super);\r\n    function DeltaCollection(deltaCache, query) {\r\n        var _this = _super.call(this, function (observer) { return _this.deltaCache.subscribe(query, observer); }) || this;\r\n        _this.deltaCache = deltaCache;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    DeltaCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return new DeltaCollection(this.deltaCache, tslib_1.__assign({}, this.query, { tags: tags }));\r\n    };\r\n    return DeltaCollection;\r\n}(Collection));\r\nexport { DeltaCollection };\r\n//# sourceMappingURL=delta-collection.js.map","import * as tslib_1 from \"tslib\";\r\nexport function applyDelta(doc, delta) {\r\n    var keys = Object.keys(delta);\r\n    var targetDoc = doc;\r\n    for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\r\n        var key = keys_1[_i];\r\n        if (targetDoc === doc)\r\n            targetDoc = tslib_1.__assign({}, doc);\r\n        var val = delta[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_1 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            // Do nothing on target doc!\r\n                            targetDoc.$wasUnset = true; // Just mark it for re-retrieval after successful posting changes.\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd = miValue;\r\n                            if (!Array.isArray(valuesToAdd)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            else {\r\n                                targetArray = targetArray.slice(); // On JS side, we must be immutable\r\n                            }\r\n                            targetDoc[key] = targetArray;\r\n                            for (var _i = 0, valuesToAdd_1 = valuesToAdd; _i < valuesToAdd_1.length; _i++) {\r\n                                var v = valuesToAdd_1[_i];\r\n                                if (!targetArray.includes(v)) { // avoid dups\r\n                                    targetArray.push(v);\r\n                                }\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_1 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_1)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetArray = targetDoc[key];\r\n                            if (!Array.isArray(targetArray)) {\r\n                                targetArray = [];\r\n                            }\r\n                            targetDoc[key] = targetArray.filter(function (t) { return !valuesToRemove_1.includes(t); });\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _a = 0, metaInstructions_1 = metaInstructions; _a < metaInstructions_1.length; _a++) {\r\n                    var mi = metaInstructions_1[_a];\r\n                    _loop_1(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDoc[key] = val;\r\n    }\r\n    return targetDoc;\r\n}\r\n// {name: \"Ulla\"}, {name: {$unset:0}\r\n// {tags: {$add: \"hej\"}}, {tags: {$unset:0}\"}\r\nexport function mergeDeltas(delta1, delta2, _a) {\r\n    var removeUnsetProps = (_a === void 0 ? { removeUnsetProps: false } : _a).removeUnsetProps;\r\n    //return {...delta1, ...delta2};\r\n    var keys = Object.keys(delta2);\r\n    var targetDelta = tslib_1.__assign({}, delta1);\r\n    for (var _i = 0, keys_2 = keys; _i < keys_2.length; _i++) {\r\n        var key = keys_2[_i];\r\n        var val = delta2[key];\r\n        if (val && typeof val === 'object') {\r\n            var metaInstructions = Object.keys(val)\r\n                .filter(function (key) { return key.startsWith('$'); });\r\n            if (metaInstructions.length > 0) {\r\n                var _loop_2 = function (mi) {\r\n                    var miValue = val[mi];\r\n                    switch (mi) {\r\n                        case \"$unset\": {\r\n                            if (removeUnsetProps) {\r\n                                delete targetDelta[key];\r\n                            }\r\n                            else {\r\n                                // No matter if targetDelta is empty or has value. Set it to {$unset:0}\r\n                                // to make sure the very end result will have {$unset:0}\r\n                                targetDelta[key] = { $unset: 0 };\r\n                            }\r\n                            break;\r\n                        }\r\n                        case \"$add\": {\r\n                            var valuesToAdd_2 = miValue;\r\n                            if (!Array.isArray(valuesToAdd_2)) {\r\n                                throw new Error(\"$add instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$remove: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$add: [...]} arrays.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetRemoveArray)) {\r\n                                targetMetaProp.$remove =\r\n                                    targetRemoveArray.filter(function (t) { return !valuesToAdd_2.includes(t); });\r\n                                if (targetMetaProp.$remove.length === 0) {\r\n                                    // If $remove array became emtpy. Remove the $remove prop.\r\n                                    delete targetMetaProp.$remove;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $add array.\r\n                            var targetAddArray = targetMetaProp.$add;\r\n                            targetAddArray = targetAddArray ? targetAddArray.concat(valuesToAdd_2) : valuesToAdd_2.slice();\r\n                            targetMetaProp.$add = targetAddArray;\r\n                            break;\r\n                        }\r\n                        case \"$remove\": {\r\n                            var valuesToRemove_2 = miValue;\r\n                            if (!Array.isArray(valuesToRemove_2)) {\r\n                                throw new Error(\"$remove instruction must contain array\");\r\n                            }\r\n                            var targetMetaProp = targetDelta[key];\r\n                            targetMetaProp = targetMetaProp ? tslib_1.__assign({}, targetMetaProp) : {};\r\n                            targetDelta[key] = targetMetaProp;\r\n                            // First, just check if target metaProp has {$add: [...items]}\r\n                            // If so, remove any equal items from there before merging the {$remove: [...]} arrays.\r\n                            var targetAddArray = targetMetaProp.$remove;\r\n                            if (Array.isArray(targetAddArray)) {\r\n                                targetMetaProp.$add =\r\n                                    targetAddArray.filter(function (t) { return !valuesToRemove_2.includes(t); });\r\n                                if (targetMetaProp.$add.length === 0) {\r\n                                    // If $add array became emtpy. Remove the $add prop.\r\n                                    delete targetMetaProp.$add;\r\n                                }\r\n                            }\r\n                            // Now it's time to merge or create target $remove array.\r\n                            var targetRemoveArray = targetMetaProp.$remove;\r\n                            targetRemoveArray = targetRemoveArray ? targetRemoveArray.concat(valuesToRemove_2) : valuesToRemove_2.slice();\r\n                            targetMetaProp.$remove = targetRemoveArray;\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                for (var _b = 0, metaInstructions_2 = metaInstructions; _b < metaInstructions_2.length; _b++) {\r\n                    var mi = metaInstructions_2[_b];\r\n                    _loop_2(mi);\r\n                }\r\n                continue;\r\n            }\r\n        }\r\n        targetDelta[key] = val;\r\n    }\r\n    return targetDelta;\r\n}\r\n//# sourceMappingURL=delta-merge.js.map","export * from './kedbackend-collection';\r\nexport * from './kedbackend-query';\r\nexport * from './kedbackend-repo';\r\nexport * from './kedbackend-subscription';\r\nexport * from './kedbackend-writer';\r\nexport * from './mutation-queue';\r\nexport * from './query-set';\r\nexport * from '../observable/mixin';\r\n//# sourceMappingURL=index.js.map","import * as tslib_1 from \"tslib\";\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { KedBackendSubscription } from \"./kedbackend-subscription\";\r\nimport { CacheBust } from './cache-bust';\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport { Collection } from '../observable/collection';\r\n/**\r\n * Represents a \"live\" query against a table or filtered table.\r\n */\r\nvar KedBackendCollection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KedBackendCollection, _super);\r\n    function KedBackendCollection(repo, table, query) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = new KedBackendSubscription(observer, _this);\r\n            _this.repo.querySet.subscribe(subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.repo = repo;\r\n        _this.table = table;\r\n        _this.query = query;\r\n        return _this;\r\n    }\r\n    Object.defineProperty(KedBackendCollection.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendCollection.prototype, \"includes\", {\r\n        get: function () {\r\n            return this._includes || (this._includes = [].concat(this.query.include || []));\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendCollection.prototype.applyQuery = function (query) {\r\n        return new KedBackendCollection(this.repo, this.table, tslib_1.__assign({}, this.query, query));\r\n    };\r\n    KedBackendCollection.prototype.addToQueryArrayProp = function (arrayProp, entries) {\r\n        var _a;\r\n        return this.applyQuery((_a = {}, _a[arrayProp] = (this.query[arrayProp] || []).concat(entries), _a));\r\n    };\r\n    KedBackendCollection.prototype.addFlags = function () {\r\n        var flags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            flags[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"flags\", flags);\r\n    };\r\n    KedBackendCollection.prototype.debug = function () {\r\n        return this.applyQuery({ debug: true });\r\n    };\r\n    KedBackendCollection.prototype.idsOnly = function () {\r\n        return this.addFlags(\"idsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.idsAndNamesOnly = function () {\r\n        return this.addFlags(\"idsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsOnly = function () {\r\n        return this.addFlags(\"includeIdsOnly\");\r\n    };\r\n    KedBackendCollection.prototype.includeIdsAndNamesOnly = function () {\r\n        return this.addFlags(\"includeIdsAndNamesOnly\");\r\n    };\r\n    KedBackendCollection.prototype.between = function (from, to) {\r\n        return this.applyQuery({ from: from, to: to });\r\n    };\r\n    KedBackendCollection.prototype.role = function (role) {\r\n        return this.applyQuery({ role: role });\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesFrom = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesFrom(\" + JSON.stringify(ids) + \")\");\r\n        var hef = this.addToQueryArrayProp(\"hasEdgesFrom\", ids);\r\n        return hef;\r\n    };\r\n    KedBackendCollection.prototype.hasEdgesTo = function (ids) {\r\n        if (ids.length === 0 || ids.some(function (id) { return !id; }))\r\n            throw new Error(\"Invalid id list given to Collection.hasEdgesTo(\" + JSON.stringify(ids) + \")\");\r\n        var het = this.addToQueryArrayProp(\"hasEdgesTo\", ids);\r\n        return het;\r\n    };\r\n    KedBackendCollection.prototype.id = function (id) {\r\n        var _this = this;\r\n        return this.applyQuery({ ids: [id] }).single({\r\n            onZero: function () { throw new Error(\"Could not find entity in \" + _this.table + \" with id \" + id); },\r\n            onMany: function () { throw new Error(\"Multiple entries in \" + _this.table + \" with id \" + id); },\r\n        });\r\n    };\r\n    KedBackendCollection.prototype.ids = function (ids) {\r\n        return this.applyQuery({ ids: ids });\r\n    };\r\n    KedBackendCollection.prototype.name = function (name) {\r\n        return this.applyQuery({ name: name });\r\n    };\r\n    KedBackendCollection.prototype.tags = function () {\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        return this.applyQuery({ tags: tags });\r\n    };\r\n    KedBackendCollection.prototype.branchId = function (branchId) {\r\n        return this.applyQuery({ branchId: branchId });\r\n    };\r\n    KedBackendCollection.prototype.include = function () {\r\n        var graphs = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            graphs[_i] = arguments[_i];\r\n        }\r\n        return this.addToQueryArrayProp(\"include\", graphs);\r\n    };\r\n    KedBackendCollection.prototype.cacheOptimized = function (onOrOff) {\r\n        return onOrOff === undefined || onOrOff === true ?\r\n            this.applyQuery({ cacheBust: CacheBust.getCacheBust(this.table, this.query, this.repo.getUser(), this.includes) }) :\r\n            this.applyQuery({ cacheBust: undefined });\r\n    };\r\n    KedBackendCollection.prototype.mutationsOnEmpty = function (mutationFactory) {\r\n        var tx = new BatchRunner();\r\n        mutationFactory(tx);\r\n        return this.applyQuery({ mutationsOnEmpty: tx.mutationRequests });\r\n    };\r\n    KedBackendCollection.prototype.single = function (throwers) {\r\n        var _this = this;\r\n        var _a = throwers || {}, onZero = _a.onZero, onMany = _a.onMany;\r\n        return this.toValue().map(function (items) {\r\n            if (items.length === 0) {\r\n                if (onZero)\r\n                    onZero();\r\n                else\r\n                    throw new Error(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but none was found.\");\r\n            }\r\n            if (items.length > 1) {\r\n                debugger;\r\n                if (onMany)\r\n                    onMany();\r\n                else\r\n                    console.log(\"Single item of \" + _this.table + \" expected to be returned by query \" + JSON.stringify(_this.query) + \" but \" + items.length + \" was found.\");\r\n            }\r\n            return items[0];\r\n        });\r\n    };\r\n    /*combineLatest<TOther>(other: QueryObservable<TOther>) {\r\n      return this.render(x => x).combineLatest(other);\r\n    }*/\r\n    KedBackendCollection.prototype.update = function (doc, changes, debounce) {\r\n        if (debounce === void 0) { debounce = 1000; }\r\n        this.repo.writer.mutate([{\r\n                op: 'update',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: doc.id,\r\n                deltaDoc: changes,\r\n                targetName: doc.name\r\n            }], debounce);\r\n    };\r\n    KedBackendCollection.prototype.addRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.add = function (doc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'add',\r\n                id: doc.id,\r\n                table: this.table,\r\n                doc: doc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.removeRelated = function (id, label, relatedDoc) {\r\n        this.repo.writer.mutate([{\r\n                op: 'remove-related',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedDoc: relatedDoc\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.undoLink = function (id, label, relatedId) {\r\n        if (!this.query.branchId)\r\n            throw new Error(\"undo links can only be performed on branches\");\r\n        this.repo.writer.mutate([{\r\n                op: 'undo-link',\r\n                table: this.table,\r\n                branchId: this.query.branchId,\r\n                id: id,\r\n                graphProp: label,\r\n                relatedId: relatedId\r\n            }], 0);\r\n    };\r\n    KedBackendCollection.prototype.delete = function () {\r\n        var _this = this;\r\n        var ids = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            ids[_i] = arguments[_i];\r\n        }\r\n        this.repo.writer.mutate(ids.map(function (id) { return ({\r\n            op: 'delete',\r\n            table: _this.table,\r\n            id: id\r\n        }); }), 0);\r\n    };\r\n    KedBackendCollection.prototype.unsubscribe = function (subscription) {\r\n        this.repo.querySet.unsubscribe(subscription);\r\n    };\r\n    return KedBackendCollection;\r\n}(Collection));\r\nexport { KedBackendCollection };\r\n/*mixin(\r\n  KedBackendCollection.prototype,\r\n  MappedCollection.prototype,\r\n  \"map\", \"flat\", \"concat\", \"render\", \"load\");*/\r\n//# sourceMappingURL=kedbackend-collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { updateArray } from '../ked-backend-client/utils';\r\nimport { branchSensitive, getTableFromLabel } from './utils';\r\nimport { applyDelta } from './delta-merge';\r\nvar KedBackendQuery = /** @class */ (function () {\r\n    function KedBackendQuery(table, query, user, repo, mutationQueue) {\r\n        this.table = table;\r\n        this.query = query;\r\n        this.user = user;\r\n        this.repo = repo;\r\n        this.mutationQueue = mutationQueue;\r\n        this.subscriptions = [];\r\n        this.data = [];\r\n        this.gotInitialResponse = false;\r\n        this.invalid = false;\r\n        this.loadedVersion = 0;\r\n        this._loadPromise = null;\r\n        this.includes = query.include ?\r\n            typeof query.include === 'string' ?\r\n                [query.include] :\r\n                query.include :\r\n            [];\r\n    }\r\n    KedBackendQuery.queryKey = function (table, query) {\r\n        var mutationsOnEmpty = query.mutationsOnEmpty, comparableProps = tslib_1.__rest(query, [\"mutationsOnEmpty\"]);\r\n        return table + JSON.stringify(comparableProps);\r\n    };\r\n    Object.defineProperty(KedBackendQuery.prototype, \"queryKey\", {\r\n        get: function () {\r\n            return KedBackendQuery.queryKey(this.table, this.query);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendQuery.prototype.subscribe = function (subscription) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.subscriptions.push(subscription);\r\n                        if (!(this.gotInitialResponse && !this.invalid)) return [3 /*break*/, 1];\r\n                        data = this.getDataWithMutationsApplied(this.mutationQueue.get(), true, this.data);\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 1:\r\n                        data = this.queryLocally();\r\n                        if (!data) return [3 /*break*/, 2];\r\n                        this.data = data;\r\n                        this.error = null;\r\n                        subscription.notifySubscriber(data, this.error);\r\n                        return [3 /*break*/, 4];\r\n                    case 2: return [4 /*yield*/, this.load()];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var loadPromise;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (this.gotInitialResponse) {\r\n                            // mutationsOnEmpty should never be used twice.\r\n                            delete this.query.mutationsOnEmpty;\r\n                        }\r\n                        if (!(!version && this._loadPromise)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this._loadPromise];\r\n                    case 1: \r\n                    // loading is ongoing, and caller does not require a recent refresh.\r\n                    // wait for the ongoing load to complete\r\n                    return [2 /*return*/, _a.sent()];\r\n                    case 2:\r\n                        version = version || this.repo.writer.persistedVersion.value;\r\n                        loadPromise = this._loadPromise = this._load(version).then(function (data) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                _this.data = data;\r\n                                _this.loadedVersion = Math.max(_this.loadedVersion, version);\r\n                            }\r\n                        }).catch(function (error) {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. The error is the final result. Set it.\r\n                                _this.error = error;\r\n                            }\r\n                        }).then(function () {\r\n                            if (_this._loadPromise === loadPromise) {\r\n                                // Noone has refreshed our load. We're finished. Data or error is already set.\r\n                                // Mark gotInitialResponse to true and notify subscribers.\r\n                                _this._loadPromise = null;\r\n                                _this.gotInitialResponse = true;\r\n                                _this.notifySubscribers(_this.mutationQueue.get());\r\n                            }\r\n                            else {\r\n                                // A more recent call to load() is ongoing, OR was ongoing but responded\r\n                                // before us.\r\n                                // In any case return this._loadPromise. If it's ongoing we'll wait for it\r\n                                // to finish. If it's null, we'll be returning finally here without\r\n                                // any action, because the action was taken by the refresher.\r\n                                return _this._loadPromise; // Wait for the refreshed load to complete\r\n                            }\r\n                        });\r\n                        return [4 /*yield*/, loadPromise];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype._load = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.mutationQueue.affectsQuery(this.table, this.query, this.includes)) return [3 /*break*/, 2];\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        return [4 /*yield*/, this.repo.writer.waitForVersionToPersist(version)];\r\n                    case 1:\r\n                        // There are outgoing mutations that affects this query.\r\n                        // Need to wait till they reach server and server responds with OK before querying\r\n                        // the server. Otherwise, we may get inaccurate data from server.\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [4 /*yield*/, this.queryServer()];\r\n                    case 3: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.unsubscribe = function (subscription) {\r\n        this.subscriptions = this.subscriptions.filter(function (s) { return s !== subscription; });\r\n    };\r\n    KedBackendQuery.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _i, mutations_1, m, data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.data) return [3 /*break*/, 9];\r\n                        _i = 0, mutations_1 = mutations;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < mutations_1.length)) return [3 /*break*/, 8];\r\n                        m = mutations_1[_i];\r\n                        if (!(m.op === 'clear-branch' && (m.branchId === this.query.branchId))) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 3:\r\n                        if (!(m.op === 'merge' && (!m.targetBranchId ||\r\n                            m.branchId === this.query.branchId ||\r\n                            m.targetBranchId === this.query.branchId))) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 5:\r\n                        if (!(m.op === 'update' && ((m.deltaDoc.tags && this.query.tags) ||\r\n                            (m.deltaDoc.name && this.query.name)))) return [3 /*break*/, 7];\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        return [4 /*yield*/, this.refreshOrInvalidate(version)];\r\n                    case 6:\r\n                        // A tag may have been added, or renamed, and\r\n                        // the query is dependent on the same property.\r\n                        // The query must be refreshed from server as we cannot\r\n                        // commit the mutations locally as we don't have all info.\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                    case 7:\r\n                        _i++;\r\n                        return [3 /*break*/, 1];\r\n                    case 8:\r\n                        data = this.getDataWithMutationsApplied(mutations, false, this.data);\r\n                        this.data = data;\r\n                        _a.label = 9;\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.refreshOrInvalidate = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(this.subscriptions.length === 0)) return [3 /*break*/, 1];\r\n                        this.invalid = true;\r\n                        return [3 /*break*/, 3];\r\n                    case 1: return [4 /*yield*/, this.load(version)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.notifySubscribers = function (optimisticMutations) {\r\n        var _this = this;\r\n        if (this.data && this.gotInitialResponse) {\r\n            var data_1 = this.getDataWithMutationsApplied(optimisticMutations, true, this.data);\r\n            this.subscriptions.forEach(function (s) {\r\n                s.notifySubscriber(data_1, _this.error);\r\n            });\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.queryLocally = function () {\r\n        return this.repo.querySet.queryLocally(this.table, this.query, this.includes);\r\n    };\r\n    KedBackendQuery.prototype.queryServer = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.repo.getClient().list(this.table, tslib_1.__assign({}, this.query))];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        return [2 /*return*/, data];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendQuery.prototype.getDataWithMutationsApplied = function (mutations, optimistic, data) {\r\n        var _this = this;\r\n        mutations.forEach(function (mutation) {\r\n            data = _this.applyMutationsOnData(data, mutation, optimistic);\r\n        });\r\n        return data;\r\n    };\r\n    KedBackendQuery.prototype.applyMutationsOnData = function (data, m, optimistic) {\r\n        if (branchSensitive(m) && m.branchId != this.query.branchId)\r\n            return data;\r\n        var _a = this, table = _a.table, includes = _a.includes, listOptions = _a.query;\r\n        var sourceIds = listOptions.hasEdgesFrom ? [].concat(listOptions.hasEdgesFrom || []) : [];\r\n        var requestedTags = listOptions.tags ? [].concat(listOptions.tags || []) : [];\r\n        switch (m.op) {\r\n            case 'update': {\r\n                return updateArray(data, function (doc) {\r\n                    if (doc.id === m.id) {\r\n                        // Apply delta on updated document\r\n                        var updatedDoc = applyDelta(doc, m.deltaDoc);\r\n                        if (optimistic)\r\n                            updatedDoc.$meta = 'updating';\r\n                        return updatedDoc;\r\n                    }\r\n                    // If id does not apply to this doc, search in graphs the id is found\r\n                    // among graph included docs, and if so, update that one:\r\n                    includes.forEach(function (label) {\r\n                        var _a;\r\n                        var includedDocs = doc[label];\r\n                        if (includedDocs) {\r\n                            var updatedArray = updateArray(includedDocs, function (related) {\r\n                                if (related.id !== m.id)\r\n                                    return related;\r\n                                var updatedRelated = applyDelta(related, m.deltaDoc);\r\n                                if (optimistic)\r\n                                    updatedRelated.$meta = 'updating';\r\n                                return updatedRelated;\r\n                            });\r\n                            if (updatedArray !== includedDocs) {\r\n                                doc = tslib_1.__assign({}, doc, (_a = {}, _a[label] = updatedArray, _a));\r\n                            }\r\n                        }\r\n                    });\r\n                    return doc;\r\n                });\r\n            }\r\n            case 'add':\r\n                if (table === m.table) {\r\n                    if (listOptions.tags) {\r\n                        var queriedTags_1 = [].concat(listOptions.tags); // tag can be either string or string[]. Make is string[] always.\r\n                        if (m.doc.tags && m.doc.tags.some(function (tag) { return queriedTags_1.includes(tag); })) {\r\n                            return data.concat([m.doc]); // Make the added doc appear in the result (optimistic mutation)\r\n                        }\r\n                    }\r\n                    // Todo, apply also for other list options, like ids:\r\n                    // The above code for 'add' was only written to cover the use case of teachers-page notifications!\r\n                }\r\n                return data; // fallback case - query was not affected.\r\n            case 'add-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    // If expression is `db.courseBlocks....whatever.. .include(\"abilities\")`, detect: db.courseBlocks.addRelated(blockId, 'abilities', ...)\r\n                    // ...because table = 'courseBlocks' and includes has \"abilities\".\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        var relatedDoc = tslib_1.__assign({}, m.relatedDoc);\r\n                        if (optimistic)\r\n                            relatedDoc.$meta = 'adding';\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = doc[m.graphProp].concat([relatedDoc]), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id)) {\r\n                        // If expression is:\r\n                        //   `db.courseBlocks.hasEdgesFrom([courseId])`  (meaning table='courseBlocks' and sourceIds includes courseId)\r\n                        // , detect: db.courseInstances.addRelated(courseId, 'courseBlocks', ....) // m.graphProp === 'blocks'--> getTableFromLabel --> 'courseBlocks'\r\n                        if (table === getTableFromLabel(m.table, m.graphProp)) {\r\n                            if (!listOptions.tags)\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            if (m.relatedDoc.tags && requestedTags.some(function (tag) { return m.relatedDoc.tags.includes(tag); })) {\r\n                                return data.concat(this.setGraphProps(m.relatedDoc));\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (listOptions.ids && listOptions.ids.some(function (id) { return id === m.relatedDoc.id; })) {\r\n                    // A certain ID is observed. A doc with this id is being added.\r\n                    // Add the doc to the result. Exactly this WILL happen in the following typical scenario:\r\n                    // 1. User adds a related document to a list.\r\n                    // 2. Document remains within the MutationQueue while batch-request is being processed by server.\r\n                    // 3. User clicks the added item to edit or view it (or our component redirects to its editor)\r\n                    // 4. A new query of that particular ID is subscribed to {ids=[theId]}\r\n                    //    KedBackendQuery.subscribe then does this:\r\n                    //      1. Call queryLocally() before querying server\r\n                    //      2. queryLocally() inspects mutations and finds a match, returning an empty list\r\n                    //         (assumes as we are adding it, it can't exist on the server anyway)\r\n                    //      3. KedBackendQUery applies mutations onto the empty list, and ends up here to add\r\n                    //         it optimistically.\r\n                    //      4. When server responds with 200 OK, calls us here again with optimistic=false\r\n                    //         to \"persist\" it in the query's data array.\r\n                    //      4B: If not 200 OK, mutation may be gone and the subscriber will se an error page\r\n                    //         \"Could not find entity with id X.\" along with a red error message on the screen\r\n                    //         about that it failed to save on server.\r\n                    return data.concat(this.setGraphProps(m.relatedDoc));\r\n                }\r\n                return data;\r\n            case 'remove-related':\r\n                if (table === m.table && includes.indexOf(m.graphProp) !== -1) {\r\n                    return updateArray(data, function (doc) {\r\n                        var _a;\r\n                        var includedDocs = doc[m.graphProp];\r\n                        if (!includedDocs)\r\n                            return doc;\r\n                        if (doc.id !== m.id)\r\n                            return doc;\r\n                        return tslib_1.__assign({}, doc, (_a = {}, _a[m.graphProp] = optimistic ?\r\n                            // Mark related-doc-to-remove with $meta: 'deleting'\r\n                            includedDocs.map(function (d) { return d.id !== m.relatedDoc.id ?\r\n                                d : tslib_1.__assign({}, d, { $meta: 'deleting' }); }) :\r\n                            // Delete related-doc-to-remove from doc[grapProp]:\r\n                            includedDocs.filter(function (d) { return d.id !== m.relatedDoc.id; }), _a));\r\n                    });\r\n                }\r\n                if (listOptions.hasEdgesFrom) {\r\n                    if (sourceIds.includes(m.id))\r\n                        return optimistic ?\r\n                            data.map(function (d) { return d.id === m.relatedDoc.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                            data.filter(function (d) { return d.id !== m.relatedDoc.id; });\r\n                }\r\n                return data;\r\n            case 'delete':\r\n                if (table === m.table) {\r\n                    return data.filter(function (d) { return d.id !== m.id; });\r\n                }\r\n                else if (listOptions.include) {\r\n                    var includedTables = includes\r\n                        .map(function (label) { return ({ label: label, table: getTableFromLabel(table, label) }); });\r\n                    var labels_1 = includedTables.filter(function (_a) {\r\n                        var table = _a.table;\r\n                        return table === m.table;\r\n                    });\r\n                    if (labels_1.length > 0) {\r\n                        return updateArray(data, function (doc) {\r\n                            labels_1.forEach(function (_a) {\r\n                                var label = _a.label;\r\n                                var _b;\r\n                                var relatedDocs = doc[label];\r\n                                if (relatedDocs) {\r\n                                    doc = tslib_1.__assign({}, doc, (_b = {}, _b[label] = optimistic ?\r\n                                        relatedDocs.map(function (d) { return d.id === m.id ? tslib_1.__assign({}, d, { $meta: 'deleting' }) : d; }) :\r\n                                        relatedDocs.filter(function (_a) {\r\n                                            var id = _a.id;\r\n                                            return id !== m.id;\r\n                                        }), _b));\r\n                                }\r\n                            });\r\n                            return doc;\r\n                        });\r\n                    }\r\n                }\r\n                return data;\r\n            default:\r\n                return data;\r\n        }\r\n    };\r\n    KedBackendQuery.prototype.setGraphProps = function (doc) {\r\n        var copy = tslib_1.__assign({}, doc);\r\n        this.includes.forEach(function (label) { return copy[label] = copy[label] || []; });\r\n        return copy;\r\n    };\r\n    return KedBackendQuery;\r\n}());\r\nexport { KedBackendQuery };\r\n//# sourceMappingURL=kedbackend-query.js.map","import * as tslib_1 from \"tslib\";\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { KedBackendCollection } from './kedbackend-collection';\r\nimport { QuerySet } from './query-set';\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { KedBackendWriter } from './kedbackend-writer';\r\nimport { DeltaCollection } from './delta-collection/delta-collection';\r\nvar KedBackendRepo = /** @class */ (function () {\r\n    function KedBackendRepo(getClient, getUser, getUserDisplayName, defaultQueryOptions, mutationQueue, querySet, writer, cacheOptimized) {\r\n        var _this = this;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this.defaultQueryOptions = defaultQueryOptions;\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.writer = writer;\r\n        this.cacheOptimized = cacheOptimized;\r\n        if (!defaultQueryOptions)\r\n            this.defaultQueryOptions = {};\r\n        if (!mutationQueue)\r\n            this.mutationQueue = new MutationQueue();\r\n        if (!querySet)\r\n            this.querySet = new QuerySet(this.mutationQueue);\r\n        if (!writer)\r\n            this.writer = new KedBackendWriter(this.mutationQueue, this.querySet, getClient, getUser, getUserDisplayName);\r\n        Object.keys(tables).forEach(function (table) {\r\n            var collection = new KedBackendCollection(_this, table, defaultQueryOptions || {});\r\n            if (cacheOptimized) {\r\n                collection = collection.cacheOptimized();\r\n            }\r\n            _this[table] = collection;\r\n        });\r\n        this.deltas = new DeltaCollection(this.writer.deltaCache, {\r\n            branchId: this.defaultQueryOptions.branchId // If branchId is undefined. DeltaCollection will respond with Error on subscribe()\r\n        });\r\n    }\r\n    KedBackendRepo.prototype.table = function (tableName) {\r\n        var collection = new KedBackendCollection(this, tableName, this.defaultQueryOptions);\r\n        if (this.cacheOptimized)\r\n            collection = collection.cacheOptimized();\r\n        return collection;\r\n    };\r\n    KedBackendRepo.prototype._clone = function (queryOptions, cacheOptimized) {\r\n        var clone = new KedBackendRepo(this.getClient, this.getUser, this.getUserDisplayName, tslib_1.__assign({}, this.defaultQueryOptions, queryOptions), this.mutationQueue, this.querySet, this.writer, cacheOptimized === undefined ? this.cacheOptimized : cacheOptimized);\r\n        return clone;\r\n    };\r\n    KedBackendRepo.prototype.branch = function (branchId) {\r\n        return this._clone({ branchId: branchId });\r\n    };\r\n    KedBackendRepo.prototype.role = function (role) {\r\n        return this._clone({ role: role });\r\n    };\r\n    KedBackendRepo.prototype.optimizeCache = function () {\r\n        return this._clone({}, true);\r\n    };\r\n    KedBackendRepo.prototype.clearBranch = function () {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot clear master branch\");\r\n        this.writer.mutate([{ op: 'clear-branch', branchId: this.defaultQueryOptions.branchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.merge = function (targetBranchId) {\r\n        if (!this.defaultQueryOptions.branchId)\r\n            throw new Error(\"Cannot merge from master branch\");\r\n        this.writer.mutate([{ op: 'merge', branchId: this.defaultQueryOptions.branchId, targetBranchId: targetBranchId }], 0);\r\n    };\r\n    KedBackendRepo.prototype.saveNow = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.writer.waitForVersionToPersist(this.writer.currentVersion)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return KedBackendRepo;\r\n}());\r\nexport { KedBackendRepo };\r\n//# sourceMappingURL=kedbackend-repo.js.map","var KedBackendSubscription = /** @class */ (function () {\r\n    function KedBackendSubscription(subscriber, collection) {\r\n        this.subscriber = subscriber;\r\n        this.collection = collection;\r\n    }\r\n    KedBackendSubscription.prototype.notifySubscriber = function (data, error) {\r\n        try {\r\n            if (error)\r\n                this.subscriber([], error, this);\r\n            else if (data !== this.lastNotifiedData) { // Will in-fact be equal by reference if data is same as last notification (as we use an immutable approach on data)\r\n                this.lastNotifiedData = data;\r\n                this.subscriber(data, error, this);\r\n            }\r\n        }\r\n        catch (ex) {\r\n            try {\r\n                this.subscriber([], ex, this);\r\n            }\r\n            catch (ex2) {\r\n                console.error(\"Error while notifying KedBackendSubscriber:\", ex2, 'originally notified error:', ex);\r\n            }\r\n        }\r\n    };\r\n    KedBackendSubscription.prototype.unsubscribe = function () {\r\n        this.collection.unsubscribe(this);\r\n    };\r\n    return KedBackendSubscription;\r\n}());\r\nexport { KedBackendSubscription };\r\n//# sourceMappingURL=kedbackend-subscription.js.map","import * as tslib_1 from \"tslib\";\r\nimport { MutationQueue } from './mutation-queue';\r\nimport { BatchRunner } from '../ked-backend-client';\r\nimport { tables } from 'kedbackend-schema/schema.json';\r\nimport { CacheBust } from './cache-bust';\r\nimport { Emitter } from '../observable';\r\nimport { DeltaCache } from './delta-collection/delta-cache';\r\nvar KedBackendWriter = /** @class */ (function () {\r\n    function KedBackendWriter(mutationQueue, querySet, getClient, getUser, getUserDisplayName) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.querySet = querySet;\r\n        this.getClient = getClient;\r\n        this.getUser = getUser;\r\n        this.getUserDisplayName = getUserDisplayName;\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = null;\r\n        this.currentVersion = 0;\r\n        this.persistedVersion = new Emitter(0);\r\n        this.errorSubscribers = [];\r\n        this.stateSubscribers = [];\r\n        this.deltaCache = new DeltaCache(getClient, getUser, getUserDisplayName);\r\n    }\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isSaving\", {\r\n        get: function () { return !!this._isSavingPromise; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(KedBackendWriter.prototype, \"isEdited\", {\r\n        get: function () { return this.mutationQueue.get().length > 0; },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    KedBackendWriter.prototype.onError = function (callback) {\r\n        this.errorSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.onStateChange = function (callback) {\r\n        this.stateSubscribers.push(callback);\r\n    };\r\n    KedBackendWriter.prototype.off = function (callback) {\r\n        this.errorSubscribers = this.errorSubscribers.filter(function (s) { return s !== callback; });\r\n        this.stateSubscribers = this.stateSubscribers.filter(function (s) { return s !== callback; });\r\n    };\r\n    KedBackendWriter.prototype.dispatchError = function (error, retryable) {\r\n        var _this = this;\r\n        this.errorSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(error, retryable, _this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.dispatchStateChange = function () {\r\n        var _this = this;\r\n        this.stateSubscribers.forEach(function (callback) {\r\n            try {\r\n                callback(_this);\r\n            }\r\n            catch (_) { }\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mutate = function (mutations, debounce) {\r\n        this.mutationQueue.add(mutations);\r\n        ++this.currentVersion;\r\n        this.dispatchStateChange();\r\n        this.querySet.notifySubscribers();\r\n        this.deltaCache.applyMutations(this.mutationQueue.get(), { optimistic: true });\r\n        if (!this._isSavingPromise) {\r\n            if (this._timeoutId)\r\n                clearTimeout(this._timeoutId);\r\n            this._timeoutId = setTimeout(this.save.bind(this), debounce);\r\n        }\r\n        // If isSaving, we don't need to do anything, becase it will re-check if additional\r\n        // mutations have come, when saving is done.\r\n    };\r\n    KedBackendWriter.prototype.retrySave = function () {\r\n        return this.save();\r\n    };\r\n    KedBackendWriter.prototype.waitForVersionToPersist = function (version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var persistedVersion;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.persistedVersion.load()];\r\n                    case 1:\r\n                        persistedVersion = _a.sent();\r\n                        if (!(persistedVersion < version)) return [3 /*break*/, 3];\r\n                        this.save(); // Be more eager to save\r\n                        return [4 /*yield*/, this.persistedVersion.filter(function (persistedVersion) { return persistedVersion >= version; }).load()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.save = function () {\r\n        var _this = this;\r\n        if (this._timeoutId)\r\n            clearTimeout(this._timeoutId);\r\n        if (this._isSavingPromise)\r\n            return this._isSavingPromise;\r\n        if (!this.isEdited)\r\n            return Promise.resolve();\r\n        this._timeoutId = null;\r\n        this._isSavingPromise = this._save();\r\n        this._isSavingPromise.catch(function () { }).then(function () { return _this._isSavingPromise = null; });\r\n        return this._isSavingPromise;\r\n    };\r\n    KedBackendWriter.prototype._save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var mutations, version, mutationRequests, res_1, etagMutations, error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.dispatchStateChange();\r\n                        mutations = this.mutationQueue.get();\r\n                        version = this.currentVersion;\r\n                        this.mutationQueue.moveToSavingQueue();\r\n                        mutationRequests = this.mapMutations(mutations);\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 6, 11, 12]);\r\n                        return [4 /*yield*/, this.getClient().batch(mutationRequests)];\r\n                    case 2:\r\n                        res_1 = _a.sent();\r\n                        etagMutations = Object.keys(res_1.newEtags).map(function (id) { return ({\r\n                            op: 'update',\r\n                            table: null,\r\n                            id: id,\r\n                            deltaDoc: { $etag: res_1.newEtags[id] },\r\n                            targetName: null // We don't have the target name. But this mutation won't be visible in a DeltaCollection anyway, so it wont be used.\r\n                        }); });\r\n                        // Invalidate cache\r\n                        CacheBust.invalidateCache(mutationRequests, this.getUser());\r\n                        // Commmit mutations along with etagMutations into queries cached data\r\n                        this.persistedVersion.dispatch(version);\r\n                        this.deltaCache.applyMutations(mutations, { optimistic: false });\r\n                        return [4 /*yield*/, this.querySet.commitMutations(MutationQueue.merge(mutations, etagMutations), version)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        // On success, clear saving queue as the mutations will now be committed to all query's data instead.\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        // Finally, notify subscribers so that views get updated with committed results\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 5];\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 4:\r\n                        // Additional mutations happend while we were saving. Handle them as well.\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5: return [3 /*break*/, 12];\r\n                    case 6:\r\n                        error_1 = _a.sent();\r\n                        this.persistedVersion.dispatchError(error_1);\r\n                        if (!(error_1 && error_1.name && error_1.name.startsWith(\"http4\"))) return [3 /*break*/, 9];\r\n                        // Access Control denied, bad request or similar. Throw mutations away.\r\n                        this.dispatchError(error_1, false);\r\n                        this.mutationQueue.clearSavingQueue();\r\n                        this.dispatchStateChange(); // isEdited may have turned to false\r\n                        this.querySet.notifySubscribers();\r\n                        if (!(this.mutationQueue.get().length > 0)) return [3 /*break*/, 8];\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 7:\r\n                        // Ho ho! Additional mutations happend while we were saving. Handle them alone. THey might be more lucky.\r\n                        _a.sent();\r\n                        _a.label = 8;\r\n                    case 8: return [3 /*break*/, 10];\r\n                    case 9:\r\n                        this.dispatchError(error_1, true);\r\n                        _a.label = 10;\r\n                    case 10: return [3 /*break*/, 12];\r\n                    case 11:\r\n                        this.dispatchStateChange();\r\n                        return [7 /*endfinally*/];\r\n                    case 12: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    KedBackendWriter.prototype.mapMutations = function (mutations) {\r\n        var br = new BatchRunner();\r\n        mutations.forEach(function (m) {\r\n            switch (m.op) {\r\n                case 'update':\r\n                    br.update(m.table, m.id, m.deltaDoc, m.branchId);\r\n                    break;\r\n                case 'add':\r\n                    br.add(m.table, m.doc);\r\n                    break;\r\n                case 'add-related':\r\n                    if (!m.relatedDoc.$etag) {\r\n                        // No $etag means this is a new document. Add it before linking to it:\r\n                        br.add(tables[m.table].relationships[m.graphProp], m.relatedDoc, m.branchId);\r\n                    }\r\n                    br.link2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'remove-related':\r\n                    br.unlink2(m.table, m.id, m.graphProp, m.relatedDoc.id, m.branchId);\r\n                    break;\r\n                case 'undo-link':\r\n                    br.undoLink(m.table, m.id, m.graphProp, m.relatedId, m.branchId);\r\n                    break;\r\n                case 'delete':\r\n                    br.delete(m.table, m.id);\r\n                    break;\r\n                case 'clear-branch':\r\n                    br.clearBranch(m.branchId);\r\n                    break;\r\n                case 'merge':\r\n                    br.merge(m.branchId, m.targetBranchId);\r\n                    break;\r\n            }\r\n        });\r\n        return br.mutationRequests;\r\n    };\r\n    return KedBackendWriter;\r\n}());\r\nexport { KedBackendWriter };\r\n//# sourceMappingURL=kedbackend-writer.js.map","import * as tslib_1 from \"tslib\";\r\nimport { getTableFromLabel, branchSensitive, globalOp } from './utils';\r\nimport { mergeDeltas } from './delta-merge';\r\nvar MutationQueue = /** @class */ (function () {\r\n    function MutationQueue() {\r\n        this.queue = [];\r\n        this.savingQueue = [];\r\n    }\r\n    MutationQueue.prototype.add = function (mutations) {\r\n        this.queue = MutationQueue.merge(this.queue, mutations);\r\n    };\r\n    MutationQueue.prototype.moveToSavingQueue = function () {\r\n        this.savingQueue = MutationQueue.merge(this.savingQueue, this.queue);\r\n        this.queue = [];\r\n    };\r\n    MutationQueue.prototype.clearSavingQueue = function () {\r\n        this.savingQueue = [];\r\n    };\r\n    MutationQueue.prototype.get = function () {\r\n        return this.savingQueue.concat(this.queue);\r\n    };\r\n    MutationQueue.prototype.affectsQuery = function (table, query, includes) {\r\n        var mutations = this.get();\r\n        if (mutations.some(function (m) { return m.op === 'merge' || m.op === 'clear-branch'; }))\r\n            return true;\r\n        if (query.ids) {\r\n            // A query with \"ids\" filter will be easy to detect a no-match on:\r\n            return mutations.some(function (m) { return globalOp(m) || (!branchSensitive(m) || m.branchId === query.branchId) &&\r\n                query.ids.includes(m.id); });\r\n        }\r\n        // Otherwise, check if mutations affect same branch and table. Could be done more fine grained,\r\n        // but that would only be a suboptimization.\r\n        return mutations.some(function (m) {\r\n            return m.op === 'add' ?\r\n                m.table === table :\r\n                m.op === 'delete' ?\r\n                    m.table === table || (includes.some(function (label) { return getTableFromLabel(table, label) === m.table; })) :\r\n                    globalOp(m) ? true :\r\n                        m.branchId == query.branchId &&\r\n                            (m.table === table || (m.op !== 'update' && ([table].concat(includes.map(function (label) { return getTableFromLabel(table, label); })).some(function (table) { return getTableFromLabel(m.table, m.graphProp) === table; }))));\r\n        });\r\n    };\r\n    MutationQueue.merge = function (queue1, queue2) {\r\n        var mutableQueue1 = queue1.slice();\r\n        var mutableQueue2 = queue2.slice();\r\n        //if (mutableQueue1.length > 0) debugger;\r\n        var len = queue1.length;\r\n        var _loop_1 = function (i) {\r\n            var m = queue1[i];\r\n            if (m.op === 'update') {\r\n                var overlappingIdOpIdx = mutableQueue2.findIndex(function (newMut) {\r\n                    return newMut.op === 'update' &&\r\n                        newMut.branchId === m.branchId &&\r\n                        newMut.id === m.id;\r\n                });\r\n                if (overlappingIdOpIdx >= 0) {\r\n                    mutableQueue1[i] = tslib_1.__assign({}, m, { deltaDoc: mergeDeltas(m.deltaDoc, mutableQueue2[overlappingIdOpIdx].deltaDoc) });\r\n                    mutableQueue2.splice(overlappingIdOpIdx, 1);\r\n                }\r\n            }\r\n        };\r\n        for (var i = 0; i < len; ++i) {\r\n            _loop_1(i);\r\n        }\r\n        return mutableQueue1.concat(mutableQueue2);\r\n    };\r\n    return MutationQueue;\r\n}());\r\nexport { MutationQueue };\r\n//# sourceMappingURL=mutation-queue.js.map","import * as tslib_1 from \"tslib\";\r\nimport { KedBackendQuery } from './kedbackend-query';\r\nimport * as JsonSchema from 'kedbackend-schema/schema.json';\r\nimport { queryArray } from './utils';\r\nvar QuerySet = /** @class */ (function () {\r\n    function QuerySet(mutationQueue) {\r\n        this.mutationQueue = mutationQueue;\r\n        this.queries = [];\r\n    }\r\n    QuerySet.prototype.commitMutations = function (mutations, version) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, Promise.all(this.queries.map(function (q) { return q.commitMutations(mutations, version); }))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.cleanupInvalidQueries();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QuerySet.prototype.cleanupInvalidQueries = function () {\r\n        this.queries = this.queries.filter(function (q) {\r\n            if (q.invalid) {\r\n                if (q.timeoutHandle) {\r\n                    clearTimeout(q.timeoutHandle);\r\n                    q.timeoutHandle = null;\r\n                }\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n    };\r\n    QuerySet.prototype.notifySubscribers = function () {\r\n        var optimisticMutations = this.mutationQueue.get();\r\n        this.queries.forEach(function (q) {\r\n            q.notifySubscribers(optimisticMutations);\r\n        });\r\n    };\r\n    QuerySet.prototype.findQuery = function (table, query) {\r\n        return this.queries.find(function (q) { return q.queryKey === KedBackendQuery.queryKey(table, query); });\r\n    };\r\n    QuerySet.prototype.queryLocally = function (table, query, includes) {\r\n        // For now, only handle this very common and special case (which\r\n        // will save a lot of unnescessary network traffic if I am thinking right...)\r\n        var mutations = this.mutationQueue.get();\r\n        // Check if the query wants to get a single entity by its ID:\r\n        if (query.ids && query.ids.length === 1) {\r\n            // And if so, if we have an outgoing mutation to create that entity:\r\n            if (mutations.some(function (m) { return m.op === 'add-related' && m.relatedDoc.id === query.ids[0]; })) {\r\n                // Then return an EMPTY response, signalling that we can resolve this locally,\r\n                // but let the optistic feature of KedBackendQuery apply the mutation before\r\n                // notifying subscribers (we don't want it to be persistent before the server\r\n                // has accepted the mutation)\r\n                return [];\r\n            }\r\n        }\r\n        // OK, another quite common case is when we ask for a certain ID and that ID replies\r\n        // within another query\r\n        if (query.hasEdgesFrom || query.hasEdgesTo)\r\n            return null; // Not possible to handle\r\n        if (!query.ids)\r\n            return null; // For now, just take hight for this particular and most common case!\r\n        var _loop_1 = function (q) {\r\n            if (!q.gotInitialResponse)\r\n                return \"continue\";\r\n            if (q.query.branchId !== query.branchId)\r\n                return \"continue\";\r\n            if (q.query.flags)\r\n                return \"continue\"; // It would be complex to support various flags. Query's data may include ids only. Can't rely on the query.\r\n            var qIncludes = q.includes;\r\n            if (qIncludes.length > 0 && (!query.include || query.include.length === 0)) {\r\n                // We don't include, but this query does. Check if we can find our result within it.\r\n                var label = qIncludes.find(function (l) { return JsonSchema.tables[q.table][\"relationships\"][l] === table; });\r\n                if (label) {\r\n                    var res_1 = {};\r\n                    for (var _i = 0, _a = q.data; _i < _a.length; _i++) {\r\n                        var entity = _a[_i];\r\n                        var subData = queryArray(query, entity[label]);\r\n                        subData.forEach(function (r) { return res_1[r.id] = r; });\r\n                    }\r\n                    var result_1 = Object.keys(res_1).map(function (id) { return res_1[id]; });\r\n                    // Only return result if we could look up every requested ID:\r\n                    if (!query.ids.every(function (id) { return result_1.some(function (x) { return x.id === id; }); }))\r\n                        return \"continue\";\r\n                    return { value: result_1 };\r\n                }\r\n            }\r\n            if (!includes.every(function (label) { return qIncludes.includes(label); }))\r\n                return \"continue\";\r\n            // Lastly, if the query includes all graphs that we do, pick the subset from that query.\r\n            // Concrete example: We observe a certain Task by ID and want its knowledgeRequirements along with it,\r\n            // and there's another query of all tasks that also includes knowledgeRequirements. Use it. \r\n            if (q.table === table) {\r\n                var result_2 = queryArray(query, q.data);\r\n                // Only return result if we could look up every requested ID:\r\n                if (!query.ids.every(function (id) { return result_2.some(function (x) { return x.id === id; }); }))\r\n                    return \"continue\";\r\n                return { value: result_2 };\r\n            }\r\n        };\r\n        for (var _i = 0, _a = this.queries; _i < _a.length; _i++) {\r\n            var q = _a[_i];\r\n            var state_1 = _loop_1(q);\r\n            if (typeof state_1 === \"object\")\r\n                return state_1.value;\r\n        }\r\n    };\r\n    QuerySet.prototype.subscribe = function (subscription) {\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (!kbQuery) {\r\n            kbQuery = new KedBackendQuery(table, query, repo.getUser(), repo, this.mutationQueue);\r\n            this.queries.push(kbQuery);\r\n        }\r\n        else {\r\n            if (kbQuery.timeoutHandle) {\r\n                clearTimeout(kbQuery.timeoutHandle);\r\n                kbQuery.timeoutHandle = null;\r\n            }\r\n        }\r\n        kbQuery.subscribe(subscription);\r\n    };\r\n    QuerySet.prototype.unsubscribe = function (subscription) {\r\n        var _this = this;\r\n        var _a = subscription.collection, table = _a.table, query = _a.query, repo = _a.repo;\r\n        var kbQuery = this.findQuery(table, query);\r\n        if (kbQuery) {\r\n            // Prohibit further notifications to this subscription:\r\n            kbQuery.unsubscribe(subscription);\r\n            // Release unnescessary memory when there are no more subscriptions of this query, by removing the query itself\r\n            // To that in a delayed manner, so that an unsubscribe() followed by an immediate subscribe() don't have to re-query the server:\r\n            if (kbQuery.subscriptions.length === 0) {\r\n                // Schedule for garbage collection in 5 minutes:\r\n                kbQuery.timeoutHandle = setTimeout(function () {\r\n                    // Check if kbQuery still has no subscriptions (not certain! A new subscriber may have come along...)\r\n                    if (kbQuery.subscriptions.length === 0) {\r\n                        // Still no subscriptions on it, time to release some memory and forget the in-memory cache of the query result\r\n                        _this.queries = _this.queries.filter(function (q) { return q !== kbQuery; });\r\n                    }\r\n                }, this.queries.length > 50 ?\r\n                    500 : // Don't host too many queries. Garbage collect this within 500 ms\r\n                    5 * 60000); // Allow query in memory for another 5 minutes\r\n            }\r\n        }\r\n    };\r\n    return QuerySet;\r\n}());\r\nexport { QuerySet };\r\n//# sourceMappingURL=query-set.js.map","import { tables } from 'kedbackend-schema/schema.json';\r\nexport function getTableFromLabel(table, label) {\r\n    return tables[table].relationships[label];\r\n}\r\nexport function queryArray(query, data) {\r\n    var filter = getFilterFromQuery(query);\r\n    return data.filter(filter);\r\n}\r\nexport function AND(filter1, filter2) {\r\n    return function (x) { return filter1(x) && filter2(x); };\r\n}\r\nexport function getFilterFromQuery(query) {\r\n    var filter = function (x) { return true; };\r\n    if (query.from)\r\n        return AND(filter, function (x) { return x.dateTime >= query.from; });\r\n    if (query.to)\r\n        return AND(filter, function (x) { return x.dateTime < query.to; });\r\n    if (query.ids)\r\n        return AND(filter, function (x) { return query.ids.includes(x.id); });\r\n    if (query.name)\r\n        return AND(filter, function (x) { return x.name === query.name; });\r\n    if (query.tags)\r\n        return AND(filter, function (x) { return x.tags && [].concat(query.tags || []).some(function (tag) { return x.tags.includes(tag); }); });\r\n    // query.hasEdgesFrom and query.hasEdgesTo cannot by filtered here\r\n    return filter;\r\n}\r\nexport function branchSensitive(m) {\r\n    return m.op !== 'delete';\r\n}\r\nexport function globalOp(m) {\r\n    return m.op === 'clear-branch' || m.op === 'merge';\r\n}\r\n//# sourceMappingURL=utils.js.map","import migrate from './migrate';\r\nexport var KedModelMigratorMixin = function (client) {\r\n    if (client.__migrator_mixed_in)\r\n        return;\r\n    client.__migrator_mixed_in = true;\r\n    var get = client.get;\r\n    var list = client.list;\r\n    client.get = function (table, id, options) {\r\n        var include = options && options.include;\r\n        return get.apply(this, arguments).then(function (result) {\r\n            migrate(result, table, include && include.toString().split(','));\r\n            return result;\r\n        });\r\n    };\r\n    client.list = function (table, options) {\r\n        var include = options && options.include;\r\n        return list.apply(this, arguments).then(function (result) {\r\n            result.forEach(function (doc) { return migrate(doc, table, include && include.toString().split(',')); });\r\n            return result;\r\n        });\r\n    };\r\n    return client;\r\n};\r\n//# sourceMappingURL=index.js.map","import migrateTask from './migrate-task';\r\nexport default function migrateCourse(course, graphs) {\r\n    if (!course.modules)\r\n        course.modules = [];\r\n    course.modules.forEach(function (module) {\r\n        if (!module.resources) {\r\n            module.resources = [];\r\n        }\r\n        if (!module.taskIds) {\r\n            module.taskIds = [];\r\n        }\r\n    });\r\n    if (!course.responsibleTeachers) {\r\n        course.responsibleTeachers = [];\r\n    }\r\n    // Earlier wrong spelling of resources\r\n    if ('resourses' in course && !('resources' in course)) {\r\n        course.resources = course.resourses;\r\n        delete course.resourses;\r\n    }\r\n    if (!course.resources) {\r\n        course.resources = [];\r\n    }\r\n    if (graphs) {\r\n        graphs.forEach(function (label) {\r\n            switch (label) {\r\n                case 'tasks':\r\n                    course.tasks.forEach(function (task) { return migrateTask(task); });\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=migrate-course.js.map","export default function migrateTask(task) {\r\n    if (!task.resources)\r\n        task.resources = [];\r\n}\r\n//# sourceMappingURL=migrate-task.js.map","import migrateCourse from './migrate-course';\r\nimport migrateTask from './migrate-task';\r\nexport default function migrate(doc, table, graphs) {\r\n    switch (table) {\r\n        case \"courses\":\r\n            migrateCourse(doc, graphs);\r\n            break;\r\n        case \"tasks\":\r\n            migrateTask(doc);\r\n            break;\r\n    }\r\n}\r\n//# sourceMappingURL=migrate.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Value } from \"./value\";\r\nimport { Emitter } from \"./emitter\";\r\nvar Collection = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Collection, _super);\r\n    function Collection(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Collection.prototype._map = function (mapper) {\r\n        throw \"mixedin\";\r\n    };\r\n    Collection.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Collection(function (s) { return x.subscribe(s); });\r\n        if (Array.isArray(x)) {\r\n            var emitter_1 = new Emitter(x);\r\n            return new Collection(function (s) { return emitter_1.subscribe(s); });\r\n        }\r\n        throw new Error(\"ObservableCollection.from() can only take arrays or observables\");\r\n    };\r\n    Collection.prototype.map = function (mapper) {\r\n        return this._map(function (items) { return items.map(function (item) { return mapper(item); }); });\r\n    };\r\n    Collection.prototype.flat = function () {\r\n        return this._map(function (items) { return [].concat.apply([], items); });\r\n    };\r\n    Collection.prototype.filter = function (filter) {\r\n        return this._map(function (items) { return items.filter(filter); });\r\n    };\r\n    Collection.prototype.concat = function (other) {\r\n        return Collection.from(this.toValue().combineLatest(other).map(function (_a) {\r\n            var me = _a[0], other = _a[1];\r\n            return me.concat(other);\r\n        }));\r\n    };\r\n    Collection.prototype.orderBy = function (prop) {\r\n        return this.toValue().map(function (array) { return array.slice().sort(function (a, b) {\r\n            var aProp = a && a[prop];\r\n            var bProp = b && b[prop];\r\n            return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n        }); }).toCollection(function (x) { return x; });\r\n    };\r\n    Collection.prototype.toValue = function () {\r\n        var _this = this;\r\n        return new Value(function (s) { return _this.subscribe(s); });\r\n    };\r\n    Collection.prototype.groupBy = function (prop) {\r\n        return this.toValue().map(function (items) {\r\n            var rv = {};\r\n            items.forEach(function (item) {\r\n                var list = rv[item[prop]] || (rv[item[prop]] = []);\r\n                list.push(item);\r\n            });\r\n            return rv;\r\n        });\r\n    };\r\n    Collection.prototype.first = function () {\r\n        return this.toValue().map(function (arr) { return arr[0]; });\r\n    };\r\n    return Collection;\r\n}(Observable));\r\nexport { Collection };\r\nCollection.prototype._map = initMapMethod(Collection);\r\n//# sourceMappingURL=collection.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Value } from \"./value\";\r\nvar Emitter = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Emitter, _super);\r\n    function Emitter(initialValue) {\r\n        var _this = _super.call(this, function (observer) {\r\n            var subscription = {\r\n                unsubscribe: function () { return _this.subscribers = _this.subscribers.filter(function (_a) {\r\n                    var s = _a[0];\r\n                    return s !== observer;\r\n                }); },\r\n            };\r\n            _this.subscribers.push([observer, subscription]);\r\n            if (_this.error)\r\n                observer(null, _this.error, subscription);\r\n            else\r\n                observer(_this.value, undefined, subscription);\r\n            return subscription;\r\n        }) || this;\r\n        _this.subscribers = [];\r\n        _this.value = initialValue;\r\n        return _this;\r\n    }\r\n    Emitter.prototype.dispatch = function (value) {\r\n        this.value = value;\r\n        this.error = undefined;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype.dispatchError = function (error) {\r\n        this.error = error;\r\n        this._dispatch();\r\n    };\r\n    Emitter.prototype._dispatch = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (_a) {\r\n            var observer = _a[0], subscription = _a[1];\r\n            try {\r\n                observer(_this.value, _this.error, subscription);\r\n            }\r\n            catch (err) {\r\n                observer(null, err, subscription);\r\n            }\r\n        });\r\n    };\r\n    return Emitter;\r\n}(Value));\r\nexport { Emitter };\r\n//# sourceMappingURL=emitter.js.map","var stack = [];\r\nvar currentFiber = null;\r\nvar providers = [function () { return currentFiber; }];\r\nfunction pushFiber(fiber) {\r\n    stack.push(currentFiber);\r\n    currentFiber = fiber;\r\n}\r\nfunction popFiber() {\r\n    currentFiber = stack.pop();\r\n}\r\nvar _FiberContext = {\r\n    get current() { return currentFiber; },\r\n    /*run: function rerun<R>(fiber: Fiber, fn: ()=>R): R | Promise<R> {\r\n      pushFiber(fiber);\r\n      try {\r\n        return Promise.resolve(fn());\r\n      } catch (p) {\r\n        if (p && typeof p.then === 'function') {\r\n          return p.then(()=>rerun(fiber, fn));\r\n        } else {\r\n          return Promise.reject(p);\r\n        }\r\n      } finally {\r\n        popFiber();\r\n      }\r\n    },*/\r\n    addProvider: function (getCurrentFiber) {\r\n        providers.push(getCurrentFiber);\r\n        setCurrentGetterFromProviders();\r\n    },\r\n    removeProvider: function (getCurrentFiber) {\r\n        providers = providers.filter(function (p) { return p !== getCurrentFiber; });\r\n        setCurrentGetterFromProviders();\r\n    }\r\n};\r\nfunction setCurrentGetterFromProviders() {\r\n    Object.defineProperty(_FiberContext, \"current\", {\r\n        get: providers.reduce(function (p, c) { return function () { return p() || c(); }; }),\r\n        set: function () { throw new Error(\"Use FiberContext.push() to change current fiber\"); }\r\n    });\r\n}\r\nvar _global = (typeof self === 'undefined' ? global : self);\r\nif (!_global[\"KEDFiberContext\"]) {\r\n    _global[\"KEDFiberContext\"] = _FiberContext;\r\n}\r\nexport var FiberContext = _global[\"KEDFiberContext\"];\r\n//# sourceMappingURL=fiber-context.js.map","export * from './observable';\r\nexport * from './value';\r\nexport * from './collection';\r\nexport * from './emitter';\r\nexport * from './fiber-context';\r\n//# sourceMappingURL=index.js.map","export function initMapMethod(ctor) {\r\n    return function (mapper) {\r\n        var _this = this;\r\n        return new ctor(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else\r\n                try {\r\n                    observer(mapper(value), error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n        }); });\r\n    };\r\n}\r\n//# sourceMappingURL=map.js.map","export function mixin(targetProto, mixinProto) {\r\n    var props = [];\r\n    for (var _i = 2; _i < arguments.length; _i++) {\r\n        props[_i - 2] = arguments[_i];\r\n    }\r\n    props.forEach(function (prop) { return targetProto[prop] = mixinProto[prop]; });\r\n}\r\n//# sourceMappingURL=mixin.js.map","var Observable = /** @class */ (function () {\r\n    //static get [Symbol.species]() { return this; }\r\n    function Observable(_subscribe) {\r\n        this._subscribe = _subscribe;\r\n    }\r\n    Observable.prototype.subscribe = function (observer) {\r\n        try {\r\n            return this._subscribe(function (items, error, subscription) {\r\n                try {\r\n                    observer(items, error, subscription);\r\n                }\r\n                catch (err) {\r\n                    observer(null, err, subscription);\r\n                }\r\n            });\r\n        }\r\n        catch (error) {\r\n            observer(null, error, { unsubscribe: function () { } });\r\n        }\r\n    };\r\n    return Observable;\r\n}());\r\nexport { Observable };\r\n//# sourceMappingURL=observable.js.map","import * as tslib_1 from \"tslib\";\r\nimport { Observable } from \"./observable\";\r\nimport { initMapMethod } from \"./map\";\r\nimport { Collection } from \"./collection\";\r\nimport { FiberContext } from './fiber-context';\r\nvar Value = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Value, _super);\r\n    function Value(subscribe) {\r\n        return _super.call(this, subscribe) || this;\r\n    }\r\n    Value.from = function (x) {\r\n        if (x.subscribe)\r\n            return new Value(function (s) { return x.subscribe(s); });\r\n        throw new Error(\"Value.from() can only take observables\");\r\n    };\r\n    Value.prototype.read = function () {\r\n        var resolved = false, result, err, notify;\r\n        var subscription = this.subscribe(function (value, error, subsciption) {\r\n            resolved = true;\r\n            result = value;\r\n            err = error;\r\n            if (error && notify)\r\n                notify(null, error, subsciption);\r\n            else if (notify)\r\n                notify(value, null, subsciption);\r\n        });\r\n        if (resolved) {\r\n            var currentFiber = FiberContext.current;\r\n            if (!currentFiber) {\r\n                subscription.unsubscribe();\r\n                throw new Error(\"Invalid Fiber Context\");\r\n            }\r\n            if (err) {\r\n                subscription.unsubscribe();\r\n                throw err;\r\n            }\r\n            var subscriptions = currentFiber.subscriptions, observer = currentFiber.observer;\r\n            subscriptions.push(subscription);\r\n            notify = observer;\r\n            return result;\r\n        }\r\n        throw new Promise(function (resolve, reject) {\r\n            notify = function (value, error, subscription) {\r\n                subscription.unsubscribe();\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n            };\r\n        });\r\n    };\r\n    Value.prototype.load = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.subscribe(function (value, error, subsciption) {\r\n                if (error)\r\n                    reject(error);\r\n                else\r\n                    resolve(value);\r\n                subsciption.unsubscribe();\r\n            });\r\n        });\r\n    };\r\n    Value.prototype.filter = function (fn) {\r\n        var _this = this;\r\n        return new Value(function (observer) { return _this.subscribe(function (value, error, subscription) {\r\n            if (error)\r\n                observer(null, error, subscription);\r\n            else if (fn(value))\r\n                observer(value, error, subscription);\r\n        }); });\r\n    };\r\n    Value.prototype.log = function (prefix) {\r\n        return this.map(function (x) {\r\n            console.log(prefix, x);\r\n            return x;\r\n        });\r\n    };\r\n    Value.prototype.toCollection = function (mapper) {\r\n        var _this = this;\r\n        return new Collection(function (s) { return _this.map(mapper).subscribe(s); });\r\n    };\r\n    Value.prototype.combineLatest = function (other) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var values = [null, null];\r\n            var mySubscription, otherSubscription;\r\n            var subscription = {\r\n                unsubscribe: function () {\r\n                    mySubscription.unsubscribe();\r\n                    otherSubscription.unsubscribe();\r\n                }\r\n            };\r\n            mySubscription = _this.subscribe(function (items, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[0] = items;\r\n                if (values[1] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            otherSubscription = other.subscribe(function (value, error, s) {\r\n                if (error) {\r\n                    s.unsubscribe();\r\n                    observer(null, error, subscription);\r\n                }\r\n                values[1] = value;\r\n                if (values[0] !== null)\r\n                    observer(values, null, subscription);\r\n            });\r\n            return subscription;\r\n        });\r\n    };\r\n    Value.prototype.switchMap = function (mapper) {\r\n        var _this = this;\r\n        return new Value(function (observer) {\r\n            var mappedSubscription = null;\r\n            var subscription = null;\r\n            var returnedSubscription = {\r\n                unsubscribe: function () {\r\n                    subscription.unsubscribe();\r\n                    if (mappedSubscription) {\r\n                        mappedSubscription.unsubscribe();\r\n                        mappedSubscription = null;\r\n                    }\r\n                }\r\n            };\r\n            subscription = _this.subscribe(function (item, error, s) {\r\n                subscription = s;\r\n                if (mappedSubscription) {\r\n                    mappedSubscription.unsubscribe();\r\n                    mappedSubscription = null;\r\n                }\r\n                if (error)\r\n                    observer(null, error, returnedSubscription);\r\n                else {\r\n                    try {\r\n                        var observableOrValue = mapper(item);\r\n                        if (observableOrValue && typeof observableOrValue.subscribe === 'function') {\r\n                            mappedSubscription = observableOrValue.subscribe(function (value, error, s) {\r\n                                mappedSubscription = s;\r\n                                observer(value, error, returnedSubscription);\r\n                            });\r\n                        }\r\n                        else {\r\n                            observer(observableOrValue, null, subscription);\r\n                        }\r\n                    }\r\n                    catch (error) {\r\n                        observer(null, error, subscription);\r\n                    }\r\n                }\r\n            });\r\n            return returnedSubscription;\r\n        });\r\n    };\r\n    return Value;\r\n}(Observable));\r\nexport { Value };\r\nValue.prototype.map = initMapMethod(Value);\r\n//# sourceMappingURL=value.js.map","export * from './js/dist/js/observable';\r\n","export * from './js/dist/js/ked-backend-repo';\r\n","export default function getUserClaims(user) {\r\n    return [{\r\n            type: \"email\",\r\n            value: user.mail\r\n        }, {\r\n            type: \"school\",\r\n            value: user.school\r\n        }].concat(user.roles.map(function (role) { return ({\r\n        type: \"role\",\r\n        value: role\r\n    }); })).concat(user.roles.map(function (role) { return ({\r\n        type: \"schoolRole\",\r\n        value: user.school + \"/\" + role\r\n    }); }));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { DocumentAccess, hasAccess as _hasAccess } from 'kedbackend/client';\r\nimport getUserClaims from './get-user-claims';\r\nimport { parseQueryString, generateQueryString } from \"../utils/query-string\";\r\nexport { getUserClaims };\r\nexport var IMPERSONATION_QUERY_PARAMS = [\r\n    \"user\",\r\n    \"role\",\r\n    \"school\",\r\n    \"debug\",\r\n    \"testVersion\",\r\n    \"testversion\",\r\n    \"features\",\r\n    \"schoolGrade\",\r\n    \"schoolgrade\",\r\n    \"schoolType\",\r\n    \"schooltype\"\r\n];\r\nexport function hasAccess(user, doc, requestedRight) {\r\n    var claims = getUserClaims(user);\r\n    if (requestedRight !== 'R' && user.tutorFor) {\r\n        claims = claims.filter(function (claim) { return claim.type !== 'email'; });\r\n    }\r\n    var result = _hasAccess(DocumentAccess.fromStringArray(doc.acl || []), claims, requestedRight);\r\n    //console.log(`Has ${requestedRight} access to ${doc.name}/${doc.id}: ${result}`);\r\n    return result;\r\n}\r\nexport function hasReadAccess(user, doc) {\r\n    return hasAccess(user, doc, 'R');\r\n}\r\nexport function hasWriteAccess(user, doc) {\r\n    return hasAccess(user, doc, 'W');\r\n}\r\nexport function hasShareAccess(user, doc) {\r\n    return hasAccess(user, doc, 'S');\r\n}\r\nexport function isTeacherAtSchool(user, school) {\r\n    var isTeacher = user.roles.some(function (role) { return role === 'EMPLOYEE' || role === 'ADMIN'; });\r\n    var belongsToSchool = (school || \"\").toLowerCase() === user.school.toLowerCase();\r\n    return (isTeacher && belongsToSchool);\r\n}\r\nexport function isAdminOrTeacherAtSchool(user, school) {\r\n    return user.roles.includes(\"ADMIN\") || isTeacherAtSchool(user, school);\r\n}\r\nexport var impersonationEnv = {\r\n    actAs: function (options) {\r\n        var role = options.role, school = options.school, url = options.url;\r\n        var currentQuery = parseQueryString(location.search);\r\n        var newQuery = tslib_1.__assign({}, currentQuery, { role: role, school: school });\r\n        var newQueryString = generateQueryString(newQuery);\r\n        if (url) {\r\n            location.href = \"\" + url + newQueryString;\r\n        }\r\n        else {\r\n            location.hash = \"#\";\r\n            location.search = newQueryString;\r\n        }\r\n    }\r\n};\r\nexport function actAs(options) {\r\n    impersonationEnv.actAs(options);\r\n}\r\nexport function preserveImpersonationQuery(url, query) {\r\n    var e_1, _a;\r\n    var currentQuery = parseQueryString(location.search);\r\n    var preservedQuery = {};\r\n    try {\r\n        for (var IMPERSONATION_QUERY_PARAMS_1 = tslib_1.__values(IMPERSONATION_QUERY_PARAMS), IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next(); !IMPERSONATION_QUERY_PARAMS_1_1.done; IMPERSONATION_QUERY_PARAMS_1_1 = IMPERSONATION_QUERY_PARAMS_1.next()) {\r\n            var param = IMPERSONATION_QUERY_PARAMS_1_1.value;\r\n            if (currentQuery[param])\r\n                preservedQuery[param] = currentQuery[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (IMPERSONATION_QUERY_PARAMS_1_1 && !IMPERSONATION_QUERY_PARAMS_1_1.done && (_a = IMPERSONATION_QUERY_PARAMS_1.return)) _a.call(IMPERSONATION_QUERY_PARAMS_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    var newQueryString = generateQueryString(tslib_1.__assign({}, preservedQuery, query));\r\n    var pHash = url.indexOf('#');\r\n    return pHash >= 0 ?\r\n        \"\" + url.substr(0, pHash) + newQueryString + url.substr(pHash) :\r\n        \"\" + url + newQueryString;\r\n}\r\n","import React from \"react\";\r\nexport var Button = function (_a) {\r\n    var label = _a.label, addClass = _a.addClass, faIcon = _a.faIcon, action = _a.action, url = _a.url;\r\n    var className = addClass ? \"btn \" + addClass : 'btn';\r\n    if (!!url && !action)\r\n        return React.createElement(\"a\", { className: className, href: url, target: \"_blank\" },\r\n            faIcon && React.createElement(\"i\", { className: faIcon }),\r\n            \" \",\r\n            label);\r\n    return React.createElement(\"a\", { className: className, onClick: action },\r\n        faIcon && React.createElement(\"i\", { className: faIcon }),\r\n        \" \",\r\n        label);\r\n};\r\nexport var DriveButton = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? 'Google Drive' : _b, action = _a.action;\r\n    return React.createElement(Button, { label: label, faIcon: \"fab fa-google-drive\", action: action });\r\n};\r\n","// Client id for GoogleWebClient\r\nexport var WebClientId = \"421572262269-u68v5lf5o8ss5t68l8gkq3pfarh6dbkv.apps.googleusercontent.com\";\r\n// Google Drive File Id to json file with Tamplates for Course Builder (Classroom)\r\nexport var TemplatesFileId = 'https://docs.google.com/document/d/1V7exG6vN83Sq8kb6uz1B6DaZDVO9eLcJbP7XF0vL4dY/export?format=txt';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { RestClient } from 'kedbackend/client';\r\nimport { HttpError } from 'kedbackend/client';\r\nimport { getTermStarEndDate } from '../utils/school-moment';\r\nimport { SchoolTerm } from '../utils/school-term';\r\nimport { dateTimeReviver, L } from '../utils/utils';\r\nimport mockJsonFile from './mock/mock-eds-data.json';\r\nimport moment from 'moment';\r\nimport { makeSuspenseApi } from '../utils/make-suspense-api';\r\nvar EdsClient = /** @class */ (function () {\r\n    function EdsClient(isomorphic, baseUrl, bearerProvider, userEmailGetter) {\r\n        var _this = this;\r\n        this.http = new RestClient(isomorphic, baseUrl, { bearerProvider: bearerProvider });\r\n        this.userEmailGetter = userEmailGetter;\r\n        var isApiMethod = function (m) {\r\n            return typeof _this[m] === 'function' &&\r\n                m !== 'constructor' && // Since makeSuspenseApi() walks prototype chain\r\n                m !== 'privatizingCacheBust' &&\r\n                m !== 'userEmailGetter';\r\n        } // List non-API methods here...\r\n        ;\r\n        Object.keys(EdsClient.prototype).forEach(function (method) {\r\n            if (isApiMethod(method)) {\r\n                _this[method] = avoidSimultanousCalls(_this[method]);\r\n            }\r\n        });\r\n        this.suspense = makeSuspenseApi(this, { isApiMethod: isApiMethod });\r\n    }\r\n    EdsClient.prototype.privatizingCacheBust = function () {\r\n        return { user: this.userEmailGetter() };\r\n    };\r\n    /**\r\n       * Retrieve active courses for current logged in student.\r\n       *\r\n       * @param courseCode Short-name of the course. Optional.\r\n       */\r\n    EdsClient.prototype.getActiveCourses = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json, ex_1;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        _c.trys.push([0, 5, , 6]);\r\n                        query = this.privatizingCacheBust();\r\n                        if (q) {\r\n                            if (q.courseCode)\r\n                                query.CourseCode = q.courseCode;\r\n                            if (q.periodName)\r\n                                query.PeriodName = q.periodName;\r\n                        }\r\n                        return [4 /*yield*/, this.http.get(\"studentactivecourses\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.courses];\r\n                    case 5:\r\n                        ex_1 = _c.sent();\r\n                        console.error(\"Error from EDS: \" + ex_1);\r\n                        throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"], [\"Kunde tyv\\u00E4rr inte ladda terminsm\\u00E5l eller avklarade steg fr\\u00E5n EDS. F\\u00F6rs\\u00F6k igen senare...\"]))));\r\n                    case 6: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve latest assessments for current logged in user.\r\n     *\r\n     * @param limit Optional limit\r\n     */\r\n    EdsClient.prototype.getLatestAssessments = function (limit) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var query, res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        query = this.privatizingCacheBust();\r\n                        if (!isNaN(limit))\r\n                            query.Count = limit;\r\n                        return [4 /*yield*/, this.http.get(\"studentassessments\", query)];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.assessments];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Retrieve studyplans for current logged-in user\r\n     */\r\n    EdsClient.prototype.getStudentGoals = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentgoals\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentGoals];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getStudentFutureAbilities = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"studentFutureAbilities\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.studentFutureAbilities];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EdsClient.prototype.getTeacherTutorStudents = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"teachertutorstudents\", this.privatizingCacheBust())];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.students];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTuitionGroups()\r\n     *\r\n     * Return tuitiongroups for school\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param courseCode - Skolverkets code for course\r\n     */\r\n    EdsClient.prototype.getSchoolTuitionGroups = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTuitionGroups\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTuitionGroups];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getTuitionGroupStudents()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     * @param tuitionGroupName - tuition gruop name in EDS\r\n     */\r\n    EdsClient.prototype.getTuitionGroupStudents = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"TuitionGroupStudents\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.tuitionGroupStudents];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * getSchoolTeachers()\r\n     *\r\n     * Return name and mailadresses for tutitiongroups in schools\r\n     *\r\n     * @param schoolName - name of school\r\n     */\r\n    EdsClient.prototype.getSchoolTeachers = function (q) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res, _a, _b, json;\r\n            return tslib_1.__generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0: return [4 /*yield*/, this.http.get(\"SchoolTeachers\", tslib_1.__assign({}, this.privatizingCacheBust(), q))];\r\n                    case 1:\r\n                        res = _c.sent();\r\n                        if (!(res.status != 200)) return [3 /*break*/, 3];\r\n                        _a = HttpError.bind;\r\n                        _b = [void 0, res.status];\r\n                        return [4 /*yield*/, res.text()];\r\n                    case 2: throw new (_a.apply(HttpError, _b.concat([_c.sent()])))();\r\n                    case 3: return [4 /*yield*/, res.json()];\r\n                    case 4:\r\n                        json = _c.sent();\r\n                        return [2 /*return*/, json.schoolTeachers];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // we assume that the EDS will return the current academic year dates determined by the current date\r\n    EdsClient.prototype.getAcademicYearTerms = function (schoolLocale, date) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var holidays, firstTermMoment, secondTermMoment, startFirstTermDate, startSecondTermDate, endFirstTermDate, endSecondTermDate, firstTerm, secondTerm;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                // mock data\r\n                switch (schoolLocale) {\r\n                    case 'en_sin':\r\n                        return [2 /*return*/, mockJsonFile.SouthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'en_nin':\r\n                        return [2 /*return*/, mockJsonFile.NorthIndia.filter(function (f) { return moment(date).isSameOrAfter(f.firstTerm.startDate) && moment(date).isSameOrBefore(f.secondTerm.endDate); })[0]];\r\n                    case 'sv':\r\n                        {\r\n                            holidays = [];\r\n                            firstTermMoment = getTermStarEndDate(date, true);\r\n                            secondTermMoment = getTermStarEndDate(date, false);\r\n                            startFirstTermDate = firstTermMoment[0];\r\n                            startSecondTermDate = secondTermMoment[0];\r\n                            endFirstTermDate = firstTermMoment[1];\r\n                            endSecondTermDate = secondTermMoment[1];\r\n                            firstTerm = { startDate: new Date(startFirstTermDate.year(), startFirstTermDate.month(), startFirstTermDate.date()).toDateString(), endDate: new Date(startFirstTermDate.year(), endFirstTermDate.month(), endFirstTermDate.date()).toDateString() };\r\n                            secondTerm = { startDate: new Date(startSecondTermDate.year(), startSecondTermDate.month(), startSecondTermDate.date()).toDateString(), endDate: new Date(startSecondTermDate.year(), endSecondTermDate.month(), endSecondTermDate.date()).toDateString() };\r\n                            return [2 /*return*/, { firstTerm: firstTerm, secondTerm: secondTerm, holidays: holidays }];\r\n                        }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return EdsClient;\r\n}());\r\nexport { EdsClient };\r\nvar EDSPeriod = /** @class */ (function () {\r\n    function EDSPeriod(periodStringOrSchoolTerm) {\r\n        if (typeof periodStringOrSchoolTerm === 'string') {\r\n            this.period = periodStringOrSchoolTerm;\r\n            this.term = this.period.startsWith('HT') ? 'AT' : 'ST';\r\n            this.year = parseInt(this.period.substr(2));\r\n            if (isNaN(this.year))\r\n                throw new Error(\"Invalid period: \" + this.period);\r\n        }\r\n        else {\r\n            var schoolTerm = new SchoolTerm(periodStringOrSchoolTerm);\r\n            this.period = (schoolTerm.term === 'AT' ? \"HT\" : \"VT\") + schoolTerm.year;\r\n            this.term = schoolTerm.term;\r\n            this.year = schoolTerm.year;\r\n        }\r\n    }\r\n    Object.defineProperty(EDSPeriod.prototype, \"schoolTerm\", {\r\n        get: function () {\r\n            return new SchoolTerm({\r\n                academicYear: this.term === 'AT' ?\r\n                    this.year + \"/\" + (this.year + 1) :\r\n                    this.year - 1 + \"/\" + this.year,\r\n                term: this.term\r\n            });\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    EDSPeriod.prototype.toString = function () {\r\n        return this.period;\r\n    };\r\n    EDSPeriod.prototype.valueOf = function () {\r\n        return this.year + \":\" + (this.term === 'ST' ? \"1\" : \"2\");\r\n    };\r\n    return EDSPeriod;\r\n}());\r\nexport { EDSPeriod };\r\nexport function parseJsonDate_old(jsonDateStr) {\r\n    var date = dateTimeReviver(\"\", jsonDateStr);\r\n    if (!(date instanceof Date))\r\n        throw new Error(\"Invalid JSON date string: \" + jsonDateStr);\r\n    return date;\r\n}\r\nfunction avoidSimultanousCalls(method) {\r\n    var ongoingPromises = {};\r\n    return function () {\r\n        var argsJson = JSON.stringify([].slice.call(arguments));\r\n        if (!ongoingPromises[argsJson]) {\r\n            ongoingPromises[argsJson] = method.apply(this, arguments).then(function (result) {\r\n                delete ongoingPromises[argsJson];\r\n                return result;\r\n            });\r\n        }\r\n        return ongoingPromises[argsJson];\r\n    };\r\n}\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleWebClient } from './google-webclient';\r\nimport { mockTuitionStudents } from './mock/mock-classroom-data';\r\nimport { env } from '../globals/KED.env';\r\n/**\r\n*\r\n*/\r\nvar ClassroomSync = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ClassroomSync, _super);\r\n    function ClassroomSync() {\r\n        return _super.call(this, { scopes: [\r\n                'https://www.googleapis.com/auth/script.external_request'\r\n            ] }) || this;\r\n    }\r\n    /**\r\n    *\r\n    * @param func function name to call in ClassroomService\r\n    * @param params optional parameters to send to function\r\n    *\r\n    * Calls the relevant funciton in ClassroomService\r\n    * The paramaters must be what is expected in the called function\r\n    * in ClassroomService and can only be basic types: string,\r\n    * number, object or boolean.\r\n    *\r\n    */\r\n    ClassroomSync.prototype.callSync = function (func, params) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        data = params ? {\r\n                            'function': func,\r\n                            'parameters': params\r\n                        } : {\r\n                            'function': func\r\n                        };\r\n                        // using dev-mode right now so we only need to run clasp push on ClassroomService\r\n                        // to be able to use devMode the user calling the script needs to be an editor on the\r\n                        // project in GAS\r\n                        data.devMode = false;\r\n                        return [4 /*yield*/, fetch('https://script.googleapis.com/v1/scripts/M1H0BlTkv983PNVTJjDXjNqXLxmQiBgGz:run?alt=json', {\r\n                                method: 'post',\r\n                                headers: {\r\n                                    'Accept': 'application/json',\r\n                                    'Content-Type': 'application/json',\r\n                                    'Authorization': 'Bearer ' + this.authToken\r\n                                },\r\n                                body: JSON.stringify(data)\r\n                            }).then(function (resp) { return resp.json(); })];\r\n                    case 2: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n    *\r\n    * @param param0\r\n    */\r\n    ClassroomSync.prototype.initSync = function (course, origCourse, fullSyncNeeded) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var emptyOrMock, _a, _b, group, data, edsSchoolNameGymn, studyGroupStudents, _c, _d, group, tuitionGroupStudents, e_1_1, _e, subset, changes, action;\r\n            var e_2, _f, e_1, _g;\r\n            return tslib_1.__generator(this, function (_h) {\r\n                switch (_h.label) {\r\n                    case 0:\r\n                        emptyOrMock = {};\r\n                        if (course.school === 'KED') {\r\n                            try {\r\n                                for (_a = tslib_1.__values(course.studyGroups), _b = _a.next(); !_b.done; _b = _a.next()) {\r\n                                    group = _b.value;\r\n                                    emptyOrMock[group] = mockTuitionStudents[group] ? mockTuitionStudents[group].map(function (s) { return s.studentEmailAddress; }) : [];\r\n                                }\r\n                            }\r\n                            catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_b && !_b.done && (_f = _a.return)) _f.call(_a);\r\n                                }\r\n                                finally { if (e_2) throw e_2.error; }\r\n                            }\r\n                        }\r\n                        return [4 /*yield*/, env.kedBackendClient.http.get('schools', { 'cacheBust': 'static', 'name': course.school }).then(function (resp) { return resp.json(); })];\r\n                    case 1:\r\n                        data = _h.sent();\r\n                        edsSchoolNameGymn = data[0].edsSchoolNameGymn;\r\n                        studyGroupStudents = edsSchoolNameGymn ? {} : emptyOrMock;\r\n                        if (!course.studyGroups) return [3 /*break*/, 9];\r\n                        if (!edsSchoolNameGymn) return [3 /*break*/, 9];\r\n                        _h.label = 2;\r\n                    case 2:\r\n                        _h.trys.push([2, 7, 8, 9]);\r\n                        _c = tslib_1.__values(course.studyGroups), _d = _c.next();\r\n                        _h.label = 3;\r\n                    case 3:\r\n                        if (!!_d.done) return [3 /*break*/, 6];\r\n                        group = _d.value;\r\n                        return [4 /*yield*/, env.edsClient.getTuitionGroupStudents({ schoolName: edsSchoolNameGymn, tuitionGroupName: group })];\r\n                    case 4:\r\n                        tuitionGroupStudents = _h.sent();\r\n                        studyGroupStudents[group] = tuitionGroupStudents.map(function (s) { return s.studentEmailAddress; });\r\n                        _h.label = 5;\r\n                    case 5:\r\n                        _d = _c.next();\r\n                        return [3 /*break*/, 3];\r\n                    case 6: return [3 /*break*/, 9];\r\n                    case 7:\r\n                        e_1_1 = _h.sent();\r\n                        e_1 = { error: e_1_1 };\r\n                        return [3 /*break*/, 9];\r\n                    case 8:\r\n                        try {\r\n                            if (_d && !_d.done && (_g = _c.return)) _g.call(_c);\r\n                        }\r\n                        finally { if (e_1) throw e_1.error; }\r\n                        return [7 /*endfinally*/];\r\n                    case 9:\r\n                        _e = this.diffCourse(course, origCourse, fullSyncNeeded), subset = _e.subset, changes = _e.changes, action = _e.action;\r\n                        // send the changes to classroom-service with {id, school code} to update classrooms\r\n                        // should we send the users from the groups or should classroom-service get these from EDS?\r\n                        // if we handle users in kedcomponents a check if there are changes should probably be made?\r\n                        if (action == 'full') {\r\n                            return [2 /*return*/, this.createClassroom(subset, studyGroupStudents)];\r\n                        }\r\n                        else if (action == 'update') {\r\n                            return [2 /*return*/, this.updateClassroom({ course: subset, changes: changes, studyGroupStudents: studyGroupStudents })];\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ClassroomSync.prototype.archive = function (course) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                console.log('archiving');\r\n                return [2 /*return*/, this.callSync('archive', [course])];\r\n            });\r\n        });\r\n    };\r\n    ClassroomSync.prototype.delete = function (subset) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                console.log('deleteing');\r\n                return [2 /*return*/, this.callSync('deleteClassrooms', [subset])];\r\n            });\r\n        });\r\n    };\r\n    /**\r\n    *\r\n    * @param course current course state\r\n    * @param origCourse previous course state\r\n    *\r\n    * Creates a subset of course and maakes a diff against previous course state\r\n    * Note: there are probably more we could filter out before sending to ClasasroomService\r\n    */\r\n    ClassroomSync.prototype.diffCourse = function (course, origCourse, fullSyncNeeded) {\r\n        // Filter out assignments from tasks and subset to only properties we are interested in\r\n        var subsetAssignments = function (tasks, modules) {\r\n            var skipTasks = [];\r\n            modules.filter(function (m) { return m.inactive; }).map(function (m) {\r\n                skipTasks = skipTasks.concat(m.taskIds);\r\n            });\r\n            var assignments = tasks.filter(function (t) { return t.assignment === true && !skipTasks.includes(t.id); });\r\n            return assignments.map(function (t) {\r\n                var assignment = t.assignment, deadline = t.deadline, id = t.id, name = t.name, resources = t.resources, templateFile = t.templateFile;\r\n                return { assignment: assignment, deadline: deadline, id: id, name: name, resources: resources, templateFile: templateFile };\r\n            });\r\n        };\r\n        // create the subset of course\r\n        var subset = (function (_a) {\r\n            var id = _a.id, school = _a.school, code = _a.code, name = _a.name, description = _a.description, tasks = _a.tasks, responsibleTeachers = _a.responsibleTeachers, studyGroups = _a.studyGroups;\r\n            return ({\r\n                id: id,\r\n                school: school,\r\n                code: code,\r\n                name: name,\r\n                description: description,\r\n                tasks: tasks,\r\n                responsibleTeachers: responsibleTeachers,\r\n                studyGroups: studyGroups\r\n            });\r\n        })(course);\r\n        // only handle tsaks that are aassignments\r\n        subset.tasks = subsetAssignments(subset.tasks, course.modules);\r\n        var changes = origCourse ? {\r\n            tasks: subsetAssignments(origCourse.tasks, origCourse.modules),\r\n            responsibleTeachers: origCourse.responsibleTeachers,\r\n            studyGroups: origCourse.studyGroups\r\n        } : false;\r\n        return { subset: subset, changes: changes, action: \"update\" };\r\n    };\r\n    ClassroomSync.prototype.createClassroom = function (course, studyGroupStudents) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/, this.callSync('createClassrooms', [course, studyGroupStudents])];\r\n            });\r\n        });\r\n    };\r\n    ClassroomSync.prototype.updateClassroom = function (_a) {\r\n        var course = _a.course, changes = _a.changes, studyGroupStudents = _a.studyGroupStudents;\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_b) {\r\n                return [2 /*return*/, this.callSync('updateClassrooms', [course, changes, studyGroupStudents])];\r\n            });\r\n        });\r\n    };\r\n    return ClassroomSync;\r\n}(GoogleWebClient));\r\nexport { ClassroomSync };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { env } from '../globals/KED.env';\r\nvar GoogleClient = /** @class */ (function () {\r\n    function GoogleClient(_a) {\r\n        var discoveryDocs = _a.discoveryDocs;\r\n        this.googleTokenProvider = env.googleTokenProvider;\r\n        this.discoveryDocs = [];\r\n        this.discoveryDocs.push(discoveryDocs);\r\n    }\r\n    GoogleClient.prototype.setBearerProvider = function (googleTokenProvider) {\r\n        this.googleTokenProvider = googleTokenProvider;\r\n    };\r\n    GoogleClient.prototype.ensureInited = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var tokenResult;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(typeof gapi === 'undefined')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadGapi()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (!(!this.tokenExpiration || this.tokenExpiration < new Date())) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.googleTokenProvider.getBearer()];\r\n                    case 3:\r\n                        tokenResult = _a.sent();\r\n                        this.tokenExpiration = new Date(tokenResult.expires);\r\n                        this.token = tokenResult.token;\r\n                        _a.label = 4;\r\n                    case 4: \r\n                    // Load all discovyerDocs\r\n                    return [4 /*yield*/, gapi.client.init({\r\n                            discoveryDocs: this.discoveryDocs\r\n                        })];\r\n                    case 5:\r\n                        // Load all discovyerDocs\r\n                        _a.sent();\r\n                        return [4 /*yield*/, gapi.client.setToken({\r\n                                access_token: this.token\r\n                            })];\r\n                    case 6:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleClient.prototype.loadGapi = function () {\r\n        return new Promise(function (resolve) {\r\n            if (typeof gapi !== 'undefined')\r\n                return resolve();\r\n            var script = document.createElement('script');\r\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\r\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n            window.gaapi_loaded = resolve;\r\n        });\r\n    };\r\n    return GoogleClient;\r\n}());\r\nexport { GoogleClient };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleClient } from './google-client';\r\nvar GoogleDrive = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoogleDrive, _super);\r\n    function GoogleDrive() {\r\n        return _super.call(this, { discoveryDocs: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest' }) || this;\r\n    }\r\n    GoogleDrive.prototype.getFile = function (fileId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.get({\r\n                                fileId: fileId,\r\n                                supportsAllDrives: true,\r\n                                fields: 'id,name,mimeType,webViewLink,iconLink,modifiedTime,thumbnailLink'\r\n                            }).then(function (resp) {\r\n                                if (resp.result.name) {\r\n                                    var file = resp.result;\r\n                                    return { fileId: file.id, url: file.webViewLink, mimeType: file.mimeType, name: file.name, modiifiedTime: file.modifiedTime, iconUrl: file.iconLink, thumbnailUrl: file.thumbnailLink };\r\n                                }\r\n                                return null;\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * updatePermissions()\r\n     *\r\n     * @param fileId\r\n     *\r\n     * Make the file accessible to all in the domain. Should be unnecessary but some\r\n     * teachers have changed their default permissions.\r\n     * We don't care right now if this fails because this is just an extra precaution.\r\n     * If we plan on using this on other domains the domain-attribute needs to be dynamic.\r\n     *\r\n     */\r\n    GoogleDrive.prototype.updatePermissions = function (fileId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var error_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 2, , 3]);\r\n                        console.log('updating permissions');\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        gapi.client.drive.permissions.create({\r\n                            fileId: fileId,\r\n                            sendNotificationEmail: false,\r\n                            role: 'reader',\r\n                            type: 'anyone',\r\n                            // type: 'domain', \r\n                            // domain: 'kunskapsskolan.se'\r\n                            supportsAllDrives: true\r\n                        }).then(function (resp) { return console.log(resp); });\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        error_1 = _a.sent();\r\n                        console.log('unable to update permissions');\r\n                        return [3 /*break*/, 3];\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Creates a folder with given name in a parent folder\r\n     * @param name folder name\r\n     * @param parent parent folders id\r\n     */\r\n    GoogleDrive.prototype.createFolder = function (name, parent) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Creating folder ' + name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.create({\r\n                                name: name,\r\n                                mimeType: 'application/vnd.google-apps.folder',\r\n                                parents: [parent]\r\n                            }).then(function (resp) { return resp.result; })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Gets the id for the folder in a path. If folder/path does not exists\r\n     * a new folder at that path is created.\r\n     * @param path the path to the file from root folder as an array\r\n     */\r\n    GoogleDrive.prototype.getIdForFolderPath = function (path) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var parent, path_1, path_1_1, folder, folderId, newFolder, e_1_1;\r\n            var e_1, _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        console.log('Getting id for ' + path.join('/'));\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        parent = 'root';\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        _b.trys.push([2, 9, 10, 11]);\r\n                        path_1 = tslib_1.__values(path), path_1_1 = path_1.next();\r\n                        _b.label = 3;\r\n                    case 3:\r\n                        if (!!path_1_1.done) return [3 /*break*/, 8];\r\n                        folder = path_1_1.value;\r\n                        return [4 /*yield*/, this.getIdForFolder(folder, parent)];\r\n                    case 4:\r\n                        folderId = _b.sent();\r\n                        if (!folderId) return [3 /*break*/, 5];\r\n                        parent = folderId;\r\n                        return [3 /*break*/, 7];\r\n                    case 5: return [4 /*yield*/, this.createFolder(folder, parent)];\r\n                    case 6:\r\n                        newFolder = _b.sent();\r\n                        parent = newFolder.id;\r\n                        _b.label = 7;\r\n                    case 7:\r\n                        path_1_1 = path_1.next();\r\n                        return [3 /*break*/, 3];\r\n                    case 8: return [3 /*break*/, 11];\r\n                    case 9:\r\n                        e_1_1 = _b.sent();\r\n                        e_1 = { error: e_1_1 };\r\n                        return [3 /*break*/, 11];\r\n                    case 10:\r\n                        try {\r\n                            if (path_1_1 && !path_1_1.done && (_a = path_1.return)) _a.call(path_1);\r\n                        }\r\n                        finally { if (e_1) throw e_1.error; }\r\n                        return [7 /*endfinally*/];\r\n                    case 11: return [2 /*return*/, parent];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Gets the id for a folder in a given parent folder\r\n     * @param name name of folder\r\n     * @param parent parent folders id\r\n     */\r\n    GoogleDrive.prototype.getIdForFolder = function (name, parent) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Getting id for ' + name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, gapi.client.drive.files.list({\r\n                                corpora: 'user',\r\n                                q: \"'\" + parent + \"' in parents and mimeType = 'application/vnd.google-apps.folder' and name = '\" + name + \"'\"\r\n                            }).then(function (resp) {\r\n                                if (resp.result.files.length) {\r\n                                    return resp.result.files[0].id;\r\n                                }\r\n                                else {\r\n                                    return false;\r\n                                }\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Copies a file to a destination\r\n     * @param file\r\n     * @param destination the destination as an array of folder names\r\n     */\r\n    GoogleDrive.prototype.copyFile = function (file, destination) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var parent_1, parent_2;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        console.log('Copying file: ' + file.name);\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        if (!destination) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.getIdForFolderPath(destination)];\r\n                    case 2:\r\n                        parent_1 = _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        parent_2 = 'root';\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/, gapi.client.drive.files.copy({\r\n                            fileId: file.id,\r\n                            supportsAllDrives: true,\r\n                            parents: [parent],\r\n                            name: file.name,\r\n                            fields: 'id,name,mimeType,webViewLink,iconLink,modifiedTime,thumbnailLink'\r\n                        }).then(function (resp) { return resp.result; })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.handInFile = function (fileId, student, newOwner, teachers) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var batch;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        // This should:\r\n                        // - add teachers to editors of file\r\n                        // - makes newOwner the owner of the file\r\n                        // - makes the caller a reader of the file\r\n                        // Now it makes teachers editors\r\n                        console.log('handing in file');\r\n                        return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        batch = gapi.client.newBatch();\r\n                        return [4 /*yield*/, teachers.forEach(function (teacher) {\r\n                                batch.add(gapi.client.drive.permissions.create({\r\n                                    fileId: fileId,\r\n                                    sendNotificationEmail: false,\r\n                                    role: 'writer',\r\n                                    type: 'user',\r\n                                    emailAddress: teacher\r\n                                }));\r\n                            })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        batch.then(function (resp) { return console.log(resp); });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.reclaimFile = function (file, student, teachers) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.returnFile = function (file, student) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    GoogleDrive.prototype.updateUrkundProperties = function (file) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * downloadFile()\r\n     * @param file\r\n     *\r\n     * When Classroom has been integrated we will want to handle only the fileId:s\r\n     * so that editing capabilities are peserved on the file (if it is a google-apps file)\r\n     * Right now google-apps files are converted to pdf and passed into the current flow.\r\n     *\r\n     * TODO: error handling\r\n     */\r\n    GoogleDrive.prototype.downloadFile = function (_a) {\r\n        var file = _a.file, limitSize = _a.limitSize, mimeType = _a.mimeType;\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var type, xhrDownload_1;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: \r\n                    // A file that can be exported to PDF is retreived with\r\n                    // file.export() from Drive, converted to a blob and then\r\n                    // to a File.\r\n                    // A file that can not be exported to PDF is retrieved\r\n                    // through XHR and converted to a File.\r\n                    // If we don't need to handle the physical files on the client\r\n                    // we could save only the fileId:s and display filename and mimeType\r\n                    // for the file in our listings. When/if we use Google Classroom for\r\n                    // our task-handling that would be the preferred approach to keep\r\n                    // the file as an editable Google file\r\n                    // Init the drive-api (only needed for download so not loaded initially)\r\n                    return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        // A file that can be exported to PDF is retreived with\r\n                        // file.export() from Drive, converted to a blob and then\r\n                        // to a File.\r\n                        // A file that can not be exported to PDF is retrieved\r\n                        // through XHR and converted to a File.\r\n                        // If we don't need to handle the physical files on the client\r\n                        // we could save only the fileId:s and display filename and mimeType\r\n                        // for the file in our listings. When/if we use Google Classroom for\r\n                        // our task-handling that would be the preferred approach to keep\r\n                        // the file as an editable Google file\r\n                        // Init the drive-api (only needed for download so not loaded initially)\r\n                        _b.sent();\r\n                        type = mimeType ? mimeType : 'application/pdf';\r\n                        if (file.canExport) {\r\n                            return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                    gapi.client.drive.files.export({\r\n                                        fileId: file.fileId,\r\n                                        mimeType: type\r\n                                    }).then(function (resp) {\r\n                                        var len = resp.body.length;\r\n                                        var data = new Uint8Array(new ArrayBuffer(len));\r\n                                        for (var i = 0; i < len; i++) {\r\n                                            data[i] = resp.body.charCodeAt(i);\r\n                                        }\r\n                                        var blob = new Blob([data], { type: type });\r\n                                        var filename = file.name + '.pdf';\r\n                                        resolve(new File([blob], filename, { type: type, lastModified: file.modifiedTime }));\r\n                                    });\r\n                                })];\r\n                        }\r\n                        else {\r\n                            xhrDownload_1 = function (file) {\r\n                                return new Promise(function (resolve, reject) {\r\n                                    var xhr = new XMLHttpRequest();\r\n                                    xhr.open(\"GET\", \"https://www.googleapis.com/drive/v3/files/\" + file.fileId + '?alt=media', true);\r\n                                    xhr.setRequestHeader('Authorization', 'Bearer ' + _this.token);\r\n                                    xhr.responseType = 'blob';\r\n                                    xhr.onload = function () {\r\n                                        resolve(new File([xhr.response], file.name, { type: file.mimeType, lastModified: file.modifiedTime }));\r\n                                    };\r\n                                    xhr.send();\r\n                                });\r\n                            };\r\n                            return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                    if (limitSize !== undefined) {\r\n                                        gapi.client.drive.files.get({\r\n                                            fileId: file.fileId,\r\n                                            fields: 'size'\r\n                                        }).then(function (resp) {\r\n                                            var size = Number(resp.result.size);\r\n                                            if (size > limitSize * 1024 * 1024) {\r\n                                                reject('GooglePickerError: Fildsize is too laarge');\r\n                                            }\r\n                                        }).then(function () {\r\n                                            xhrDownload_1(file).then(function (resp) {\r\n                                                resolve(resp);\r\n                                            });\r\n                                        });\r\n                                    }\r\n                                    else {\r\n                                        xhrDownload_1(file).then(function (resp) {\r\n                                            resolve(resp);\r\n                                        });\r\n                                    }\r\n                                })];\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return GoogleDrive;\r\n}(GoogleClient));\r\nexport { GoogleDrive };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { GoogleWebClient } from './google-webclient';\r\nimport { GoogleDrive } from './google-drive';\r\nvar mimeTypeCollections = {\r\n    'google-apps': 'application/vnd.google-apps.document,application/vnd.google-apps.presentation,application/vnd.google-apps.spreadsheet',\r\n    'pdf': 'application/pdf'\r\n};\r\n/**\r\n * GooglePicker\r\n * Includes the initiation of the correct api:s.\r\n * Certain options can be passed to the constructor\r\n * and there could be others worth incorporating (i.e. Team Drive-support).\r\n *\r\n * Right now two options are handled:\r\n * - upload: if a user can upload to Drive in the Google Drive Picker\r\n * - multiple: if a user can select multiple files\r\n * - limitType: active limits to certain mimeTypesCollections\r\n * - mineOnly: if only show files owned by the user\r\n *\r\n * We could probably split this into google-picker and google-drive where google-drive\r\n * handles the explicit calls to the google drive api.\r\n */\r\nvar GooglePicker = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GooglePicker, _super);\r\n    function GooglePicker(options) {\r\n        var _this = _super.call(this, { scopes: ['https://www.googleapis.com/auth/drive'] }) || this;\r\n        _this.options = { upload: false, multiple: false, limitType: false, onlyMine: false };\r\n        Object.assign(_this.options, options);\r\n        _this.drive = new GoogleDrive();\r\n        return _this;\r\n    }\r\n    /**\r\n     * show()\r\n     *\r\n     * If a single file is requested from the picker a list of files with one element is returned.\r\n     * It is up to the caller to handle the list in a relevant manner.\r\n     *\r\n     * More data from the file could be extracted if it is deemed necessary.\r\n     *\r\n     */\r\n    GooglePicker.prototype.show = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureInited()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/, new Promise(function (resolve, reject) {\r\n                                var callback = function (response) {\r\n                                    if (response['action'] == google.picker.Action.CANCEL) {\r\n                                        reject();\r\n                                    }\r\n                                    else if (response['action'] == google.picker.Action.PICKED) {\r\n                                        var selected_1 = [];\r\n                                        response.docs.map(function (doc) {\r\n                                            var fileId = doc.id, mimeType = doc.mimeType, name = doc.name, modifiedTime = doc.modifiedTime, iconUrl = doc.iconUrl, url = doc.url;\r\n                                            var canExport = mimeType.includes('google-apps');\r\n                                            selected_1.push({ fileId: fileId, mimeType: mimeType, name: name, modifiedTime: modifiedTime, canExport: canExport, iconUrl: iconUrl, url: url });\r\n                                            // update permissions to read by all in domain\r\n                                            _this.drive.updatePermissions(fileId);\r\n                                        });\r\n                                        resolve(selected_1);\r\n                                    }\r\n                                };\r\n                                var pickerbuilder = new google.picker.PickerBuilder()\r\n                                    .enableFeature(google.picker.Feature.SUPPORT_DRIVES)\r\n                                    .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)\r\n                                    .addView(new google.picker.DocsView()\r\n                                    .setOwnedByMe(true) // should this be an option?\r\n                                    .setIncludeFolders(true))\r\n                                    .addView(new google.picker.DocsView()\r\n                                    .setIncludeFolders(true)\r\n                                    .setEnableTeamDrives(true))\r\n                                    .setLocale(\"sv\") // should this be an option?\r\n                                    .setSize(1051, 650) // should this be an option?\r\n                                    .setOAuthToken(_this.authToken)\r\n                                    .setCallback(callback);\r\n                                if (_this.options.upload) {\r\n                                    pickerbuilder.addView(new google.picker.DocsUploadView().setIncludeFolders(true));\r\n                                }\r\n                                if (_this.options.multiple) {\r\n                                    pickerbuilder.enableFeature(google.picker.Feature.MULTISELECT_ENABLED);\r\n                                }\r\n                                if (_this.options.onlyMine) {\r\n                                    pickerbuilder.enableFeature(google.picker.Feature.MINE_ONLY);\r\n                                }\r\n                                if (_this.options.limitType) {\r\n                                    var mimeTypes = mimeTypeCollections[_this.options.limitType];\r\n                                    console.log(mimeTypes);\r\n                                    pickerbuilder.setSelectableMimeTypes(mimeTypes);\r\n                                }\r\n                                _this.picker = pickerbuilder.build();\r\n                                _this.picker.setVisible(true);\r\n                            })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GooglePicker.prototype.close = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                this.picker.dispose();\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    return GooglePicker;\r\n}(GoogleWebClient));\r\nexport { GooglePicker };\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../globals/KED.env';\r\nimport { WebClientId } from './configs';\r\nvar GoogleWebClient = /** @class */ (function () {\r\n    function GoogleWebClient(_a) {\r\n        var _b;\r\n        var _c = _a.scopes, scopes = _c === void 0 ? [] : _c;\r\n        this.scopes = ['https://www.googleapis.com/auth/userinfo.email', 'https://www.googleapis.com/auth/userinfo.profile'];\r\n        (_b = this.scopes).push.apply(_b, tslib_1.__spread(scopes));\r\n    }\r\n    GoogleWebClient.prototype.ensureInited = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var SCOPES;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(typeof gapi === \"undefined\")) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadGapi()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        SCOPES = this.scopes.join(' ');\r\n                        return [4 /*yield*/, new Promise(function (resolve, reject) {\r\n                                gapi.load(\"client:auth2\", function () {\r\n                                    // Calls authorize without prompting the user. If authorization hasn't been given by\r\n                                    // the user an error is returned and we call authorize again with consent-screen\r\n                                    var reauthorize = false;\r\n                                    return gapi.auth2.authorize({\r\n                                        client_id: WebClientId,\r\n                                        scope: SCOPES,\r\n                                        response_type: 'permission',\r\n                                        login_hint: env.currentUser.mail,\r\n                                        prompt: 'none'\r\n                                    }, function (resp) {\r\n                                        console.table(resp);\r\n                                        if (resp.error) {\r\n                                            // no consent given so reauthorize\r\n                                            reauthorize = true;\r\n                                        }\r\n                                        else {\r\n                                            // check if we have all the scopes we want\r\n                                            var scopeset_1 = new Set(resp.scope.split(' '));\r\n                                            var missingScopes = _this.scopes.filter(function (x) { return !scopeset_1.has(x); });\r\n                                            if (missingScopes.length > 0) {\r\n                                                console.log('missing scopes');\r\n                                                // scopes are missing from our consent so reauthorize\r\n                                                reauthorize = true;\r\n                                            }\r\n                                            else {\r\n                                                // everything seems to be ok so store our token\r\n                                                _this.authToken = resp.access_token;\r\n                                                resolve();\r\n                                            }\r\n                                        }\r\n                                        if (reauthorize) {\r\n                                            console.log('reauthorize');\r\n                                            return gapi.auth2.authorize({\r\n                                                client_id: WebClientId,\r\n                                                scope: SCOPES,\r\n                                                response_type: 'permission',\r\n                                                login_hint: env.currentUser.mail,\r\n                                                prompt: 'consent'\r\n                                            }, function (resp) {\r\n                                                console.table(resp);\r\n                                                if (resp.error) {\r\n                                                    // something is still wrong so throw an error\r\n                                                    reject('Google Web Client: No access token');\r\n                                                }\r\n                                                else {\r\n                                                    // we now have a token (hopefully with the right scopes)\r\n                                                    // should we check again?\r\n                                                    _this.authToken = resp.access_token;\r\n                                                    resolve();\r\n                                                }\r\n                                            });\r\n                                        }\r\n                                        if (resp.expires_in < 500) {\r\n                                            return gapi.auth2.authorize({\r\n                                                client_id: WebClientId,\r\n                                                scope: SCOPES,\r\n                                                response_type: 'permission',\r\n                                                login_hint: env.currentUser.mail,\r\n                                                prompt: 'none'\r\n                                            }, function (resp) {\r\n                                                _this.authToken = resp.access_token;\r\n                                                resolve();\r\n                                            });\r\n                                        }\r\n                                    });\r\n                                });\r\n                            })];\r\n                    case 3:\r\n                        _a.sent();\r\n                        if (!(typeof google === \"undefined\" || typeof google.picker === \"undefined\")) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, new Promise(function (resolve) {\r\n                                gapi.load(\"picker\", function () { resolve(); });\r\n                            })];\r\n                    case 4:\r\n                        _a.sent();\r\n                        _a.label = 5;\r\n                    case 5:\r\n                        if (!(typeof gapi.client === \"undefined\" || typeof gapi.client.classroom === \"undefined\")) return [3 /*break*/, 7];\r\n                        return [4 /*yield*/, new Promise(function (resolve) {\r\n                                gapi.client.load(\"classroom\", 'v1', function () { resolve(); });\r\n                            })];\r\n                    case 6:\r\n                        _a.sent();\r\n                        _a.label = 7;\r\n                    case 7: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GoogleWebClient.prototype.loadGapi = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            if (typeof gapi !== \"undefined\")\r\n                return resolve();\r\n            var script = document.createElement(\"script\");\r\n            script.src = \"https://apis.google.com/js/client.js?onload=gaapi_loaded\";\r\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n            window.gaapi_loaded = resolve;\r\n        });\r\n    };\r\n    return GoogleWebClient;\r\n}());\r\nexport { GoogleWebClient };\r\n","import * as tslib_1 from \"tslib\";\r\nvar createStudents = function (group, n, m) {\r\n    var students = [];\r\n    for (var i = n; i <= m; i++) {\r\n        students.push({\r\n            schoolName: 'KED',\r\n            tuitionGroupName: group,\r\n            studentFirstName: 'Student ' + i,\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student' + i + '.classroom@kedschools.com'\r\n        });\r\n    }\r\n    return students;\r\n};\r\nexport var mockTeachers = [\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 1',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher1.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 2',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher2.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Teacher 3',\r\n        teacherLastName: 'Classroom',\r\n        teacherEmailAddress: 'teacher3.classroom@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Carl',\r\n        teacherLastName: 'Holmberg',\r\n        teacherEmailAddress: 'carl@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'David',\r\n        teacherLastName: 'Fahlander',\r\n        teacherEmailAddress: 'david.fahlander@kedschools.com'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Andrei',\r\n        teacherLastName: 'Spatarelu',\r\n        teacherEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n    },\r\n    {\r\n        schoolName: 'KED',\r\n        teacherFirstName: 'Andrei',\r\n        teacherLastName: 'Spatarelu',\r\n        teacherEmailAddress: 'andrei@kedschools.com'\r\n    }\r\n];\r\nexport var mockTuitionGroups = {\r\n    'DJUSÄL01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR1 (180816-190614)',\r\n            courseCode: 'DJUSÄL01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR2 (180816-190614)',\r\n            courseCode: 'DJUSÄL01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            courseCode: 'DJUSÄL01'\r\n        }\r\n    ],\r\n    'DJUDJI0': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            courseCode: 'DJUDJI0'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            courseCode: 'DJUDJI0'\r\n        },\r\n    ],\r\n    'KEMKEM01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            courseCode: 'KEMKEM01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            courseCode: 'KEMKEM01'\r\n        }\r\n    ],\r\n    \"MATMAT03b\": [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr1 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr2 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr3 (180816-190614)',\r\n            courseCode: 'MATMAT03b'\r\n        }\r\n    ],\r\n    'BIOBIO01': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            courseCode: 'BIOBIO01'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            courseCode: 'BIOBIO01'\r\n        }\r\n    ],\r\n    'SVESVE03': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr1 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr2 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr3 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr4 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr5 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr6 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'SVE3_Gr7 (180816-190614)',\r\n            courseCode: 'SVESVE03'\r\n        }\r\n    ]\r\n};\r\nexport var mockTuitionStudents = {\r\n    'DJUR1_GR1 (180816-190614)': createStudents('DJUR1_GR1 (180816-190614)', 1, 12),\r\n    'DJUR1_GR2 (180816-190614)': createStudents('DJUR1_GR2 (180816-190614)', 13, 24),\r\n    'DJUR1_GR3 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Student2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUR1_GR3 (180816-190614)',\r\n            studentFirstName: 'Student3',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student3.classroom@kedschools.com'\r\n        }\r\n    ], createStudents('DJUR1_GR3 (180816-190614)', 23, 34)),\r\n    'DJUDJ_Gr1 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr1 (180816-190614)',\r\n            studentFirstName: 'David',\r\n            studentLastName: 'Fahlander',\r\n            studentEmailAddress: 'david.fahlander@kedschools.com'\r\n        }\r\n    ], createStudents('DJUDJ_Gr1 (180816-190614)', 151, 160)),\r\n    'DJUDJ_Gr2 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'Carl',\r\n            studentLastName: 'Holmberg',\r\n            studentEmailAddress: 'carl@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei.spatarelu@vemendo.se'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'DJUDJ_Gr2 (180816-190614)',\r\n            studentFirstName: 'David',\r\n            studentLastName: 'Fahlander',\r\n            studentEmailAddress: 'david.fahlander@kedschools.com'\r\n        }\r\n    ], createStudents('DJUDJ_Gr2 (180816-190614)', 161, 165)),\r\n    'MAT3b_Gr1 (180816-190614)': createStudents('MAT3b_Gr1 (180816-190614)', 3, 23),\r\n    'MAT3b_Gr3 (180816-190614)': createStudents('MAT3b_Gr3 (180816-190614)', 24, 49),\r\n    'MAT3b_Gr2 (180816-190614)': tslib_1.__spread([\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'MAT3b_Gr2 (180816-190614)',\r\n            studentFirstName: 'Andrei',\r\n            studentLastName: 'Spatarelu',\r\n            studentEmailAddress: 'andrei@kedschools.com'\r\n        }\r\n    ], createStudents('MAT3b_Gr2 (180816-190614)', 50, 72)),\r\n    'IDR1_Gr1 (180816-190614)': createStudents('IDR1_Gr1 (180816-190614)', 1, 12),\r\n    'IDR1_Gr2 (180816-190614)': createStudents('IDR1_Gr2 (180816-190614)', 13, 22),\r\n    'IDR1_Gr3 (180816-190614)': createStudents('IDR1_Gr3 (180816-190614)', 23, 34),\r\n    'KEM1_Gr1 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 3',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student3.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 8',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student8.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 9',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student9.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'KEM1_Gr2 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 1',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student1.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 5',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student5.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'KEM1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 6',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student6.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'BIO1_Gr1 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 1',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student1.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 4',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student4.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 6',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student6.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr1 (180816-190614)',\r\n            studentFirstName: 'Student 10',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student10.classroom@kedschools.com'\r\n        }\r\n    ],\r\n    'BIO1_Gr2 (180816-190614)': [\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 2',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student2.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 7',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student7.classroom@kedschools.com'\r\n        },\r\n        {\r\n            schoolName: 'KED',\r\n            tuitionGroupName: 'BIO1_Gr2 (180816-190614)',\r\n            studentFirstName: 'Student 8',\r\n            studentLastName: 'Classroom',\r\n            studentEmailAddress: 'student8.classroom@kedschools.com'\r\n        },\r\n    ],\r\n    'SVE3_Gr1 (180816-190614)': createStudents('SVE3_Gr1 (180816-190614)', 1, 21),\r\n    'SVE3_Gr2 (180816-190614)': createStudents('SVE3_Gr2 (180816-190614)', 22, 44),\r\n    'SVE3_Gr3 (180816-190614)': createStudents('SVE3_Gr3 (180816-190614)', 45, 61),\r\n    'SVE3_Gr4 (180816-190614)': createStudents('SVE3_Gr4 (180816-190614)', 62, 78),\r\n    'SVE3_Gr5 (180816-190614)': createStudents('SVE3_Gr5 (180816-190614)', 83, 107),\r\n    'SVE3_Gr6 (180816-190614)': createStudents('SVE3_Gr6 (180816-190614)', 108, 124),\r\n    'SVE3_Gr7 (180816-190614)': createStudents('SVE3_Gr7 (180816-190614)', 125, 150)\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar GoalProgress = /** @class */ (function (_super) {\r\n    tslib_1.__extends(GoalProgress, _super);\r\n    function GoalProgress() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.createProgress = function () {\r\n            var _a = _this.props, numberOfTasks = _a.numberOfTasks, completedNumberOfTasks = _a.completedNumberOfTasks, maximumTasksDisplayed = _a.maximumTasksDisplayed, backgroundColor = _a.backgroundColor, progressColor = _a.progressColor;\r\n            var progress = [];\r\n            if (numberOfTasks > maximumTasksDisplayed) {\r\n                return React.createElement(\"div\", { className: \"progress-overview\" },\r\n                    \" \",\r\n                    completedNumberOfTasks,\r\n                    \" / \",\r\n                    numberOfTasks,\r\n                    \" \");\r\n            }\r\n            for (var taskNo = 1; taskNo <= numberOfTasks; taskNo++) {\r\n                progress.push(React.createElement(\"svg\", { key: taskNo },\r\n                    React.createElement(\"circle\", { className: \"circle-chart-background\", fill: taskNo > completedNumberOfTasks ? backgroundColor : progressColor, cx: \"8\", cy: \"8\", r: \"8\" })));\r\n            }\r\n            return progress;\r\n        };\r\n        return _this;\r\n    }\r\n    GoalProgress.prototype.render = function () {\r\n        return React.createElement(\"div\", { className: \"goals-progress\" }, this.createProgress());\r\n    };\r\n    GoalProgress.defaultProps = {\r\n        numberofTasks: 0,\r\n        completedNumberOfTasks: 0,\r\n        maximumTasksDisplayed: 10,\r\n        backgroundColor: \"lightgrey\",\r\n        progressColor: \"#3dbca2\",\r\n    };\r\n    return GoalProgress;\r\n}(React.Component));\r\nexport { GoalProgress };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Emitter } from 'kedbackend/observable';\r\nimport { db } from '../../../globals/db';\r\nimport { flatten } from '../../../utils/utils';\r\nexport function getOrderedDocs(docs, order, _a) {\r\n    var appendLeftovers = (_a === void 0 ? { appendLeftovers: false } : _a).appendLeftovers;\r\n    // Mark doc IDs that where present in given 'order' array.\r\n    // Will be used to find left-overs that were not present in the 'order' array.\r\n    var markedDocs = {};\r\n    if (!docs || !order) {\r\n        // Special case: no docs or no order. Don't fail. Just return docs as is.\r\n        return docs;\r\n    }\r\n    // Map given 'order' array to corresponding docs. Also mark in markedDocs.\r\n    var result = (docs && order ?\r\n        order.map(function (id) {\r\n            markedDocs[id] = true;\r\n            return docs.find(function (doc) { return doc.id === id; });\r\n        }).filter(function (doc) { return !!doc; }) :\r\n        docs);\r\n    if (appendLeftovers) {\r\n        // If any leftovers are there, concat them at the end:\r\n        var leftOvers = docs.filter(function (doc) { return !markedDocs[doc.id]; });\r\n        return result.concat(leftOvers);\r\n    }\r\n    else {\r\n        return result;\r\n    }\r\n}\r\nexport function resolveRequirementOrder(obj, orderDefiner) {\r\n    var _a;\r\n    var orderDefiningDocObservable;\r\n    if (orderDefiner) {\r\n        // User provided the orderDefining doc (use case is when obj is a Course or Subject, which contains its order by itself. User then provides the Course or Subject in both args)\r\n        orderDefiningDocObservable = new Emitter([orderDefiner]);\r\n    }\r\n    else {\r\n        var courseCodes = obj.tags.filter(function (tag) { return tag.startsWith(\"course:\"); });\r\n        if (courseCodes.length === 0) {\r\n            return new Emitter(obj); // No course tags. Not possible to resolve order.\r\n        }\r\n        orderDefiningDocObservable = (_a = db.courses).tags.apply(_a, tslib_1.__spread(courseCodes)).toValue();\r\n    }\r\n    return orderDefiningDocObservable.map(function (orderHolders) {\r\n        var abilitiesOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.abilitiesOrder || []; }));\r\n        var ccOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.centralContentOrder || []; }));\r\n        var krOrder = flatten(orderHolders.map(function (orderHolder) { return orderHolder.knowledgeRequirementsOrder || []; }));\r\n        var objClone = Object.assign({}, obj);\r\n        if (objClone.abilities)\r\n            objClone.abilities = getOrderedDocs(obj.abilities, abilitiesOrder);\r\n        if (objClone.centralContent)\r\n            objClone.centralContent = getOrderedDocs(obj.centralContent, ccOrder);\r\n        if (objClone.knowledgeRequirements)\r\n            objClone.knowledgeRequirements = getOrderedDocs(obj.knowledgeRequirements, krOrder);\r\n        return objClone;\r\n    });\r\n}\r\n","import { flatten } from '../../../utils/utils';\r\nimport { getOrderedDocs } from './ordered-requirements';\r\nexport function getSortedTasks(content) {\r\n    return getOrderedDocs(content.tasks, content.taskOrder, { appendLeftovers: true });\r\n}\r\nexport function computeUpdatedOrder(docs, currentOrder, source, target, placement, _a) {\r\n    var appendLeftovers = (_a === void 0 ? { appendLeftovers: false } : _a).appendLeftovers;\r\n    var orderedIds = getOrderedDocs(docs, currentOrder, { appendLeftovers: true }).map(function (t) { return t.id; });\r\n    var placeBefore = placement === 'before';\r\n    var result = flatten(orderedIds\r\n        .filter(function (id) { return id !== source.id; }) // Remove source id\r\n        .map(function (id) { return id !== target.id ?\r\n        // We're not on target\r\n        id :\r\n        // We're on target. Place before or after?\r\n        placeBefore ?\r\n            [source.id, id] :\r\n            [id, source.id]; }));\r\n    return result;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten, L } from \"../../../utils/utils\";\r\nimport { getEmailFromDocAccess } from '../utils';\r\nexport function getUncoveredKnowledgeRequirements(course) {\r\n    var uncoveredRequirements = course.knowledgeRequirements.reduce(function (result, item) {\r\n        result[item.id] = item;\r\n        return result;\r\n    }, {});\r\n    course.tasks.forEach(function (task) {\r\n        task.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredRequirements[kr.id];\r\n        });\r\n    });\r\n    return Object.keys(uncoveredRequirements).map(function (id) { return uncoveredRequirements[id]; });\r\n}\r\nexport function getIdsNotCoveredByTasks(course) {\r\n    return getIdsNotCoveredByReqReferencingDocs([course], course.tasks);\r\n}\r\nexport function getIdsNotCoveredByReqReferencingDocs(templates, docsBeingChecked) {\r\n    var uncoveredIds = {};\r\n    // 1. Mark the ids of all knowledge requirements, abilities and central content for this course:\r\n    templates.forEach(function (course) {\r\n        course.knowledgeRequirements.forEach(function (r) {\r\n            uncoveredIds[r.id] = true;\r\n        });\r\n        course.abilities.forEach(function (a) {\r\n            uncoveredIds[a.id] = true;\r\n        });\r\n        course.centralContent.forEach(function (cc) {\r\n            uncoveredIds[cc.id] = true;\r\n        });\r\n    });\r\n    // 2. List all tasks and unmark all ids that they refer to\r\n    docsBeingChecked.forEach(function (doc) {\r\n        doc.knowledgeRequirements.forEach(function (kr) {\r\n            delete uncoveredIds[kr.id];\r\n        });\r\n        doc.abilities.forEach(function (a) {\r\n            delete uncoveredIds[a.id];\r\n        });\r\n        doc.centralContent.forEach(function (cc) {\r\n            delete uncoveredIds[cc.id];\r\n        });\r\n    });\r\n    return uncoveredIds;\r\n}\r\nexport function sanityCheck(course) {\r\n    function hasDuplicateTasks(course) {\r\n        var taskIds = {};\r\n        return flatten(course.modules.map(function (module) { return module.taskIds.map(function (taskId) {\r\n            if (taskIds[taskId]) {\r\n                var task = course.tasks.find(function (t) { return t.id === taskId; });\r\n                return L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"], [\"Samma uppgift f\\u00F6rekommer flera g\\u00E5nger: \\\"\", \"\\\"\"])), task.name);\r\n            }\r\n            taskIds[taskId] = true;\r\n        }).filter(function (x) { return x; }); }));\r\n    }\r\n    function tasksWithSameUrl(course) {\r\n        var taskUrls = {};\r\n        return course.tasks.map(function (task) {\r\n            if (task.url) {\r\n                if (taskUrls[task.url]) {\r\n                    return L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"], [\"Tv\\u00E5 uppgifter pekar p\\u00E5 samma URL: \\\"\", \"\\\" samt \\\"\", \"\\\"\"])), taskUrls[task.url].name, task.name);\r\n                }\r\n                taskUrls[task.url] = task;\r\n            }\r\n        }).filter(function (x) { return x; });\r\n    }\r\n    function hasEmptyModuleNames(course) {\r\n        return course.modules.some(function (module) { return module.name === \"\"; }) && L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Det finns minst en modul utan angivet namn\"], [\"Det finns minst en modul utan angivet namn\"])));\r\n    }\r\n    function hasDuplicateModuleNames(course) {\r\n        var moduleNames = {};\r\n        return course.modules.map(function (module) {\r\n            if (module.name && moduleNames[module.name]) {\r\n                return L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"], [\"Modulen med namn \", \" f\\u00F6rekommer flera g\\u00E5nger\"])), module.name);\r\n            }\r\n            if (module.name)\r\n                moduleNames[module.name] = true;\r\n        });\r\n    }\r\n    var checks = flatten([\r\n        hasDuplicateTasks(course),\r\n        tasksWithSameUrl(course),\r\n        hasEmptyModuleNames(course),\r\n        hasDuplicateModuleNames(course)\r\n    ]);\r\n    return checks.filter(function (result) { return result; });\r\n}\r\nexport function getTasksPerId(course) {\r\n    var result = {};\r\n    function add(id, task) {\r\n        var list = result[id] || (result[id] = []);\r\n        list.push(task);\r\n    }\r\n    course.tasks.forEach(function (task) {\r\n        task.abilities.forEach(function (a) { return add(a.id, task); });\r\n        task.centralContent.forEach(function (c) { return add(c.id, task); });\r\n        task.futureAbilities.forEach(function (fa) { return add(fa, task); });\r\n    });\r\n    return result;\r\n}\r\n/** Returns an access list for a course in a backward compatible way */\r\nexport function getSoftAccessList(course) {\r\n    var responsibleTeachers = course.responsibleTeachers;\r\n    var result = responsibleTeachers.map(function (da) { return ({\r\n        name: da.name,\r\n        email: getEmailFromDocAccess(da),\r\n        access: da.access || 'edit'\r\n    }); });\r\n    return result;\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Link } from 'react-router-dom';\r\nimport { allowCopy } from \"../utils\";\r\nimport { showError, L } from \"../../../utils/utils\";\r\nimport { createUUID } from \"kedbackend/client\";\r\nimport env from '../../../globals/KED.env';\r\nvar AdminMenuItems = [\r\n    { name: \"schools\", text: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolor\"], [\"Skolor\"]))), route: \"/schools\" },\r\n    { name: \"subjects\", text: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mnen\"], [\"\\u00C4mnen\"]))), route: \"/subjects\" },\r\n];\r\nvar NonAdminMenuItems = [\r\n    { name: \"courseBuilder\", text: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Kursbyggaren\"], [\"Kursbyggaren\"]))), route: \"/courses/new\" },\r\n    { name: \"studentPage\", text: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Elevsida\"], [\"Elevsida\"]))), route: \"\" },\r\n    { name: \"feedback\", text: React.createElement(\"span\", null,\r\n            React.createElement(\"i\", { className: \"fa fa-commenting-o\", \"aria-hidden\": \"true\" }),\r\n            \" Feedback\"), route: \"https://kg.kunskapsporten.se/kursbyggaren/\" }\r\n];\r\nfunction onDropImage(ev, host, course, origCourse) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var files, url, items, file, form, res, _loop_1, i;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    ev.stopPropagation();\r\n                    ev.preventDefault();\r\n                    files = ev.dataTransfer.files;\r\n                    url = null;\r\n                    items = Array.from(ev.dataTransfer.items);\r\n                    if (!(files.length > 0)) return [3 /*break*/, 3];\r\n                    file = files[0];\r\n                    if (file.size > 2 * 1024 * 1024) {\r\n                        showError(L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Kan inte ladda upp bilder st\\u00F6rre \\u00E4n 2 MB\"], [\"Kan inte ladda upp bilder st\\u00F6rre \\u00E4n 2 MB\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    form = new FormData();\r\n                    form.append(\"files\", file);\r\n                    return [4 /*yield*/, env.kedBackendClient.http.fetch('web-upload', 'put', {}, {}, {\r\n                            body: form\r\n                        })];\r\n                case 1:\r\n                    res = _a.sent();\r\n                    if (res.status !== 200) {\r\n                        showError(L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Kunde inte ladda upp filen till Google Storage\"], [\"Kunde inte ladda upp filen till Google Storage\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    return [4 /*yield*/, res.text()];\r\n                case 2:\r\n                    url = _a.sent();\r\n                    return [3 /*break*/, 7];\r\n                case 3:\r\n                    _loop_1 = function (i) {\r\n                        var item;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    item = items[i];\r\n                                    if (!item.type.match('^text/uri-list')) return [3 /*break*/, 2];\r\n                                    return [4 /*yield*/, new Promise(function (resolve) { return item.getAsString(resolve); })];\r\n                                case 1:\r\n                                    // URI\r\n                                    url = _a.sent();\r\n                                    _a.label = 2;\r\n                                case 2: return [2 /*return*/];\r\n                            }\r\n                        });\r\n                    };\r\n                    i = 0;\r\n                    _a.label = 4;\r\n                case 4:\r\n                    if (!(i < items.length)) return [3 /*break*/, 7];\r\n                    return [5 /*yield**/, _loop_1(i)];\r\n                case 5:\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6:\r\n                    ++i;\r\n                    return [3 /*break*/, 4];\r\n                case 7:\r\n                    if (url == null) {\r\n                        showError(L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Kunde inte hitta n\\u00E5gon bild i inneh\\u00E5llet\"], [\"Kunde inte hitta n\\u00E5gon bild i inneh\\u00E5llet\"]))));\r\n                        return [2 /*return*/];\r\n                    }\r\n                    setCourseImage(course, origCourse, host, url);\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nexport function setCourseImage(course, origCourse, host, url) {\r\n    var imageId = createUUID();\r\n    host.update({\r\n        imageId: { $set: imageId },\r\n        images: {\r\n            $set: [{\r\n                    id: imageId,\r\n                    url: url,\r\n                    acl: [\r\n                        \"role:USER:R\",\r\n                        \"schoolRole:\" + env.currentUser.school + \"/EMPLOYEE:S\"\r\n                    ],\r\n                    $meta: 'add'\r\n                }]\r\n        }\r\n    });\r\n}\r\n/* This version had the bug that old images were not replaced.\r\nOne course at Uppsala contained 12 images.\r\n\r\n\r\nexport function setCourseImageOld(\r\n  course: Course,\r\n  origCourse: Course,\r\n  host: ICourseEditorHost,\r\n  url: string)\r\n{\r\n  if (!origCourse || !origCourse.imageId) {\r\n    const imageId = createUUID();\r\n    host.update({\r\n      imageId: { $set: imageId },\r\n      images: {\r\n        $push: [{\r\n          id: imageId,\r\n          url,\r\n          acl: course.isTemplate ? [\"role:USER:R\"] : [\"role:USER:R\", `schoolRole:${env.currentUser.school}/EMPLOYEE:S`],\r\n          $meta: 'add'\r\n        }]\r\n      }\r\n    });\r\n  } else {\r\n    // Update existing image:\r\n    const imgIdx = course.images.findIndex(img => img.id === course.imageId);\r\n    if (imgIdx >= 0) {\r\n      const imageEntity = course.images[imgIdx];\r\n      if (course.isTemplate) {\r\n        // Templates: Update the template image content:\r\n        host.update({\r\n          images: {\r\n            $splice: [[imgIdx, 1, {\r\n              ...imageEntity,\r\n              url,\r\n              $meta: 'update'\r\n            }]]\r\n          }\r\n        })\r\n      } else {\r\n        // Real courses: Replace with a new image\r\n        const imageId = createUUID();\r\n        host.update({\r\n          imageId: { $set: imageId },\r\n          images: {\r\n            $splice: [[imgIdx, 1, {\r\n              id: imageId,\r\n              url,\r\n              acl: [\r\n                `role:USER:R`,\r\n                `schoolRole:${env.currentUser.school}/EMPLOYEE:S`\r\n              ],\r\n              $meta: 'add'\r\n            }]]\r\n          }\r\n        })\r\n      }\r\n    } else {\r\n      showError(L`Kunde inte uppdatera bilden.`);\r\n    }\r\n  }\r\n}\r\n*/\r\nexport var CourseBanner = function (props) {\r\n    var title = props.title, isTemplate = props.isTemplate, host = props.host, course = props.course, origCourse = props.origCourse, backgroundImage = props.backgroundImage, activePage = props.activePage;\r\n    var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n    var menuItems = NonAdminMenuItems;\r\n    if (isAdmin)\r\n        menuItems = AdminMenuItems.concat(menuItems);\r\n    return React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n        React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n            React.createElement(\"div\", { className: \"sv-script-portlet sv-portlet sv-skip-spacer\" },\r\n                backgroundImage && React.createElement(\"style\", null, \"\\n        .pageHeader {\\n          background-image: url('\" + backgroundImage + \"') !important;\\n        }\\n      \"),\r\n                React.createElement(\"div\", { className: \"pageHeader\", onDragOver: course && allowCopy, onDrop: course && (function (ev) { return onDropImage(ev, host, course, origCourse); }) },\r\n                    React.createElement(\"a\", null,\r\n                        React.createElement(\"h1\", null, title)),\r\n                    React.createElement(\"div\", { className: \"buttonsField\" },\r\n                        React.createElement(\"div\", { className: \"buttonsContainer\" },\r\n                            React.createElement(\"div\", { className: \"align-horizontal\" }),\r\n                            React.createElement(\"div\", { className: 'horizontalMenu' },\r\n                                React.createElement(\"ul\", null, menuItems.map(function (item) { return ({\r\n                                    item: item,\r\n                                    isActive: activePage === item.name,\r\n                                    callback: props.callbacks && props.callbacks[item.name],\r\n                                    givenRoute: (props.routes && props.routes[item.name]),\r\n                                    defaultRoute: item.route\r\n                                }); }).filter(function (x) { return x.callback || x.defaultRoute || x.givenRoute; }).map(function (_a) {\r\n                                    var item = _a.item, isActive = _a.isActive, callback = _a.callback, defaultRoute = _a.defaultRoute, givenRoute = _a.givenRoute;\r\n                                    return React.createElement(\"li\", { key: item.name, className: isActive ? \"activePage\" : \"\", onClick: callback }, callback ?\r\n                                        React.createElement(\"a\", null, item.text) :\r\n                                        defaultRoute || givenRoute ?\r\n                                            givenRoute || /^http[s]\\:\\/\\//i.test(defaultRoute) ?\r\n                                                React.createElement(\"a\", { href: givenRoute || defaultRoute }, item.text) :\r\n                                                React.createElement(Link, { to: defaultRoute }, item.text) :\r\n                                            React.createElement(\"a\", null, item.text));\r\n                                })))))))));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { findDOMNode } from 'react-dom';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { CourseModuleComponent } from './course-module';\r\nvar CourseModuleList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CourseModuleList, _super);\r\n    function CourseModuleList(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this._moduleRefs = {};\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    CourseModuleList.prototype.addModule = function () {\r\n        this.props.host.update({ modules: { $push: [{\r\n                        name: \"Ny kursmodul\",\r\n                        id: createUUID(),\r\n                        resources: [],\r\n                        taskIds: []\r\n                    }\r\n                ] } });\r\n    };\r\n    CourseModuleList.prototype.getOrderedModules = function () {\r\n        var course = this.props.course;\r\n        var moduleOrder = course.moduleOrder || course.modules.map(function (m) { return m.id; });\r\n        return moduleOrder\r\n            // Map ordered id to module\r\n            .map(function (id) { return course.modules.find(function (m) { return m.id === id; }); })\r\n            // Ignore entries that only exists in moduleOrder but not in modules\r\n            .filter(function (m) { return !!m; })\r\n            // Append modules at end that are not listed in moduleOrder\r\n            .concat(course.modules.filter(function (m) { return !moduleOrder.find(function (id) { return m.id === id; }); }));\r\n    };\r\n    CourseModuleList.prototype.reorder = function (moduleId, direction) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var course, orderedModules, moduleIndex, newModuleIndex, currentModuleAtPosition, moduleOrder, origScrollPos, elemModule;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        course = this.props.course;\r\n                        orderedModules = this.getOrderedModules();\r\n                        moduleIndex = orderedModules.findIndex(function (m) { return m.id === moduleId; });\r\n                        newModuleIndex = moduleIndex + direction;\r\n                        if (newModuleIndex < 0 || newModuleIndex >= orderedModules.length) {\r\n                            // Cannot order outside limits.\r\n                            return [2 /*return*/];\r\n                        }\r\n                        currentModuleAtPosition = orderedModules[newModuleIndex];\r\n                        moduleOrder = orderedModules.map(function (m) { return m.id; });\r\n                        moduleOrder[newModuleIndex] = moduleId;\r\n                        moduleOrder[moduleIndex] = currentModuleAtPosition.id;\r\n                        origScrollPos = document.documentElement.scrollTop;\r\n                        return [4 /*yield*/, this.props.host.update({\r\n                                moduleOrder: { $set: moduleOrder }\r\n                            })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        elemModule = findDOMNode(this._moduleRefs[moduleId]);\r\n                        if (elemModule) {\r\n                            try {\r\n                                window.scrollTo({ top: origScrollPos }); // Prohibit default scrolling directly upwards on move up.\r\n                                if (elemModule.getBoundingClientRect().top < 0 || elemModule.getBoundingClientRect().bottom > document.documentElement.scrollHeight) {\r\n                                    elemModule.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n                                }\r\n                            }\r\n                            catch (e) {\r\n                                // Only Chrome beta supports the arguments given above. Default for older browsers.\r\n                                window.scrollTo(null, origScrollPos);\r\n                                if (elemModule.getBoundingClientRect().top < 0 || elemModule.getBoundingClientRect().bottom > document.documentElement.scrollHeight) {\r\n                                    elemModule.scrollIntoView(true);\r\n                                }\r\n                            }\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CourseModuleList.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, course = _a.course, host = _a.host, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask;\r\n        var moduleOrder = course.moduleOrder || course.modules.map(function (m) { return m.id; });\r\n        var orderedModules = this.getOrderedModules();\r\n        return React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\", ref: function (elem) { return _this._elem = elem; } },\r\n            orderedModules.map(function (module) { return React.createElement(CourseModuleComponent, { ref: function (elem) { return _this._moduleRefs[module.id] = elem; }, key: module.id, course: course, module: module, onReorder: function (direction) { return _this.reorder(module.id, direction); }, getOrderedModules: function () { return _this.getOrderedModules(); }, host: host, idsNotCoveredByAnyTask: idsNotCoveredByAnyTask }); }),\r\n            React.createElement(\"div\", { className: \"btn btn-large\", onClick: function () { return _this.addModule(); } }, \"L\\u00E4gg till kursmodul\"));\r\n    };\r\n    return CourseModuleList;\r\n}(React.Component));\r\nexport { CourseModuleList };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditableResourceList } from '../sub-components/editable-resource-list';\r\nimport { EditableTaskList } from '../sub-components/editable-task-list';\r\nimport update from 'react-addons-update';\r\nimport { RemoveItem } from '../sub-components/remove-item';\r\nimport { L, showError } from \"../../../utils/utils\";\r\nimport { Wysiwyg } from '../../utility-components/wysiwyg';\r\nimport actions_swedish from '../../utility-components/wysiwyg/actions-sv';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nimport { ContentEditableField } from '../../utility-components/content-editable-field';\r\nimport { computeUpdatedOrder } from '../../course-builder-ks/logic/task-order';\r\nimport { features } from '../../../features';\r\nvar DEFAULT_KNOWLEDGE_MATRIX = [{\r\n        abilityIds: [],\r\n        EIds: [],\r\n        CIds: [],\r\n        AIds: []\r\n    }];\r\nvar CourseModuleComponent = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CourseModuleComponent, _super);\r\n    function CourseModuleComponent(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            editMandatoryContent: false\r\n        };\r\n        return _this;\r\n    }\r\n    CourseModuleComponent.prototype.getModuleIndex = function () {\r\n        var _a = this.props, course = _a.course, module = _a.module;\r\n        return course.modules.findIndex(function (m) { return m.id === module.id; });\r\n    };\r\n    CourseModuleComponent.prototype.getModuleOrderIndex = function () {\r\n        var _a = this.props, course = _a.course, module = _a.module;\r\n        var orderedModules = this.props.getOrderedModules();\r\n        return orderedModules.findIndex(function (m) { return m.id === module.id; });\r\n    };\r\n    CourseModuleComponent.prototype.updateModule = function (moduleUpdates) {\r\n        var module = this.props.module;\r\n        var updatedModule = update(module, moduleUpdates);\r\n        var moduleIndex = this.getModuleIndex();\r\n        this.props.host.update({ modules: { $splice: [[moduleIndex, 1, updatedModule]] } });\r\n    };\r\n    /* This method works for both adding new tasks to the task table\r\n    and adding references to existing tasks. The magic of that has to do with\r\n    whether task.$meta = 'add' or not and is done in EditCourse.save()\r\n    */\r\n    CourseModuleComponent.prototype.onTaskAdded = function (task, taskCustomization) {\r\n        // Add task ID to module taskIds list:\r\n        var courseUpdates = {};\r\n        var taskIds = this.props.module.taskIds.slice();\r\n        taskIds.push(task.id);\r\n        // Add physical Task to Course.tasks.\r\n        if (!this.props.course.tasks.some(function (t) { return t.id === task.id; })) {\r\n            courseUpdates.tasks = { $push: [task] };\r\n        }\r\n        var customizations = tslib_1.__assign({}, (this.props.module.taskCustomizations || {}));\r\n        if (taskCustomization)\r\n            customizations[task.id] = taskCustomization;\r\n        var moduleIndex = this.getModuleIndex();\r\n        courseUpdates.modules = {};\r\n        courseUpdates.modules[moduleIndex] = {\r\n            taskIds: { $set: taskIds },\r\n            taskCustomizations: { $set: customizations }\r\n        };\r\n        // Update module\r\n        this.props.host.update(courseUpdates);\r\n    };\r\n    CourseModuleComponent.prototype.onTaskUpdated = function (task) {\r\n        if (!task.$meta)\r\n            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Hoppsan, blev lite knas. Fel ID: \", \"\"], [\"Hoppsan, blev lite knas. Fel ID: \", \"\"])), 'Pa7Dq'));\r\n        var taskIndex = this.props.course.tasks.findIndex(function (t) { return t.id === task.id; });\r\n        if (taskIndex >= 0) {\r\n            this.props.host.update({ tasks: { $splice: [[taskIndex, 1, task]] } });\r\n        }\r\n    };\r\n    CourseModuleComponent.prototype.onTaskCustomized = function (taskId, customization) {\r\n        var customizations = tslib_1.__assign({}, (this.props.module.taskCustomizations || {}));\r\n        customizations[taskId] = customization;\r\n        this.updateModule({ taskCustomizations: { $set: customizations } });\r\n    };\r\n    CourseModuleComponent.prototype.onTaskDeleted = function (id) {\r\n        // Remove task ID from module taskIds list.\r\n        // This depends on the fact that EditCourse._setState() maintains\r\n        // removed Task links (which it actually does (or should do at least)).\r\n        this.updateModule({\r\n            taskIds: { $set: this.props.module.taskIds.filter(function (tid) { return tid !== id; }) },\r\n            taskCustomizations: {\r\n                $apply: function (customizations) {\r\n                    var copy = tslib_1.__assign({}, customizations);\r\n                    delete copy[id];\r\n                    return copy;\r\n                }\r\n            }\r\n        });\r\n    };\r\n    CourseModuleComponent.prototype.onTaskReplaced = function (id, task) {\r\n        var idxTask = this.props.module.taskIds.indexOf(id);\r\n        if (idxTask < 0) {\r\n            showError(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Kunde inte spara uppgift. Felkod d72kQ\"], [\"Kunde inte spara uppgift. Felkod d72kQ\"]))));\r\n            return;\r\n        }\r\n        var moduleUpdates = {\r\n            // Replace old id with new id:\r\n            taskIds: { $splice: [[idxTask, 1, task.id]] },\r\n            taskCustomizations: {\r\n                $apply: function (customizations) {\r\n                    var copy = tslib_1.__assign({}, customizations);\r\n                    delete copy[id];\r\n                    return copy;\r\n                }\r\n            }\r\n        };\r\n        var updatedModule = update(this.props.module, moduleUpdates);\r\n        var moduleIndex = this.getModuleIndex();\r\n        this.props.host.update({\r\n            // Apply moduleUpdates from above:\r\n            modules: { $splice: [[moduleIndex, 1, updatedModule]] },\r\n            // Add the new task to Course.tasks.\r\n            // Don't remove the old one! Why? Because it may be referenced\r\n            // by another module in same course! Let EditCourse._setState()\r\n            // do the \"garbage collection\" instead.\r\n            tasks: { $set: this.props.course.tasks.concat(task) }\r\n        });\r\n    };\r\n    CourseModuleComponent.prototype.onTasksReordered = function (source, target, placement) {\r\n        var newTaskIds = computeUpdatedOrder(this.props.course.tasks, this.props.module.taskIds, source, target, placement, { appendLeftovers: false });\r\n        this.updateModule({\r\n            taskIds: { $set: newTaskIds }\r\n        });\r\n    };\r\n    CourseModuleComponent.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, course = _a.course, host = _a.host, module = _a.module, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask;\r\n        var moduleIndex = this.getModuleIndex();\r\n        var moduleOrderedIndex = this.getModuleOrderIndex();\r\n        var knowledgeMatrixDiv;\r\n        var updateModule = this.updateModule.bind(this);\r\n        var week = 1;\r\n        var startWeekOptions = [\"--\"];\r\n        var endWeekOptions = [\"--\"];\r\n        for (var i = 0; i < 51; ++i) {\r\n            startWeekOptions.push('' + week);\r\n            endWeekOptions.push('' + ++week);\r\n        }\r\n        return React.createElement(OpenCloseBox, { inactivated: !features.cbCollapseBoxes, title: React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", { style: { float: \"right\" } },\r\n                    moduleOrderedIndex > 0 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-up selectable\", \"aria-hidden\": \"true\", onClick: function (e) { e.stopPropagation(); _this.props.onReorder(-1); } }),\r\n                        \" \"),\r\n                    moduleOrderedIndex < course.modules.length - 1 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-down selectable\", \"aria-hidden\": \"true\", onClick: function (e) { e.stopPropagation(); _this.props.onReorder(1); } }),\r\n                        \" \"),\r\n                    React.createElement(RemoveItem, { title: \"Ta bort modulen\", style: { display: 'inline-block' }, onClick: function (e) { e.stopPropagation(); confirm(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Ta bort modul \", \"?\"], [\"Ta bort modul \", \"?\"])), module.name)) && host.update({ modules: { $splice: [[moduleIndex, 1]] } }); } })),\r\n                React.createElement(\"p\", null, module.name)), headerOpen: module.name == 'Ny kursmodul' },\r\n            React.createElement(\"div\", { className: \"course-module ked_boxed\", style: { position: 'relative' } },\r\n                React.createElement(ContentEditableField, { text: module.name, tag: 'h3', className: 'renameable-text', maxChars: 100, placeholder: \"Namnl\\u00F6s modul\", onChange: function (newName) { return updateModule({ name: { $set: newName } }); } }),\r\n                React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem center\" },\r\n                        React.createElement(\"p\", null, \"Startvecka\")),\r\n                    React.createElement(\"div\", { className: \"horizontalItem center\" },\r\n                        React.createElement(\"select\", { value: module.startWeek || \"--\", onChange: function (ev) { return updateModule({ startWeek: {\r\n                                    $set: ev.target.value === '--' ?\r\n                                        undefined :\r\n                                        parseInt(ev.target.value)\r\n                                }\r\n                            }); } }, startWeekOptions.map(function (o) { return React.createElement(\"option\", { key: o, value: o }, o); }))),\r\n                    React.createElement(\"div\", { className: \"horizontalItem center\" },\r\n                        React.createElement(\"p\", null, \"Slutvecka\")),\r\n                    React.createElement(\"div\", { className: \"horizontalItem center\" },\r\n                        React.createElement(\"select\", { value: module.endWeek || \"--\", onChange: function (ev) { return updateModule({ endWeek: {\r\n                                    $set: ev.target.value === '--' ?\r\n                                        undefined :\r\n                                        parseInt(ev.target.value)\r\n                                }\r\n                            }); } }, endWeekOptions.map(function (o) { return React.createElement(\"option\", { key: o, value: o }, o); })))),\r\n                React.createElement(\"h4\", null, \"Kursmodulens introduktion\"),\r\n                React.createElement(Wysiwyg, { actions: [\r\n                        \"bold\",\r\n                        \"italic\",\r\n                        \"underline\",\r\n                        \"strikethrough\",\r\n                        \"heading2\",\r\n                        \"heading3\",\r\n                        \"olist\",\r\n                        \"ulist\",\r\n                        \"outdent\",\r\n                        \"indent\",\r\n                        \"line\",\r\n                        \"link\",\r\n                        \"image\"\r\n                    ], defaultActions: actions_swedish, html: module.mandatoryContent, onChange: function (html) {\r\n                        updateModule({ mandatoryContent: { $set: html } });\r\n                    } }),\r\n                React.createElement(\"h4\", null, \"Uppgifter\"),\r\n                React.createElement(EditableTaskList, { taskIds: module.taskIds, taskCustomizations: module.taskCustomizations, course: course, module: module, host: host, idsNotCoveredByAnyTask: idsNotCoveredByAnyTask, onTaskAdded: function (task, taskCustomization) { return _this.onTaskAdded(task, taskCustomization); }, onTaskUpdated: function (task) { return _this.onTaskUpdated(task); }, onTaskCustomizationUpdated: function (taskId, customization) {\r\n                        return _this.onTaskCustomized(taskId, customization);\r\n                    }, onTaskDeleted: function (id) { return _this.onTaskDeleted(id); }, onTaskReplaced: function (id, task) { return _this.onTaskReplaced(id, task); }, onTasksReordered: function (source, target, placement) { return _this.onTasksReordered(source, target, placement); } }),\r\n                React.createElement(\"h4\", null, \"Modulresurser\"),\r\n                React.createElement(\"p\", { className: \"subHeader\" }, \"(Eventuella resuser f\\u00F6r redovisning av modulen samt f\\u00F6r modulen som helhet)\"),\r\n                React.createElement(EditableResourceList, { resources: module.resources, onUpdate: function (resourcesUpdates) { return updateModule({ resources: resourcesUpdates }); }, host: host }),\r\n                React.createElement(\"div\", { style: { position: 'absolute', top: 0, right: 0 } },\r\n                    moduleOrderedIndex > 0 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-up selectable\", \"aria-hidden\": \"true\", onClick: function () { return _this.props.onReorder(-1); } }),\r\n                        \" \"),\r\n                    moduleOrderedIndex < course.modules.length - 1 && React.createElement(\"span\", null,\r\n                        React.createElement(\"i\", { className: \"fa fa-arrow-circle-down selectable\", \"aria-hidden\": \"true\", onClick: function () { return _this.props.onReorder(1); } }),\r\n                        \" \"),\r\n                    React.createElement(RemoveItem, { title: \"Ta bort modulen\", style: { display: 'inline-block' }, onClick: function () { return confirm(L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Ta bort modul \", \"?\"], [\"Ta bort modul \", \"?\"])), module.name)) && host.update({ modules: { $splice: [[moduleIndex, 1]] } }); } })),\r\n                React.createElement(\"div\", { className: \"horizontal-align\" },\r\n                    React.createElement(\"div\", { className: \"horizontaItem activateCourseModule\" },\r\n                        React.createElement(\"div\", { className: \"btn btn-info\" + (module.inactive ? \" btn-activate\" : \" btn-inactivate\"), onClick: function () { return updateModule({ inactive: { $set: !module.inactive } }); } }, module.inactive ? 'Aktivera modulen' : 'Inaktivera modulen')))));\r\n    };\r\n    return CourseModuleComponent;\r\n}(React.Component));\r\nexport { CourseModuleComponent };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { CourseBanner } from \"./course-banner\";\r\nimport { L, showError, flatten, compareProp, showInfo, maxLength, compareProps, distinct } from \"../../../utils/utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { Link } from 'react-router-dom';\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nimport { SchoolCourses } from \"../sub-components/school-courses\";\r\nimport { TextInput } from '../../utility-components/form-field-text-input';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\nvar CreateNewCourse = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CreateNewCourse, _super);\r\n    function CreateNewCourse(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            courseOptions: null,\r\n            selectedTemplateId: \"--\",\r\n            courses: null,\r\n            selectedCourseId: \"\"\r\n        };\r\n        return _this;\r\n    }\r\n    CreateNewCourse.prototype.componentDidMount = function () {\r\n        this.load().catch(showError);\r\n    };\r\n    CreateNewCourse.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subjects, courses, courseOptions;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        showInfo(\"Laddar kurser\");\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"subjects\", {\r\n                                tags: [\"schoolType:gymnasium\"],\r\n                                include: \"courseTemplates\"\r\n                            })];\r\n                    case 1:\r\n                        subjects = _a.sent();\r\n                        courses = flatten(subjects.map(function (s) { return s.courseTemplates; }))\r\n                            .sort(compareProps([\"name\", \"dateTime\"]));\r\n                        // If two courses have the same name, they will be secondary sorted by date imported.\r\n                        // By running the distinct() call below, we will make sure that only the latest imported\r\n                        // course with that name is loaded.\r\n                        // This is the case for \"Webbutveckling 1\" - a course that used to occur on a subject with\r\n                        // another name in 2018, but in 2019 occurs on a new subject, so it's by definition another\r\n                        // course, but same name.\r\n                        courses = distinct(courses, function (c) { return c.name; });\r\n                        courseOptions = tslib_1.__spread([\r\n                            { id: \"--\", name: \"--\" }\r\n                        ], courses, [\r\n                            { id: \"---\", name: \"---\" },\r\n                            { id: \"custom\", name: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Egen kurs\"], [\"Egen kurs\"]))) }\r\n                        ]);\r\n                        showInfo(\"\");\r\n                        this.setState({ courseOptions: courseOptions });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CreateNewCourse.prototype.onSelectCourse = function (id) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var derivedCourses, courseOptions, kedStandardOptions, teacherMade, courses;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (id === 'custom') {\r\n                            this.setState({\r\n                                selectedTemplateId: id\r\n                            });\r\n                        }\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"courses\", { hasEdgesTo: [id] })];\r\n                    case 1:\r\n                        derivedCourses = _a.sent();\r\n                        courseOptions = derivedCourses\r\n                            .filter(function (course) { return course.active; })\r\n                            .map(function (_a) {\r\n                            var id = _a.id, school = _a.school, description = _a.description, createdBy = _a.createdBy, modifiedBy = _a.modifiedBy;\r\n                            if (description)\r\n                                description = maxLength(description, 80);\r\n                            var descriptionOrAuthor = description ||\r\n                                (createdBy ? createdBy.name + \"s version\" :\r\n                                    modifiedBy && modifiedBy.name + \"s version\");\r\n                            return {\r\n                                id: id,\r\n                                name: school === 'standard' ?\r\n                                    description ? \"Standard - \" + description : \"Standard\" :\r\n                                    school + \" - \" + maxLength(descriptionOrAuthor, 90),\r\n                                school: school\r\n                            };\r\n                        }).sort(compareProp(\"name\"));\r\n                        kedStandardOptions = courseOptions.filter(function (option) { return option.school === \"standard\"; });\r\n                        teacherMade = courseOptions.filter(function (option) { return option.school !== \"standard\"; });\r\n                        courses = tslib_1.__spread(kedStandardOptions, [\r\n                            { id: id, name: \"Tom\" }\r\n                        ], teacherMade);\r\n                        this.setState({\r\n                            courses: courses,\r\n                            selectedTemplateId: id,\r\n                            selectedCourseId: courses[0].id\r\n                        });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CreateNewCourse.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, courseOptions = _a.courseOptions, selectedTemplateId = _a.selectedTemplateId, courses = _a.courses, selectedCourseId = _a.selectedCourseId, customCourseName = _a.customCourseName, customCoursePoints = _a.customCoursePoints;\r\n        var customCourseCode = customCourseName && (this.state.customCourseCode || \"CUST-\" + customCourseName.substr(0, 5).toUpperCase());\r\n        return React.createElement(\"div\", { style: { outline: 0 } },\r\n            React.createElement(CourseBanner, { title: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Kursbyggaren\"], [\"Kursbyggaren\"]))), activePage: \"courseBuilder\", routes: { feedback: this.props.feedbackUrl } }),\r\n            React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n                React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n                    React.createElement(\"div\", { className: \"sv-spacer-20pxvt sv-vertical sv-layout sv-skip-spacer\" },\r\n                        React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" },\r\n                            React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n                                React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-7\" },\r\n                                    React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                                        React.createElement(\"h2\", null, \"Skapa ny kurs\"),\r\n                                        React.createElement(\"hr\", null),\r\n                                        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                                            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                                React.createElement(\"p\", null, \"V\\u00E4lj gymnasiekurs :\"))),\r\n                                        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                                            React.createElement(\"div\", { className: \"horizontalItem top\" }, !courseOptions ?\r\n                                                React.createElement(\"div\", null,\r\n                                                    React.createElement(Spinner, null),\r\n                                                    React.createElement(\"select\", { disabled: true, value: \"\" },\r\n                                                        React.createElement(\"option\", null, \"--\"))) :\r\n                                                React.createElement(\"select\", { value: selectedTemplateId, onChange: function (ev) { return _this.onSelectCourse(ev.target.value).catch(showError); } }, courseOptions.map(function (course) {\r\n                                                    return React.createElement(\"option\", { key: course.id, value: course.id }, course.name);\r\n                                                })))),\r\n                                        selectedTemplateId === 'custom' ? React.createElement(React.Fragment, null,\r\n                                            React.createElement(AlignHorizontal, null,\r\n                                                React.createElement(HorizontalItem, null,\r\n                                                    React.createElement(TextInput, { id: \"customCourseName\", autoFocus: true, label: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Kursens namn\"], [\"Kursens namn\"]))), value: customCourseName || '', onChange: function (value) {\r\n                                                            return _this.setState({ customCourseName: value });\r\n                                                        } })),\r\n                                                React.createElement(HorizontalItem, null,\r\n                                                    React.createElement(TextInput, { id: \"customCourseCode\", label: L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Kurskod\"], [\"Kurskod\"]))), size: 12, value: customCourseCode || '', onChange: function (customCourseCode) { return _this.setState({ customCourseCode: customCourseCode }); } }))),\r\n                                            React.createElement(TextInput, { id: \"customCoursePoints\", label: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Po\\u00E4ng\"], [\"Po\\u00E4ng\"]))), size: 3, value: '' + (customCoursePoints || ''), onChange: function (value) {\r\n                                                    var numPoints = value ? parseInt(value) : 0;\r\n                                                    if (!isNaN(numPoints) && numPoints < 1000) {\r\n                                                        _this.setState({ customCoursePoints: numPoints });\r\n                                                    }\r\n                                                } }),\r\n                                            React.createElement(\"br\", null),\r\n                                            React.createElement(\"br\", null),\r\n                                            React.createElement(Link, { className: \"btn btn-large\", to: \"/courses/create-custom/\" + encodeURIComponent(JSON.stringify({ name: customCourseName, code: customCourseCode, points: customCoursePoints })) }, \"Skapa\")) : courses && React.createElement(React.Fragment, null,\r\n                                            React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                                    React.createElement(\"p\", null, \"Utg\\u00E5 fr\\u00E5n version: \"))),\r\n                                            React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                                                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                                    React.createElement(\"select\", { value: selectedCourseId, onChange: function (ev) { return _this.setState({\r\n                                                            selectedCourseId: ev.target.value\r\n                                                        }); } }, courses.map(function (course) {\r\n                                                        return React.createElement(\"option\", { key: course.id, value: course.id }, course.name);\r\n                                                    })))),\r\n                                            React.createElement(\"br\", null),\r\n                                            React.createElement(\"br\", null),\r\n                                            selectedCourseId && React.createElement(Link, { to: \"/courses/create-from-template/\" + this.state.selectedCourseId, className: \"btn btn-large\" }, \"Skapa\")))),\r\n                                React.createElement(\"div\", { className: \"sv-layout sv-column-5\" },\r\n                                    React.createElement(SchoolCourses, null))))))));\r\n    };\r\n    return CreateNewCourse;\r\n}(React.Component));\r\nexport { CreateNewCourse };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { findDOMNode } from 'react-dom';\r\nimport { L, showInfo, showError } from '../../../utils/utils';\r\nimport { hasChanges } from '../utils';\r\nimport { BatchRunner, createUUID } from 'kedbackend/client';\r\nimport env from '../../../globals/KED.env';\r\nimport { CourseBanner } from './course-banner';\r\nimport { InnerEditCourse } from './inner-edit-course';\r\nimport update from 'react-addons-update';\r\nimport { updateDocumentGraphs, applyEtags, updateCourseBuilderStatus, loadCourse, updateCreationStamp, updateModificationStamp } from '../utils';\r\nimport { RemoveItem } from '../sub-components/remove-item';\r\nimport { getUncoveredKnowledgeRequirements, getSoftAccessList } from './business-logic';\r\nimport cfg from '../../../globals/KED.cfg';\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nimport { mySchoolCoursesRepo } from '../../../repos/school-courses';\r\nimport { preserveImpersonationQuery } from \"../../../access-control\";\r\nimport { getCurrentUser } from '../../../globals/current-user';\r\nimport { features } from '../../../features/features';\r\nimport { ClassroomSync } from '../../../apis/google-classroom-sync';\r\nvar catcher = cfg.ENVIRONMENT === 'production' ?\r\n    showError : null;\r\nvar CONFIRM_NAVIGATE_MESSAGE = L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Du har osparat data. V\\u00E4lj avbryt och tryck CTRL+S om du vill spara f\\u00F6rst.\"], [\"Du har osparat data. V\\u00E4lj avbryt och tryck CTRL+S om du vill spara f\\u00F6rst.\"])));\r\nvar DEFAULT_STATE = {\r\n    origCourse: null,\r\n    origTemplate: null,\r\n    course: null,\r\n    dialogContainers: [],\r\n    hasUnsavedData: false,\r\n    view: 'courseBuilder',\r\n    classroomSyncInProgress: false\r\n};\r\nvar EditCourse = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditCourse, _super);\r\n    function EditCourse(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = tslib_1.__assign({}, DEFAULT_STATE);\r\n        _this.update = _this.update.bind(_this);\r\n        _this.refDialog = _this.refDialog.bind(_this);\r\n        _this.contentYPos = 0;\r\n        _this.onKeyDown = _this.onKeyDown.bind(_this);\r\n        _this.beforeUnload = _this.beforeUnload.bind(_this);\r\n        _this.onClickPreventUnload = _this.onClickPreventUnload.bind(_this);\r\n        _this.isSaving = false;\r\n        _this.dialogs = [];\r\n        if (props.view)\r\n            _this.state = tslib_1.__assign({}, _this.state, { view: props.view });\r\n        return _this;\r\n    }\r\n    EditCourse.prototype.setStatePromised = function (state) {\r\n        return this._setState(tslib_1.__assign({ hasUnsavedData: true }, state));\r\n    };\r\n    EditCourse.prototype.setNonSaveableDataState = function (state) {\r\n        return this._setState(state);\r\n    };\r\n    EditCourse.prototype._setState = function (state) {\r\n        var _this = this;\r\n        if (state.course) {\r\n            {\r\n                //\r\n                // Maintain course task links (remove links to tasks that are not used\r\n                // by any module)\r\n                //\r\n                var _a = state.course, tasks = _a.tasks, modules = _a.modules;\r\n                var usedTaskIds_1 = {};\r\n                modules.forEach(function (module) { return module.taskIds.forEach(function (id) { return usedTaskIds_1[id] = true; }); });\r\n                var filteredCourseTasks = tasks.filter(function (t) { return usedTaskIds_1[t.id]; });\r\n                var modifiedCourse = tslib_1.__assign({}, state.course);\r\n                modifiedCourse.tasks = filteredCourseTasks;\r\n                state = tslib_1.__assign({}, state, { course: modifiedCourse });\r\n            }\r\n        }\r\n        // Invoke our course into state property allCourses so that the\r\n        // right-hand side list of courses gets update immediately with\r\n        // the publishable state of this course.\r\n        var allCourses = state.allCourses || this.state.allCourses;\r\n        var course = state.course || this.state.course;\r\n        if (allCourses) {\r\n            var idxOurCourse = allCourses.findIndex(function (c) { return c.id === _this.props.id; });\r\n            allCourses = update(allCourses, { $splice: [[idxOurCourse, 1, course]] });\r\n            state = tslib_1.__assign({}, state);\r\n            state.allCourses = allCourses;\r\n        }\r\n        return new Promise(function (resolve) { return _super.prototype.setState.call(_this, function () { return state; }, resolve); });\r\n    };\r\n    EditCourse.prototype.componentWillMount = function () {\r\n        this.load().catch(catcher);\r\n        window.addEventListener('keydown', this.onKeyDown);\r\n        window.addEventListener('beforeunload', this.beforeUnload);\r\n        document.body.addEventListener('click', this.onClickPreventUnload);\r\n    };\r\n    EditCourse.prototype.componentWillUnmount = function () {\r\n        window.removeEventListener('keydown', this.onKeyDown);\r\n        window.removeEventListener('beforeunload', this.beforeUnload);\r\n        document.body.removeEventListener('click', this.onClickPreventUnload);\r\n        updateCourseBuilderStatus('');\r\n    };\r\n    EditCourse.prototype.componentWillReceiveProps = function (nextProps) {\r\n        if (this.state && this.state.course) {\r\n            if (nextProps.id !== this.props.id || nextProps.templateId !== this.props.templateId) {\r\n                this.setStatePromised(DEFAULT_STATE);\r\n            }\r\n        }\r\n        if (nextProps.view !== this.props.view) {\r\n            this.setNonSaveableDataState({ view: nextProps.view });\r\n        }\r\n    };\r\n    EditCourse.prototype.componentDidUpdate = function (prevProps, prevState) {\r\n        if (this.contentDiv) {\r\n            var contentDiv = findDOMNode(this.contentDiv);\r\n            if (contentDiv) {\r\n                this.contentYPos = contentDiv.getBoundingClientRect().top;\r\n            }\r\n        }\r\n        if (prevState && prevState.course) {\r\n            // This was not the initial update.\r\n            // If props have been updated to point out another course or template, reset component:\r\n            if (this.props.id !== prevProps.id || this.props.templateId !== prevProps.templateId) {\r\n                this.load().catch(catcher);\r\n            }\r\n        }\r\n        if (!prevState.hasUnsavedData && this.state.hasUnsavedData) {\r\n            updateCourseBuilderStatus('unsaved');\r\n        }\r\n    };\r\n    EditCourse.prototype.loadFromTemplate = function (templateId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var template, course, mySchool;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        showInfo(\"Laddar data från mall...\");\r\n                        return [4 /*yield*/, loadCourse(templateId, { includeTemplateChain: true })];\r\n                    case 1:\r\n                        template = _a.sent();\r\n                        course = updateCreationStamp(Date.now(), template, env.currentUser);\r\n                        course.id = createUUID();\r\n                        course.parentId = templateId;\r\n                        course.active = false;\r\n                        course.isTemplate = false;\r\n                        course.templateChain = tslib_1.__spread(course.templateChain);\r\n                        course.templateChain.push({ id: templateId, $meta: 'ref' });\r\n                        mySchool = env.currentUser.school;\r\n                        course.school = mySchool;\r\n                        course.description = \"\";\r\n                        course.responsibleTeachers = [{ name: env.currentUser.displayName, email: env.currentUser.mail, access: 'full', url: env.currentUser.mail }];\r\n                        delete course.studyGroups;\r\n                        course.acl = [\r\n                            \"role:USER:R\",\r\n                            \"schoolRole:\" + mySchool + \"/EMPLOYEE:S\" // Other teachers at same school should be able to modify the course.\r\n                        ];\r\n                        delete course.$etag;\r\n                        delete course.createdBy;\r\n                        delete course.createdDate;\r\n                        delete course.modifiedBy;\r\n                        delete course.modifiedDate;\r\n                        delete course.activatedBy;\r\n                        delete course.activatedDate;\r\n                        delete course.googleClassRoomCode;\r\n                        delete course.googleClassRoomURL;\r\n                        delete course.googleCreateClassrooms;\r\n                        return [4 /*yield*/, this.setStatePromised({ course: course, origCourse: null, origTemplate: template })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        showInfo(\"\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.loadCustomParams = function (_a) {\r\n        var name = _a.name, code = _a.code, points = _a.points;\r\n        var now = Date.now();\r\n        var mySchool = env.currentUser.school;\r\n        var user = env.currentUser;\r\n        var course = {\r\n            id: createUUID(),\r\n            name: name,\r\n            code: code,\r\n            points: points,\r\n            dateTime: now,\r\n            createdDate: now,\r\n            createdBy: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            },\r\n            subjectId: \"custom\",\r\n            subjectCode: \"custom\",\r\n            active: false,\r\n            isTemplate: false,\r\n            templateChain: [],\r\n            school: mySchool,\r\n            description: \"\",\r\n            responsibleTeachers: [{ name: user.displayName, email: user.mail, access: 'full', url: user.mail }],\r\n            acl: [\r\n                \"role:USER:R\",\r\n                \"schoolRole:\" + mySchool + \"/EMPLOYEE:S\" // Other teachers at same school should be able to modify the course.\r\n            ],\r\n            resources: [],\r\n            modules: [],\r\n            knowledgeRequirementsOrder: [],\r\n            centralContentOrder: [],\r\n            abilitiesOrder: [],\r\n            images: [],\r\n            knowledgeRequirements: [],\r\n            centralContent: [],\r\n            abilities: [],\r\n            tasks: [],\r\n            schoolType: \"gymnasium\",\r\n            tags: [\r\n                \"sub:CUSTOM\",\r\n                \"course:\" + code,\r\n                \"schoolType:gymnasium\"\r\n            ]\r\n        };\r\n        this.setState({ course: course, origCourse: course, origTemplate: null });\r\n    };\r\n    EditCourse.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        updateCourseBuilderStatus('');\r\n                        if (!this.props.id) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.loadExistingCourse(this.props.id)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 5];\r\n                    case 2:\r\n                        if (!this.props.templateId) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.loadFromTemplate(this.props.templateId)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 5];\r\n                    case 4:\r\n                        if (this.props.customParams) {\r\n                            this.loadCustomParams(this.props.customParams);\r\n                        }\r\n                        else {\r\n                            throw new Error(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Ogiltig parameter. customParams, id eller templateId m\\u00E5ste anges\"], [\"Ogiltig parameter. customParams, id eller templateId m\\u00E5ste anges\"]))));\r\n                        }\r\n                        _a.label = 5;\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.loadExistingCourse = function (courseId) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var course;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        showInfo(\"Laddar kurs\");\r\n                        return [4 /*yield*/, loadCourse(courseId)];\r\n                    case 1:\r\n                        course = _a.sent();\r\n                        if (!course.responsibleTeachers)\r\n                            course.responsibleTeachers = [{ name: env.currentUser.displayName, email: env.currentUser.mail, access: 'full', url: env.currentUser.mail }];\r\n                        return [4 /*yield*/, this.setNonSaveableDataState({ course: course, origCourse: course })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        showInfo(\"\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.update = function (courseUpdates) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.setStatePromised({ course: update(this.state.course, courseUpdates) })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        //check classroom changes\r\n                        if (features.studyGroups) {\r\n                            this._checkClassroomChanges();\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.deleteCourse = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var courseSchool, parentId, courseId, classroomSync, children, br, children_1, children_1_1, childCourse;\r\n            var e_1, _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        showInfo(\"Raderar kursen...\");\r\n                        courseSchool = this.state.course.school;\r\n                        parentId = this.state.course.parentId;\r\n                        courseId = this.props.id;\r\n                        classroomSync = new ClassroomSync();\r\n                        classroomSync.delete({ responsibleTeachers: this.state.course.responsibleTeachers, id: courseId });\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"courses\", {\r\n                                hasEdgesTo: [this.props.id]\r\n                            })];\r\n                    case 1:\r\n                        children = _b.sent();\r\n                        br = new BatchRunner();\r\n                        try {\r\n                            for (children_1 = tslib_1.__values(children), children_1_1 = children_1.next(); !children_1_1.done; children_1_1 = children_1.next()) {\r\n                                childCourse = children_1_1.value;\r\n                                /* CANNOT DO THIS. MAY NOT HAVE ACCESS! if (childCourse.parentId === courseId) {\r\n                                  // Reconnect child with my parent instead, as I will be disappearing...\r\n                                  childCourse.parentId = parentId;\r\n                                  br.put(\"courses\", childCourse);\r\n                                }*/\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (children_1_1 && !children_1_1.done && (_a = children_1.return)) _a.call(children_1);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        br.delete(\"courses\", courseId);\r\n                        return [4 /*yield*/, env.kedBackendClient.batch(br.mutationRequests)];\r\n                    case 2:\r\n                        _b.sent();\r\n                        if (courseSchool === env.currentUser.school) {\r\n                            mySchoolCoursesRepo.delete(courseId);\r\n                        }\r\n                        showInfo(\"\");\r\n                        location.hash = \"#/courses/new\";\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * In case that the course has changes which should be synced with classroom\r\n     * Ask the user if the sync should be done\r\n     */\r\n    EditCourse.prototype.confirmSaveAndSync = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var course, syncWithClassroom;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        course = this.state.course;\r\n                        syncWithClassroom = false;\r\n                        //confirm should not be displayed in case the checkbox was saved and the feature flag is off\r\n                        if (course.googleCreateClassrooms && !course.inSyncWithClassroom && features.studyGroups) {\r\n                            syncWithClassroom = confirm(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Synkronisera kurs kurs med Classroom?\"], [\"Synkronisera kurs kurs med Classroom?\"]))));\r\n                        }\r\n                        return [4 /*yield*/, syncWithClassroom];\r\n                    case 1:\r\n                        (_a.sent()) ? this.syncWithClassroomAndSave() : this.save();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, course, origCourse, classroomSync, result, catcher_1, enableTeacherRights, origAccessList, modifiedAccessList, currentUser, err_1, errorMessage;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.state, course = _a.course, origCourse = _a.origCourse;\r\n                        if (!(features.studyGroups && origCourse && origCourse.googleCreateClassrooms && !course.googleCreateClassrooms)) return [3 /*break*/, 4];\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        _b.trys.push([1, 3, , 4]);\r\n                        classroomSync = new ClassroomSync();\r\n                        return [4 /*yield*/, classroomSync.archive(course)];\r\n                    case 2:\r\n                        result = _b.sent();\r\n                        if (!result.done) {\r\n                            showError(L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Classroom course could not be archived\"], [\"Classroom course could not be archived\"]))));\r\n                        }\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        catcher_1 = _b.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 4:\r\n                        enableTeacherRights = features.teacherRights;\r\n                        origAccessList = this.state.origCourse ? getSoftAccessList(this.state.origCourse) : [];\r\n                        modifiedAccessList = getSoftAccessList(this.state.course);\r\n                        currentUser = getCurrentUser();\r\n                        if (enableTeacherRights &&\r\n                            (!currentUser.roles.includes(\"ADMIN\") &&\r\n                                !tslib_1.__spread(origAccessList, modifiedAccessList).some(function (_a) {\r\n                                    var email = _a.email, url = _a.url, access = _a.access;\r\n                                    return (email || url) === currentUser.mail && // url is for backward compat! Has been renamed to email.\r\n                                        (!access || // Backward compat. Was not possible to set access before!\r\n                                            access === 'edit' || // Edit is fine\r\n                                            access === 'full');\r\n                                }))) {\r\n                            showError(L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Kursen kunde inte sparas. L\\u00E4gg till dig sj\\u00E4lv i listan p\\u00E5 ansvariga l\\u00E4rare\"], [\"Kursen kunde inte sparas. L\\u00E4gg till dig sj\\u00E4lv i listan p\\u00E5 ansvariga l\\u00E4rare\"]))));\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (this.isSaving)\r\n                            return [2 /*return*/];\r\n                        _b.label = 5;\r\n                    case 5:\r\n                        _b.trys.push([5, 7, 8, 9]);\r\n                        this.isSaving = true;\r\n                        return [4 /*yield*/, this._save()];\r\n                    case 6:\r\n                        _b.sent();\r\n                        return [3 /*break*/, 9];\r\n                    case 7:\r\n                        err_1 = _b.sent();\r\n                        errorMessage = err_1 && err_1.message ? err_1.message : L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Ett ok\\u00E4nt fel har intr\\u00E4ffat...\"], [\"Ett ok\\u00E4nt fel har intr\\u00E4ffat...\"])));\r\n                        if (err_1) {\r\n                            if (err_1.name === 'http409' || err_1.name === 'http412' || err_1.name === 'http404') {\r\n                                // Conflict. Show a nicer error message:\r\n                                errorMessage = L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Kursen har redigerad av annan anv\\u00E4ndare. Ladda om sidan och g\\u00F6r om \\u00E4ndrinarna.\"], [\"Kursen har redigerad av annan anv\\u00E4ndare. Ladda om sidan och g\\u00F6r om \\u00E4ndrinarna.\"])));\r\n                            }\r\n                            else if (err_1.name === 'http403') {\r\n                                if (this.state.course.isTemplate)\r\n                                    errorMessage = L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"Ingen beh\\u00F6righet att spara kursmallen. Endast administrat\\u00F6rer kan redigera kursmallar.\"], [\"Ingen beh\\u00F6righet att spara kursmallen. Endast administrat\\u00F6rer kan redigera kursmallar.\"])));\r\n                                else if (this.state.course.school)\r\n                                    errorMessage = L(templateObject_9 || (templateObject_9 = tslib_1.__makeTemplateObject([\"Ingen beh\\u00F6righet att spara kursen \", \". Kursen kan bara redigeras av anst\\u00E4llda p\\u00E5 \", \"\"], [\"Ingen beh\\u00F6righet att spara kursen \", \". Kursen kan bara redigeras av anst\\u00E4llda p\\u00E5 \", \"\"])), this.state.course.name, this.state.course.school);\r\n                            }\r\n                        }\r\n                        showError(errorMessage);\r\n                        updateCourseBuilderStatus('error');\r\n                        return [3 /*break*/, 9];\r\n                    case 8:\r\n                        this.isSaving = false;\r\n                        return [7 /*endfinally*/];\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype.syncInProgress = function () {\r\n        return this.state.classroomSyncInProgress;\r\n    };\r\n    EditCourse.prototype.syncWithClassroomAndSave = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, course, origCourse, classroomSync, fullSyncNeeded, syncResult, err_2;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.state, course = _a.course, origCourse = _a.origCourse;\r\n                        return [4 /*yield*/, this.save()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        // if there is still unsaved data it means that an error encountered during save. \r\n                        // sync with google classroom will be canceled\r\n                        if (this.state.hasUnsavedData) {\r\n                            showError(L(templateObject_10 || (templateObject_10 = tslib_1.__makeTemplateObject([\"Synkronisering med Classroom skulle inte ske\"], [\"Synkronisering med Classroom skulle inte ske\"]))));\r\n                            return [2 /*return*/];\r\n                        }\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        _b.trys.push([2, 7, , 8]);\r\n                        this.setState({ classroomSyncInProgress: true });\r\n                        classroomSync = new ClassroomSync();\r\n                        if (!course.googleCreateClassrooms) return [3 /*break*/, 6];\r\n                        fullSyncNeeded = course.inSyncWithClassroom == null;\r\n                        return [4 /*yield*/, classroomSync.initSync(course, origCourse, fullSyncNeeded)];\r\n                    case 3:\r\n                        syncResult = _b.sent();\r\n                        if (!syncResult.done) return [3 /*break*/, 5];\r\n                        this.update({ inSyncWithClassroom: { $set: true } });\r\n                        this.setState({ classroomSyncInProgress: false });\r\n                        //update inSyncWithClassroom flag\r\n                        return [4 /*yield*/, this._save(true)];\r\n                    case 4:\r\n                        //update inSyncWithClassroom flag\r\n                        _b.sent();\r\n                        showInfo(L(templateObject_11 || (templateObject_11 = tslib_1.__makeTemplateObject([\"Synkronisering med framg\\u00E5ng\"], [\"Synkronisering med framg\\u00E5ng\"]))));\r\n                        return [3 /*break*/, 6];\r\n                    case 5:\r\n                        showError(L(templateObject_12 || (templateObject_12 = tslib_1.__makeTemplateObject([\"Fel vid synkronisering med Classroom\"], [\"Fel vid synkronisering med Classroom\"]))));\r\n                        this.setState({ classroomSyncInProgress: false });\r\n                        _b.label = 6;\r\n                    case 6: return [3 /*break*/, 8];\r\n                    case 7:\r\n                        err_2 = _b.sent();\r\n                        catcher;\r\n                        return [3 /*break*/, 8];\r\n                    case 8: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype._save = function (silentSave) {\r\n        if (silentSave === void 0) { silentSave = false; }\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, course, origCourse, origTemplate, doesAllTasksCoverAllRequirements, modifiedCourse, batch, orig, newCourseTasks, tags, isExistingCourse, schoolId, schoolId, schoolId, conflictedCourses, res;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.state, course = _a.course, origCourse = _a.origCourse, origTemplate = _a.origTemplate;\r\n                        doesAllTasksCoverAllRequirements = getUncoveredKnowledgeRequirements(course).length === 0;\r\n                        !silentSave && showInfo(L(templateObject_13 || (templateObject_13 = tslib_1.__makeTemplateObject([\"Sparar...\"], [\"Sparar...\"]))));\r\n                        modifiedCourse = updateModificationStamp(Date.now(), course, env.currentUser);\r\n                        batch = new BatchRunner();\r\n                        orig = origCourse || origTemplate;\r\n                        newCourseTasks = modifiedCourse.tasks.map(function (task) {\r\n                            if (task.$meta === 'add' || task.$meta === 'update') {\r\n                                var origTask = orig.tasks.find(function (t) { return t.id === task.id; });\r\n                                return updateDocumentGraphs(origTask || {}, task, \"tasks\", {\r\n                                    knowledgeRequirements: 'knowledge-requirements',\r\n                                    centralContent: 'central-content',\r\n                                    abilities: 'abilities'\r\n                                }, batch);\r\n                            }\r\n                            else {\r\n                                var updatedTask = tslib_1.__assign({}, task);\r\n                                delete updatedTask.$meta;\r\n                                return updatedTask;\r\n                            }\r\n                        });\r\n                        modifiedCourse = update(modifiedCourse, { tasks: { $set: newCourseTasks } });\r\n                        modifiedCourse = updateDocumentGraphs(origCourse || {}, modifiedCourse, 'courses', {\r\n                            templateChain: 'courses',\r\n                            centralContent: 'central-content',\r\n                            knowledgeRequirements: 'knowledge-requirements',\r\n                            abilities: 'abilities',\r\n                            images: 'images',\r\n                            tasks: 'tasks'\r\n                        }, batch);\r\n                        modifiedCourse = tslib_1.__assign({}, modifiedCourse);\r\n                        modifiedCourse.publishable = doesAllTasksCoverAllRequirements;\r\n                        tags = (modifiedCourse.tags || []).filter(function (tag) { return tag !== 'incomplete'; });\r\n                        modifiedCourse.tags = modifiedCourse.publishable ?\r\n                            tags : tags.concat(\"incomplete\");\r\n                        isExistingCourse = origCourse && !this.props.customParams;\r\n                        if (!!isExistingCourse) return [3 /*break*/, 3];\r\n                        // A new course should be added:\r\n                        batch.add('courses', modifiedCourse);\r\n                        if (!course.school) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, mySchoolCoursesRepo.getSchoolId()];\r\n                    case 1:\r\n                        schoolId = _b.sent();\r\n                        batch.link(\"schools\", schoolId, \"courses\", course.id, \"courses\");\r\n                        if (course.active) {\r\n                            batch.link(\"schools\", schoolId, \"courses\", course.id, \"activeCourses\");\r\n                        }\r\n                        _b.label = 2;\r\n                    case 2: return [3 /*break*/, 7];\r\n                    case 3:\r\n                        // An existing course should be updated:\r\n                        batch.put('courses', modifiedCourse);\r\n                        if (!(!origCourse.active && course.active)) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, mySchoolCoursesRepo.getSchoolId()];\r\n                    case 4:\r\n                        schoolId = _b.sent();\r\n                        batch.link(\"schools\", schoolId, \"courses\", course.id, \"activeCourses\");\r\n                        return [3 /*break*/, 7];\r\n                    case 5:\r\n                        if (!(origCourse.active && !course.active)) return [3 /*break*/, 7];\r\n                        return [4 /*yield*/, mySchoolCoursesRepo.getSchoolId()];\r\n                    case 6:\r\n                        schoolId = _b.sent();\r\n                        batch.unlink(\"schools\", schoolId, \"courses\", course.id, \"activeCourses\");\r\n                        _b.label = 7;\r\n                    case 7:\r\n                        if (!(modifiedCourse.subjectCode === 'custom')) return [3 /*break*/, 9];\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"courses\", {\r\n                                tags: [\"course:\" + modifiedCourse.code]\r\n                            })];\r\n                    case 8:\r\n                        conflictedCourses = _b.sent();\r\n                        conflictedCourses = conflictedCourses.filter(function (c) { return c.id !== modifiedCourse.id; });\r\n                        conflictedCourses = conflictedCourses.filter(function (c) { return c.subjectCode !== \"custom\"; });\r\n                        if (conflictedCourses.length > 0) {\r\n                            throw new Error(L(templateObject_14 || (templateObject_14 = tslib_1.__makeTemplateObject([\"Kursens kurskod f\\u00E5r inte vara samma som kurskoder fr\\u00E5n skolverket: \", \"\"], [\"Kursens kurskod f\\u00E5r inte vara samma som kurskoder fr\\u00E5n skolverket: \", \"\"])), modifiedCourse.code));\r\n                        }\r\n                        _b.label = 9;\r\n                    case 9: return [4 /*yield*/, env.kedBackendClient.batch(batch.mutationRequests)];\r\n                    case 10:\r\n                        res = _b.sent();\r\n                        !silentSave && showInfo(isExistingCourse ? L(templateObject_15 || (templateObject_15 = tslib_1.__makeTemplateObject([\"\\u00C4ndringarna har sparats\"], [\"\\u00C4ndringarna har sparats\"]))) : L(templateObject_16 || (templateObject_16 = tslib_1.__makeTemplateObject([\"Kursen har skapats\"], [\"Kursen har skapats\"]))));\r\n                        // Update state to reflect what has been posted:\r\n                        if (res && res.newEtags)\r\n                            modifiedCourse = applyEtags(modifiedCourse, res.newEtags, [\"images\", \"tasks\"]);\r\n                        if (course.school === env.currentUser.school) {\r\n                            // Update mySchoolCoursesRepo\r\n                            if (!isExistingCourse) {\r\n                                mySchoolCoursesRepo.insert(modifiedCourse);\r\n                            }\r\n                            else {\r\n                                mySchoolCoursesRepo.update(modifiedCourse);\r\n                            }\r\n                        }\r\n                        return [4 /*yield*/, this.setNonSaveableDataState({ course: modifiedCourse, origCourse: modifiedCourse, hasUnsavedData: false })];\r\n                    case 11:\r\n                        _b.sent();\r\n                        updateCourseBuilderStatus('');\r\n                        if (!isExistingCourse) {\r\n                            // This was the creation of a new course. Correct the route now when the user enters an edit state:\r\n                            location.hash = \"#/courses/\" + modifiedCourse.id + \"/edit\";\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditCourse.prototype._checkClassroomChanges = function () {\r\n        var _a = this.state, course = _a.course, origCourse = _a.origCourse;\r\n        var arr1set = course.tasks.filter(function (x) { return x.assignment; });\r\n        if (!origCourse) {\r\n            course.inSyncWithClassroom = false;\r\n            this.setStatePromised({ course: course });\r\n            return;\r\n        }\r\n        //if (course.inSyncWithClassroom) {\r\n        var arr2set = origCourse.tasks.filter(function (x) { return x.assignment; });\r\n        //check tasks added or removed\r\n        var hasTeacherChanges = hasChanges(origCourse.responsibleTeachers, course.responsibleTeachers);\r\n        //\r\n        var hasTasksChanges = arr1set.filter(function (x) { return !arr2set.find(function (y) { return y.id == x.id; }); }).length > 0 || arr2set.filter(function (x) { return !arr1set.find(function (y) { return y.id == x.id; }); }).length > 0;\r\n        //check if any task renamed or changed its type\r\n        if (!hasTasksChanges) {\r\n            hasTasksChanges = arr1set.some(function (e1) { return arr2set.find(function (e2) {\r\n                return e2.id === e1.id && e2.name !== e1.name;\r\n            }) != null; });\r\n        }\r\n        var hasStudyGroupsChanges = hasChanges(origCourse.studyGroups, course.studyGroups);\r\n        //checks are made with the previous object in case that the user will revert the changes\r\n        var prevStatus = course.inSyncWithClassroom;\r\n        course.inSyncWithClassroom = !(hasTeacherChanges || hasTasksChanges || hasStudyGroupsChanges);\r\n        if (prevStatus != course.inSyncWithClassroom) {\r\n            this.setStatePromised({ course: course });\r\n        }\r\n    };\r\n    EditCourse.prototype.activateAndSave = function () {\r\n        var _this = this;\r\n        var course = tslib_1.__assign({}, this.state.course);\r\n        if (!course.active) {\r\n            /*const uncoveredRequirements = getUncoveredKnowledgeRequirements(course);\r\n            if (uncoveredRequirements.length > 0)\r\n              return showError (L`Det finns kunskapskrav som inte uppfylls av någon modul. Kan inte aktivera kursen förrän alla kunskapskrav finns med.`);\r\n            */\r\n            course.active = true;\r\n            course.activatedBy = {\r\n                name: env.currentUser.displayName,\r\n                url: \"mailto:\" + env.currentUser.mail\r\n            };\r\n            course.activatedDate = Date.now();\r\n            this.setStatePromised({ course: course })\r\n                .then(function () { return _this.save(); })\r\n                .catch(catcher);\r\n        }\r\n    };\r\n    EditCourse.prototype.inactivateAndSave = function () {\r\n        var _this = this;\r\n        var course = tslib_1.__assign({}, this.state.course);\r\n        if (course.active) {\r\n            course.active = false;\r\n            course.inactivatedBy = {\r\n                name: env.currentUser.displayName,\r\n                url: \"mailto:\" + env.currentUser.mail\r\n            };\r\n            course.inactivatedDate = Date.now();\r\n            this.setStatePromised({ course: course })\r\n                .then(function () { return _this.save(); })\r\n                .catch(catcher);\r\n        }\r\n    };\r\n    EditCourse.prototype.openDialog = function (dialogContainer) {\r\n        this.setNonSaveableDataState({ dialogContainers: this.state.dialogContainers.concat(dialogContainer) });\r\n    };\r\n    EditCourse.prototype.closeDialog = function () {\r\n        var dialogContainers = this.state.dialogContainers;\r\n        var length = dialogContainers.length;\r\n        length && this.setNonSaveableDataState({ dialogContainers: dialogContainers.slice(0, length - 1) });\r\n        // Now sync the direct 'dialogs' property with the new state:\r\n        while (this.dialogs.length >= length)\r\n            this.dialogs.pop();\r\n    };\r\n    EditCourse.prototype.refDialog = function (dialog, index) {\r\n        this.dialogs[index] = dialog; // Setting per index instead of push(). Works even if the ref attribute could be invoked multiple times.\r\n    };\r\n    EditCourse.prototype.onKeyDown = function (ev) {\r\n        if (ev.which === 83 && (ev.ctrlKey || ev.metaKey)) { // CTRL-S\r\n            ev.preventDefault();\r\n            if (this.state.dialogContainers.length > 0) {\r\n                this.saveDialog();\r\n                return;\r\n            }\r\n            this.save();\r\n        }\r\n        else if (ev.which === 27 && this.state.dialogContainers.length > 0) {\r\n            this.closeDialog();\r\n            ev.preventDefault();\r\n        }\r\n        else if (ev.which === 13) {\r\n            var targetElem = ev.target;\r\n            if (this.state.dialogContainers.length > 0 &&\r\n                targetElem.tagName !== 'TEXTAREA' &&\r\n                targetElem.tagName !== 'INPUT' &&\r\n                targetElem.tagName !== 'SELECT' &&\r\n                targetElem.tagName !== 'OPTION' &&\r\n                !targetElem.contentEditable) {\r\n                this.saveDialog();\r\n            }\r\n        }\r\n    };\r\n    EditCourse.prototype.beforeUnload = function (ev) {\r\n        if (this.state.dialogContainers.length > 0 || this.state.hasUnsavedData) {\r\n            if (!env.kedBackendClient.http.bearerProvider.wantsRedirect) {\r\n                ev.returnValue = CONFIRM_NAVIGATE_MESSAGE;\r\n                return ev.returnValue;\r\n            }\r\n        }\r\n    };\r\n    EditCourse.prototype.onClickPreventUnload = function (ev) {\r\n        if (ev.target && ('' + ev.target.tagName).toLowerCase() === 'a') {\r\n            var a = ev.target;\r\n            if (a.href && a.getAttribute('href') !== '#' && !a.target) {\r\n                if (this.state.dialogContainers.length > 0 || this.state.hasUnsavedData) {\r\n                    if (!confirm(CONFIRM_NAVIGATE_MESSAGE)) {\r\n                        ev.preventDefault();\r\n                        ev.stopPropagation();\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n    EditCourse.prototype.saveDialog = function () {\r\n        if (this.state.dialogContainers.length > 0) {\r\n            var dialog = this.dialogs[this.state.dialogContainers.length - 1]; // YES, should reference this.dialogs by length of dialogContainers. Strange yes, but leave it so!\r\n            dialog && dialog.save();\r\n        }\r\n    };\r\n    EditCourse.prototype.render = function () {\r\n        var _this = this;\r\n        var isAdmin = env.currentUser.roles.indexOf(\"ADMIN\") >= 0;\r\n        var course = this.state.course;\r\n        return !this.state.course ? React.createElement(\"div\", { style: { outline: 0 } },\r\n            React.createElement(CourseBanner, { title: \"\", activePage: this.state.view, routes: { feedback: this.props.feedbackUrl } }),\r\n            React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null),\r\n                \"V.g. v\\u00E4nta medan kursen laddas...\")) :\r\n            React.createElement(\"div\", { style: { outline: 0 } },\r\n                React.createElement(CourseBanner, { title: course.name + \" - \" + course.points + \"p\", activePage: this.state.view, routes: {\r\n                        studentPage: preserveImpersonationQuery(this.props.viewCourseUrl, { courseId: this.props.id }),\r\n                        feedback: this.props.feedbackUrl\r\n                    }, host: this, course: course, origCourse: this.state.origCourse, backgroundImage: course.images.filter(function (img) { return img.id === course.imageId; }).map(function (img) { return img.url; })[0], isTemplate: course.isTemplate }),\r\n                React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n                    React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-12\" },\r\n                        React.createElement(\"div\", { className: \"sv-spacer-20pxvt sv-vertical sv-layout sv-skip-spacer\" },\r\n                            React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\", ref: function (div) { return _this.contentDiv = div; } },\r\n                                React.createElement(InnerEditCourse, { course: this.state.course, origCourse: this.state.origCourse, host: this }),\r\n                                React.createElement(\"br\", null),\r\n                                this.state.dialogContainers.map(function (_a, i) {\r\n                                    var Component = _a.Component, props = _a.props;\r\n                                    return React.createElement(\"div\", { key: i },\r\n                                        React.createElement(\"div\", { className: \"darken\" }),\r\n                                        React.createElement(\"div\", { className: \"modal-page-wrap\" },\r\n                                            React.createElement(\"div\", { className: \"modal-page\" },\r\n                                                React.createElement(Component, tslib_1.__assign({ ref: function (dialog) { return _this.refDialog(dialog, i); } }, props)),\r\n                                                React.createElement(RemoveItem, { onClick: function () { return _this.closeDialog(); } }))));\r\n                                }))))));\r\n    };\r\n    return EditCourse;\r\n}(React.Component));\r\nexport { EditCourse };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8, templateObject_9, templateObject_10, templateObject_11, templateObject_12, templateObject_13, templateObject_14, templateObject_15, templateObject_16;\r\n","export { EditCourse } from './edit-course';\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditableResourceList } from '../sub-components/editable-resource-list';\r\nimport { dtFormat } from '../utils';\r\nimport { CourseModuleList } from './course-module-list';\r\nimport { SchoolCourses } from '../sub-components/school-courses';\r\nimport { getUncoveredKnowledgeRequirements, sanityCheck, getIdsNotCoveredByTasks, getSoftAccessList } from './business-logic';\r\nimport { setCourseImage } from \"./course-banner\";\r\nimport { Spinner } from '../sub-components/spinner';\r\nimport { EditableTeacherList } from '../sub-components/editable-teacher-list';\r\nimport { showError, L } from \"../../../utils/utils\";\r\nimport { WeightedItemsTable } from '../sub-components/weighted-items-table';\r\nimport { Wysiwyg } from '../../utility-components/wysiwyg/index';\r\nimport actions_swedish from '../../utility-components/wysiwyg/actions-sv';\r\nimport { EditableWorkFlowLink } from '../sub-components/editable-workflow-link';\r\nimport { getCurrentUser } from '../../../globals/current-user';\r\nimport { Observe } from '../../utility-components/observe';\r\nimport { SelectStudyGroups } from '../sub-components/select-study-groups';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nimport { features } from '../../../features';\r\nimport { TextInput } from '../../utility-components/form-field-text-input';\r\nimport { AlignHorizontal } from '../../utility-components/align-horizontal';\r\nimport { HorizontalItem } from '../../utility-components/horizontal-item';\r\n;\r\nvar InnerEditCourse = /** @class */ (function (_super) {\r\n    tslib_1.__extends(InnerEditCourse, _super);\r\n    function InnerEditCourse(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            changeImageUrl: false\r\n        };\r\n        return _this;\r\n    }\r\n    InnerEditCourse.prototype.setImageUrl = function (imageUrl) {\r\n        var course = this.props.course;\r\n        if (!course.imageId) {\r\n        }\r\n    };\r\n    InnerEditCourse.prototype.render = function () {\r\n        var _a = this.props, course = _a.course, origCourse = _a.origCourse, host = _a.host;\r\n        var uncoveredKnowledgeRequirements = getUncoveredKnowledgeRequirements(course);\r\n        var idsNotCoveredByAnyTask = getIdsNotCoveredByTasks(course);\r\n        var sanityCheckWarnings = sanityCheck(course);\r\n        var courseImage = course.images.find(function (img) { return img.id === course.imageId; });\r\n        var courseImageIsDataUrl = courseImage && courseImage.url.startsWith('data:');\r\n        var courseIsUploaded = courseImage && courseImage.url.indexOf('storage.googleapis.com') > 0;\r\n        var softAccessList = getSoftAccessList(course);\r\n        var currentUser = getCurrentUser();\r\n        var canDelete = !features.teacherRights || softAccessList.some(function (user) { return user.email === currentUser.mail && user.access === 'full'; });\r\n        var displayStudyGroups = features.studyGroups;\r\n        return React.createElement(\"div\", { className: \"sv-row sv-layout sv-skip-spacer\" },\r\n            React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-7\" },\r\n                React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                    course.isTemplate && React.createElement(\"h1\", null, \"Kursmall\"),\r\n                    React.createElement(\"h2\", null, \"Kurs\\u00F6vergripande\"),\r\n                    React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, \"Kurs\\u00F6vergripande\"), headerOpen: true, inactivated: !features.cbCollapseBoxes },\r\n                        React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                            React.createElement(\"div\", null,\r\n                                course.subjectId === \"custom\" && React.createElement(React.Fragment, null,\r\n                                    React.createElement(\"h3\", null, \"Kursens namn och po\\u00E4ng\"),\r\n                                    React.createElement(AlignHorizontal, null,\r\n                                        React.createElement(HorizontalItem, null,\r\n                                            React.createElement(TextInput, { id: \"customCourseName\", autoFocus: true, label: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kursens namn\"], [\"Kursens namn\"]))), value: course.name, onChange: function (value) { return host.update({ name: { $set: value } }); } })),\r\n                                        React.createElement(HorizontalItem, null,\r\n                                            React.createElement(TextInput, { id: \"customCourseCode\", label: L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Kurskod\"], [\"Kurskod\"]))), size: 12, value: course.code || '', onChange: function (courseCode) { return host.update({ code: { $set: courseCode } }); } }))),\r\n                                    React.createElement(TextInput, { id: \"customCoursePoints\", label: L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Po\\u00E4ng\"], [\"Po\\u00E4ng\"]))), size: 3, value: '' + (course.points || ''), onChange: function (value) {\r\n                                            var numPoints = value ? parseInt(value) : 0;\r\n                                            if (!isNaN(numPoints) && numPoints < 1000) {\r\n                                                host.update({ points: { $set: { numPoints: numPoints } } });\r\n                                            }\r\n                                        } }),\r\n                                    React.createElement(\"br\", null)),\r\n                                React.createElement(\"h3\", null, \"Kursens bild\"),\r\n                                courseImageIsDataUrl ?\r\n                                    React.createElement(\"p\", null, \"Kursens bild ligger i databasen. F\\u00F6r att \\u00E4ndra bild m\\u00E5ste du dra och sl\\u00E4ppa en ny bild ovanp\\u00E5 den gamla h\\u00F6gst upp p\\u00E5 denna sida. Bilden kan antingen vara fr\\u00E5n en annan webbsida. Lokala bildfiler g\\u00E5r ocks\\u00E5 bra att dra och sl\\u00E4ppa.\")\r\n                                    : courseIsUploaded ? React.createElement(\"p\", null, \"Kursens bild ligger i Kunskapsskolans Google moln. F\\u00F6r att \\u00E4ndra bild m\\u00E5ste du dra och sl\\u00E4ppa en ny bild ovanp\\u00E5 den gamla h\\u00F6gst upp p\\u00E5 denna sida. Bilden kan antingen vara fr\\u00E5n en annan webbsida. Lokala bildfiler g\\u00E5r ocks\\u00E5 bra att dra och sl\\u00E4ppa.\") : courseImage ? React.createElement(\"div\", null,\r\n                                        React.createElement(\"textarea\", { value: courseImage.url, style: { width: '100%', height: '30px' }, onChange: function (ev) { return setCourseImage(course, origCourse, host, ev.target.value); } }),\r\n                                        React.createElement(\"p\", null, \"Bilden som visas h\\u00F6gst upp h\\u00E4mtas fr\\u00E5n angiven URL. F\\u00F6r att \\u00E4ndra bild kan du redigera URL ovan. Ett annat s\\u00E4tt att \\u00E4ndra bild \\u00E4r att dra och sl\\u00E4ppa en ny bild \\u00F6ver den gamla h\\u00F6gst upp p\\u00E5 sidan.\")) :\r\n                                        React.createElement(\"p\", null, \"Kursen saknar egen bild. L\\u00E4gg till en bild genom att dra och sl\\u00E4ppa en bild p\\u00E5 kurs-bannern h\\u00F6gst upp p\\u00E5 den h\\u00E4r sidan.\"),\r\n                                React.createElement(\"br\", null)),\r\n                            !course.isTemplate && React.createElement(\"div\", null,\r\n                                React.createElement(\"h3\", null, \"Beskrivning\"),\r\n                                React.createElement(\"p\", { className: \"subHeader\" }, \"(Beskrivning av kursen. F\\u00F6r att skilja mellan olika varianter av samma gymnasiekurs)\"),\r\n                                React.createElement(\"textarea\", { className: \"inputTextBox inputTextSmall\", value: course.description, onChange: function (ev) { return host.update({ description: { $set: ev.target.value } }); } }),\r\n                                React.createElement(\"br\", null)),\r\n                            React.createElement(\"div\", null,\r\n                                React.createElement(\"h3\", null, \"Upptaktstext\"),\r\n                                React.createElement(\"p\", { className: \"subHeader\" }, \"(texten ska visas p\\u00E5 kursens upptaktssektion)\"),\r\n                                React.createElement(Wysiwyg, { html: course.runUpText, defaultActions: actions_swedish, actions: [\r\n                                        \"bold\",\r\n                                        \"italic\",\r\n                                        \"underline\",\r\n                                        \"strikethrough\",\r\n                                        \"heading2\",\r\n                                        \"heading3\",\r\n                                        \"olist\",\r\n                                        \"ulist\",\r\n                                        \"outdent\",\r\n                                        \"indent\",\r\n                                        \"line\",\r\n                                        \"link\",\r\n                                        \"image\"\r\n                                    ], onChange: function (newHtml) { return host.update({ runUpText: { $set: newHtml } }); } }),\r\n                                React.createElement(\"br\", null)),\r\n                            React.createElement(\"h3\", null, \"Kursresurser\"),\r\n                            React.createElement(\"p\", { className: \"subHeader\" }, \"(Resurser f\\u00F6r upptakt och kursen som helhet)\"),\r\n                            React.createElement(EditableResourceList, { resources: course.resources, onUpdate: function (resourcesUpdates) { return host.update({ resources: resourcesUpdates }); }, host: host }),\r\n                            React.createElement(\"br\", null),\r\n                            React.createElement(\"h3\", null, \"Arbetsg\\u00E5ng\"),\r\n                            React.createElement(\"p\", { className: \"subHeader\" }, \"(Eventuell l\\u00E4nk till arbetsg\\u00E5ng f\\u00F6r kursen)\"),\r\n                            React.createElement(EditableWorkFlowLink, { url: course.workFlowLink, onUpdate: function (updates) { return host.update({ workFlowLink: updates }); }, host: host }),\r\n                            React.createElement(\"br\", null),\r\n                            !course.isTemplate && React.createElement(\"div\", null,\r\n                                React.createElement(\"h3\", null, \"Google Classroom\"),\r\n                                displayStudyGroups ? React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                        React.createElement(\"div\", { className: \"checkBox\" + (course.googleCreateClassrooms ? \" checked\" : \"\"), onClick: function () { host.update({ googleCreateClassrooms: { $set: !course.googleCreateClassrooms } }); } })),\r\n                                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Skapa klassrum f\\u00F6r kursen\"))\r\n                                    :\r\n                                        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                                            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                                React.createElement(\"input\", { placeholder: \"Google classroom URL\", type: \"text\", size: 30, value: course.googleClassRoomURL, onChange: function (ev) { return host.update({ googleClassRoomURL: { $set: ev.target.value } }); } })),\r\n                                            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                                                React.createElement(\"input\", { placeholder: \"kod\", type: \"text\", size: 8, value: course.googleClassRoomCode, onChange: function (ev) { return host.update({ googleClassRoomCode: { $set: ev.target.value } }); } })))),\r\n                            course.isTemplate ? null : React.createElement(React.Fragment, null,\r\n                                React.createElement(EditableTeacherList, { school: course.school, teachers: course.responsibleTeachers, onUpdate: function (teachersUpdate) {\r\n                                        host.update({ responsibleTeachers: { $set: teachersUpdate } });\r\n                                    } }),\r\n                                React.createElement(\"br\", null),\r\n                                displayStudyGroups && React.createElement(\"div\", { className: \"select-studygroups\" },\r\n                                    React.createElement(\"h3\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Undervisningsgrupper\"], [\"Undervisningsgrupper\"])))),\r\n                                    React.createElement(Observe, { fallback: React.createElement(Spinner, null), errorFallback: L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Kunde inte ladda undervisningsgrupper fr\\u00E5n EDS\"], [\"Kunde inte ladda undervisningsgrupper fr\\u00E5n EDS\"]))) },\r\n                                        React.createElement(SelectStudyGroups, { school: course.school, courseCode: course.code, selectedStudyGroups: course.studyGroups || [], onUpdate: function (studyGroups) { return host.update({ studyGroups: { $set: studyGroups } }); }, placeholder: L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Koppla undervisningsgrupper till kursen...\"], [\"Koppla undervisningsgrupper till kursen...\"]))) })))))),\r\n                    React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                        React.createElement(\"div\", { id: \"Kursensmoduler\" }),\r\n                        React.createElement(\"h2\", null, \"Kursens moduler\"),\r\n                        React.createElement(\"hr\", null)),\r\n                    React.createElement(CourseModuleList, { host: host, course: course, idsNotCoveredByAnyTask: idsNotCoveredByAnyTask }),\r\n                    React.createElement(\"div\", null,\r\n                        React.createElement(\"br\", null),\r\n                        React.createElement(WeightedItemsTable, { course: course })),\r\n                    React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                        React.createElement(\"h2\", null, \"Kursens status\"),\r\n                        React.createElement(\"hr\", null),\r\n                        course.createdBy && course.createdDate && React.createElement(\"p\", null,\r\n                            \"Kursen skapades \",\r\n                            dtFormat(course.createdDate),\r\n                            \" av \",\r\n                            React.createElement(\"strong\", null, course.createdBy.name),\r\n                            \".\"),\r\n                        course.modifiedBy && course.modifiedDate && React.createElement(\"p\", null,\r\n                            \"Kursen redigerades senast \",\r\n                            dtFormat(course.modifiedDate),\r\n                            \" av \",\r\n                            React.createElement(\"strong\", null, course.modifiedBy.name),\r\n                            \".\"),\r\n                        course.active ? React.createElement(\"p\", null,\r\n                            \"Kursen \\u00E4r \",\r\n                            React.createElement(\"strong\", null, \"AKTIV\"),\r\n                            \" sedan \",\r\n                            dtFormat(course.activatedDate),\r\n                            \" av \",\r\n                            React.createElement(\"strong\", null, course.activatedBy.name),\r\n                            \".\") : React.createElement(\"p\", null,\r\n                            \"Kursen \\u00E4r \",\r\n                            React.createElement(\"strong\", null, \"INAKTIV\"),\r\n                            course.inactivatedBy ? React.createElement(\"span\", null,\r\n                                \"sedan \",\r\n                                dtFormat(course.inactivatedDate),\r\n                                \" av \",\r\n                                React.createElement(\"strong\", null, course.inactivatedBy.name),\r\n                                \".\") : React.createElement(\"span\", null, \".\")),\r\n                        (uncoveredKnowledgeRequirements.length === 0 ?\r\n                            React.createElement(\"p\", { className: \"markedGreen\" }, \"Modulernas kunskapskrav t\\u00E4cker skolverkets krav f\\u00F6r denna kurs\") :\r\n                            React.createElement(\"div\", { className: \"markedRed warning-box\" },\r\n                                React.createElement(\"div\", { className: \"warningFlag\" },\r\n                                    React.createElement(\"i\", { className: \"fa fa-exclamation-triangle\", \"aria-hidden\": \"true\" })),\r\n                                React.createElement(\"p\", null, \"Modulernas kunskapskrav t\\u00E4cker inte skolverkets krav f\\u00F6r denna kurs.\"))),\r\n                        sanityCheckWarnings.map(function (warning) { return React.createElement(\"div\", { key: warning, className: \"markedRed warning-box\" },\r\n                            React.createElement(\"div\", { className: \"warningFlag\" },\r\n                                React.createElement(\"i\", { className: \"fa fa-exclamation-triangle\", \"aria-hidden\": \"true\" })),\r\n                            React.createElement(\"p\", null, warning)); }),\r\n                        React.createElement(\"br\", null),\r\n                        React.createElement(\"div\", { className: \"btn btn-large\", onClick: function () { return host.confirmSaveAndSync(); } }, \"Spara\"),\r\n                        course.active ?\r\n                            React.createElement(\"div\", { className: \"btn btn-info btn-large\", onClick: function () { return host.inactivateAndSave(); } }, \"Inaktivera och spara\") :\r\n                            React.createElement(\"div\", { className: \"btn btn-info btn-large\", onClick: function () { return host.activateAndSave(); } }, \"Aktivera och spara\")),\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                        canDelete && !course.isTemplate && (origCourse ? React.createElement(\"div\", { className: \"btn btn-warning btn-large pull-right\", onClick: function () {\r\n                                if (confirm(L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Bekr\\u00E4fta borttagning av kursen \\\"\", \" - \", \"\\\" f\\u00F6r skolan \", \"\\n\\nKursen kommar att raderas helt!\\n\\n\\u00C4r du s\\u00E4ker?\"], [\"Bekr\\u00E4fta borttagning av kursen \\\"\", \" - \", \"\\\" f\\u00F6r skolan \", \"\\\\n\\\\nKursen kommar att raderas helt!\\\\n\\\\n\\u00C4r du s\\u00E4ker?\"])), course.name, course.description, course.school)))\r\n                                    host.deleteCourse().catch(showError);\r\n                            } }, \"Ta bort kurs\") : React.createElement(\"div\", { className: \"btn btn-warning btn-large pull-right\", onClick: function () { return history.go(-1); } }, \"Avbryt\")),\r\n                        course.googleCreateClassrooms && displayStudyGroups &&\r\n                            React.createElement(\"div\", { className: \"btn btn-primary btn-large pull-right\", onClick: function () { return host.syncWithClassroomAndSave(); } },\r\n                                host.syncInProgress() ? React.createElement(Spinner, null) :\r\n                                    (course.inSyncWithClassroom ? React.createElement(\"span\", null,\r\n                                        React.createElement(\"i\", { className: \"fas fa-check\", \"aria-hidden\": \"true\" })) : React.createElement(\"span\", null,\r\n                                        React.createElement(\"i\", { className: \"fas fa-code-branch\" }))),\r\n                                \"\\u00A0Synk med Classroom\")))),\r\n            React.createElement(\"div\", { className: \"sv-layout sv-column-5\" },\r\n                React.createElement(SchoolCourses, null)));\r\n    };\r\n    return InnerEditCourse;\r\n}(React.Component));\r\nexport { InnerEditCourse };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../utils/utils';\r\nimport { HashRouter as Router, Route } from 'react-router-dom';\r\nimport { ErrorSuccessFeedback } from '../../utils/error-success-feedback';\r\nimport { Schools } from './schools';\r\nimport { NewSchool } from './schools/new-school';\r\nimport env from '../../globals/KED.env';\r\n// Views\r\nimport { Subjects, ShowSubject } from './subjects';\r\nimport { EditCourse } from './courses';\r\nimport { EditSchool } from \"./schools/edit-school\";\r\nimport { CourseBanner } from \"./courses/course-banner\";\r\nimport { CreateNewCourse } from \"./courses/create-new\";\r\n// Keep Session Alive\r\nimport { keepSessionAlive } from '../../utils/keep-session-alive';\r\nkeepSessionAlive();\r\nvar CourseBuilder = /** @class */ (function (_super) {\r\n    tslib_1.__extends(CourseBuilder, _super);\r\n    function CourseBuilder(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    CourseBuilder.prototype.render = function () {\r\n        var _this = this;\r\n        var isAuthorized = env.currentUser.roles.some(function (role) { return role === \"ADMIN\" || role === \"EMPLOYEE\"; });\r\n        var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n        return React.createElement(\"div\", { className: \"course-builder\" },\r\n            React.createElement(Router, null, isAuthorized ? React.createElement(\"div\", null,\r\n                React.createElement(Route, { exact: true, path: \"/\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return isAdmin ?\r\n                            React.createElement(Schools, { viewCourseUrl: _this.props.viewCourseUrl, feedbackUrl: _this.props.feedbackUrl }) :\r\n                            React.createElement(CreateNewCourse, { feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { exact: true, path: \"/schools\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(Schools, { viewCourseUrl: _this.props.viewCourseUrl, feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { exact: true, path: \"/schools/new/gymnasium\", render: function () { return React.createElement(NewSchool, { type: \"gymnasium\", feedbackUrl: _this.props.feedbackUrl }); } }),\r\n                React.createElement(Route, { exact: true, path: \"/schools/new/primary\", render: function () { return React.createElement(NewSchool, { type: \"primary\", feedbackUrl: _this.props.feedbackUrl }); } }),\r\n                React.createElement(Route, { exact: true, path: \"/schools/:id/edit\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(EditSchool, { id: match.params.id, title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Editera skola\"], [\"Editera skola\"]))), feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { exact: true, path: \"/subjects\", render: function () { return React.createElement(Subjects, { feedbackUrl: _this.props.feedbackUrl }); } }),\r\n                React.createElement(Route, { path: \"/subjects/:id\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(ShowSubject, { id: match.params.id, feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { exact: true, path: \"/courses/new\", render: function () { return React.createElement(CreateNewCourse, { feedbackUrl: _this.props.feedbackUrl }); } }),\r\n                React.createElement(Route, { path: \"/courses/create-from-template/:templateId\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(EditCourse, { templateId: match.params.templateId, view: \"courseBuilder\", viewCourseUrl: _this.props.viewCourseUrl, feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { path: \"/courses/create-custom/:customParams\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(EditCourse, { customParams: JSON.parse(decodeURIComponent(match.params.customParams)), view: \"courseBuilder\", viewCourseUrl: _this.props.viewCourseUrl, feedbackUrl: _this.props.feedbackUrl });\r\n                    } }),\r\n                React.createElement(Route, { path: \"/courses/:id/edit\", render: function (_a) {\r\n                        var match = _a.match;\r\n                        return React.createElement(EditCourse, { id: match.params.id, view: \"courseBuilder\", viewCourseUrl: _this.props.viewCourseUrl, feedbackUrl: _this.props.feedbackUrl });\r\n                    } })) : React.createElement(\"div\", null,\r\n                React.createElement(Route, { path: \"/\", render: function () { return React.createElement(\"div\", null,\r\n                        React.createElement(CourseBanner, { title: \"Kursbyggaren\", activePage: \"courseBuilder\", routes: { feedback: _this.props.feedbackUrl } }),\r\n                        React.createElement(\"h2\", null, \"Beh\\u00F6righet saknas\"),\r\n                        React.createElement(\"p\", null, \"Detta verktyg \\u00E4r endast till f\\u00F6r anst\\u00E4llda p\\u00E5 Kunskapsskolan.\"),\r\n                        React.createElement(\"h3\", null, \"Anv\\u00E4ndarattribut\"),\r\n                        React.createElement(\"table\", { className: \"ked_boxed\", style: { border: \"1px solid #eee\" } },\r\n                            React.createElement(\"thead\", null,\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Attribut\"),\r\n                                    React.createElement(\"th\", null, \"V\\u00E4rde\"))),\r\n                            React.createElement(\"tbody\", null, Object.keys(env.currentUser).map(function (attr) { return React.createElement(\"tr\", { key: attr },\r\n                                React.createElement(\"td\", null, attr),\r\n                                React.createElement(\"td\", null, env.currentUser[attr])); })))); } }))),\r\n            React.createElement(ErrorSuccessFeedback, null));\r\n    };\r\n    return CourseBuilder;\r\n}(React.Component));\r\nexport { CourseBuilder };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport { flatten } from '../../utils/utils';\r\n//get sentences by requirement\r\nexport function getRequirmentSentences(requirement) {\r\n    return requirement.split(\".\").filter(function (e) { return e; });\r\n}\r\n//retrieve sentences\r\nexport function getSavedSentences(partialRequirments) {\r\n    return partialRequirments.map(function (obj) {\r\n        return obj.trim();\r\n    }) || [];\r\n}\r\n//check all requirements are marked\r\nexport function allRequirementSentecesMarked(requirementName, partialRequirements) {\r\n    var textSentences = getRequirmentSentences(requirementName);\r\n    return partialRequirements && partialRequirements.length === textSentences.length;\r\n    ;\r\n}\r\n//get the partial saved sentences for the default view\r\nexport function getPartialContentDefaultView(requirement, partialRequirments, alreadyCoveredPartialRequirments, skipNotMarked) {\r\n    var resultedHtml = requirement.name;\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n    var allReqCoveredSentence = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n    var allReqSentencesMarked = allRequirementSentecesMarked(requirement.name, rowRequirments);\r\n    textSentences.forEach(function (sentence) {\r\n        //trimm current sentence\r\n        var trimmedSentence = sentence.trim();\r\n        var fullSentence = sentence + \".\";\r\n        if (rowRequirments && rowRequirments.includes(trimmedSentence) && !allReqSentencesMarked) {\r\n            resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedGreen\" + \">\" + fullSentence + \"</span>\");\r\n        }\r\n        else {\r\n            var coveredSentece = allReqCoveredSentence && allReqCoveredSentence.includes(trimmedSentence);\r\n            if (coveredSentece) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span>\" + fullSentence + \"</span>\");\r\n            }\r\n            else if (!allReqSentencesMarked && allReqCoveredSentence && allReqCoveredSentence.length > 0) {\r\n                resultedHtml = resultedHtml.replace(fullSentence, \"<span class=\" + \"markedRed\" + \">\" + fullSentence + \"</span>\");\r\n            }\r\n        }\r\n    });\r\n    return resultedHtml;\r\n}\r\n//check the current requirement is already covered\r\nexport function isPartialCoveredRequirment(requirement, alreadyCoveredPartialRequirments) {\r\n    var textSentences = getRequirmentSentences(requirement.name);\r\n    var result = false;\r\n    for (var i = 0; i < textSentences.length; i++) {\r\n        var trimmedSentence = textSentences[i].trim();\r\n        var allCoveredSentenceReq = alreadyCoveredPartialRequirments && getCoveredSenteces(alreadyCoveredPartialRequirments, requirement.id);\r\n        var coveredSentece = allCoveredSentenceReq && allCoveredSentenceReq.includes(trimmedSentence);\r\n        if (coveredSentece) {\r\n            result = true;\r\n            break;\r\n        }\r\n    }\r\n    return result;\r\n}\r\n//compute the covered senteces excluding the current requirement\r\nexport function getCoveredSenteces(allReq, requirementId) {\r\n    var resultArray = [];\r\n    allReq.forEach(function (obj) {\r\n        var assignedReq = Object.assign([], Object.keys(obj).filter(function (reqId) { return reqId == requirementId; }).map(function (k) { return obj[k].map(function (elem) { return elem.trim(); }); }));\r\n        resultArray.push.apply(resultArray, tslib_1.__spread(assignedReq));\r\n    });\r\n    return flatten(resultArray);\r\n}\r\n//sort the selected sentences by the order of the appearance in the requirement\r\nexport function getSortedRequirments(textSentences, partialRequirments) {\r\n    var output = [];\r\n    var indexedSentences = textSentences.map(function (e, i) { return { ind: i, val: e }; });\r\n    output = indexedSentences.filter(function (s) { return partialRequirments.includes(s.val); });\r\n    return output ? output.sort(function (x, y) { return x.ind > y.ind ? 1 : -1; }).map(function (s) { return s.val; }) : [];\r\n}\r\nexport function getMigrationTitle(isMigrated, markMode) {\r\n    return isMigrated ?\r\n        markMode ?\r\n            \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n            \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n        undefined;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { dtFormat } from '../utils';\r\nimport validUrl from 'valid-url';\r\nvar EditResource = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditResource, _super);\r\n    function EditResource(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = _this.props.resource || { name: '', url: '' };\r\n        return _this;\r\n    }\r\n    EditResource.prototype.save = function () {\r\n        var resource = this.state;\r\n        if (!validUrl.isUri(resource.url))\r\n            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med exempelvis http:, https: eller mailto:\"], [\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med exempelvis http:, https: eller mailto:\"])), resource.url));\r\n        this.props.onSave(resource);\r\n    };\r\n    EditResource.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, onSave = _a.onSave, onDelete = _a.onDelete;\r\n        var resource = this.state;\r\n        var isValidUrl = validUrl.isUri(this.state.url);\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, title),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Namn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: true, tabIndex: 1, size: 50, value: resource.name, onChange: function (ev) { return _this.setState({ name: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"L\\u00E4nk:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top \" },\r\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, value: resource.url, onChange: function (ev) { return _this.setState({ url: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                (resource.createdDate || resource.modifiedDate) && React.createElement(\"div\", null,\r\n                    resource.createdDate && React.createElement(\"p\", null,\r\n                        \"Resursen/L\\u00E4nken skapades \",\r\n                        dtFormat(resource.createdDate),\r\n                        \" av \",\r\n                        React.createElement(\"strong\", null, resource.createdBy.name),\r\n                        \".\"),\r\n                    resource.modifiedDate && React.createElement(\"p\", null,\r\n                        \"Resursen/L\\u00E4nken redigerades senast \",\r\n                        dtFormat(resource.modifiedDate),\r\n                        \" av \",\r\n                        React.createElement(\"strong\", null, resource.modifiedBy.name),\r\n                        \".\"),\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(\"br\", null)),\r\n                onDelete && React.createElement(\"div\", { tabIndex: 2, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return onDelete(); } }, \"Ta bort resurs/l\\u00E4nk\"),\r\n                React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-large\" + (isValidUrl ? \"\" : \" btn-inactive\"), onClick: isValidUrl && (function () { return onSave(resource); }) }, \"Spara\")));\r\n    };\r\n    return EditResource;\r\n}(React.Component));\r\nexport { EditResource };\r\nvar templateObject_1;\r\n","import ReactDatePicker from \"react-datepicker\";\r\nimport moment from 'moment';\r\nimport * as React from 'react';\r\nimport { TaskMigrationBox } from \"./task-migration-box\";\r\nimport { GooglePicker } from '../../../../apis/google-picker';\r\nimport { DriveButton } from \"../../../../apis/buttons\";\r\nimport { TaskContentFragment } from \"./task-content-fragment\";\r\nimport { UICheckbox } from \"../../../utility-components/checkbox\";\r\nimport { FileView } from '../../../course-viewer/subcomponents/task-fileview';\r\nexport function BasicEditableTaskFields(_a) {\r\n    var task = _a.task, course = _a.course, writeAccess = _a.writeAccess, features = _a.features, editTask = _a.editTask, templates = _a.templates;\r\n    var showGooglePicker = features.picker;\r\n    if (task.contentType === undefined) {\r\n        task.contentType = task.url != '' ? 'url' : 'desc';\r\n    }\r\n    return React.createElement(\"div\", null,\r\n        React.createElement(\"h2\", null, \"Uppgiftens namn och l\\u00E4nk\"),\r\n        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"p\", null, \"Uppgiftens namn:\")),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"input\", { autoFocus: true, type: \"text\", size: 35, value: task.name, disabled: !writeAccess, readOnly: !writeAccess, onChange: function (ev) {\r\n                        editTask.updateTaskOrCustomization(\"name\", { $set: ev.target.value });\r\n                    } }))),\r\n        task.migratedTexts && writeAccess && React.createElement(TaskMigrationBox, { task: task, course: course, updateLink: function (id, linkOrUnlink) { return editTask.updateLink(id, linkOrUnlink); } }),\r\n        React.createElement(\"h2\", null, \"Inneh\\u00E5llstyp\"),\r\n        React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"p\", null, \"V\\u00E4lj:\")),\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"select\", { value: task.contentType, onChange: function (ev) {\r\n                        editTask.updateTaskOrCustomization(\"contentType\", { $set: ev.target.value });\r\n                    } },\r\n                    React.createElement(\"option\", { value: \"url\" }, \"L\\u00E4nk\"),\r\n                    React.createElement(\"option\", { value: \"desc\" }, \"Beskrivning\")))),\r\n        task.contentType == 'url' ? React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n            React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                React.createElement(\"p\", null, \"URL:\")),\r\n            React.createElement(\"div\", { className: \"horizontalItem top align-horizontal\" },\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"input\", { className: \"horizontalItem\", type: \"text\", size: 35, value: task.url, disabled: !writeAccess, readOnly: !writeAccess, onChange: function (ev) {\r\n                            editTask.updateTaskOrCustomization(\"url\", { $set: ev.target.value });\r\n                        } })),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, showGooglePicker && React.createElement(DriveButton, { label: \"\", action: function () {\r\n                        var picker = new GooglePicker({ upload: true });\r\n                        picker.show().then(function (files) {\r\n                            var fileurl = files[0].url;\r\n                            var viewurl = fileurl.substr(0, fileurl.lastIndexOf('/')) + \"/view\";\r\n                            if (viewurl == task.url)\r\n                                return;\r\n                            editTask.updateTaskOrCustomization(\"url\", { $set: viewurl });\r\n                        });\r\n                    } })))) : React.createElement(React.Fragment, null, (writeAccess || !!task.content) && React.createElement(TaskContentFragment, { writeAccess: writeAccess, task: task, editTask: editTask })),\r\n        React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null, \"Inl\\u00E4mningsuppgift\"),\r\n            React.createElement(UICheckbox, { state: (editTask.getTaskProp(\"assignment\") ? \"checked\" : \"\"), onChange: function () {\r\n                    editTask.updateTaskOrCustomization(\"assignment\", { $set: !editTask.getTaskProp(\"assignment\") });\r\n                }, label: \"Den h\\u00E4r uppgiften \\u00E4r en inl\\u00E4mningsuppgift\" }),\r\n            task.assignment && features.picker && React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", { className: \"align-horizontal spaced\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"p\", null, \"V\\u00E4lj mall:\")),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"select\", { value: task.templateFile ? task.templateFile.fileId : '-', onChange: function (ev) {\r\n                                var newValue = ev.target.value;\r\n                                if (newValue === '-') {\r\n                                    // do not use template\r\n                                    editTask.updateTemplateView(null);\r\n                                }\r\n                                else if (newValue.startsWith('t:')) {\r\n                                    editTask.updateTemplateView({ fileId: newValue });\r\n                                }\r\n                                else {\r\n                                    // Picked file\r\n                                    var picker = new GooglePicker({ limitType: 'google-apps' });\r\n                                    picker.show().then(function (files) { return editTask.updateTemplateView(files[0]); });\r\n                                }\r\n                            } },\r\n                            React.createElement(\"option\", { value: \"-\" }, \"Ingen mall\"),\r\n                            templates ? templates.map(function (template, idx) {\r\n                                return React.createElement(\"option\", { key: idx, value: \"t:\" + template.fileId },\r\n                                    template.grade ? template.grade + \": \" : \"\",\r\n                                    template.title);\r\n                            }) : null,\r\n                            task.templateFile && !task.templateFile.fileId.startsWith('t:') ?\r\n                                React.createElement(\"option\", { value: task.templateFile.fileId },\r\n                                    \"Egen mall: \",\r\n                                    task.templateFile.name) :\r\n                                React.createElement(\"option\", { value: \"4\" }, \"Egen mall\")))),\r\n                task.templateFile && React.createElement(\"div\", { className: \"spaced\" },\r\n                    React.createElement(FileView, { size: \"large\", thumbnail: task.templateFile.iconUrl, title: task.templateFile.name, url: task.templateFile.url }),\r\n                    course.googleCreateClassrooms && React.createElement(\"p\", null,\r\n                        React.createElement(\"em\", null, \"Obs! Uppgiften hamnar i kursens Classroom som en inl\\u00E4mingsuppgift.\")))),\r\n            editTask.getTaskProp(\"assignment\") && React.createElement(React.Fragment, null,\r\n                React.createElement(\"p\", null, \"Inl\\u00E4mningsdatum\"),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(ReactDatePicker, { nextMonthButtonLabel: \"\", previousMonthButtonLabel: \"\", showWeekNumbers: true, selected: editTask.getTaskProp(\"deadline\") && moment(editTask.getTaskProp(\"deadline\")).toDate(), dateFormat: \"yyyy-MM-dd\", locale: \"sv\", popperPlacement: \"bottom-start\", onChange: function (value) {\r\n                                editTask.updateTaskOrCustomization(\"deadline\", { $set: moment(value).format(\"YYYY-MM-DD\") });\r\n                            } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, editTask.getTaskProp(\"deadline\") && React.createElement(\"a\", { className: \"deleteDate\", href: \"#\", title: \"Ta bort inl\\u00E4mningsdatum\", onClick: function (ev) {\r\n                            ev.preventDefault();\r\n                            editTask.updateTaskOrCustomization(\"deadline\", { $set: null });\r\n                        } }))),\r\n                React.createElement(UICheckbox, { state: ((task.sendToUrkund == null ? true : task.sendToUrkund) ? \"checked\" : \"\"), onChange: function () {\r\n                        return editTask.updateTaskOrCustomization(\"sendToUrkund\", { $set: task.sendToUrkund == null ? false : !task.sendToUrkund });\r\n                    }, label: \"Skicka inl\\u00E4mningar till Urkund\" }),\r\n                task.templateFile && React.createElement(UICheckbox, { state: (task.additionalUploads ? \"checked\" : \"\"), label: \"Till\\u00E5t inl\\u00E4mning av andra/ytterligare filer\", onChange: function () {\r\n                        return editTask.updateTaskOrCustomization(\"additionalUploads\", { $set: task.additionalUploads == null ? true : !task.additionalUploads });\r\n                    } }))));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { KnowledgeMatrix } from '../../sub-components/knowledge-matrix';\r\nimport update from 'react-addons-update';\r\nimport { hasWriteAccess } from '../../../../access-control';\r\nimport { SelectRelatedDocs } from '../../sub-components/select-related-docs';\r\nimport validUrl from 'valid-url';\r\nimport { L, showError } from \"../../../../utils/utils\";\r\nimport { CachedResponse } from \"../../../../utils/cached-response\";\r\nimport env from '../../../../globals/KED.env';\r\nimport { Spinner } from \"../../sub-components/spinner\";\r\nimport { Features, features } from '../../../../features';\r\nimport { SearchResults } from './search-results';\r\nimport { BasicEditableTaskFields } from './basic-editable-task-fields';\r\nimport { TaskStatusFragment } from './task-status-fragment';\r\nimport { SaveOrCancelButtons } from './save-or-cancel-buttons';\r\nimport { PreviewableTaskFields } from './previewable-task-fields';\r\nimport { GoogleDrive } from '../../../../apis/google-drive';\r\nimport { TemplatesFileId } from '../../../../apis/configs';\r\nimport { washHtml } from '../../../utility-components/wysiwyg/wash-html';\r\nvar EditTask = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditTask, _super);\r\n    function EditTask(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.features = new Features();\r\n        var writeAccess = !props.task || hasWriteAccess(env.currentUser, props.task);\r\n        _this.state = {\r\n            title: props.task ?\r\n                writeAccess ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Redigera uppgift till \\\"\", \"\\\"\"], [\"Redigera uppgift till \\\"\", \"\\\"\"])), props.module.name) : L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Visa uppgift till \\\"\", \"\\\"\"], [\"Visa uppgift till \\\"\", \"\\\"\"])), props.module.name) :\r\n                props.searchMode ? L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"S\\u00F6k ny uppgift till \\\"\", \"\\\"\"], [\"S\\u00F6k ny uppgift till \\\"\", \"\\\"\"])), props.module.name) : L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till egen uppgift till \\\"\", \"\\\"\"], [\"L\\u00E4gg till egen uppgift till \\\"\", \"\\\"\"])), props.module.name),\r\n            futureAbilitiesOpen: false,\r\n            taskCustomization: props.taskCustomization || {},\r\n            task: props.task ? tslib_1.__assign({ $meta: props.task.$meta || 'update' }, props.task) : props.searchMode ? null :\r\n                // No task was given. Set $meta = 'add' to inform EditCourse.save()\r\n                // to add the task to the tasks table.\r\n                {\r\n                    id: createUUID(),\r\n                    $meta: 'add',\r\n                    tags: [\r\n                        \"sub:\" + props.course.subjectCode,\r\n                        \"course:\" + props.course.code\r\n                    ],\r\n                    school: !props.course.isTemplate && env.currentUser.school,\r\n                    resources: [],\r\n                    abilities: [],\r\n                    centralContent: [],\r\n                    futureAbilities: [],\r\n                    knowledgeRequirements: [],\r\n                    name: \"\",\r\n                    url: \"\",\r\n                    acl: props.course.isTemplate ? [\r\n                        \"role:USER:R\" // (OK to keep after kursbygg-changes). Templates (which will be empty!) will not have tasks. If they had, might not tasks should not be possible to modify. (An ADMIN could belong to a school! Other non-admins at that school should not be able to edit it)\r\n                    ] : [\r\n                        \"role:USER:R\",\r\n                        \"schoolRole:\" + env.currentUser.school + \"/EMPLOYEE:S\"\r\n                    ]\r\n                },\r\n            searchMarkedIds: props.searchMode && [],\r\n            searchResult: props.searchMode && [],\r\n            isSearching: props.searchMode\r\n        };\r\n        if (props.searchMode) {\r\n            _this.searchResponse = new CachedResponse(function () {\r\n                return env.kedBackendClient.list(\"tasks\", {\r\n                    tags: \"course:\" + props.course.code,\r\n                    include: ['knowledgeRequirements', 'abilities', 'centralContent'],\r\n                    flags: ['includeIdsOnly']\r\n                });\r\n            });\r\n        }\r\n        return _this;\r\n    }\r\n    EditTask.prototype.setStatePromised = function (state) {\r\n        var _this = this;\r\n        return new Promise(function (resolve) { return _super.prototype.setState.call(_this, function () { return state; }, resolve); });\r\n    };\r\n    EditTask.prototype.componentDidMount = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var err_1;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.props.searchMode) return [3 /*break*/, 8];\r\n                        this.setStatePromised({ isSearching: true });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, 5, 6, 8]);\r\n                        return [4 /*yield*/, this.searchResponse.query()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        if (!(this.state.searchMarkedIds && this.state.searchMarkedIds.length === 0)) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, this.updateSearchResult(this.state.searchMarkedIds)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        _a.label = 4;\r\n                    case 4: return [3 /*break*/, 8];\r\n                    case 5:\r\n                        err_1 = _a.sent();\r\n                        showError(err_1);\r\n                        return [3 /*break*/, 8];\r\n                    case 6: return [4 /*yield*/, this.setStatePromised({ isSearching: false })];\r\n                    case 7:\r\n                        _a.sent();\r\n                        return [7 /*endfinally*/];\r\n                    case 8:\r\n                        if (!features.picker) return [3 /*break*/, 10];\r\n                        return [4 /*yield*/, fetch(TemplatesFileId).then(function (resp) { return resp.json(); }).then(function (data) {\r\n                                _this.setStatePromised({ templates: data });\r\n                                if (_this.state.task && _this.state.task.templateFile) {\r\n                                    var templateFile = _this.state.task.templateFile;\r\n                                    if (templateFile.fileId) {\r\n                                        _this.updateTemplateView(templateFile);\r\n                                    }\r\n                                }\r\n                            })];\r\n                    case 9:\r\n                        _a.sent();\r\n                        _a.label = 10;\r\n                    case 10: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.updateSearchMarkedIds = function (searchMarkedIds) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var setStatePromise;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        setStatePromise = this.setStatePromised({ task: null, searchMarkedIds: searchMarkedIds, previewTaskContent: null });\r\n                        if (!!this.searchResponse.result) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.searchResponse.promise];\r\n                    case 1:\r\n                        _a.sent();\r\n                        // Refresh searchMarkedIds now as user might have clicked around while waiting for\r\n                        // tasks to load...\r\n                        return [4 /*yield*/, setStatePromise];\r\n                    case 2:\r\n                        // Refresh searchMarkedIds now as user might have clicked around while waiting for\r\n                        // tasks to load...\r\n                        _a.sent(); // So we know state has been reflected...\r\n                        searchMarkedIds = this.state.searchMarkedIds;\r\n                        _a.label = 3;\r\n                    case 3: return [4 /*yield*/, this.updateSearchResult(searchMarkedIds)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.updateSearchResult = function (searchMarkedIds) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var allTasksForSubject, searchResult;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.searchResponse.query()];\r\n                    case 1:\r\n                        allTasksForSubject = _a.sent();\r\n                        searchResult = allTasksForSubject.filter(function (t) {\r\n                            return searchMarkedIds.every(function (id) {\r\n                                return t.knowledgeRequirements.some(function (kr) { return kr.id === id; }) ||\r\n                                    t.abilities.some(function (a) { return a.id === id; }) ||\r\n                                    t.centralContent.some(function (c) { return c.id === id; });\r\n                            });\r\n                        });\r\n                        this.setStatePromised({\r\n                            searchResult: searchResult\r\n                        });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.onMarkChanged = function (id, isMarked) {\r\n        var searchMode = this.props.searchMode;\r\n        if (searchMode) {\r\n            var searchMarkedIds = this.state.searchMarkedIds;\r\n            this.updateSearchMarkedIds(isMarked ?\r\n                searchMarkedIds.concat(id) :\r\n                searchMarkedIds.filter(function (x) { return x !== id; })).catch(showError);\r\n            return;\r\n        }\r\n        this.updateLink(id, isMarked);\r\n    };\r\n    EditTask.prototype.updateLink = function (id, linkOrUnlink) {\r\n        var course = this.props.course;\r\n        var task = this.state.task;\r\n        // One of the following three will be found:\r\n        var ability = course.abilities.find(function (a) { return a.id === id; });\r\n        var knowledgeRequirement = course.knowledgeRequirements.find(function (r) { return r.id === id; });\r\n        var centralContent = course.centralContent.find(function (cc) { return cc.id === id; });\r\n        var _a = tslib_1.__read(ability ?\r\n            [\"abilities\", ability] :\r\n            knowledgeRequirement ?\r\n                [\"knowledgeRequirements\", knowledgeRequirement] :\r\n                centralContent ?\r\n                    [\"centralContent\", centralContent] :\r\n                    [null, null], 2), collectionProp = _a[0], item = _a[1];\r\n        if (!collectionProp) {\r\n            console.error(\"Could not find marked id \" + id);\r\n            return;\r\n        }\r\n        var updatedCollection = task[collectionProp].slice();\r\n        var currentPos = updatedCollection.findIndex(function (doc) { return doc.id === id; });\r\n        if (linkOrUnlink) {\r\n            if (currentPos < 0) {\r\n                updatedCollection.push(item);\r\n            }\r\n        }\r\n        else {\r\n            if (currentPos >= 0) {\r\n                updatedCollection.splice(currentPos, 1);\r\n            }\r\n        }\r\n        var updatedTask = tslib_1.__assign({}, task);\r\n        updatedTask[collectionProp] = updatedCollection;\r\n        // Clear migratedTexts from task.\r\n        // First deep clone:\r\n        if (task && task.migratedTexts) {\r\n            updatedTask.migratedTexts = tslib_1.__assign({}, task.migratedTexts);\r\n            if (task.migratedTexts[collectionProp]) {\r\n                updatedTask.migratedTexts[collectionProp] = tslib_1.__assign({}, task.migratedTexts[collectionProp]);\r\n                // Delete the id within the deep clone:\r\n                delete updatedTask.migratedTexts[collectionProp][id];\r\n            }\r\n        }\r\n        this.setStatePromised({\r\n            task: updatedTask\r\n        });\r\n    };\r\n    EditTask.prototype.updateTemplateView = function (templateFile) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var drive, tFileId_1, file, tFile;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        drive = new GoogleDrive();\r\n                        if (!(templateFile && templateFile.fileId.startsWith('t:'))) return [3 /*break*/, 2];\r\n                        tFileId_1 = templateFile.fileId.replace('t:', '');\r\n                        return [4 /*yield*/, drive.getFile(tFileId_1)];\r\n                    case 1:\r\n                        file = _a.sent();\r\n                        if (file) {\r\n                            file.fileId = 't:' + file.fileId;\r\n                            tFile = this.state.templates.filter(function (tpl) { return tpl.fileId == tFileId_1; })[0];\r\n                            file.name = tFile ? tFile.title : file.name;\r\n                            templateFile = { fileId: file.fileId, name: file.name, mimeType: file.mimeType, modifiedTime: Number(file.modiifiedTime), url: file.url, iconUrl: file.thumbnailUrl };\r\n                        }\r\n                        else {\r\n                            templateFile = null;\r\n                        }\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        this.updateTaskOrCustomization(\"templateFile\", { $set: templateFile });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, task, taskCustomization, writeAccess;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this.state, task = _a.task, taskCustomization = _a.taskCustomization;\r\n                        writeAccess = hasWriteAccess(env.currentUser, task);\r\n                        if (!writeAccess) return [3 /*break*/, 5];\r\n                        if (task.sendToUrkund == undefined)\r\n                            task.sendToUrkund = true; // sendToUrkund is default so setting this here, perhaps there is a better place for this!\r\n                        if (!task.url && !task.content)\r\n                            throw new Error(L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Uppgiften m\\u00E5ste antingen ha en URL eller ett inneh\\u00E5ll\"], [\"Uppgiften m\\u00E5ste antingen ha en URL eller ett inneh\\u00E5ll\"]))));\r\n                        if (task.url && !validUrl.isUri(task.url))\r\n                            throw new Error(L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Angiven URL '\", \"' \\u00E4r ogiltig. Den ska b\\u00F6rja med http: eller https:\"], [\"Angiven URL '\", \"' \\u00E4r ogiltig. Den ska b\\u00F6rja med http: eller https:\"])), task.url));\r\n                        if (!(this.props.task && this.props.task.id !== task.id)) return [3 /*break*/, 2];\r\n                        // Replace existing task with copy\r\n                        return [4 /*yield*/, this.props.onReplace(this.props.task.id, task)];\r\n                    case 1:\r\n                        // Replace existing task with copy\r\n                        _b.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 2: \r\n                    // Update existing task\r\n                    return [4 /*yield*/, this.props.onSave(task, null)];\r\n                    case 3:\r\n                        // Update existing task\r\n                        _b.sent();\r\n                        _b.label = 4;\r\n                    case 4: return [3 /*break*/, 9];\r\n                    case 5:\r\n                        if (!this.props.searchMode) return [3 /*break*/, 7];\r\n                        return [4 /*yield*/, this.props.onSave(task, taskCustomization)];\r\n                    case 6:\r\n                        _b.sent();\r\n                        return [3 /*break*/, 9];\r\n                    case 7:\r\n                        if (this.props.course.isTemplate && task.$meta === 'add')\r\n                            throw new Error(L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Du saknar beh\\u00F6righet f\\u00F6r att spara nya versioner av uppgifter i kursmallen\"], [\"Du saknar beh\\u00F6righet f\\u00F6r att spara nya versioner av uppgifter i kursmallen\"]))));\r\n                        return [4 /*yield*/, this.props.onSaveCustomization(taskCustomization)];\r\n                    case 8:\r\n                        _b.sent();\r\n                        _b.label = 9;\r\n                    case 9: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.copyTask = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var taskCopy;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        taskCopy = tslib_1.__assign({}, this.state.task, (this.state.taskCustomization || {}), { id: createUUID(), acl: this.props.course.isTemplate ? [\r\n                                \"role:USER:R\" // (OK to keep but this check might become unnescesary if we totally remove the possibility to edit templates) Template tasks should not be possible to modify. (An ADMIN could belong to a school! Other non-admins at that school should not be able to edit it)\r\n                            ] : [\r\n                                \"role:USER:R\",\r\n                                \"schoolRole:\" + env.currentUser.school + \"/EMPLOYEE:S\"\r\n                            ], school: this.props.course.school });\r\n                        taskCopy.$meta = 'add';\r\n                        return [4 /*yield*/, this.setStatePromised({\r\n                                task: taskCopy,\r\n                                title: L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\"Redigera kopierad uppgift till \\\"\", \"\\\"\"], [\"Redigera kopierad uppgift till \\\"\", \"\\\"\"])), this.props.module.name),\r\n                                taskCustomization: undefined\r\n                            })];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditTask.prototype.getTaskProp = function (taskProp) {\r\n        var _a = this.state, task = _a.task, taskCustomization = _a.taskCustomization;\r\n        var customization = taskCustomization && taskCustomization[taskProp];\r\n        return customization !== undefined ?\r\n            customization :\r\n            task[taskProp];\r\n    };\r\n    EditTask.prototype.updateTaskOrCustomization = function (taskProp, updates) {\r\n        var _a = this.state, task = _a.task, taskCustomization = _a.taskCustomization;\r\n        var writeAccess = task && hasWriteAccess(env.currentUser, task);\r\n        if (writeAccess && (!taskCustomization || taskCustomization[taskProp] === undefined)) {\r\n            var newTask = tslib_1.__assign({}, task);\r\n            newTask[taskProp] = update(task[taskProp], updates);\r\n            this.setStatePromised({ task: newTask });\r\n        }\r\n        else {\r\n            var newCustomization = tslib_1.__assign({}, taskCustomization);\r\n            newCustomization[taskProp] = update(newCustomization[taskProp] || task[taskProp], updates);\r\n            this.setStatePromised({ taskCustomization: newCustomization });\r\n        }\r\n    };\r\n    EditTask.prototype.render = function () {\r\n        var _a = this.props, course = _a.course, module = _a.module, onCancel = _a.onCancel, onDelete = _a.onDelete, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask, searchMode = _a.searchMode;\r\n        var _b = this.state, task = _b.task, taskCustomization = _b.taskCustomization, title = _b.title, searchResult = _b.searchResult, searchMarkedIds = _b.searchMarkedIds, isSearching = _b.isSearching, templates = _b.templates;\r\n        var markedIds = searchMode ?\r\n            searchMarkedIds :\r\n            task.centralContent.map(function (x) { return x.id; })\r\n                .concat(task.abilities.map(function (x) { return x.id; }))\r\n                .concat(task.knowledgeRequirements.map(function (x) { return x.id; }));\r\n        var writeAccess = task && hasWriteAccess(env.currentUser, task);\r\n        var taskUrlValid = task && validUrl.isUri(task.url);\r\n        var features = this.features;\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"h1\", null, title),\r\n            React.createElement(\"div\", { className: \"sv-layout sv-skip-spacer sv-column-6\" },\r\n                React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                    React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                        React.createElement(\"h3\", null, searchMode ?\r\n                            \"Filtrera på kunskapskrav\" : writeAccess ?\r\n                            \"Välj kunskapskrav\" :\r\n                            \"Kunskapskrav\"),\r\n                        searchMode ?\r\n                            React.createElement(\"p\", null, \"Markera de kunskapskrav som uppgiften m\\u00E5ste t\\u00E4cka.\") : writeAccess &&\r\n                            React.createElement(\"p\", null, \"Markera de kunskapskrav som din uppgift t\\u00E4cker.\"),\r\n                        React.createElement(KnowledgeMatrix, { knowledgeRequirements: course.knowledgeRequirements, markedIds: markedIds, idsToMarkNotOk: idsNotCoveredByAnyTask, markMode: searchMode || writeAccess, migratedIds: task && task.migratedTexts && task.migratedTexts.knowledgeRequirements, onMarkChanged: this.onMarkChanged.bind(this) }))),\r\n                React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                    React.createElement(SelectRelatedDocs, { options: course.abilities, title: writeAccess || searchMode ? \"Välj förmågor\" : \"Förmågor\", markedIds: markedIds, markMode: writeAccess || searchMode, migratedIds: task && task.migratedTexts && task.migratedTexts.abilities, onMarkChanged: this.onMarkChanged.bind(this) })),\r\n                React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                    React.createElement(SelectRelatedDocs, { options: course.centralContent, title: writeAccess || searchMode ? \"Välj centralt innehåll\" : \"Centralt innehåll\", markedIds: markedIds, markMode: writeAccess || searchMode, migratedIds: task && task.migratedTexts && task.migratedTexts.centralContent, onMarkChanged: this.onMarkChanged.bind(this) }))),\r\n            React.createElement(\"div\", { className: \"sv-layout sv-column-6\" },\r\n                React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                    isSearching && React.createElement(\"p\", null,\r\n                        React.createElement(Spinner, null),\r\n                        \" Laddar uppgifter...\"),\r\n                    searchResult ?\r\n                        /*\r\n                        *\r\n                        * Search Results Fragent\r\n                        *\r\n                        *\r\n                        */\r\n                        React.createElement(React.Fragment, null,\r\n                            React.createElement(SearchResults, { searchMarkedIds: searchMarkedIds, searchResult: searchResult, task: task, writeAccess: writeAccess, taskCustomization: taskCustomization, editTask: this }),\r\n                            this.state.previewTaskContent ?\r\n                                React.createElement(\"div\", { dangerouslySetInnerHTML: { __html: washHtml(this.state.previewTaskContent) } })\r\n                                : task && React.createElement(PreviewableTaskFields, { writeAccess: writeAccess, task: task, taskCustomization: taskCustomization, editTask: this }),\r\n                            task && React.createElement(TaskStatusFragment, { task: task })) :\r\n                        /*\r\n                        *\r\n                        * Edit Tasks Fragment\r\n                        *\r\n                        *\r\n                        */\r\n                        React.createElement(React.Fragment, null,\r\n                            task && React.createElement(BasicEditableTaskFields, { task: task, course: course, writeAccess: writeAccess, features: features, editTask: this, templates: templates }),\r\n                            task && React.createElement(PreviewableTaskFields, { writeAccess: writeAccess, task: task, taskCustomization: taskCustomization, editTask: this }),\r\n                            task && React.createElement(TaskStatusFragment, { task: task }))),\r\n                task && React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\" },\r\n                    React.createElement(\"hr\", null),\r\n                    React.createElement(\"br\", null),\r\n                    React.createElement(SaveOrCancelButtons, { writeAccess: writeAccess, editTask: this }))));\r\n    };\r\n    return EditTask;\r\n}(React.Component));\r\nexport { EditTask };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8;\r\n","export * from './edit-task';\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditableResourceList } from '../../sub-components/editable-resource-list';\r\nexport function PreviewableTaskFields(_a) {\r\n    var writeAccess = _a.writeAccess, task = _a.task, taskCustomization = _a.taskCustomization, editTask = _a.editTask;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(React.Fragment, null,\r\n            React.createElement(\"h3\", null, \"Uppgiftens l\\u00E4randem\\u00E5l\"),\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"textarea\", { className: \"inputTextBox learning-goal-box\", disabled: !writeAccess, value: task.learningGoal, onChange: function (ev) {\r\n                        var newTask = tslib_1.__assign({}, task);\r\n                        newTask.learningGoal = ev.target.value;\r\n                        editTask.setStatePromised({ task: newTask });\r\n                    } }))),\r\n        React.createElement(\"br\", null),\r\n        React.createElement(React.Fragment, null,\r\n            taskCustomization && taskCustomization.resources ?\r\n                React.createElement(\"h3\", null, \"Resurser f\\u00F6r uppgiften (modifierad f\\u00F6r denna kursinstans)\") :\r\n                React.createElement(\"h3\", null, \"Resurser kopplade till uppgiften\"),\r\n            React.createElement(EditableResourceList, { resources: (taskCustomization && taskCustomization.resources) || task.resources, host: editTask.props.host, onUpdate: function (resourceUpdates) {\r\n                    editTask.updateTaskOrCustomization(\"resources\", resourceUpdates);\r\n                } })));\r\n}\r\n","import * as React from 'react';\r\nimport { showError } from '../../../../utils/utils';\r\nexport function SaveOrCancelButtons(_a) {\r\n    var writeAccess = _a.writeAccess, editTask = _a.editTask;\r\n    return React.createElement(React.Fragment, null,\r\n        !!editTask.props.onDelete && React.createElement(\"div\", { className: \"btn btn-warning btn-large pull-right\", onClick: function () { return editTask.props.onDelete(); } }, \"Ta bort fr\\u00E5n kursmodul\"),\r\n        React.createElement(\"div\", { className: \"pull-right\" }, \"\\u00A0\"),\r\n        React.createElement(\"div\", { className: \"btn btn-warning btn-large pull-right\", onClick: function () { return editTask.props.onCancel(); } }, \"Avbryt\"),\r\n        React.createElement(\"div\", { className: \"btn btn-large\", onClick: function () { return editTask.save().catch(showError); } }, \"Spara\"),\r\n        !writeAccess && React.createElement(\"div\", { className: \"btn btn-large\", onClick: function () { return editTask.copyTask().catch(showError); } }, \"Skapa kopia av den h\\u00E4r uppgiften\"));\r\n}\r\n","import * as React from \"react\";\r\nimport { findDOMNode } from 'react-dom';\r\nimport { shortPersonNameFormat, shortDateFormat } from \"../../utils\";\r\nexport function SearchResults(_a) {\r\n    var searchMarkedIds = _a.searchMarkedIds, searchResult = _a.searchResult, task = _a.task, editTask = _a.editTask, writeAccess = _a.writeAccess, taskCustomization = _a.taskCustomization;\r\n    return React.createElement(\"div\", { className: \"task-search-result\" + (!editTask.state.task && !editTask.state.previewTaskContent ? \" fixed\" : \"\") },\r\n        searchMarkedIds.length === 0 ?\r\n            React.createElement(\"h2\", null, \"Samtliga uppgifter f\\u00F6r kursen\") :\r\n            React.createElement(\"h2\", null, \"Uppgifter som t\\u00E4cker valda filter\"),\r\n        React.createElement(\"table\", null,\r\n            React.createElement(\"tbody\", null, searchResult\r\n                .filter(task ?\r\n                function (foundTask) { return foundTask.id === task.id; } :\r\n                function () { return true; })\r\n                .map(function (foundTask) { return React.createElement(React.Fragment, { key: foundTask.id },\r\n                React.createElement(\"tr\", null,\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"div\", { tabIndex: 1, className: \"checkBox\" + (task && task.id === foundTask.id ? \" checked\" : \"\"), onClick: function () { return toggleChooseTask(foundTask); } })),\r\n                    React.createElement(\"td\", null, foundTask.content ?\r\n                        React.createElement(\"a\", { href: \"#\", onClick: function (ev) {\r\n                                toggleChooseTask(foundTask);\r\n                                ev.preventDefault();\r\n                                ev.stopPropagation();\r\n                            } }, foundTask.name) :\r\n                        React.createElement(\"a\", { href: foundTask.url, target: \"_blank\" }, foundTask.name)),\r\n                    React.createElement(\"td\", null, shortPersonNameFormat(foundTask.modifiedBy.name)),\r\n                    React.createElement(\"td\", null, foundTask.school || \"Standard\"),\r\n                    React.createElement(\"td\", null, shortDateFormat(foundTask.modifiedDate)))); }))),\r\n        React.createElement(\"br\", null),\r\n        React.createElement(\"hr\", null));\r\n    function toggleChooseTask(foundTask) {\r\n        if (task && task.id === foundTask.id) {\r\n            editTask.updateSearchMarkedIds(searchMarkedIds);\r\n        }\r\n        else {\r\n            findDOMNode(editTask).parentElement.scrollTop = 0;\r\n            editTask.setStatePromised({ task: foundTask, previewTaskContent: null });\r\n        }\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { Wysiwyg } from '../../../utility-components/wysiwyg';\r\nimport actions_swedish from '../../../utility-components/wysiwyg/actions-sv';\r\nexport function TaskContentFragment(_a) {\r\n    var writeAccess = _a.writeAccess, task = _a.task, editTask = _a.editTask;\r\n    return React.createElement(Wysiwyg, { actions: [\r\n            \"bold\",\r\n            \"italic\",\r\n            \"underline\",\r\n            \"strikethrough\",\r\n            \"heading2\",\r\n            \"heading3\",\r\n            \"olist\",\r\n            \"ulist\",\r\n            \"outdent\",\r\n            \"indent\",\r\n            \"line\",\r\n            \"link\",\r\n            \"image\"\r\n        ], defaultActions: actions_swedish, readOnly: !writeAccess, html: task.content, onChange: function (html) {\r\n            var newTask = tslib_1.__assign({}, task);\r\n            newTask.content = html;\r\n            editTask.setState({ task: newTask });\r\n        } });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from '../../../utility-components/open-close-box';\r\nvar TaskMigrationBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TaskMigrationBox, _super);\r\n    function TaskMigrationBox(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TaskMigrationBox.prototype.render = function () {\r\n        var _a = this.props, task = _a.task, course = _a.course, updateLink = _a.updateLink;\r\n        if (!task.migratedTexts)\r\n            return React.createElement(React.Fragment, null, \"\\u00A0\");\r\n        var _b = task.migratedTexts, abilities = _b.abilities, centralContent = _b.centralContent, knowledgeRequirements = _b.knowledgeRequirements;\r\n        var krs = Object.keys(knowledgeRequirements || {}).map(function (id) { return (tslib_1.__assign({}, course.knowledgeRequirements.find(function (t) { return t.id === id; }), knowledgeRequirements[id])); }); //.filter(({name}) => !!name);\r\n        var krA = { title: \"Uppdaterat kunskapskrav för betyget A\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'A'; }) };\r\n        var krC = { title: \"Uppdaterat Kunskapskrav för betyget C\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'C'; }) };\r\n        var krE = { title: \"Uppdaterat kunskapskrav för betyget E\", type: \"knowledgeRequirements\", items: krs.filter(function (kr) { return kr.gradeStep === 'E'; }) };\r\n        var abs = { title: \"Uppdaterade förmågor\", type: \"abilities\", items: Object.keys(abilities || {}).map(function (id) { return (tslib_1.__assign({}, course.abilities.find(function (t) { return t.id === id; }), abilities[id])); }) }; //.filter(({name}) => !!name)};\r\n        var ccs = { title: \"Uppdaterat centralt innehåll\", type: \"centralContent\", items: Object.keys(centralContent || {}).map(function (id) { return (tslib_1.__assign({}, course.centralContent.find(function (cc) { return cc.id == id; }), centralContent[id])); }) }; //.filter(({name}) => !!name)};\r\n        var tablesToShow = [krA, krC, krE, ccs, abs].filter(function (boxInfo) { return boxInfo.items.length > 0; });\r\n        if (tablesToShow.length === 0)\r\n            return React.createElement(React.Fragment, null, \"\\u00A0\");\r\n        return (React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"div\", null,\r\n                React.createElement(\"div\", { className: \"warningFlag\" },\r\n                    React.createElement(\"i\", { className: \"fa fa-exclamation-triangle\", \"aria-hidden\": \"true\" })),\r\n                React.createElement(\"p\", null, \"Uppdaterade formuleringar fr\\u00E5n Skolverket\")) }, tablesToShow.map(function (_a) {\r\n            var title = _a.title, type = _a.type, items = _a.items;\r\n            return React.createElement(\"div\", { key: title },\r\n                React.createElement(\"h5\", null, title),\r\n                React.createElement(\"table\", null,\r\n                    React.createElement(\"thead\", null,\r\n                        React.createElement(\"tr\", null,\r\n                            React.createElement(\"th\", { style: { width: \"40%\" } }, \"Ursprunglig formulering\"),\r\n                            React.createElement(\"th\", { style: { width: \"40%\" } }, \"Skolverkets nya formulering\"),\r\n                            React.createElement(\"th\", null, \"T\\u00E4cker uppgiften den nya formuleringen?\"))),\r\n                    React.createElement(\"tbody\", null, items.map(function (item) { return React.createElement(\"tr\", { key: item.id },\r\n                        React.createElement(\"td\", { dangerouslySetInnerHTML: { __html: item.oldText } }),\r\n                        React.createElement(\"td\", { dangerouslySetInnerHTML: { __html: item.name } }),\r\n                        React.createElement(\"td\", null,\r\n                            React.createElement(\"button\", { onClick: function () { return updateLink(item.id, true); } }, \"Ja - beh\\u00E5ll kopplingen\"),\r\n                            React.createElement(\"button\", { onClick: function () { return updateLink(item.id, false); } }, \"Nej - ta bort kopplingen\"))); }))));\r\n        })));\r\n    };\r\n    return TaskMigrationBox;\r\n}(React.Component));\r\nexport { TaskMigrationBox };\r\n","import * as React from 'react';\r\nimport { dtFormat } from '../../utils';\r\nexport function TaskStatusFragment(_a) {\r\n    var task = _a.task;\r\n    return React.createElement(React.Fragment, null,\r\n        React.createElement(\"h3\", null, \"Uppgiftens status\"),\r\n        task.createdBy && task.createdDate && React.createElement(\"p\", null,\r\n            \"Uppgiften skapades \",\r\n            dtFormat(task.createdDate),\r\n            \" av \",\r\n            React.createElement(\"strong\", null, task.createdBy.name),\r\n            \".\"),\r\n        task.modifiedBy && task.modifiedDate && React.createElement(\"p\", null,\r\n            \"Uppgiften redigerades senast \",\r\n            dtFormat(task.modifiedDate),\r\n            \" av \",\r\n            React.createElement(\"strong\", null, task.modifiedBy.name),\r\n            \".\"));\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport validUrl from 'valid-url';\r\nvar EditWorkflowLink = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditWorkflowLink, _super);\r\n    function EditWorkflowLink(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { url: _this.props.url || '' };\r\n        return _this;\r\n    }\r\n    EditWorkflowLink.prototype.save = function () {\r\n        var url = this.state.url;\r\n        if (!validUrl.isUri(url))\r\n            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med http: eller https:\"], [\"Angiven URL '\", \"' \\u00E4r ogiltig. Ska b\\u00F6rja med http: eller https:\"])), url));\r\n        this.props.onSave(url);\r\n    };\r\n    EditWorkflowLink.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, onSave = _a.onSave, onDelete = _a.onDelete;\r\n        var state = this.state;\r\n        var isValidUrl = validUrl.isUri(this.state.url);\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, \"Koppla en arbetsg\\u00E5ng till kursen\"),\r\n                React.createElement(\"p\", null, \"Det g\\u00E5r bara att l\\u00E4gga in en arbetsg\\u00E5ng per kurs.\"),\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"L\\u00E4nk:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top \" },\r\n                        React.createElement(\"input\", { type: \"text\", tabIndex: 1, size: 50, value: state.url, onChange: function (ev) { return _this.setState({ url: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null)),\r\n            React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet\", id: \"svid12_492422d515badf36646e4ff1\" },\r\n                onDelete && React.createElement(\"div\", { tabIndex: 2, className: \"btn btn-warning btn-large pull-right\", onClick: function () { return onDelete(); } }, \"Ta bort arbetsg\\u00E5ng\"),\r\n                React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-large\" + (isValidUrl ? \"\" : \" btn-inactive\"), onClick: isValidUrl && (function () { return onSave(state.url); }) }, \"Spara\")));\r\n    };\r\n    return EditWorkflowLink;\r\n}(React.Component));\r\nexport { EditWorkflowLink };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport { showError, L } from \"../../../utils/utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { createUUID, DocumentAccess, BatchRunner } from \"kedbackend/client\";\r\nimport { Link } from 'react-router-dom';\r\nexport var EditSchool = function (props) { return React.createElement(\"div\", { style: { outline: 0 } },\r\n    React.createElement(CourseBanner, { title: \"Skolor\", activePage: \"schools\", callbacks: { schools: function () { return location.hash = \"#/schools\"; } }, routes: { feedback: props.feedbackUrl } }),\r\n    React.createElement(EditSchoolNoBanner, tslib_1.__assign({}, props))); };\r\nvar EditSchoolNoBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditSchoolNoBanner, _super);\r\n    function EditSchoolNoBanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = null;\r\n        return _this;\r\n    }\r\n    EditSchoolNoBanner.prototype.componentDidMount = function () {\r\n        this.load().catch(function (err) { return showError(err); });\r\n    };\r\n    EditSchoolNoBanner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var id, school;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.props.id) return [3 /*break*/, 2];\r\n                        id = this.props.id;\r\n                        return [4 /*yield*/, env.kedBackendClient.get(\"schools\", id)];\r\n                    case 1:\r\n                        school = _a.sent();\r\n                        this.origSchool = tslib_1.__assign({}, school);\r\n                        this.setState(tslib_1.__assign({}, school));\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        // No id, create new instead.\r\n                        this.setState({\r\n                            id: createUUID(),\r\n                            officialBranchId: createUUID(),\r\n                            isGymnasium: this.props.type === 'gymnasium',\r\n                            isPrimarySchool: this.props.type === 'primary'\r\n                        });\r\n                        _a.label = 3;\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.save = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var r, school;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        r = new BatchRunner();\r\n                        school = tslib_1.__assign({}, this.state, { tags: (this.state.tags || [])\r\n                                .filter(function (tag) { return [\"primary\", \"gymnasium\"].indexOf(tag) < 0; }) });\r\n                        if (school.isPrimarySchool)\r\n                            school.tags.push(\"primary\");\r\n                        if (school.isGymnasium)\r\n                            school.tags.push(\"gymnasium\");\r\n                        if (!(school.isGymnasium || school.isPrimarySchool)) {\r\n                            throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolan m\\u00E5ste antingen vara gymnasium eller grundskola\"], [\"Skolan m\\u00E5ste antingen vara gymnasium eller grundskola\"]))));\r\n                        }\r\n                        if (!this.origSchool) {\r\n                            school.acl = [\"role:USER:R\"];\r\n                            school.acl.push(new DocumentAccess(\"schoolRole\", school.name + \"/EMPLOYEE\", \"W\").toString());\r\n                            r.add(\"schools\", school);\r\n                            this.addSchoolBranch(school, r);\r\n                        }\r\n                        else if (this.origSchool.name !== this.state.name) {\r\n                            throw new Error(\"Skolans namn får inte ändras. Kontakta Vemendo AB.\");\r\n                        }\r\n                        else {\r\n                            if (!school.officialBranchId) {\r\n                                school.officialBranchId = createUUID();\r\n                                this.addSchoolBranch(school, r);\r\n                            }\r\n                            r.put(\"schools\", school);\r\n                        }\r\n                        return [4 /*yield*/, env.kedBackendClient.batch(r.mutationRequests)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        location.hash = \"#/schools\";\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.addSchoolBranch = function (school, r) {\r\n        var branch = {\r\n            id: school.officialBranchId,\r\n            name: school.name,\r\n            schoolId: school.id,\r\n            acl: [\r\n                \"role:USER:R\",\r\n                new DocumentAccess(\"schoolRole\", school.name + \"/EMPLOYEE\", \"W\").toString()\r\n            ]\r\n        };\r\n        r.add(\"branches\", branch);\r\n    };\r\n    EditSchoolNoBanner.prototype.deleteSchool = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schoolBranch, br_1;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(prompt(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4r du s\\u00E4ker p\\u00E5 att ta bort skolan \\\"\", \"\\\"? Skriv skolans exakta namn f\\u00F6r att bekr\\u00E4fta\"], [\"\\u00C4r du s\\u00E4ker p\\u00E5 att ta bort skolan \\\"\", \"\\\"? Skriv skolans exakta namn f\\u00F6r att bekr\\u00E4fta\"])), this.state.name)) === this.state.name)) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"branches\", {\r\n                                ids: [this.state.officialBranchId],\r\n                                include: \"approvedChildren\",\r\n                                flags: [\"includeIdsOnly\"]\r\n                            })];\r\n                    case 1:\r\n                        schoolBranch = _a.sent();\r\n                        br_1 = new BatchRunner();\r\n                        br_1.delete(\"schools\", this.state.id);\r\n                        schoolBranch[0].approvedChildren.forEach(function (_a) {\r\n                            var id = _a.id;\r\n                            br_1.delete(\"branches\", id);\r\n                        });\r\n                        br_1.delete(\"branches\", this.state.officialBranchId);\r\n                        return [4 /*yield*/, env.kedBackendClient.batch(br_1.mutationRequests)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        location.hash = \"#/schools\";\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        alert(\"Skolan togs inte bort eftersom det namn du angav inte stämmer.\");\r\n                        _a.label = 4;\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    EditSchoolNoBanner.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, id = _a.id;\r\n        var editExisting = !!id;\r\n        var school = this.state;\r\n        var origSchool = this.origSchool;\r\n        var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n        return React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n            React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" },\r\n                React.createElement(\"h2\", null, title),\r\n                React.createElement(\"hr\", null),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Namn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: !school || !school.name, disabled: !isAdmin || editExisting, tabIndex: 1, size: 50, value: school ? school.name : \"\", onChange: function (ev) { return _this.setState({ name: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Visningsnamn:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", autoFocus: school && !school.displayName, disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.displayName : \"\", onChange: function (ev) { return _this.setState({ displayName: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                school && school.isGymnasium ? React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"EDS namn (gymnasium):\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.edsSchoolNameGymn : \"\", onChange: function (ev) { return _this.setState({ edsSchoolNameGymn: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })) : null,\r\n                school && school.isPrimarySchool ? React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"EDS namn (grundskola):\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"text\", disabled: !isAdmin, tabIndex: 1, size: 50, value: school ? school.edsSchoolNamePrim : \"\", onChange: function (ev) { return _this.setState({ edsSchoolNamePrim: ev.target.value }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })) : null,\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, \"Typ:\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"checkbox\", name: \"schoolTypePrimary\", disabled: !isAdmin, checked: school && school.isPrimarySchool, tabIndex: 1, value: \"primary\", onChange: function (ev) { return _this.setState({ isPrimarySchool: ev.target.checked }); } }),\r\n                        \"\\u00A0Grundskola\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"input\", { type: \"checkbox\", name: \"schoolTypeGymnasium\", disabled: !isAdmin, checked: school && school.isGymnasium, tabIndex: 1, value: \"gymnasium\", onChange: function (ev) { return _this.setState({ isGymnasium: ev.target.checked }); } }),\r\n                        \"\\u00A0Gymnasium\"),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" })),\r\n                React.createElement(\"br\", null),\r\n                isAdmin && editExisting && React.createElement(\"div\", { tabIndex: 2, className: \"btn btn-warning btn-large pull-right\", onClick: function () {\r\n                        return _this.deleteSchool().catch(showError);\r\n                    } }, \"Ta bort skola\"),\r\n                React.createElement(\"div\", { className: \"pull-right\" }, \"\\u00A0\"),\r\n                React.createElement(Link, { className: \"btn btn-warning btn-large pull-right\", to: \"/schools\" }, \"Avbryt\"),\r\n                isAdmin && React.createElement(\"a\", { tabIndex: 1, className: \"btn btn-large\", onClick: function () {\r\n                        if (origSchool && origSchool.name !== school.name) {\r\n                            if (!confirm(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"\\u00C4r du s\\u00E4ker p\\u00E5 att du vill d\\u00F6pa om skolan? Detta p\\u00E5verkar portalens funktion f\\u00F6r l\\u00E4rare och elever som tillh\\u00F6r skolan. Namnet m\\u00E5ste st\\u00E4mma exakt \\u00F6verens med namngivningen av skolan p\\u00E5 anv\\u00E4ndarobjekten.\\n\\nDet som h\\u00E4nder annars \\u00E4r att elever och l\\u00E4rare p\\u00E5 skolan inte l\\u00E4ngre hittar n\\u00E5gra kurser.\\n\\nBlir det fel kan du dock alltid bara d\\u00F6pa tillbaka skolans namn.\"], [\"\\u00C4r du s\\u00E4ker p\\u00E5 att du vill d\\u00F6pa om skolan? Detta p\\u00E5verkar portalens funktion f\\u00F6r l\\u00E4rare och elever som tillh\\u00F6r skolan. Namnet m\\u00E5ste st\\u00E4mma exakt \\u00F6verens med namngivningen av skolan p\\u00E5 anv\\u00E4ndarobjekten.\\n\\nDet som h\\u00E4nder annars \\u00E4r att elever och l\\u00E4rare p\\u00E5 skolan inte l\\u00E4ngre hittar n\\u00E5gra kurser.\\n\\nBlir det fel kan du dock alltid bara d\\u00F6pa tillbaka skolans namn.\"]))))) {\r\n                                return;\r\n                            }\r\n                        }\r\n                        _this.save().catch(showError);\r\n                    } }, \"Spara\")));\r\n    };\r\n    return EditSchoolNoBanner;\r\n}(React.Component));\r\nexport { EditSchoolNoBanner };\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { Link } from 'react-router-dom';\r\nimport { actAs } from \"../../../access-control\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nexport var EditableSchoolList = function (props) {\r\n    var schools = props.schools, viewCourseUrl = props.viewCourseUrl;\r\n    var isAdmin = env.currentUser.roles.some(function (role) { return role === \"ADMIN\"; });\r\n    return React.createElement(\"div\", { className: \"editable-school-list\" },\r\n        React.createElement(\"div\", null, schools ? React.createElement(\"table\", null,\r\n            React.createElement(\"tbody\", null, schools.map(function (school) {\r\n                return React.createElement(\"tr\", { className: \"align-horizontal\", key: school.id },\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(Link, { className: \"editItem\", to: \"/schools/\" + school.id + \"/edit\" })),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null, school.name)),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(\"a\", { style: { cursor: 'pointer' }, onClick: function () { return actAs({ role: \"EMPLOYEE\", school: school.name }); } }, \"Agera som l\\u00E4rare p\\u00E5 denna skola\"))),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"p\", null,\r\n                            React.createElement(\"a\", { style: { cursor: 'pointer' }, onClick: function () { return actAs({ role: \"STUDENT\", school: school.name, url: viewCourseUrl }); } }, \"Agera som elev p\\u00E5 denna skola\"))));\r\n            }))) : React.createElement(\"p\", null,\r\n            React.createElement(Spinner, null),\r\n            \"V.g. v\\u00E4nta medan skolor laddas\")),\r\n        React.createElement(\"br\", null),\r\n        schools && isAdmin && React.createElement(Link, { to: \"/schools/new/\" + props.type, className: \"btn\" }, props.type == 'gymnasium' ? L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till gymnasieskola\"], [\"L\\u00E4gg till gymnasieskola\"]))) :\r\n            props.type == 'primary' ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till grundskola\"], [\"L\\u00E4gg till grundskola\"]))) : L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till skola\"], [\"L\\u00E4gg till skola\"])))));\r\n};\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport env from '../../../globals/KED.env';\r\nimport { EditableSchoolList } from './editable-school-list';\r\nimport { showError, compareProp } from \"../../../utils/utils\";\r\nimport { Spinner } from '../sub-components/spinner';\r\nexport var Schools = function (props) { return React.createElement(\"div\", { style: { outline: 0 } },\r\n    React.createElement(CourseBanner, { title: \"Skolor\", activePage: \"schools\", routes: { feedback: props.feedbackUrl } }),\r\n    React.createElement(SchoolsWithoutBanner, { viewCourseUrl: props.viewCourseUrl })); };\r\nvar SchoolsWithoutBanner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SchoolsWithoutBanner, _super);\r\n    function SchoolsWithoutBanner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            schools: null\r\n        };\r\n        return _this;\r\n    }\r\n    SchoolsWithoutBanner.prototype.componentDidMount = function () {\r\n        this.load().catch(function (err) { return showError(err.message || err); });\r\n    };\r\n    SchoolsWithoutBanner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var schools;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.list(\"schools\")];\r\n                    case 1:\r\n                        schools = _a.sent();\r\n                        this.setState({ schools: schools });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SchoolsWithoutBanner.prototype.render = function () {\r\n        var schools = this.state.schools;\r\n        schools && schools.sort(compareProp(\"name\"));\r\n        return React.createElement(\"div\", { className: \"sv-row sv-layout\" },\r\n            React.createElement(\"div\", { className: \"pagecontent sv-layout sv-spacer-20pxvt sv-skip-spacer\" }, schools ? React.createElement(React.Fragment, null,\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, \"Gymnasieskolor\"),\r\n                    React.createElement(EditableSchoolList, { schools: schools.filter(function (school) { return school.isGymnasium; }), viewCourseUrl: this.props.viewCourseUrl, type: \"gymnasium\" })),\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, \"Grundskolor\"),\r\n                    React.createElement(EditableSchoolList, { schools: schools.filter(function (school) { return school.isPrimarySchool; }), viewCourseUrl: this.props.viewCourseUrl, type: \"primary\" }))) : React.createElement(Spinner, null)));\r\n    };\r\n    return SchoolsWithoutBanner;\r\n}(React.Component));\r\nexport { SchoolsWithoutBanner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditSchool } from './edit-school';\r\nimport { L } from '../../../utils/utils';\r\nexport var NewSchool = function (props) { return React.createElement(EditSchool, { title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"L\\u00E4gg till skola\"], [\"L\\u00E4gg till skola\"]))), type: props.type, feedbackUrl: props.feedbackUrl }); };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditResource } from '../modal-pages/edit-resource';\r\nimport { updateModificationAndCreationStamps } from '../utils';\r\nimport env from '../../../globals/KED.env';\r\nimport { DriveButton } from '../../../apis/buttons';\r\nimport { GooglePicker } from '../../../apis/google-picker';\r\nimport { features } from '../../../features';\r\nvar EditableResourceList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditableResourceList, _super);\r\n    function EditableResourceList(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    EditableResourceList.prototype.render = function () {\r\n        var _a = this.props, host = _a.host, onUpdate = _a.onUpdate, resources = _a.resources;\r\n        var showGooglePicker = features.picker;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"taskContainer\" }, resources.map(function (resource, idx) {\r\n                return React.createElement(\"div\", { className: \"align-horizontal\", key: idx },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { className: \"editItem\", onClick: function () { return host.openDialog({\r\n                                Component: EditResource,\r\n                                props: {\r\n                                    title: \"Redigera resurs\",\r\n                                    resource: resource,\r\n                                    onSave: function (editedResource) {\r\n                                        var updatedResource = updateModificationAndCreationStamps(editedResource, env.currentUser);\r\n                                        onUpdate({ $splice: [[idx, 1, updatedResource]] });\r\n                                        host.closeDialog();\r\n                                    },\r\n                                    onDelete: function () {\r\n                                        onUpdate({ $splice: [[idx, 1]] });\r\n                                        host.closeDialog();\r\n                                    }\r\n                                }\r\n                            }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { href: resource.url, target: \"_blank\" }, resource.name)));\r\n            })),\r\n            React.createElement(\"div\", { className: \"horizontal-align spaced\" },\r\n                React.createElement(\"div\", { className: \"horizontaItem top\" },\r\n                    React.createElement(\"a\", { className: \"btn\", onClick: function () { return host.openDialog({\r\n                            Component: EditResource,\r\n                            props: {\r\n                                title: \"Lägg till resurs\",\r\n                                onSave: function (newResource) {\r\n                                    var updatedResource = updateModificationAndCreationStamps(newResource, env.currentUser);\r\n                                    onUpdate({ $push: [updatedResource] });\r\n                                    host.closeDialog();\r\n                                }\r\n                            }\r\n                        }); } },\r\n                        React.createElement(\"i\", { className: \"fa fa-paperclip\", \"aria-hidden\": true }),\r\n                        \" L\\u00E4gg till resurs\")),\r\n                showGooglePicker && React.createElement(\"div\", { className: \"horizontaItem top\" },\r\n                    React.createElement(DriveButton, { label: \"L\\u00E4gg till fr\\u00E5n Drive\", action: function () {\r\n                            var picker = new GooglePicker({ upload: true, multiple: true });\r\n                            picker.show().then(function (files) {\r\n                                files.forEach(function (file) {\r\n                                    var newResource = { url: file.url, name: file.name };\r\n                                    var updatedResource = updateModificationAndCreationStamps(newResource, env.currentUser);\r\n                                    onUpdate({ $push: [updatedResource] });\r\n                                });\r\n                            });\r\n                        } }))));\r\n    };\r\n    return EditableResourceList;\r\n}(React.Component));\r\nexport { EditableResourceList };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditTask } from '../modal-pages/edit-task';\r\nimport { updateModificationAndCreationStamps } from \"../utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { hasWriteAccess } from \"../../../access-control\";\r\nimport { SortableTaskList } from '../../utility-components/sortable-task-list';\r\nimport { getOrderedDocs } from '../../course-builder-ks/logic/ordered-requirements';\r\nvar EditableTaskList = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditableTaskList, _super);\r\n    function EditableTaskList(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    EditableTaskList.prototype.openTaskDialog = function (task) {\r\n        var _a = this.props, taskCustomizations = _a.taskCustomizations, course = _a.course, host = _a.host, module = _a.module, taskIds = _a.taskIds, onTaskAdded = _a.onTaskAdded, onTaskUpdated = _a.onTaskUpdated, onTaskCustomizationUpdated = _a.onTaskCustomizationUpdated, onTaskDeleted = _a.onTaskDeleted, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask, onTaskReplaced = _a.onTaskReplaced;\r\n        host.openDialog({\r\n            Component: EditTask,\r\n            props: {\r\n                task: task,\r\n                taskCustomization: taskCustomizations && taskCustomizations[task.id],\r\n                module: module,\r\n                course: course,\r\n                host: host,\r\n                idsNotCoveredByAnyTask: idsNotCoveredByAnyTask,\r\n                onSave: function (task) {\r\n                    var updatedTask = updateModificationAndCreationStamps(task, env.currentUser);\r\n                    onTaskUpdated(updatedTask);\r\n                    host.closeDialog();\r\n                },\r\n                onSaveCustomization: function (customization) {\r\n                    onTaskCustomizationUpdated(task.id, customization);\r\n                    host.closeDialog();\r\n                },\r\n                onDelete: function () {\r\n                    onTaskDeleted(task.id);\r\n                    host.closeDialog();\r\n                },\r\n                onReplace: function (taskId, newTask) {\r\n                    onTaskReplaced(taskId, newTask);\r\n                    host.closeDialog();\r\n                },\r\n                onCancel: function () { return host.closeDialog(); }\r\n            }\r\n        });\r\n    };\r\n    EditableTaskList.prototype.render = function () {\r\n        var _this = this;\r\n        var props = this.props;\r\n        var tasks = getOrderedDocs(props.course.tasks, props.taskIds, { appendLeftovers: false });\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(SortableTaskList, { taskMetas: tasks.map(function (task) { return ({ task: task, isTaskOwner: hasWriteAccess(env.currentUser, task) }); }), renderEditLink: function (_a) {\r\n                    var task = _a.task, isTaskOwner = _a.isTaskOwner;\r\n                    return React.createElement(\"div\", { className: isTaskOwner ?\r\n                            \"editItem\" :\r\n                            \"viewItem\", onClick: function () { return _this.openTaskDialog(task); } });\r\n                }, renderLink: function (_a) {\r\n                    var task = _a.task;\r\n                    return task.content ?\r\n                        // Rather than linking to url, show the task's content (by opening\r\n                        // the task dialog)\r\n                        React.createElement(\"a\", { href: \"#\", onClick: function (ev) {\r\n                                ev.preventDefault();\r\n                                _this.openTaskDialog(task);\r\n                            } }, task.name) :\r\n                        React.createElement(\"a\", { href: task.url, target: \"_blank\" }, task.name);\r\n                }, onSort: function (source, target, placement) {\r\n                    _this.props.onTasksReordered(source, target, placement);\r\n                } }),\r\n            React.createElement(\"br\", null),\r\n            React.createElement(\"a\", { className: \"btn\", onClick: function () {\r\n                    var _a = _this.props, course = _a.course, host = _a.host, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask, module = _a.module, onTaskAdded = _a.onTaskAdded, onTaskCustomizationUpdated = _a.onTaskCustomizationUpdated;\r\n                    props.host.openDialog({\r\n                        Component: EditTask,\r\n                        props: {\r\n                            searchMode: true,\r\n                            module: module,\r\n                            course: course,\r\n                            host: host,\r\n                            idsNotCoveredByAnyTask: idsNotCoveredByAnyTask,\r\n                            onSave: function (choosenTask, taskCustomization) {\r\n                                choosenTask = updateModificationAndCreationStamps(choosenTask, env.currentUser);\r\n                                onTaskAdded(choosenTask, taskCustomization);\r\n                                host.closeDialog();\r\n                            },\r\n                            onCancel: function () { return host.closeDialog(); }\r\n                        }\r\n                    });\r\n                } },\r\n                React.createElement(\"i\", { className: \"fa fa-search\", \"aria-hidden\": true }),\r\n                \" S\\u00F6k uppgift\"),\r\n            \"\\u00A0\",\r\n            React.createElement(\"a\", { onClick: function () {\r\n                    var _a = _this.props, course = _a.course, host = _a.host, module = _a.module, taskIds = _a.taskIds, onTaskAdded = _a.onTaskAdded, onTaskUpdated = _a.onTaskUpdated, onTaskDeleted = _a.onTaskDeleted, idsNotCoveredByAnyTask = _a.idsNotCoveredByAnyTask;\r\n                    host.openDialog({\r\n                        Component: EditTask,\r\n                        props: {\r\n                            module: module,\r\n                            course: course,\r\n                            host: host,\r\n                            idsNotCoveredByAnyTask: idsNotCoveredByAnyTask,\r\n                            onSave: function (newTask) {\r\n                                newTask = updateModificationAndCreationStamps(newTask, env.currentUser);\r\n                                onTaskAdded(newTask);\r\n                                host.closeDialog();\r\n                            },\r\n                            onCancel: function () { return host.closeDialog(); }\r\n                        }\r\n                    });\r\n                }, className: \"btn\" },\r\n                React.createElement(\"i\", { className: \"fa fa-plus\", \"aria-hidden\": true }),\r\n                \" L\\u00E4gg till egen uppgift\"));\r\n    };\r\n    return EditableTaskList;\r\n}(React.Component));\r\nexport { EditableTaskList };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useRef, useState } from 'react';\r\nimport { RemoveItem } from \"./remove-item\";\r\nimport { L } from '../../../utils/utils';\r\nimport { SelectTeacher } from './select-teacher';\r\nimport { Observe } from '../../utility-components/observe';\r\nimport { Spinner } from './spinner';\r\nimport { features } from '../../../features';\r\nexport function EditableTeacherList(_a) {\r\n    var school = _a.school, teachers = _a.teachers, onUpdate = _a.onUpdate;\r\n    var nameElem = useRef();\r\n    var _b = tslib_1.__read(useState(false), 2), selectingTeacher = _b[0], setSelectingTeacher = _b[1];\r\n    var displayTeacherRights = features.teacherRights;\r\n    return React.createElement(\"div\", { className: \"teachers-list\" },\r\n        React.createElement(\"h3\", null, \"Ansvariga l\\u00E4rare\"),\r\n        React.createElement(\"table\", { style: { width: \"100%\" } },\r\n            React.createElement(\"thead\", null, teachers.length > 0 && React.createElement(\"tr\", null,\r\n                React.createElement(\"th\", { style: { width: \"15%\" } }, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Namn\"], [\"Namn\"])))),\r\n                React.createElement(\"th\", null, L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"E-postadress\"], [\"E-postadress\"])))),\r\n                displayTeacherRights && React.createElement(\"th\", { style: { width: \"24px\" } }, L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Beh\\u00F6righet\"], [\"Beh\\u00F6righet\"])))),\r\n                React.createElement(\"th\", { style: { width: \"24px\" } }))),\r\n            React.createElement(\"tbody\", null, teachers.map(function (teacher, idx) {\r\n                return React.createElement(\"tr\", { key: idx },\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"input\", { type: \"text\", ref: nameElem, value: teacher.name, autoFocus: !teacher.name && idx > 0, onChange: function (ev) {\r\n                                if (ev.target.value || teacher.email) {\r\n                                    // Update row\r\n                                    var clone = tslib_1.__spread(teachers);\r\n                                    clone[idx] = tslib_1.__assign({}, teacher, { name: ev.target.value });\r\n                                    onUpdate(clone);\r\n                                }\r\n                                else {\r\n                                    // Remove row\r\n                                    onUpdate(tslib_1.__spread(teachers.slice(0, idx), teachers.slice(idx + 1)));\r\n                                }\r\n                            } })),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(\"input\", { type: \"text\", style: { width: \"100%\" }, value: teacher.email || teacher.url, onKeyDown: function (ev) {\r\n                                if (ev.which === 9 &&\r\n                                    !ev.shiftKey &&\r\n                                    idx === teachers.length - 1 &&\r\n                                    (teachers.length < 1 || !!teachers[teachers.length - 1].name)) {\r\n                                    setSelectingTeacher(true);\r\n                                    ev.preventDefault();\r\n                                }\r\n                            }, onChange: function (ev) {\r\n                                var editedTeacher = tslib_1.__assign({}, teacher, { url: ev.target.value, email: ev.target.value });\r\n                                if (ev.target.value || teacher.name) {\r\n                                    // Update row\r\n                                    var clone = tslib_1.__spread(teachers);\r\n                                    clone[idx] = editedTeacher;\r\n                                    onUpdate(clone);\r\n                                }\r\n                                else {\r\n                                    // Remove row\r\n                                    onUpdate(tslib_1.__spread(teachers.slice(0, idx), teachers.slice(idx + 1)));\r\n                                }\r\n                            } })),\r\n                    displayTeacherRights && React.createElement(\"td\", null,\r\n                        React.createElement(\"select\", { disabled: !(teacher.email || teacher.url), value: teacher.access || 'edit', onChange: function (ev) {\r\n                                var clone = tslib_1.__spread(teachers);\r\n                                clone[idx] = tslib_1.__assign({}, teacher, { access: ev.target.value });\r\n                                onUpdate(clone);\r\n                            } },\r\n                            React.createElement(\"option\", { value: \"read\" }, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"L\\u00E4sa\"], [\"L\\u00E4sa\"])))),\r\n                            React.createElement(\"option\", { value: \"edit\" }, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Redigera\"], [\"Redigera\"])))),\r\n                            React.createElement(\"option\", { value: \"full\" }, L(templateObject_6 || (templateObject_6 = tslib_1.__makeTemplateObject([\"Full\"], [\"Full\"])))))),\r\n                    React.createElement(\"td\", null,\r\n                        React.createElement(RemoveItem, { onClick: function () {\r\n                                onUpdate(tslib_1.__spread(teachers.slice(0, idx), teachers.slice(idx + 1)));\r\n                            } })));\r\n            }))),\r\n        React.createElement(\"br\", null),\r\n        selectingTeacher ?\r\n            React.createElement(Observe, { fallback: React.createElement(Spinner, null), errorFallback: L(templateObject_7 || (templateObject_7 = tslib_1.__makeTemplateObject([\"Kunder inte h\\u00E4mta skolans l\\u00E4rare fr\\u00E5n EDS\"], [\"Kunder inte h\\u00E4mta skolans l\\u00E4rare fr\\u00E5n EDS\"]))) },\r\n                React.createElement(SelectTeacher, { school: school, selectedTeachers: teachers, onBlur: function () { return setSelectingTeacher(false); }, onSelect: function (_a) {\r\n                        var name = _a.name, email = _a.email;\r\n                        var newTeacher = {\r\n                            name: name,\r\n                            email: email,\r\n                            url: email,\r\n                            access: 'edit'\r\n                        };\r\n                        var clone = tslib_1.__spread(teachers);\r\n                        clone.push(newTeacher);\r\n                        onUpdate(clone);\r\n                        setSelectingTeacher(false);\r\n                    } })) :\r\n            React.createElement(\"a\", { className: \"btn\", onClick: function () {\r\n                    setSelectingTeacher(true);\r\n                } },\r\n                React.createElement(\"i\", { className: \"fa fa-user-plus\", \"aria-hidden\": true }), L(templateObject_8 || (templateObject_8 = tslib_1.__makeTemplateObject([\" L\\u00E4gg till ansvarig l\\u00E4rare\"], [\" L\\u00E4gg till ansvarig l\\u00E4rare\"])))));\r\n}\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5, templateObject_6, templateObject_7, templateObject_8;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { EditWorkflowLink } from '../modal-pages/edit-workflow-link';\r\nvar EditableWorkFlowLink = /** @class */ (function (_super) {\r\n    tslib_1.__extends(EditableWorkFlowLink, _super);\r\n    function EditableWorkFlowLink(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    EditableWorkFlowLink.prototype.render = function () {\r\n        var _a = this.props, host = _a.host, onUpdate = _a.onUpdate, url = _a.url;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"div\", { className: \"taskContainer\" }, url &&\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { className: \"editItem\", onClick: function () { return host.openDialog({\r\n                                Component: EditWorkflowLink,\r\n                                props: {\r\n                                    url: url,\r\n                                    onSave: function (newUrl) {\r\n                                        onUpdate({ $set: newUrl });\r\n                                        host.closeDialog();\r\n                                    },\r\n                                    onDelete: function () {\r\n                                        onUpdate({ $set: undefined });\r\n                                        host.closeDialog();\r\n                                    }\r\n                                }\r\n                            }); } })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"a\", { href: url, target: \"_blank\" }, \"Nuvarande arbetsg\\u00E5ng\")))),\r\n            !url && React.createElement(\"a\", { className: \"btn\", onClick: function () { return host.openDialog({\r\n                    Component: EditWorkflowLink,\r\n                    props: {\r\n                        onSave: function (newUrl) {\r\n                            onUpdate({ $set: newUrl });\r\n                            host.closeDialog();\r\n                        }\r\n                    }\r\n                }); } },\r\n                React.createElement(\"i\", { className: \"fa fa-paperclip\", \"aria-hidden\": true }),\r\n                \" Koppla en arbetsg\\u00E5ng till kursen\"));\r\n    };\r\n    return EditableWorkFlowLink;\r\n}(React.Component));\r\nexport { EditableWorkFlowLink };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport { getPartialContentDefaultView, getRequirmentSentences, getCoveredSenteces, getSavedSentences, isPartialCoveredRequirment, getMigrationTitle, getSortedRequirments, allRequirementSentecesMarked } from '../knowledge-matrix-partial-utils';\r\nvar KnowledgeMatrix = /** @class */ (function (_super) {\r\n    tslib_1.__extends(KnowledgeMatrix, _super);\r\n    function KnowledgeMatrix(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    KnowledgeMatrix.prototype.getKnowledgeSentencesContent = function (requirement, partialRequirments, index, markedOk, isMigrated) {\r\n        var _this = this;\r\n        var _a = this.props, coveredPartialRequirments = _a.coveredPartialRequirments, markMode = _a.markMode;\r\n        //split text in senteces\r\n        var textSentences = getRequirmentSentences(requirement.name);\r\n        //get saved sencenteces for the current requirement\r\n        var rowRequirments = partialRequirments && getSavedSentences(partialRequirments);\r\n        //get all saved senteces excluding the current ones\r\n        var allCoveredSentenceReq = coveredPartialRequirments && getCoveredSenteces(coveredPartialRequirments, requirement.id);\r\n        return React.createElement(\"td\", { key: index, title: getMigrationTitle(isMigrated, markMode) }, textSentences.map(function (sentence, k) {\r\n            var trimmedSentence = sentence.trim();\r\n            var hasValue = rowRequirments && rowRequirments.includes(trimmedSentence) || markedOk && !rowRequirments;\r\n            var sentenceNotMarked = !allCoveredSentenceReq.includes(trimmedSentence);\r\n            return React.createElement(\"span\", { key: k, dangerouslySetInnerHTML: { __html: sentence ? sentence + \".\" : \"\" }, className: \"selectable\" + (hasValue ? \" markedGreen\" : (sentenceNotMarked ? \" markedRed\" : \"\")), onClick: function () {\r\n                    var updatedRequirments = partialRequirments ? Object.assign([], partialRequirments) : [];\r\n                    var shouldBeRemoved = rowRequirments && rowRequirments.includes(trimmedSentence);\r\n                    //check if no partial data saved, but the requirment is markedOk\r\n                    if (markedOk && (!rowRequirments || rowRequirments.length == 0)) {\r\n                        //save all excepting the one that should be removed\r\n                        updatedRequirments = textSentences.filter(function (x) { return x != sentence; });\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                    else {\r\n                        if (shouldBeRemoved) {\r\n                            updatedRequirments = partialRequirments.filter(function (req) { return req != sentence; });\r\n                        }\r\n                        else {\r\n                            updatedRequirments.push(sentence);\r\n                        }\r\n                        _this.props.onUpdatePartialKnowledge(requirement.id, getSortedRequirments(textSentences, updatedRequirments));\r\n                    }\r\n                } });\r\n        }));\r\n    };\r\n    KnowledgeMatrix.prototype.onRequirementChanged = function (requirement, value, partialValues, allPartialMarked) {\r\n        if (this.props.onUpdatePartialKnowledge) {\r\n            //remove all saved senteces if the requirement is unchecked\r\n            (value && !partialValues || allPartialMarked) ? this.props.onUpdatePartialKnowledge(requirement.id, []) : this.props.onUpdatePartialKnowledge(requirement.id, getRequirmentSentences(requirement.name));\r\n        }\r\n        else {\r\n            this.props.onMarkChanged(requirement.id, !value);\r\n        }\r\n    };\r\n    KnowledgeMatrix.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, knowledgeRequirements = _a.knowledgeRequirements, markedIds = _a.markedIds, migratedIds = _a.migratedIds, explainedRequirements = _a.explainedRequirements, markBySentenceView = _a.markBySentenceView, markPartialFeatureEnabled = _a.markPartialFeatureEnabled;\r\n        var _b = this.props, idsToMarkNotOk = _b.idsToMarkNotOk, markMode = _b.markMode, onExplainedRequirementsChanged = _b.onExplainedRequirementsChanged, partialRequirments = _b.partialRequirments, coveredPartialRequirments = _b.coveredPartialRequirments;\r\n        var columns = [\"E\", \"C\", \"A\"];\r\n        var rows = [];\r\n        var reqs = knowledgeRequirements.slice();\r\n        var row = null;\r\n        while (true) {\r\n            row = columns.map(function (grade) {\r\n                var pNext = reqs.findIndex(function (r) { return r.gradeStep && r.gradeStep.toUpperCase() === grade; });\r\n                if (pNext < 0)\r\n                    return null;\r\n                var rv = reqs[pNext];\r\n                reqs.splice(pNext, 1);\r\n                return rv;\r\n            });\r\n            if (row.every(function (r) { return r === null; }))\r\n                break;\r\n            rows.push(row);\r\n        }\r\n        return React.createElement(\"table\", { className: \"knowledge-matrix\" },\r\n            React.createElement(\"thead\", null,\r\n                React.createElement(\"tr\", null, columns.map(function (c) { return React.createElement(\"th\", { key: c }, c); }))),\r\n            React.createElement(\"tbody\", null, rows.map(function (row, i) { return React.createElement(React.Fragment, { key: i },\r\n                React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0;\r\n                    var isMarkedNotOK = requirement && idsToMarkNotOk && idsToMarkNotOk[requirement.id]; //not used anymore\r\n                    var isMigrated = requirement && migratedIds && !!migratedIds[requirement.id];\r\n                    var rowPartialRequirements = requirement && partialRequirments && partialRequirments[requirement.id];\r\n                    var partialValues = rowPartialRequirements && getSavedSentences(rowPartialRequirements);\r\n                    var allReqSentencesMarked = requirement && allRequirementSentecesMarked(requirement.name, partialValues);\r\n                    var hasPartialCovered = requirement && isPartialCoveredRequirment(requirement, coveredPartialRequirments);\r\n                    var markedRed = !(partialValues && partialValues.length > 0 || hasPartialCovered);\r\n                    return requirement && markBySentenceView && markPartialFeatureEnabled ? _this.getKnowledgeSentencesContent(requirement, rowPartialRequirements, j, isMarkedOK, isMigrated) :\r\n                        React.createElement(\"td\", { key: j, dangerouslySetInnerHTML: { __html: requirement ? (rowPartialRequirements && rowPartialRequirements.length || hasPartialCovered) ?\r\n                                    getPartialContentDefaultView(requirement, rowPartialRequirements, coveredPartialRequirments, markedRed) : requirement.name : \"\" }, className: (markMode ? \"selectable\" : \"\") +\r\n                                (isMigrated ? \" migrated\" : \"\") +\r\n                                (isMarkedOK && (!rowPartialRequirements || allReqSentencesMarked) ?\r\n                                    \" markedGreen\" :\r\n                                    markedRed ?\r\n                                        \" markedRed\" :\r\n                                        \"\"), onClick: markMode && requirement ?\r\n                                function () { return _this.onRequirementChanged(requirement, isMarkedOK, partialValues, allReqSentencesMarked); } :\r\n                                undefined, title: getMigrationTitle(isMigrated, markMode) });\r\n                })),\r\n                explainedRequirements && React.createElement(\"tr\", null, row.map(function (requirement, j) {\r\n                    var partialSentences = requirement && partialRequirments && partialRequirments[requirement.id] && getSavedSentences(partialRequirments[requirement.id]);\r\n                    var isMarkedOK = requirement && markedIds && markedIds.indexOf(requirement.id) >= 0 || partialSentences && partialSentences.length > 0;\r\n                    return React.createElement(\"td\", { key: j }, isMarkedOK ? React.createElement(\"textarea\", { placeholder: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Beskrivning av kravet\"], [\"Beskrivning av kravet\"]))), className: \"inputTextBox inputTextLarge\", style: { width: \"100%\" }, readOnly: !markMode, value: (requirement && explainedRequirements[requirement.id]) || \"\", onChange: requirement && onExplainedRequirementsChanged && (function (ev) { return onExplainedRequirementsChanged(requirement.id, ev.target.value); }) }) : undefined);\r\n                }))); })));\r\n        { /*return <div>\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th>E</th>\r\n                <th>C</th>\r\n                <th>A</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {tbody.map((row, i) =>\r\n              <tr key={i}>{row.map((cell, j) => {\r\n                const isMarkedOK = props.markedIds && props.markedIds.indexOf(cell.id) >= 0;\r\n                const isMarkedNotOK = props.idsToMarkNotOk && props.idsToMarkNotOk[cell.id];\r\n                return <td\r\n                  key={j}\r\n                  rowSpan={cell.rowSpan}\r\n                  className={(props.markMode ? \"selectable\" : \"\") +\r\n                    (isMarkedOK ?\r\n                      \" markedGreen\" :\r\n                      (isMarkedNotOK ?\r\n                        \" markedRed\":\r\n                        \"\"))}\r\n                  onClick={props.markMode && (()=>props.onMarkChanged(cell.id, !isMarkedOK))}>\r\n                  {cell.html && <div style={{position: 'relative'}}>\r\n                    <p\r\n                      className={cell.type === 'ability' ? 'abilityText' : 'criteriaText'}\r\n                      dangerouslySetInnerHTML={{__html: cell.html}} />\r\n                    {props.editMode && <RemoveItem className=\"upperRight\" onClick={()=>\r\n                      this.setCellIds(\r\n                        cell.type,\r\n                        cell.rowIndex,\r\n                        this.getCellIds(\r\n                          cell.type,\r\n                          cell.rowIndex).filter(id => id != cell.id) )} /> }\r\n                  </div>}\r\n                </td>})}\r\n              </tr>)}\r\n            </tbody>\r\n          </table>\r\n        </div>*/\r\n        }\r\n    };\r\n    return KnowledgeMatrix;\r\n}(React.Component));\r\nexport { KnowledgeMatrix };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from \"../../../utils/utils\";\r\n;\r\nexport var RemoveItem = function (_a) {\r\n    var onClick = _a.onClick, className = _a.className, style = _a.style, title = _a.title;\r\n    return React.createElement(\"div\", { title: title || L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Radera\"], [\"Radera\"]))), className: \"removeItem \" + (className || \"\"), onClick: onClick, style: style });\r\n};\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { showError, compareProp } from '../../../utils/utils';\r\nimport { mySchoolCoursesRepo } from \"../../../repos/school-courses\";\r\nimport { Spinner } from \"./spinner\";\r\nimport { Link } from 'react-router-dom';\r\nimport { shortDateFormat } from \"../utils\";\r\nimport env from '../../../globals/KED.env';\r\nimport { OpenCloseBox } from '../../utility-components/open-close-box';\r\nvar SchoolCourses = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SchoolCourses, _super);\r\n    function SchoolCourses(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            schoolCourses: null\r\n        };\r\n        _this.onSchoolCoursesUpdated = _this.onSchoolCoursesUpdated.bind(_this);\r\n        return _this;\r\n    }\r\n    SchoolCourses.prototype.componentDidMount = function () {\r\n        mySchoolCoursesRepo.subscribe(this.onSchoolCoursesUpdated).catch(showError);\r\n    };\r\n    SchoolCourses.prototype.componentWillUnmount = function () {\r\n        mySchoolCoursesRepo.unsubscribe(this.onSchoolCoursesUpdated);\r\n    };\r\n    SchoolCourses.prototype.onSchoolCoursesUpdated = function (schoolCourses) {\r\n        var compareName = compareProp(\"name\");\r\n        var compareCreatedDate = compareProp(\"createdDate\");\r\n        schoolCourses.sort(function (a, b) { return compareName(a, b) || compareCreatedDate(a, b); });\r\n        this.setState({ schoolCourses: schoolCourses });\r\n    };\r\n    SchoolCourses.prototype.outputCourses = function (courses, header, open) {\r\n        return (React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, header), headerOpen: open, contentClassName: \"odd-even\" }, courses.map(function (course) {\r\n            return React.createElement(\"div\", { className: \"schoolCourse\", key: course.id },\r\n                React.createElement(\"div\", { className: \"align-horizontal\" },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top pull-right\" },\r\n                        React.createElement(Link, { to: \"/courses/\" + course.id + \"/edit\", className: \"editItem\" })),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(Link, { to: \"/courses/\" + course.id + \"/edit\" }, course.name)),\r\n                    React.createElement(\"div\", { className: \"horizontalItem top\" }, course.active && React.createElement(\"div\", { className: \"pill active\" }, \"Aktiv\")),\r\n                    course.active && !course.publishable && React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                        React.createElement(\"div\", { className: \"pill incomplete\" }, \"Inkomplett\"))),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"p\", null, course.description)),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, course.modifiedBy ?\r\n                    React.createElement(\"p\", { className: \"small\" },\r\n                        \"Redigerad av \",\r\n                        course.modifiedBy.name,\r\n                        \" / \",\r\n                        shortDateFormat(course.modifiedDate)) :\r\n                    React.createElement(\"p\", { className: \"small\", style: { fontStyle: 'italic' } }, \" \")));\r\n        })));\r\n    };\r\n    SchoolCourses.prototype.render = function () {\r\n        var schoolCourses = this.state.schoolCourses;\r\n        var myCourses = [];\r\n        var othersCourses = [];\r\n        if (schoolCourses) {\r\n            var me_1 = env.currentUser.mail;\r\n            schoolCourses.forEach(function (course) {\r\n                if (course.activatedBy && course.activatedBy.url == me_1) {\r\n                    myCourses.push(course);\r\n                }\r\n                else if (course.responsibleTeachers.filter(function (t) { return t.url == me_1; }).length > 0) {\r\n                    myCourses.push(course);\r\n                }\r\n                else {\r\n                    othersCourses.push(course);\r\n                }\r\n            });\r\n        }\r\n        return React.createElement(\"div\", { className: \"sv-html-portlet sv-portlet sv-skip-spacer\" },\r\n            React.createElement(\"div\", { className: \"ked_boxed\" },\r\n                React.createElement(\"h3\", null, \"Skolans kurser\"),\r\n                React.createElement(\"div\", { className: \"taskContainer odd-even\" }, !schoolCourses ?\r\n                    React.createElement(\"p\", null,\r\n                        React.createElement(Spinner, null),\r\n                        \" Laddar skolans kurser\") :\r\n                    React.createElement(React.Fragment, null,\r\n                        this.outputCourses(myCourses, 'Mina kurser', true),\r\n                        this.outputCourses(othersCourses, 'Andra kurser', false))),\r\n                location.hash !== \"#/courses/new\" && React.createElement(Link, { className: \"btn\", to: \"/courses/new\", onClick: function () { return window.scroll(0, 0); } }, \"Skapa ny kurs\")));\r\n    };\r\n    return SchoolCourses;\r\n}(React.Component));\r\nexport { SchoolCourses };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { OpenCloseBox } from \"../../utility-components/open-close-box\";\r\nimport { arrayToLookup } from '../../../utils/utils';\r\nvar SelectRelatedDocs = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SelectRelatedDocs, _super);\r\n    function SelectRelatedDocs(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {};\r\n        return _this;\r\n    }\r\n    SelectRelatedDocs.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, options = _a.options, title = _a.title, markedIds = _a.markedIds, markMode = _a.markMode, migratedIds = _a.migratedIds, uncoveredIds = _a.uncoveredIds;\r\n        var groupedOptions = arrayToLookup(options, function (d) { return d.group || \"default\"; });\r\n        var groups = Object.keys(groupedOptions);\r\n        return React.createElement(OpenCloseBox, { title: React.createElement(\"p\", null, title), className: \"larger\" }, groups.map(function (group) { return React.createElement(React.Fragment, { key: group },\r\n            groups.length === 1 ? null : React.createElement(React.Fragment, null,\r\n                React.createElement(\"br\", null),\r\n                React.createElement(\"h5\", null, group),\r\n                React.createElement(\"hr\", null)),\r\n            groupedOptions[group].map(function (option) {\r\n                var isMarked = markedIds.some(function (x) { return x === option.id; });\r\n                var isMigrated = migratedIds && !!migratedIds[option.id];\r\n                var isUncovered = uncoveredIds && uncoveredIds[option.id];\r\n                return React.createElement(\"div\", { className: \"align-horizontal\", key: option.id, onClick: function () {\r\n                        return markMode && _this.props.onMarkChanged(option.id, !isMarked);\r\n                    } },\r\n                    React.createElement(\"div\", { className: \"horizontalItem top spaced\" +\r\n                            (markMode ? \" selectable\" : \"\") +\r\n                            (isMarked ? \" markedGreen\" : (isUncovered ?\r\n                                \" markedRed\" :\r\n                                \"\")) +\r\n                            (isMigrated ? \" migrated\" : \"\"), title: isMigrated ?\r\n                            markMode ?\r\n                                \"Skolverket har uppdaterat textens formulering. Du kan granska \\u00E4ndringen genom att f\\u00E4lla ut varningsboxen till h\\u00F6ger, med titel \\\"Uppdaterade formuleringar fr\\u00E5n Skolverket\\\"\" :\r\n                                \"Skolverket har uppdaterat textens formulering, men detta har \\u00E4nnu inte granskats av uppgiftens redigeringsbeh\\u00F6rige\" :\r\n                            undefined },\r\n                        React.createElement(\"p\", { dangerouslySetInnerHTML: { __html: option.name } }),\r\n                        React.createElement(\"br\", null)));\r\n            })); }));\r\n    };\r\n    return SelectRelatedDocs;\r\n}(React.Component));\r\nexport { SelectRelatedDocs };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport Select from 'react-select';\r\nimport { env } from '../../../globals/KED.env';\r\nimport { db } from '../../../globals/db';\r\nimport { mockTuitionGroups } from '../../../apis/mock/mock-classroom-data';\r\nexport function SelectStudyGroups(_a) {\r\n    var school = _a.school, courseCode = _a.courseCode, selectedStudyGroups = _a.selectedStudyGroups, placeholder = _a.placeholder, onUpdate = _a.onUpdate;\r\n    // Mock-data for KED\r\n    var emptyOrMock = school === 'KED' && mockTuitionGroups[courseCode] ? mockTuitionGroups[courseCode] : [];\r\n    // Map given {school} to its name in EDS:\r\n    var edsSchoolNameGymn = db.schools\r\n        .cacheOptimized() // Will add cacheBust to the query (making server add cache header)\r\n        .name(school).single() // Get the single school instance with name={school}\r\n        .read().edsSchoolNameGymn; // Read it the suspense-way (throwing Promise if not there...)\r\n    // List studygroups for that school and given course:\r\n    var studyGroups = edsSchoolNameGymn ? env.edsClient.suspense.getSchoolTuitionGroups({\r\n        schoolName: edsSchoolNameGymn,\r\n        courseCode: courseCode\r\n    }) : emptyOrMock;\r\n    // Convert to option objects as react-select wants them:\r\n    var options = studyGroups.map(function (sg) { return ({\r\n        label: sg.tuitionGroupName,\r\n        value: sg.tuitionGroupName\r\n    }); });\r\n    // Display the mutliselect:\r\n    return React.createElement(Select, { isMulti: true, options: options, value: selectedStudyGroups.map(function (group) { return ({ label: group, value: group }); }), placeholder: placeholder, noOptionsMessage: function () { return L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde inte hitta undervisningsgrupper f\\u00F6r denna kurs\"], [\"Kunde inte hitta undervisningsgrupper f\\u00F6r denna kurs\"]))); }, onChange: function (options) {\r\n            onUpdate(options.map(function (_a) {\r\n                var value = _a.value;\r\n                return value;\r\n            }));\r\n        } });\r\n}\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nimport { db } from '../../../globals/db';\r\nimport { env } from '../../../globals/KED.env';\r\nimport { arrayToLookup, compareProps, L } from '../../../utils/utils';\r\nimport { cfg } from '../../../globals/KED.cfg';\r\nimport Select from 'react-select';\r\nimport { isAdminOrTeacherAtSchool } from '../../../access-control';\r\nimport { mockTeachers } from '../../../apis/mock/mock-classroom-data';\r\nexport function SelectTeacher(_a) {\r\n    //\r\n    // Load the teacher list asynchronically (using suspense)\r\n    //\r\n    var school = _a.school, selectedTeachers = _a.selectedTeachers, onSelect = _a.onSelect, onBlur = _a.onBlur;\r\n    // Mock-data for KED\r\n    var emptyOrMock = school === 'KED' ? mockTeachers : [];\r\n    // Suspense-read from KedBackend:\r\n    var edsSchoolNameGymn = db.schools.cacheOptimized().name(school).single().read().edsSchoolNameGymn;\r\n    // Suspense-read from EDS:\r\n    var edsTeachers = edsSchoolNameGymn ?\r\n        env.edsClient.suspense.getSchoolTeachers({ schoolName: edsSchoolNameGymn }) :\r\n        emptyOrMock;\r\n    var teacherList = edsTeachers.map(function (_a) {\r\n        var teacherFirstName = _a.teacherFirstName, teacherLastName = _a.teacherLastName, teacherEmailAddress = _a.teacherEmailAddress;\r\n        return ({\r\n            label: teacherFirstName + \" \" + teacherLastName,\r\n            value: teacherEmailAddress\r\n        });\r\n    });\r\n    // Add current user to the list (in case current user is ADMIN or EMPLOYEE at the school)\r\n    var addCurrentUser = isAdminOrTeacherAtSchool(env.currentUser, school);\r\n    if (addCurrentUser && !teacherList.some(function (t) { return t.value === env.currentUser.mail; })) {\r\n        teacherList.push({ label: env.currentUser.displayName, value: env.currentUser.mail });\r\n    }\r\n    // Filter out already selected teachers:\r\n    var teacherSet = arrayToLookup(selectedTeachers, function (t) { return t.email; });\r\n    teacherList = teacherList\r\n        .filter(function (t) { return !teacherSet[t.value]; }) // Remove already added ones\r\n        .sort(compareProps([\"label\"], cfg.KED_LOCALE)); // Sort by name\r\n    // Show the select:\r\n    return React.createElement(Select, { isMulti: false, options: teacherList, defaultMenuIsOpen: true, autoFocus: true, onBlur: function () { return onBlur(); }, placeholder: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"V\\u00E4lj bland skolans l\\u00E4rare...\"], [\"V\\u00E4lj bland skolans l\\u00E4rare...\"]))), noOptionsMessage: function () { return L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"Det finns inga fler l\\u00E4rare att v\\u00E4lja fr\\u00E5n\"], [\"Det finns inga fler l\\u00E4rare att v\\u00E4lja fr\\u00E5n\"]))); }, onChange: function (option) {\r\n            var _a = option, label = _a.label, value = _a.value;\r\n            onSelect({ name: label, email: value });\r\n        } });\r\n}\r\nvar templateObject_1, templateObject_2;\r\n","import * as React from 'react';\r\nexport var Spinner = function (_a) {\r\n    var _b = _a.label, label = _b === void 0 ? \"\" : _b;\r\n    return React.createElement(\"span\", null,\r\n        React.createElement(\"i\", { className: \"fa fa-spinner fa-spin\", \"aria-hidden\": \"true\" }),\r\n        \"\\u00A0\",\r\n        label);\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { getTasksPerId } from \"../courses/business-logic\";\r\nimport { futureAbilities } from \"../../../contracts/ked-models\";\r\nimport { OpenCloseBox } from \"../../utility-components/open-close-box\";\r\nvar WeightedItemsTable = /** @class */ (function (_super) {\r\n    tslib_1.__extends(WeightedItemsTable, _super);\r\n    function WeightedItemsTable(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isOpen: false\r\n        };\r\n        return _this;\r\n    }\r\n    WeightedItemsTable.prototype.render = function () {\r\n        var course = this.props.course;\r\n        var isOpen = this.state.isOpen;\r\n        var rows = [];\r\n        var tasksPerId = getTasksPerId(course);\r\n        rows.push(React.createElement(\"tr\", { key: \"centralContent\", className: \"covered-item-label\" },\r\n            React.createElement(\"td\", { colSpan: 2 }, \"Centralt inneh\\u00E5ll\")));\r\n        course.centralContent.forEach(function (cc, idx) { return rows.push(React.createElement(\"tr\", { key: cc.id, className: idx % 2 ? \"tableOdd\" : \"\" },\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", { className: \"criteriaText\", dangerouslySetInnerHTML: { __html: cc.name } })),\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", null, (tasksPerId[cc.id] || []).length)))); });\r\n        rows.push(React.createElement(\"tr\", { key: \"abilities\", className: \"covered-item-label\" },\r\n            React.createElement(\"td\", { colSpan: 2 }, \"F\\u00F6rm\\u00E5gor\")));\r\n        course.abilities.forEach(function (ability, idx) { return rows.push(React.createElement(\"tr\", { key: ability.id, className: idx % 2 ? \"tableOdd\" : \"\" },\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", { className: \"abilityText\", dangerouslySetInnerHTML: { __html: ability.name } })),\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", null, (tasksPerId[ability.id] || []).length)))); });\r\n        rows.push(React.createElement(\"tr\", { key: \"futureAbilities\", className: \"covered-item-label\" },\r\n            React.createElement(\"td\", { colSpan: 2 }, \"Framtidsf\\u00F6rm\\u00E5gor\")));\r\n        futureAbilities.forEach(function (futureAbilityText, idx) { return rows.push(React.createElement(\"tr\", { key: futureAbilityText, className: idx % 2 ? \"tableOdd\" : \"\" },\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", { className: \"abilityText\" }, futureAbilityText)),\r\n            React.createElement(\"td\", null,\r\n                React.createElement(\"p\", null, (tasksPerId[futureAbilityText] || []).length)))); });\r\n        return React.createElement(OpenCloseBox, { className: \"larger\", title: React.createElement(\"p\", null, \"Kursens t\\u00E4ckningstabell\"), contentClassName: \"weighted-items-table\" },\r\n            React.createElement(\"p\", null, \"Tabellen anger hur m\\u00E5nga uppgifter som ber\\u00F6r varje del.\"),\r\n            React.createElement(\"table\", null,\r\n                React.createElement(\"tbody\", null, rows)));\r\n    };\r\n    return WeightedItemsTable;\r\n}(React.Component));\r\nexport { WeightedItemsTable };\r\n","import * as tslib_1 from \"tslib\";\r\nimport env from '../../../../globals/KED.env';\r\nimport { migrateSubject } from './migrate-subject';\r\nimport { loadCourse } from '../../utils';\r\nexport function diffXmlWithDatabase(existingSubject, subjectToImport, changes) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var expandedCourseTemplates, courseSets;\r\n        var _this = this;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', existingSubject.id, { include: [\"courseTemplates\", \"abilities\"] })];\r\n                case 1:\r\n                    // Expand graphs of existing Subject\r\n                    existingSubject = _a.sent();\r\n                    return [4 /*yield*/, Promise.all(existingSubject.courseTemplates.map(function (ct) { return loadCourse(ct.id, {\r\n                            include: [\r\n                                'centralContent',\r\n                                'knowledgeRequirements'\r\n                            ]\r\n                        }); }))];\r\n                case 2:\r\n                    expandedCourseTemplates = _a.sent();\r\n                    console.log(\"Subject: \" + existingSubject.name + \". Courses: \" + expandedCourseTemplates.map(function (_a) {\r\n                        var name = _a.name;\r\n                        return name;\r\n                    }));\r\n                    return [4 /*yield*/, Promise.all(expandedCourseTemplates.map(function (courseTemplate) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var _a;\r\n                            return tslib_1.__generator(this, function (_b) {\r\n                                switch (_b.label) {\r\n                                    case 0:\r\n                                        _a = {\r\n                                            template: courseTemplate\r\n                                        };\r\n                                        return [4 /*yield*/, env.kedBackendClient.list(\"courses\", { name: courseTemplate.name, include: ['abilities'], flags: ['includeIdsOnly'] })];\r\n                                    case 1: return [2 /*return*/, (_a.instances = _b.sent(),\r\n                                            _a)];\r\n                                }\r\n                            });\r\n                        }); }))];\r\n                case 3:\r\n                    courseSets = _a.sent();\r\n                    /*if (expandedCourseTemplates.some (course => !course.centralContentOrder || !course.knowledgeRequirementsOrder || !course.abilitiesOrder)) {\r\n                      migrateOrderListsOfCourseInstances(courseSets, subjectToImport, changes);\r\n                      // In future, as abilities may be added or removed, we will have to maintain the order of abilities on the course instances,\r\n                      // the same way we do it with central content and knowledge requirements. TODO respect abilities order on every place abilities are enumerated,\r\n                      // such as on course viewer, course builder, etc.\r\n                      migrateAbilitiesOrderOnSubject(existingSubject, courseSets, changes);\r\n                    } else {*/\r\n                    return [4 /*yield*/, migrateSubject(existingSubject, courseSets, subjectToImport, changes)];\r\n                case 4:\r\n                    /*if (expandedCourseTemplates.some (course => !course.centralContentOrder || !course.knowledgeRequirementsOrder || !course.abilitiesOrder)) {\r\n                      migrateOrderListsOfCourseInstances(courseSets, subjectToImport, changes);\r\n                      // In future, as abilities may be added or removed, we will have to maintain the order of abilities on the course instances,\r\n                      // the same way we do it with central content and knowledge requirements. TODO respect abilities order on every place abilities are enumerated,\r\n                      // such as on course viewer, course builder, etc.\r\n                      migrateAbilitiesOrderOnSubject(existingSubject, courseSets, changes);\r\n                    } else {*/\r\n                    _a.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { flatten } from '../../../../utils/utils';\r\nimport env from '../../../../globals/KED.env';\r\nfunction diffSubjectGlobalTexts(dbTextMap, xmlTexts) {\r\n    var e_1, _a;\r\n    var removedIds = new Set();\r\n    var newTexts = new Map();\r\n    var idsToAdd = new Set();\r\n    xmlTexts.forEach(function (newText) {\r\n        newText = newText.trim();\r\n        if (!dbTextMap.has(newText)) {\r\n            var id = createUUID();\r\n            console.log(\"New id: \" + id + \". Text: \" + newText);\r\n            newTexts.set(newText, id);\r\n            idsToAdd.add(id);\r\n        }\r\n        else {\r\n            newTexts.set(newText, dbTextMap.get(newText));\r\n        }\r\n    });\r\n    try {\r\n        for (var _b = tslib_1.__values(dbTextMap.entries()), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n            var _d = tslib_1.__read(_c.value, 2), oldText = _d[0], oldId = _d[1];\r\n            if (xmlTexts.indexOf(oldText) === -1) {\r\n                removedIds.add(oldId);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return {\r\n        removedIds: removedIds,\r\n        newTexts: newTexts,\r\n        idsToAdd: idsToAdd\r\n    };\r\n}\r\nvar _fictiveOldId = 1;\r\nfunction fictiveOldId() {\r\n    return \"fictiveOldId\" + (++_fictiveOldId);\r\n}\r\nvar stopWords = new Set(\r\n// From https://github.com/MihaiValentin/lunr-languages/blob/master/lunr.sv.js#L252\r\n('alla allt att av blev bli blir blivit de dem den denna deras dess dessa det detta dig din dina ditt du där då efter ej eller en er era ert ett från för ha hade han hans har henne hennes hon honom hur här i icke ingen inom inte jag ju kan kunde man med mellan men mig min mina mitt mot mycket ni nu när någon något några och om oss på samma sedan sig sin sina sitta själv skulle som så sådan sådana sådant till under upp ut utan vad var vara varför varit varje vars vart vem vi vid vilka vilkas vilken vilket vår våra vårt än är åt över' +\r\n    ' kring') // This line contains additional stop-words missing in lunr.sv.\r\n    .split(' '));\r\nfunction getLexemes(html) {\r\n    return new Set(removeTags(html).replace(/[^\\w\\såäö]/gi, '').toLowerCase().split(/\\s/)\r\n        .map(function (lexeme) { return lexeme.trim(); })\r\n        .filter(function (lexeme) { return !!lexeme; })\r\n        .filter(function (lexeme) { return !stopWords.has(lexeme); }));\r\n}\r\nfunction removeTags(html) {\r\n    var div = document.createElement('div');\r\n    div.innerHTML = html;\r\n    return '' + div.innerText;\r\n}\r\nfunction getIdsToMigrate(dbTexts, xmlTexts, newTexts, textType, course) {\r\n    var idsToMigrate = new Map();\r\n    dbTexts = dbTexts.map(function (entity) { return (tslib_1.__assign({}, entity, { name: entity.name.trim() })); }).filter(function (_a) {\r\n        var name = _a.name;\r\n        return !!name;\r\n    });\r\n    var xmlSet = new Map();\r\n    xmlTexts.forEach(function (item) { return xmlSet.set(item.html, item); });\r\n    var dbSet = new Map();\r\n    dbTexts.forEach(function (entity) { return dbSet.set(entity.name, entity); });\r\n    // Remove those who already exists identically\r\n    dbTexts = dbTexts.filter(function (entity) { return !xmlSet.has(entity.name); });\r\n    xmlTexts = xmlTexts.filter(function (item) { return !dbSet.has(item.html); });\r\n    // Now, for the remainder, try the best to map old texts to new texts, and when done, check if there are new texts that never got mapped.\r\n    // Start by putting all dbText into the result, without a paired xml text yet:\r\n    dbTexts.forEach(function (dbText) { return idsToMigrate.set(dbText.id, {\r\n        gradeStep: dbText.gradeStep,\r\n        oldText: dbText.name,\r\n        lexemes: getLexemes(dbText.name),\r\n        matchLevel: 0\r\n    }); });\r\n    // Then try to pair each xmlText to an item in idsToMigrate\r\n    var xmlSpinsters = [];\r\n    while (xmlTexts.length > 0) {\r\n        var xmlText = xmlTexts[0];\r\n        var bestMatch = findBestMatch(xmlText);\r\n        if (!bestMatch) {\r\n            xmlSpinsters.push(xmlText);\r\n        }\r\n        else {\r\n            if (bestMatch.newText) {\r\n                // Throw out existing match\r\n                xmlTexts.push({ html: bestMatch.newText, gradeStep: bestMatch.gradeStep });\r\n            }\r\n            var pair = idsToMigrate.get(bestMatch.id);\r\n            // Pair myself with this match:\r\n            pair.newText = xmlText.html;\r\n            pair.matchLevel = bestMatch.myMatchLevel;\r\n            pair.newId = newTexts.get(xmlText.html);\r\n        }\r\n        xmlTexts.shift();\r\n    }\r\n    // For each spinster (new texts that couldn't find any match in old texts),\r\n    // Add them with an fictive old ID but omit oldText to mark it as a newcomer\r\n    xmlSpinsters.forEach(function (spinster) {\r\n        idsToMigrate.set(fictiveOldId(), {\r\n            newId: newTexts.get(spinster.html),\r\n            newText: spinster.html,\r\n            gradeStep: spinster.gradeStep,\r\n            matchLevel: 0,\r\n            lexemes: new Set()\r\n        });\r\n    });\r\n    // Mark typo-fixes\r\n    idsToMigrate.forEach(function (match) {\r\n        var oldText = match.oldText, newText = match.newText;\r\n        if (oldText && newText) {\r\n            if (tslib_1.__spread(getLexemes(oldText)).join(' ') === tslib_1.__spread(getLexemes(newText)).join(' ')) {\r\n                match.isTypoFix = true;\r\n            }\r\n        }\r\n    });\r\n    console.log(\"IdsToMigrate\", tslib_1.__spread(idsToMigrate.values()).map(function (_a) {\r\n        var oldText = _a.oldText, lexemes = _a.lexemes;\r\n        return tslib_1.__spread(lexemes).join(' ') + \": \" + oldText;\r\n    }));\r\n    return idsToMigrate;\r\n    function findBestMatch(xmlText) {\r\n        var xmlLexemes = getLexemes(xmlText.html);\r\n        var possiblePartners = tslib_1.__spread(idsToMigrate.entries()).filter(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), id = _b[0], x = _b[1];\r\n            return x.gradeStep === xmlText.gradeStep;\r\n        })\r\n            .map(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), id = _b[0], _c = _b[1], gradeStep = _c.gradeStep, matchLevel = _c.matchLevel, newText = _c.newText, lexemes = _c.lexemes;\r\n            return ({\r\n                id: id,\r\n                gradeStep: gradeStep,\r\n                matchLevel: matchLevel,\r\n                newText: newText,\r\n                myMatchLevel: getMatchLevel(xmlLexemes, lexemes)\r\n            });\r\n        }).filter(function (pp) { return pp.myMatchLevel >= 50 && (!pp.matchLevel || pp.matchLevel < pp.myMatchLevel); });\r\n        return possiblePartners.sort(function (a, b) { return b.myMatchLevel - a.myMatchLevel; })[0]; // highest first.\r\n    }\r\n    function getMatchLevel(lexemes1, lexemes2) {\r\n        if (lexemes1.size === 0 || lexemes2.size === 0)\r\n            return 0;\r\n        var points1 = 0;\r\n        var points2 = 0;\r\n        lexemes1.forEach(function (word) {\r\n            if (lexemes2.has(word))\r\n                ++points1;\r\n        });\r\n        lexemes2.forEach(function (word) {\r\n            if (lexemes1.has(word))\r\n                ++points2;\r\n        });\r\n        return Math.round(100 * Math.max(points1 / lexemes1.size, points2 / lexemes2.size));\r\n    }\r\n    /*if (dbTexts.length !== xmlTexts.length) {\r\n      // We can no longer assume that the changed texts refer to different formulations of the same meaning.\r\n      // We not map old formulations to new ones.\r\n      // In future, we could handle this case by assuming all old texts not occurring in new data, have been removed and all new have been added.\r\n      throw new Error(\"Number of \" + textType + (course ? ` on course ${course}` : \"\") + \" differs. Cannot migrate.\");\r\n    }\r\n    dbTexts.forEach(({name: oldText, id: oldId, gradeStep}, i) => {\r\n      const xmlText = xmlTexts[i].trim();\r\n      if (oldText.trim() !== xmlText) {\r\n        idsToMigrate.set(oldId, {newText: xmlText, newId: newTexts.get(xmlText), oldText, gradeStep});\r\n      }\r\n    });\r\n    return idsToMigrate;*/\r\n}\r\nexport function migrateSubject(existingSubject, courseSets, subjectToImport, changes) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        function migrateCourseInstance(course, courseToImport, idsToMigrate) {\r\n            var showChanges = !shownChanges.has(course.name);\r\n            shownChanges.add(course.name);\r\n            abilityIdsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, oldText = _a.oldText;\r\n                // Relink the course instance with abilities. This change does not need to be visible in GUI.\r\n                changes.push({\r\n                    mutations: function (br) {\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"abilities\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"abilities\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.abilitiesOrder = subjectToImport.abilities.map(function (html) { return newAbilityTexts.get(html); });\r\n            var ccsToMigrate = idsToMigrate.ccsToMigrate, krsToMigrate = idsToMigrate.krsToMigrate;\r\n            // Central Content\r\n            ccsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, newText = _a.newText, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                changes.push({\r\n                    change: showChanges && (oldText ?\r\n                        newText ?\r\n                            isTypoFix ?\r\n                                \"Tryckfelsr\\u00E4ttning Centralt Inneh\\u00E5ll\" :\r\n                                \"Uppdaterat Centralt Inneh\\u00E5ll\" :\r\n                            \"Borttaget Centralt Inneh\\u00E5ll\" :\r\n                        \"Nytt Centralt Inneh\\u00E5ll\"),\r\n                    content: \"<h4>\" + course.name + \"</h4><strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                    mutations: function (br) {\r\n                        if (newId && ccsToAdd.has(newId) && !createdIds.has(newId)) {\r\n                            var cc = {\r\n                                id: newId,\r\n                                name: newText,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: Date.now()\r\n                            };\r\n                            br.add(\"central-content\", cc);\r\n                            createdIds.add(newId);\r\n                        }\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"centralContent\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"centralContent\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.centralContentOrder = courseToImport.centralContent.map(function (_a) {\r\n                var html = _a.html;\r\n                return newCCTexts.get(html);\r\n            });\r\n            // Knowledge Requirements\r\n            krsToMigrate.forEach(function (_a, oldId) {\r\n                var newId = _a.newId, newText = _a.newText, gradeStep = _a.gradeStep, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                changes.push({\r\n                    change: showChanges && (oldText ?\r\n                        newText ?\r\n                            isTypoFix ?\r\n                                \"Tryckfelsr\\u00E4ttning Kunskapskrav\" :\r\n                                \"Uppdaterat Kunskapskrav\" :\r\n                            \"Borttaget Kunskapskrav\" :\r\n                        \"Nytt Kunskapskrav\"),\r\n                    content: \"<h4>\" + course.name + \"</h4><strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                    mutations: function (br) {\r\n                        if (newId && krsToAdd.has(newId) && !createdIds.has(newId)) {\r\n                            var kr = {\r\n                                id: newId,\r\n                                name: newText,\r\n                                gradeStep: gradeStep,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: Date.now()\r\n                            };\r\n                            console.log(\"Adding Knowledge-Requirement \" + newId + \": \" + newText);\r\n                            br.add(\"knowledge-requirements\", kr);\r\n                            createdIds.add(newId);\r\n                        }\r\n                        if (oldText)\r\n                            br.unlink2(\"courses\", course.id, \"knowledgeRequirements\", oldId);\r\n                        if (newId)\r\n                            br.link2(\"courses\", course.id, \"knowledgeRequirements\", newId);\r\n                    }\r\n                });\r\n            });\r\n            course.knowledgeRequirementsOrder =\r\n                courseToImport.knowledgeRequirements.map(function (kr) { return newKRTexts.get(kr.html); });\r\n            // Updates the course properties centralContentOrder and knowledgeRequirementsOrder\r\n            if (abilityIdsToMigrate.size > 0 || ccsToMigrate.size > 0 || krsToMigrate.size > 0) {\r\n                changes.push({\r\n                    change: !course.isTemplate ? \"Uppdaterad Kursinstans\" : \"Uppdaterad Kursmall\",\r\n                    content: !course.isTemplate ?\r\n                        course.name + \". Skola: \" + (course.school || \"ej angiven\") + \". Beskrivning: \" + (course.description || '') :\r\n                        \"\" + course.name,\r\n                    mutations: function (br) { return br.put(\"courses\", course); }\r\n                });\r\n            }\r\n        }\r\n        // Tasks:\r\n        // 1. ASYNC OPERATION: Go through all tasks that has edges to any of the old ids.\r\n        // 2. For each found task, do:\r\n        //    A: Iterate tags starting with \"course:\". Pick the course code.\r\n        //    B: Populate the new property migrationTasks: {\r\n        //         abilities: {[newId: string]: {oldText: string, oldId: string, importDate: number}}, // Be able to create a chain in the GUI !\r\n        //         centralContent: {[newId: string]: {oldText: string, ...\"...}},\r\n        //         knowledgeRequirements: {[newId: string]: {oldText: string, ...\"...}},\r\n        //       }\r\n        //       OBS1! Mergea abilities, centralCondent och knowledgeRequirements med ev tidigare värden (så man kan importera om och om igen!)\r\n        //       OBS2! oldId kan förekomma på flera newId om task används av flera kurser. \r\n        //    C: Create sets for unlinks and link operations per type.\r\n        //    D: For all courseCodes that the task is taggen on,\r\n        //         * register ccsToMigrate.keys() in the unlink set of central contents\r\n        //         * register ccsToMigrate.values() in the link set of central contents\r\n        //         * --\"-- for knowledgeRequirements\r\n        //    E: unlink and link with regards to abilityIdsToMigrate (keys() and values() respectively).\r\n        //    F: unlink and link according to the created sets of link / unlink operations.\r\n        //    Note: Unlike course instances, there's no order property to take care of here!\r\n        //\r\n        function migrateTasks() {\r\n            return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                function fetchTasksInChunksWithEdgesTo(ids, options) {\r\n                    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n                        var result;\r\n                        return tslib_1.__generator(this, function (_a) {\r\n                            switch (_a.label) {\r\n                                case 0:\r\n                                    // This function should make work around the case when given \"ids\" contains too many items, by\r\n                                    // dividing the requests into several and merge the result using a Map.\r\n                                    if (ids.length === 0)\r\n                                        return [2 /*return*/, []]; // Otherwise we'll request every task in the system.\r\n                                    result = new Map();\r\n                                    console.log(\"Number of ids: \" + ids.length);\r\n                                    return [4 /*yield*/, env.kedBackendClient.list(\"tasks\", tslib_1.__assign({}, options, { hasEdgesTo: ids }))];\r\n                                case 1: \r\n                                //return result.values();\r\n                                return [2 /*return*/, _a.sent()];\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                var oldIds, importDate, tasks, _loop_2, tasks_1, tasks_1_1, task;\r\n                var e_7, _a;\r\n                return tslib_1.__generator(this, function (_b) {\r\n                    switch (_b.label) {\r\n                        case 0:\r\n                            oldIds = tslib_1.__spread(abilityIdsToMigrate.keys(), flatten(idsToMigratePerCourse.map(function (c) { return tslib_1.__spread(c.ccsToMigrate.keys(), c.krsToMigrate.keys()); }))).filter(function (id) { return !id.startsWith('fictiveOldId'); });\r\n                            importDate = Date.now();\r\n                            return [4 /*yield*/, fetchTasksInChunksWithEdgesTo(oldIds, {\r\n                                    include: [\"abilities\", \"knowledgeRequirements\", \"centralContent\"],\r\n                                    flags: [\"includeIdsOnly\"]\r\n                                })];\r\n                        case 1:\r\n                            tasks = _b.sent();\r\n                            _loop_2 = function (task) {\r\n                                var e_8, _a, e_9, _b, e_10, _c, e_11, _d;\r\n                                var oldMT = task.migratedTexts || {\r\n                                    abilities: {},\r\n                                    centralContent: {},\r\n                                    knowledgeRequirements: {}\r\n                                };\r\n                                task.migratedTexts = {\r\n                                    abilities: {},\r\n                                    centralContent: {},\r\n                                    knowledgeRequirements: {}\r\n                                };\r\n                                var mutations = [];\r\n                                var changeDescriptions = [];\r\n                                var _loop_3 = function (id) {\r\n                                    var migrationInfo = abilityIdsToMigrate.get(id);\r\n                                    if (migrationInfo) {\r\n                                        var newId_1 = migrationInfo.newId, newText = migrationInfo.newText, isTypoFix = migrationInfo.isTypoFix;\r\n                                        var oldText = migrationInfo.oldText;\r\n                                        var oldId = id;\r\n                                        if (oldMT.abilities[id]) {\r\n                                            // If migrating stuff that was never acknowledges by a teacher,\r\n                                            // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                            oldText = oldMT.abilities[id].oldText;\r\n                                            oldId = oldMT.abilities[id].oldId;\r\n                                        }\r\n                                        if (newId_1 && oldText !== newText) {\r\n                                            // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                            if (!isTypoFix) {\r\n                                                // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                task.migratedTexts.abilities[newId_1] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                            }\r\n                                        }\r\n                                        mutations.push(function (br) {\r\n                                            br.unlink2(\"tasks\", task.id, \"abilities\", id);\r\n                                            if (newId_1)\r\n                                                br.link2(\"tasks\", task.id, \"abilities\", newId_1);\r\n                                        });\r\n                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                        if (newId_1) {\r\n                                            changeDescriptions.push(newText);\r\n                                        }\r\n                                    }\r\n                                };\r\n                                try {\r\n                                    for (var _e = (e_8 = void 0, tslib_1.__values(task.abilities)), _f = _e.next(); !_f.done; _f = _e.next()) {\r\n                                        var id = _f.value.id;\r\n                                        _loop_3(id);\r\n                                    }\r\n                                }\r\n                                catch (e_8_1) { e_8 = { error: e_8_1 }; }\r\n                                finally {\r\n                                    try {\r\n                                        if (_f && !_f.done && (_a = _e.return)) _a.call(_e);\r\n                                    }\r\n                                    finally { if (e_8) throw e_8.error; }\r\n                                }\r\n                                var taskCourseCodes = new Set(task.tags ?\r\n                                    task.tags.filter(function (t) { return t.startsWith('course:'); }).map(function (t) { return t.substr(\"course:\".length); }) :\r\n                                    []);\r\n                                // We need to keep track of linkedIds (for this particular task) for the following reason:\r\n                                // Let's say the task was referred to by two different courses (possible in old versions),\r\n                                // and in old Central Content, the two courses did have slightly different formulations of central content,\r\n                                // so the task was mapped to both of them. Then, in new XML, the same central content was formulated\r\n                                // in a new way that is identical this time between the two courses. Then both old IDs will be replaced\r\n                                // by a single new ID. It would then be unnescessary to link to the new ID twice.\r\n                                var linkedIds = new Set();\r\n                                try {\r\n                                    for (var idsToMigratePerCourse_1 = (e_9 = void 0, tslib_1.__values(idsToMigratePerCourse)), idsToMigratePerCourse_1_1 = idsToMigratePerCourse_1.next(); !idsToMigratePerCourse_1_1.done; idsToMigratePerCourse_1_1 = idsToMigratePerCourse_1.next()) {\r\n                                        var _g = idsToMigratePerCourse_1_1.value, krsToMigrate = _g.krsToMigrate, ccsToMigrate = _g.ccsToMigrate, courseCode = _g.courseCode;\r\n                                        if (taskCourseCodes.size === 0 || taskCourseCodes.has(courseCode)) {\r\n                                            var _loop_4 = function (id) {\r\n                                                var migrationInfo = ccsToMigrate.get(id);\r\n                                                if (migrationInfo) {\r\n                                                    var newId_2 = migrationInfo.newId, newText = migrationInfo.newText, oldText = migrationInfo.oldText, isTypoFix = migrationInfo.isTypoFix;\r\n                                                    var oldId = id;\r\n                                                    if (oldMT.centralContent[id]) {\r\n                                                        // If migrating stuff that was never acknowledges by a teacher,\r\n                                                        // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                                        oldText = oldMT.centralContent[id].oldText;\r\n                                                        oldId = oldMT.centralContent[id].oldId;\r\n                                                    }\r\n                                                    if (newId_2 && oldText !== newText) {\r\n                                                        // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                                        if (!isTypoFix) {\r\n                                                            // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                            task.migratedTexts.centralContent[newId_2] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                                        }\r\n                                                    }\r\n                                                    if (!newId_2 || !linkedIds.has(newId_2)) {\r\n                                                        mutations.push(function (br) {\r\n                                                            br.unlink2(\"tasks\", task.id, \"centralContent\", id);\r\n                                                            if (newId_2)\r\n                                                                br.link2(\"tasks\", task.id, \"centralContent\", newId_2);\r\n                                                        });\r\n                                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                                        if (newId_2) {\r\n                                                            changeDescriptions.push(newText);\r\n                                                            linkedIds.add(newId_2);\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            };\r\n                                            try {\r\n                                                for (var _h = (e_10 = void 0, tslib_1.__values(task.centralContent)), _j = _h.next(); !_j.done; _j = _h.next()) {\r\n                                                    var id = _j.value.id;\r\n                                                    _loop_4(id);\r\n                                                }\r\n                                            }\r\n                                            catch (e_10_1) { e_10 = { error: e_10_1 }; }\r\n                                            finally {\r\n                                                try {\r\n                                                    if (_j && !_j.done && (_c = _h.return)) _c.call(_h);\r\n                                                }\r\n                                                finally { if (e_10) throw e_10.error; }\r\n                                            }\r\n                                            var _loop_5 = function (id) {\r\n                                                var migrationInfo = krsToMigrate.get(id);\r\n                                                if (migrationInfo) {\r\n                                                    var newId_3 = migrationInfo.newId, newText = migrationInfo.newText, oldText = migrationInfo.oldText, isTypoFix = migrationInfo.isTypoFix;\r\n                                                    var oldId = id;\r\n                                                    if (oldMT.knowledgeRequirements[id]) {\r\n                                                        // If migrating stuff that was never acknowledges by a teacher,\r\n                                                        // We should point out the very old id and text instead of the never-acknowledged one.\r\n                                                        oldText = oldMT.knowledgeRequirements[id].oldText;\r\n                                                        oldId = oldMT.knowledgeRequirements[id].oldId;\r\n                                                    }\r\n                                                    if (newId_3 && oldText !== newText) {\r\n                                                        // Special case: If oldText === newText, then this is a reimport new XML that reverts back to origin text. Don't require acknowledgement from teacher!\r\n                                                        if (!isTypoFix) {\r\n                                                            // If this wasn't just a typo fix (changes in stop words, casing or special characters)\r\n                                                            task.migratedTexts.knowledgeRequirements[newId_3] = { oldId: oldId, oldText: oldText, importDate: importDate };\r\n                                                        }\r\n                                                    }\r\n                                                    if (!newId_3 || !linkedIds.has(newId_3)) {\r\n                                                        mutations.push(function (br) {\r\n                                                            br.unlink2(\"tasks\", task.id, \"knowledgeRequirements\", id);\r\n                                                            if (newId_3)\r\n                                                                br.link2(\"tasks\", task.id, \"knowledgeRequirements\", newId_3);\r\n                                                        });\r\n                                                        changeDescriptions.push(\"<strike>\" + oldText + \"</strike>\");\r\n                                                        if (newId_3) {\r\n                                                            changeDescriptions.push(newText);\r\n                                                            linkedIds.add(newId_3);\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            };\r\n                                            try {\r\n                                                for (var _k = (e_11 = void 0, tslib_1.__values(task.knowledgeRequirements)), _l = _k.next(); !_l.done; _l = _k.next()) {\r\n                                                    var id = _l.value.id;\r\n                                                    _loop_5(id);\r\n                                                }\r\n                                            }\r\n                                            catch (e_11_1) { e_11 = { error: e_11_1 }; }\r\n                                            finally {\r\n                                                try {\r\n                                                    if (_l && !_l.done && (_d = _k.return)) _d.call(_k);\r\n                                                }\r\n                                                finally { if (e_11) throw e_11.error; }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                                catch (e_9_1) { e_9 = { error: e_9_1 }; }\r\n                                finally {\r\n                                    try {\r\n                                        if (idsToMigratePerCourse_1_1 && !idsToMigratePerCourse_1_1.done && (_b = idsToMigratePerCourse_1.return)) _b.call(idsToMigratePerCourse_1);\r\n                                    }\r\n                                    finally { if (e_9) throw e_9.error; }\r\n                                }\r\n                                changes.push({\r\n                                    change: \"Migrerad Uppgift\",\r\n                                    content: \"<h4>\" + task.name + \" \" + (task.school ? \"(\" + task.school + \") \" : '(skola ej angiven)') + \"</h4>\\n          <p>Kurskod: \" + tslib_1.__spread(taskCourseCodes).join(',') + \"</p>\\n          \" + changeDescriptions.map(function (txt) { return \"<p>\" + txt + \"</p>\"; }).join(''),\r\n                                    mutations: function (br) {\r\n                                        br.put(\"tasks\", task);\r\n                                        mutations.forEach(function (m) { return m(br); });\r\n                                    }\r\n                                });\r\n                            };\r\n                            try {\r\n                                /*const tasks = await env.kedBackendClient.list<Task>(\"tasks\", {\r\n                                  hasEdgesTo: oldIds,\r\n                                  include: [\"abilities\", \"knowledgeRequirements\", \"centralContent\"],\r\n                                  flags: [\"includeIdsOnly\"]\r\n                                });*/\r\n                                for (tasks_1 = tslib_1.__values(tasks), tasks_1_1 = tasks_1.next(); !tasks_1_1.done; tasks_1_1 = tasks_1.next()) {\r\n                                    task = tasks_1_1.value;\r\n                                    _loop_2(task);\r\n                                }\r\n                            }\r\n                            catch (e_7_1) { e_7 = { error: e_7_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (tasks_1_1 && !tasks_1_1.done && (_a = tasks_1.return)) _a.call(tasks_1);\r\n                                }\r\n                                finally { if (e_7) throw e_7.error; }\r\n                            }\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        var dbTextMap, orderedAbilities, orderedAbilities_1, orderedAbilities_1_1, a, courseSets_1, courseSets_1_1, template, _a, _b, cc, _c, _d, kr, _e, newAbilityTexts, abilitiesToAdd, _f, newCCTexts, ccsToAdd, _g, newKRTexts, krsToAdd, abilityIdsToMigrate, idsToMigratePerCourse, createdIds, shownChanges, _loop_1, courseSets_2, courseSets_2_1, _h, template, instances;\r\n        var e_2, _j, e_3, _k, e_4, _l, e_5, _m, e_6, _o;\r\n        return tslib_1.__generator(this, function (_p) {\r\n            switch (_p.label) {\r\n                case 0:\r\n                    dbTextMap = new Map();\r\n                    orderedAbilities = existingSubject.abilitiesOrder ?\r\n                        existingSubject.abilitiesOrder.map(function (id) { return existingSubject.abilities.find(function (a) { return a.id === id; }); }) :\r\n                        existingSubject.abilities;\r\n                    try {\r\n                        for (orderedAbilities_1 = tslib_1.__values(orderedAbilities), orderedAbilities_1_1 = orderedAbilities_1.next(); !orderedAbilities_1_1.done; orderedAbilities_1_1 = orderedAbilities_1.next()) {\r\n                            a = orderedAbilities_1_1.value;\r\n                            dbTextMap.set(a.name.trim(), a.id);\r\n                        }\r\n                    }\r\n                    catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (orderedAbilities_1_1 && !orderedAbilities_1_1.done && (_j = orderedAbilities_1.return)) _j.call(orderedAbilities_1);\r\n                        }\r\n                        finally { if (e_2) throw e_2.error; }\r\n                    }\r\n                    try {\r\n                        for (courseSets_1 = tslib_1.__values(courseSets), courseSets_1_1 = courseSets_1.next(); !courseSets_1_1.done; courseSets_1_1 = courseSets_1.next()) {\r\n                            template = courseSets_1_1.value.template;\r\n                            try {\r\n                                for (_a = (e_4 = void 0, tslib_1.__values(template.centralContent)), _b = _a.next(); !_b.done; _b = _a.next()) {\r\n                                    cc = _b.value;\r\n                                    dbTextMap.set(cc.name.trim(), cc.id);\r\n                                }\r\n                            }\r\n                            catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_b && !_b.done && (_l = _a.return)) _l.call(_a);\r\n                                }\r\n                                finally { if (e_4) throw e_4.error; }\r\n                            }\r\n                            try {\r\n                                for (_c = (e_5 = void 0, tslib_1.__values(template.knowledgeRequirements)), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n                                    kr = _d.value;\r\n                                    dbTextMap.set(kr.name.trim(), kr.id);\r\n                                }\r\n                            }\r\n                            catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_d && !_d.done && (_m = _c.return)) _m.call(_c);\r\n                                }\r\n                                finally { if (e_5) throw e_5.error; }\r\n                            }\r\n                        }\r\n                    }\r\n                    catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (courseSets_1_1 && !courseSets_1_1.done && (_k = courseSets_1.return)) _k.call(courseSets_1);\r\n                        }\r\n                        finally { if (e_3) throw e_3.error; }\r\n                    }\r\n                    _e = diffSubjectGlobalTexts(dbTextMap, subjectToImport.abilities), newAbilityTexts = _e.newTexts, abilitiesToAdd = _e.idsToAdd;\r\n                    _f = diffSubjectGlobalTexts(dbTextMap, flatten(subjectToImport.courses.map(function (c) { return c.centralContent.map(function (cc) { return cc.html; }); }))), newCCTexts = _f.newTexts, ccsToAdd = _f.idsToAdd;\r\n                    _g = diffSubjectGlobalTexts(dbTextMap, flatten(subjectToImport.courses.map(function (c) { return c.knowledgeRequirements.map(function (kr) { return kr.html; }); }))), newKRTexts = _g.newTexts, krsToAdd = _g.idsToAdd;\r\n                    console.log(\"Abilities to add: \" + abilitiesToAdd.size);\r\n                    console.log(\"CCs to add: \" + ccsToAdd.size);\r\n                    console.log(\"KRs to add: \" + krsToAdd.size);\r\n                    abilityIdsToMigrate = getIdsToMigrate(orderedAbilities, subjectToImport.abilities.map(function (html) { return ({ html: html }); }), newAbilityTexts, \"abilities\");\r\n                    idsToMigratePerCourse = courseSets.map(function (_a, i) {\r\n                        var template = _a.template;\r\n                        console.log(\"Course: \" + template.name);\r\n                        var xmlCourse = subjectToImport.courses.find(function (c) { return c.name === template.name; }) ||\r\n                            subjectToImport.courses.find(function (c) { return c.code === template.code; });\r\n                        return {\r\n                            courseCode: template.code,\r\n                            ccsToMigrate: xmlCourse ?\r\n                                getIdsToMigrate(template.centralContent, // Has already been sorted when retrieved via loadCourse()\r\n                                xmlCourse.centralContent.map(function (_a) {\r\n                                    var html = _a.html;\r\n                                    return ({ html: html });\r\n                                }), newCCTexts, \"central content\", template.name) :\r\n                                new Map(),\r\n                            krsToMigrate: xmlCourse ?\r\n                                getIdsToMigrate(template.knowledgeRequirements, // Has already been sorted when retrieved via loadCourse()\r\n                                xmlCourse.knowledgeRequirements, newKRTexts, \"knowledge requirements\", template.name) :\r\n                                new Map()\r\n                        };\r\n                    });\r\n                    // OK so now we have all info.\r\n                    // Now, we need to:\r\n                    // Subject:\r\n                    // 1. Remove links from subjects to abilities\r\n                    // 2. Add links from subjects to abilities\r\n                    abilityIdsToMigrate.forEach(function (_a, oldId) {\r\n                        var newText = _a.newText, newId = _a.newId, oldText = _a.oldText, isTypoFix = _a.isTypoFix;\r\n                        //const oldText = existingSubject.abilities.find(a => a.id === oldId).name;\r\n                        changes.push({\r\n                            change: (oldText ?\r\n                                newText ?\r\n                                    isTypoFix ?\r\n                                        \"Tryckfelsr\\u00E4ttning F\\u00F6rm\\u00E5ga\" :\r\n                                        \"Uppdaterad F\\u00F6rm\\u00E5ga\" :\r\n                                    \"Borttagen F\\u00F6rm\\u00E5ga\" :\r\n                                \"Ny F\\u00F6rm\\u00E5ga\"),\r\n                            content: \"<strike>\" + (oldText || '') + \"</strike><br/>\" + (newText || ''),\r\n                            mutations: function (br) {\r\n                                if (newId && abilitiesToAdd.has(newId)) {\r\n                                    var a = {\r\n                                        id: newId,\r\n                                        name: newText,\r\n                                        acl: [\"role:USER:R\"],\r\n                                        dateTime: Date.now()\r\n                                    };\r\n                                    br.add(\"abilities\", a);\r\n                                }\r\n                                if (oldText)\r\n                                    br.unlink2(\"subjects\", existingSubject.id, \"abilities\", oldId);\r\n                                if (newId)\r\n                                    br.link2(\"subjects\", existingSubject.id, \"abilities\", newId);\r\n                            }\r\n                        });\r\n                    });\r\n                    // 3. Update abilitiesOrder on Subject based on subjectToImport.abilities (mapped to ids in newTexts)\r\n                    if (!existingSubject.abilitiesOrder || abilityIdsToMigrate.size > 0) {\r\n                        existingSubject.abilitiesOrder = subjectToImport.abilities.map(function (xml) { return newAbilityTexts.get(xml); });\r\n                        changes.push({\r\n                            mutations: function (br) { return br.put(\"subjects\", existingSubject); },\r\n                            change: existingSubject.abilitiesOrder ?\r\n                                null : // Ändringen redan visuell som \"Uppdaterad för förmåga\", etc, ovan\r\n                                \"Inf\\u00F6r en ordnad lista p\\u00E5 f\\u00F6rm\\u00E5gor i databasen\",\r\n                        });\r\n                    }\r\n                    createdIds = new Set();\r\n                    changes.push({ mutations: function () { return createdIds.clear(); } }); // In case mutations run twice (which it doesn't as of current impl.)\r\n                    shownChanges = new Set();\r\n                    changes.push({ mutations: function () { return shownChanges.clear(); } });\r\n                    _loop_1 = function (template, instances) {\r\n                        var e_12, _a;\r\n                        // Find courseToImport\r\n                        var courseToImport = (subjectToImport.courses.find(function (c) { return c.name === template.name; }) ||\r\n                            subjectToImport.courses.find(function (c) { return c.code === template.code; }));\r\n                        // Find Central Content and Knowledge Requirements to migrate\r\n                        var _b = idsToMigratePerCourse.find(function (x) { return x.courseCode === template.code; }), ccsToMigrate = _b.ccsToMigrate, krsToMigrate = _b.krsToMigrate;\r\n                        try {\r\n                            // Loop through all course instances (instances also contains templates)\r\n                            // and migrate them. This will include creating missing entities in the DB.\r\n                            for (var instances_1 = (e_12 = void 0, tslib_1.__values(instances)), instances_1_1 = instances_1.next(); !instances_1_1.done; instances_1_1 = instances_1.next()) {\r\n                                var course = instances_1_1.value;\r\n                                migrateCourseInstance(course, courseToImport, { ccsToMigrate: ccsToMigrate, krsToMigrate: krsToMigrate });\r\n                            }\r\n                        }\r\n                        catch (e_12_1) { e_12 = { error: e_12_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (instances_1_1 && !instances_1_1.done && (_a = instances_1.return)) _a.call(instances_1);\r\n                            }\r\n                            finally { if (e_12) throw e_12.error; }\r\n                        }\r\n                    };\r\n                    try {\r\n                        // Courses:\r\n                        // 1. Go through all course instances and:\r\n                        //      A: Remove links from courses to abilities listed in abilityIdsToMigrate.keys()\r\n                        //      B: Add links from courses to abilities abiltitiesToMigrate.values()\r\n                        //      C: Update abilitiesOrder on course instances based on subjectToImport (mapped to ids in newTexts)\r\n                        // 2, 3: Do the same for central-content and knowledge-requirementes:\r\n                        //    Find ccs and krs to migrate based on courseInstance.code\r\n                        //    For both ccs and krs, do:\r\n                        //      A: Unlink ccsToMigrate.keys()\r\n                        //      B: Link ccsToMigrate.values()\r\n                        //      C: Update centralContentOrder based on subjectToImport.centralContent mapped to newTexts ids\r\n                        //      (same for krsToMigrate, with knowledgeRequirementsOrder instead)\r\n                        for (courseSets_2 = tslib_1.__values(courseSets), courseSets_2_1 = courseSets_2.next(); !courseSets_2_1.done; courseSets_2_1 = courseSets_2.next()) {\r\n                            _h = courseSets_2_1.value, template = _h.template, instances = _h.instances;\r\n                            _loop_1(template, instances);\r\n                        }\r\n                    }\r\n                    catch (e_6_1) { e_6 = { error: e_6_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (courseSets_2_1 && !courseSets_2_1.done && (_o = courseSets_2.return)) _o.call(courseSets_2);\r\n                        }\r\n                        finally { if (e_6) throw e_6.error; }\r\n                    }\r\n                    return [4 /*yield*/, migrateTasks()];\r\n                case 1:\r\n                    _p.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nexport { ShowSubject } from './show-subject';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport { SubjectsInner } from './subjects-inner';\r\nvar Subjects = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Subjects, _super);\r\n    function Subjects(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isListingSubjects: true,\r\n            primarySchoolSubjects: [],\r\n            uploadedSubject: null\r\n        };\r\n        return _this;\r\n    }\r\n    Subjects.prototype.render = function () {\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(CourseBanner, { title: L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00C4mnen\"], [\"\\u00C4mnen\"]))), activePage: \"subjects\", routes: { feedback: this.props.feedbackUrl } }),\r\n            React.createElement(SubjectsInner, { linkPrefix: \"/subjects/\" }));\r\n    };\r\n    return Subjects;\r\n}(React.Component));\r\nexport { Subjects };\r\nvar templateObject_1;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nvar ShowSubjectInner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ShowSubjectInner, _super);\r\n    function ShowSubjectInner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { subject: null };\r\n        return _this;\r\n    }\r\n    ShowSubjectInner.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    ShowSubjectInner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subject;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', this.props.id, { include: 'courseTemplates' })];\r\n                    case 1:\r\n                        subject = _a.sent();\r\n                        this.setState({ subject: subject });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ShowSubjectInner.prototype.render = function () {\r\n        if (!this.state.subject)\r\n            return React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null));\r\n        var _a = this.state.subject, name = _a.name, code = _a.code, courseTemplates = _a.courseTemplates, schoolType = _a.schoolType;\r\n        return React.createElement(\"div\", null, schoolType === 'primary' ? React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null,\r\n                \"Grundskole\\u00E4mnet \",\r\n                name,\r\n                \" (\",\r\n                code,\r\n                \")\"),\r\n            React.createElement(\"ul\", { className: \"entity-list\" }, courseTemplates.map(function (_a) {\r\n                var id = _a.id, code = _a.code, publishable = _a.publishable, points = _a.points, schoolGrade = _a.schoolGrade;\r\n                return React.createElement(\"li\", { key: id, className: \"complete\" },\r\n                    name,\r\n                    \" f\\u00F6r \\u00E5rskurs \",\r\n                    schoolGrade);\r\n            }))) : React.createElement(React.Fragment, null,\r\n            React.createElement(\"h2\", null,\r\n                \"Kurser f\\u00F6r \\u00E4mnet \",\r\n                name,\r\n                \" (\",\r\n                code,\r\n                \")\"),\r\n            React.createElement(\"ul\", { className: \"entity-list\" }, courseTemplates.map(function (_a) {\r\n                var id = _a.id, name = _a.name, code = _a.code, publishable = _a.publishable, points = _a.points;\r\n                return React.createElement(\"li\", { key: id, className: \"complete\" },\r\n                    name,\r\n                    \" - \",\r\n                    points,\r\n                    \"p\");\r\n            }))));\r\n    };\r\n    return ShowSubjectInner;\r\n}(React.Component));\r\nexport { ShowSubjectInner };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport env from '../../../globals/KED.env';\r\nimport { CourseBanner } from \"../courses/course-banner\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nimport { ShowSubjectInner } from './show-subject-inner';\r\nvar ShowSubject = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ShowSubject, _super);\r\n    function ShowSubject(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { subject: null };\r\n        return _this;\r\n    }\r\n    ShowSubject.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    ShowSubject.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subject;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.get('subjects', this.props.id, { include: 'courseTemplates' })];\r\n                    case 1:\r\n                        subject = _a.sent();\r\n                        this.setState({ subject: subject });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ShowSubject.prototype.render = function () {\r\n        if (!this.state.subject)\r\n            return React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null));\r\n        var _a = this.state.subject, name = _a.name, code = _a.code, courseTemplates = _a.courseTemplates, schoolType = _a.schoolType;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(CourseBanner, { title: name, activePage: \"subjects\", routes: { feedback: this.props.feedbackUrl } }),\r\n            React.createElement(ShowSubjectInner, { id: this.props.id }));\r\n    };\r\n    return ShowSubject;\r\n}(React.Component));\r\nexport { ShowSubject };\r\n","export function parseSkolverketYears(inYear) {\r\n    switch (inYear.trim()) {\r\n        case '3':\r\n        case '1-3':\r\n            return ['1-3'];\r\n        case '6':\r\n        case '4-6':\r\n            return ['4-6'];\r\n        case '7-9':\r\n        case '9':\r\n            return ['7-9'];\r\n        // Specials\r\n        case '1': return [\"1-3\"]; // Förekommer i ämnena \"Svenska\" och \"Svenska som andraspråk\"\r\n        case '1s': return [\"1-3\"]; // Förekommer i ämnena \"Svenska\" och \"Svenska som andraspråk\"\r\n        case '1-6': return [\"1-3\", \"4-6\"]; // Förekommer i ämnet \"Hem- och konsumentkunskap\"\r\n        case '4-9': return [\"4-6\", \"7-9\"]; // Förekommer i ämnet \"Moderna språk\"\r\n        default: {\r\n            throw new Error(\"Unexpected year in Skolverket XML: \" + inYear + \". Expecting 3,6,9 or 1-3, 4-6, 7-9\");\r\n        }\r\n    }\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L, showInfo, compareProp, arrayToLookup, flatten } from '../../../utils/utils';\r\nimport env from '../../../globals/KED.env';\r\nimport $ from 'jquery';\r\nimport { parseSkolverketYears } from './skolverket-subject';\r\nimport { UploadedSubject } from './uploaded-subject';\r\nexport { ShowSubject } from './show-subject';\r\nimport { Link } from 'react-router-dom';\r\nimport { readBlobAsText, allowCopy } from \"../utils\";\r\nimport { Spinner } from \"../sub-components/spinner\";\r\nvar SubjectsInner = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SubjectsInner, _super);\r\n    function SubjectsInner(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isListingSubjects: true,\r\n            gymnasiumSubjects: [],\r\n            primarySchoolSubjects: [],\r\n            uploadedSubject: null\r\n        };\r\n        return _this;\r\n    }\r\n    SubjectsInner.prototype.componentWillMount = function () {\r\n        this.load();\r\n    };\r\n    SubjectsInner.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var subjects, gymnasiumSubjects, primarySchoolSubjects;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, env.kedBackendClient.list(\"subjects\")];\r\n                    case 1:\r\n                        subjects = _a.sent();\r\n                        subjects.sort(compareProp(\"name\"));\r\n                        gymnasiumSubjects = subjects.filter(function (s) { return s.schoolType !== 'primary'; });\r\n                        primarySchoolSubjects = subjects.filter(function (s) { return s.schoolType === 'primary'; });\r\n                        this.setState({ gymnasiumSubjects: gymnasiumSubjects, primarySchoolSubjects: primarySchoolSubjects, isListingSubjects: false });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SubjectsInner.prototype.handleFileSelect = function (ev) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var files, xml, doc, typeOfSchooling, schoolType, model, courses, i, course, knownledgeRequirements, centralContents, knowledgeRequirements, centralContentsByStadium_1, knowledgeRequirementsByStadium_1, subjectName_1, subjectCode_1, subjectPurpose, coursesByStadium, model;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        ev.stopPropagation();\r\n                        ev.preventDefault();\r\n                        files = ev.dataTransfer.files;\r\n                        return [4 /*yield*/, readBlobAsText(files[0])];\r\n                    case 1:\r\n                        xml = _a.sent();\r\n                        doc = $($.parseXML(xml));\r\n                        typeOfSchooling = doc.find(\"subject>originatorTypeOfSchooling\").text().trim() ||\r\n                            doc.find(\"subject>typeOfSchooling\").text().trim();\r\n                        schoolType = typeOfSchooling === \"COMPULSORY_SCHOOL\" ?\r\n                            'primary' :\r\n                            typeOfSchooling === \"UPPER_SECONDARY_EDUCATION\" ?\r\n                                'gymnasium' :\r\n                                null;\r\n                        if (schoolType === 'gymnasium') {\r\n                            model = {\r\n                                name: doc.find(\"subject>name\").text().trim(),\r\n                                code: doc.find(\"subject>code\").text().trim(),\r\n                                purpose: doc.find(\"subject>purpose\").text().trim(),\r\n                                courses: [],\r\n                                schoolType: 'gymnasium'\r\n                            };\r\n                            courses = doc.find(\"subject>courses\");\r\n                            for (i = 0; i < courses.length; ++i) {\r\n                                course = $(courses[i]);\r\n                                knownledgeRequirements = [].slice.call(course.find(\"knowledgeRequirements\"))\r\n                                    .map(function (r) { return ({\r\n                                    gradeStep: $(r).find('gradeStep').text().trim(),\r\n                                    text: $(r).find('text').text().trim()\r\n                                }); });\r\n                                model.courses.push({\r\n                                    name: course.find(\"name\").text().trim(),\r\n                                    code: course.find(\"code\").text().trim(),\r\n                                    centralContent: course.find(\"centralContent\").text().trim(),\r\n                                    points: parseInt(course.find(\"point\").text().trim()),\r\n                                    knownledgeRequirements: knownledgeRequirements,\r\n                                });\r\n                            }\r\n                            this.setState({ uploadedSubject: model });\r\n                        }\r\n                        else {\r\n                            centralContents = flatten(Array.from(doc.find(\"subject>centralContent\"))\r\n                                .map(function (cc) {\r\n                                var year = $(cc).find('year').text().trim();\r\n                                var typeOfCentralContent = $(cc).find('typeOfCentralContent').text().trim();\r\n                                if (typeOfCentralContent) {\r\n                                    // Do not yet support multiple types of central content.\r\n                                    throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av centralt inneh\\u00E5ll. Detta st\\u00F6ds \\u00E4nnu inte.\"], [\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av centralt inneh\\u00E5ll. Detta st\\u00F6ds \\u00E4nnu inte.\"]))));\r\n                                }\r\n                                var stadiums = parseSkolverketYears(year);\r\n                                var centralContentsForEachStadium = stadiums.map(function (stadium) { return ({\r\n                                    year: stadium,\r\n                                    text: $(cc).find('text').text().trim()\r\n                                }); });\r\n                                return centralContentsForEachStadium;\r\n                            }));\r\n                            knowledgeRequirements = flatten(Array.from(doc.find(\"subject>knowledgeRequirement\"))\r\n                                .map(function (kr) {\r\n                                var year = $(kr).find('year').text().trim();\r\n                                var typeOfRequirement = $(kr).find('typeOfRequirement').text().trim();\r\n                                if (typeOfRequirement) {\r\n                                    // Do not yet support multiple types of knowledge requirement.\r\n                                    throw new Error(L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av kunskapskrav. Detta st\\u00F6ds \\u00E4nnu inte.\"], [\"\\u00C4mnet inneh\\u00E5ller flera parallella typer av kunskapskrav. Detta st\\u00F6ds \\u00E4nnu inte.\"]))));\r\n                                }\r\n                                return parseSkolverketYears(year).map(function (stadium) { return ({\r\n                                    year: stadium,\r\n                                    text: $(kr).find('text').text().trim(),\r\n                                    gradeStep: $(kr).find('gradeStep').text().trim()\r\n                                }); });\r\n                            }));\r\n                            centralContentsByStadium_1 = arrayToLookup(centralContents, function (cc) { return cc.year; });\r\n                            knowledgeRequirementsByStadium_1 = arrayToLookup(knowledgeRequirements, function (kr) { return kr.year; });\r\n                            subjectName_1 = doc.find(\"subject>name\").text().trim();\r\n                            subjectCode_1 = doc.find(\"subject>code\").text().trim();\r\n                            subjectPurpose = doc.find(\"subject>purpose\").text().trim();\r\n                            coursesByStadium = ['1-3', '4-6', '7-9']\r\n                                .map(function (stadium) { return ({\r\n                                name: subjectName_1 + ' ' + stadium,\r\n                                code: subjectCode_1 + '|' + stadium,\r\n                                points: 0,\r\n                                year: stadium,\r\n                                centralContent: (centralContentsByStadium_1[stadium] || []).map(function (cc) { return cc.text; }).join('\\n'),\r\n                                knownledgeRequirements: (knowledgeRequirementsByStadium_1[stadium] || []).map(function (_a) {\r\n                                    var gradeStep = _a.gradeStep, text = _a.text;\r\n                                    return ({ gradeStep: gradeStep, text: text });\r\n                                })\r\n                            }); });\r\n                            model = {\r\n                                name: subjectName_1,\r\n                                code: subjectCode_1,\r\n                                purpose: subjectPurpose,\r\n                                schoolType: 'primary',\r\n                                courses: coursesByStadium\r\n                            };\r\n                            this.setState({ uploadedSubject: model });\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SubjectsInner.prototype.onImportSuccess = function (subject) {\r\n        showInfo(L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Importen av \", \" lyckades\"], [\"Importen av \", \" lyckades\"])), subject));\r\n        this.setState({ uploadedSubject: null });\r\n        this.load();\r\n    };\r\n    SubjectsInner.prototype.render = function () {\r\n        var _this = this;\r\n        var linkPrefix = this.props.linkPrefix;\r\n        return React.createElement(\"div\", null, this.state.uploadedSubject ?\r\n            React.createElement(UploadedSubject, { onCancel: function () { return _this.setState({ uploadedSubject: null }); }, onImportSuccess: function (subject) { return _this.onImportSuccess(subject); }, subject: this.state.uploadedSubject })\r\n            : this.state.isListingSubjects ?\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"p\", null,\r\n                        React.createElement(Spinner, null),\r\n                        \"Var god v\\u00E4nta medan \\u00E4mnen h\\u00E4mtas...\")) :\r\n                React.createElement(\"div\", null,\r\n                    React.createElement(\"h2\", null, L(templateObject_4 || (templateObject_4 = tslib_1.__makeTemplateObject([\"Gymnasie\\u00E4mnen\"], [\"Gymnasie\\u00E4mnen\"])))),\r\n                    React.createElement(\"ul\", null, this.state.gymnasiumSubjects.map(function (s) {\r\n                        return React.createElement(\"li\", { key: s.id, className: s.publishable ? \"complete\" : \"incomplete\" },\r\n                            React.createElement(Link, { to: linkPrefix + s.id }, s.name));\r\n                    })),\r\n                    React.createElement(\"h2\", null, L(templateObject_5 || (templateObject_5 = tslib_1.__makeTemplateObject([\"Grundskole\\u00E4mnen\"], [\"Grundskole\\u00E4mnen\"])))),\r\n                    React.createElement(\"ul\", null, this.state.primarySchoolSubjects.map(function (s) {\r\n                        return React.createElement(\"li\", { key: s.id, className: s.publishable ? \"complete\" : \"incomplete\" },\r\n                            React.createElement(Link, { to: linkPrefix + s.id }, s.name));\r\n                    })),\r\n                    React.createElement(\"div\", { className: \"drop-zone\", onDragOver: allowCopy, onDrop: function (ev) { return _this.handleFileSelect(ev); } },\r\n                        \"Droppa Subject-fil h\\u00E4r fr\\u00E5n skolverket (H\\u00E4mtas fr\\u00E5n \",\r\n                        React.createElement(\"a\", { href: \"http://opendata.skolverket.se\", target: \"skolverket\" }, \"opendata.skolverket.se\"),\r\n                        \")\")));\r\n    };\r\n    return SubjectsInner;\r\n}(React.Component));\r\nexport { SubjectsInner };\r\nvar templateObject_1, templateObject_2, templateObject_3, templateObject_4, templateObject_5;\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { L } from '../../../utils/utils';\r\nimport $ from 'jquery';\r\nimport env from '../../../globals/KED.env';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport { diffXmlWithDatabase } from './diff/diff-xml-with-database';\r\nvar UploadedSubject = /** @class */ (function (_super) {\r\n    tslib_1.__extends(UploadedSubject, _super);\r\n    function UploadedSubject(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.coursesElems = {};\r\n        _this.centralContentElems = [];\r\n        _this.knowledgeRequirementElems = [];\r\n        _this.state = {\r\n            showFullText: false,\r\n            changes: [],\r\n            isWorking: true,\r\n            isImporting: false\r\n        };\r\n        return _this;\r\n    }\r\n    UploadedSubject.prototype.componentDidMount = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, changes, subjectToImport, error_1;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        this.addClassesForCherryPickedElements();\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        _b.trys.push([1, 3, 4, 5]);\r\n                        return [4 /*yield*/, this.diffWithExisting()];\r\n                    case 2:\r\n                        _a = _b.sent(), changes = _a.changes, subjectToImport = _a.subjectToImport;\r\n                        this.setState({ changes: changes, subjectToImport: subjectToImport });\r\n                        return [3 /*break*/, 5];\r\n                    case 3:\r\n                        error_1 = _b.sent();\r\n                        this.setState({ error: '' + error_1 });\r\n                        return [3 /*break*/, 5];\r\n                    case 4:\r\n                        this.setState({ isWorking: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 5: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.addClassesForCherryPickedElements = function () {\r\n        var abilities = $(this.purposeElem).find('li').first().parent().children('li');\r\n        abilities.addClass('ability');\r\n        var centralContents = $(this.centralContentElems).find('li');\r\n        centralContents.addClass('central-content');\r\n        var knowledgeRequirements = $(this.knowledgeRequirementElems).find('p');\r\n        knowledgeRequirements.addClass('knowledge-requirement');\r\n        var all = $([abilities, centralContents, knowledgeRequirements]);\r\n        all.addClass('marked-area');\r\n    };\r\n    UploadedSubject.prototype.cherryPickData = function () {\r\n        var _this = this;\r\n        //\r\n        // Reads elements (tagged by classes in addClassesForCherryPickedElements()) and converts their inner HTML to the corresponding\r\n        // model SubjectToImport. Note that if we need to adjust how to pick the right LI or P elements, we\r\n        // will only need to change the code in addClassesForCherryPickedElements(), not this code.\r\n        //\r\n        var skolSubject = this.props.subject;\r\n        var abilitiesLis = Array.from($(this.purposeElem).find('li').first().parent().children('li'));\r\n        var abilities = abilitiesLis.map(function (a, i) { return (i + 1 + \". \" + $(a).html()).trim(); }).filter(function (html) { return !!html; });\r\n        var result = {\r\n            name: skolSubject.name,\r\n            code: skolSubject.code,\r\n            schoolType: skolSubject.schoolType,\r\n            abilities: abilities,\r\n            courses: Object.keys(this.coursesElems)\r\n                .map(function (courseCode) { return _this.coursesElems[courseCode]; })\r\n                .map(function (_a) {\r\n                var course = _a.course, elem = _a.elem;\r\n                return ({\r\n                    name: course.name,\r\n                    year: course.year,\r\n                    code: course.code,\r\n                    points: course.points,\r\n                    centralContent: Array.from($(elem).find('.central-content')).map(function (c) { return ({\r\n                        html: $(c).html().trim(),\r\n                        group: $(c).parent('ul').prev('h4').text().trim()\r\n                    }); }).filter(function (_a) {\r\n                        var html = _a.html;\r\n                        return !!html;\r\n                    }),\r\n                    knowledgeRequirements: Array.from($(elem).find('.grade-step-none .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: null, html: html }); })\r\n                        .concat(Array.from($(elem).find('.grade-step-E .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"E\", html: html }); })\r\n                        .concat(Array.from($(elem).find('.grade-step-C .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"C\", html: html }); }))\r\n                        .concat(Array.from($(elem).find('.grade-step-A .knowledge-requirement')).map(function (r) { return $(r).html().trim(); })\r\n                        .filter(function (html) { return !!html; })\r\n                        .map(function (html) { return ({ gradeStep: \"A\", html: html }); })))\r\n                });\r\n            })\r\n        };\r\n        return result;\r\n    };\r\n    UploadedSubject.prototype.diffWithExisting = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            function ct() {\r\n                var rv = createTime;\r\n                createTime += 2;\r\n                return rv;\r\n            }\r\n            var subjectToImport, changes, existingSubjects, existingSubject, centralContent, knowledgeRequirements, createTime, newSubject_1, subjectAbilities, _loop_1, _a, _b, a, _loop_2, _c, _d, c;\r\n            var e_1, _e, e_2, _f;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_g) {\r\n                switch (_g.label) {\r\n                    case 0:\r\n                        subjectToImport = this.cherryPickData();\r\n                        changes = [];\r\n                        return [4 /*yield*/, env.kedBackendClient.list(\"subjects\")];\r\n                    case 1:\r\n                        existingSubjects = _g.sent();\r\n                        existingSubject = existingSubjects.filter(function (s) { return s.code === _this.props.subject.code; })[0];\r\n                        centralContent = [], knowledgeRequirements = [];\r\n                        createTime = Date.now();\r\n                        if (!existingSubject) return [3 /*break*/, 3];\r\n                        // Include abilities and standardCourses with the found Subject:\r\n                        return [4 /*yield*/, diffXmlWithDatabase(existingSubject, subjectToImport, changes)];\r\n                    case 2:\r\n                        // Include abilities and standardCourses with the found Subject:\r\n                        _g.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        newSubject_1 = existingSubject = {\r\n                            id: createUUID(),\r\n                            schoolType: subjectToImport.schoolType,\r\n                            tags: [\"schoolType:\" + subjectToImport.schoolType],\r\n                            acl: [\"role:USER:R\"],\r\n                            code: subjectToImport.code,\r\n                            name: subjectToImport.name,\r\n                            abilitiesOrder: [],\r\n                            publishable: false,\r\n                            dateTime: ct()\r\n                        };\r\n                        changes.push({\r\n                            change: \"Nytt ämne\",\r\n                            content: subjectToImport.name + \" (\" + subjectToImport.code + \")\",\r\n                            mutations: function (r) { return r.add(\"subjects\", newSubject_1); }\r\n                        });\r\n                        subjectAbilities = [];\r\n                        _loop_1 = function (a) {\r\n                            var newAbility = {\r\n                                id: createUUID(),\r\n                                name: a,\r\n                                acl: [\"role:USER:R\"],\r\n                                dateTime: ct()\r\n                            };\r\n                            subjectAbilities.push(newAbility); // To refer from in courses later on!\r\n                            changes.push({\r\n                                change: \"Ny förmåga\",\r\n                                content: a,\r\n                                mutations: function (r) {\r\n                                    r.add(\"abilities\", newAbility);\r\n                                    r.link(\"subjects\", newSubject_1.id, \"abilities\", newAbility.id, \"abilities\");\r\n                                }\r\n                            });\r\n                        };\r\n                        try {\r\n                            for (_a = tslib_1.__values(subjectToImport.abilities), _b = _a.next(); !_b.done; _b = _a.next()) {\r\n                                a = _b.value;\r\n                                _loop_1(a);\r\n                            }\r\n                        }\r\n                        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (_b && !_b.done && (_e = _a.return)) _e.call(_a);\r\n                            }\r\n                            finally { if (e_1) throw e_1.error; }\r\n                        }\r\n                        // Update now when we have abilities order:\r\n                        newSubject_1.abilitiesOrder = subjectAbilities.map(function (_a) {\r\n                            var id = _a.id;\r\n                            return id;\r\n                        });\r\n                        _loop_2 = function (c) {\r\n                            var e_3, _a, e_4, _b, e_5, _c;\r\n                            var newCourse = {\r\n                                id: createUUID(),\r\n                                subjectCode: newSubject_1.code,\r\n                                schoolType: newSubject_1.schoolType,\r\n                                tags: [\r\n                                    \"sub:\" + newSubject_1.code,\r\n                                    \"course:\" + c.code,\r\n                                    \"schoolType:\" + newSubject_1.schoolType\r\n                                ],\r\n                                dateTime: ct(),\r\n                                isTemplate: true,\r\n                                acl: [\"role:EMPLOYEE:R\"],\r\n                                name: c.name,\r\n                                code: c.code,\r\n                                points: c.points,\r\n                                modules: [],\r\n                                subjectId: newSubject_1.id,\r\n                                resources: [],\r\n                                createdBy: { name: env.currentUser.displayName, url: \"mailto:\" + env.currentUser.mail },\r\n                                createdDate: Date.now(),\r\n                                knowledgeRequirementsOrder: [],\r\n                                centralContentOrder: [],\r\n                                abilitiesOrder: subjectAbilities.map(function (_a) {\r\n                                    var id = _a.id;\r\n                                    return id;\r\n                                })\r\n                            };\r\n                            if (c.year)\r\n                                newCourse.schoolGrade = c.year;\r\n                            changes.push({\r\n                                change: \"Ny kurs\",\r\n                                content: c.name,\r\n                                mutations: function (r) {\r\n                                    r.add(\"courses\", newCourse);\r\n                                    r.link(\"subjects\", newSubject_1.id, \"courses\", newCourse.id, \"courseTemplates\");\r\n                                }\r\n                            });\r\n                            var _loop_3 = function (ccGroup, html) {\r\n                                // Check if there exists an identical central content on previous course first\r\n                                var newCentralContent = centralContent.filter(function (cc) { return cc.name === html; })[0];\r\n                                if (!newCentralContent) {\r\n                                    newCentralContent = {\r\n                                        id: createUUID(),\r\n                                        dateTime: ct(),\r\n                                        name: html,\r\n                                        acl: [\"role:USER:R\"]\r\n                                    };\r\n                                    if (ccGroup)\r\n                                        newCentralContent.group = ccGroup;\r\n                                    centralContent.push(newCentralContent);\r\n                                    changes.push({\r\n                                        change: \"Nytt centralt innehåll\",\r\n                                        content: \"<h4>\" + ccGroup + \"</h4>\" + html,\r\n                                        mutations: function (r) {\r\n                                            r.add(\"central-content\", newCentralContent);\r\n                                            r.link(\"courses\", newCourse.id, \"central-content\", newCentralContent.id, \"centralContent\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    changes.push({\r\n                                        mutations: function (r) {\r\n                                            r.link(\"courses\", newCourse.id, \"central-content\", newCentralContent.id, \"centralContent\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                // Register the order in which this central content appeared in the XML:\r\n                                newCourse.centralContentOrder.push(newCentralContent.id);\r\n                            };\r\n                            try {\r\n                                for (var _d = (e_3 = void 0, tslib_1.__values(c.centralContent)), _e = _d.next(); !_e.done; _e = _d.next()) {\r\n                                    var _f = _e.value, ccGroup = _f.group, html = _f.html;\r\n                                    _loop_3(ccGroup, html);\r\n                                }\r\n                            }\r\n                            catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_e && !_e.done && (_a = _d.return)) _a.call(_d);\r\n                                }\r\n                                finally { if (e_3) throw e_3.error; }\r\n                            }\r\n                            var _loop_4 = function (cr) {\r\n                                var newKnowledgeRequirement = knowledgeRequirements.filter(function (kr) { return kr.name === cr.html && kr.gradeStep === cr.gradeStep; })[0];\r\n                                if (!newKnowledgeRequirement) {\r\n                                    newKnowledgeRequirement = {\r\n                                        id: createUUID(),\r\n                                        dateTime: ct(),\r\n                                        name: cr.html,\r\n                                        gradeStep: cr.gradeStep,\r\n                                        acl: [\"role:USER:R\"]\r\n                                    };\r\n                                    knowledgeRequirements.push(newKnowledgeRequirement);\r\n                                    changes.push({\r\n                                        change: \"Nytt kunskapskrav för betyget \" + cr.gradeStep,\r\n                                        content: cr.html,\r\n                                        mutations: function (r) {\r\n                                            r.add(\"knowledge-requirements\", newKnowledgeRequirement);\r\n                                            r.link(\"courses\", newCourse.id, \"knowledge-requirements\", newKnowledgeRequirement.id, \"knowledgeRequirements\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                else {\r\n                                    changes.push({\r\n                                        mutations: function (r) {\r\n                                            r.link(\"courses\", newCourse.id, \"knowledge-requirements\", newKnowledgeRequirement.id, \"knowledgeRequirements\");\r\n                                        }\r\n                                    });\r\n                                }\r\n                                // Register the order in which this knowledge requirement appeared in the XML:\r\n                                newCourse.knowledgeRequirementsOrder.push(newKnowledgeRequirement.id);\r\n                            };\r\n                            try {\r\n                                for (var _g = (e_4 = void 0, tslib_1.__values(c.knowledgeRequirements)), _h = _g.next(); !_h.done; _h = _g.next()) {\r\n                                    var cr = _h.value;\r\n                                    _loop_4(cr);\r\n                                }\r\n                            }\r\n                            catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (_h && !_h.done && (_b = _g.return)) _b.call(_g);\r\n                                }\r\n                                finally { if (e_4) throw e_4.error; }\r\n                            }\r\n                            var _loop_5 = function (a) {\r\n                                changes.push({\r\n                                    mutations: function (r) {\r\n                                        r.link(\"courses\", newCourse.id, \"abilities\", a.id, \"abilities\");\r\n                                    }\r\n                                });\r\n                            };\r\n                            try {\r\n                                // Build knowledge matrix\r\n                                // Link directly from course template to all abilities that the subject has:\r\n                                for (var subjectAbilities_1 = (e_5 = void 0, tslib_1.__values(subjectAbilities)), subjectAbilities_1_1 = subjectAbilities_1.next(); !subjectAbilities_1_1.done; subjectAbilities_1_1 = subjectAbilities_1.next()) {\r\n                                    var a = subjectAbilities_1_1.value;\r\n                                    _loop_5(a);\r\n                                }\r\n                            }\r\n                            catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n                            finally {\r\n                                try {\r\n                                    if (subjectAbilities_1_1 && !subjectAbilities_1_1.done && (_c = subjectAbilities_1.return)) _c.call(subjectAbilities_1);\r\n                                }\r\n                                finally { if (e_5) throw e_5.error; }\r\n                            }\r\n                        };\r\n                        try {\r\n                            for (_c = tslib_1.__values(subjectToImport.courses), _d = _c.next(); !_d.done; _d = _c.next()) {\r\n                                c = _d.value;\r\n                                _loop_2(c);\r\n                            }\r\n                        }\r\n                        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n                        finally {\r\n                            try {\r\n                                if (_d && !_d.done && (_f = _c.return)) _f.call(_c);\r\n                            }\r\n                            finally { if (e_2) throw e_2.error; }\r\n                        }\r\n                        _g.label = 4;\r\n                    case 4: return [2 /*return*/, { changes: changes, subjectToImport: subjectToImport }];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.cancel = function () {\r\n        this.props.onCancel();\r\n    };\r\n    UploadedSubject.prototype.import = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var allMutations;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.setState({ isWorking: true, isImporting: true });\r\n                        allMutations = this.state.changes.map(function (change) { return change.mutations; });\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        _a.trys.push([1, , 3, 4]);\r\n                        return [4 /*yield*/, env.kedBackendClient.do(function (r) {\r\n                                allMutations.forEach(function (mut) { return mut(r); });\r\n                            })];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [3 /*break*/, 4];\r\n                    case 3:\r\n                        this.setState({ isWorking: false, isImporting: false });\r\n                        return [7 /*endfinally*/];\r\n                    case 4:\r\n                        this.props.onImportSuccess(this.props.subject.name);\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    UploadedSubject.prototype.fixL = function (html) {\r\n        return html; //.replace('<l fromat=\"OL\">')\r\n    };\r\n    UploadedSubject.prototype.render = function () {\r\n        var _this = this;\r\n        var subjectToImport = this.state.subjectToImport;\r\n        var subject = this.props.subject;\r\n        return React.createElement(\"div\", null,\r\n            React.createElement(\"h1\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Uppladdat \\u00C4mne \", \"\"], [\"Uppladdat \\u00C4mne \", \"\"])), subjectToImport ? subjectToImport.name : '')),\r\n            this.state.error ? React.createElement(\"p\", null,\r\n                \"Fel: \",\r\n                this.state.error) :\r\n                this.state.isWorking ? React.createElement(\"p\", null, \"Arbetar...\") :\r\n                    this.state.isImporting ? React.createElement(\"p\", null, \"Importerar...\") :\r\n                        this.state.changes.every(function (c) { return !c.change; }) ? // Inga ändringar att visa (bara pseudo-ändringar)\r\n                            React.createElement(\"div\", null,\r\n                                React.createElement(\"p\", null, \"Kunde inte finna n\\u00E5gra f\\u00F6r\\u00E4ndringar fr\\u00E5n befintligt data. Klicka OK f\\u00F6r att avbryta och \\u00E5terg\\u00E5.\"),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.cancel(); } }, \" OK \")) :\r\n                            React.createElement(\"div\", null,\r\n                                React.createElement(\"table\", { style: { border: \"1px solid gray\", padding: \"2px\" } },\r\n                                    React.createElement(\"thead\", null,\r\n                                        React.createElement(\"tr\", null,\r\n                                            React.createElement(\"th\", { colSpan: 2 }, \"Granskning av \\u00E4ndringar i grund-data\")),\r\n                                        React.createElement(\"tr\", null,\r\n                                            React.createElement(\"th\", null, \"\\u00C4ndring\"),\r\n                                            React.createElement(\"th\", null, \"Inneh\\u00E5ll\"))),\r\n                                    React.createElement(\"tbody\", null, this.state.changes.filter(function (change) { return change.change; }).map(function (change, i) { return React.createElement(\"tr\", { key: i },\r\n                                        React.createElement(\"td\", { style: { padding: \"2px\" } }, change.change),\r\n                                        React.createElement(\"td\", { style: { padding: \"2px\" }, dangerouslySetInnerHTML: { __html: change.content } })); }))),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.cancel(); }, disabled: this.state.isImporting }, \"Avbryt\"),\r\n                                React.createElement(\"button\", { onClick: function () { return _this.import(); }, disabled: this.state.isImporting }, \"Importera\"),\r\n                                React.createElement(\"br\", null)),\r\n            React.createElement(\"button\", { onClick: function () { return _this.setState({ showFullText: !_this.state.showFullText }); } }, this.state.showFullText ? L(templateObject_2 || (templateObject_2 = tslib_1.__makeTemplateObject([\"D\\u00F6lj nedan\"], [\"D\\u00F6lj nedan\"]))) : L(templateObject_3 || (templateObject_3 = tslib_1.__makeTemplateObject([\"Visa hela texten fr\\u00E5n Skolverket\"], [\"Visa hela texten fr\\u00E5n Skolverket\"])))),\r\n            React.createElement(\"table\", { style: { display: this.state.showFullText ? '' : 'none' } },\r\n                React.createElement(\"tbody\", null,\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Namn\"),\r\n                        React.createElement(\"td\", null, subject.name)),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"\\u00C4mneskod\"),\r\n                        React.createElement(\"td\", null, subject.code)),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Syfte\"),\r\n                        React.createElement(\"td\", { ref: function (elem) { return _this.purposeElem = elem; }, dangerouslySetInnerHTML: { __html: this.fixL(subject.purpose) } })),\r\n                    React.createElement(\"tr\", null,\r\n                        React.createElement(\"th\", null, \"Kurser\"),\r\n                        React.createElement(\"td\", null, subject.courses.map(function (course) { return React.createElement(\"table\", { key: course.code, ref: function (elem) { return _this.coursesElems[course.code] = { course: course, elem: elem }; } },\r\n                            React.createElement(\"tbody\", null,\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kursens namn\"),\r\n                                    React.createElement(\"td\", null, course.name)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kurskod\"),\r\n                                    React.createElement(\"td\", null, course.code)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Po\\u00E4ng\"),\r\n                                    React.createElement(\"td\", null, course.points)),\r\n                                React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Centralt inneh\\u00E5ll\"),\r\n                                    React.createElement(\"td\", { ref: function (elem) { return _this.centralContentElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.centralContent) } })),\r\n                                course.knownledgeRequirements.some(function (kr) { return !kr.gradeStep; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav utan betygs\\u00E4ttning\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-none\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return !r.gradeStep; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'E'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg E\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-E\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'E'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'C'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg C\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-C\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'C'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined,\r\n                                course.knownledgeRequirements.some(function (kr) { return kr.gradeStep === 'A'; }) ? React.createElement(\"tr\", null,\r\n                                    React.createElement(\"th\", null, \"Kunskapskrav Betyg A\"),\r\n                                    React.createElement(\"td\", { className: \"grade-step-A\", ref: function (elem) { return _this.knowledgeRequirementElems.push(elem); }, dangerouslySetInnerHTML: { __html: _this.fixL(course.knownledgeRequirements.filter(function (r) { return r.gradeStep === 'A'; }).map(function (kr) { return kr.text; }).join('')) } })) : undefined)); }))))));\r\n    };\r\n    return UploadedSubject;\r\n}(React.Component));\r\nexport { UploadedSubject };\r\nvar templateObject_1, templateObject_2, templateObject_3;\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nimport { createUUID } from 'kedbackend/client';\r\nimport update from 'react-addons-update';\r\nimport $ from 'jquery';\r\nimport env from '../../globals/KED.env';\r\nexport function updateDocumentGraphs(oldDoc, newDoc, table, graphs, batch) {\r\n    var e_1, _a;\r\n    var docUpdates = {};\r\n    var docId = newDoc.id;\r\n    var _loop_1 = function (navProp) {\r\n        var e_2, _a, e_3, _b, e_4, _c;\r\n        var foreignTable = graphs[navProp];\r\n        var oldList = oldDoc[navProp] || [];\r\n        var newList = newDoc[navProp];\r\n        if (!newList)\r\n            return \"continue\";\r\n        var tuples = newList\r\n            .map(function (doc, idx) { return ({ doc: doc, idx: idx }); }); // Create tubles of {doc, array-index} so we can update result\r\n        var added = tuples.filter(function (tuple) { return !oldList.some(function (o) { return o.id === tuple.doc.id; }); }); // Find added items\r\n        try {\r\n            for (var added_1 = (e_2 = void 0, tslib_1.__values(added)), added_1_1 = added_1.next(); !added_1_1.done; added_1_1 = added_1.next()) {\r\n                var a = added_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, a.doc);\r\n                var meta = mutatedSubDoc.$meta;\r\n                delete mutatedSubDoc.$meta; // Delete $meta so that \"add\" or \"update\" does not persiste to next state.\r\n                if (meta === 'add') {\r\n                    if (!mutatedSubDoc.id)\r\n                        mutatedSubDoc.id = createUUID(); // Generate ID if not done yet.\r\n                    // Now put an 'add' mutation in the batch queue.\r\n                    batch.add(foreignTable, mutatedSubDoc);\r\n                }\r\n                else if (meta === 'update') {\r\n                    batch.put(foreignTable, mutatedSubDoc);\r\n                }\r\n                batch.link(table, docId, foreignTable, mutatedSubDoc.id, navProp);\r\n                // Update result so that state is reflected after succesful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][a.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (added_1_1 && !added_1_1.done && (_a = added_1.return)) _a.call(added_1);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        var removed = oldList.filter(function (o) { return !newList.some(function (n) { return n.id === o.id; }); });\r\n        try {\r\n            for (var removed_1 = (e_3 = void 0, tslib_1.__values(removed)), removed_1_1 = removed_1.next(); !removed_1_1.done; removed_1_1 = removed_1.next()) {\r\n                var r = removed_1_1.value;\r\n                batch.unlink(table, docId, foreignTable, r.id, navProp);\r\n            }\r\n        }\r\n        catch (e_3_1) { e_3 = { error: e_3_1 }; }\r\n        finally {\r\n            try {\r\n                if (removed_1_1 && !removed_1_1.done && (_b = removed_1.return)) _b.call(removed_1);\r\n            }\r\n            finally { if (e_3) throw e_3.error; }\r\n        }\r\n        var updated = tuples.filter(function (tuple) { return oldList.some(function (o) { return o.id === tuple.doc.id && tuple.doc.$meta === 'update'; }); });\r\n        try {\r\n            for (var updated_1 = (e_4 = void 0, tslib_1.__values(updated)), updated_1_1 = updated_1.next(); !updated_1_1.done; updated_1_1 = updated_1.next()) {\r\n                var u = updated_1_1.value;\r\n                var mutatedSubDoc = tslib_1.__assign({}, u.doc);\r\n                delete mutatedSubDoc.$meta;\r\n                batch.put(foreignTable, mutatedSubDoc);\r\n                // Update result so that $meta is removed from navigation prop after successful POST to server.\r\n                if (!docUpdates[navProp])\r\n                    docUpdates[navProp] = {};\r\n                docUpdates[navProp][u.idx] = { $set: mutatedSubDoc };\r\n            }\r\n        }\r\n        catch (e_4_1) { e_4 = { error: e_4_1 }; }\r\n        finally {\r\n            try {\r\n                if (updated_1_1 && !updated_1_1.done && (_c = updated_1.return)) _c.call(updated_1);\r\n            }\r\n            finally { if (e_4) throw e_4.error; }\r\n        }\r\n    };\r\n    try {\r\n        for (var _b = tslib_1.__values(Object.keys(graphs)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n            var navProp = _c.value;\r\n            _loop_1(navProp);\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return update(newDoc, docUpdates);\r\n}\r\nexport function dtFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD HH:mm');\r\n}\r\nexport function shortDateFormat(dateTime) {\r\n    return moment(dateTime).format('YYMMDD');\r\n}\r\nexport function shortPersonNameFormat(name) {\r\n    if (!name)\r\n        return \"\";\r\n    var names = name.split(' ').filter(function (n) { return !!n; });\r\n    var lastName = names.pop();\r\n    return names.map(function (name) { return name[0] + \".\"; }).concat(lastName).join(' ');\r\n}\r\nexport function updateModificationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        dateTime: { $set: now },\r\n        modifiedDate: { $set: now },\r\n        modifiedBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function updateCreationStamp(now, obj, user) {\r\n    return update(obj, {\r\n        createdDate: { $set: now },\r\n        createdBy: {\r\n            $set: {\r\n                name: user.displayName,\r\n                url: \"mailto:\" + user.mail\r\n            }\r\n        }\r\n    });\r\n}\r\nexport function getEmailFromDocAccess(resource) {\r\n    if (resource.email)\r\n        return resource.email;\r\n    return resource.url ?\r\n        resource.url.startsWith('mailto:') ?\r\n            resource.url.substring('mailto:'.length) :\r\n            resource.url :\r\n        resource.url;\r\n}\r\nexport function updateModificationAndCreationStamps(obj, user) {\r\n    var now = Date.now();\r\n    obj = updateModificationStamp(now, obj, user);\r\n    if (!obj.createdBy)\r\n        obj = updateCreationStamp(now, obj, user);\r\n    return obj;\r\n}\r\nexport function applyEtags(doc, newEtags, graphs) {\r\n    var e_5, _a;\r\n    var res = tslib_1.__assign({}, doc);\r\n    var etag = newEtags[doc.id];\r\n    if (etag)\r\n        res.$etag = etag;\r\n    try {\r\n        for (var graphs_1 = tslib_1.__values(graphs), graphs_1_1 = graphs_1.next(); !graphs_1_1.done; graphs_1_1 = graphs_1.next()) {\r\n            var label = graphs_1_1.value;\r\n            var newList = doc[label].map(function (d) { return applyEtags(d, newEtags, []); });\r\n            res[label] = newList;\r\n        }\r\n    }\r\n    catch (e_5_1) { e_5 = { error: e_5_1 }; }\r\n    finally {\r\n        try {\r\n            if (graphs_1_1 && !graphs_1_1.done && (_a = graphs_1.return)) _a.call(graphs_1);\r\n        }\r\n        finally { if (e_5) throw e_5.error; }\r\n    }\r\n    return res;\r\n}\r\nexport function readBlob(blob, m) {\r\n    return new Promise(function (resolve, reject) {\r\n        var reader = new FileReader();\r\n        reader.onload = function (ev) { return resolve(ev.target.result); };\r\n        reader.onabort = function (ev) { return reject(new Error(\"file read aborted\")); };\r\n        reader.onerror = function (ev) { return reject(ev.target.error); };\r\n        m(reader);\r\n    });\r\n}\r\nexport function readBlobAsText(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsText(blob); });\r\n}\r\nexport function readBlobAsDataUrl(blob) {\r\n    return readBlob(blob, function (r) { return r.readAsDataURL(blob); });\r\n}\r\nexport function allowCopy(e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    e.dataTransfer.dropEffect = 'copy';\r\n}\r\nexport function updateCourseBuilderStatus(status) {\r\n    var div = $('div.course-builder')[0];\r\n    if (div)\r\n        div.className = \"course-builder\" + (status ? \" status \" + status : \"\");\r\n}\r\nexport function loadCourse(id, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var client, includeTemplateChain, includeTasks, _a, course, courseTasks, templateChain;\r\n        return tslib_1.__generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    client = env.kedBackendClient;\r\n                    includeTemplateChain = options && options.includeTemplateChain;\r\n                    includeTasks = !options || !options.include || options.include.indexOf(\"tasks\") !== -1;\r\n                    return [4 /*yield*/, Promise.all([\r\n                            client.get(\"courses\", id, {\r\n                                include: options && options.include ? options.include.filter(function (i) { return i !== \"tasks\"; }) : [\r\n                                    \"centralContent\",\r\n                                    \"knowledgeRequirements\",\r\n                                    \"abilities\",\r\n                                    \"images\",\r\n                                    \"acl\" // Don't include tasks here...\r\n                                ]\r\n                            }),\r\n                            // ... but include tasks here instead so that we can load the graphs for the\r\n                            // tasks as well!\r\n                            includeTasks && client.list(\"tasks\", {\r\n                                hasEdgesFrom: id,\r\n                                include: ['knowledgeRequirements', 'centralContent', 'abilities', 'acl'],\r\n                                flags: ['includeIdsOnly'] // Don't need redundant info that's already on course\r\n                            }),\r\n                            includeTemplateChain && client.list(\"courses\", {\r\n                                hasEdgesFrom: id,\r\n                                flags: ['idsOnly']\r\n                            })\r\n                        ])];\r\n                case 1:\r\n                    _a = tslib_1.__read.apply(void 0, [(_b.sent()), 3]), course = _a[0], courseTasks = _a[1], templateChain = _a[2];\r\n                    course.tasks = courseTasks;\r\n                    // Correct the order of Abilities\r\n                    if (course.abilities && course.abilitiesOrder) {\r\n                        course.abilities = course.abilitiesOrder.map(function (id) {\r\n                            return course.abilities.find(function (a) { return a.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of KnowledgeRequirements\r\n                    if (course.knowledgeRequirements && course.knowledgeRequirementsOrder) {\r\n                        course.knowledgeRequirements = course.knowledgeRequirementsOrder.map(function (id) {\r\n                            return course.knowledgeRequirements.find(function (c) { return c.id === id; });\r\n                        });\r\n                    }\r\n                    // Correct the order of CentralContent\r\n                    if (course.centralContent && course.centralContentOrder) {\r\n                        course.centralContent = course.centralContentOrder.map(function (id) {\r\n                            return course.centralContent.find(function (cc) { return cc.id === id; });\r\n                        }); //.filter(x => !!x);// Debugging somthin' . Normally the last .filter()... part should not be nescessary...\r\n                    }\r\n                    // Include template chain if requested.\r\n                    if (includeTemplateChain)\r\n                        course.templateChain = templateChain;\r\n                    return [2 /*return*/, course];\r\n            }\r\n        });\r\n    });\r\n}\r\n// Check differences between two array of type T\r\nexport function hasChanges(originalValues, currentValues) {\r\n    return originalValues === undefined || currentValues.filter(function (x) { return !originalValues.includes(x); }).length > 0 || originalValues.filter(function (x) { return !currentValues.includes(x); }).length > 0;\r\n}\r\n","import * as React from \"react\";\r\nexport var FileView = function (_a) {\r\n    var thumbnail = _a.thumbnail, url = _a.url, title = _a.title, label = _a.label, icon = _a.icon, _b = _a.size, size = _b === void 0 ? \"small\" : _b, customAction = _a.customAction;\r\n    var myLabel = !!label ? label : title;\r\n    var myIcon = !!thumbnail ? thumbnail : icon;\r\n    var hasIcon = !!myIcon;\r\n    return (React.createElement(\"div\", { className: \"file-view \" + size },\r\n        React.createElement(\"a\", { href: customAction ? \"#\" : url, target: customAction ? undefined : \"_blank\", title: title }, hasIcon ? (React.createElement(\"img\", { className: \"file-\" + (thumbnail ? \"thumbnail\" : \"icon\"), src: myIcon, alt: title })) : (React.createElement(\"i\", { className: \"fas fa-file\" }))),\r\n        React.createElement(\"a\", { href: customAction ? \"#\" : url, target: customAction ? undefined : \"_blank\", title: title, onClick: customAction }, myLabel)));\r\n};\r\n","import * as React from 'react';\r\nexport var LanguageContext = React.createContext({ intl: null });\r\n","import * as tslib_1 from \"tslib\";\r\nimport { IntlProvider, addLocaleData } from 'react-intl';\r\nimport locale_en from 'react-intl/locale-data/en';\r\nimport locale_sv from 'react-intl/locale-data/sv';\r\nimport messages_sv from \"../../translations/sv.json\";\r\nimport messages_en from \"../../translations/en.json\";\r\nimport * as React from 'react';\r\nimport cfg from '../../globals/KED.cfg';\r\nimport moment from 'moment';\r\nexport var setupIntl = function (Component) {\r\n    return /** @class */ (function (_super) {\r\n        tslib_1.__extends(_SetupLanguageIntl, _super);\r\n        function _SetupLanguageIntl(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            addLocaleData(tslib_1.__spread(locale_en, locale_sv));\r\n            _this.messages = {\r\n                'sv': messages_sv,\r\n                'en': messages_en\r\n            };\r\n            moment().locale(cfg.KED_LOCALE);\r\n            return _this;\r\n        }\r\n        _SetupLanguageIntl.prototype.render = function () {\r\n            return React.createElement(IntlProvider, { locale: cfg.KED_LOCALE, messages: this.messages[cfg.KED_LOCALE] },\r\n                React.createElement(Component, tslib_1.__assign({}, this.props)));\r\n        };\r\n        return _SetupLanguageIntl;\r\n    }(React.Component));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nexport var AlignHorizontal = function (_a) {\r\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\r\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"align-horizontal\"]).join(' ') }, children));\r\n};\r\n","import React from 'react';\r\nexport var UICheckbox = function (_a) {\r\n    var state = _a.state, label = _a.label, onChange = _a.onChange;\r\n    return React.createElement(\"label\", { className: 'ui-checkbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\nexport var UIAddbox = function (_a) {\r\n    var state = _a.state, label = _a.label, _b = _a.onChange, onChange = _b === void 0 ? function () { return null; } : _b;\r\n    return React.createElement(\"label\", { className: 'ui-addbox' },\r\n        label,\r\n        React.createElement(\"input\", { type: \"checkbox\", checked: state == \"checked\", onChange: onChange }),\r\n        React.createElement(\"span\", { className: \"custom-element\" }));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nvar ContentEditableField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ContentEditableField, _super);\r\n    function ContentEditableField(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.myself = React.createRef();\r\n        _this.state = {\r\n            text: props.text || ''\r\n        };\r\n        return _this;\r\n    }\r\n    ContentEditableField.prototype.render = function () {\r\n        var _a = this.props, tag = _a.tag, text = _a.text, readOnly = _a.readOnly;\r\n        var TagType = tag;\r\n        return React.createElement(TagType, { contentEditable: !readOnly, \"data-placeholder\": this.props.placeholder, ref: this.myself, className: this.props.className, onChange: this.onChange.bind(this), onKeyDown: this.onKeyDown.bind(this), onKeyUp: this.onKeyUp.bind(this), onBlur: this.onBlur.bind(this), onPaste: this.onPaste.bind(this), dangerouslySetInnerHTML: { __html: text } });\r\n    };\r\n    ContentEditableField.prototype.onChange = function (e) {\r\n        this.setState({ text: this.myself.current.innerText });\r\n    };\r\n    /**\r\n     * Take action depending on key-event\r\n     * @param e event from field\r\n     *\r\n     * If allowNavigation then listen to arrow-keys\r\n     * Limits to maxChars\r\n     */\r\n    ContentEditableField.prototype.onKeyDown = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        if (e.key === 'Escape') {\r\n            this.myself.current.innerText = this.props.text || \"\";\r\n            this.myself.current.blur();\r\n            e.stopPropagation();\r\n        }\r\n        else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            this.navigate(text, 'down');\r\n        }\r\n        else if (e.key === 'Tab') {\r\n            this.propagateOnChange(text);\r\n        }\r\n        else if (text.length >= this.props.maxChars && (/^[\\d\\w\\s]$/.test(e.key) && !(e.metaKey || e.ctrlKey))) {\r\n            e.preventDefault();\r\n        }\r\n        if (this.props.allowNavigation === true) {\r\n            var navDir = e.key.startsWith('Arrow') ? e.key.replace('Arrow', '').toLowerCase() : false;\r\n            var caret = document.getSelection().getRangeAt(0).endOffset; // only works for plaintext\r\n            if (navDir && text.length == 0) {\r\n                this.navigate(text, navDir);\r\n            }\r\n            else if (navDir && (navDir == 'up' || navDir == 'down')) {\r\n                this.navigate(text, navDir);\r\n            }\r\n            else if (navDir && ((navDir == 'left' && caret == 0) ||\r\n                (navDir == 'right' && caret == text.length))) {\r\n                this.navigate(text, navDir);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     *\r\n     * @param e event from field\r\n     * Solely used to hande validations-issues\r\n     */\r\n    ContentEditableField.prototype.onKeyUp = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        if (this.props.validateValue !== undefined && !this.props.validateValue.test(text)) {\r\n            this.myself.current.innerText = this.props.text || \"\";\r\n            this.myself.current.blur();\r\n            e.preventDefault();\r\n        }\r\n    };\r\n    /**\r\n     * Update value and pass to parents navigate-funciton\r\n     * @param text\r\n     * @param direction\r\n     */\r\n    ContentEditableField.prototype.navigate = function (text, direction) {\r\n        // first update cell\r\n        this.propagateOnChange(text);\r\n        this.setState({ text: text });\r\n        // then navigate away\r\n        this.props.onNavigate(direction);\r\n    };\r\n    /**\r\n     * Make sure pasted text is pure text\r\n     * @param e the paset event\r\n     */\r\n    ContentEditableField.prototype.onPaste = function (e) {\r\n        e.preventDefault();\r\n        var text = (e.clipboardData && e.clipboardData.getData) ? e.clipboardData.getData(\"text/plain\") : '';\r\n        document.execCommand(\"insertHTML\", false, text);\r\n    };\r\n    /**\r\n     * Update value on exit from field\r\n     * @param e\r\n     */\r\n    ContentEditableField.prototype.onBlur = function (e) {\r\n        var text = this.myself.current.innerText;\r\n        this.propagateOnChange(text);\r\n        this.setState({ text: text });\r\n    };\r\n    /**\r\n     * Only update value if it has changed\r\n     * @param newValue\r\n     */\r\n    ContentEditableField.prototype.propagateOnChange = function (newValue) {\r\n        if (this.propagatedOnChange != newValue) {\r\n            this.propagatedOnChange = newValue;\r\n            this.props.onChange(newValue);\r\n        }\r\n    };\r\n    return ContentEditableField;\r\n}(React.PureComponent));\r\nexport { ContentEditableField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { FormField } from './form-field';\r\nvar TextInput = /** @class */ (function (_super) {\r\n    tslib_1.__extends(TextInput, _super);\r\n    function TextInput(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    TextInput.prototype.render = function () {\r\n        var _this = this;\r\n        return (React.createElement(FormField, { label: this.props.label },\r\n            React.createElement(\"div\", null,\r\n                React.createElement(\"input\", { type: \"text\", autoFocus: this.props.autoFocus, id: this.props.id, size: this.props.size || 35, value: this.props.value, onChange: this.props.onChange && (function (ev) { return _this.props.onChange(ev.target.value); }), disabled: this.props.disabled, placeholder: this.props.placeholder }))));\r\n    };\r\n    return TextInput;\r\n}(React.Component));\r\nexport { TextInput };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nfunction findId(node) {\r\n    var recucheck = new Set();\r\n    return (function findId(node) {\r\n        if (typeof node === 'string')\r\n            return null;\r\n        if (recucheck.has(node)) {\r\n            return;\r\n        }\r\n        recucheck.add(node);\r\n        if (node.props) {\r\n            if (node.props.id)\r\n                return node.props.id;\r\n            if (node.props.children) {\r\n                return findId(node.props.children);\r\n            }\r\n            return;\r\n        }\r\n        if (node.length) {\r\n            for (var i = 0; i < node.length; ++i) {\r\n                var child = node[i];\r\n                if (child) {\r\n                    var childId = findId(child);\r\n                    if (childId)\r\n                        return childId;\r\n                    //console.log(child);\r\n                }\r\n            }\r\n        }\r\n    })(node);\r\n}\r\nvar FormField = /** @class */ (function (_super) {\r\n    tslib_1.__extends(FormField, _super);\r\n    function FormField(props) {\r\n        return _super.call(this, props) || this;\r\n    }\r\n    FormField.prototype.render = function () {\r\n        return React.createElement(React.Fragment, null,\r\n            React.createElement(\"label\", { className: \"kclabel\", htmlFor: this.props.id || findId(this.props.children) }, this.props.label),\r\n            this.props.children);\r\n    };\r\n    return FormField;\r\n}(React.Component));\r\nexport { FormField };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React from 'react';\r\nexport var HorizontalItem = function (_a) {\r\n    var className = _a.className, classNames = _a.classNames, children = _a.children;\r\n    return (React.createElement(\"div\", { className: tslib_1.__spread((classNames || []), (className ? [className] : []), [\"horizontalItem\"]).join(' ') }, children));\r\n};\r\n","import * as tslib_1 from \"tslib\";\r\nimport { FiberContext } from \"kedbackend/observable\";\r\nimport React, { Suspense } from 'react';\r\nimport { L } from '../../utils/utils';\r\nvar FiberContextReact = React.createContext(null);\r\nvar ReactSharedInternals = Object.keys(React).filter(function (key) { return key.includes(\"_INTERNALS\"); }).map(function (k) { return React[k]; })[0];\r\nvar ReactCurrentDispatcher = ReactSharedInternals.ReactCurrentDispatcher;\r\nFiberContext.addProvider(function () {\r\n    // Here we actuall do useContext(FiberContext) but without logging to internal debug logs\r\n    // Normally, react hooks are sensitive in which order they are called (useState(), etc)\r\n    // but useContext() is not sensitive about that at all.\r\n    // Still, the debug version of react will log calls to useHook() and throw if a render\r\n    // doesn't use the same number of hooks every time. This check should not apply\r\n    // to useHook() since it is not sensitive to the order in which it was called.\r\n    // And we need to be able to call it from within contitional expressions / statements,\r\n    // so we must bypass this debug logging here by accessing readContext() directly.\r\n    return ReactCurrentDispatcher.current && ReactCurrentDispatcher.current.readContext(FiberContextReact);\r\n});\r\nvar Observe = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Observe, _super);\r\n    function Observe(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.subscriptions = [];\r\n        _this.outerSubscription = {\r\n            unsubscribe: function () {\r\n                _this.subscriptions.forEach(function (s) { return s.unsubscribe(); });\r\n                _this.subscriptions = [];\r\n            }\r\n        };\r\n        _this.observer = function (value, error, subscription) {\r\n            if (error) {\r\n                _this.setState({ error: error });\r\n            }\r\n            else {\r\n                _this.setState(function (_a) {\r\n                    var counter = _a.counter;\r\n                    return ({ counter: counter + 1, error: error });\r\n                });\r\n            }\r\n        };\r\n        _this.state = {\r\n            counter: 0,\r\n            error: null\r\n        };\r\n        return _this;\r\n    }\r\n    Observe.prototype.componentDidCatch = function (error, info) {\r\n        if (!error || !error.name)\r\n            error = new Error('' + error);\r\n        this.setState({ error: error, info: info });\r\n        console.log(error, info);\r\n    };\r\n    Observe.prototype.componentWillMount = function () {\r\n        this.outerSubscription.unsubscribe();\r\n    };\r\n    Observe.prototype.render = function () {\r\n        if (this.state.error) {\r\n            return this.props.errorFallback || React.createElement(\"p\", null, L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Kunde inte ladda inneh\\u00E5llet\"], [\"Kunde inte ladda inneh\\u00E5llet\"]))));\r\n        }\r\n        this.outerSubscription.unsubscribe();\r\n        return React.createElement(Suspense, { fallback: this.props.fallback || null },\r\n            React.createElement(FiberContextReact.Provider, { value: this }, this.props.children));\r\n    };\r\n    return Observe;\r\n}(React.Component));\r\nexport { Observe };\r\nvar templateObject_1;\r\n","/* REFACTOR: Move this component outside coursebuilder!\r\n   This is a general-purpose component\r\n*/\r\nimport * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { GoalProgress } from '../charts/goal-progress';\r\nvar OpenCloseBox = /** @class */ (function (_super) {\r\n    tslib_1.__extends(OpenCloseBox, _super);\r\n    function OpenCloseBox(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            headerOpen: props.headerOpen || false\r\n        };\r\n        return _this;\r\n    }\r\n    OpenCloseBox.prototype.componentWillReceiveProps = function (nextProps) {\r\n        if (nextProps.headerOpen !== this.props.headerOpen) {\r\n            this.setState({ headerOpen: nextProps.headerOpen });\r\n        }\r\n    };\r\n    OpenCloseBox.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.props, title = _a.title, className = _a.className, children = _a.children, headerClassName = _a.headerClassName, contentClassName = _a.contentClassName, displayProgress = _a.displayProgress, progressData = _a.progressData, inactivated = _a.inactivated, inactivatedRender = _a.inactivatedRender;\r\n        var headerOpen = this.state.headerOpen;\r\n        if (inactivated)\r\n            return inactivatedRender === 'titleAndChildren' ? React.createElement(React.Fragment, null,\r\n                React.createElement(React.Fragment, null, title),\r\n                React.createElement(React.Fragment, null, children)) : React.createElement(React.Fragment, null, children);\r\n        //var currentProgressData = //progressData();\r\n        return React.createElement(\"div\", { className: (className || '') + \" openClose\" + (headerOpen ? \" open\" : \"\") },\r\n            React.createElement(\"div\", { className: \"openHeader\" + (headerClassName ? \" \" + headerClassName : \"\"), onClick: function () {\r\n                    if (_this.props.onOpenClose)\r\n                        _this.props.onOpenClose(!_this.state.headerOpen);\r\n                    _this.setState({ headerOpen: !_this.state.headerOpen });\r\n                } },\r\n                React.createElement(\"div\", { className: \"openHeaderContainer\" },\r\n                    React.createElement(\"div\", null, title),\r\n                    displayProgress && React.createElement(GoalProgress, tslib_1.__assign({}, progressData)))),\r\n            React.createElement(\"div\", { className: \"openContent\" + (contentClassName ? \" \" + contentClassName : \"\") }, children));\r\n    };\r\n    return OpenCloseBox;\r\n}(React.Component));\r\nexport { OpenCloseBox };\r\n","import * as tslib_1 from \"tslib\";\r\nimport React, { useState } from 'react';\r\nexport function taskHasMigratedTexts(task) {\r\n    return task.migratedTexts && Object.keys(task.migratedTexts).some(function (type) {\r\n        return Object.keys(task.migratedTexts[type]).length > 0;\r\n    });\r\n}\r\nexport function SortableTaskList(_a) {\r\n    var taskMetas = _a.taskMetas, renderEditLink = _a.renderEditLink, renderLink = _a.renderLink, onSort = _a.onSort;\r\n    var _b = tslib_1.__read(useState({\r\n        taskBeingDragged: null,\r\n        taskBeingHovered: null,\r\n        insertBefore: false,\r\n        originClientY: -1\r\n    }), 2), dragState = _b[0], setDragState = _b[1];\r\n    var taskBeingDragged = dragState.taskBeingDragged, taskBeingHovered = dragState.taskBeingHovered, insertBefore = dragState.insertBefore, originClientY = dragState.originClientY;\r\n    return React.createElement(\"div\", { className: \"taskContainer sortable\", onDrop: function (ev) {\r\n            if (taskBeingHovered && taskBeingDragged) {\r\n                onSort(taskBeingDragged, taskBeingHovered, insertBefore ? 'before' : 'after');\r\n            }\r\n            setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null, taskBeingDragged: null }));\r\n        } }, taskMetas.map(function (taskMeta) {\r\n        var task = taskMeta.task, isTaskOwner = taskMeta.isTaskOwner;\r\n        var hasMigratedTexts = taskHasMigratedTexts(task);\r\n        var taskId = task.id;\r\n        return React.createElement(React.Fragment, { key: taskId },\r\n            insertBefore && taskBeingHovered === task ?\r\n                React.createElement(\"div\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") :\r\n                null,\r\n            React.createElement(\"div\", { className: [\"align-horizontal\", \"draggable\", task === taskBeingDragged && \"drag-source\"].filter(function (x) { return x; }).join(' '), draggable: true, onDragStart: function (ev) {\r\n                    ev.dataTransfer.effectAllowed = \"move\";\r\n                    setDragState(tslib_1.__assign({}, dragState, { originClientY: ev.clientY, taskBeingDragged: task }));\r\n                }, onDragOver: function (ev) {\r\n                    if (!taskBeingDragged)\r\n                        return;\r\n                    if (taskBeingDragged === task) {\r\n                        setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null }));\r\n                        return;\r\n                    }\r\n                    ev.preventDefault();\r\n                    ev.dataTransfer.dropEffect = \"move\";\r\n                    setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: task, insertBefore: originClientY > ev.clientY }));\r\n                }, onDragEnd: function (ev) {\r\n                    setDragState(tslib_1.__assign({}, dragState, { taskBeingHovered: null, taskBeingDragged: null }));\r\n                } },\r\n                isTaskOwner && hasMigratedTexts && React.createElement(\"div\", { className: \"horizontalItem top\" },\r\n                    React.createElement(\"div\", { style: { position: 'relative', top: '0.2em', left: '-0.7em' } },\r\n                        React.createElement(\"i\", { className: \"fa fa-pagelines\", style: { position: 'absolute', top: 0, left: 0, color: '#49c35a' } }))),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, renderEditLink(taskMeta)),\r\n                React.createElement(\"div\", { className: \"horizontalItem top\" }, renderLink(taskMeta))),\r\n            !insertBefore && taskBeingHovered === task ?\r\n                React.createElement(\"div\", { className: \"drop-target\", onDragOver: function (ev) { return ev.preventDefault(); } }, \"\\u00A0\") :\r\n                null);\r\n    }));\r\n}\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>F</b>',\r\n        title: 'Fetstil',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>K</i>',\r\n        title: 'Kursiv',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Understruken',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Struken',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Rubrik 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Rubrik 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Rubrik 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraf',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Citat',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '<i class=\"fa fa-list-ol\" aria-hidden=\"true\"></i>',\r\n        title: 'Ordnad lista',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '<i class=\"fa fa-list\" aria-hidden=\"true\"></i>',\r\n        title: 'Punktlista',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Minska indrag',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'Öka indrag',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Programkod',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Vågrät linje',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '<i class=\"fa fa-link\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga länk',\r\n        result: function () {\r\n            var url = window.prompt('Ange länkens URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '<i class=\"fa fa-picture-o\" aria-hidden=\"true\"></i>',\r\n        title: 'Infoga bild',\r\n        promptMsg: 'Ange bildens URL',\r\n        result: function (ev, component) {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url) {\r\n                //exec('insertImage', url);\r\n                var img = document.createElement(\"img\");\r\n                img.src = url;\r\n                img.tabIndex = 1;\r\n                insertElement(img);\r\n                img.onfocus = component.onFocus;\r\n                img.onblur = component.onBlur;\r\n                component.props.onChange(component.contentDiv.innerHTML);\r\n            }\r\n        }\r\n    }\r\n};\r\nfunction insertElement(element) {\r\n    var sel, range;\r\n    if (window.getSelection && (sel = window.getSelection()).rangeCount) {\r\n        range = sel.getRangeAt(0);\r\n        range.collapse(true);\r\n        range.insertNode(element);\r\n        // Move the caret immediately after the inserted span\r\n        range.setStartAfter(element);\r\n        range.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(range);\r\n    }\r\n}\r\n","import exec from './exec';\r\nexport default {\r\n    bold: {\r\n        icon: '<b>B</b>',\r\n        title: 'Bold',\r\n        result: function () { return exec('bold'); }\r\n    },\r\n    italic: {\r\n        icon: '<i>I</i>',\r\n        title: 'Italic',\r\n        result: function () { return exec('italic'); }\r\n    },\r\n    underline: {\r\n        icon: '<u>U</u>',\r\n        title: 'Underline',\r\n        result: function () { return exec('underline'); }\r\n    },\r\n    strikethrough: {\r\n        icon: '<strike>S</strike>',\r\n        title: 'Strike-through',\r\n        result: function () { return exec('strikeThrough'); }\r\n    },\r\n    heading1: {\r\n        icon: '<b>H<sub>1</sub></b>',\r\n        title: 'Heading 1',\r\n        result: function () { return exec('formatBlock', '<H1>'); }\r\n    },\r\n    heading2: {\r\n        icon: '<b>H<sub>2</sub></b>',\r\n        title: 'Heading 2',\r\n        result: function () { return exec('formatBlock', '<H2>'); }\r\n    },\r\n    heading3: {\r\n        icon: '<b>H<sub>3</sub></b>',\r\n        title: 'Heading 3',\r\n        result: function () { return exec('formatBlock', '<H3>'); }\r\n    },\r\n    paragraph: {\r\n        icon: '&#182;',\r\n        title: 'Paragraph',\r\n        result: function () { return exec('formatBlock', '<P>'); }\r\n    },\r\n    quote: {\r\n        icon: '&#8220; &#8221;',\r\n        title: 'Quote',\r\n        result: function () { return exec('formatBlock', '<BLOCKQUOTE>'); }\r\n    },\r\n    olist: {\r\n        icon: '&#35;',\r\n        title: 'Ordered List',\r\n        result: function () { return exec('insertOrderedList'); }\r\n    },\r\n    ulist: {\r\n        icon: '&#8226;',\r\n        title: 'Unordered List',\r\n        result: function () { return exec('insertUnorderedList'); }\r\n    },\r\n    outdent: {\r\n        icon: '<i class=\"fa fa-outdent\" aria-hidden=\"true\"></i>',\r\n        title: 'Outdent',\r\n        result: function () { return exec(\"outdent\"); }\r\n    },\r\n    indent: {\r\n        icon: '<i class=\"fa fa-indent\" aria-hidden=\"true\"></i>',\r\n        title: 'Indent',\r\n        result: function () { return exec(\"indent\"); },\r\n    },\r\n    code: {\r\n        icon: '&lt;/&gt;',\r\n        title: 'Code',\r\n        result: function () { return exec('formatBlock', '<PRE>'); }\r\n    },\r\n    line: {\r\n        icon: '&#8213;',\r\n        title: 'Horizontal Line',\r\n        result: function () { return exec('insertHorizontalRule'); }\r\n    },\r\n    link: {\r\n        icon: '&#128279;',\r\n        title: 'Link',\r\n        result: function () {\r\n            var url = window.prompt('Enter the link URL');\r\n            if (url) {\r\n                var selected = document.getSelection();\r\n                var elem = document.createElement('a');\r\n                elem.href = url;\r\n                elem.target = \"_blank\";\r\n                elem.appendChild(document.createTextNode(selected.toString()));\r\n                exec('insertHTML', elem.outerHTML);\r\n            }\r\n        }\r\n    },\r\n    image: {\r\n        icon: '&#128247;',\r\n        title: 'Image',\r\n        promptMsg: 'Enter the URL of the image',\r\n        result: function () {\r\n            var url = window.prompt(this.promptMsg);\r\n            if (url)\r\n                exec('insertImage', url);\r\n        }\r\n    }\r\n};\r\n","export default (function (command, value) {\r\n    if (value === void 0) { value = null; }\r\n    document.execCommand(command, false, value);\r\n});\r\n","export function patchElement(element) {\r\n    var modified = false;\r\n    if (element.tagName === \"A\") {\r\n        var href = element.getAttribute(\"href\");\r\n        var target = element.getAttribute(\"target\");\r\n        if (href) {\r\n            if (href.startsWith(\"javascript:\")) {\r\n                // Fix \"javascript:window.open('...')\" URLS\r\n                var url = href;\r\n                var windowOpen = \"window.open('\";\r\n                var pWindowOpen = url.indexOf(windowOpen);\r\n                if (pWindowOpen >= 0) {\r\n                    var urlEnd = url.substr(pWindowOpen + windowOpen.length);\r\n                    var pUrlEnd = urlEnd.indexOf(\"'\");\r\n                    if (pUrlEnd >= 0) {\r\n                        var newUrl = urlEnd.substr(0, pUrlEnd);\r\n                        element.setAttribute(\"href\", newUrl);\r\n                        element.setAttribute(\"target\", \"_blank\"); // The reason they use JS links is for opening in new tab\r\n                        modified = true;\r\n                    }\r\n                }\r\n            }\r\n            else if (href.startsWith(\"https://\") || href.startsWith(\"http://\")) {\r\n                try {\r\n                    var url = new URL(href);\r\n                    // Fix digilär URLs:\r\n                    if (url.host === \"xn--digilr-fua.se\") {\r\n                        if (url.search[0] === '?') {\r\n                            var pSecondQ = url.search.indexOf('?', 1);\r\n                            if (pSecondQ > 0) {\r\n                                url.search = url.search.substr(0, pSecondQ) + \"&\" + url.search.substr(pSecondQ + 1);\r\n                                element.setAttribute(\"href\", url.href);\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                    // Fix so that external URLS are opened in separate tabs\r\n                    if (location.hostname !== 'localhost') {\r\n                        if (url.host !== location.host) {\r\n                            if (!element.getAttribute(\"target\")) {\r\n                                element.setAttribute(\"target\", \"_blank\");\r\n                                modified = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                catch (error) {\r\n                    element.removeAttribute(\"a\");\r\n                    modified = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n","export default function imageEditActions(cb) {\r\n    return [{\r\n            name: 'float-left',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-right\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; left:-4px;top:0; transform: scale(0.5); transform-origin: left top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Låt bilden flyta vänster om text',\r\n            result: function () { return cb('float-left'); }\r\n        }, {\r\n            name: 'float-right',\r\n            icon: \"<div style=\\\"position:relative\\\">\\n      <i class=\\\"fa fa-align-left\\\" aria-hidden=\\\"true\\\"></i>\\n      <div style=\\\"position:absolute; right:-4px;top:0; transform: scale(0.5); transform-origin: right top\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n    </div>\",\r\n            title: 'Låt bilden flyta höger om text',\r\n            result: function () { return cb('float-right'); }\r\n        }, {\r\n            name: 'unfloat',\r\n            icon: \"<div style=\\\"position:relative;\\\" aria-hidden=\\\"true\\\">\\n      <div style=\\\"position:absolute;top:0;left:0\\\">&#8254;</div>\\n      <div style=\\\"position:absolute;top:0:left:0;transform: scale(0.5); transform-origin: left bottom\\\">\\n        <i class=\\\"fa fa-picture-o\\\" aria-hidden=\\\"true\\\"></i>\\n      </div>\\n      <div style=\\\"position:absolute;top:0;left:0\\\">_</div>\\n    </div>\",\r\n            title: 'Placera bilden på egen rad',\r\n            result: function () { return cb('unfloat'); }\r\n        }];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport exec from './exec';\r\nimport { washHtml } from './wash-html';\r\nimport imageEditActions from './image-edit-actions';\r\nimport actions from './actions';\r\nvar classes = {\r\n    actionbar: 'wysiwyg-actionbar',\r\n    button: 'wysiwyg-button',\r\n    content: 'wysiwyg-content',\r\n    focusrect: 'wysiwyg-focusrect',\r\n    focuspoint: 'wysiwyg-focuspoint',\r\n    readonlyContent: 'wysiwyg-content readonly'\r\n};\r\nvar Wysiwyg = /** @class */ (function (_super) {\r\n    tslib_1.__extends(Wysiwyg, _super);\r\n    function Wysiwyg(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = { focusRect: null };\r\n        _this.onFocus = _this.onFocus.bind(_this);\r\n        _this.onBlur = _this.onBlur.bind(_this);\r\n        _this.onMouseDown = _this.onMouseDown.bind(_this);\r\n        _this.onMouseMove = _this.onMouseMove.bind(_this);\r\n        _this.onMouseUp = _this.onMouseUp.bind(_this);\r\n        return _this;\r\n    }\r\n    Wysiwyg.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        if (!this.props.readOnly) {\r\n            Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n                .forEach(function (elem) {\r\n                elem.tabIndex = 1;\r\n                elem.onfocus = _this.onFocus;\r\n                elem.onblur = _this.onBlur;\r\n            });\r\n        }\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.componentDidUpdate = function () {\r\n        var _this = this;\r\n        Array.from(this.contentDiv.querySelectorAll(\"img,a\")).map(function (elem) { return elem; })\r\n            .forEach(function (elem) {\r\n            elem.tabIndex = 1;\r\n            elem.onfocus = _this.onFocus;\r\n            elem.onblur = _this.onBlur;\r\n        });\r\n        if (this.props.reportNumChars) {\r\n            this.props.reportNumChars((this.contentDiv && this.contentDiv.innerText && this.contentDiv.innerText.length) || 0);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.shouldComponentUpdate = function (nextProps, nextState) {\r\n        //this.contentDiv.onfocus = this.onFocus;\r\n        //this.contentDiv.onblur = this.onBlur;\r\n        return !this.contentDiv ||\r\n            nextState != this.state ||\r\n            nextProps.readOnly !== this.props.readOnly ||\r\n            washHtml(nextProps.html) !== washHtml(this.contentDiv.innerHTML);\r\n    };\r\n    Wysiwyg.prototype.triggerOnChange = function (html) {\r\n        this.props.onChange && this.props.onChange(washHtml(html));\r\n    };\r\n    Wysiwyg.prototype.onFocus = function (ev) {\r\n        var elem = ev.target;\r\n        if (!elem || !elem.tagName)\r\n            return;\r\n        if (elem.tagName !== 'IMG' && elem.tagName !== 'A')\r\n            return;\r\n        var contentParent = this.contentDiv.parentElement;\r\n        var newState = {\r\n            focusRect: getRelatativeClientRect(contentParent, elem),\r\n        };\r\n        switch (elem.tagName) {\r\n            case 'A':\r\n            case 'IMG':\r\n            default: break;\r\n        }\r\n        this.setState(newState);\r\n        this.focusElem = elem;\r\n    };\r\n    Wysiwyg.prototype.onBlur = function (ev) {\r\n        /*if (ev.relatedTarget) {\r\n          const relatedTarget = ev.relatedTarget as HTMLElement;\r\n          if (relatedTarget.className && relatedTarget.className.split(' ').indexOf(classes.button) >= 0) {\r\n            // A image action button was pressed\r\n            set\r\n            return;\r\n          }\r\n        }*/\r\n        if ((ev.target === this.focusElem && ev.relatedTarget !== this.focusRectDiv) ||\r\n            ev.target === this.focusRectDiv) {\r\n            this.setState({ focusRect: null });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.makeClickable = function (elem) {\r\n        elem.tabIndex = 1;\r\n    };\r\n    Wysiwyg.prototype.onMouseDown = function (ev) {\r\n        if ((ev.target.className || \"\").split(' ').indexOf(classes.focuspoint) >= 0) {\r\n            var corner = this.getRectCorner(ev);\r\n            this.corner = corner;\r\n            this.resizeStartX = ev.clientX;\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseMove = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            ev.preventDefault();\r\n            // TODO: Räkna ut baserat på this.corner hur bildens storlek borde ändras.\r\n            // Leta upp bilden per ID från this.contentDiv\r\n            // Sätt DIV:ens style attribut width till ny width.\r\n            // Om DIV:en redan hade height, sätt ny height med samma aspect ratio som innan,\r\n            // annars, sätt inte height alls (eller möjligtvis till auto))\r\n            var focusRect = this.focusRectDiv.getBoundingClientRect();\r\n            if (focusRect.width < 32)\r\n                return;\r\n            //const currentWidth = focusRect.width;\r\n            //const currentHeight = focusRect.height;\r\n            //const hasHeightStyle = !this.focusElem.style.height || this.focusElem.style.height === \"auto\";\r\n            var newWidth = Math.max(32, this.corner.endsWith('l') ?\r\n                focusRect.width + (this.resizeStartX - ev.clientX) :\r\n                //focusRect.right - ev.clientX :\r\n                focusRect.width - (this.resizeStartX - ev.clientX));\r\n            this.resizeStartX = ev.clientX;\r\n            //ev.clientX - focusRect.left;\r\n            var factor = newWidth / focusRect.width;\r\n            var newHeight = focusRect.height * factor;\r\n            this.focusElem.style.width = newWidth + \"px\";\r\n            this.focusElem.style.height = newHeight + \"px\";\r\n            this.setState({\r\n                focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem),\r\n            });\r\n        }\r\n    };\r\n    Wysiwyg.prototype.onMouseUp = function (ev) {\r\n        if (this.corner && this.state.focusRect && this.focusElem) {\r\n            this.corner = null;\r\n            this.triggerOnChange(this.contentDiv.innerHTML);\r\n        }\r\n    };\r\n    Wysiwyg.prototype.getRectCorner = function (ev) {\r\n        var e_1, _a;\r\n        try {\r\n            for (var _b = tslib_1.__values((ev.target.className || '').split(' ')), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var className = _c.value;\r\n                switch (className) {\r\n                    case 'fpul':\r\n                        return 'ul';\r\n                    case 'fpur':\r\n                        return 'fpur';\r\n                    case 'fplr':\r\n                        return 'lr';\r\n                    case 'fpll':\r\n                        return 'll';\r\n                }\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n        return null;\r\n    };\r\n    Wysiwyg.prototype.execImageEditAction = function (cmd) {\r\n        //console.log(cmd);\r\n        if (!this.focusElem)\r\n            return;\r\n        //console.log(\"doing it\");\r\n        switch (cmd) {\r\n            case 'float-left':\r\n                this.focusElem.style.cssFloat = 'left';\r\n                break;\r\n            case 'float-right':\r\n                this.focusElem.style.cssFloat = 'right';\r\n                break;\r\n            case 'unfloat':\r\n                this.focusElem.style.cssFloat = '';\r\n                break;\r\n        }\r\n        this.triggerOnChange(this.contentDiv.innerHTML);\r\n        this.setState({ focusRect: getRelatativeClientRect(this.contentDiv.parentElement, this.focusElem) });\r\n    };\r\n    Wysiwyg.prototype.render = function () {\r\n        var _this = this;\r\n        var defaultActions = this.props.defaultActions || actions;\r\n        var actionsToUse = this.props.actions ? this.props.actions.map(function (action) {\r\n            return typeof action === 'string' ?\r\n                defaultActions[action] :\r\n                defaultActions[action.name] ? tslib_1.__assign({}, defaultActions[action.name], action) :\r\n                    action;\r\n        })\r\n            : Object.keys(defaultActions).map(function (action) { return defaultActions[action]; });\r\n        if (this.state.focusRect) {\r\n            actionsToUse = actionsToUse.concat(imageEditActions(function (cmd) { return _this.execImageEditAction(cmd); }));\r\n        }\r\n        var focusRect = this.state.focusRect;\r\n        var _a = this.props, readOnly = _a.readOnly, reportNumChars = _a.reportNumChars, maxChars = _a.maxChars;\r\n        return React.createElement(\"div\", { className: this.props.className },\r\n            !readOnly && React.createElement(\"div\", { className: classes.actionbar }, actionsToUse.map(function (action, idx) {\r\n                return React.createElement(\"button\", { key: idx, className: classes.button, dangerouslySetInnerHTML: { __html: action.icon }, title: action.title, onMouseDown: function (ev) { action.result(ev, _this); }, onMouseUp: function (ev) { return setTimeout(function () { return _this.contentDiv.focus(); }, 10); } });\r\n            })),\r\n            React.createElement(\"div\", { className: readOnly ? classes.readonlyContent : classes.content, style: { position: 'relative', top: 0, left: 0 }, onMouseMove: this.onMouseMove, onMouseDown: this.onMouseDown, onMouseUp: this.onMouseUp },\r\n                React.createElement(\"div\", { className: \"editor\", ref: function (div) { return _this.contentDiv = div; }, dangerouslySetInnerHTML: { __html: washHtml(this.props.html) }, contentEditable: !readOnly, onPaste: function (ev) {\r\n                        if (!isNaN(maxChars)) {\r\n                            var target = ev.target, currentTarget = ev.currentTarget;\r\n                            //const textBeingOverwritten = (target as any).innerText || \"\";\r\n                            var editorText = (currentTarget && currentTarget.innerText) || \"\";\r\n                            var textBeingPasted = ev.clipboardData.getData(\"text/plain\") || \"\";\r\n                            if (editorText.length + textBeingPasted.length > maxChars) {\r\n                                ev.preventDefault();\r\n                            }\r\n                        }\r\n                    }, onKeyUp: reportNumChars ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        reportNumChars(innerText ? innerText.length : 0);\r\n                    } : null, onKeyPress: !isNaN(maxChars) ? function (ev) {\r\n                        var innerText = ev.target.innerText;\r\n                        if (innerText && innerText.length >= maxChars) {\r\n                            ev.preventDefault();\r\n                        }\r\n                    } : null, onInput: function (ev) { return _this.triggerOnChange(ev.target.innerHTML); }, onKeyDown: function (ev) {\r\n                        if (readOnly)\r\n                            return;\r\n                        if (reportNumChars && ev.currentTarget) {\r\n                            reportNumChars((ev.currentTarget.innerText || \"\").length);\r\n                        }\r\n                        //console.log(\"Key: \" + ev.which);\r\n                        if (ev.which >= 35 && ev.which <= 40) { // home/end/up/down/left/right\r\n                            ev.stopPropagation(); // Prevent entire page from scrolling??\r\n                        }\r\n                        if (ev.which === 9) {\r\n                            ev.preventDefault(); // TAB\r\n                            if (ev.shiftKey) {\r\n                                exec(\"outdent\");\r\n                            }\r\n                            else {\r\n                                exec(\"indent\");\r\n                            }\r\n                        }\r\n                        if ((ev.keyCode === 8 || ev.keyCode === 46) && // Delete or Back buttons\r\n                            _this.focusElem && _this.state.focusRect) {\r\n                            if (_this.focusElem && _this.focusElem.parentElement) {\r\n                                _this.focusElem.parentElement.removeChild(_this.focusElem); // Remove marked image\r\n                            }\r\n                            _this.focusElem = null;\r\n                            _this.setState({ focusRect: null });\r\n                            _this.triggerOnChange(_this.contentDiv.innerHTML);\r\n                        }\r\n                    } }),\r\n                focusRect && React.createElement(\"div\", { ref: function (div) { return _this.focusRectDiv = div; }, className: classes.focusrect, onBlur: this.onBlur, tabIndex: 1, style: {\r\n                        outline: 0,\r\n                        position: 'absolute',\r\n                        top: this.state.focusRect.top,\r\n                        left: this.state.focusRect.left,\r\n                        width: this.state.focusRect.width,\r\n                        height: this.state.focusRect.height\r\n                    } },\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpul\", style: { position: 'absolute', top: 0, left: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpur\", style: { position: 'absolute', top: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fplr\", style: { position: 'absolute', bottom: 0, right: 0 } }),\r\n                    React.createElement(\"div\", { className: classes.focuspoint + \" fpll\", style: { position: 'absolute', bottom: 0, left: 0 } }))));\r\n    };\r\n    return Wysiwyg;\r\n}(React.Component));\r\nexport { Wysiwyg };\r\nfunction getRelatativeClientRect(parent, child) {\r\n    var parentRect = parent.getBoundingClientRect();\r\n    var childRect = child.getBoundingClientRect();\r\n    return {\r\n        top: childRect.top - parentRect.top + parent.scrollTop,\r\n        left: childRect.left - parentRect.left + parent.scrollLeft,\r\n        bottom: childRect.bottom - parentRect.top + parent.scrollTop,\r\n        right: childRect.right - parentRect.left + parent.scrollLeft,\r\n        width: childRect.width,\r\n        height: childRect.height\r\n    };\r\n}\r\n","import { patchElement } from './html-patch-policy';\r\nvar parser = new DOMParser();\r\n/** Tags / Attributes Whitelist\r\n *\r\n */\r\nvar HTML_WASH_POLICY = {\r\n    b: {},\r\n    i: {},\r\n    p: {},\r\n    u: {},\r\n    strike: {},\r\n    pre: {},\r\n    h1: {},\r\n    h2: {},\r\n    h3: {},\r\n    h4: {},\r\n    h5: {},\r\n    img: { src: true, class: true, style: true, tabindex: true },\r\n    a: { href: true, target: true, tabindex: true },\r\n    ul: {},\r\n    ol: {},\r\n    li: {},\r\n    hr: {},\r\n    br: {},\r\n    div: {},\r\n    span: {},\r\n    // table tags:\r\n    table: { border: true },\r\n    tbody: {},\r\n    thead: {},\r\n    tfoot: {},\r\n    tr: {},\r\n    td: { headers: true, colspan: true, rowspan: true },\r\n    th: { abbr: true, headers: true, scope: true, sorted: true, colspan: true, rowspan: true }\r\n};\r\nexport function washHtml(html) {\r\n    var doc = parser.parseFromString(html, \"text/html\");\r\n    var childNodes = doc.body.childNodes;\r\n    var modified = false;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified ?\r\n        doc.body.innerHTML :\r\n        html; // By returning the original HTML string, we spare the user from refreshing the edit area,\r\n    // which would otherwise put the cursor at the top, losing the position where user where.\r\n}\r\nfunction washNode(node) {\r\n    var modified = false;\r\n    if (isElement(node)) {\r\n        if (washElement(node)) {\r\n            modified = true;\r\n        }\r\n    }\r\n    if (washChildNodes(node)) {\r\n        modified = true;\r\n    }\r\n    return modified;\r\n}\r\nfunction washChildNodes(node) {\r\n    var modified = false;\r\n    var childNodes = node.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        if (washNode(childNodes.item(i))) {\r\n            modified = true;\r\n        }\r\n    }\r\n    return modified;\r\n}\r\n/** Replace an element with its child nodes.\r\n *\r\n */\r\nfunction removeMiddleElement(element) {\r\n    var childNodes = element.childNodes;\r\n    for (var i = 0; i < childNodes.length; ++i) {\r\n        element.parentNode.insertBefore(childNodes.item(i), element);\r\n    }\r\n    element.remove();\r\n}\r\nfunction washElement(element) {\r\n    var modified = patchElement(element);\r\n    var policy = element.tagName && HTML_WASH_POLICY[element.tagName.toLowerCase()];\r\n    if (!policy) {\r\n        console.warn(\"Wysiwyg: not allowed tag\", element.tagName);\r\n        washChildNodes(element);\r\n        removeMiddleElement(element);\r\n        return true;\r\n    }\r\n    for (var i = 0; i < element.attributes.length; ++i) {\r\n        var attr = element.attributes.item(i);\r\n        var allowed = attr.name && !!policy[attr.name.toLowerCase()];\r\n        if (!allowed) {\r\n            modified = true;\r\n            console.warn(\"Wysiwyg: not allowed attribute\", attr.name, \"Tag: \", element.tagName);\r\n            element.removeAttribute(attr.name);\r\n        }\r\n    }\r\n    return modified;\r\n}\r\nfunction isElement(node) {\r\n    return !!node.tagName;\r\n}\r\n","var Course = /** @class */ (function () {\r\n    function Course() {\r\n    }\r\n    return Course;\r\n}());\r\nexport { Course };\r\nexport var futureAbilities = [\r\n    \"Lära att lära\",\r\n    \"Samarbeta\",\r\n    \"Agera globalt\",\r\n    \"Visa handlingskraft\",\r\n    \"Vara innovativ\",\r\n    \"Leva digitalt\"\r\n];\r\n","import * as tslib_1 from \"tslib\";\r\nimport '../../global-setters/set-all';\r\nimport env from '../../globals/KED.env';\r\nimport cfg from '../../globals/KED.cfg';\r\nvar bearerPromise = env.bearerProvider.getBearer(); // Start getting bearer as soon as possible.\r\nimport * as React from 'react';\r\nimport { CourseBuilder } from '../../components/course-builder';\r\nimport { showError } from \"../../utils/utils\";\r\nimport { Spinner } from \"../../components/course-builder/sub-components/spinner\";\r\nimport { LanguageContext } from '../../components/utility-components/LanguageContext';\r\nimport { injectIntl } from 'react-intl';\r\nimport { setupIntl } from '../../components/utility-components/SetupLanguageIntl';\r\nvar _KEDAppCourseBuilder = /** @class */ (function (_super) {\r\n    tslib_1.__extends(_KEDAppCourseBuilder, _super);\r\n    function _KEDAppCourseBuilder(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            isTokenLoaded: false\r\n        };\r\n        return _this;\r\n    }\r\n    _KEDAppCourseBuilder.prototype.componentWillMount = function () {\r\n        var _this = this;\r\n        bearerPromise.then(function () {\r\n            _this.setState({ isTokenLoaded: true });\r\n        }).catch(function (err) {\r\n            showError(err);\r\n        });\r\n    };\r\n    _KEDAppCourseBuilder.prototype.render = function () {\r\n        var intl = this.props.intl;\r\n        return this.state.isTokenLoaded ?\r\n            React.createElement(LanguageContext.Provider, { value: { intl: intl } },\r\n                React.createElement(CourseBuilder, { viewCourseUrl: cfg.KED_COURSE_VIEWER_URL, feedbackUrl: this.props.feedbackUrl })) :\r\n            React.createElement(\"p\", null,\r\n                React.createElement(Spinner, null),\r\n                \"V.g. v\\u00E4nta... autenticerar...\");\r\n    };\r\n    return _KEDAppCourseBuilder;\r\n}(React.Component));\r\nexport var KEDAppCourseBuilder = setupIntl(injectIntl(_KEDAppCourseBuilder));\r\n","import * as tslib_1 from \"tslib\";\r\nimport KED from '../../globals/KED';\r\nimport { KEDAppCourseBuilder } from './app.coursebuilder.client';\r\n// Add KEDAppCourseBuilder to the set of components in KED.components\r\nKED.components = tslib_1.__assign({}, KED.components, { KEDAppCourseBuilder: KEDAppCourseBuilder });\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString } from '../utils/query-string';\r\nimport FeatureDescriptions from './feature-flags.json';\r\nimport { cfg } from '../globals/KED.cfg';\r\nvar Features = /** @class */ (function () {\r\n    function Features() {\r\n        var e_1, _a;\r\n        this._initialized = false;\r\n        var _loop_1 = function (featureName) {\r\n            Object.defineProperty(this_1, featureName, {\r\n                get: function () {\r\n                    if (!this._initialized)\r\n                        this.init();\r\n                    return this._features[featureName];\r\n                },\r\n                set: function (value) {\r\n                    throw new Error('Feature flags cannot be set here');\r\n                }\r\n            });\r\n        };\r\n        var this_1 = this;\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                _loop_1(featureName);\r\n            }\r\n        }\r\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_1) throw e_1.error; }\r\n        }\r\n    }\r\n    Features.prototype.init = function () {\r\n        var e_2, _a;\r\n        if (this._initialized)\r\n            return;\r\n        var turnedOnFeatures = (cfg.KED_FEATURES || \"\").split(',').map(function (name) { return name.trim().toLowerCase(); });\r\n        var query = parseQueryString(location.search, { toLower: true });\r\n        if (query.testversion) {\r\n            turnedOnFeatures = [\"*\"];\r\n        }\r\n        if (query.features) {\r\n            turnedOnFeatures = query.features\r\n                .split(',')\r\n                .map(function (feature) { return feature.trim().toLowerCase(); });\r\n        }\r\n        var turnOnAll = turnedOnFeatures.includes('*');\r\n        this._features = {};\r\n        try {\r\n            for (var _b = tslib_1.__values(Object.keys(FeatureDescriptions)), _c = _b.next(); !_c.done; _c = _b.next()) {\r\n                var featureName = _c.value;\r\n                this._features[featureName] = turnOnAll ||\r\n                    turnedOnFeatures.includes(featureName.toLowerCase());\r\n            }\r\n        }\r\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n        finally {\r\n            try {\r\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\r\n            }\r\n            finally { if (e_2) throw e_2.error; }\r\n        }\r\n        this._initialized = true;\r\n    };\r\n    return Features;\r\n}());\r\nexport { Features };\r\nexport var features = new Features();\r\n","export * from './features';\r\n","import cfg from '../globals/KED.cfg';\r\ncfg.ENVIRONMENT = process.env.ENVIRONMENT;\r\ncfg.KED_API_URL = process.env.KED_API_URL; // \"https://kedbackendtest.azurewebsites.net/api/\"\r\ncfg.EDS_API_URL = process.env.EDS_API_URL; // \"https://edsportalowinapi.azurewebsites.net/api/\"\r\ncfg.KED_TOKEN_URL = process.env.KED_TOKEN_URL; // \"https://kedauthtest.azurewebsites.net/token\"\r\ncfg.KED_CLIENT_ID = process.env.KED_CLIENT_ID; // \"devclient\", \"testclient\", \"...\"\r\ncfg.KED_CLIENT_SECRET = process.env.KED_CLIENT_SECRET;\r\ncfg.KED_REALM = process.env.KED_REALM; // \"SE1\"\r\ncfg.KED_LOCALE = cfg.KED_LOCALE || process.env.KED_LOCALE; // \"sv\", \"en\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_SCHOOL_LOCALE = cfg.KED_SCHOOL_LOCALE || process.env.KED_SCHOOL_LOCALE; // \"sv\", \"en_sin\", \"en_nin\". Only set from process.env if not set from SiteVision element config.\r\ncfg.KED_RESOURCES_URL = cfg.KED_RESOURCES_URL || process.env.KED_RESOURCES_URL;\r\n","/* These scripts assume some of the global vars have already been set:\r\n  * KED.cfg\r\n  * KED.env.currentUser\r\n\r\n  The rest will be set here (client side)\r\n*/\r\nimport './configure';\r\nimport './set-bearer-providers';\r\nimport './set-ked-backend-client';\r\nimport './set-eds-client';\r\n","import * as tslib_1 from \"tslib\";\r\nimport { parseQueryString, generateQueryString, splitUrlAndQuery } from \"../utils/query-string\";\r\nimport { WebServerBearerProvider, isomorphic, storage } from 'kedbackend/clientweb';\r\nimport { KedBearerProvider } from 'kedbackend/client';\r\nimport cfg from '../globals/KED.cfg';\r\nimport env from '../globals/KED.env';\r\nimport { IMPERSONATION_QUERY_PARAMS } from \"../access-control/index\";\r\nimport { cherryPickProps } from \"../utils/utils\";\r\nvar employeeClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.profile.emails\",\r\n    \"https://www.googleapis.com/auth/classroom.rosters\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.students\"\r\n];\r\nvar studentClassroomScopes = [\r\n    \"https://www.googleapis.com/auth/classroom.courses\",\r\n    \"https://www.googleapis.com/auth/classroom.coursework.me\"\r\n];\r\nfunction getMergedTokenPath(tokenPath, locationSearch, scopes) {\r\n    // Merge configured query params of token path with params given to current page\r\n    var currentQuery = parseQueryString(locationSearch);\r\n    var impersonationProps = cherryPickProps(currentQuery, IMPERSONATION_QUERY_PARAMS);\r\n    var _a = tslib_1.__read(splitUrlAndQuery(tokenPath), 2), tokenPathWithoutQuery = _a[0], tokenQueryString = _a[1];\r\n    var tokenPathQuery = parseQueryString(tokenQueryString);\r\n    return tokenPathWithoutQuery + generateQueryString(tslib_1.__assign({}, tokenPathQuery, impersonationProps, { scopes: scopes.join(',') }));\r\n}\r\nfunction getTokenId(mergedTokenPath, userEmail) {\r\n    return mergedTokenPath + \"/\" + userEmail;\r\n}\r\nfunction saveUserInfo(user, tokenId) {\r\n    env.currentUser = user;\r\n    var schoolgrade = parseQueryString(location.search, { toLower: true }).schoolgrade;\r\n    if (schoolgrade) {\r\n        var schoolGradeInt = parseInt(schoolgrade);\r\n        env.currentUser.schoolGrade = schoolGradeInt;\r\n        env.currentUser.schoolType = schoolGradeInt > 9 ? \"Gymnasium\" : \"Grundskolor\";\r\n    }\r\n    sessionStorage.setItem(\"userInfo\" + tokenId, JSON.stringify(user));\r\n}\r\nfunction loadUserInfo(tokenId) {\r\n    var storedSessionUser = sessionStorage.getItem(\"userInfo\" + tokenId);\r\n    if (storedSessionUser) {\r\n        env.currentUser = JSON.parse(storedSessionUser);\r\n    }\r\n}\r\nfunction createBearerProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        if (res.user) {\r\n            saveUserInfo(res.user, tokenId);\r\n        }\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createGoogleTokenProvider(mergedTokenPath, userEmail) {\r\n    var tokenId = getTokenId(mergedTokenPath, userEmail);\r\n    return new WebServerBearerProvider(mergedTokenPath, function (responseText) {\r\n        var res = JSON.parse(responseText);\r\n        if (!res.ok)\r\n            throw new Error(res.error);\r\n        return { token: res.token, expires: Date.now() + 59 * 60 * 1000 };\r\n    }, tokenId);\r\n}\r\nfunction createTestTokenProvider(tokenUrl, user, scopes) {\r\n    return new KedBearerProvider(isomorphic, storage, tokenUrl + user.mail + location.search, cfg.KED_CLIENT_ID, cfg.KED_CLIENT_SECRET, tokenUrl, {\r\n        email: user.mail.toLowerCase(),\r\n        roles: user.roles,\r\n        school: user.school,\r\n        schoolType: user.schoolType,\r\n        scopes: scopes,\r\n        name: user.displayName\r\n    });\r\n}\r\n// env.currentUser.mail is set by SiteVision server initially.\r\n// A response from /api/token may change the mail attribute of the current\r\n// user, so env.currentUser.mail may be different after getting a response.\r\n// However, the initial value is valuable always in order to distinguish the case\r\n// when one normal user logs out and another user logs in.\r\nvar initialUserEmail = env.currentUser && env.currentUser.mail; // Initial value of mail. May change.\r\nif (initialUserEmail) {\r\n    // KED\r\n    if (cfg.KED_TOKEN_PATH) {\r\n        //\r\n        //\r\n        // Production / SiteVision proxied /api/token to request tokens from:\r\n        //\r\n        //\r\n        var mergedTokenPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        env.bearerProvider = createBearerProvider(mergedTokenPath, initialUserEmail);\r\n        loadUserInfo(getTokenId(mergedTokenPath, initialUserEmail));\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        // Google\r\n        var googleMergedPath = getMergedTokenPath(cfg.KED_TOKEN_PATH, location.search, scopes);\r\n        env.googleTokenProvider = createGoogleTokenProvider(googleMergedPath, initialUserEmail);\r\n    }\r\n    else if (cfg.KED_TOKEN_URL && cfg.KED_CLIENT_ID && cfg.KED_CLIENT_SECRET) {\r\n        //\r\n        //\r\n        // Test - go directly to KEDAUTH server to retrieve tokens\r\n        //\r\n        //\r\n        env.bearerProvider = createTestTokenProvider(cfg.KED_TOKEN_URL, env.currentUser, [\r\n            \"kedbackend\",\r\n            \"EDS\",\r\n        ]);\r\n        var scopes = [\r\n            \"https://www.googleapis.com/auth/calendar.readonly\",\r\n            \"https://www.googleapis.com/auth/drive\"\r\n        ].concat(env.currentUser.roles.includes(\"EMPLOYEE\")\r\n            ? employeeClassroomScopes\r\n            : studentClassroomScopes);\r\n        env.googleTokenProvider = createTestTokenProvider(cfg.KED_TOKEN_URL + \"/google\", env.currentUser, scopes);\r\n    }\r\n    else {\r\n        throw new Error(\"Missing configuration parameter KED_TOKEN_PATH\");\r\n    }\r\n}\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { isomorphic } from 'kedbackend/clientweb';\r\nimport { EdsClient } from '../apis/edsclient';\r\nenv.edsClient = new EdsClient(isomorphic, cfg.EDS_API_URL, env.bearerProvider, function () { return env.currentUser.mail; });\r\n","import env from '../globals/KED.env';\r\nimport cfg from '../globals/KED.cfg';\r\nimport { KedBackendClientWeb } from 'kedbackend/clientweb';\r\nenv.kedBackendClient = new KedBackendClientWeb(cfg.KED_API_URL, env.bearerProvider);\r\n","import KED from './KED';\r\n;\r\nif (!KED.cfg)\r\n    KED.cfg = {};\r\nexport default KED.cfg;\r\nexport var cfg = KED.cfg;\r\n","import KED from './ked';\r\nif (!KED.env)\r\n    KED.env = {};\r\nexport default KED.env;\r\nexport var env = KED.env;\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import env from './KED.env';\r\nexport function getCurrentUser() {\r\n    return env.currentUser;\r\n}\r\n","import env from './KED.env';\r\nimport { KedBackendRepo } from 'kedbackend/repo';\r\nimport { getGlobalId, createUUID } from 'kedbackend/client';\r\nimport cfg from './KED.cfg';\r\nif (!env.db) {\r\n    // Put db on env so that it is shared between subject planner and other components!\r\n    env.db = new KedBackendRepo(function () { return env.kedBackendClient; }, function () { return env.currentUser ?\r\n        env.currentUser.mail :\r\n        \"\"; }, function () { return env.currentUser ?\r\n        env.currentUser.displayName || env.currentUser.mail :\r\n        \"\"; });\r\n}\r\nexport var db = env.db;\r\nexport var globalId = getGlobalId(cfg.KED_REALM);\r\nexport var Schools = {\r\n    standardSchool: db.schools.name(\"standard\").cacheOptimized().single(),\r\n    get mySchool() { return db.schools.name(env.currentUser.school).cacheOptimized().single(); }\r\n};\r\nexport var CourseInstances = {\r\n    getBranchId: function (school, courseId) {\r\n        return school.switchMap(function (school) {\r\n            return db.branches\r\n                .hasEdgesFrom([school.officialBranchId])\r\n                .name(\"draft\")\r\n                .tags(courseId)\r\n                .idsOnly()\r\n                .map(function (_a) {\r\n                var id = _a.id;\r\n                return id;\r\n            })\r\n                .toValue()\r\n                .map(function (ids) { return ids.length > 0 ? ids[0] : undefined; });\r\n        });\r\n    },\r\n    /** Get a DRAFT branch for given course ID and given school.\r\n     * If there is not yet such a branch, create it using mutationsOnEmpty() which will\r\n     * lead to the C# code DocumentRepository.ReadOrMutate() via DocumentController.\r\n     */\r\n    getOrCreateBranchId: function (school, courseId) {\r\n        return db.courseInstances.idsOnly().id(courseId).switchMap(function () {\r\n            return school.switchMap(function (school) {\r\n                return db.branches\r\n                    .hasEdgesFrom([school.officialBranchId])\r\n                    .name(\"draft\")\r\n                    .tags(courseId)\r\n                    .idsOnly()\r\n                    .mutationsOnEmpty(function (tx) {\r\n                    // These 2 mutations will occur server side, atomically.\r\n                    // Will be sent on each request in the query, but will only execute if query results in zero items.\r\n                    //console.log(\"School:\", school);\r\n                    var id = createUUID();\r\n                    tx.add(\"branches\", {\r\n                        id: id,\r\n                        acl: [\r\n                            \"role:USER:R\",\r\n                            \"schoolRole:\" + school.name + \"/EMPLOYEE:S\"\r\n                        ],\r\n                        name: 'draft',\r\n                        schoolId: school.id,\r\n                        treeParentId: school.officialBranchId,\r\n                        tags: [courseId]\r\n                    });\r\n                    // Approving the branch makes sure that it was created by an EMPLOYEE on given school.\r\n                    tx.link2(\"branches\", school.officialBranchId, \"approvedChildren\", id);\r\n                })\r\n                    .single()\r\n                    .map(function (_a) {\r\n                    var id = _a.id;\r\n                    return id;\r\n                });\r\n            });\r\n        });\r\n    },\r\n    getAllDescendantIds: function (courseId) {\r\n        return db.courseBlocks.tags(courseId).idsOnly().concat(db.courseContents.tags(courseId).idsOnly()).concat(db.courseTabs.tags(courseId).idsOnly()).concat(db.tasks.tags(courseId).idsOnly())\r\n            .map(function (x) { return x.id; });\r\n    }\r\n};\r\n","export var KED_NAMESPACE = \"KED\";\r\nvar result = typeof KED === 'undefined' ? {} : KED;\r\nif (typeof window !== 'undefined' && typeof KED === 'undefined') {\r\n    window[KED_NAMESPACE] = result;\r\n}\r\nexport default result;\r\n","import * as tslib_1 from \"tslib\";\r\nvar Repo = /** @class */ (function () {\r\n    function Repo(comm) {\r\n        this.comm = comm;\r\n        this.listPromise = null;\r\n        this.items = null;\r\n        this.subscribers = [];\r\n    }\r\n    Repo.prototype.subscribe = function (subscriber) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            subscriber(_this.items, _this.error);\r\n            _this.subscribers.push(subscriber);\r\n        });\r\n    };\r\n    Repo.prototype.unsubscribe = function (subscriber) {\r\n        this.subscribers = this.subscribers.filter(function (s) { return s !== subscriber; });\r\n    };\r\n    Repo.prototype.notifySubscribers = function () {\r\n        var _this = this;\r\n        this.subscribers.forEach(function (s) { return s(_this.items, _this.error); });\r\n    };\r\n    Repo.prototype.ensureHasData = function () {\r\n        if (!this.listPromise)\r\n            this.refreshFromServer();\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.refreshFromServer = function () {\r\n        var _this = this;\r\n        this.listPromise = this.comm.query().then(function (items) {\r\n            _this.items = items;\r\n            _this.error = null;\r\n            _this.notifySubscribers();\r\n        }).catch(function (error) {\r\n            _this.error = error;\r\n            _this.items = _this.items || [];\r\n            _this.notifySubscribers();\r\n        });\r\n        return this.listPromise;\r\n    };\r\n    Repo.prototype.update = function (item) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var updatedItems;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this.ensureHasData()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        updatedItems = Array.isArray(item) ? item : [item];\r\n                        this.items = this.items.map(function (it) {\r\n                            var updatedItem = updatedItems.find(function (_a) {\r\n                                var id = _a.id;\r\n                                return it.id === id;\r\n                            });\r\n                            return updatedItem ?\r\n                                Object.assign({}, updatedItem) :\r\n                                it;\r\n                        });\r\n                        this.notifySubscribers();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    Repo.prototype.insert = function (item) {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.concat(item);\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    Repo.prototype.delete = function (id) {\r\n        var _this = this;\r\n        var ids = Array.isArray(id) ? id : [id];\r\n        return this.ensureHasData().then(function () {\r\n            _this.items = _this.items.filter(function (it) { return !ids.some(function (id) { return it.id === id; }); });\r\n            _this.notifySubscribers();\r\n        });\r\n    };\r\n    return Repo;\r\n}());\r\nexport { Repo };\r\n","import * as tslib_1 from \"tslib\";\r\nimport { Repo } from './repo';\r\nimport env from '../globals/KED.env';\r\nimport { flatten, L } from \"../utils/utils\";\r\nvar SchoolCoursesRepo = /** @class */ (function (_super) {\r\n    tslib_1.__extends(SchoolCoursesRepo, _super);\r\n    function SchoolCoursesRepo(getSchoolName) {\r\n        var _this = _super.call(this, {\r\n            query: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var schoolName, schools;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            schoolName = getSchoolName();\r\n                            return [4 /*yield*/, env.kedBackendClient.list(\"schools\", {\r\n                                    name: schoolName,\r\n                                    include: [\"courses\"]\r\n                                })];\r\n                        case 1:\r\n                            schools = _a.sent();\r\n                            this._schoolId = schools.length > 0 && schools[0].id;\r\n                            if (!this._schoolId)\r\n                                throw new Error(L(templateObject_1 || (templateObject_1 = tslib_1.__makeTemplateObject([\"Skolan \", \" finns inte registrerad i systemet.\\n          Kontakta en administrat\\u00F6r f\\u00F6r Kursbyggarverktyget och be om att l\\u00E4gga till skolan med namnet \\\"\", \"\\\"\"], [\"Skolan \", \" finns inte registrerad i systemet.\\n          Kontakta en administrat\\u00F6r f\\u00F6r Kursbyggarverktyget och be om att l\\u00E4gga till skolan med namnet \\\"\", \"\\\"\"])), schoolName, schoolName));\r\n                            return [2 /*return*/, flatten(schools.map(function (school) { return school.courses; }))];\r\n                    }\r\n                });\r\n            }); }\r\n        }) || this;\r\n        return _this;\r\n    }\r\n    SchoolCoursesRepo.prototype.getSchoolId = function () {\r\n        var _this = this;\r\n        return this.ensureHasData().then(function () { return _this._schoolId; });\r\n    };\r\n    return SchoolCoursesRepo;\r\n}(Repo));\r\nexport var mySchoolCoursesRepo = new SchoolCoursesRepo(function () { return env.currentUser.school; });\r\nvar templateObject_1;\r\n","var CachedResponse = /** @class */ (function () {\r\n    function CachedResponse(queryer) {\r\n        this.queryer = queryer;\r\n        this.promise = null;\r\n        this.result = null;\r\n    }\r\n    CachedResponse.prototype.query = function () {\r\n        var _this = this;\r\n        return this.promise ?\r\n            this.promise :\r\n            (this.promise = this.queryer().then(function (x) { return _this.result = x; }));\r\n    };\r\n    CachedResponse.prototype.reset = function () {\r\n        this.promise = null;\r\n    };\r\n    return CachedResponse;\r\n}());\r\nexport { CachedResponse };\r\n","import * as tslib_1 from \"tslib\";\r\nimport * as React from 'react';\r\nimport { db } from '../globals/db';\r\nimport { RemoveItem } from '../components/course-builder/sub-components/remove-item';\r\nvar ErrorSuccessFeedback = /** @class */ (function (_super) {\r\n    tslib_1.__extends(ErrorSuccessFeedback, _super);\r\n    function ErrorSuccessFeedback(props) {\r\n        var _this = _super.call(this, props) || this;\r\n        _this.state = {\r\n            errors: [],\r\n            infos: []\r\n        };\r\n        _this._unhandledRejection = _this._unhandledRejection.bind(_this);\r\n        _this._error = _this._error.bind(_this);\r\n        _this._customError = _this._customError.bind(_this);\r\n        _this._onInfo = _this._onInfo.bind(_this);\r\n        _this._dbWriterError = _this._dbWriterError.bind(_this);\r\n        _this._dbWriterStateChanged = _this._dbWriterStateChanged.bind(_this);\r\n        return _this;\r\n    }\r\n    ErrorSuccessFeedback.prototype._addError = function (message, details, retryable) {\r\n        var _this = this;\r\n        //console.error(message, {retryable: !!retryable, details});\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            if (errors.some(function (e) { return e.message === message; }))\r\n                return { errors: errors };\r\n            if (errors.length > 2)\r\n                errors = errors.slice(1);\r\n            return {\r\n                errors: errors.concat([{ message: message, details: details, retryable: retryable }])\r\n            };\r\n        });\r\n        // Remove non-retryable errors after 30 seconds:\r\n        if (!retryable)\r\n            setTimeout(function () {\r\n                _this.setState(function (_a) {\r\n                    var errors = _a.errors;\r\n                    return ({\r\n                        errors: errors.filter(function (e) { return e.message !== message; })\r\n                    });\r\n                });\r\n            }, 30000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._addInfo = function (message) {\r\n        var _this = this;\r\n        if (message === \"\") {\r\n            // Turn off current info messages\r\n            this.setState({ infos: [] });\r\n            return;\r\n        }\r\n        this.setState(function (_a) {\r\n            var infos = _a.infos;\r\n            if (infos.some(function (info) { return info === message; }))\r\n                return { infos: infos };\r\n            if (infos.length > 1)\r\n                infos = infos.slice(1);\r\n            return {\r\n                infos: [message] // was: infos.concat(message). But it sucks!\r\n            };\r\n        });\r\n        // Remove info message after 10 seconds:\r\n        setTimeout(function () {\r\n            _this.setState(function (_a) {\r\n                var infos = _a.infos;\r\n                return ({\r\n                    infos: infos.filter(function (msg) { return msg !== message; })\r\n                });\r\n            });\r\n        }, 10000);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterError = function (error, retryable) {\r\n        this._addError(\"Det g\\u00E5r inte att spara till servern\", error, retryable);\r\n    };\r\n    ErrorSuccessFeedback.prototype._dbWriterStateChanged = function (_a) {\r\n        var isEdited = _a.isEdited, isSaving = _a.isSaving;\r\n        if (!isEdited) {\r\n            // If isEdited is false, a successful write must have happened, and\r\n            // there cannot be any retryable error anymore\r\n            this.setState(function (_a) {\r\n                var errors = _a.errors;\r\n                errors = errors.filter(function (e) { return !e.retryable; });\r\n                return { errors: errors };\r\n            });\r\n        }\r\n        this.setState({\r\n            dbWriterIsEdited: isEdited,\r\n            dbWriterIsSaving: isSaving\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentDidMount = function () {\r\n        window.addEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.addEventListener('error', this._error);\r\n        window.addEventListener('customerror', this._customError);\r\n        window.addEventListener('info', this._onInfo);\r\n        db.writer.onError(this._dbWriterError);\r\n        db.writer.onStateChange(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype.componentWillUnmount = function () {\r\n        window.removeEventListener('unhandledrejection', this._unhandledRejection);\r\n        window.removeEventListener('error', this._error);\r\n        window.removeEventListener('customerror', this._customError);\r\n        window.removeEventListener('info', this._onInfo);\r\n        db.writer.off(this._dbWriterError);\r\n        db.writer.off(this._dbWriterStateChanged);\r\n    };\r\n    ErrorSuccessFeedback.prototype._unhandledRejection = function (ev) {\r\n        this._addError(\"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.reason);\r\n    };\r\n    ErrorSuccessFeedback.prototype._error = function (ev) {\r\n        this._addError(ev.error ? ev.error.message : \"Ett ok\\u00E4nt fel intr\\u00E4ffade...\", ev.error);\r\n    };\r\n    ErrorSuccessFeedback.prototype._customError = function (ev) {\r\n        this._addError(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype._onInfo = function (ev) {\r\n        this._addInfo(ev.detail);\r\n    };\r\n    ErrorSuccessFeedback.prototype.render = function () {\r\n        var _this = this;\r\n        var _a = this.state, errors = _a.errors, infos = _a.infos, dbWriterIsSaving = _a.dbWriterIsSaving;\r\n        return React.createElement(\"div\", { className: \"error-success-feedback\", style: {\r\n                position: \"fixed\",\r\n                left: 0,\r\n                top: 0,\r\n                width: \"100%\",\r\n                pointerEvents: 'none'\r\n            } },\r\n            React.createElement(\"div\", { style: { display: 'table', margin: \"0 auto\" } },\r\n                errors.filter(function (e) { return !e.retryable || !dbWriterIsSaving; })\r\n                    .map(function (_a) {\r\n                    var message = _a.message, details = _a.details, retryable = _a.retryable, showDetails = _a.showDetails;\r\n                    return (React.createElement(\"div\", { key: message, className: \"error\" },\r\n                        React.createElement(\"div\", { style: { float: 'left' } }, message),\r\n                        React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            React.createElement(RemoveItem, { onClick: function () { return _this.removeError(message); } })),\r\n                        details || retryable ? React.createElement(\"div\", { style: { pointerEvents: 'auto' } },\r\n                            details ? React.createElement(React.Fragment, null,\r\n                                React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.toggleDetails(message); } }, showDetails ? \"Dölj detailer\" : \"Visa detailjer\"),\r\n                                \"\\u00A0\") : undefined,\r\n                            showDetails ? React.createElement(\"p\", null, '' + details) : React.createElement(React.Fragment, null, \"\\u00A0\"),\r\n                            retryable ? React.createElement(\"a\", { className: \"btn\", onClick: function () { return _this.retrySave(); } }, \"F\\u00F6rs\\u00F6k spara nu\") : undefined) : undefined));\r\n                }),\r\n                infos.map(function (message) {\r\n                    return React.createElement(\"p\", { key: message, className: \"info\" }, message);\r\n                })));\r\n    };\r\n    ErrorSuccessFeedback.prototype.removeError = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({\r\n                errors: errors.filter(function (e) { return e.message !== message; })\r\n            });\r\n        });\r\n    };\r\n    ErrorSuccessFeedback.prototype.retrySave = function () {\r\n        db.writer.retrySave();\r\n    };\r\n    ErrorSuccessFeedback.prototype.toggleDetails = function (message) {\r\n        this.setState(function (_a) {\r\n            var errors = _a.errors;\r\n            return ({ errors: errors.map(function (error) { return error.message === message ? tslib_1.__assign({}, error, { showDetails: !error.showDetails }) :\r\n                    error; })\r\n            });\r\n        });\r\n    };\r\n    return ErrorSuccessFeedback;\r\n}(React.Component));\r\nexport { ErrorSuccessFeedback };\r\n","import * as tslib_1 from \"tslib\";\r\nimport $ from 'jquery';\r\nimport { cfg } from '../globals/KED.cfg';\r\nvar HEARTBEAT_INTERVAL = 5 * 60 * 1000; // 5 minutes.\r\nvar HEARTBEAT_URL = cfg.KED_KEEP_ALIVE_URL;\r\nvar lastActivity = Date.now();\r\nexport function keepSessionAlive() {\r\n    setInterval(onTimeout, HEARTBEAT_INTERVAL);\r\n    setTimeout(function () { return $('body')\r\n        .mousemove(onUserActive)\r\n        .keypress(onUserActive)\r\n        .scroll(onUserActive); }, 100);\r\n}\r\nfunction onUserActive() {\r\n    lastActivity = Date.now();\r\n}\r\nfunction onTimeout() {\r\n    var inactivityTime = Date.now() - lastActivity;\r\n    if (inactivityTime < HEARTBEAT_INTERVAL) {\r\n        heartbeat();\r\n    }\r\n}\r\nfunction heartbeat() {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var res, err_1;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    console.log(\"Sending heartbeat request to \" + HEARTBEAT_URL);\r\n                    _a.label = 1;\r\n                case 1:\r\n                    _a.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, fetch(HEARTBEAT_URL, {\r\n                            cache: 'no-cache',\r\n                            credentials: 'same-origin'\r\n                        })];\r\n                case 2:\r\n                    res = _a.sent();\r\n                    console.log(\"Response from \" + HEARTBEAT_URL + \": \" + res.status + \" \" + res.statusText);\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    err_1 = _a.sent();\r\n                    console.warn(\"Request to \" + HEARTBEAT_URL + \" failed: \" + err_1);\r\n                    return [3 /*break*/, 4];\r\n                case 4: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nvar DEFAULT_CACHE_EXPIRATION = 30 * 60 * 1000; // 30 minutes.\r\nvar defaultOptions = {\r\n    isApiMethod: function (f) { return typeof f === 'function'; },\r\n    cacheExpiration: DEFAULT_CACHE_EXPIRATION\r\n};\r\nexport function makeSuspenseApi(api, options) {\r\n    if (options === void 0) { options = defaultOptions; }\r\n    options = tslib_1.__assign({}, defaultOptions, options);\r\n    var isApiMethod = options.isApiMethod, cacheExpiration = options.cacheExpiration;\r\n    var rv = Object.create(api);\r\n    var cache = {};\r\n    // Walk the instance + prototype chain to generate suspense version of each promise returning method\r\n    for (var proto = api; proto && proto !== Object.prototype; proto = Object.getPrototypeOf(proto)) {\r\n        suspendify(proto);\r\n    }\r\n    function suspendify(proto) {\r\n        Object.keys(proto).forEach(function (prop) {\r\n            if (!rv.hasOwnProperty(prop) && isApiMethod(prop)) {\r\n                rv[prop] = function () {\r\n                    var args = [];\r\n                    for (var _i = 0; _i < arguments.length; _i++) {\r\n                        args[_i] = arguments[_i];\r\n                    }\r\n                    var key = JSON.stringify(tslib_1.__spread([prop], args));\r\n                    var cachedEntry = cache[key];\r\n                    if (cachedEntry !== undefined) {\r\n                        if (cachedEntry.promise)\r\n                            throw cachedEntry.promise;\r\n                        if (cachedEntry.error)\r\n                            throw cachedEntry.error;\r\n                        if (cachedEntry.timeout > Date.now()) {\r\n                            return cachedEntry.value;\r\n                        }\r\n                    }\r\n                    try {\r\n                        var promise = proto[prop].apply(api, args).then(function (result) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, value: result };\r\n                        }).catch(function (error) {\r\n                            cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                        });\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, promise: promise };\r\n                        throw promise;\r\n                    }\r\n                    catch (error) {\r\n                        if (error.then)\r\n                            throw error;\r\n                        cache[key] = { timeout: Date.now() + cacheExpiration, error: error };\r\n                    }\r\n                };\r\n            }\r\n        });\r\n    }\r\n    return rv;\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nexport function parseQueryString(locationSearch, options) {\r\n    var toLower = (options || {}).toLower;\r\n    var result = {};\r\n    if (locationSearch && locationSearch.length > 1)\r\n        locationSearch.substr(1)\r\n            .split('&')\r\n            .map(function (part) { return part.split('=').map(function (s) { return decodeURIComponent(s.trim()); }); })\r\n            .forEach(function (_a) {\r\n            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];\r\n            return result[toLower ? key.toLowerCase() : key] = value;\r\n        });\r\n    return result;\r\n}\r\nfunction encodeParams(params) {\r\n    return Object.keys(params).filter(function (key) { return params[key] !== undefined; }).map(function (key) { return encodeURIComponent(key) + \"=\" + encodeURIComponent(params[key]); }).join('&');\r\n}\r\nexport function generateQueryString(params) {\r\n    return \"?\" + encodeParams(params);\r\n}\r\nexport function parseHashQueryString(locationHash, options) {\r\n    return parseQueryString(locationHash, options);\r\n}\r\nexport function generateHashQueryString(params) {\r\n    return \"#\" + encodeParams(params);\r\n}\r\nexport function splitUrlAndQuery(urlWithPossibleQuery) {\r\n    var pQuery = urlWithPossibleQuery.indexOf('?');\r\n    return pQuery >= 0 ?\r\n        [urlWithPossibleQuery.substr(0, pQuery), urlWithPossibleQuery.substr(pQuery)] :\r\n        [urlWithPossibleQuery, \"\"];\r\n}\r\n","import * as tslib_1 from \"tslib\";\r\nimport moment from 'moment';\r\nexport function getFirstAndLastWeekOfTerm(term) {\r\n    return term === 'AT' ?\r\n        [32, 51] :\r\n        [1, 25];\r\n}\r\n//Not used anymore\r\n// export function getTermStartAndEnd(now: moment.Moment) : moment.Moment[] {\r\n//     return now.month() >= 6 ? // 6 = July in JS Dates and in moment as well!\r\n//     [moment(new Date(now.year(), 7, 1)), moment(new Date(now.year(), 11, 31))] : // aug1 - dec31\r\n//     [moment(new Date(now.year(), 0, 1)), moment(new Date(now.year(), 6, 31))]; // jan1 - july31\r\n// }\r\nexport function getTermStarEndDate(date, isFirstTerm) {\r\n    var addYear = date.getMonth() >= 7;\r\n    var termYear = null;\r\n    if (addYear) {\r\n        termYear = isFirstTerm ? date.getFullYear() : date.getFullYear() + 1;\r\n    }\r\n    else {\r\n        termYear = isFirstTerm ? date.getFullYear() - 1 : date.getFullYear();\r\n    }\r\n    var termYearMoment = moment(termYear.toString(), \"YYYY\");\r\n    if (termYearMoment.week() != 1) {\r\n        termYearMoment = termYearMoment.clone().add(1, 'week');\r\n    }\r\n    return isFirstTerm ? [moment(termYearMoment.clone()).week(32).startOf('week'), moment(termYearMoment.clone()).week(51).endOf('week')] :\r\n        [moment(termYearMoment.clone()), moment(termYearMoment.clone()).week(25).endOf('week')];\r\n}\r\nexport function getSchoolMoment(m) {\r\n    var thisYear = m.year();\r\n    var isAutumn = m.month() >= 6; // determine \r\n    var _a = tslib_1.__read(isAutumn ?\r\n        [thisYear, thisYear + 1] :\r\n        [thisYear - 1, thisYear], 2), autumnYear = _a[0], springYear = _a[1];\r\n    var academicYear = '' + autumnYear + '/' + springYear;\r\n    var term = isAutumn ? 'AT' : 'ST';\r\n    var week = m.week();\r\n    return { academicYear: academicYear, term: term, week: week };\r\n}\r\nexport function addYear(aYear, numYearsToAdd) {\r\n    return aYear.split('/')\r\n        .map(function (yearStr) { return parseInt(yearStr) + numYearsToAdd; })\r\n        .map(function (year) { return '' + year; })\r\n        .join('/');\r\n}\r\nexport function nextAcademicYear(aYear) {\r\n    return addYear(aYear, 1);\r\n}\r\nexport function prevAcademicYear(aYear) {\r\n    return addYear(aYear, -1);\r\n}\r\n","import moment from 'moment';\r\nimport { getSchoolMoment, addYear } from './school-moment';\r\nfunction isSchoolMoment(obj) {\r\n    return 'academicYear' in obj;\r\n}\r\nvar SchoolTerm = /** @class */ (function () {\r\n    function SchoolTerm(dateOrSchoolMoment) {\r\n        var schoolMoment = isSchoolMoment(dateOrSchoolMoment) ?\r\n            dateOrSchoolMoment : getSchoolMoment(moment(dateOrSchoolMoment));\r\n        this.academicYear = schoolMoment.academicYear;\r\n        this.term = schoolMoment.term;\r\n    }\r\n    Object.defineProperty(SchoolTerm.prototype, \"year\", {\r\n        get: function () {\r\n            return parseInt(this.academicYear\r\n                .split('/')[this.term === 'AT' ? 0 : 1]);\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    SchoolTerm.prototype.nextTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: this.academicYear\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: addYear(this.academicYear, 1)\r\n            });\r\n    };\r\n    SchoolTerm.prototype.prevTerm = function () {\r\n        return new SchoolTerm(this.term === 'AT' ?\r\n            {\r\n                term: 'ST',\r\n                academicYear: addYear(this.academicYear, -1)\r\n            } :\r\n            {\r\n                term: 'AT',\r\n                academicYear: this.academicYear\r\n            });\r\n    };\r\n    SchoolTerm.prototype.toLocaleString = function (intl, shortYear) {\r\n        var year = this.term === 'AT' ?\r\n            this.academicYear.split('/')[0] :\r\n            this.academicYear.split('/')[1];\r\n        if (shortYear)\r\n            year = year.substr(2);\r\n        return this.term === 'AT' ? intl.formatMessage({ id: 'termplanner.secondTerm', defaultMessage: 'HT {year}' }, { year: year }) :\r\n            intl.formatMessage({ id: 'termplanner.firstTerm', defaultMessage: 'VT {year}' }, { year: year });\r\n    };\r\n    return SchoolTerm;\r\n}());\r\nexport { SchoolTerm };\r\n","import * as tslib_1 from \"tslib\";\r\nexport function capitalizeFirst(str) {\r\n    for (var i = 0, l = str.length; i < l; ++i) {\r\n        if (str.charCodeAt(i) < 0x2000) {\r\n            return str.substr(0, i) + str[i].toLocaleUpperCase() + str.substr(i + 1);\r\n        }\r\n    }\r\n    return str;\r\n}\r\nexport function extend(obj, extension) {\r\n    if (typeof extension !== 'object')\r\n        return obj;\r\n    Object.keys(extension).forEach(function (key) {\r\n        obj[key] = extension[key];\r\n    });\r\n    return obj;\r\n}\r\nexport function clone(obj, extension) {\r\n    var clone = {};\r\n    Object.getOwnPropertyNames(obj).forEach(function (key) {\r\n        Object.defineProperty(clone, key, Object.getOwnPropertyDescriptor(obj, key));\r\n    });\r\n    if (extension)\r\n        extend(clone, extension);\r\n    return clone;\r\n}\r\nvar concat = [].concat;\r\nexport function flatten(a) {\r\n    return concat.apply([], a);\r\n}\r\nexport function compareProp(prop) {\r\n    return function (a, b) {\r\n        var aProp = a[prop], bProp = b[prop];\r\n        return aProp > bProp ? 1 : aProp < bProp ? -1 : 0;\r\n    };\r\n}\r\nexport function compareProps(props, locales, options) {\r\n    props = Array.isArray(props) ? props : [props];\r\n    var localeCompare = function (a, b) {\r\n        return typeof a === 'string' ?\r\n            a.localeCompare(b, locales, options) :\r\n            a < b ? -1 : a > b ? 1 : 0;\r\n    };\r\n    function cmpPart(a, b, firstPart, rest) {\r\n        var firstA = a[firstPart];\r\n        var firstB = b[firstPart];\r\n        if (firstA === firstB)\r\n            return 0;\r\n        if (firstA == null)\r\n            return -1;\r\n        if (firstB == null)\r\n            return 1;\r\n        return rest.length === 0 ?\r\n            localeCompare(firstA, firstB) :\r\n            cmpPart(firstA, firstB, rest[0], rest.slice(1));\r\n    }\r\n    return props\r\n        .map(function (prop) { return prop.split('.'); })\r\n        .map(function (_a) {\r\n        var _b = tslib_1.__read(_a), firstPart = _b[0], rest = _b.slice(1);\r\n        return function (a, b) { return cmpPart(a, b, firstPart, rest); };\r\n    })\r\n        .reduce(function (cmp1, cmp2) {\r\n        return function (a, b) { return cmp1(a, b) || cmp2(a, b); };\r\n    });\r\n}\r\nexport function L(text) {\r\n    var args = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        args[_i - 1] = arguments[_i];\r\n    }\r\n    var first = text[0];\r\n    return buildMessage(text, args);\r\n}\r\nfunction buildMessage(text, args) {\r\n    var rv = text[0];\r\n    for (var i = 1, l = text.length; i < l; ++i) {\r\n        rv += args[i - 1] + text[i];\r\n    }\r\n    return rv;\r\n}\r\nvar TC = /** @class */ (function () {\r\n    function TC(template) {\r\n        extend(this, template);\r\n    }\r\n    return TC;\r\n}());\r\nexport { TC };\r\nexport function dateTimeReviver(key, value) {\r\n    var a;\r\n    if (typeof value === 'string') {\r\n        a = /\\/Date\\((\\d*)\\)\\//.exec(value);\r\n        if (a) {\r\n            return new Date(+a[1]);\r\n        }\r\n    }\r\n    return value;\r\n}\r\n//let infoSerial = 1;\r\nexport function showInfo(msg) {\r\n    var event = new CustomEvent('info', { 'detail': msg });\r\n    window.dispatchEvent(event);\r\n}\r\nexport function showError(errMsg) {\r\n    var msg = typeof errMsg === 'string' ? errMsg : errMsg.message;\r\n    var event = new CustomEvent('customerror', { 'detail': msg });\r\n    console.error(errMsg);\r\n    window.dispatchEvent(event);\r\n}\r\nexport function maxLength(str, maxLen) {\r\n    return str.length > maxLen ?\r\n        str.substr(0, maxLen - 3) + \"...\" :\r\n        str;\r\n}\r\nexport function arrayToLookup(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        var array = result[key];\r\n        if (array)\r\n            array.push(item);\r\n        else\r\n            result[key] = [item];\r\n    }\r\n    return result;\r\n}\r\nexport function arrayToMap(a, keyAccessor) {\r\n    var result = {};\r\n    for (var i = 0, l = a.length; i < l; ++i) {\r\n        var item = a[i];\r\n        var key = keyAccessor(item);\r\n        result[key] = item;\r\n    }\r\n    return result;\r\n}\r\nexport function cherryPickProps(obj, propsToPick) {\r\n    var e_1, _a;\r\n    var result = {};\r\n    try {\r\n        for (var propsToPick_1 = tslib_1.__values(propsToPick), propsToPick_1_1 = propsToPick_1.next(); !propsToPick_1_1.done; propsToPick_1_1 = propsToPick_1.next()) {\r\n            var param = propsToPick_1_1.value;\r\n            if (param in obj)\r\n                result[param] = obj[param];\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (propsToPick_1_1 && !propsToPick_1_1.done && (_a = propsToPick_1.return)) _a.call(propsToPick_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return result;\r\n}\r\nexport function distinct(a, keyAccessor) {\r\n    var map = arrayToMap(a, keyAccessor || (function (x) { return x; }));\r\n    return Object.keys(map).map(function (key) { return map[key]; });\r\n}\r\nexport function shallowEquals(a, b) {\r\n    if (a === b)\r\n        return true;\r\n    if (!a || !b)\r\n        return false;\r\n    if (typeof a !== 'object' || typeof b !== 'object')\r\n        return false;\r\n    var keysA = Object.keys(a);\r\n    var keysB = Object.keys(b);\r\n    if (keysA.length !== keysB.length)\r\n        return false;\r\n    for (var i = 0, l = keysA.length; i < l; ++i) {\r\n        var key = keysA[i];\r\n        if (keysB[i] !== key)\r\n            return false;\r\n        if (a[key] !== b[key])\r\n            return false;\r\n    }\r\n    return true;\r\n}\r\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AClBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACnPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC1FA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACzDA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/JA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9JA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC3NA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC7BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC9NA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChCA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjCA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACZA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AC/CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACLA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AChBA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACPA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACvBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnNA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7DA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjXA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7GA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACrXA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3MA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxNA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1KA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1vBA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9MA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9GA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpaA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpMA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7FA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7CA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACltBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACzCA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACpBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/cA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrQA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5BA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACdA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC5CA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AClEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC1CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC3HA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtGA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvRA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACvGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACbA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxCA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACVA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACTA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/HA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACJA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC7EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AChDA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACtDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACnDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACrDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}